(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.4.4";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{for(var key in obj){if(_.has(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker)return}}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list)});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value});return results};_.reject=function(obj,iterator,context){return _.filter(obj,function(value,index,list){return!iterator.call(context,value,index,list)},context)};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key]})};_.where=function(obj,attrs,first){if(_.isEmpty(attrs))return first?null:[];return _[first?"find":"filter"](obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false}return true})};_.findWhere=function(obj,attrs){return _.where(obj,attrs,true)};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity,value:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity,value:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value]}};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index<right.index?-1:1}),"value")};var group=function(obj,value,context,behavior){var result={};var iterator=lookupIterator(value||_.identity);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result};_.groupBy=function(obj,value,context){return group(obj,value,context,function(result,key,value){(_.has(result,key)?result[key]:result[key]=[]).push(value)})};_.countBy=function(obj,value,context){return group(obj,value,context,function(result,key){if(!_.has(result,key))result[key]=0;result[key]++})};_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;return n!=null&&!guard?slice.call(array,0,n):array[0]};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(array==null)return void 0;if(n!=null&&!guard){return slice.call(array,Math.max(array.length-n,0))}else{return array[array.length-1]}};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){each(input,function(value){if(_.isArray(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(concat.apply(ArrayProto,arguments))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,"length"));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(args,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,l=list.length;i<l;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,l=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,l+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<l;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step}return range};_.bind=function(func,context){if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));var args=slice.call(arguments,2);return function(){return func.apply(context,args.concat(slice.call(arguments)))}};_.partial=function(func){var args=slice.call(arguments,1);return function(){return func.apply(this,args.concat(slice.call(arguments)))}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait){var context,args,timeout,result;var previous=0;var later=function(){previous=new Date;timeout=null;result=func.apply(context,args)};return function(){var now=new Date;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args)}else if(!timeout){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)result=func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)result=func.apply(context,args);return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){if(times<=0)return func();return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(_.has(obj,key))keys[keys.length]=key;return keys};_.values=function(obj){var values=[];for(var key in obj)if(_.has(obj,key))values.push(obj[key]);return values};_.pairs=function(obj){var pairs=[];for(var key in obj)if(_.has(obj,key))pairs.push([key,obj[key]]);return pairs};_.invert=function(obj){var result={};for(var key in obj)if(_.has(obj,key))result[obj[key]]=key;return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop]}}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]==null)obj[prop]=source[prop]}}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){var accum=Array(n);for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return null;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}if(evaluate){source+="';\n"+evaluate+"\n__p+='"}index=offset+match.length;return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);(function(_,undefined){var plurals=[],singulars=[],uncountables=[];var inflector={gsub:function(word,rule,replacement){var pattern=new RegExp(rule.source||rule,"gi");return pattern.test(word)?word.replace(pattern,replacement):null},plural:function(rule,replacement){plurals.unshift([rule,replacement])},pluralize:function(word,count,includeNumber){var result;if(count!==undefined){count=Math.round(count);result=count===1?this.singularize(word):this.pluralize(word);result=includeNumber?[count,result].join(" "):result}else{if(_(uncountables).include(word)){return word}result=word;_(plurals).detect(function(rule){var gsub=this.gsub(word,rule[0],rule[1]);return gsub?result=gsub:false},this)}return result},singular:function(rule,replacement){singulars.unshift([rule,replacement])},singularize:function(word){if(_(uncountables).include(word)){return word}var result=word;_(singulars).detect(function(rule){var gsub=this.gsub(word,rule[0],rule[1]);return gsub?result=gsub:false},this);return result},irregular:function(singular,plural){this.plural("\\b"+singular+"\\b",plural);this.singular("\\b"+plural+"\\b",singular)},uncountable:function(word){uncountables.unshift(word)},resetInflections:function(){plurals=[];singulars=[];uncountables=[];this.plural(/$/,"s");this.plural(/s$/,"s");this.plural(/(ax|test)is$/,"$1es");this.plural(/(octop|vir)us$/,"$1i");this.plural(/(octop|vir)i$/,"$1i");this.plural(/(alias|status)$/,"$1es");this.plural(/(bu)s$/,"$1ses");this.plural(/(buffal|tomat)o$/,"$1oes");this.plural(/([ti])um$/,"$1a");this.plural(/([ti])a$/,"$1a");this.plural(/sis$/,"ses");this.plural(/(?:([^f])fe|([lr])f)$/,"$1$2ves");this.plural(/(hive)$/,"$1s");this.plural(/([^aeiouy]|qu)y$/,"$1ies");this.plural(/(x|ch|ss|sh)$/,"$1es");this.plural(/(matr|vert|ind)(?:ix|ex)$/,"$1ices");this.plural(/([m|l])ouse$/,"$1ice");this.plural(/([m|l])ice$/,"$1ice");this.plural(/^(ox)$/,"$1en");this.plural(/^(oxen)$/,"$1");this.plural(/(quiz)$/,"$1zes");this.singular(/s$/,"");this.singular(/(n)ews$/,"$1ews");this.singular(/([ti])a$/,"$1um");this.singular(/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/,"$1$2sis");this.singular(/(^analy)ses$/,"$1sis");this.singular(/([^f])ves$/,"$1fe");this.singular(/(hive)s$/,"$1");this.singular(/(tive)s$/,"$1");this.singular(/([lr])ves$/,"$1f");this.singular(/([^aeiouy]|qu)ies$/,"$1y");this.singular(/(s)eries$/,"$1eries");this.singular(/(m)ovies$/,"$1ovie");this.singular(/(x|ch|ss|sh)es$/,"$1");this.singular(/([m|l])ice$/,"$1ouse");this.singular(/(bus)es$/,"$1");this.singular(/(o)es$/,"$1");this.singular(/(shoe)s$/,"$1");this.singular(/(cris|ax|test)es$/,"$1is");this.singular(/(octop|vir)i$/,"$1us");this.singular(/(alias|status)es$/,"$1");this.singular(/^(ox)en/,"$1");this.singular(/(vert|ind)ices$/,"$1ex");this.singular(/(matr)ices$/,"$1ix");this.singular(/(quiz)zes$/,"$1");this.singular(/(database)s$/,"$1");this.irregular("person","people");this.irregular("man","men");this.irregular("child","children");this.irregular("sex","sexes");this.irregular("move","moves");this.irregular("cow","kine");_("equipment information rice money species series fish sheep jeans".split(/\s+/)).each(function(word){this.uncountable(word)},this);return this}};_.mixin(inflector.resetInflections())})(_);(function(){_.sum=function(array){return _.reduce(array,function(memo,num){return memo+num},0)}})();!function(root,String){"use strict";var nativeTrim=String.prototype.trim;var nativeTrimRight=String.prototype.trimRight;var nativeTrimLeft=String.prototype.trimLeft;var parseNumber=function(source){return source*1||0};var strRepeat=function(str,qty){if(qty<1)return"";var result="";while(qty>0){if(qty&1)result+=str;qty>>=1,str+=str}return result};var slice=[].slice;var defaultToWhiteSpace=function(characters){if(characters==null)return"\\s";else if(characters.source)return characters.source;else return"["+_s.escapeRegExp(characters)+"]"};function boolMatch(s,matchers){var i,matcher,down=s.toLowerCase();matchers=[].concat(matchers);for(i=0;i<matchers.length;i+=1){matcher=matchers[i];if(!matcher)continue;if(matcher.test&&matcher.test(s))return true;if(matcher.toLowerCase()===down)return true}}var escapeChars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"};var reversedEscapeChars={};for(var key in escapeChars)reversedEscapeChars[escapeChars[key]]=key;reversedEscapeChars["'"]="#39";var sprintf=function(){function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()}var str_repeat=strRepeat;var str_format=function(){if(!str_format.cache.hasOwnProperty(arguments[0])){str_format.cache[arguments[0]]=str_format.parse(arguments[0])}return str_format.format.call(null,str_format.cache[arguments[0]],arguments)};str_format.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type="",arg,output=[],i,k,match,pad,pad_character,pad_length;for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i]);if(node_type==="string"){output.push(parse_tree[i])}else if(node_type==="array"){match=parse_tree[i];if(match[2]){arg=argv[cursor];for(k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k])){throw new Error(sprintf('[_.sprintf] property "%s" does not exist',match[2][k]))}arg=arg[match[2][k]]}}else if(match[1]){arg=argv[match[1]]}else{arg=argv[cursor++]}if(/[^s]/.test(match[8])&&get_type(arg)!="number"){throw new Error(sprintf("[_.sprintf] expecting number but found %s",get_type(arg)))}switch(match[8]){case"b":arg=arg.toString(2);break;case"c":arg=String.fromCharCode(arg);break;case"d":arg=parseInt(arg,10);break;case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);break;case"o":arg=arg.toString(8);break;case"s":arg=(arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg;break;case"u":arg=Math.abs(arg);break;case"x":arg=arg.toString(16);break;case"X":arg=arg.toString(16).toUpperCase();break}arg=/[def]/.test(match[8])&&match[3]&&arg>=0?"+"+arg:arg;pad_character=match[4]?match[4]=="0"?"0":match[4].charAt(1):" ";pad_length=match[6]-String(arg).length;pad=match[6]?str_repeat(pad_character,pad_length):"";output.push(match[5]?arg+pad:pad+arg)}}return output.join("")};str_format.cache={};str_format.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0;while(_fmt){if((match=/^[^\x25]+/.exec(_fmt))!==null){parse_tree.push(match[0])}else if((match=/^\x25{2}/.exec(_fmt))!==null){parse_tree.push("%")}else if((match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt))!==null){if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if((field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);while((replacement_field=replacement_field.substring(field_match[0].length))!==""){if((field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1])}else if((field_match=/^\[(\d+)\]/.exec(replacement_field))!==null){field_list.push(field_match[1])}else{throw new Error("[_.sprintf] huh?")}}}else{throw new Error("[_.sprintf] huh?")}match[2]=field_list}else{arg_names|=2}if(arg_names===3){throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported")}parse_tree.push(match)}else{throw new Error("[_.sprintf] huh?")}_fmt=_fmt.substring(match[0].length)}return parse_tree};return str_format}();var _s={VERSION:"2.3.0",isBlank:function(str){if(str==null)str="";return/^\s*$/.test(str)},stripTags:function(str){if(str==null)return"";return String(str).replace(/<\/?[^>]+>/g,"")},capitalize:function(str){str=str==null?"":String(str);return str.charAt(0).toUpperCase()+str.slice(1)},chop:function(str,step){if(str==null)return[];str=String(str);step=~~step;return step>0?str.match(new RegExp(".{1,"+step+"}","g")):[str]},clean:function(str){return _s.strip(str).replace(/\s+/g," ")},count:function(str,substr){if(str==null||substr==null)return 0;str=String(str);substr=String(substr);var count=0,pos=0,length=substr.length;while(true){pos=str.indexOf(substr,pos);if(pos===-1)break;count++;pos+=length}return count},chars:function(str){if(str==null)return[];return String(str).split("")},swapCase:function(str){if(str==null)return"";return String(str).replace(/\S/g,function(c){return c===c.toUpperCase()?c.toLowerCase():c.toUpperCase()})},escapeHTML:function(str){if(str==null)return"";return String(str).replace(/[&<>"']/g,function(m){return"&"+reversedEscapeChars[m]+";"})},unescapeHTML:function(str){if(str==null)return"";return String(str).replace(/\&([^;]+);/g,function(entity,entityCode){var match;if(entityCode in escapeChars){return escapeChars[entityCode]}else if(match=entityCode.match(/^#x([\da-fA-F]+)$/)){return String.fromCharCode(parseInt(match[1],16))}else if(match=entityCode.match(/^#(\d+)$/)){return String.fromCharCode(~~match[1])}else{return entity}})},escapeRegExp:function(str){if(str==null)return"";return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(str,i,howmany,substr){var arr=_s.chars(str);arr.splice(~~i,~~howmany,substr);return arr.join("")},insert:function(str,i,substr){return _s.splice(str,i,0,substr)},include:function(str,needle){if(needle==="")return true;if(str==null)return false;return String(str).indexOf(needle)!==-1},join:function(){var args=slice.call(arguments),separator=args.shift();if(separator==null)separator="";return args.join(separator)},lines:function(str){if(str==null)return[];return String(str).split("\n")},reverse:function(str){return _s.chars(str).reverse().join("")},startsWith:function(str,starts){if(starts==="")return true;if(str==null||starts==null)return false;str=String(str);starts=String(starts);return str.length>=starts.length&&str.slice(0,starts.length)===starts},endsWith:function(str,ends){if(ends==="")return true;if(str==null||ends==null)return false;str=String(str);ends=String(ends);return str.length>=ends.length&&str.slice(str.length-ends.length)===ends},succ:function(str){if(str==null)return"";str=String(str);return str.slice(0,-1)+String.fromCharCode(str.charCodeAt(str.length-1)+1)},titleize:function(str){if(str==null)return"";str=String(str).toLowerCase();return str.replace(/(?:^|\s|-)\S/g,function(c){return c.toUpperCase()})},camelize:function(str){return _s.trim(str).replace(/[-_\s]+(.)?/g,function(match,c){return c?c.toUpperCase():""})},underscored:function(str){return _s.trim(str).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(str){return _s.trim(str).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(str){return _s.titleize(String(str).replace(/[\W_]/g," ")).replace(/\s/g,"")},humanize:function(str){return _s.capitalize(_s.underscored(str).replace(/_id$/,"").replace(/_/g," "))},trim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrim)return nativeTrim.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp("^"+characters+"+|"+characters+"+$","g"),"")},ltrim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrimLeft)return nativeTrimLeft.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp("^"+characters+"+"),"")},rtrim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrimRight)return nativeTrimRight.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp(characters+"+$"),"")},truncate:function(str,length,truncateStr){if(str==null)return"";str=String(str);truncateStr=truncateStr||"...";length=~~length;return str.length>length?str.slice(0,length)+truncateStr:str},prune:function(str,length,pruneStr){if(str==null)return"";str=String(str);length=~~length;pruneStr=pruneStr!=null?String(pruneStr):"...";if(str.length<=length)return str;var tmpl=function(c){return c.toUpperCase()!==c.toLowerCase()?"A":" "},template=str.slice(0,length+1).replace(/.(?=\W*\w*$)/g,tmpl);if(template.slice(template.length-2).match(/\w\w/))template=template.replace(/\s*\S+$/,"");else template=_s.rtrim(template.slice(0,template.length-1));return(template+pruneStr).length>str.length?str:str.slice(0,template.length)+pruneStr
},words:function(str,delimiter){if(_s.isBlank(str))return[];return _s.trim(str,delimiter).split(delimiter||/\s+/)},pad:function(str,length,padStr,type){str=str==null?"":String(str);length=~~length;var padlen=0;if(!padStr)padStr=" ";else if(padStr.length>1)padStr=padStr.charAt(0);switch(type){case"right":padlen=length-str.length;return str+strRepeat(padStr,padlen);case"both":padlen=length-str.length;return strRepeat(padStr,Math.ceil(padlen/2))+str+strRepeat(padStr,Math.floor(padlen/2));default:padlen=length-str.length;return strRepeat(padStr,padlen)+str}},lpad:function(str,length,padStr){return _s.pad(str,length,padStr)},rpad:function(str,length,padStr){return _s.pad(str,length,padStr,"right")},lrpad:function(str,length,padStr){return _s.pad(str,length,padStr,"both")},sprintf:sprintf,vsprintf:function(fmt,argv){argv.unshift(fmt);return sprintf.apply(null,argv)},toNumber:function(str,decimals){if(!str)return 0;str=_s.trim(str);if(!str.match(/^-?\d+(?:\.\d+)?$/))return NaN;return parseNumber(parseNumber(str).toFixed(~~decimals))},numberFormat:function(number,dec,dsep,tsep){if(isNaN(number)||number==null)return"";number=number.toFixed(~~dec);tsep=typeof tsep=="string"?tsep:",";var parts=number.split("."),fnums=parts[0],decimals=parts[1]?(dsep||".")+parts[1]:"";return fnums.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+tsep)+decimals},strRight:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str},strRightBack:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.lastIndexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str},strLeft:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(0,pos):str},strLeftBack:function(str,sep){if(str==null)return"";str+="";sep=sep!=null?""+sep:sep;var pos=str.lastIndexOf(sep);return~pos?str.slice(0,pos):str},toSentence:function(array,separator,lastSeparator,serial){separator=separator||", ";lastSeparator=lastSeparator||" and ";var a=array.slice(),lastMember=a.pop();if(array.length>2&&serial)lastSeparator=_s.rtrim(separator)+lastSeparator;return a.length?a.join(separator)+lastSeparator+lastMember:lastMember},toSentenceSerial:function(){var args=slice.call(arguments);args[3]=true;return _s.toSentence.apply(_s,args)},slugify:function(str){if(str==null)return"";var from="\u0105\xe0\xe1\xe4\xe2\xe3\xe5\xe6\u0103\u0107\u0119\xe8\xe9\xeb\xea\xec\xed\xef\xee\u0142\u0144\xf2\xf3\xf6\xf4\xf5\xf8\u015b\u0219\u021b\xf9\xfa\xfc\xfb\xf1\xe7\u017c\u017a",to="aaaaaaaaaceeeeeiiiilnoooooosstuuuunczz",regex=new RegExp(defaultToWhiteSpace(from),"g");str=String(str).toLowerCase().replace(regex,function(c){var index=from.indexOf(c);return to.charAt(index)||"-"});return _s.dasherize(str.replace(/[^\w\s-]/g,""))},surround:function(str,wrapper){return[wrapper,str,wrapper].join("")},quote:function(str,quoteChar){return _s.surround(str,quoteChar||'"')},unquote:function(str,quoteChar){quoteChar=quoteChar||'"';if(str[0]===quoteChar&&str[str.length-1]===quoteChar)return str.slice(1,str.length-1);else return str},exports:function(){var result={};for(var prop in this){if(!this.hasOwnProperty(prop)||prop.match(/^(?:include|contains|reverse)$/))continue;result[prop]=this[prop]}return result},repeat:function(str,qty,separator){if(str==null)return"";qty=~~qty;if(separator==null)return strRepeat(String(str),qty);for(var repeat=[];qty>0;repeat[--qty]=str){}return repeat.join(separator)},naturalCmp:function(str1,str2){if(str1==str2)return 0;if(!str1)return-1;if(!str2)return 1;var cmpRegex=/(\.\d+)|(\d+)|(\D+)/g,tokens1=String(str1).toLowerCase().match(cmpRegex),tokens2=String(str2).toLowerCase().match(cmpRegex),count=Math.min(tokens1.length,tokens2.length);for(var i=0;i<count;i++){var a=tokens1[i],b=tokens2[i];if(a!==b){var num1=parseInt(a,10);if(!isNaN(num1)){var num2=parseInt(b,10);if(!isNaN(num2)&&num1-num2)return num1-num2}return a<b?-1:1}}if(tokens1.length===tokens2.length)return tokens1.length-tokens2.length;return str1<str2?-1:1},levenshtein:function(str1,str2){if(str1==null&&str2==null)return 0;if(str1==null)return String(str2).length;if(str2==null)return String(str1).length;str1=String(str1);str2=String(str2);var current=[],prev,value;for(var i=0;i<=str2.length;i++)for(var j=0;j<=str1.length;j++){if(i&&j)if(str1.charAt(j-1)===str2.charAt(i-1))value=prev;else value=Math.min(current[j],current[j-1],prev)+1;else value=i+j;prev=current[j];current[j]=value}return current.pop()},toBoolean:function(str,trueValues,falseValues){if(typeof str==="number")str=""+str;if(typeof str!=="string")return!!str;str=_s.trim(str);if(boolMatch(str,trueValues||["true","1"]))return true;if(boolMatch(str,falseValues||["false","0"]))return false}};_s.strip=_s.trim;_s.lstrip=_s.ltrim;_s.rstrip=_s.rtrim;_s.center=_s.lrpad;_s.rjust=_s.lpad;_s.ljust=_s.rpad;_s.contains=_s.include;_s.q=_s.quote;_s.toBool=_s.toBoolean;if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)module.exports=_s;exports._s=_s}if(typeof define==="function"&&define.amd)define("underscore.string",[],function(){return _s});root._=root._||{};root._.string=root._.str=_s}(this,String);(function(undefined){var moment,VERSION="2.4.0",round=Math.round,i,YEAR=0,MONTH=1,DATE=2,HOUR=3,MINUTE=4,SECOND=5,MILLISECOND=6,languages={},hasModule=typeof module!=="undefined"&&module.exports,aspNetJsonRegex=/^\/?Date\((\-?\d+)/i,aspNetTimeSpanJsonRegex=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,isoDurationRegex=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,formattingTokens=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,localFormattingTokens=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,parseTokenOneOrTwoDigits=/\d\d?/,parseTokenOneToThreeDigits=/\d{1,3}/,parseTokenThreeDigits=/\d{3}/,parseTokenFourDigits=/\d{1,4}/,parseTokenSixDigits=/[+\-]?\d{1,6}/,parseTokenDigits=/\d+/,parseTokenWord=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,parseTokenTimezone=/Z|[\+\-]\d\d:?\d\d/i,parseTokenT=/T/i,parseTokenTimestampMs=/[\+\-]?\d+(\.\d{1,3})?/,isoRegex=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d:?\d\d|Z)?)?$/,isoFormat="YYYY-MM-DDTHH:mm:ssZ",isoDates=["YYYY-MM-DD","GGGG-[W]WW","GGGG-[W]WW-E","YYYY-DDD"],isoTimes=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],parseTimezoneChunker=/([\+\-]|\d\d)/gi,proxyGettersAndSetters="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),unitMillisecondFactors={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},unitAliases={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},camelFunctions={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},formatFunctions={},ordinalizeTokens="DDD w W M D d".split(" "),paddedTokens="M D H h m s w W".split(" "),formatTokenFunctions={M:function(){return this.month()+1},MMM:function(format){return this.lang().monthsShort(this,format)},MMMM:function(format){return this.lang().months(this,format)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(format){return this.lang().weekdaysMin(this,format)},ddd:function(format){return this.lang().weekdaysShort(this,format)},dddd:function(format){return this.lang().weekdays(this,format)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return leftZeroFill(this.year()%100,2)},YYYY:function(){return leftZeroFill(this.year(),4)},YYYYY:function(){return leftZeroFill(this.year(),5)},gg:function(){return leftZeroFill(this.weekYear()%100,2)},gggg:function(){return this.weekYear()},ggggg:function(){return leftZeroFill(this.weekYear(),5)},GG:function(){return leftZeroFill(this.isoWeekYear()%100,2)},GGGG:function(){return this.isoWeekYear()},GGGGG:function(){return leftZeroFill(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),true)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),false)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return toInt(this.milliseconds()/100)},SS:function(){return leftZeroFill(toInt(this.milliseconds()/10),2)},SSS:function(){return leftZeroFill(this.milliseconds(),3)},SSSS:function(){return leftZeroFill(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-"}return b+leftZeroFill(toInt(a/60),2)+":"+leftZeroFill(toInt(a)%60,2)},ZZ:function(){var a=-this.zone(),b="+";if(a<0){a=-a;b="-"}return b+leftZeroFill(toInt(10*a/6),4)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()}},lists=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];function padToken(func,count){return function(a){return leftZeroFill(func.call(this,a),count)}}function ordinalizeToken(func,period){return function(a){return this.lang().ordinal(func.call(this,a),period)}}while(ordinalizeTokens.length){i=ordinalizeTokens.pop();formatTokenFunctions[i+"o"]=ordinalizeToken(formatTokenFunctions[i],i)}while(paddedTokens.length){i=paddedTokens.pop();formatTokenFunctions[i+i]=padToken(formatTokenFunctions[i],2)}formatTokenFunctions.DDDD=padToken(formatTokenFunctions.DDD,3);function Language(){}function Moment(config){checkOverflow(config);extend(this,config)}function Duration(duration){var normalizedInput=normalizeObjectUnits(duration),years=normalizedInput.year||0,months=normalizedInput.month||0,weeks=normalizedInput.week||0,days=normalizedInput.day||0,hours=normalizedInput.hour||0,minutes=normalizedInput.minute||0,seconds=normalizedInput.second||0,milliseconds=normalizedInput.millisecond||0;this._input=duration;this._milliseconds=+milliseconds+seconds*1e3+minutes*6e4+hours*36e5;this._days=+days+weeks*7;this._months=+months+years*12;this._data={};this._bubble()}function extend(a,b){for(var i in b){if(b.hasOwnProperty(i)){a[i]=b[i]}}if(b.hasOwnProperty("toString")){a.toString=b.toString}if(b.hasOwnProperty("valueOf")){a.valueOf=b.valueOf}return a}function absRound(number){if(number<0){return Math.ceil(number)}else{return Math.floor(number)}}function leftZeroFill(number,targetLength){var output=number+"";while(output.length<targetLength){output="0"+output}return output}function addOrSubtractDurationFromMoment(mom,duration,isAdding,ignoreUpdateOffset){var milliseconds=duration._milliseconds,days=duration._days,months=duration._months,minutes,hours;if(milliseconds){mom._d.setTime(+mom._d+milliseconds*isAdding)}if(days||months){minutes=mom.minute();hours=mom.hour()}if(days){mom.date(mom.date()+days*isAdding)}if(months){mom.month(mom.month()+months*isAdding)}if(milliseconds&&!ignoreUpdateOffset){moment.updateOffset(mom)}if(days||months){mom.minute(minutes);mom.hour(hours)}}function isArray(input){return Object.prototype.toString.call(input)==="[object Array]"}function isDate(input){return Object.prototype.toString.call(input)==="[object Date]"||input instanceof Date}function compareArrays(array1,array2,dontConvert){var len=Math.min(array1.length,array2.length),lengthDiff=Math.abs(array1.length-array2.length),diffs=0,i;for(i=0;i<len;i++){if(dontConvert&&array1[i]!==array2[i]||!dontConvert&&toInt(array1[i])!==toInt(array2[i])){diffs++}}return diffs+lengthDiff}function normalizeUnits(units){if(units){var lowered=units.toLowerCase().replace(/(.)s$/,"$1");units=unitAliases[units]||camelFunctions[lowered]||lowered}return units}function normalizeObjectUnits(inputObject){var normalizedInput={},normalizedProp,prop,index;for(prop in inputObject){if(inputObject.hasOwnProperty(prop)){normalizedProp=normalizeUnits(prop);if(normalizedProp){normalizedInput[normalizedProp]=inputObject[prop]}}}return normalizedInput}function makeList(field){var count,setter;if(field.indexOf("week")===0){count=7;setter="day"}else if(field.indexOf("month")===0){count=12;setter="month"}else{return}moment[field]=function(format,index){var i,getter,method=moment.fn._lang[field],results=[];if(typeof format==="number"){index=format;format=undefined}getter=function(i){var m=moment().utc().set(setter,i);return method.call(moment.fn._lang,m,format||"")};if(index!=null){return getter(index)}else{for(i=0;i<count;i++){results.push(getter(i))}return results}}}function toInt(argumentForCoercion){var coercedNumber=+argumentForCoercion,value=0;if(coercedNumber!==0&&isFinite(coercedNumber)){if(coercedNumber>=0){value=Math.floor(coercedNumber)}else{value=Math.ceil(coercedNumber)}}return value}function daysInMonth(year,month){return new Date(Date.UTC(year,month+1,0)).getUTCDate()}function daysInYear(year){return isLeapYear(year)?366:365}function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0}function checkOverflow(m){var overflow;if(m._a&&m._pf.overflow===-2){overflow=m._a[MONTH]<0||m._a[MONTH]>11?MONTH:m._a[DATE]<1||m._a[DATE]>daysInMonth(m._a[YEAR],m._a[MONTH])?DATE:m._a[HOUR]<0||m._a[HOUR]>23?HOUR:m._a[MINUTE]<0||m._a[MINUTE]>59?MINUTE:m._a[SECOND]<0||m._a[SECOND]>59?SECOND:m._a[MILLISECOND]<0||m._a[MILLISECOND]>999?MILLISECOND:-1;if(m._pf._overflowDayOfYear&&(overflow<YEAR||overflow>DATE)){overflow=DATE}m._pf.overflow=overflow}}function initializeParsingFlags(config){config._pf={empty:false,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:false,invalidMonth:null,invalidFormat:false,userInvalidated:false,iso:false}}function isValid(m){if(m._isValid==null){m._isValid=!isNaN(m._d.getTime())&&m._pf.overflow<0&&!m._pf.empty&&!m._pf.invalidMonth&&!m._pf.nullInput&&!m._pf.invalidFormat&&!m._pf.userInvalidated;if(m._strict){m._isValid=m._isValid&&m._pf.charsLeftOver===0&&m._pf.unusedTokens.length===0}}return m._isValid}function normalizeLanguage(key){return key?key.toLowerCase().replace("_","-"):key}extend(Language.prototype,{set:function(config){var prop,i;for(i in config){prop=config[i];if(typeof prop==="function"){this[i]=prop}else{this["_"+i]=prop}}},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(m){return this._months[m.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(m){return this._monthsShort[m.month()]},monthsParse:function(monthName){var i,mom,regex;if(!this._monthsParse){this._monthsParse=[]}for(i=0;i<12;i++){if(!this._monthsParse[i]){mom=moment.utc([2e3,i]);regex="^"+this.months(mom,"")+"|^"+this.monthsShort(mom,"");this._monthsParse[i]=new RegExp(regex.replace(".",""),"i")}if(this._monthsParse[i].test(monthName)){return i}}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(m){return this._weekdays[m.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(m){return this._weekdaysShort[m.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(m){return this._weekdaysMin[m.day()]},weekdaysParse:function(weekdayName){var i,mom,regex;if(!this._weekdaysParse){this._weekdaysParse=[]}for(i=0;i<7;i++){if(!this._weekdaysParse[i]){mom=moment([2e3,1]).day(i);regex="^"+this.weekdays(mom,"")+"|^"+this.weekdaysShort(mom,"")+"|^"+this.weekdaysMin(mom,"");this._weekdaysParse[i]=new RegExp(regex.replace(".",""),"i")}if(this._weekdaysParse[i].test(weekdayName)){return i}}},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(key){var output=this._longDateFormat[key];if(!output&&this._longDateFormat[key.toUpperCase()]){output=this._longDateFormat[key.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(val){return val.slice(1)});this._longDateFormat[key]=output}return output},isPM:function(input){return(input+"").toLowerCase().charAt(0)==="p"},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(hours,minutes,isLower){if(hours>11){return isLower?"pm":"PM"}else{return isLower?"am":"AM"}},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(key,mom){var output=this._calendar[key];return typeof output==="function"?output.apply(mom):output},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(number,withoutSuffix,string,isFuture){var output=this._relativeTime[string];return typeof output==="function"?output(number,withoutSuffix,string,isFuture):output.replace(/%d/i,number)},pastFuture:function(diff,output){var format=this._relativeTime[diff>0?"future":"past"];return typeof format==="function"?format(output):format.replace(/%s/i,output)},ordinal:function(number){return this._ordinal.replace("%d",number)},_ordinal:"%d",preparse:function(string){return string},postformat:function(string){return string},week:function(mom){return weekOfYear(mom,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}});function loadLang(key,values){values.abbr=key;if(!languages[key]){languages[key]=new Language}languages[key].set(values);return languages[key]}function unloadLang(key){delete languages[key]}function getLangDefinition(key){var i=0,j,lang,next,split,get=function(k){if(!languages[k]&&hasModule){try{require("./lang/"+k)}catch(e){}}return languages[k]};if(!key){return moment.fn._lang}if(!isArray(key)){lang=get(key);if(lang){return lang}key=[key]}while(i<key.length){split=normalizeLanguage(key[i]).split("-");j=split.length;next=normalizeLanguage(key[i+1]);next=next?next.split("-"):null;while(j>0){lang=get(split.slice(0,j).join("-"));if(lang){return lang}if(next&&next.length>=j&&compareArrays(split,next,true)>=j-1){break}j--}i++}return moment.fn._lang}function removeFormattingTokens(input){if(input.match(/\[[\s\S]/)){return input.replace(/^\[|\]$/g,"")}return input.replace(/\\/g,"")}function makeFormatFunction(format){var array=format.match(formattingTokens),i,length;for(i=0,length=array.length;i<length;i++){if(formatTokenFunctions[array[i]]){array[i]=formatTokenFunctions[array[i]]}else{array[i]=removeFormattingTokens(array[i])}}return function(mom){var output="";for(i=0;i<length;i++){output+=array[i]instanceof Function?array[i].call(mom,format):array[i]}return output}}function formatMoment(m,format){if(!m.isValid()){return m.lang().invalidDate()}format=expandFormat(format,m.lang());if(!formatFunctions[format]){formatFunctions[format]=makeFormatFunction(format)}return formatFunctions[format](m)}function expandFormat(format,lang){var i=5;function replaceLongDateFormatTokens(input){return lang.longDateFormat(input)||input}localFormattingTokens.lastIndex=0;while(i>=0&&localFormattingTokens.test(format)){format=format.replace(localFormattingTokens,replaceLongDateFormatTokens);localFormattingTokens.lastIndex=0;i-=1}return format}function getParseRegexForToken(token,config){var a;switch(token){case"DDDD":return parseTokenThreeDigits;case"YYYY":case"GGGG":case"gggg":return parseTokenFourDigits;case"YYYYY":case"GGGGG":case"ggggg":return parseTokenSixDigits;case"S":case"SS":case"SSS":case"DDD":return parseTokenOneToThreeDigits;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return parseTokenWord;case"a":case"A":return getLangDefinition(config._l)._meridiemParse;case"X":return parseTokenTimestampMs;case"Z":case"ZZ":return parseTokenTimezone;case"T":return parseTokenT;case"SSSS":return parseTokenDigits;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"ww":case"W":case"WW":case"e":case"E":return parseTokenOneOrTwoDigits;default:a=new RegExp(regexpEscape(unescapeFormat(token.replace("\\","")),"i"));return a}}function timezoneMinutesFromString(string){var tzchunk=(parseTokenTimezone.exec(string)||[])[0],parts=(tzchunk+"").match(parseTimezoneChunker)||["-",0,0],minutes=+(parts[1]*60)+toInt(parts[2]);return parts[0]==="+"?-minutes:minutes}function addTimeToArrayFromToken(token,input,config){var a,datePartArray=config._a;switch(token){case"M":case"MM":if(input!=null){datePartArray[MONTH]=toInt(input)-1}break;case"MMM":case"MMMM":a=getLangDefinition(config._l).monthsParse(input);if(a!=null){datePartArray[MONTH]=a}else{config._pf.invalidMonth=input}break;case"D":case"DD":if(input!=null){datePartArray[DATE]=toInt(input)}break;case"DDD":case"DDDD":if(input!=null){config._dayOfYear=toInt(input)}break;case"YY":datePartArray[YEAR]=toInt(input)+(toInt(input)>68?1900:2e3);break;case"YYYY":case"YYYYY":datePartArray[YEAR]=toInt(input);break;case"a":case"A":config._isPm=getLangDefinition(config._l).isPM(input);break;case"H":case"HH":case"h":case"hh":datePartArray[HOUR]=toInt(input);break;case"m":case"mm":datePartArray[MINUTE]=toInt(input);break;case"s":case"ss":datePartArray[SECOND]=toInt(input);break;case"S":case"SS":case"SSS":case"SSSS":datePartArray[MILLISECOND]=toInt(("0."+input)*1e3);break;case"X":config._d=new Date(parseFloat(input)*1e3);break;case"Z":case"ZZ":config._useUTC=true;config._tzm=timezoneMinutesFromString(input);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":token=token.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":token=token.substr(0,2);if(input){config._w=config._w||{};config._w[token]=input}break}}function dateFromConfig(config){var i,date,input=[],currentDate,yearToUse,fixYear,w,temp,lang,weekday,week;if(config._d){return}currentDate=currentDateArray(config);if(config._w&&config._a[DATE]==null&&config._a[MONTH]==null){fixYear=function(val){return val?val.length<3?parseInt(val,10)>68?"19"+val:"20"+val:val:config._a[YEAR]==null?moment().weekYear():config._a[YEAR]};w=config._w;if(w.GG!=null||w.W!=null||w.E!=null){temp=dayOfYearFromWeeks(fixYear(w.GG),w.W||1,w.E,4,1)}else{lang=getLangDefinition(config._l);weekday=w.d!=null?parseWeekday(w.d,lang):w.e!=null?parseInt(w.e,10)+lang._week.dow:0;week=parseInt(w.w,10)||1;if(w.d!=null&&weekday<lang._week.dow){week++}temp=dayOfYearFromWeeks(fixYear(w.gg),week,weekday,lang._week.doy,lang._week.dow)}config._a[YEAR]=temp.year;config._dayOfYear=temp.dayOfYear}if(config._dayOfYear){yearToUse=config._a[YEAR]==null?currentDate[YEAR]:config._a[YEAR];if(config._dayOfYear>daysInYear(yearToUse)){config._pf._overflowDayOfYear=true}date=makeUTCDate(yearToUse,0,config._dayOfYear);config._a[MONTH]=date.getUTCMonth();config._a[DATE]=date.getUTCDate()}for(i=0;i<3&&config._a[i]==null;++i){config._a[i]=input[i]=currentDate[i]}for(;i<7;i++){config._a[i]=input[i]=config._a[i]==null?i===2?1:0:config._a[i]}input[HOUR]+=toInt((config._tzm||0)/60);input[MINUTE]+=toInt((config._tzm||0)%60);config._d=(config._useUTC?makeUTCDate:makeDate).apply(null,input)}function dateFromObject(config){var normalizedInput;if(config._d){return}normalizedInput=normalizeObjectUnits(config._i);config._a=[normalizedInput.year,normalizedInput.month,normalizedInput.day,normalizedInput.hour,normalizedInput.minute,normalizedInput.second,normalizedInput.millisecond];dateFromConfig(config)}function currentDateArray(config){var now=new Date;if(config._useUTC){return[now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()]}else{return[now.getFullYear(),now.getMonth(),now.getDate()]}}function makeDateFromStringAndFormat(config){config._a=[];config._pf.empty=true;var lang=getLangDefinition(config._l),string=""+config._i,i,parsedInput,tokens,token,skipped,stringLength=string.length,totalParsedInputLength=0;tokens=expandFormat(config._f,lang).match(formattingTokens)||[];for(i=0;i<tokens.length;i++){token=tokens[i];parsedInput=(getParseRegexForToken(token,config).exec(string)||[])[0];if(parsedInput){skipped=string.substr(0,string.indexOf(parsedInput));if(skipped.length>0){config._pf.unusedInput.push(skipped)}string=string.slice(string.indexOf(parsedInput)+parsedInput.length);totalParsedInputLength+=parsedInput.length}if(formatTokenFunctions[token]){if(parsedInput){config._pf.empty=false}else{config._pf.unusedTokens.push(token)}addTimeToArrayFromToken(token,parsedInput,config)}else if(config._strict&&!parsedInput){config._pf.unusedTokens.push(token)}}config._pf.charsLeftOver=stringLength-totalParsedInputLength;if(string.length>0){config._pf.unusedInput.push(string)}if(config._isPm&&config._a[HOUR]<12){config._a[HOUR]+=12}if(config._isPm===false&&config._a[HOUR]===12){config._a[HOUR]=0}dateFromConfig(config);checkOverflow(config)}function unescapeFormat(s){return s.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(matched,p1,p2,p3,p4){return p1||p2||p3||p4})}function regexpEscape(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function makeDateFromStringAndArray(config){var tempConfig,bestMoment,scoreToBeat,i,currentScore;if(config._f.length===0){config._pf.invalidFormat=true;config._d=new Date(NaN);return}for(i=0;i<config._f.length;i++){currentScore=0;tempConfig=extend({},config);initializeParsingFlags(tempConfig);tempConfig._f=config._f[i];makeDateFromStringAndFormat(tempConfig);if(!isValid(tempConfig)){continue}currentScore+=tempConfig._pf.charsLeftOver;currentScore+=tempConfig._pf.unusedTokens.length*10;tempConfig._pf.score=currentScore;if(scoreToBeat==null||currentScore<scoreToBeat){scoreToBeat=currentScore;bestMoment=tempConfig}}extend(config,bestMoment||tempConfig)}function makeDateFromString(config){var i,string=config._i,match=isoRegex.exec(string);if(match){config._pf.iso=true;for(i=4;i>0;i--){if(match[i]){config._f=isoDates[i-1]+(match[6]||" ");break}}for(i=0;i<4;i++){if(isoTimes[i][1].exec(string)){config._f+=isoTimes[i][0];break}}if(parseTokenTimezone.exec(string)){config._f+="Z"}makeDateFromStringAndFormat(config)}else{config._d=new Date(string)}}function makeDateFromInput(config){var input=config._i,matched=aspNetJsonRegex.exec(input);if(input===undefined){config._d=new Date}else if(matched){config._d=new Date(+matched[1])}else if(typeof input==="string"){makeDateFromString(config)}else if(isArray(input)){config._a=input.slice(0);dateFromConfig(config)}else if(isDate(input)){config._d=new Date(+input)}else if(typeof input==="object"){dateFromObject(config)}else{config._d=new Date(input)}}function makeDate(y,m,d,h,M,s,ms){var date=new Date(y,m,d,h,M,s,ms);if(y<1970){date.setFullYear(y)}return date}function makeUTCDate(y){var date=new Date(Date.UTC.apply(null,arguments));if(y<1970){date.setUTCFullYear(y)}return date}function parseWeekday(input,language){if(typeof input==="string"){if(!isNaN(input)){input=parseInt(input,10)}else{input=language.weekdaysParse(input);if(typeof input!=="number"){return null}}}return input}function substituteTimeAgo(string,number,withoutSuffix,isFuture,lang){return lang.relativeTime(number||1,!!withoutSuffix,string,isFuture)}function relativeTime(milliseconds,withoutSuffix,lang){var seconds=round(Math.abs(milliseconds)/1e3),minutes=round(seconds/60),hours=round(minutes/60),days=round(hours/24),years=round(days/365),args=seconds<45&&["s",seconds]||minutes===1&&["m"]||minutes<45&&["mm",minutes]||hours===1&&["h"]||hours<22&&["hh",hours]||days===1&&["d"]||days<=25&&["dd",days]||days<=45&&["M"]||days<345&&["MM",round(days/30)]||years===1&&["y"]||["yy",years];args[2]=withoutSuffix;args[3]=milliseconds>0;args[4]=lang;return substituteTimeAgo.apply({},args)}function weekOfYear(mom,firstDayOfWeek,firstDayOfWeekOfYear){var end=firstDayOfWeekOfYear-firstDayOfWeek,daysToDayOfWeek=firstDayOfWeekOfYear-mom.day(),adjustedMoment;if(daysToDayOfWeek>end){daysToDayOfWeek-=7}if(daysToDayOfWeek<end-7){daysToDayOfWeek+=7}adjustedMoment=moment(mom).add("d",daysToDayOfWeek);return{week:Math.ceil(adjustedMoment.dayOfYear()/7),year:adjustedMoment.year()}}function dayOfYearFromWeeks(year,week,weekday,firstDayOfWeekOfYear,firstDayOfWeek){var d=new Date(Date.UTC(year,0)).getUTCDay(),daysToAdd,dayOfYear;weekday=weekday!=null?weekday:firstDayOfWeek;daysToAdd=firstDayOfWeek-d+(d>firstDayOfWeekOfYear?7:0);dayOfYear=7*(week-1)+(weekday-firstDayOfWeek)+daysToAdd+1;return{year:dayOfYear>0?year:year-1,dayOfYear:dayOfYear>0?dayOfYear:daysInYear(year-1)+dayOfYear}}function makeMoment(config){var input=config._i,format=config._f;if(typeof config._pf==="undefined"){initializeParsingFlags(config)}if(input===null){return moment.invalid({nullInput:true})}if(typeof input==="string"){config._i=input=getLangDefinition().preparse(input)}if(moment.isMoment(input)){config=extend({},input);config._d=new Date(+input._d)}else if(format){if(isArray(format)){makeDateFromStringAndArray(config)}else{makeDateFromStringAndFormat(config)}}else{makeDateFromInput(config)}return new Moment(config)}moment=function(input,format,lang,strict){if(typeof lang==="boolean"){strict=lang;lang=undefined}return makeMoment({_i:input,_f:format,_l:lang,_strict:strict,_isUTC:false})};moment.utc=function(input,format,lang,strict){var m;if(typeof lang==="boolean"){strict=lang;lang=undefined}m=makeMoment({_useUTC:true,_isUTC:true,_l:lang,_i:input,_f:format,_strict:strict}).utc();return m};moment.unix=function(input){return moment(input*1e3)};moment.duration=function(input,key){var isDuration=moment.isDuration(input),isNumber=typeof input==="number",duration=isDuration?input._input:isNumber?{}:input,match=null,sign,ret,parseIso,timeEmpty,dateTimeEmpty;if(isNumber){if(key){duration[key]=input}else{duration.milliseconds=input}}else if(!!(match=aspNetTimeSpanJsonRegex.exec(input))){sign=match[1]==="-"?-1:1;duration={y:0,d:toInt(match[DATE])*sign,h:toInt(match[HOUR])*sign,m:toInt(match[MINUTE])*sign,s:toInt(match[SECOND])*sign,ms:toInt(match[MILLISECOND])*sign}}else if(!!(match=isoDurationRegex.exec(input))){sign=match[1]==="-"?-1:1;parseIso=function(inp){var res=inp&&parseFloat(inp.replace(",","."));return(isNaN(res)?0:res)*sign};duration={y:parseIso(match[2]),M:parseIso(match[3]),d:parseIso(match[4]),h:parseIso(match[5]),m:parseIso(match[6]),s:parseIso(match[7]),w:parseIso(match[8])}}ret=new Duration(duration);if(isDuration&&input.hasOwnProperty("_lang")){ret._lang=input._lang}return ret};moment.version=VERSION;moment.defaultFormat=isoFormat;moment.updateOffset=function(){};moment.lang=function(key,values){var r;if(!key){return moment.fn._lang._abbr}if(values){loadLang(normalizeLanguage(key),values)}else if(values===null){unloadLang(key);key="en"}else if(!languages[key]){getLangDefinition(key)}r=moment.duration.fn._lang=moment.fn._lang=getLangDefinition(key);return r._abbr};moment.langData=function(key){if(key&&key._lang&&key._lang._abbr){key=key._lang._abbr}return getLangDefinition(key)};moment.isMoment=function(obj){return obj instanceof Moment};moment.isDuration=function(obj){return obj instanceof Duration};for(i=lists.length-1;i>=0;--i){makeList(lists[i])}moment.normalizeUnits=function(units){return normalizeUnits(units)};moment.invalid=function(flags){var m=moment.utc(NaN);if(flags!=null){extend(m._pf,flags)}else{m._pf.userInvalidated=true}return m};moment.parseZone=function(input){return moment(input).parseZone()};extend(moment.fn=Moment.prototype,{clone:function(){return moment(this)},valueOf:function(){return+this._d+(this._offset||0)*6e4},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){return formatMoment(moment(this).utc(),"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")
},toArray:function(){var m=this;return[m.year(),m.month(),m.date(),m.hours(),m.minutes(),m.seconds(),m.milliseconds()]},isValid:function(){return isValid(this)},isDSTShifted:function(){if(this._a){return this.isValid()&&compareArrays(this._a,(this._isUTC?moment.utc(this._a):moment(this._a)).toArray())>0}return false},parsingFlags:function(){return extend({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){this.zone(0);this._isUTC=false;return this},format:function(inputString){var output=formatMoment(this,inputString||moment.defaultFormat);return this.lang().postformat(output)},add:function(input,val){var dur;if(typeof input==="string"){dur=moment.duration(+val,input)}else{dur=moment.duration(input,val)}addOrSubtractDurationFromMoment(this,dur,1);return this},subtract:function(input,val){var dur;if(typeof input==="string"){dur=moment.duration(+val,input)}else{dur=moment.duration(input,val)}addOrSubtractDurationFromMoment(this,dur,-1);return this},diff:function(input,units,asFloat){var that=this._isUTC?moment(input).zone(this._offset||0):moment(input).local(),zoneDiff=(this.zone()-that.zone())*6e4,diff,output;units=normalizeUnits(units);if(units==="year"||units==="month"){diff=(this.daysInMonth()+that.daysInMonth())*432e5;output=(this.year()-that.year())*12+(this.month()-that.month());output+=(this-moment(this).startOf("month")-(that-moment(that).startOf("month")))/diff;output-=(this.zone()-moment(this).startOf("month").zone()-(that.zone()-moment(that).startOf("month").zone()))*6e4/diff;if(units==="year"){output=output/12}}else{diff=this-that;output=units==="second"?diff/1e3:units==="minute"?diff/6e4:units==="hour"?diff/36e5:units==="day"?(diff-zoneDiff)/864e5:units==="week"?(diff-zoneDiff)/6048e5:diff}return asFloat?output:absRound(output)},from:function(time,withoutSuffix){return moment.duration(this.diff(time)).lang(this.lang()._abbr).humanize(!withoutSuffix)},fromNow:function(withoutSuffix){return this.from(moment(),withoutSuffix)},calendar:function(){var diff=this.diff(moment().zone(this.zone()).startOf("day"),"days",true),format=diff<-6?"sameElse":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(format,this))},isLeapYear:function(){return isLeapYear(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(input){var day=this._isUTC?this._d.getUTCDay():this._d.getDay();if(input!=null){input=parseWeekday(input,this.lang());return this.add({d:input-day})}else{return day}},month:function(input){var utc=this._isUTC?"UTC":"",dayOfMonth;if(input!=null){if(typeof input==="string"){input=this.lang().monthsParse(input);if(typeof input!=="number"){return this}}dayOfMonth=this.date();this.date(1);this._d["set"+utc+"Month"](input);this.date(Math.min(dayOfMonth,this.daysInMonth()));moment.updateOffset(this);return this}else{return this._d["get"+utc+"Month"]()}},startOf:function(units){units=normalizeUnits(units);switch(units){case"year":this.month(0);case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}if(units==="week"){this.weekday(0)}else if(units==="isoWeek"){this.isoWeekday(1)}return this},endOf:function(units){units=normalizeUnits(units);return this.startOf(units).add(units==="isoWeek"?"week":units,1).subtract("ms",1)},isAfter:function(input,units){units=typeof units!=="undefined"?units:"millisecond";return+this.clone().startOf(units)>+moment(input).startOf(units)},isBefore:function(input,units){units=typeof units!=="undefined"?units:"millisecond";return+this.clone().startOf(units)<+moment(input).startOf(units)},isSame:function(input,units){units=typeof units!=="undefined"?units:"millisecond";return+this.clone().startOf(units)===+moment(input).startOf(units)},min:function(other){other=moment.apply(null,arguments);return other<this?this:other},max:function(other){other=moment.apply(null,arguments);return other>this?this:other},zone:function(input){var offset=this._offset||0;if(input!=null){if(typeof input==="string"){input=timezoneMinutesFromString(input)}if(Math.abs(input)<16){input=input*60}this._offset=input;this._isUTC=true;if(offset!==input){addOrSubtractDurationFromMoment(this,moment.duration(offset-input,"m"),1,true)}}else{return this._isUTC?offset:this._d.getTimezoneOffset()}return this},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){if(typeof this._i==="string"){this.zone(this._i)}return this},hasAlignedHourOffset:function(input){if(!input){input=0}else{input=moment(input).zone()}return(this.zone()-input)%60===0},daysInMonth:function(){return daysInMonth(this.year(),this.month())},dayOfYear:function(input){var dayOfYear=round((moment(this).startOf("day")-moment(this).startOf("year"))/864e5)+1;return input==null?dayOfYear:this.add("d",input-dayOfYear)},weekYear:function(input){var year=weekOfYear(this,this.lang()._week.dow,this.lang()._week.doy).year;return input==null?year:this.add("y",input-year)},isoWeekYear:function(input){var year=weekOfYear(this,1,4).year;return input==null?year:this.add("y",input-year)},week:function(input){var week=this.lang().week(this);return input==null?week:this.add("d",(input-week)*7)},isoWeek:function(input){var week=weekOfYear(this,1,4).week;return input==null?week:this.add("d",(input-week)*7)},weekday:function(input){var weekday=(this.day()+7-this.lang()._week.dow)%7;return input==null?weekday:this.add("d",input-weekday)},isoWeekday:function(input){return input==null?this.day()||7:this.day(this.day()%7?input:input-7)},get:function(units){units=normalizeUnits(units);return this[units]()},set:function(units,value){units=normalizeUnits(units);if(typeof this[units]==="function"){this[units](value)}return this},lang:function(key){if(key===undefined){return this._lang}else{this._lang=getLangDefinition(key);return this}}});function makeGetterAndSetter(name,key){moment.fn[name]=moment.fn[name+"s"]=function(input){var utc=this._isUTC?"UTC":"";if(input!=null){this._d["set"+utc+key](input);moment.updateOffset(this);return this}else{return this._d["get"+utc+key]()}}}for(i=0;i<proxyGettersAndSetters.length;i++){makeGetterAndSetter(proxyGettersAndSetters[i].toLowerCase().replace(/s$/,""),proxyGettersAndSetters[i])}makeGetterAndSetter("year","FullYear");moment.fn.days=moment.fn.day;moment.fn.months=moment.fn.month;moment.fn.weeks=moment.fn.week;moment.fn.isoWeeks=moment.fn.isoWeek;moment.fn.toJSON=moment.fn.toISOString;extend(moment.duration.fn=Duration.prototype,{_bubble:function(){var milliseconds=this._milliseconds,days=this._days,months=this._months,data=this._data,seconds,minutes,hours,years;data.milliseconds=milliseconds%1e3;seconds=absRound(milliseconds/1e3);data.seconds=seconds%60;minutes=absRound(seconds/60);data.minutes=minutes%60;hours=absRound(minutes/60);data.hours=hours%24;days+=absRound(hours/24);data.days=days%30;months+=absRound(days/30);data.months=months%12;years=absRound(months/12);data.years=years},weeks:function(){return absRound(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*864e5+this._months%12*2592e6+toInt(this._months/12)*31536e6},humanize:function(withSuffix){var difference=+this,output=relativeTime(difference,!withSuffix,this.lang());if(withSuffix){output=this.lang().pastFuture(difference,output)}return this.lang().postformat(output)},add:function(input,val){var dur=moment.duration(input,val);this._milliseconds+=dur._milliseconds;this._days+=dur._days;this._months+=dur._months;this._bubble();return this},subtract:function(input,val){var dur=moment.duration(input,val);this._milliseconds-=dur._milliseconds;this._days-=dur._days;this._months-=dur._months;this._bubble();return this},get:function(units){units=normalizeUnits(units);return this[units.toLowerCase()+"s"]()},as:function(units){units=normalizeUnits(units);return this["as"+units.charAt(0).toUpperCase()+units.slice(1)+"s"]()},lang:moment.fn.lang,toIsoString:function(){var years=Math.abs(this.years()),months=Math.abs(this.months()),days=Math.abs(this.days()),hours=Math.abs(this.hours()),minutes=Math.abs(this.minutes()),seconds=Math.abs(this.seconds()+this.milliseconds()/1e3);if(!this.asSeconds()){return"P0D"}return(this.asSeconds()<0?"-":"")+"P"+(years?years+"Y":"")+(months?months+"M":"")+(days?days+"D":"")+(hours||minutes||seconds?"T":"")+(hours?hours+"H":"")+(minutes?minutes+"M":"")+(seconds?seconds+"S":"")}});function makeDurationGetter(name){moment.duration.fn[name]=function(){return this._data[name]}}function makeDurationAsGetter(name,factor){moment.duration.fn["as"+name]=function(){return+this/factor}}for(i in unitMillisecondFactors){if(unitMillisecondFactors.hasOwnProperty(i)){makeDurationAsGetter(i,unitMillisecondFactors[i]);makeDurationGetter(i.toLowerCase())}}makeDurationAsGetter("Weeks",6048e5);moment.duration.fn.asMonths=function(){return(+this-this.years()*31536e6)/2592e6+this.years()*12};moment.lang("en",{ordinal:function(number){var b=number%10,output=toInt(number%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th";return number+output}});function makeGlobal(deprecate){var warned=false,local_moment=moment;if(typeof ender!=="undefined"){return}if(deprecate){this.moment=function(){if(!warned&&console&&console.warn){warned=true;console.warn("Accessing Moment through the global scope is "+"deprecated, and will be removed in an upcoming "+"release.")}return local_moment.apply(null,arguments)}}else{this["moment"]=moment}}if(hasModule){module.exports=moment;makeGlobal(true)}else if(typeof define==="function"&&define.amd){define("moment",function(require,exports,module){if(module.config().noGlobal!==true){makeGlobal(module.config().noGlobal===undefined)}return moment})}else{makeGlobal()}}).call(this);(function(global){var re={starts_with_slashes:/^\/+/,ends_with_slashes:/\/+$/,pluses:/\+/g,query_separator:/[&;]/,uri_parser:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@\/]*)(?::([^:@\/]*))?)?@)?(\[[0-9a-fA-F:.]+\]|[^:\/?#]*)(?::(\d+|(?=:)))?(:)?)((((?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/};if(!Array.prototype.forEach){Array.prototype.forEach=function(callback,thisArg){var T,k;if(this==null){throw new TypeError(" this is null or not defined")}var O=Object(this);var len=O.length>>>0;if(typeof callback!=="function"){throw new TypeError(callback+" is not a function")}if(arguments.length>1){T=thisArg}k=0;while(k<len){var kValue;if(k in O){kValue=O[k];callback.call(T,kValue,k,O)}k++}}}function decode(s){if(s){s=s.toString().replace(re.pluses,"%20");s=decodeURIComponent(s)}return s}function parseUri(str){var parser=re.uri_parser;var parserKeys=["source","protocol","authority","userInfo","user","password","host","port","isColonUri","relative","path","directory","file","query","anchor"];var m=parser.exec(str||"");var parts={};parserKeys.forEach(function(key,i){parts[key]=m[i]||""});return parts}function parseQuery(str){var i,ps,p,n,k,v,l;var pairs=[];if(typeof str==="undefined"||str===null||str===""){return pairs}if(str.indexOf("?")===0){str=str.substring(1)}ps=str.toString().split(re.query_separator);for(i=0,l=ps.length;i<l;i++){p=ps[i];n=p.indexOf("=");if(n!==0){k=decode(p.substring(0,n));v=decode(p.substring(n+1));pairs.push(n===-1?[p,null]:[k,v])}}return pairs}function Uri(str){this.uriParts=parseUri(str);this.queryPairs=parseQuery(this.uriParts.query);this.hasAuthorityPrefixUserPref=null}["protocol","userInfo","host","port","path","anchor"].forEach(function(key){Uri.prototype[key]=function(val){if(typeof val!=="undefined"){this.uriParts[key]=val}return this.uriParts[key]}});Uri.prototype.hasAuthorityPrefix=function(val){if(typeof val!=="undefined"){this.hasAuthorityPrefixUserPref=val}if(this.hasAuthorityPrefixUserPref===null){return this.uriParts.source.indexOf("//")!==-1}else{return this.hasAuthorityPrefixUserPref}};Uri.prototype.isColonUri=function(val){if(typeof val!=="undefined"){this.uriParts.isColonUri=!!val}else{return!!this.uriParts.isColonUri}};Uri.prototype.query=function(val){var s="",i,param,l;if(typeof val!=="undefined"){this.queryPairs=parseQuery(val)}for(i=0,l=this.queryPairs.length;i<l;i++){param=this.queryPairs[i];if(s.length>0){s+="&"}if(param[1]===null){s+=param[0]}else{s+=param[0];s+="=";if(typeof param[1]!=="undefined"){s+=encodeURIComponent(param[1])}}}return s.length>0?"?"+s:s};Uri.prototype.getQueryParamValue=function(key){var param,i,l;for(i=0,l=this.queryPairs.length;i<l;i++){param=this.queryPairs[i];if(key===param[0]){return param[1]}}};Uri.prototype.getQueryParamValues=function(key){var arr=[],i,param,l;for(i=0,l=this.queryPairs.length;i<l;i++){param=this.queryPairs[i];if(key===param[0]){arr.push(param[1])}}return arr};Uri.prototype.deleteQueryParam=function(key,val){var arr=[],i,param,keyMatchesFilter,valMatchesFilter,l;for(i=0,l=this.queryPairs.length;i<l;i++){param=this.queryPairs[i];keyMatchesFilter=decode(param[0])===decode(key);valMatchesFilter=param[1]===val;if(arguments.length===1&&!keyMatchesFilter||arguments.length===2&&(!keyMatchesFilter||!valMatchesFilter)){arr.push(param)}}this.queryPairs=arr;return this};Uri.prototype.addQueryParam=function(key,val,index){if(arguments.length===3&&index!==-1){index=Math.min(index,this.queryPairs.length);this.queryPairs.splice(index,0,[key,val])}else if(arguments.length>0){this.queryPairs.push([key,val])}return this};Uri.prototype.hasQueryParam=function(key){var i,len=this.queryPairs.length;for(i=0;i<len;i++){if(this.queryPairs[i][0]==key)return true}return false};Uri.prototype.replaceQueryParam=function(key,newVal,oldVal){var index=-1,len=this.queryPairs.length,i,param;if(arguments.length===3){for(i=0;i<len;i++){param=this.queryPairs[i];if(decode(param[0])===decode(key)&&decodeURIComponent(param[1])===decode(oldVal)){index=i;break}}if(index>=0){this.deleteQueryParam(key,decode(oldVal)).addQueryParam(key,newVal,index)}}else{for(i=0;i<len;i++){param=this.queryPairs[i];if(decode(param[0])===decode(key)){index=i;break}}this.deleteQueryParam(key);this.addQueryParam(key,newVal,index)}return this};["protocol","hasAuthorityPrefix","isColonUri","userInfo","host","port","path","query","anchor"].forEach(function(key){var method="set"+key.charAt(0).toUpperCase()+key.slice(1);Uri.prototype[method]=function(val){this[key](val);return this}});Uri.prototype.scheme=function(){var s="";if(this.protocol()){s+=this.protocol();if(this.protocol().indexOf(":")!==this.protocol().length-1){s+=":"}s+="//"}else{if(this.hasAuthorityPrefix()&&this.host()){s+="//"}}return s};Uri.prototype.origin=function(){var s=this.scheme();if(this.userInfo()&&this.host()){s+=this.userInfo();if(this.userInfo().indexOf("@")!==this.userInfo().length-1){s+="@"}}if(this.host()){s+=this.host();if(this.port()||this.path()&&this.path().substr(0,1).match(/[0-9]/)){s+=":"+this.port()}}return s};Uri.prototype.addTrailingSlash=function(){var path=this.path()||"";if(path.substr(-1)!=="/"){this.path(path+"/")}return this};Uri.prototype.toString=function(){var path,s=this.origin();if(this.isColonUri()){if(this.path()){s+=":"+this.path()}}else if(this.path()){path=this.path();if(!(re.ends_with_slashes.test(s)||re.starts_with_slashes.test(path))){s+="/"}else{if(s){s.replace(re.ends_with_slashes,"/")}path=path.replace(re.starts_with_slashes,"/")}s+=path}else{if(this.host()&&(this.query().toString()||this.anchor())){s+="/"}}if(this.query().toString()){s+=this.query().toString()}if(this.anchor()){if(this.anchor().indexOf("#")!==0){s+="#"}s+=this.anchor()}return s};Uri.prototype.clone=function(){return new Uri(this.toString())};if(typeof define==="function"&&define.amd){define(function(){return Uri})}else if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=Uri}else{global.Uri=Uri}})(this);var JClipboard=function(){var instance,_defaults={moviePath:"JClipboard.swf",trustedOrigins:null,allowScriptAccess:"always",useNoCache:true};function JClipboard(){var that=this;that.initialize=function(){that.options=_defaults;that.$el=null;that.isReady=false;that.copyable=null;that.$copyableEl=null;if(detectFlashSupport()){$(document.body).append(render().$el)}};that.dispatch=function(eventName,args){switch(eventName){case"load":_onLoaded();break;case"mouseOver":_onMouseOver();break;case"mouseOut":_onMouseOut();break;case"dataRequested":_onDataRequested();break;case"complete":_onComplete();break}};that.bindTo=function(copyable,$copyableEl){that.copyable=copyable;that.$copyableEl=$copyableEl;var position=$copyableEl.offset(),width=$copyableEl.outerWidth(),height=$copyableEl.outerHeight();reposition(position);resize(width,height)};that.unbind=function(){if(that.copyable){that.copyable=that.$copyableEl=null;var position={top:-9999,left:-9999},width=1,height=1;reposition(position);resize(width,height)}};function detectFlashSupport(){var hasFlash=false;if(typeof ActiveXObject==="function"){try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")){hasFlash=true}}catch(error){}}if(!hasFlash&&navigator.mimeTypes["application/x-shockwave-flash"]){hasFlash=true}return hasFlash}function render(){var template="<div id='sm-clipboard-html-bridge' class='global-zeroclipboard-container'></div>";var $el=$(template),flashvars=_buildFlashVars(that.options),html='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="sm-clipboard-flash-bridge" width="100%" height="100%">'+'<param name="movie" value="'+that.options.moviePath+_noCache(that.options.moviePath,that.options)+'"/>'+'<param name="allowScriptAccess" value="'+that.options.allowScriptAccess+'"/>'+'<param name="scale" value="exactfit"/>'+'<param name="loop" value="false"/>'+'<param name="menu" value="false"/>'+'<param name="quality" value="best" />'+'<param name="bgcolor" value="#ffffff"/>'+'<param name="wmode" value="transparent"/>'+'<param name="flashvars" value="'+flashvars+'"/>'+'<embed src="'+that.options.moviePath+_noCache(that.options.moviePath,that.options)+'"loop="false" menu="false" quality="best" bgcolor="#ffffff" width="100%" height="100%"'+'name="sm-clipboard-flash-bridge" allowScriptAccess="always" allowFullScreen="false"'+'type="application/x-shockwave-flash" wmode="transparent"'+'pluginspage="http://www.macromedia.com/go/getflashplayer"'+'flashvars="'+flashvars+'"'+'scale="exactfit"></embed></object>';$el.css({position:"absolute",left:0,top:0,width:"10px",height:"100px",zIndex:"9999"});$el.html(html);that.$el=$el;that.flashBridge=$el.find("[name=sm-clipboard-flash-bridge]").get(0);return that}function _noCache(path,options){var useNoCache=!(options&&options.useNoCache===false);if(useNoCache){return(path.indexOf("?")===-1?"?":"&")+"nocache="+(new Date).getTime()}else{return""}}function _buildFlashVars(options){var str=[],trustedOrigins=options.trustedOrigins;if(trustedOrigins){if(!trustedOrigins.length){throw"You must provide an array of domains for trustedOrigins. "+"For example: ['www.example.com', 'staging.example.com']"}str.push("trustedOrigins="+encodeURIComponent(trustedOrigins.join(",")))}return str.join("&")}function _setText(text){if(that.isReady){that.flashBridge.setText(text)}}function reposition(position){that.$el.css({top:position.top,left:position.left})}function resize(width,height){that.$el.css({width:width,height:height});that.flashBridge.setSize(width,height)}function _onLoaded(){that.isReady=true;that.flashBridge.setHandCursor(true)}function _onMouseOver(){var hoverClass=that.copyable.options.hoverClass;if(hoverClass){that.$copyableEl.addClass(hoverClass)}}function _onMouseOut(){var hoverClass=that.copyable.options.hoverClass;if(hoverClass){that.$copyableEl.removeClass(hoverClass)}that.unbind()}function _onDataRequested(){var text=that.copyable.getText(that.$copyableEl);_setText(text)}function _onComplete(){that.$copyableEl.trigger("click");that.unbind()}}return{getInstance:function(){if(instance===undefined){instance=new JClipboard;instance.initialize();instance.constructor=null}return instance},init:function(options){$.extend(_defaults,options);window.JClipboard=this.getInstance()}}}();var Copyable=function($elements,options){var that=this,_defaults={hoverClass:null,activeClass:null};that.getText=function($el){return that.text($el)};function initialize($elements,options){if(JClipboard.init){throw"You must initialize JClipboard before calling copyable()"}that.$elements=$elements;that.options=$.extend(true,_defaults,options);that.text=options.text;_bindEvents()}function _bindEvents(){that.$elements.on("mouseover",_onMouseOver)}function _onMouseOver(e){var $target=$(e.target);JClipboard.bindTo(that,$target)}initialize($elements,options)};$.fn["copyable"]=function(options){var $elements=$(this);new Copyable($elements,options)};(function($,undefined){var uuid=0,runiqueId=/^ui-id-\d+$/;$.ui=$.ui||{};$.extend($.ui,{version:"1.10.3",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}});$.fn.extend({focus:function(orig){return function(delay,fn){return typeof delay==="number"?this.each(function(){var elem=this;setTimeout(function(){$(elem).focus();if(fn){fn.call(elem)}},delay)}):orig.apply(this,arguments)}}($.fn.focus),scrollParent:function(){var scrollParent;if($.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))){scrollParent=this.parents().filter(function(){return/(relative|absolute|fixed)/.test($.css(this,"position"))&&/(auto|scroll)/.test($.css(this,"overflow")+$.css(this,"overflow-y")+$.css(this,"overflow-x"))}).eq(0)}else{scrollParent=this.parents().filter(function(){return/(auto|scroll)/.test($.css(this,"overflow")+$.css(this,"overflow-y")+$.css(this,"overflow-x"))}).eq(0)}return/fixed/.test(this.css("position"))||!scrollParent.length?$(document):scrollParent},zIndex:function(zIndex){if(zIndex!==undefined){return this.css("zIndex",zIndex)}if(this.length){var elem=$(this[0]),position,value;while(elem.length&&elem[0]!==document){position=elem.css("position");if(position==="absolute"||position==="relative"||position==="fixed"){value=parseInt(elem.css("zIndex"),10);if(!isNaN(value)&&value!==0){return value}}elem=elem.parent()}}return 0},uniqueId:function(){return this.each(function(){if(!this.id){this.id="ui-id-"+ ++uuid}})},removeUniqueId:function(){return this.each(function(){if(runiqueId.test(this.id)){$(this).removeAttr("id")}})}});function focusable(element,isTabIndexNotNaN){var map,mapName,img,nodeName=element.nodeName.toLowerCase();if("area"===nodeName){map=element.parentNode;mapName=map.name;if(!element.href||!mapName||map.nodeName.toLowerCase()!=="map"){return false}img=$("img[usemap=#"+mapName+"]")[0];return!!img&&visible(img)}return(/input|select|textarea|button|object/.test(nodeName)?!element.disabled:"a"===nodeName?element.href||isTabIndexNotNaN:isTabIndexNotNaN)&&visible(element)}function visible(element){return $.expr.filters.visible(element)&&!$(element).parents().addBack().filter(function(){return $.css(this,"visibility")==="hidden"}).length}$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(dataName){return function(elem){return!!$.data(elem,dataName)}}):function(elem,i,match){return!!$.data(elem,match[3])},focusable:function(element){return focusable(element,!isNaN($.attr(element,"tabindex")))},tabbable:function(element){var tabIndex=$.attr(element,"tabindex"),isTabIndexNaN=isNaN(tabIndex);return(isTabIndexNaN||tabIndex>=0)&&focusable(element,!isTabIndexNaN)}});if(!$("<a>").outerWidth(1).jquery){$.each(["Width","Height"],function(i,name){var side=name==="Width"?["Left","Right"]:["Top","Bottom"],type=name.toLowerCase(),orig={innerWidth:$.fn.innerWidth,innerHeight:$.fn.innerHeight,outerWidth:$.fn.outerWidth,outerHeight:$.fn.outerHeight};function reduce(elem,size,border,margin){$.each(side,function(){size-=parseFloat($.css(elem,"padding"+this))||0;if(border){size-=parseFloat($.css(elem,"border"+this+"Width"))||0}if(margin){size-=parseFloat($.css(elem,"margin"+this))||0}});return size}$.fn["inner"+name]=function(size){if(size===undefined){return orig["inner"+name].call(this)}return this.each(function(){$(this).css(type,reduce(this,size)+"px")})};$.fn["outer"+name]=function(size,margin){if(typeof size!=="number"){return orig["outer"+name].call(this,size)}return this.each(function(){$(this).css(type,reduce(this,size,true,margin)+"px")})}})}if(!$.fn.addBack){$.fn.addBack=function(selector){return this.add(selector==null?this.prevObject:this.prevObject.filter(selector))}}if($("<a>").data("a-b","a").removeData("a-b").data("a-b")){$.fn.removeData=function(removeData){return function(key){if(arguments.length){return removeData.call(this,$.camelCase(key))}else{return removeData.call(this)}}}($.fn.removeData)}$.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());$.support.selectstart="onselectstart"in document.createElement("div");$.fn.extend({disableSelection:function(){return this.bind(($.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(event){event.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}});$.extend($.ui,{plugin:{add:function(module,option,set){var i,proto=$.ui[module].prototype;for(i in set){proto.plugins[i]=proto.plugins[i]||[];proto.plugins[i].push([option,set[i]])}},call:function(instance,name,args){var i,set=instance.plugins[name];if(!set||!instance.element[0].parentNode||instance.element[0].parentNode.nodeType===11){return}for(i=0;i<set.length;i++){if(instance.options[set[i][0]]){set[i][1].apply(instance.element,args)}}}},hasScroll:function(el,a){if($(el).css("overflow")==="hidden"){return false}var scroll=a&&a==="left"?"scrollLeft":"scrollTop",has=false;if(el[scroll]>0){return true}el[scroll]=1;has=el[scroll]>0;el[scroll]=0;return has}})})(jQuery);(function($,undefined){var uuid=0,slice=Array.prototype.slice,_cleanData=$.cleanData;$.cleanData=function(elems){for(var i=0,elem;(elem=elems[i])!=null;i++){try{$(elem).triggerHandler("remove")}catch(e){}}_cleanData(elems)};$.widget=function(name,base,prototype){var fullName,existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split(".")[0];name=name.split(".")[1];fullName=namespace+"-"+name;if(!prototype){prototype=base;base=$.Widget}$.expr[":"][fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName)};$[namespace]=$[namespace]||{};existingConstructor=$[namespace][name];constructor=$[namespace][name]=function(options,element){if(!this._createWidget){return new constructor(options,element)}if(arguments.length){this._createWidget(options,element)}};$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]});basePrototype=new base;basePrototype.options=$.widget.extend({},basePrototype.options);$.each(prototype,function(prop,value){if(!$.isFunction(value)){proxiedPrototype[prop]=value;return}proxiedPrototype[prop]=function(){var _super=function(){return base.prototype[prop].apply(this,arguments)},_superApply=function(args){return base.prototype[prop].apply(this,args)};return function(){var __super=this._super,__superApply=this._superApply,returnValue;this._super=_super;this._superApply=_superApply;returnValue=value.apply(this,arguments);this._super=__super;this._superApply=__superApply;return returnValue}}()});constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName});if(existingConstructor){$.each(existingConstructor._childConstructors,function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto)});delete existingConstructor._childConstructors}else{base._childConstructors.push(constructor)}$.widget.bridge(name,constructor)};$.widget.extend=function(target){var input=slice.call(arguments,1),inputIndex=0,inputLength=input.length,key,value;for(;inputIndex<inputLength;inputIndex++){for(key in input[inputIndex]){value=input[inputIndex][key];if(input[inputIndex].hasOwnProperty(key)&&value!==undefined){if($.isPlainObject(value)){target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value)}else{target[key]=value}}}}return target};$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall=typeof options==="string",args=slice.call(arguments,1),returnValue=this;options=!isMethodCall&&args.length?$.widget.extend.apply(null,[options].concat(args)):options;if(isMethodCall){this.each(function(){var methodValue,instance=$.data(this,fullName);if(!instance){return $.error("cannot call methods on "+name+" prior to initialization; "+"attempted to call method '"+options+"'")}if(!$.isFunction(instance[options])||options.charAt(0)==="_"){return $.error("no such method '"+options+"' for "+name+" widget instance")}methodValue=instance[options].apply(instance,args);if(methodValue!==instance&&methodValue!==undefined){returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue;return false}})}else{this.each(function(){var instance=$.data(this,fullName);if(instance){instance.option(options||{})._init()}else{$.data(this,fullName,new object(options,this))}})}return returnValue}};$.Widget=function(){};$.Widget._childConstructors=[];$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:false,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0];this.element=$(element);this.uuid=uuid++;this.eventNamespace="."+this.widgetName+this.uuid;this.options=$.widget.extend({},this.options,this._getCreateOptions(),options);this.bindings=$();this.hoverable=$();this.focusable=$();if(element!==this){$.data(element,this.widgetFullName,this);this._on(true,this.element,{remove:function(event){if(event.target===element){this.destroy()}}});this.document=$(element.style?element.ownerDocument:element.document||element);this.window=$(this.document[0].defaultView||this.document[0].parentWindow)}this._create();this._trigger("create",null,this._getCreateEventData());this._init()},_getCreateOptions:$.noop,_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){this._destroy();this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName));this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled");this.bindings.unbind(this.eventNamespace);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus")},_destroy:$.noop,widget:function(){return this.element},option:function(key,value){var options=key,parts,curOption,i;if(arguments.length===0){return $.widget.extend({},this.options)}if(typeof key==="string"){options={};parts=key.split(".");key=parts.shift();if(parts.length){curOption=options[key]=$.widget.extend({},this.options[key]);for(i=0;i<parts.length-1;i++){curOption[parts[i]]=curOption[parts[i]]||{};curOption=curOption[parts[i]]}key=parts.pop();if(value===undefined){return curOption[key]===undefined?null:curOption[key]}curOption[key]=value}else{if(value===undefined){return this.options[key]===undefined?null:this.options[key]}options[key]=value}}this._setOptions(options);return this},_setOptions:function(options){var key;for(key in options){this._setOption(key,options[key])}return this},_setOption:function(key,value){this.options[key]=value;if(key==="disabled"){this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!value).attr("aria-disabled",value);
this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus")}return this},enable:function(){return this._setOption("disabled",false)},disable:function(){return this._setOption("disabled",true)},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this;if(typeof suppressDisabledCheck!=="boolean"){handlers=element;element=suppressDisabledCheck;suppressDisabledCheck=false}if(!handlers){handlers=element;element=this.element;delegateElement=this.widget()}else{element=delegateElement=$(element);this.bindings=this.bindings.add(element)}$.each(handlers,function(event,handler){function handlerProxy(){if(!suppressDisabledCheck&&(instance.options.disabled===true||$(this).hasClass("ui-state-disabled"))){return}return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments)}if(typeof handler!=="string"){handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++}var match=event.match(/^(\w+)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];if(selector){delegateElement.delegate(selector,eventName,handlerProxy)}else{element.bind(eventName,handlerProxy)}})},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace;element.unbind(eventName).undelegate(eventName)},_delay:function(handler,delay){function handlerProxy(){return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments)}var instance=this;return setTimeout(handlerProxy,delay||0)},_hoverable:function(element){this.hoverable=this.hoverable.add(element);this._on(element,{mouseenter:function(event){$(event.currentTarget).addClass("ui-state-hover")},mouseleave:function(event){$(event.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(element){this.focusable=this.focusable.add(element);this._on(element,{focusin:function(event){$(event.currentTarget).addClass("ui-state-focus")},focusout:function(event){$(event.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];data=data||{};event=$.Event(event);event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase();event.target=this.element[0];orig=event.originalEvent;if(orig){for(prop in orig){if(!(prop in event)){event[prop]=orig[prop]}}}this.element.trigger(event,data);return!($.isFunction(callback)&&callback.apply(this.element[0],[event].concat(data))===false||event.isDefaultPrevented())}};$.each({show:"fadeIn",hide:"fadeOut"},function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){if(typeof options==="string"){options={effect:options}}var hasOptions,effectName=!options?method:options===true||typeof options==="number"?defaultEffect:options.effect||defaultEffect;options=options||{};if(typeof options==="number"){options={duration:options}}hasOptions=!$.isEmptyObject(options);options.complete=callback;if(options.delay){element.delay(options.delay)}if(hasOptions&&$.effects&&$.effects.effect[effectName]){element[method](options)}else if(effectName!==method&&element[effectName]){element[effectName](options.duration,options.easing,callback)}else{element.queue(function(next){$(this)[method]();if(callback){callback.call(element[0])}next()})}}})})(jQuery);(function($,undefined){var mouseHandled=false;$(document).mouseup(function(){mouseHandled=false});$.widget("ui.mouse",{version:"1.10.3",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var that=this;this.element.bind("mousedown."+this.widgetName,function(event){return that._mouseDown(event)}).bind("click."+this.widgetName,function(event){if(true===$.data(event.target,that.widgetName+".preventClickEvent")){$.removeData(event.target,that.widgetName+".preventClickEvent");event.stopImmediatePropagation();return false}});this.started=false},_mouseDestroy:function(){this.element.unbind("."+this.widgetName);if(this._mouseMoveDelegate){$(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)}},_mouseDown:function(event){if(mouseHandled){return}this._mouseStarted&&this._mouseUp(event);this._mouseDownEvent=event;var that=this,btnIsLeft=event.which===1,elIsCancel=typeof this.options.cancel==="string"&&event.target.nodeName?$(event.target).closest(this.options.cancel).length:false;if(!btnIsLeft||elIsCancel||!this._mouseCapture(event)){return true}this.mouseDelayMet=!this.options.delay;if(!this.mouseDelayMet){this._mouseDelayTimer=setTimeout(function(){that.mouseDelayMet=true},this.options.delay)}if(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)){this._mouseStarted=this._mouseStart(event)!==false;if(!this._mouseStarted){event.preventDefault();return true}}if(true===$.data(event.target,this.widgetName+".preventClickEvent")){$.removeData(event.target,this.widgetName+".preventClickEvent")}this._mouseMoveDelegate=function(event){return that._mouseMove(event)};this._mouseUpDelegate=function(event){return that._mouseUp(event)};$(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate);event.preventDefault();mouseHandled=true;return true},_mouseMove:function(event){if($.ui.ie&&(!document.documentMode||document.documentMode<9)&&!event.button){return this._mouseUp(event)}if(this._mouseStarted){this._mouseDrag(event);return event.preventDefault()}if(this._mouseDistanceMet(event)&&this._mouseDelayMet(event)){this._mouseStarted=this._mouseStart(this._mouseDownEvent,event)!==false;this._mouseStarted?this._mouseDrag(event):this._mouseUp(event)}return!this._mouseStarted},_mouseUp:function(event){$(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;if(event.target===this._mouseDownEvent.target){$.data(event.target,this.widgetName+".preventClickEvent",true)}this._mouseStop(event)}return false},_mouseDistanceMet:function(event){return Math.max(Math.abs(this._mouseDownEvent.pageX-event.pageX),Math.abs(this._mouseDownEvent.pageY-event.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return true}})})(jQuery);(function($,undefined){function isOverAxis(x,reference,size){return x>reference&&x<reference+size}function isFloating(item){return/left|right/.test(item.css("float"))||/inline|table-cell/.test(item.css("display"))}$.widget("ui.sortable",$.ui.mouse,{version:"1.10.3",widgetEventPrefix:"sort",ready:false,options:{appendTo:"parent",axis:false,connectWith:false,containment:false,cursor:"auto",cursorAt:false,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_create:function(){var o=this.options;this.containerCache={};this.element.addClass("ui-sortable");this.refresh();this.floating=this.items.length?o.axis==="x"||isFloating(this.items[0].item):false;this.offset=this.element.offset();this._mouseInit();this.ready=true},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled");this._mouseDestroy();for(var i=this.items.length-1;i>=0;i--){this.items[i].item.removeData(this.widgetName+"-item")}return this},_setOption:function(key,value){if(key==="disabled"){this.options[key]=value;this.widget().toggleClass("ui-sortable-disabled",!!value)}else{$.Widget.prototype._setOption.apply(this,arguments)}},_mouseCapture:function(event,overrideHandle){var currentItem=null,validHandle=false,that=this;if(this.reverting){return false}if(this.options.disabled||this.options.type==="static"){return false}this._refreshItems(event);$(event.target).parents().each(function(){if($.data(this,that.widgetName+"-item")===that){currentItem=$(this);return false}});if($.data(event.target,that.widgetName+"-item")===that){currentItem=$(event.target)}if(!currentItem){return false}if(this.options.handle&&!overrideHandle){$(this.options.handle,currentItem).find("*").addBack().each(function(){if(this===event.target){validHandle=true}});if(!validHandle){return false}}this.currentItem=currentItem;this._removeCurrentsFromItems();return true},_mouseStart:function(event,overrideHandle,noActivation){var i,body,o=this.options;this.currentContainer=this;this.refreshPositions();this.helper=this._createHelper(event);this._cacheHelperProportions();this._cacheMargins();this.scrollParent=this.helper.scrollParent();this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};$.extend(this.offset,{click:{left:event.pageX-this.offset.left,top:event.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.helper.css("position","absolute");this.cssPosition=this.helper.css("position");this.originalPosition=this._generatePosition(event);this.originalPageX=event.pageX;this.originalPageY=event.pageY;o.cursorAt&&this._adjustOffsetFromHelper(o.cursorAt);this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]};if(this.helper[0]!==this.currentItem[0]){this.currentItem.hide()}this._createPlaceholder();if(o.containment){this._setContainment()}if(o.cursor&&o.cursor!=="auto"){body=this.document.find("body");this.storedCursor=body.css("cursor");body.css("cursor",o.cursor);this.storedStylesheet=$("<style>*{ cursor: "+o.cursor+" !important; }</style>").appendTo(body)}if(o.opacity){if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity")}this.helper.css("opacity",o.opacity)}if(o.zIndex){if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex")}this.helper.css("zIndex",o.zIndex)}if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){this.overflowOffset=this.scrollParent.offset()}this._trigger("start",event,this._uiHash());if(!this._preserveHelperProportions){this._cacheHelperProportions()}if(!noActivation){for(i=this.containers.length-1;i>=0;i--){this.containers[i]._trigger("activate",event,this._uiHash(this))}}if($.ui.ddmanager){$.ui.ddmanager.current=this}if($.ui.ddmanager&&!o.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,event)}this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(event);return true},_mouseDrag:function(event){var i,item,itemElement,intersection,o=this.options,scrolled=false;this.position=this._generatePosition(event);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-event.pageY<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed}else if(event.pageY-this.overflowOffset.top<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed}if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-event.pageX<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed}else if(event.pageX-this.overflowOffset.left<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed}}else{if(event.pageY-$(document).scrollTop()<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed)}else if($(window).height()-(event.pageY-$(document).scrollTop())<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed)}if(event.pageX-$(document).scrollLeft()<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed)}else if($(window).width()-(event.pageX-$(document).scrollLeft())<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed)}}if(scrolled!==false&&$.ui.ddmanager&&!o.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,event)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}for(i=this.items.length-1;i>=0;i--){item=this.items[i];itemElement=item.item[0];intersection=this._intersectsWithPointer(item);if(!intersection){continue}if(item.instance!==this.currentContainer){continue}if(itemElement!==this.currentItem[0]&&this.placeholder[intersection===1?"next":"prev"]()[0]!==itemElement&&!$.contains(this.placeholder[0],itemElement)&&(this.options.type==="semi-dynamic"?!$.contains(this.element[0],itemElement):true)){this.direction=intersection===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(item)){this._rearrange(event,item)}else{break}this._trigger("change",event,this._uiHash());break}}this._contactContainers(event);if($.ui.ddmanager){$.ui.ddmanager.drag(this,event)}this._trigger("sort",event,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(event,noPropagation){if(!event){return}if($.ui.ddmanager&&!this.options.dropBehaviour){$.ui.ddmanager.drop(this,event)}if(this.options.revert){var that=this,cur=this.placeholder.offset(),axis=this.options.axis,animation={};if(!axis||axis==="x"){animation.left=cur.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollLeft)}if(!axis||axis==="y"){animation.top=cur.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollTop)}this.reverting=true;$(this.helper).animate(animation,parseInt(this.options.revert,10)||500,function(){that._clear(event)})}else{this._clear(event,noPropagation)}return false},cancel:function(){if(this.dragging){this._mouseUp({target:null});if(this.options.helper==="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}for(var i=this.containers.length-1;i>=0;i--){this.containers[i]._trigger("deactivate",null,this._uiHash(this));if(this.containers[i].containerCache.over){this.containers[i]._trigger("out",null,this._uiHash(this));this.containers[i].containerCache.over=0}}}if(this.placeholder){if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0])}if(this.options.helper!=="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove()}$.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){$(this.domPosition.prev).after(this.currentItem)}else{$(this.domPosition.parent).prepend(this.currentItem)}}return this},serialize:function(o){var items=this._getItemsAsjQuery(o&&o.connected),str=[];o=o||{};$(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||/(.+)[\-=_](.+)/);if(res){str.push((o.key||res[1]+"[]")+"="+(o.key&&o.expression?res[1]:res[2]))}});if(!str.length&&o.key){str.push(o.key+"=")}return str.join("&")},toArray:function(o){var items=this._getItemsAsjQuery(o&&o.connected),ret=[];o=o||{};items.each(function(){ret.push($(o.item||this).attr(o.attribute||"id")||"")});return ret},_intersectsWith:function(item){var x1=this.positionAbs.left,x2=x1+this.helperProportions.width,y1=this.positionAbs.top,y2=y1+this.helperProportions.height,l=item.left,r=l+item.width,t=item.top,b=t+item.height,dyClick=this.offset.click.top,dxClick=this.offset.click.left,isOverElementHeight=this.options.axis==="x"||y1+dyClick>t&&y1+dyClick<b,isOverElementWidth=this.options.axis==="y"||x1+dxClick>l&&x1+dxClick<r,isOverElement=isOverElementHeight&&isOverElementWidth;if(this.options.tolerance==="pointer"||this.options.forcePointerForContainers||this.options.tolerance!=="pointer"&&this.helperProportions[this.floating?"width":"height"]>item[this.floating?"width":"height"]){return isOverElement}else{return l<x1+this.helperProportions.width/2&&x2-this.helperProportions.width/2<r&&t<y1+this.helperProportions.height/2&&y2-this.helperProportions.height/2<b}},_intersectsWithPointer:function(item){var isOverElementHeight=this.options.axis==="x"||isOverAxis(this.positionAbs.top+this.offset.click.top,item.top,item.height),isOverElementWidth=this.options.axis==="y"||isOverAxis(this.positionAbs.left+this.offset.click.left,item.left,item.width),isOverElement=isOverElementHeight&&isOverElementWidth,verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();if(!isOverElement){return false}return this.floating?horizontalDirection&&horizontalDirection==="right"||verticalDirection==="down"?2:1:verticalDirection&&(verticalDirection==="down"?2:1)},_intersectsWithSides:function(item){var isOverBottomHalf=isOverAxis(this.positionAbs.top+this.offset.click.top,item.top+item.height/2,item.height),isOverRightHalf=isOverAxis(this.positionAbs.left+this.offset.click.left,item.left+item.width/2,item.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();if(this.floating&&horizontalDirection){return horizontalDirection==="right"&&isOverRightHalf||horizontalDirection==="left"&&!isOverRightHalf}else{return verticalDirection&&(verticalDirection==="down"&&isOverBottomHalf||verticalDirection==="up"&&!isOverBottomHalf)}},_getDragVerticalDirection:function(){var delta=this.positionAbs.top-this.lastPositionAbs.top;return delta!==0&&(delta>0?"down":"up")},_getDragHorizontalDirection:function(){var delta=this.positionAbs.left-this.lastPositionAbs.left;return delta!==0&&(delta>0?"right":"left")},refresh:function(event){this._refreshItems(event);this.refreshPositions();return this},_connectWith:function(){var options=this.options;return options.connectWith.constructor===String?[options.connectWith]:options.connectWith},_getItemsAsjQuery:function(connected){var i,j,cur,inst,items=[],queries=[],connectWith=this._connectWith();if(connectWith&&connected){for(i=connectWith.length-1;i>=0;i--){cur=$(connectWith[i]);for(j=cur.length-1;j>=0;j--){inst=$.data(cur[j],this.widgetFullName);if(inst&&inst!==this&&!inst.options.disabled){queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element):$(inst.options.items,inst.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),inst])}}}}queries.push([$.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):$(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(i=queries.length-1;i>=0;i--){queries[i][0].each(function(){items.push(this)})}return $(items)},_removeCurrentsFromItems:function(){var list=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=$.grep(this.items,function(item){for(var j=0;j<list.length;j++){if(list[j]===item.item[0]){return false}}return true})},_refreshItems:function(event){this.items=[];this.containers=[this];var i,j,cur,inst,targetData,_queries,item,queriesLength,items=this.items,queries=[[$.isFunction(this.options.items)?this.options.items.call(this.element[0],event,{item:this.currentItem}):$(this.options.items,this.element),this]],connectWith=this._connectWith();if(connectWith&&this.ready){for(i=connectWith.length-1;i>=0;i--){cur=$(connectWith[i]);for(j=cur.length-1;j>=0;j--){inst=$.data(cur[j],this.widgetFullName);if(inst&&inst!==this&&!inst.options.disabled){queries.push([$.isFunction(inst.options.items)?inst.options.items.call(inst.element[0],event,{item:this.currentItem}):$(inst.options.items,inst.element),inst]);this.containers.push(inst)}}}}for(i=queries.length-1;i>=0;i--){targetData=queries[i][1];_queries=queries[i][0];for(j=0,queriesLength=_queries.length;j<queriesLength;j++){item=$(_queries[j]);item.data(this.widgetName+"-item",targetData);items.push({item:item,instance:targetData,width:0,height:0,left:0,top:0})}}},refreshPositions:function(fast){if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset()}var i,item,t,p;for(i=this.items.length-1;i>=0;i--){item=this.items[i];if(item.instance!==this.currentContainer&&this.currentContainer&&item.item[0]!==this.currentItem[0]){continue}t=this.options.toleranceElement?$(this.options.toleranceElement,item.item):item.item;if(!fast){item.width=t.outerWidth();item.height=t.outerHeight()}p=t.offset();item.left=p.left;item.top=p.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)}else{for(i=this.containers.length-1;i>=0;i--){p=this.containers[i].element.offset();this.containers[i].containerCache.left=p.left;this.containers[i].containerCache.top=p.top;this.containers[i].containerCache.width=this.containers[i].element.outerWidth();this.containers[i].containerCache.height=this.containers[i].element.outerHeight()}}return this},_createPlaceholder:function(that){that=that||this;var className,o=that.options;if(!o.placeholder||o.placeholder.constructor===String){className=o.placeholder;o.placeholder={element:function(){var nodeName=that.currentItem[0].nodeName.toLowerCase(),element=$("<"+nodeName+">",that.document[0]).addClass(className||that.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");if(nodeName==="tr"){that.currentItem.children().each(function(){$("<td>&#160;</td>",that.document[0]).attr("colspan",$(this).attr("colspan")||1).appendTo(element)})}else if(nodeName==="img"){element.attr("src",that.currentItem.attr("src"))}if(!className){element.css("visibility","hidden")}return element},update:function(container,p){if(className&&!o.forcePlaceholderSize){return}if(!p.height()){p.height(that.currentItem.innerHeight()-parseInt(that.currentItem.css("paddingTop")||0,10)-parseInt(that.currentItem.css("paddingBottom")||0,10))}if(!p.width()){p.width(that.currentItem.innerWidth()-parseInt(that.currentItem.css("paddingLeft")||0,10)-parseInt(that.currentItem.css("paddingRight")||0,10))}}}}that.placeholder=$(o.placeholder.element.call(that.element,that.currentItem));that.currentItem.after(that.placeholder);o.placeholder.update(that,that.placeholder)},_contactContainers:function(event){var i,j,dist,itemWithLeastDistance,posProperty,sizeProperty,base,cur,nearBottom,floating,innermostContainer=null,innermostIndex=null;for(i=this.containers.length-1;i>=0;i--){if($.contains(this.currentItem[0],this.containers[i].element[0])){continue}if(this._intersectsWith(this.containers[i].containerCache)){if(innermostContainer&&$.contains(this.containers[i].element[0],innermostContainer.element[0])){continue}innermostContainer=this.containers[i];innermostIndex=i}else{if(this.containers[i].containerCache.over){this.containers[i]._trigger("out",event,this._uiHash(this));this.containers[i].containerCache.over=0}}}if(!innermostContainer){return}if(this.containers.length===1){if(!this.containers[innermostIndex].containerCache.over){this.containers[innermostIndex]._trigger("over",event,this._uiHash(this));this.containers[innermostIndex].containerCache.over=1}}else{dist=1e4;itemWithLeastDistance=null;floating=innermostContainer.floating||isFloating(this.currentItem);posProperty=floating?"left":"top";sizeProperty=floating?"width":"height";base=this.positionAbs[posProperty]+this.offset.click[posProperty];for(j=this.items.length-1;j>=0;j--){if(!$.contains(this.containers[innermostIndex].element[0],this.items[j].item[0])){continue}if(this.items[j].item[0]===this.currentItem[0]){continue}if(floating&&!isOverAxis(this.positionAbs.top+this.offset.click.top,this.items[j].top,this.items[j].height)){continue}cur=this.items[j].item.offset()[posProperty];nearBottom=false;if(Math.abs(cur-base)>Math.abs(cur+this.items[j][sizeProperty]-base)){nearBottom=true;cur+=this.items[j][sizeProperty]}if(Math.abs(cur-base)<dist){dist=Math.abs(cur-base);itemWithLeastDistance=this.items[j];this.direction=nearBottom?"up":"down"}}if(!itemWithLeastDistance&&!this.options.dropOnEmpty){return}if(this.currentContainer===this.containers[innermostIndex]){return}itemWithLeastDistance?this._rearrange(event,itemWithLeastDistance,null,true):this._rearrange(event,null,this.containers[innermostIndex].element,true);this._trigger("change",event,this._uiHash());this.containers[innermostIndex]._trigger("change",event,this._uiHash(this));this.currentContainer=this.containers[innermostIndex];this.options.placeholder.update(this.currentContainer,this.placeholder);this.containers[innermostIndex]._trigger("over",event,this._uiHash(this));this.containers[innermostIndex].containerCache.over=1}},_createHelper:function(event){var o=this.options,helper=$.isFunction(o.helper)?$(o.helper.apply(this.element[0],[event,this.currentItem])):o.helper==="clone"?this.currentItem.clone():this.currentItem;if(!helper.parents("body").length){$(o.appendTo!=="parent"?o.appendTo:this.currentItem[0].parentNode)[0].appendChild(helper[0])}if(helper[0]===this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}}if(!helper[0].style.width||o.forceHelperSize){helper.width(this.currentItem.width())}if(!helper[0].style.height||o.forceHelperSize){helper.height(this.currentItem.height())}return helper},_adjustOffsetFromHelper:function(obj){if(typeof obj==="string"){obj=obj.split(" ")}if($.isArray(obj)){obj={left:+obj[0],top:+obj[1]||0}}if("left"in obj){this.offset.click.left=obj.left+this.margins.left}if("right"in obj){this.offset.click.left=this.helperProportions.width-obj.right+this.margins.left}if("top"in obj){this.offset.click.top=obj.top+this.margins.top}if("bottom"in obj){this.offset.click.top=this.helperProportions.height-obj.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var po=this.offsetParent.offset();if(this.cssPosition==="absolute"&&this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0])){po.left+=this.scrollParent.scrollLeft();po.top+=this.scrollParent.scrollTop()}if(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()==="html"&&$.ui.ie){po={top:0,left:0}}return{top:po.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:po.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition==="relative"){var p=this.currentItem.position();return{top:p.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:p.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var ce,co,over,o=this.options;if(o.containment==="parent"){o.containment=this.helper[0].parentNode}if(o.containment==="document"||o.containment==="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,$(o.containment==="document"?document:window).width()-this.helperProportions.width-this.margins.left,($(o.containment==="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!/^(document|window|parent)$/.test(o.containment)){ce=$(o.containment)[0];co=$(o.containment).offset();over=$(ce).css("overflow")!=="hidden";this.containment=[co.left+(parseInt($(ce).css("borderLeftWidth"),10)||0)+(parseInt($(ce).css("paddingLeft"),10)||0)-this.margins.left,co.top+(parseInt($(ce).css("borderTopWidth"),10)||0)+(parseInt($(ce).css("paddingTop"),10)||0)-this.margins.top,co.left+(over?Math.max(ce.scrollWidth,ce.offsetWidth):ce.offsetWidth)-(parseInt($(ce).css("borderLeftWidth"),10)||0)-(parseInt($(ce).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,co.top+(over?Math.max(ce.scrollHeight,ce.offsetHeight):ce.offsetHeight)-(parseInt($(ce).css("borderTopWidth"),10)||0)-(parseInt($(ce).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(d,pos){if(!pos){pos=this.position}var mod=d==="absolute"?1:-1,scroll=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);return{top:pos.top+this.offset.relative.top*mod+this.offset.parent.top*mod-(this.cssPosition==="fixed"?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop())*mod,left:pos.left+this.offset.relative.left*mod+this.offset.parent.left*mod-(this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())*mod}},_generatePosition:function(event){var top,left,o=this.options,pageX=event.pageX,pageY=event.pageY,scroll=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,scrollIsRootNode=/(html|body)/i.test(scroll[0].tagName);if(this.cssPosition==="relative"&&!(this.scrollParent[0]!==document&&this.scrollParent[0]!==this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}if(this.originalPosition){if(this.containment){if(event.pageX-this.offset.click.left<this.containment[0]){pageX=this.containment[0]+this.offset.click.left}if(event.pageY-this.offset.click.top<this.containment[1]){pageY=this.containment[1]+this.offset.click.top}if(event.pageX-this.offset.click.left>this.containment[2]){pageX=this.containment[2]+this.offset.click.left}if(event.pageY-this.offset.click.top>this.containment[3]){pageY=this.containment[3]+this.offset.click.top}}if(o.grid){top=this.originalPageY+Math.round((pageY-this.originalPageY)/o.grid[1])*o.grid[1];pageY=this.containment?top-this.offset.click.top>=this.containment[1]&&top-this.offset.click.top<=this.containment[3]?top:top-this.offset.click.top>=this.containment[1]?top-o.grid[1]:top+o.grid[1]:top;left=this.originalPageX+Math.round((pageX-this.originalPageX)/o.grid[0])*o.grid[0];pageX=this.containment?left-this.offset.click.left>=this.containment[0]&&left-this.offset.click.left<=this.containment[2]?left:left-this.offset.click.left>=this.containment[0]?left-o.grid[0]:left+o.grid[0]:left}}return{top:pageY-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(this.cssPosition==="fixed"?-this.scrollParent.scrollTop():scrollIsRootNode?0:scroll.scrollTop()),left:pageX-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():scrollIsRootNode?0:scroll.scrollLeft())}},_rearrange:function(event,i,a,hardRefresh){a?a[0].appendChild(this.placeholder[0]):i.item[0].parentNode.insertBefore(this.placeholder[0],this.direction==="down"?i.item[0]:i.item[0].nextSibling);this.counter=this.counter?++this.counter:1;var counter=this.counter;this._delay(function(){if(counter===this.counter){this.refreshPositions(!hardRefresh)}})},_clear:function(event,noPropagation){this.reverting=false;var i,delayedTriggers=[];if(!this._noFinalSort&&this.currentItem.parent().length){this.placeholder.before(this.currentItem)}this._noFinalSort=null;if(this.helper[0]===this.currentItem[0]){for(i in this._storedCSS){if(this._storedCSS[i]==="auto"||this._storedCSS[i]==="static"){this._storedCSS[i]=""
}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}if(this.fromOutside&&!noPropagation){delayedTriggers.push(function(event){this._trigger("receive",event,this._uiHash(this.fromOutside))})}if((this.fromOutside||this.domPosition.prev!==this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!==this.currentItem.parent()[0])&&!noPropagation){delayedTriggers.push(function(event){this._trigger("update",event,this._uiHash())})}if(this!==this.currentContainer){if(!noPropagation){delayedTriggers.push(function(event){this._trigger("remove",event,this._uiHash())});delayedTriggers.push(function(c){return function(event){c._trigger("receive",event,this._uiHash(this))}}.call(this,this.currentContainer));delayedTriggers.push(function(c){return function(event){c._trigger("update",event,this._uiHash(this))}}.call(this,this.currentContainer))}}for(i=this.containers.length-1;i>=0;i--){if(!noPropagation){delayedTriggers.push(function(c){return function(event){c._trigger("deactivate",event,this._uiHash(this))}}.call(this,this.containers[i]))}if(this.containers[i].containerCache.over){delayedTriggers.push(function(c){return function(event){c._trigger("out",event,this._uiHash(this))}}.call(this,this.containers[i]));this.containers[i].containerCache.over=0}}if(this.storedCursor){this.document.find("body").css("cursor",this.storedCursor);this.storedStylesheet.remove()}if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity)}if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex==="auto"?"":this._storedZIndex)}this.dragging=false;if(this.cancelHelperRemoval){if(!noPropagation){this._trigger("beforeStop",event,this._uiHash());for(i=0;i<delayedTriggers.length;i++){delayedTriggers[i].call(this,event)}this._trigger("stop",event,this._uiHash())}this.fromOutside=false;return false}if(!noPropagation){this._trigger("beforeStop",event,this._uiHash())}this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(this.helper[0]!==this.currentItem[0]){this.helper.remove()}this.helper=null;if(!noPropagation){for(i=0;i<delayedTriggers.length;i++){delayedTriggers[i].call(this,event)}this._trigger("stop",event,this._uiHash())}this.fromOutside=false;return true},_trigger:function(){if($.Widget.prototype._trigger.apply(this,arguments)===false){this.cancel()}},_uiHash:function(_inst){var inst=_inst||this;return{helper:inst.helper,placeholder:inst.placeholder||$([]),position:inst.position,originalPosition:inst.originalPosition,offset:inst.positionAbs,item:inst.currentItem,sender:_inst?_inst.element:null}}})})(jQuery);SM.Model={__create:function(kwargs){},__validators:undefined,__setters:undefined,__getters:undefined,__counter:0,__defaults:undefined,__initSettings:function(options){var key,overrides;this.__settings={};if(options){overrides={};for(key in this.__defaults){if(this.__defaults.hasOwnProperty(key)&&options.hasOwnProperty(key)){overrides[key]=options[key]}}this.__settings=SM.Object.extend(this.__defaults,overrides)}else if(this.__defaults){this.__settings=SM.Object.copy(this.__defaults)}},get:function(key,obj){var getters=this.__getters;if(key===undefined){return}if(getters&&getters[key]){return getters[key](this,obj)}else{return this[key]}},set:function(key,val,options){var setters=this.__setters,oldVal=this[key],defaults={notify:false,validate:false},settings;if(options){settings=SM.Object.extend(defaults,options)}else{settings=defaults}if(settings.validate&&!this.validate(key,val)){return this}if(setters&&setters[key]){setters[key](this,val,settings)}else{this[key]=val}if(settings.notify){if(val!==oldVal){this._trigger({type:key+".changed",property:key,old:oldVal,value:val})}this._trigger({type:key+".set",property:key,old:oldVal,value:val})}return this},on:function(event,data,callback){if(arguments.length<3){throw new Error("model.bind requires three arguments")}else if(!event||!data||!callback){throw new Error("model.bind must be passed an event, data, and callback")}this._$.on(event,data,callback);return this},off:function(event,callback){this._$.off(event,callback)},validateKeyValue:function(key,value){var validation=this.__validators[key]?this.__validators[key](this,value):{isValid:true};if(!validation.isValid){validation.property=key;validation.value=value;return validation}return{isValid:true}},validateGroup:function(group){var key,validation,validations={isValid:true,invalids:{}};for(key in group){if(!group.hasOwnProperty(key)){continue}validation=this.validateKeyValue(key,group[key]);if(!validation.isValid){validations.isValid=false;validations.invalids[key]=validation}}return validations},validate:function(){var self=this,validators=this.__validators,validations,group,value,key;if(validators){if(arguments.length===0){validations=this.validateGroup(this._getValidatables())}else if(arguments.length===1){if(typeof arguments[0]==="string"){group={};key=arguments[0];value=this.state[key];group[key]=value;validations=this.validateGroup(group)}else if(typeof arguments[0]==="object"){validations=this.validateGroup(arguments[0])}}else if(arguments.length===2){group={};key=arguments[0];value=arguments[1];group[key]=value;validations=this.validateGroup(group)}}else{validations=this.validateGroup({})}if(!validations.isValid){this._trigger({type:"validated",validations:validations})}return validations},_trigger:function(event){var evt={};try{if(event===null||event===undefined){throw new Error("model._trigger: triggering a null or undefined event")}if(typeof event==="string"){evt.type=event}else{if(event.type===null||event.type===undefined){throw new Error("model._trigger: triggering a null or undefined event")}evt=event}this._$.trigger(evt)}catch(e){SM.Error.log(e,"Error model triggering "+evt.type)}return this},_getValidatables:function(){var key,validatables={},validators=this.__validators;for(key in validators){validatables[key]=this.get(key)}return validatables}};SM.Models={_models:{},_types:{},create:function(name,kwargs){var inst,modelName,type;if(name===undefined){throw new Error("a model name is required to create an instance")}modelName=name+"Model";type=SM[modelName];if(type===undefined){throw new Error("attempted to create an unregistered model name: "+modelName)}return this._create(type,kwargs)},register:function(name,prototype){var modelName;if(arguments.length!==2){throw new Error("a string model name and model prototype is required to register a model")}if(name===undefined||typeof name!=="string"){throw new Error("a string model name is required to register a model")}modelName=name+"Model";if(SM[modelName]!==undefined){throw new Error("a model of this type has already been registered")}SM[modelName]=SM.Object.extend(SM.Model,prototype);SM[modelName].__counter=0;SM[modelName].__NAME=name;return SM[modelName]},extend:function(name,baseModel,overrides){var extended=SM.Object.deepExtend(baseModel,overrides);return this.register(name,extended)},_create:function(type,kwargs){var inst=SM.Object.create(type);inst._$=$({});inst.__initSettings(kwargs);inst.__uid=type.__counter++;kwargs=kwargs||{};inst.__create(kwargs);return inst}};SM.log=function(str){if(SM.DEBUG){if(window.console){if(console&&console.log&&console.log.apply){console.log.apply(console,arguments)}else if(console&&console.log){Function.apply.apply(console.log,[null,arguments])}}}};SM.Date={getDaysInMonth:function(month,year){var self=this;return 32-new Date(year,month,32).getDate()},getSimpleDate:function(date){if(!date){return{}}return{month:date.getMonth(),year:date.getFullYear(),day:date.getDate()}},timestamp:function(){return(new Date).getTime()},toISOString:function(datetime){var pad=function(n){return n<10?"0"+n:n};if(!Date.prototype.toISOString){return[this.getUTCFullYear(),"-",pad(this.getUTCMonth()+1),"-",pad(this.getUTCDate()),"T",pad(this.getUTCHours()),":",pad(this.getUTCMinutes()),":",pad(this.getUTCSeconds()),"Z"].join("")}else{return datetime.toISOString()}},stdTimezoneOffset:function(){var d=new Date,year=d.getFullYear(),jan=new Date(year,0,1),jul=new Date(year,6,1);return Math.max(jan.getTimezoneOffset(),jul.getTimezoneOffset())},utcOffset:function(){return(new Date).getTimezoneOffset()*-6e4},toAge:function(ms){var seconds,minutes,hours,days,totalSeconds,totalMinutes,totalHours,totalDays;totalSeconds=Math.floor(ms/1e3);seconds=totalSeconds%60;totalMinutes=Math.floor(totalSeconds/60);minutes=totalMinutes%60;totalHours=Math.floor(totalMinutes/60);hours=totalHours%24;totalDays=Math.floor(totalHours/24);days=totalDays%365;return{seconds:seconds,minutes:minutes,hours:hours,days:days}},ageToMilliseconds:function(age){var increments=age.split(" "),self,i=0,increment,number,unit,ms=0;for(;i<increments.length;i++){increment=increments[i];number=parseInt(increment,10),unit=increment.charAt(increment.length-1);unit=this._millisecondMap[unit];if(unit){ms+=number*unit}}return ms},formatDigitalTime:function(hours,minutes,seconds){var ageStr="";ageStr=this._addDigitalTimeString(ageStr,hours)+":";ageStr=this._addDigitalTimeString(ageStr,minutes)+":";return this._addDigitalTimeString(ageStr,seconds)},_millisecondMap:{s:1e3,m:1e3*60,h:1e3*60*60,d:1e3*60*60*24,o:1e3*60*60*24*30,y:1e3*60*60*24*365},_addDigitalTimeString:function(ageStr,timeIncrement){if(timeIncrement>9){ageStr=ageStr+timeIncrement}else if(timeIncrement>0){ageStr=ageStr+"0"+timeIncrement}else{ageStr=ageStr+"00"}return ageStr}};(function(){var $doc;jQuery.event.special.leave={add:function(handleObj){var oldHandler=handleObj.handler,self=this,el=this;if(!$doc){$doc=$(document)}handleObj.handler=function(e){if(e.type===SM.Event.FOCUSIN){if(!SM.DOM.contains(el,e.target)&&e.target.tagName.toLowerCase()!=="body"){oldHandler.apply(this,arguments)}}if(e.type===SM.Event.CLICK){if(!SM.DOM.contains(el,e.target)){oldHandler.apply(this,arguments)}}};setTimeout(function(){$doc.on(SM.Event.FOCUSIN+"."+handleObj.guid,handleObj.data,handleObj.handler).on(SM.Event.CLICK+"."+handleObj.guid,handleObj.data,handleObj.handler)},0)},remove:function(handleObj){$doc.off(SM.Event.FOCUSIN+"."+handleObj.guid).off(SM.Event.CLICK+"."+handleObj.guid)}}})();SM.Cookies={get:function(name){var map=this.getAll();return map[name]},set:function(name,value,expires,options){var date,ms;options=SM.Object.extend({path:"/"},options);if(typeof expires==="string"){ms=SM.Date.ageToMilliseconds(expires)}else{ms=expires}date=new Date;date.setTime(date.getTime()+ms);expires=date.toGMTString();document.cookie=[name+"="+value,"expires="+expires,"path="+options.path].join("; ");return this},remove:function(name,options){options=SM.Object.extend({path:"/"},options);return this.set(name,"","-1s",options)},getAll:function(){var map={},split,cookies=document.cookie.split(";");$.each(cookies,function(i,cookie){cookie=$.trim(cookie);split=cookie.split("=");if(split.length===2){map[split[0]]=split[1]}});return map}};(function(global){function parseDomains(host){var domainParts=host.split("."),l=domainParts.length,i=0,rootDomain=domainParts[l-2],subDomains=[],subDomain;if(l>2){for(;i<l-2;i++){subDomain=domainParts[i];subDomains.push(subDomain)}}return[].concat(rootDomain).concat(subDomains)}Uri.prototype.getDomains=function(){this.uriParts.domains=this.uriParts.domains||parseDomains(this.uriParts.host);return this.uriParts.domains};Uri.prototype.getRootDomain=function(){var domains=this.getDomains();return domains[0]};Uri.prototype.getSubDomains=function(){var domains=this.getDomains();return domains.slice(1,domains.length)}})(this);SM.BaseMenu={__NAME:"menu",__defaults:{position:{my:"left top",at:"left bottom",offset:"0 -1"},parentEl:document.body},__init:function(){var self=this;if(this.__settings.menuView){this._menuView=this.__settings.menuView}this.bind("click",this._onClick).bind("keydown",this._onKeydown)},__onClick:function(e){e.preventDefault();if(this._isOpen){this.close()}else{this.open()}},__onClosedKeydown:function(e){var kc=e.which;if(kc===SM.KeyCodes.ENTER){e.preventDefault();e.stopPropagation();this.$el.click()}},__onWindowResize:function(e){this.position()},__onMenuInit:function(){},__onBeforeMenuOpen:function(){$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).subscribe(SM.Event.CLICK,this._onDocumentClick).subscribe(SM.Event.KEYDOWN,this._onDocumentKeydown)},__onMenuAddedToPage:function(){},__onAfterMenuOpen:function(){},__onClickOutside:function(e){this.close()},__onFocusOutside:function(e){this.close()},__onOpenKeydown:function(e){var kc=e.which;if(kc===SM.KeyCodes.ESCAPE){e.preventDefault();this.close()}},__onBeforeMenuClose:function(){},__onAfterMenuClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).unsubscribe(SM.Event.KEYDOWN,this._onDocumentKeydown).unsubscribe(SM.Event.CLICK,this._onDocumentClick)},__setters:{position:function(self,val){SM.Object.update(self.__settings.position,val);if(self.isOpen()){self.position()}},parentEl:function(self,val){self.__settings.parentEl=val;if(self.isOpen()){self.position()}}},__getters:{menuView:function(self,val){if(!self._menu){self._initMenu()}return self._menu}},bindMenu:function(event,callback){this._menu.$el.on(this._menu.__NAME+"."+event,{self:this},callback);return this},open:function(){var menuView;if(this.$el.hasClass("disabled")){return}menuView=this.get("menuView");if(this._isOpen){return}this.trigger("beforeOpen");this.__onBeforeMenuOpen();menuView.$el.on("click",".close-menu-btn",{self:this},this._onCloseMenuClick);menuView.$el.appendTo(this.__settings.parentEl);this.$el.addClass("open");this.__onMenuAddedToPage();this.position();this._isOpen=true;this.trigger("afterOpen");this.__onAfterMenuOpen()},close:function(){var menuView;if(!this._isOpen){return}menuView=this.get("menuView");this.trigger("beforeClose");this.__onBeforeMenuClose();menuView.$el.off("click",".close-menu-btn",this._onCloseMenuClick);menuView.$el.detach();this._isOpen=false;this.$el.removeClass("open");this.trigger("afterClose");this.__onAfterMenuClose()},isOpen:function(){return this._isOpen},position:function(){var position;if(!this.__settings.position.of){this.__settings.position.of=this.$el}if(this.__settings.parentEl){this.__settings.position.within=this.__settings.parentEl}position=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this._menu.$el.position(position);this.trigger("position")},_initMenu:function(){var MenuView;if(!this._menu){MenuView=SM[this._menuView];if(!MenuView){throw new Error("A menu requires a menuView key")}this._menu=SM.Views.create(MenuView,this.__settings);this._menu.$el.css({top:0,left:0});this.trigger("menuInit");this.__onMenuInit()}return this._menu},__destroy:function(){if(this._menu){this.__onAfterMenuClose();this._isOpen=false;if(this._menu.$el){this._menu.$el.remove()}this._menu=null}this.$el.off("click",this._onClick).off("keydown",this._onKeydown).data(this.__NAME,null)},_menu:null,_menuView:"BaseMenuView",_isOpen:false,_onClick:function(e){var self=e.data.self;self.__onClick(e)},_onKeydown:function(e){var self=e.data.self;if(!self._isOpen){self.__onClosedKeydown(e)}},_onDocumentKeydown:function(e){var self=e.data.self;self.__onOpenKeydown(e)},_onDocumentClick:function(e){var self=e.data.self;if(!self._menuContains(e.target)&&!self._isStepChild(e.target)&&!self._contains(e.target)){self.__onClickOutside(e)}},_onDocumentFocusin:function(e){var self=e.data.self;if(e.target===document){return}if(!self._menuContains(e.target)&&!self._isStepChild(e.target)&&!self._contains(e.target)&&e.target.tagName.toLowerCase()!=="body"){self.__onFocusOutside(e)}},_onResize:function(e){var self=e.data.self;self.__onWindowResize(e)},_menuContains:function(el){return SM.DOM.contains(this._menu.el,el)},_isStepChild:function(el){return false},_onCloseMenuClick:function(e){e.data.self.close()},_contains:function(el){return SM.DOM.contains(this.el,el)}};SM.Menu=SM.Widgets.register(SM.BaseMenu);SM.ActionMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"actionMenu",__defaults:{saveState:false,selectedAction:null},__onMenuInit:function(){this.bindMenu("actionSelected",this._onActionSelected).bindMenu("optionClicked",this._onOptionClicked).bindMenu("beforeSubmenuOpen",this._onBeforeSubmenuOpen).bindMenu("submenuOpened",this._onSubmenuOpened).bindMenu("submenuClosed",this._onSubmenuClosed);this.activeSubmenu=null;this._isSubmenuOpen=false},__setters:{selectedAction:function(self,action){var menuView=self.get("menuView");menuView.set("selectedAction",action)},actions:function(self,actions){var menuView=self.get("menuView");menuView.set("actions",actions)}},_onOptionClicked:function(e){var self=e.data.self;self.$el.focus();self.close()},closeSubmenus:function(){if(this.activeSubmenu){this.activeSubmenu.closeSubmenus();this.activeSubmenu.close()}},hasAction:function(action){var menuView=this.get("menuView");return menuView.hasAction(action)},_getCurrentAction:function(){var actions=this.__settings.actions,currentIndex=this._menu.get("currentIndex");if(actions&&actions[currentIndex]){return actions[currentIndex]}return null},_getCurrentActionSubmenu:function(){var currentAction=this._getCurrentAction();if(currentAction&&currentAction.submenu&&currentAction.submenu.actions&&currentAction.submenu.actions.length){return currentAction.submenu}return null},_isSubmenu:function(){return!!this.__settings.parentMenu},_menuView:"ActionMenuView",_onActionSelected:function(e){var self=e.data.self;if(self.__settings.saveState&&self.__settings.selectedAction===e.action){return}if(self.__settings.saveState){self.__settings.selectedAction=e.action}self.trigger({type:"actionSelected",action:e.action,$action:e.$action})},_onBeforeSubmenuOpen:function(e){var self=e.data.self;if(self.activeSubmenu){self.activeSubmenu.close()}},_onSubmenuOpened:function(e){var self=e.data.self;self.activeSubmenu=e.actionSubmenu;self.activeSubmenu.bindMenu("actionSelected",function(e){self.close()});self._isSubmenuOpen=true;self.trigger("submenuOpened")},_onSubmenuClosed:function(e){var self=e.data.self;self.activeSubmenu=null;self._isSubmenuOpen=false},__onOpenKeydown:function(e){var kc=e.which,currentAction=this._getCurrentAction();SM.BaseMenu.__onOpenKeydown.call(this,e);if(!this._isSubmenuOpen){if(kc===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.LEFT&&this._isSubmenu()){this.close();e.preventDefault()}else if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.RIGHT&&this._getCurrentActionSubmenu()){this._menu.selectCurrent();e.preventDefault()}}},__onBeforeMenuClose:function(){SM.BaseMenu.__onBeforeMenuClose.call(this);this.closeSubmenus()},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);if(this._menu){this._menu.set("currentIndex",-1)}}});SM.SelectMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"selectMenu",__defaults:{selectedValue:null,options:undefined,paginationEnabled:false,numOptionsPerPage:10,searchEnabled:false,loadPage:undefined,loadSearchPage:undefined,selectWidth:"200px",menuMaxWidth:"400px"},__init:function(options){var menuView,selectedValue;SM.BaseMenu.__init.call(this);this.bind("keypress",this._onCloseKeypress);this.$el.addClass("btn select-menu").css("width",this.__settings.selectWidth);menuView=this.get("menuView");selectedValue=menuView.get("selectedValue");if(selectedValue){this.__settings.selectedValue=selectedValue;this._setDisplay(menuView.get("valueText"))}},__onMenuInit:function(){this.bindMenu("change",this._onMenuChange);this.bindMenu("onOptionsLoaded",this._onMenuOptionsLoaded)},__onClosedKeydown:function(e){var kc=e.which;SM.BaseMenu.__onClosedKeydown.call(this,e);if(kc===SM.KeyCodes.DOWN){this._menu.nextSelect();e.preventDefault()}else if(kc===SM.KeyCodes.UP){this._menu.prevSelect();e.preventDefault()}},__onOpenKeydown:function(e){var kc=e.which,$el=$(e.target),inSearchField=$el.attr("name")==="searchTerm";SM.BaseMenu.__onOpenKeydown.call(this,e);if(kc===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.TAB){e.stopPropagation()}},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this._setMenuUI();this.subscribe(SM.Event.KEYPRESS,this._onOpenKeypress)},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this.unsubscribe(SM.Event.KEYPRESS,this._onOpenKeypress);this.$el.focus()},__onAfterMenuOpen:function(){SM.BaseMenu.__onAfterMenuOpen.call(this);this._menu.prepareMenuLoad()},__setters:{value:function(self,value){self._menu.set("selectedValue",value)},options:function(self,options){self._menu.set("options",options)}},__getters:{value:function(self,val){return self.__settings.selectedValue}},_menuView:"SelectMenuView",_inlineSearchTerm:undefined,_setDisplay:function(text){this.$el.text(text)},_setMenuUI:function(){var $menuEl=this._menu.$el;$menuEl.css("min-width",this.__settings.selectWidth);$menuEl.css("max-width",this.__settings.menuMaxWidth);if(!this.__settings.paginationEnabled){$menuEl.addClass("no-pagination")}},_getNewInlineSearchTerm:function(letter){return this._inlineSearchTerm?this._inlineSearchTerm+letter:letter},_inlineSearchWithSelect:function(letter,shouldSelect){var index,searchTerm,startIndex,setKey=shouldSelect?"selectedIndex":"currentIndex";if(!letter){return}searchTerm=this._getNewInlineSearchTerm(letter);index=this._menu.inlineSearchOptionsWithSelect(searchTerm,shouldSelect);if(this._inlineSearchTerm&&index===-1){this._inlineSearchTerm=undefined;index=this._menu.inlineSearchOptionsWithSelect(letter,shouldSelect)}if(index!==-1){this._menu.set(setKey,index);this._inlineSearchTerm=this._getNewInlineSearchTerm(letter)}else{this._inlineSearchTerm=undefined}},_getLetter:function(e){var charCode=e.charCode!==undefined?e.charCode:e.keyCode;return String.fromCharCode(charCode).toLowerCase()},_onCloseKeypress:function(e){var self=e.data.self,letter;if(!self.isOpen()){letter=self._getLetter(e);if(e.which===SM.KeyCodes.SPACE){e.preventDefault()}self._inlineSearchWithSelect(letter,true)}},_onOpenKeypress:function(e){var self=e.data.self,letter=self._getLetter(e),$el=$(e.target),inOptions=$el.closest(".select-option-item").length>0;if(!inOptions){return}if(e.which===SM.KeyCodes.SPACE){e.preventDefault()}self._inlineSearchWithSelect(letter,false)},_onMenuChange:function(e){var self=e.data.self;if(self.__settings.selectedValue===e.value){self.$el.focus();self.close();return}self._setDisplay(e.displayText);self.__settings.selectedValue=e.value;self.trigger({type:"change",value:e.value,displayText:e.displayText});self.$el.focus();self.close()},_onMenuOptionsLoaded:function(e){var self=e.data.self;self.trigger("onOptionsLoaded")}});SM.Autocomplete=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"autocomplete",__defaults:{minLength:2,delay:0,maxResults:50,autocompleteOnPaste:true,source:[],search:function(term){var source=this.__settings.source,maxResults=this.__settings.maxResults,matches=0,results;results=$.map(source,function(value,index){var lowerValue=value.toLowerCase(),lowerTerm=term.toLowerCase();if(matches>=maxResults){return false}if(lowerValue.indexOf(lowerTerm)!==-1){matches++;return{value:value,text:value}}});this.set("results",results)},position:{collision:"none"},enabled:true,setInputOnSelect:true,matchInputWidth:true},_timeout:undefined,__getters:{input:function(self){return self._getInput()},results:function(self){var menuView=self.get("menuView");return menuView.get("results")}},__setters:{input:function(self,input){self._setInput(input)},results:function(self,results){var menuView=self.get("menuView");if(results.length>self.__settings.maxResults){results=results.slice(0,self.__settings.maxResults)}menuView.set("results",results);if(results.length>0){self.open()}else{self.close()}},enabled:function(self,enabled){if(enabled&&!self.__settings.enabled){self._bindEvents()}else if(!enabled&&self.__settings.enabled){self.close();self.$el.off("keydown",self._onKeydown).off("keyup",self._onKeyup).off("paste",self._onPaste)}self.__settings.enabled=enabled}},__init:function(options){var tagName=this.el.tagName.toLowerCase();if(this.__settings.enabled){this._bindEvents()}if(this.__settings.menuView){this._menuView=this.__settings.menuView}this._hasVal=tagName==="input"||tagName==="textarea";this._height=this.$el.height();this._width=this.$el.outerWidth()},__onMenuInit:function(){this.bindMenu("selected",this._onOptionSelected)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this)},__onMenuAddedToPage:function(){SM.BaseMenu.__onMenuAddedToPage.call(this);if(this.__settings.matchInputWidth){this._matchInputSize()}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this._menu.set("currentIndex",-1)},__onWindowResize:function(){this._matchInputSize();SM.BaseMenu.__onWindowResize.call(this)},_matchInputSize:function(){var menuView=this.get("menuView"),$el=this.$el,inputWidth=$el.outerWidth(),menuViewBorderLeftWidth=parseInt(menuView.$el.css("border-left-width"),10),menuViewBorderRightWidth=parseInt(menuView.$el.css("border-right-width"),10);menuView.$el.css("width",inputWidth-menuViewBorderLeftWidth-menuViewBorderRightWidth)},_bindEvents:function(){this.bind("keydown",this._onKeydown).bind("keyup",this._onKeyup);if(this.__settings.autocompleteOnPaste){this.bind("paste",this._onPaste)}},_menuView:"AutocompleteMenuView",_pipeInput:function(){var currentInput=this._getInput();if(currentInput.length>=this.__settings.minLength){this._checkHeight();this._checkSearch()}else{this.close()}},_checkHeight:function(){var currHeight=this.$el.height();if(this._height!==currHeight&&this.isOpen()){this.position();this._height=currHeight}},_debounceSearch:function(){var self=this;clearTimeout(self._timeout);self._timeout=setTimeout(function(){self._pipeInput()},self.__settings.delay)},_checkSearch:function(){var currentInput=this._getInput();this.__settings.search.call(this,currentInput)},_getInput:function(){var $el=this.$el;return $.trim(this._hasVal?$el.val():$el.text())},_setInput:function(input){var $el=this.$el;if(this._hasVal){$el.val(input)}else{$el.text(input)}},_onOptionSelected:function(e){var self=e.data.self;if(self.__settings.setInputOnSelect){self._setInput(e.text)}self.trigger({type:"selected",text:e.text,value:e.value});self.close()},_onKeyup:function(e){var self=e.data.self,kc=e.which;if(kc===SM.KeyCodes.DOWN||kc===SM.KeyCodes.UP||kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.ESCAPE){e.preventDefault();return}if(kc===SM.KeyCodes.SHIFT||kc===SM.KeyCodes.CTRL||kc===SM.KeyCodes.CAPS||kc===SM.KeyCodes.ALT||kc===SM.KeyCodes.HOME||kc===SM.KeyCodes.END||kc===SM.KeyCodes.LEFT||kc===SM.KeyCodes.RIGHT||kc===SM.KeyCodes.LEFT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.SELECT){return}if((e.ctrlKey||e.metaKey)&&kc===SM.KeyCodes.V){return}if(self.__settings.delay>0){self._debounceSearch()}else{self._pipeInput()}},_onPaste:function(e){var self=e.data.self;setTimeout(function(){self._pipeInput()},0)},_onKeydown:function(e){var self=e.data.self,kc=e.which;if(self.isOpen()){if(kc===SM.KeyCodes.DOWN){self._menu.nextCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.UP){self._menu.prevCurrent();e.preventDefault()}else if(kc===SM.KeyCodes.ENTER){self._menu.selectCurrent();e.preventDefault()}}}});SM.Datepicker=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"datepicker",__defaults:{selectedDate:null,minDate:null,maxDate:null,selectMenus:false,dateFormat:"d"},__init:function(options){this.bind("focusin",this._onFocusIn).bind("click",this._onClick).bind("keyup",this._onKeyup).bind("paste",this._onPaste);if(this.$el.siblings(".datepicker-icon").length){this.$icon=this.$el.siblings(".datepicker-icon").first();this.$icon.on("click",{self:this},this._onIconClick)}this._setInitialValue()},__onMenuInit:function(){this.bindMenu("dateSelected",this._onDateSelected)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this._menu.resetDisplayDate(this.__settings);this._menu.render()},__setters:{selectedDate:function(self,val){self._setSelectedDate(val);self.trigger("dateSelected")},minDate:function(self,val){self._setMinDate(val)},maxDate:function(self,val){self._setMaxDate(val)},selectMenus:function(self,val){self.__settings.selectMenus=val}},_menuView:"CalendarMenuView",_setSelectedDate:function(date){var state=this.__settings;if(date){if(state.minDate&&date<state.minDate){state.selectedDate=new Date(state.minDate)}else if(state.maxDate&&date>state.maxDate){state.selectedDate=new Date(state.maxDate)}else{state.selectedDate=date}this.$el.val(Globalize.format(state.selectedDate,state.dateFormat))}else{state.selectedDate=null;this.$el.val("")}return this},_setMinDate:function(date){var state=this.__settings;if(date){if(state.selectedDate&&date>state.selectedDate){state.minDate=new Date(state.selectedDate)}else if(state.maxDate&&date>state.maxDate){state.minDate=new Date(state.maxDate)}else{state.minDate=date}}else{state.minDate=null}return this},_setMaxDate:function(date){var state=this.__settings;if(date){if(state.selectedDate&&date<state.selectedDate){state.maxDate=new Date(state.selectedDate)}else if(state.minDate&&date<state.minDate){state.maxDate=new Date(state.minDate)}else{state.maxDate=date}}else{state.maxDate=null}return this},_setInitialValue:function(){var selectedDate=this.__settings.selectedDate;if(selectedDate){this._setSelectedDate(selectedDate)}return this},_parseDate:function(dateString){var date=Globalize.parseDate(dateString,this.get("dateFormat"));if(date){this.set("selectedDate",date)}else{this.set("selectedDate",null)}},_isStepChild:function(el){return this.$icon&&this.$icon.get(0)===el},_onFocusIn:function(e){var self=e.data.self;self.open()},_onClick:function(e){var self=e.data.self;self.open()},_onDateSelected:function(e){var self=e.data.self;self.set("selectedDate",e.date);self.$el.focus();self.close()},_onKeyup:function(e){var self=e.data.self,val=self.$el.val();self._parseDate(val)},_onPaste:function(e){var self=e.data.self,val=self.$el.val();self._parseDate(val)},_onIconClick:function(e){var self=e.data.self;self.open()}});SM.DateRange=SM.Widgets.register({__NAME:"dateRangePicker",__getters:{startMinDate:function(self){return self._start.get("minDate")},startMaxDate:function(self){return self._start.get("maxDate")},startSelectedDate:function(self){return self._start.get("selectedDate")},endMinDate:function(self){return self._end.get("minDate")},endMaxDate:function(self){return self._end.get("maxDate")},endSelectedDate:function(self){return self._end.get("selectedDate")}},__setters:{startMinDate:function(self,val){self._start.set("minDate",val)},startMaxDate:function(self,val){self._start.set("maxDate",val)},startSelectedDate:function(self,val){self._start.set("selectedDate",val)},endMinDate:function(self,val){self._end.set("minDate",val)},endMaxDate:function(self,val){self._end.set("maxDate",val)},endSelectedDate:function(self,val){self._end.set("selectedDate",val)}},__init:function(options){var start=this.$el.find(".datepicker.date-start"),end=this.$el.find(".datepicker.date-end");if(start.length===0||end.length===0){throw new Error(".date-start or .date-end not found inside daterange element")}start.datepicker({minDate:options.startMinDate,maxDate:options.startMaxDate,selectedDate:options.startSelectedDate,selectMenus:options.selectMenus});end.datepicker({minDate:options.endMinDate,maxDate:options.endMaxDate,selectedDate:options.endSelectedDate,selectMenus:options.selectMenus});this._initStartMaxDate=options.startMaxDate;this._initEndMinDate=options.endMinDate;this._start=start.data("datepicker");this._end=end.data("datepicker");this._start.$el.on("datepicker.beforeOpen",{daterange:this},this._startDateOpen);
this._end.$el.on("datepicker.dateSelected",{daterange:this},this._onEndDateSelected).on("datepicker.beforeOpen",{daterange:this},this._endDateOpen)},_start:undefined,_end:undefined,_initStartMaxDate:undefined,_initEndMinDate:undefined,_startDateOpen:function(e){var self=e.data.daterange,selectedEndDate=self._end.get("selectedDate"),startMaxDate=self._start.get("maxDate"),endMaxDate=self._end.get("maxDate");if(selectedEndDate&&self._initStartMaxDate&&selectedEndDate<self._initStartMaxDate){self._start.set("maxDate",selectedEndDate)}else if(selectedEndDate&&!self._initStartMaxDate){self._start.set("maxDate",selectedEndDate)}else if(self._initStartMaxDate){self._start.set("maxDate",self._initStartMaxDate)}else if(endMaxDate){self._start.set("maxDate",endMaxDate)}},_endDateOpen:function(e){var self=e.data.daterange,selectedStartDate=self._start.get("selectedDate"),endMinDate=self._end.get("minDate"),startMinDate=self._start.get("minDate");if(selectedStartDate&&self._initEndMinDate&&selectedStartDate>self._initEndMinDate){self._end.set("minDate",selectedStartDate)}else if(selectedStartDate&&!self._initEndMinDate){self._end.set("minDate",selectedStartDate)}else if(self._initEndMinDate){self._end.set("minDate",self._initEndMinDate)}else if(startMinDate){self._end.set("minDate",startMinDate)}},_onEndDateSelected:function(e){var self=e.datepicker,selectedDate=self.get("selectedDate");if(selectedDate){selectedDate.setMilliseconds(999);selectedDate.setSeconds(59);selectedDate.setMinutes(59);selectedDate.setHours(23);self._setSelectedDate(selectedDate)}}});SM.Accordion=SM.Widgets.register({__NAME:"accordion",__defaults:{multiOpen:false,overflowAuto:true},__init:function(){this._cacheData()._bindEvents();if(SM.Browser.isIE8){this.$el.find("div.key > header > h3").prepend('<span class="accordion-arrow"></span>')}},KEY_ATTR:"data-panel-key",close:function(panelKey){var panel;panelKey=this._getNormalizedStringPanelkey(panelKey);panel=this._panels[panelKey];if(panel&&this._openPanels[panelKey]){this._close(panel)}return this},open:function(panelKey){var panel;panelKey=this._getNormalizedStringPanelkey(panelKey);panel=this._panels[panelKey];if(panel&&!this._openPanels[panelKey]){if(!this.__settings.multiOpen){this._closeOpenPanels()}this._open(panel)}return this},disable:function(panelKey,disabled){var $header;panelKey=this._getNormalizedStringPanelkey(panelKey);$header=this.$el.find("#"+panelKey).siblings("header");if(panelKey){if(disabled){this._disabledPanels[panelKey]=true;$header.addClass("disabled")}else{delete this._disabledPanels[panelKey];$header.removeClass("disabled")}}return this},isOpen:function(panelKey){panelKey=this._getNormalizedStringPanelkey(panelKey);return!!this._openPanels[panelKey]},isDisabled:function(panelKey){panelKey=this._getNormalizedStringPanelkey(panelKey);return!!this._disabledPanels[panelKey]},_openPanels:undefined,_panels:undefined,_disabledPanels:undefined,_close:function(panel){panel.$section.css("overflow-y","hidden");this.__trigger({type:"beforeClose",index:panel.index,id:panel.key});delete this._openPanels[panel.key];panel.$section.animate({height:0},200,this._onClose)},_open:function(panel){var height;panel.$panel.addClass("opening");this.__trigger({type:"beforeOpen",index:panel.index,id:panel.key});this._openPanels[panel.key]=true;if(!this.$el.hasClass("static")){height=panel.$section.css("height","auto").height();panel.$section.css("height",0);this.$el.one("accordion.afterOpen",function(){panel.$section.css("height","auto")})}else{panel.$panel.addClass("open");height=panel.$section.height();panel.$panel.removeClass("open")}panel.$section.animate({height:height},200,this._onOpen)},_cacheData:function(){var i=0,$panels,$panel,id,$section,panelLen,$header;this._openPanels={};this._panels={};this._disabledPanels={};$panels=this.$el.children("div.key");panelLen=$panels.length;for(;i<panelLen;i++){$panel=$panels.eq(i);$header=$panel.find("header");id=$header.find("a.keyOpener").attr("target").substr(1);$section=this.$el.find("#"+id);this._panels[id]={index:i,key:id,$panel:$panel,$section:$section};if($panel.hasClass("open")){this._openPanels[id]=true}if($header.hasClass("disabled")){this.disable(id,true)}}return this},_closeOpenPanels:function(){var panels=this._panels,openPanels=this._openPanels,panel;for(panel in openPanels){if(openPanels[panel]){this._close(panels[panel])}}},_bindEvents:function(){this.$el.on("click",".key > header",{accordion:this},this._onKeyClick);return this},_getNormalizedStringPanelkey:function(index){if(typeof index==="string"){return index}var panel,panels=this._panels;for(panel in panels){if(panels[panel].index===index){return panels[panel].key}}},_getSingleOpenedPanelkey:function(){for(var panelKey in this._openPanels){return panelKey}},_onClose:function(){var $section=$(this),self=$section.closest(".accordion").data(SM.Accordion.__NAME),panelKey=$section.attr("id"),panel=self._panels[panelKey];panel.$panel.removeClass("open");$section.removeAttr("style");self.__trigger({type:"afterClose",index:panel.index,id:panel.key})},_onOpen:function(){var $section=$(this),self=$section.closest(".accordion").data(SM.Accordion.__NAME),panelKey=$section.attr("id"),panel=self._panels[panelKey];panel.$panel.removeClass("opening");panel.$panel.addClass("open");if(self.__settings.overflowAuto){$section.css("overflow-y","auto")}self.__trigger({type:"afterOpen",index:panel.index,id:panel.key})},_onKeyClick:function(e){var self=e.data.accordion,panelKey=$(this).find("a.keyOpener").attr("target").substring(1),openedKey=self._getSingleOpenedPanelkey();e.preventDefault();if(self.isDisabled(panelKey)){return}if(!self.__settings.multiOpen&&openedKey&&self.isDisabled(openedKey)){return}if(self._openPanels[panelKey]){self.close(panelKey)}else{self.open(panelKey)}}});SM.Popout=SM.Widgets.register({__NAME:"popout",__defaults:{tipSideX:"left",tipSideY:"top",parentElement:document.body,offsetX:null,offsetY:null,at:"left top",showDelayTime:750,hideDelayTime:500,collision:"flip flip",tipOrientation:"leftright",autoClose:true,preventClick:true},__init:function(options){this.$el.on("mouseenter.popout open.popout",{popout:this},this._onMouseenter).on("close.popout",{popout:this},this._onCloseClick);if(this.__settings.preventClick){this.$el.on("click.popout",this._onClick)}if(this.__settings.autoClose){this.$el.on("mouseleave.popout",{popout:this},this._onMouseleave)}},__destroy:function(){this.$el.off(".popout")},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_offsetX:undefined,_offsetY:undefined,_tipSideX:undefined,_tipSideY:undefined,_positions:{leftright:{left:{css:"tip-left",offset:"+32",flip:"right"},right:{css:"tip-right",offset:"-15",flip:"left"},bottom:{css:"tip-bottom",offset:"+34",flip:"top"},top:{css:"tip-top",offset:"-14",flip:"bottom"}},topbottom:{left:{css:"tip-left",offset:"-14",flip:"right"},right:{css:"tip-right",offset:"+34",flip:"left"},bottom:{css:"tip-bottom",offset:"-15",flip:"top"},top:{css:"tip-top",offset:"+32",flip:"bottom"}}},_beforeShow:function(){var positions=this._getPositionByOrientation(this.__settings.tipOrientation);if(this.__settings.offsetX){this._offsetX=this.__settings.offsetX}else{this._offsetX=positions[this.__settings.tipSideX].offset}if(this.__settings.offsetY){this._offsetY=this.__settings.offsetY}else{this._offsetY=positions[this.__settings.tipSideY].offset}this._$msg=this.$el.find(".popout");if(this._$msg.length===0){this.$el.append("<div class='popout'></div>");this._$msg=this.$el.find(".popout").html($("#"+this.$el.attr("data-help")).html())}this._$msg=this._$msg.clone();if(this.__settings.tipOrientation){this._$msg.addClass("tip-orientation-"+this.__settings.tipOrientation)}this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("position.horizontal.flip",{popout:this,offsetKey:"_offsetX",tipKey:"tipSideX"},this._onMessageFlip).on("position.vertical.flip",{popout:this,offsetKey:"_offsetY",tipKey:"tipSideY"},this._onMessageFlip).on("click",".close",{popout:this},this._onCloseClick).addClass(positions[this.__settings.tipSideX].css).addClass(positions[this.__settings.tipSideY].css).addClass("tip-orientation-"+this.__settings.tipOrientation).append('<span class="tip"></span>').append('<a class="close"><span aria-hidden="true"></span>Close</a>').appendTo(this.__settings.parentElement);if(this.__settings.autoClose){this._$msg.on("mouseleave",{popout:this},this._onMessageMouseleave)}this._isMsgSetup=true;return this},_show:function(){var self=this;setTimeout(function(){if(self._isHovered){self._$msg.addClass("open").position($.migrationFixPosition({my:self.__settings.tipSideX+" "+self.__settings.tipSideY,at:self.__settings.at,of:self.$el,offset:self._offsetX+" "+self._offsetY,collision:self.__settings.collision}));self.trigger("opened")}},self.get("showDelayTime"));return self},_hide:function(){var self=this;setTimeout(function(){if(!self._isHovered){if(self._$msg!==undefined){self._$msg.remove()}self._isMsgSetup=false}},self.get("hideDelayTime"));return self},_getPositionByOrientation:function(orientation){if(typeof this._positions[orientation]!=="undefined"){return this._positions[orientation]}else{return this._positions.leftright}},_onMessageFlip:function(e){var self=e.data.popout,dir=self.__settings[e.data.tipKey],positions=self._getPositionByOrientation(self.__settings.tipOrientation),current=positions[dir],next=positions[current.flip];self[e.data.offsetKey]=next.offset;self._$msg.removeClass(current.css).addClass(next.css)},_onMouseenter:function(e){var self=e.data.popout;self._isHovered=true;if(!self._isMsgSetup){self._beforeShow()._show()}},_onMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()},_onMessageMouseenter:function(e){var self=e.data.popout;self._isHovered=true},_onMessageMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()},_onCloseClick:function(e){var self=e.data.popout;self._isHovered=false;self._$msg.remove();self._isMsgSetup=false;e.stopPropagation()},_onClick:function(e){e.preventDefault();e.stopPropagation()}});SM.SidiPopout=SM.Widgets.register({__NAME:"sidipopout",__defaults:{templateID:"sidi-popout-msg-template",tipSide:"left",parentElement:document.body,at:"left top",showDelayTime:250,hideDelayTime:150,collision:"flip flip"},__init:function(){this.$el.on("mouseenter",{popout:this},this._onMouseenter).on("mouseleave",{popout:this},this._onMouseleave)},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_tipSide:undefined,_beforeShow:function(){var html,self=this;this._$msg=this.$el.find(".popout");this._$msg=this._$msg.clone();html=SM.Template.render(this.__settings.templateID,this.__settings);this._$msg.append(html);if(self.__settings.tipSide==="bottom"){self._$msg.css("width",100)}this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).on(SM.Event.CLICK,"[data-dimension-id]",{popout:this},self._onClickCombineHide).addClass("sidi-tip-"+this.__settings.tipSide).appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this},_show:function(){var self=this;if($("body").hasClass("noPopout")){return}setTimeout(function(){var offset=self.$el.offset(),posx=offset.left,posy=offset.top;if(self._isHovered){if(self.__settings.tipSide==="left"||self.__settings.tipSide==="right"){if(self.__settings.tipSide==="left"){posx+=self.$el.outerWidth()}else{posx-=self._$msg.outerWidth()}posy+=(self.$el.outerHeight()-self._$msg.outerHeight())/2}else{posx+=(self.$el.outerWidth()-self._$msg.outerWidth())/2;if(self.__settings.tipSide==="bottom"){posy-=self._$msg.outerHeight()+12}else{posy+=self._$msg.outerHeight()}}self._$msg.addClass("open").css({left:Math.floor(posx)+"px",top:Math.floor(posy)+"px"});self.trigger("opened")}},self.get("showDelayTime"));return self},_hide:function(){var self=this;setTimeout(function(){if(!self._isHovered){self._$msg.remove();self._isMsgSetup=false}},self.get("hideDelayTime"));return self},_onMouseenter:function(e){var self=e.data.popout;self._isHovered=true;if(!self._isMsgSetup){self._beforeShow()._show()}},_onMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()},_onMessageMouseenter:function(e){var self=e.data.popout;self._isHovered=true},_onMessageMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()},_onClickCombineHide:function(e){var self=e.data.popout,$currentTarget=$(e.currentTarget),answerID=$currentTarget.attr("data-dimension-id"),combinehideModel=self.__settings.question.getRollup().combinehideModel;if(answerID){combinehideModel.unCombine(answerID)}else{combinehideModel.unHideAll()}self._isHovered=false;self._hide()}});SM.TMBCPopout=SM.Widgets.register({__NAME:"tmbcpopout",__defaults:{templateID:"tmbc-popout-msg-template",tipSideX:"left",tipSideY:"top",parentElement:document.body,offsetX:null,offsetY:null,at:"left top",showDelayTime:250,hideDelayTime:150,collision:"flip flip"},__init:function(){this.$el.on("mouseenter",{popout:this},this._onMouseenter).on("mouseleave",{popout:this},this._onMouseleave)},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_tipSideX:undefined,_tipSideY:undefined,_offsetX:undefined,_offsetY:undefined,_positions:{left:{css:"tip-left",offset:"+32",flip:"right"},right:{css:"tip-right",offset:"-15",flip:"left"},bottom:{css:"tip-bottom",offset:"+34",flip:"top"},top:{css:"tip-top",offset:"-14",flip:"bottom"}},_beforeShow:function(){var html;if(this.__settings.offsetX){this._offsetX=this.__settings.offsetX}else{this._offsetX=this._positions[this.__settings.tipSideX].offset}if(this.__settings.offsetY){this._offsetY=this.__settings.offsetY}else{this._offsetY=this._positions[this.__settings.tipSideY].offset}this._$msg=this.$el.find(".popout");this._$msg=this._$msg.clone();html=SM.Template.render(this.__settings.templateID,this.__settings);this._$msg.append(html);this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).addClass("sidi-tip-"+this.__settings.tipSideX).appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this},_show:function(){var self=this;setTimeout(function(){var $text=self.$el,offset=$text.offset(),posx=offset.left,posy=offset.top;if(self._isHovered){if(self.__settings.tipSideX==="left"){posx+=$text.outerWidth()+10}else{posx-=self._$msg.outerWidth()}posy+=($text.outerHeight()-self._$msg.outerHeight())/2;posy+=self.__settings.offsetY;self._$msg.addClass("open").css({left:Math.floor(posx)+"px",top:Math.floor(posy)+"px"});self.trigger("opened")}},self.get("showDelayTime"));return self},_hide:function(){var self=this;setTimeout(function(){if(!self._isHovered){if(self._$msg){self._$msg.remove()}self._isMsgSetup=false}},self.get("hideDelayTime"));return self},_onMouseenter:function(e){var self=e.data.popout;self._isHovered=true;if(!self._isMsgSetup){self._beforeShow()._show()}},_onMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()},_onMessageMouseenter:function(e){var self=e.data.popout;self._isHovered=true},_onMessageMouseleave:function(e){var self=e.data.popout;self._isHovered=false;self._hide()}});SM.Form=SM.Widgets.register({__NAME:"form",__defaults:{formErrorsClass:"form-errors",formGroupErrorClass:"has-error",formControlErrorsClass:"form-control-errors",formControlErrorMessageClass:"form-control-error-message"},__init:function(options){var self=this;self.formView=options.formView;options.formView=null;self.options=SM.Object.deepUpdate(self.__defaults,options);self.validations=self.formView.validations;self.errors=[]},attrs:function(){var attrs={},attrList;attrList=this.$el.serializeArray();_.each(attrList,function(attr){attrs[attr.name]=attr.value});return attrs},validate:function(){var self=this,formErrorsClass=self.options.formErrorsClass,formGroupErrorClass=self.options.formGroupErrorClass,formControlErrorsClass=self.options.formControlErrorsClass,formControlErrorMessageClass=self.options.formControlErrorMessageClass;var validator=function(attrs,selector){var shouldValidate=true,$checkbox,fieldValue;if(attrs["if"]){shouldValidate=attrs["if"]()}else if(attrs["ifChecked"]){$checkbox=self.$el.find(attrs["ifChecked"]);if($checkbox.length){shouldValidate=$checkbox.prop("checked")}else{SM.log("Could not find "+attrs["ifChecked"])}}if(shouldValidate){if(attrs.type==="presence"){fieldValue=self.$el.find(selector).val();if(_.isEmpty(fieldValue)){self.errors.push([selector,attrs.message])}}else if(attrs.type==="length"){fieldValue=self.$el.find(selector).val();if(_.has(attrs,"exactly")&&fieldValue.length!==attrs.exactly){self.errors.push([selector,attrs.message])}if(_.has(attrs,"min")&&fieldValue.length<attrs.min){self.errors.push([selector,attrs.message])}if(_.has(attrs,"max")&&fieldValue.length>attrs.max){self.errors.push([selector,attrs.message])}}}};self.errors=[];self.$el.find("."+formErrorsClass).hide();self.$el.find("."+formGroupErrorClass).removeClass(formGroupErrorClass);self.$el.find("."+formControlErrorsClass).remove();_.each(self.validations,function(obj,selector){if(!_.isArray(obj)){validator(obj,selector)}else{_.each(obj,function(attrs){validator(attrs,selector)})}});var selector,message,$formControl,$formControlErrors;if(self.errors.length){self.$el.find("."+formErrorsClass).show();_.each(self.errors,function(error){selector=error[0];message=error[1];$formControl=self.$el.find(selector);$formControl.parents(".form-group").eq(0).addClass(formGroupErrorClass);$formControlErrors=$formControl.next("."+formControlErrorsClass);if(!$formControlErrors.length){$formControlErrors=$("<div class='"+formControlErrorsClass+"'></div>");$formControl.after($formControlErrors)}$formControlErrors.append("<p class='"+formControlErrorMessageClass+"'>"+message+"</p>")})}},isValid:function(){this.validate();return _.isEmpty(this.errors)}});SM.Tabs=SM.Widgets.register({__NAME:"tabs",__defaults:{requireOpenTab:true},__setters:{selectedTab:function(self,val){self.open(val)}},__getters:{selectedTab:function(self){return self._selectedTab}},__init:function(){this._cacheData()._initTab()._bindEvents()},open:function(tabKey){var tab,selectedTab=this._selectedTab;if(typeof tabKey!=="string"){tabKey=this._getKeyFromIndex(tabKey)}tab=this._tabs[tabKey];if(!tab){return this}if(tab.$tab.hasClass("disabled")||selectedTab===tabKey){return this}this._opening=tab;this._closeOpenTab();if(!this._selectedTab){this._open(tab)}this._opening=undefined;return this},close:function(tabKey){var tab,selectedTab=this._selectedTab;if(tabKey===undefined&&!this.__settings.requireOpenTab){this._closeOpenTab();return this}if(typeof tabKey!=="string"){tabKey=this._getKeyFromIndex(tabKey)}tab=this._tabs[tabKey];if(tab&&selectedTab===tab.key&&!this.__settings.requireOpenTab){this._close(tab)}return this},_selectedTab:undefined,_tabs:undefined,_close:function(tab){var e=$.Event("beforeClose",{tab:tab,opening:this._opening});this.__trigger(e);if(e.isDefaultPrevented()){return this}tab.$panel.removeClass("open");tab.$tab.removeClass("active");this._selectedTab=undefined;this.__trigger({type:"afterClose",tab:tab});return this},_open:function(tab){this.__trigger({type:"beforeOpen",tab:tab});this._setOpenView(tab);return this},_setOpenView:function(tab){this._selectedTab=tab.key;tab.$tab.addClass("active");tab.$panel.addClass("open")},_bindEvents:function(){this.$el.children("nav").find(".tab").on("click",{tabs:this},this._onTabClick);return this},_initTab:function(){var $activeTab=this.$el.children("nav").find(".tab.active"),tabKey,tab;if($activeTab.length){tabKey=$activeTab.attr("tab-target");tab=this._tabs[tabKey];this._setOpenView(tab)}return this},_closeOpenTab:function(){var selectedTab=this._selectedTab,tab;if(selectedTab===undefined){return this}tab=this._tabs[selectedTab];this._close(tab);return this},_cacheData:function(){var id,len,i=0,$tab,$panel,$tabs;$tabs=this.$el.children("nav").find(".tab");len=$tabs.length;this._tabs={};for(;i<len;i++){$tab=$tabs.eq(i);id=$tab.attr("tab-target");$panel=this.$el.find(".panel[tab="+id+"]");this._tabs[id]={index:i,$tab:$tab,key:id,$panel:$panel}}return this},_getKeyFromIndex:function(index){var tab,tabs=this._tabs;for(tab in tabs){if(tabs[tab].index===index){return tabs[tab].key}}},_onTabClick:function(e){var tabs=e.data.tabs,$tab=$(this),tabKey;e.preventDefault();tabKey=$tab.attr("tab-target");if(tabs.__settings.noClickTab===tabKey){return}if(tabs._selectedTab===tabKey){tabs.close(tabKey)}else{tabs.open(tabKey)}}});SM.SideTab=SM.Widgets.register({__NAME:"sideTab",__init:function(){var self=this,bottom;if(SM.Browser.isIE7){return}if(!this._supportsMediaQuery){this._bindWindowResize()}this.$el.appendTo(document.body);bottom=this._getBottomValue();this.$el.css("bottom",bottom);setTimeout(function(){var right=self._getRightValues();self.$el.css("right",right.normal);self.$el.hover(function(){self.$el.addClass("fast").css("right",right.hover)},function(){self.$el.css("right",right.normal)});if(!self._supportsMediaQuery){self._hasShown=true;self._$window.trigger("resize")}},1800)},_supportsMediaQuery:SM.Browser.support.mediaQuery(),_$window:$(window),MIN_SCREEN_WIDTH:1040,INITIAL_BOTTOM:30,SPACING:7,_bindWindowResize:function(){var self=this;this._hasShown=false;this._$window.on("resize",function(e){if(self._hasShown){if(self._$window.width()>self.MIN_SCREEN_WIDTH){self.$el.show()}else{self.$el.hide()}}})},_getRightValues:function(){var width=this.$el.outerWidth(),height=this.$el.outerHeight(),hoverRight,right;if(SM.Browser.isIE8){right=-1*(height-width)}else{right=-1*((width-height)/2)}hoverRight=Math.floor(right);right=hoverRight-5;return{hover:hoverRight,normal:hoverRight-5}},_getBottomValue:function(){var $prev=this.$el.prev(".sidetab"),bottom;if($prev.length){bottom=this._getPreviousTopValue($prev)+this.SPACING}else{bottom=this.INITIAL_BOTTOM}return bottom+this._getRotationAdjustment()},_getRotationAdjustment:function(){var width=this.$el.outerWidth(),height=this.$el.outerHeight();if(SM.Browser.isIE8){return height-width}else{return width-(width+height)/2}},_getPreviousTopValue:function($prev){var prevWidth=$prev.outerWidth(),prevHeight=$prev.outerHeight(),prevBottom=parseInt($prev.css("bottom"),10),prevRotationAdjustment;if(SM.Browser.isIE8){prevRotationAdjustment=prevWidth;return prevRotationAdjustment+prevBottom}else{prevRotationAdjustment=(prevWidth+prevHeight)/2;return prevRotationAdjustment+prevBottom}}});SM.Timepicker=SM.Widgets.register({__NAME:"timepicker",__defaults:{minuteIncrement:15,militaryTime:false,time:null},__init:function(){var timeData={hours:-1,minutes:-1,ampm:"AM"};if(this.__settings.time){timeData=this._parseTime(this.__settings.time)}this._createMenus(timeData);this.bind("selectMenu.change",".hour-menu-btn",this._hoursPicked).bind("selectMenu.change",".minute-menu-btn",this._minutesPicked);if(!this.__settings.militaryTime){this.bind("selectMenu.change",".ampm-menu-btn",this._ampmPicked)}else{this.$el.find(".ampm-menu-btn").hide()}},__setters:{date:function(self,date){var timeData=self._parseTime(date);self._setMenus(timeData)},hours:function(self,hours){var ampm,timedata;if(!self.__settings.militaryTime){timedata=self._convertHoursToAMPM(hours);hours=timedata.hours;ampm=timedata.ampm;self._ampm.set("value",ampm)}self._hours.set("value",hours)},minutes:function(self,val){self._minutes.set("value",val)},ampm:function(self,val){self._ampm.set("value",val)},time:function(self,date){self.set("date",date)}},__getters:{isMilitaryTime:function(self){if(Globalize.usesMilitaryTime()){return true}return self.__settings.militaryTime},time:function(self){var hours=parseInt(self._hours.get("value"),10),minutes=parseInt(self._minutes.get("value"),10),ampm;if(!self.__settings.militaryTime&&hours>=0){ampm=self._ampm.get("value");if(hours===12){if(ampm==="AM"){hours=0}}else{if(ampm==="PM"){hours+=12}}}return{hours:hours,minutes:minutes}}},_createMenus:function(timeData){var culture=Globalize.getSmartlingCulture();this._hours=this.$el.find(".hour-menu-btn").selectMenu({menuView:"HourSelectMenuView",selectWidth:"auto",selectedValue:timeData.hours,militaryTime:this.__settings.militaryTime}).data("selectMenu");this._minutes=this.$el.find(".minute-menu-btn").selectMenu({menuView:"MinuteSelectMenuView",selectWidth:"auto",selectedValue:timeData.minutes,increment:this.__settings.minuteIncrement}).data("selectMenu");if(!this.get("isMilitaryTime")){this._ampm=this.$el.find(".ampm-menu-btn").selectMenu({options:[{text:Globalize.cultures[culture].calendar.AM[0],value:"AM"},{text:Globalize.cultures[culture].calendar.PM[0],value:"PM"}],selectWidth:"auto",selectedValue:timeData.ampm}).data("selectMenu")}},_setMenus:function(timeData){this._hours.set("value",timeData.hours.toString());this._minutes.set("value",timeData.minutes.toString());if(!this.__settings.militaryTime){this._ampm.set("value",timeData.ampm)}},_convertHoursToAMPM:function(hours){if(hours===12){ampm="PM"}else if(hours>12){hours=hours-12;ampm="PM"}else{ampm="AM";if(hours===0){hours=12}}return{hours:hours,ampm:ampm}},_parseTime:function(time){var hours=time.getHours(),minutes=time.getMinutes(),ampm,i=this.__settings.minuteIncrement,r,timedata;r=minutes%i;if(r>0){if(Math.floor(i/2)-r>0){minutes=minutes-r}else{minutes=minutes-r+i;if(minutes>=60){hours++;minutes=0;if(hours===24){hours=0}}}}if(!this.__settings.militaryTime){timedata=this._convertHoursToAMPM(hours);hours=timedata.hours;ampm=timedata.ampm}return{hours:hours,minutes:minutes,ampm:ampm}},_hoursPicked:function(e){var self=e.data.self;self.trigger("change")},_minutesPicked:function(e){var self=e.data.self;self.trigger("change")},_ampmPicked:function(e){var self=e.data.self;self.trigger("change")}});SM.Waterpark=SM.Widgets.register({__NAME:"waterpark",__init:function(){this.calculateAttributes()._bindEvents()._displayLocation(this.__settings.location)},__defaults:{location:{slide:0}},__setters:{location:function(self,val){self._setLocation(val)}},calculateAttributes:function(){var $slides=this.$el.find(".slide"),slideCount=$slides.length,slideWidth,totalWidth;if(slideCount%2!==0){slideCount+=1}slideWidth=SM.Math.toPercentString(1/slideCount,6),totalWidth=""+slideCount*100+"%";this.$el.find(".mover").css("width",totalWidth);$slides.css("width",slideWidth);return this},_bindEvents:function(){this.$el.on("click","a.shifter",{waterpark:this},this._onShifterClick).on("click","a.custom-shifter",{waterpark:this},this._onCustomShiftClick).on("click","a.back-shifter",{waterpark:this},this._onBackClick);return this},_setLocation:function(location){var currentLoc=this.__settings.location,self=this,$slide;if(!location||location.slide===undefined){return this}if(currentLoc&&location.slide===currentLoc.slide&&location.lane===currentLoc.lane){return this}this._displayLocation(location);this.__settings.location.slide=location.slide;this.__settings.location.lane=location.lane;this.__trigger("shift");this._startAfterTimer(location.slide,location.lane);return this},_startAfterTimer:function(slide,lane){var location=this.__settings.location,self=this;setTimeout(function(){if(location.slide===slide&&location.lane===lane){self.trigger("afterShift")}},300)},_displayLocation:function(location){var $slide,distance=""+location.slide*-100+"%";if(!SM.Browser.isIE7){this.$el.find(".mover").css("margin-left",distance)}$slide=this.$el.find(".slide").removeClass("current").eq(location.slide).addClass("current");if(location.lane){$slide.find(".lane").removeClass("open").filter("."+location.lane).addClass("open")}},_onShifterClick:function(e){var $el=$(this),waterpark=e.data.waterpark,lane=$el.attr("lane-target"),slide=parseInt($el.attr("slide-target"),10);waterpark._setLocation({slide:slide,lane:lane});e.preventDefault()},_onCustomShiftClick:function(e){var waterpark=e.data.waterpark;waterpark.__trigger("customShift");e.preventDefault()},_onBackClick:function(e){var $el=$(this);var waterpark=e.data.waterpark;var slide=waterpark.get("location").slide-1;waterpark._setLocation({slide:slide});e.preventDefault()}});SM.DialogView=SM.Views.deepExtend({__NAME:"dialog",__templateID:"dialog-template",__defaults:{isModal:false,isFixed:true,noOverlay:false,width:350,position:{my:"center",at:"center",collision:"none"},fixedPosition:null,easyClose:true,closeBtn:true},_hasShownOnce:false,__afterRender:function(){var title;this.$el.css("width",this.__settings.width);if(this.__settings.title){this.$el.attr("title",this.__settings.title)}title=this.$el.attr("title");if(title){this._addTitlebar(title);this.$el.removeAttr("title")}if(this.__settings.closeBtn){this._addCloseBtn()}if(this._hasShownOnce){this.$el.addClass("open");this.$el.removeClass("close")}else{this.$el.addClass("close");this.$el.removeClass("open")}},__onBeforeOpen:function(){var self=this;$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.on("click",".dialog-close-btn",{self:this},this._onCloseClick)},__onAfterOpen:function(){},__onBeforeClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.off("click",this._onCloseClick)},__onAfterClose:function(){},__onWindowResize:function(e){if(!this.__settings.noOverlay){this.position()}},open:function(options){if(this._isOpen){return this}if(options){SM.Object.update(this.__settings,options)}this.trigger("beforeOpen");this.__onBeforeOpen();this._open();return this},update:function(options){if(options.title){this._updateTitlebar(options.title)}},close:function(){var e=$.Event("beforeClose",{dialog:this});if(!this._isOpen){return this}this.trigger(e);if(e.isDefaultPrevented()){return this}this.__onBeforeClose();this._close();return this},position:function(){var position;if(!this.__settings.position.of){this.__settings.position.of=window}position=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this.$el.position(position);this.trigger("position")},isOpen:function(){return this._isOpen},_$overlay:null,_isOpen:false,_open:function(){var dialogContainer,overlay,self=this;dialogContainer=SM.Template.renderHTML("dialog-container-template");this._$dialogContainer=$(dialogContainer);this._$dialogContainer.appendTo(document.body);if(!this.__settings.noOverlay){overlay=SM.Template.renderHTML("dialog-overlay-template",{isModal:this.__settings.isModal});this._$overlay=$(overlay);if(this.$el.hasClass("dialog-b")){this._$overlay.addClass("dialog-overlay-b")}this._$overlay.appendTo(this._$dialogContainer);if(this.__settings.easyClose){this._$overlay.on("click",{self:this},self._onOverlayClick)}}else{this._$dialogContainer.addClass("no-overlay")}if(this.__settings.isModal&&this.__settings.isFixed){$("body").addClass("sm-fixed-dialog-modal")}this.$el.appendTo(this._$dialogContainer);setTimeout(function(){self._fadeIn()},0)},_close:function(){var self=this;if(this._$overlay){this._$overlay.removeClass("open")}this.$el.removeClass("open");this.$el.addClass("close");this._isOpen=false;this._hasShownOnce=false;if(this.__settings.isModal){$("body").removeClass("sm-fixed-dialog-modal")}setTimeout(function(){self._fadeOutComplete()},100)},_fadeIn:function(){if(this._$overlay){this._$overlay.addClass("open")}this.$el.addClass("open");this.$el.removeClass("close");if(this.__settings.isFixed&&!this.__settings.isModal){this.$el.closest(".dialog-container").addClass("fixed-dialog")}if(!this.__settings.noOverlay){this.position()}else if(this.__settings.fixedPosition){this._$dialogContainer.css(this.__settings.fixedPosition)}this._isOpen=true;this._hasShownOnce=true;this.trigger("afterOpen");this.__onAfterOpen()},_fadeOutComplete:function(){if(this._$overlay){this._$overlay.off("click");this._$overlay.remove();this._$overlay=null}this.$el.detach();this.trigger("afterClose");this._$dialogContainer.remove();this._$dialogContainer=null;
this.__onAfterClose()},_addCloseBtn:function(){var closeBtn,dialogTemplate=this.$el.hasClass("dialog-b")?"dialog-close-btn-template-b":"dialog-close-btn-template";closeBtn=SM.Template.renderHTML(dialogTemplate);this.$el.prepend(closeBtn)},_updateTitlebar:function(title){this.$el.find(".dialog-title-bar").replaceWith(SM.Template.renderHTML("dialog-title-bar-template",{title:title}))},_addTitlebar:function(title){var titleBar=SM.Template.renderHTML("dialog-title-bar-template",{title:title});this.$el.prepend(titleBar)},_onCloseClick:function(e){e.data.self.close();e.preventDefault()},_onOverlayClick:function(e){e.data.self.close()},_onResize:function(e,triggerSource){var self=e.data.self;self.__onWindowResize(e,triggerSource)},_onOpenKeydown:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self.close();e.preventDefault()}},_contains:function(el){return SM.DOM.contains(this.el,el)}});SM.BaseNotificationView=SM.Views.register({__NAME:"BaseNotificationView",__templateID:"notification-template",__defaults:{duration:5e3,expires:true,tabMessage:null},close:function(){this.notifications.close(this)},isInQueue:function(){this.notifications.isInQueue(this)}});SM.SuccessNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"SuccessNotificationView",__templateID:"status-notification-template",__defaults:{icon:"2"}});SM.ErrorNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"ErrorNotificationView",__templateID:"status-notification-template",__defaults:{icon:"!"}});SM.InfoNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"InfoNotificationView",__templateID:"status-notification-template",__defaults:{icon:"i"}});SM.Notifications={_queuedList:[],CLOSE_ANIMATION_TIME:700,OPEN_ANIMATION_TIME:700,error:function(options){var view=SM.Views.create(SM.ErrorNotificationView,options);this.init();view.$el.addClass("sm-notification-error");this.queue(view);return view},success:function(options){var view=SM.Views.create(SM.SuccessNotificationView,options);this.init();view.$el.addClass("sm-notification-success");this.queue(view);return view},info:function(options){var view=SM.Views.create(SM.InfoNotificationView,options);this.init();view.$el.addClass("sm-notification-info");this.queue(view);return view},template:function(options){var view=SM.Views.create(SM.BaseNotificationView,options);this.init();this.queue(view);return view},queue:function(notification){notification.$el.data("smnotification",notification);notification.notifications=this;this._queuedList.push(notification);if(this._isWindowFocused){this._processQueue()}else{this._startTitleMessager()}},init:function(){if(this._hasInit){return}this._originalTitle=document.title;this._titleChangeIntervalID=null;this._isWindowFocused=true;this.el=SM.Template.renderHTML("notifications-container-template");this.$el=$(this.el);$(document.body).append(this.el);$(window).on("focus.smnotification",{self:this},this._onWindowFocus).on("blur.smnotification",{self:this},this._onWindowBlur);this.$el.on("click","[notification-close-btn]",{self:this},this._onCloseClick);this._hasInit=true},close:function(notification){var $wrapper,index=this._getQueueIndex(notification),self=this;if(index!==-1){this._queuedList.splice(index,1);return}if(!notification.$el){return}$wrapper=notification.$el.parents(".sm-notification-wrapper");if(!$wrapper.length||$wrapper.hasClass("close")){return}$wrapper.css({height:$wrapper.height()});notification.set("isOpen",false);setTimeout(function(){$wrapper.addClass("close");setTimeout(function(){$wrapper.remove()},self.CLOSE_ANIMATION_TIME)},0)},open:function(notification){var self=this,wrapper=SM.Template.renderHTML("notification-wrapper-template"),$wrapper=$(wrapper);$wrapper.append(notification.el);this.$el.prepend($wrapper);$wrapper.css({marginTop:-1*$wrapper.outerHeight()-10});notification.set("isOpen",true);setTimeout(function(){$wrapper.addClass("open");if(notification.get("expires")){setTimeout(function(){self.close(notification)},self.OPEN_ANIMATION_TIME+notification.get("duration"))}},0)},isInQueue:function(notification){return this._getQueueIndex(notification)!==-1},_getQueueIndex:function(notification){var index=-1;$.each(this._queuedList,function(i,queued){if(notification.__uid===queued.__uid&&notification.__NAME===queued.__NAME){index=i;return false}});return index},_processQueue:function(){var self=this,notification;while(this._queuedList.length>0){notification=this._queuedList.shift();self.open(notification)}},_startTitleMessager:function(){var self=this,index=this._indexOfNextTabMessage(0);if(this._titleChangeIntervalID===null&&index!==-1){this._titleChangeIntervalID=setInterval(function(){if(index!==-1){document.title=self._queuedList[index].get("tabMessage");index=self._indexOfNextTabMessage(index+1)}else{document.title=self._originalTitle;index=self._indexOfNextTabMessage(0)}},2500)}},_stopTitleMessager:function(){if(this._titleChangeIntervalID){document.title=this._originalTitle;clearInterval(this._titleChangeIntervalID);this._titleChangeIntervalID=null}},_indexOfNextTabMessage:function(i){var len=this._queuedList.length;for(;i<len;i++){if(this._queuedList[i].get("tabMessage")){return i}}return-1},_onWindowFocus:function(e){var self=e.data.self;self._isWindowFocused=true;self._stopTitleMessager();self._processQueue()},_onWindowBlur:function(e){var self=e.data.self;self._isWindowFocused=false},_onCloseClick:function(e){var self=e.data.self,notification,$notification=$(this).parents(".sm-notification");e.preventDefault();if($notification.length){notification=$notification.data("smnotification");if(notification){self.close(notification)}}}};SM.Tooltips={init:function(options){this.enable(options)},enable:function(options){options=SM.Object.extend({selector:"[title]",delay:1500,fadeIn:false,fadeOut:false,fadeTime:250},options);if(!SM.Browser.isOldIE){$(document).on("mouseenter.smtooltips",options.selector,{self:this,delay:options.delay,fadeIn:options.fadeIn,fadeOut:options.fadeOut,fadeTime:options.fadeTime},this._onMouseenter)}},disable:function(selector){var tooltipSelector=selector?selector:"[title]";if(!SM.Browser.isOldIE){$(document).off("mouseenter.smtooltips",tooltipSelector)}},_onMouseenter:function(e){var self=e.data.self,delay=e.data.delay,fadeTime=e.data.fadeTime,fadeIn=e.data.fadeIn,fadeOut=e.data.fadeOut,$el=$(e.currentTarget),attrs;if(!$el.data("tooltip")){attrs=self._getAttrs($el);if(!attrs.text){return}$el.data("tooltip",attrs);$el.removeAttr("title");$el.on("click.smtooltips mouseleave.smtooltips remove.smtooltips",{self:self,fadeOut:fadeOut,fadeTime:fadeTime},self._destroy);setTimeout(function(){var tipData=$el.data("tooltip");if(tipData&&!tipData.isShown){self._showTipOn($el,fadeIn,fadeTime)}},delay)}},_destroy:function(e){var self=e.data.self,$el=$(this),fadeOut=e.data.fadeOut,fadeTime=e.data.fadeTime,tipData;tipData=$el.data("tooltip");if(!tipData){return}if(tipData.$el){if(fadeOut){tipData.$el.fadeOut(fadeTime,function(){tipData.$el.remove()})}else{tipData.$el.remove()}}$el.off("mouseleave.smtooltips");$el.off("remove.smtooltips");$el.off("click.smtooltips");$el.attr("title",tipData.text);$el.data("tooltip",null)},_showTipOn:function($el,fadeIn,fadeTime){var attrs=$el.data("tooltip"),position=SM.Object.copy(this._sides[attrs.side].position),$tip=this._build(attrs);attrs.$el=$tip;attrs.isShown=true;if(fadeIn){$tip.hide().appendTo(document.body).fadeIn(fadeTime)}else{document.body.appendChild($tip[0])}position.of=$el;$tip.position($.migrationFixPosition(position))},_build:function(attrs){var div=document.createElement("div"),classes="tool-tip ";classes+=this._sides[attrs.side].className;if(attrs.classes){classes+=" "+attrs.classes}div.className=classes;div.textContent=attrs.text;return $(div)},_sides:{left:{className:"tool-tip-left",position:{my:"right center",at:"left center",offset:"-5 0",collision:"none"}},right:{className:"tool-tip-right",position:{my:"left center",at:"right center",offset:"5 0",collision:"none"}},top:{className:"tool-tip-top",position:{my:"center bottom",at:"center top",offset:"0 -5",collision:"none"}},bottom:{className:"tool-tip-bottom",position:{my:"center top",at:"center bottom",offset:"0 5",collision:"none"}}},_getAttrs:function($el){return{text:$el.attr("title"),side:$el.attr("sm-tooltip-side")||"top",classes:$el.attr("sm-tooltip-classes")}}};SM.BaseMenuView=SM.Views.register({__NAME:"baseMenuView",__templateID:"base-menu-template"});SM.OptionMenuView=SM.Object.deepExtend({__init:function(){this.bind("focusin",".option",this._onFocusIn).bind("mouseenter",".option",this._onOptionMouseEnter).bind("mouseleave",this._onMouseLeave)},__setters:{currentIndex:function(self,index){self._$options.removeClass("current");self._$options.parent().removeClass("current");if(index===-1){self._$currentOption=null}else{self._$currentOption=self._$options.eq(index).addClass("current");self._$currentOption.parent().addClass("current")}self._currentIndex=index;self.focusOption(self._currentIndex)},selectedIndex:function(self,index){self._setSelectedIndex(index)}},__getters:{currentIndex:function(self,val){return self._currentIndex}},nextCurrent:function(){var currentIndex=this._currentIndex;if(currentIndex<this._optionCount-1){this.set("currentIndex",currentIndex+1);this.scrollToItem(this._currentIndex)}},prevCurrent:function(){var currentIndex=this._currentIndex;if(currentIndex>0){this.set("currentIndex",currentIndex-1);this.scrollToItem(this._currentIndex)}},selectCurrent:function(){if(this._$currentOption){this._$currentOption.click()}},_$selectedOption:undefined,_$currentOption:undefined,_$options:undefined,_currentIndex:-1,_selectedIndex:-1,_optionCount:0,_refreshOptionData:function(){this._$options=this.$el.find(".option").not(".disabled");this._optionCount=this._$options.length;return this},_setSelectedIndex:function(index){this._$options.removeClass("selected");if(index>=0&&index<this._optionCount){this._$selectedOption=this._$options.eq(index).addClass("selected")}else{this._$selectedOption=undefined}this._selectedIndex=index;return this},scrollToItem:function(index){var menu=this.el,option=this._$options.eq(index).parent()[0];if(menu.scrollHeight<=menu.offsetHeight){return}if(option.offsetTop<menu.scrollTop){menu.scrollTop=option.offsetTop}else if(option.offsetTop+option.offsetHeight>menu.scrollTop+menu.clientHeight){menu.scrollTop=option.offsetTop+option.offsetHeight-menu.clientHeight}return this},focusOption:function(index){var $optionEl=this._$options.eq(index);$optionEl.focus()},_onOptionMouseEnter:function(e){var self=e.data.self,$option=$(this);if($option.hasClass("disabled")){return}self.set("currentIndex",self._$options.index($option))},_onFocusIn:function(e){e.stopPropagation()},_onMouseLeave:function(e){var self=e.data.self;self.set("currentIndex",-1)}});SM.ActionMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"actionMenuView",__templateID:"action-menu-template",__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick)},__afterRender:function(){this._refreshOptionData();if(this.__settings.saveState){if(this.__settings.selectedAction){this._setSelectedAction(this.__settings.selectedAction,true)}else{this._setSelectedIndex(-1,true)}}},__setters:{selectedAction:function(self,action){self._setSelectedAction(action,false)},selectedIndex:function(self,index){self._setSelectedIndex(index,false)},actions:function(self,actions){self.__settings.actions=actions;self.render()}},hasAction:function(action){return this.$el.find('[data-action="'+action+'"]').length>0},actionHasSubMenu:function(action){var submenu=this._getActionSubmenu(action);return submenu&&submenu.actions&&submenu.actions.length},openSelectedSubmenu:function(){var self=this,$anchor,selectedAction=this.__settings.selectedAction,submenu=this._getActionSubmenu(selectedAction),actionSubmenu;if(submenu&&submenu.actions&&submenu.actions.length){$anchor=this.$el.find('[data-action="'+selectedAction+'"]');actionSubmenu=$anchor.data("actionMenu");if(!actionSubmenu){submenu=$.extend({parentMenu:self},submenu);$anchor.actionMenu(submenu).on("actionMenu.beforeOpen",function(e){self.trigger({type:"beforeSubmenuOpen",actionSubmenu:actionSubmenu})}).on("actionMenu.afterOpen",function(e){self.trigger({type:"submenuOpened",actionSubmenu:actionSubmenu})}).on("actionMenu.actionSelected",function(e){self.trigger({type:"actionSelected",action:e.action,$action:e.$action})}).on("actionMenu.afterClose",function(){self.trigger("submenuClosed")});actionSubmenu=$anchor.data("actionMenu")}actionSubmenu.open()}},_getActionSubmenu:function(action){var actions=this.__settings.actions||[],i;for(i=0;i<actions.length;i++){if(actions[i].action===action){return actions[i].submenu}}return null},_setSelectedAction:function(action,silent){var index=-1,$action=this.$el.find('[data-action="'+action+'"]');if($action.length){index=this._$options.index($action)}if(this.__settings.saveState){this._setSelectedIndex(index,silent)}this.__settings.selectedAction=action;if(!silent&&!(index>=0&&this.__settings.saveState)&&!this.actionHasSubMenu(action)){this.trigger({type:"actionSelected",action:action,$action:$action})}},_setSelectedIndex:function(index,silent){var $action;if(this.__settings.saveState){SM.OptionMenuView._setSelectedIndex.call(this,index)}if(index>=0&&index<this._optionCount){$action=this._$options.eq(index);this.__settings.selectedAction=$action.attr("data-action");if(!silent){this.trigger({type:"actionSelected",action:$action.attr("data-action"),$action:$action})}}},_onOptionClick:function(e){var self=e.data.self,$option=$(this),split,href=$option.attr("href"),action=$option.attr("data-action");if(href){split=href.split("#");if(split.length<2){if($option.hasClass("disabled")){e.preventDefault();e.stopPropagation()}else{self.trigger("optionClicked")}return}}e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return}self.set("selectedAction",action);if(self.actionHasSubMenu(action)){self.openSelectedSubmenu()}else{self.trigger("optionClicked")}}});SM.SelectMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"SelectMenuView",__templateID:"select-menu-template",__create:function(){if(this.__settings.loadPage){this._loadedOptions=[]}if(this.__settings.loadSearchPage){this._loadedSearchOptions=[]}},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click keydown",".option",this._onOptionClick);this.bind("focus",".option",this._onOptionFocus);this.bind("click keydown","[data-pageaction]",this._onPagingClick);this.bind("keydown",".search-bar",this._onSearchSubmit);this.bind("click keydown",".search-button",this._onSearchSubmit);this.bind("click keydown",".clear-search",this._onClearSearch)},__afterRender:function(){this._renderMenu()},__setters:{selectedValue:function(self,value){var index=self._getIndexByValue(value),displayText;if(index!==-1){self._setSelectedIndex(index);self.__settings.selectedValue=value;displayText=self._getText(value);self.trigger({type:"change",value:value,displayText:displayText})}},selectedIndex:function(self,index){var value,displayText;if(index>=0&&index<self._optionCount){self._setSelectedIndex(index);self.__settings.selectedValue=self._getValueByIndex(index);displayText=self._getText(self.__settings.selectedValue);self.trigger({type:"change",value:self.__settings.selectedValue,displayText:displayText})}},options:function(self,options){self.__settings.options=options;self.render()}},__getters:{selectedValue:function(self){return self.__settings.selectedValue},valueText:function(self){var value=self.__settings.selectedValue;return self._getText(value)}},VALUE_ATTR:"data-opt-value",inlineSearchOptionsWithSelect:function(searchTerm,shouldSelect){var optionsText=this._optionsText,optionsLen=optionsText.length,searchTermLen=searchTerm.length,startIndex=shouldSelect?this._selectedIndex:this._currentIndex,i;if(!(this.__settings.options||this._isLoaded)){return-1}if(searchTermLen>1){i=startIndex}else{if(startIndex===-1){i=0}else{i=startIndex+1}}for(i;i<optionsLen;i++){if(optionsText[i].substr(0,searchTermLen)===searchTerm){return i}}for(i=0;i<=startIndex;i++){if(optionsText[i].substr(0,searchTermLen)===searchTerm){return i}}return-1},prepareMenuLoad:function(){var shouldLoadDynamicPage=this.__settings.loadPage!==undefined;if(shouldLoadDynamicPage){this._loadDynamicPageWithSearch(1,false)}this.scrollToItem(this._selectedIndex);this._focusMenu()},nextSelect:function(){var selectedIndex=this._selectedIndex;if(selectedIndex<this._optionCount-1){this.set("selectedIndex",selectedIndex+1);this.scrollToItem(this._selectedIndex)}},prevSelect:function(){var selectedIndex=this._selectedIndex;if(selectedIndex>0){this.set("selectedIndex",selectedIndex-1);this.scrollToItem(this._selectedIndex)}},_currentIndex:0,_optionsText:undefined,_firstNumOnPage:1,_firstNumOnSearchPage:1,_searchString:null,_showSearchResults:false,_prepopulatedSearchResults:null,_isLoaded:false,_loadedOptions:null,_totalLoadedOptions:0,_loadedSearchOptions:null,_totalLoadedSearchOptions:0,_renderMenu:function(){var populatedOptions=this.__settings.options,numOptionsPerPage=this.__settings.numOptionsPerPage,isPrepopulated=populatedOptions!==undefined,paginationEnabled=this.__settings.paginationEnabled,searchEnabled=this.__settings.searchEnabled,showSearchResults=this._showSearchResults,firstNumOnPage=showSearchResults?this._firstNumOnSearchPage:this._firstNumOnPage,selectedValue=this.get("selectedValue"),currentPage,pageIndex,optionsToShow,numTotalOptions,showPagination,showSearch,isFirstPage,isLastPage,lastNumOnPage,lastPageFirstNum,$selectedOption,menuHtml="";if(!isPrepopulated){currentPage=this._calculateCurrentPageNum(firstNumOnPage);if(this._isDynamicPageLoadedWithSearch(currentPage,showSearchResults)){pageIndex=currentPage-1;optionsToShow=showSearchResults?this._loadedSearchOptions[pageIndex]:this._loadedOptions[pageIndex];numTotalOptions=showSearchResults?this._totalLoadedSearchOptions:this._totalLoadedOptions}}else{if(showSearchResults){optionsToShow=this._prepopulatedSearchResults}else{optionsToShow=populatedOptions}numTotalOptions=optionsToShow.length}showPagination=paginationEnabled&&numTotalOptions>numOptionsPerPage;if(paginationEnabled){showSearch=showSearchResults||searchEnabled&&showPagination}else{showSearch=searchEnabled}if(showSearch){menuHtml+=SM.Template.render("select-search-template",{searchPlaceholderText:this.__settings.searchPlaceholderText,searchString:this._searchString})}if(optionsToShow&&optionsToShow.length>0){if(showPagination){lastNumOnPage=Math.min(firstNumOnPage+numOptionsPerPage-1,numTotalOptions);if(isPrepopulated){optionsToShow=optionsToShow.slice(firstNumOnPage-1,lastNumOnPage)}menuHtml+=SM.Template.render("select-options-template",optionsToShow);isFirstPage=firstNumOnPage===1;lastPageFirstNum=this._calculateLastPageFirstNum(numTotalOptions,numOptionsPerPage);isLastPage=firstNumOnPage===lastPageFirstNum;menuHtml+=SM.Template.render("select-pagination-template",{firstNumOnPage:firstNumOnPage,lastNumOnPage:lastNumOnPage,totalOptions:numTotalOptions,isFirstPage:isFirstPage,isLastPage:isLastPage})}else{menuHtml+=SM.Template.render("select-options-template",optionsToShow)}this.trigger("onOptionsLoaded")}else if(!isPrepopulated&&!this._isLoaded){menuHtml+=$("#select-options-loading").html()}else if(showSearchResults){menuHtml+=$("#select-search-none").html();this.trigger("onOptionsLoaded")}this.$el.html(menuHtml);$selectedOption=this.$el.find(".selected").last();this._refreshOptionData();this._collectOptionsText();if(selectedValue){this._getOptionByValue(selectedValue).addClass("selected")}else if($selectedOption.length>0){this.set("selectedValue",$selectedOption.attr("data-opt-value"))}this._focusMenu()},_focusMenu:function(){var $searchBar=this.$el.find('[name="searchTerm"]'),selectedValue=this.get("selectedValue"),$selectedOption;if($searchBar.length>0){$searchBar.focus()}else{$selectedOption=this._getOptionByValue(selectedValue);if(selectedValue&&$selectedOption.length>0){$selectedOption.focus()}else{this.$el.find(".option").first().focus()}}},_refreshOptionData:function(){this._$options=this.$el.find(".option");this._optionCount=this._$options.length},_collectOptionsText:function(){this._optionsText=this._$options.map(function(){return $.trim($(this).text().toLowerCase())}).get()},_getText:function(value){return $.trim(this._getOptionByValue(value).text())},_getOptionByValue:function(value){return this.$el.find("["+this.VALUE_ATTR+'="'+value+'"]')},_getIndexByValue:function(value){var $option=this._getOptionByValue(value);return this._$options.index($option)},_getValueByIndex:function(index){var $option;if(index===-1){return}$option=this._$options.eq(index);return $option.attr(this.VALUE_ATTR)},_loadDynamicPageWithSearch:function(pageNum,isSearch,searchTerm){var self=this,pageIndex=pageNum-1,limit=this.__settings.numOptionsPerPage,offset=limit*pageIndex+1;if(this._isDynamicPageLoadedWithSearch(pageNum,isSearch)){return}if(isSearch){this.__settings.loadSearchPage(offset,limit,searchTerm).done(function(data){self._isLoaded=true;self._totalLoadedSearchOptions=data.totalOptions;self._loadedSearchOptions[pageIndex]=data.options;self._renderMenu()})}else{this.__settings.loadPage(offset,limit).done(function(data){self._isLoaded=true;self._totalLoadedOptions=data.totalOptions;self._loadedOptions[pageIndex]=data.options;self._renderMenu()})}},_onMouseLeave:function(e){return},_onSearchSubmit:function(e){var self=e.data.self,$triggeringEl=$(this),loadOptions=self.__settings.loadSearchPage!==undefined,newSearchString=$.trim(self.$el.find('[name="searchTerm"]').val()),pageToLoad;if($triggeringEl.hasClass("search-button")){if(!SM.A11y.checkClick(e)){return}e.stopPropagation()}else if($triggeringEl.hasClass("search-bar")){if(!SM.A11y.checkSubmit(e)){return}}if(newSearchString.length===0||newSearchString===self._searchString){return}else{self._firstNumOnSearchPage=1}self._showSearchResults=true;self._searchString=newSearchString;self.$el.find(".clear-search").removeClass("hide");if(loadOptions){self._loadedSearchOptions=[];self._totalLoadedSearchOptions=0;pageToLoad=self._calculateCurrentPageNum(self._firstNumOnSearchPage);self._loadDynamicPageWithSearch(pageToLoad,true,self._searchString)}else{self._prepopulatedSearchResults=self._searchOptions(self.__settings.options,self._searchString);if(self._prepopulatedSearchResults.length===0){self._firstNumOnSearchPage=0}}self._renderMenu()},_onClearSearch:function(e){var self=e.data.self,$clearBtn=self.$el.find(".clear-search");if(!SM.A11y.checkClick(e)){return}e.preventDefault();e.stopPropagation();$clearBtn.addClass("hide");self._prepopulatedSearchResults=null;self._loadedSearchOptions=[];self._totalLoadedSearchOptions=0;self._searchString=null;self._showSearchResults=false;self._firstNumOnSearchPage=1;self._renderMenu()},_onOptionClick:function(e){var self=e.data.self,$option=$(this);if(!SM.A11y.checkClick(e)){return}e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return}self.set("selectedIndex",self._$options.index($option))},_onPagingClick:function(e){var self=e.data.self,loadOptions=self.__settings.loadPage!==undefined,$pageBtn=$(this),pagingAction=$pageBtn.data("pageaction"),numOptionsPerPage=self.__settings.numOptionsPerPage,numTotalOptions,firstNumOnPage=self._showSearchResults?self._firstNumOnSearchPage:self._firstNumOnPage,pageToLoad;if(!SM.A11y.checkClick(e)){return}e.stopPropagation();if(self._showSearchResults){numTotalOptions=loadOptions?self._totalLoadedSearchOptions:self._prepopulatedSearchResults.length}else{numTotalOptions=loadOptions?self._totalLoadedOptions:self.__settings.options.length}switch(pagingAction){case"first":firstNumOnPage=1;break;case"previous":firstNumOnPage-=numOptionsPerPage;break;case"next":firstNumOnPage+=numOptionsPerPage;break;case"last":firstNumOnPage=self._calculateLastPageFirstNum(numTotalOptions,numOptionsPerPage);break;default:return}if(self._showSearchResults){self._firstNumOnSearchPage=firstNumOnPage}else{self._firstNumOnPage=firstNumOnPage}self._renderMenu();if(loadOptions){pageToLoad=self._calculateCurrentPageNum(firstNumOnPage);self._loadDynamicPageWithSearch(pageToLoad,self._showSearchResults,self._searchString)}},_onOptionFocus:function(e){var $optionEl=$(this),self=e.data.self,index=$optionEl.closest("li").index();e.stopPropagation();if(!$optionEl.hasClass("current")){self.set("currentIndex",index)}},_calculateLastPageFirstNum:function(totalNumOptions,numOptionsPerPage){var numPages=Math.ceil(totalNumOptions/numOptionsPerPage);if(totalNumOptions===0){return 0}return(numPages-1)*numOptionsPerPage+1},_searchOptions:function(options,searchString){return $.map(options,function(option,index){var lowerOptionString=option.text.toLowerCase(),lowerTerm=searchString.toLowerCase();if(lowerOptionString.indexOf(lowerTerm)!==-1){return option}})},_isDynamicPageLoadedWithSearch:function(pageNum,isSearch){var options,numOptionPages,desiredPage,pageIndex=pageNum-1;if(isSearch){options=this._loadedSearchOptions}else{options=this._loadedOptions}numOptionPages=options.length;if(numOptionPages>0&&numOptionPages>=pageNum){loadedPage=options[pageIndex];if(loadedPage!==undefined){this._isLoaded=true;return true}}this._isLoaded=false;return false},_calculateCurrentPageNum:function(firstNumOnPage){var numOptionsPerPage=this.__settings.numOptionsPerPage;return Math.ceil(firstNumOnPage/numOptionsPerPage)}});SM.CalendarMenuView=SM.Views.register({__NAME:"calendarMenuView",__templateID:"calendar-menu-template",__init:function(){this.bind("click",".nextBtn",this._onNextMonthClick).bind("click",".prevBtn",this._onPrevMonthClick).bind("click","td.day:not(.out-of-range)",this._onDayClick);if(this.__settings.selectMenus){this.bind("selectMenu.change",".yearSelect",this._onSelectYearChange).bind("selectMenu.change",".monthSelect",this._onSelectMonthChange)}},__beforeRender:function(){var weekdays=this._buildDayHeaders(),calendarData=this.__settings,displayDate,minDate,maxDate,selectedDate,currentDate,isPrevBtnDisabled,isNextBtnDisabled,culture=Globalize.culture(),monthName,weeks;displayDate=SM.Date.getSimpleDate(this._displayDate);minDate=SM.Date.getSimpleDate(calendarData.minDate);maxDate=SM.Date.getSimpleDate(calendarData.maxDate);selectedDate=SM.Date.getSimpleDate(calendarData.selectedDate);currentDate=SM.Date.getSimpleDate(this._currentDate);isPrevBtnDisabled=displayDate.year<=minDate.year&&displayDate.month<=minDate.month;isNextBtnDisabled=displayDate.year>=maxDate.year&&displayDate.month>=maxDate.month;monthName=culture.calendars.standard.months.names[displayDate.month],weeks=this._buildDays(displayDate,minDate,maxDate,selectedDate,currentDate);return{weekdays:weekdays,monthName:monthName,displayDate:displayDate,minDate:minDate,maxDate:maxDate,currentDate:currentDate,selectedDate:selectedDate,isPrevBtnDisabled:isPrevBtnDisabled,isNextBtnDisabled:isNextBtnDisabled,selectMenus:calendarData.selectMenus,weeks:weeks,yearFirst:culture.calendar.yearFirst}},__afterRender:function(md){var minMonth,maxMonth;if(this.__settings.selectMenus){this.$el.find(".yearSelect").selectMenu({menuView:"YearSelectMenuView",selectWidth:"auto",selectedValue:md.displayDate.year,minYear:md.minDate.year,maxYear:md.maxDate.year});minMonth=0;maxMonth=11;if(md.minDate.year&&md.displayDate.year===md.minDate.year){minMonth=md.minDate.month}if(md.maxDate.year&&md.displayDate.year===md.maxDate.year){maxMonth=md.maxDate.month}this.$el.find(".monthSelect").selectMenu({menuView:"MonthSelectMenuView",selectWidth:"auto",selectedValue:md.displayDate.month,minMonth:minMonth,maxMonth:maxMonth})}},resetDisplayDate:function(settings){var simpleDate,calendarData=this.__settings=settings;this._currentDate=new Date;if(calendarData.selectedDate){simpleDate=SM.Date.getSimpleDate(calendarData.selectedDate)}else if(calendarData.minDate&&this._currentDate<calendarData.minDate){simpleDate=SM.Date.getSimpleDate(calendarData.minDate)}else if(calendarData.maxDate&&this._currentDate>calendarData.maxDate){simpleDate=SM.Date.getSimpleDate(calendarData.maxDate)}else{simpleDate=SM.Date.getSimpleDate(this._currentDate)}this._displayDate=new Date(simpleDate.year,simpleDate.month,1)},_setDisplayDate:function(year,month){var date=new Date(year,month,1);this._currentDate=new Date;this._displayDate=date},_buildDayHeaders:function(){var culture=Globalize.culture(),calendar=culture.calendars.standard,i=calendar.firstDay,days=calendar.days.names,shortDays=calendar.days.namesShort,normalizedIndex,weekdays=[],dayCount=7;while(dayCount){normalizedIndex=i<7?i:i-7;weekdays.push({name:days[normalizedIndex],shortName:shortDays[normalizedIndex]});dayCount--;i++}return weekdays},_buildDays:function(displayDate,minDate,maxDate,selectedDate,currentDate){var daysBuilt=0,i,day,dayNumber,selectedMonth=selectedDate.month,selectedYear=selectedDate.year,selectedDay=selectedDate.day,currentMonth=currentDate.month,currentYear=currentDate.year,currentDay=currentDate.day,minMonth=minDate.month,minYear=minDate.year,minDay=minDate.day,maxDay=maxDate.day,maxMonth=maxDate.month,maxYear=maxDate.year,weeks=[],days,displayMonth=displayDate.month,displayYear=displayDate.year,firstDayIndex=Globalize.getWeekdayIndexOfFirstDay(displayMonth,displayYear),daysInMonth=SM.Date.getDaysInMonth(displayMonth,displayYear),isMinMonth=minMonth===displayMonth&&minYear===displayYear,isMaxMonth=maxMonth===displayMonth&&maxYear===displayYear,isSelectedMonth=selectedMonth===displayMonth&&selectedYear===displayYear,isCurrentMonth=currentMonth===displayMonth&&currentYear===displayYear,daysToBeBuilt=7*Math.ceil((daysInMonth+firstDayIndex)/7);while(daysBuilt<daysToBeBuilt){days=[];for(i=0;i<7;i++){dayNumber=daysBuilt-firstDayIndex+1;if(daysBuilt<firstDayIndex||dayNumber>daysInMonth){day={isBlank:true,isFirstEnd:dayNumber===daysInMonth+1}}else{day={number:dayNumber,isLast:dayNumber===daysInMonth,isSelected:isSelectedMonth&&selectedDay===dayNumber,isToday:isCurrentMonth&&currentDay===dayNumber,isOutOfRange:isMinMonth&&daysBuilt>=firstDayIndex&&dayNumber<minDay||isMaxMonth&&dayNumber>maxDay&&dayNumber<=daysInMonth}}days.push(day);++daysBuilt}weeks.push(days)}return weeks},_onPrevMonthClick:function(e){var self=e.data.self,displayDate=SM.Date.getSimpleDate(self._displayDate),$elem=$(this);e.preventDefault();e.stopPropagation();if(!$elem.hasClass("disabled")){self._setDisplayDate(displayDate.year,displayDate.month-1);self.render()}},_onNextMonthClick:function(e){var self=e.data.self,$elem=$(this),displayDate=SM.Date.getSimpleDate(self._displayDate);e.preventDefault();e.stopPropagation();if(!$elem.hasClass("disabled")){self._setDisplayDate(displayDate.year,displayDate.month+1);self.render()}},_onSelectYearChange:function(e){var self=e.data.self,month,year,calendarData=self.__settings,minDate=SM.Date.getSimpleDate(calendarData.minDate),maxDate=SM.Date.getSimpleDate(calendarData.maxDate),displayDate=SM.Date.getSimpleDate(self._displayDate);year=parseInt(e.value,10);month=displayDate.month;if(minDate.year&&year===minDate.year&&minDate.month>displayDate.month){month=minDate.month}if(maxDate.year&&year===maxDate.year&&maxDate.month<displayDate.month){month=maxDate.month}self._setDisplayDate(year,month);self.render()},_onSelectMonthChange:function(e){var self=e.data.self,displayDate=SM.Date.getSimpleDate(self._displayDate);self._setDisplayDate(displayDate.year,parseInt(e.value,10));self.render()},_onDayClick:function(e){var self=e.data.self,$day=$(e.currentTarget),day=parseInt($day.attr("data-day"),10),displayDate=SM.Date.getSimpleDate(self._displayDate);self.trigger({type:"dateSelected",date:new Date(displayDate.year,displayDate.month,day)})}});SM.AutocompleteMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"AutocompleteMenuView",__templateID:"autocomplete-menu-template",__defaults:{results:[]},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick)},__afterRender:function(){this._refreshOptionData()},__setters:{results:function(self,results){self.__settings.results=results;
self.render();self.set("currentIndex",-1)}},_onOptionClick:function(e){var self=e.data.self,$option=$(this);e.preventDefault();e.stopPropagation();if($option.hasClass("disabled")){return}self.trigger({type:"selected",text:$option.text(),value:$option.attr("data-value")})}});SM.YearSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"years-select-menu-template",__NAME:"yearSelectMenuView",__defaults:{maxYear:null,minYear:null},__beforeRender:function(){var maxYear=this.__settings.maxYear?this.__settings.maxYear:(new Date).getFullYear(),selectedYear=this.__settings.selectedValue,minYear=this.__settings.minYear,years=[],year=maxYear;for(;year>=minYear;year--){years.push({text:year,value:year,selected:year===selectedYear})}this.__settings.options=years;return this.__settings}});SM.MonthSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"month-select-menu-template",__NAME:"monthSelectMenuView",__defaults:{maxMonth:11,minMonth:0},__beforeRender:function(){var maxMonth=this.__settings.maxMonth,selectedMonth=this.__settings.selectedValue,months=[],culture=Globalize.culture(),monthNamesShort=culture.calendars.standard.months.namesAbbr,month=this.__settings.minMonth;for(;month<=maxMonth;month++){months.push({value:month,text:monthNamesShort[month],selected:month===selectedMonth})}this.__settings.options=months;return this.__settings}});SM.HourSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"hour-select-menu-template",__NAME:"hourSelectMenuView",__defaults:{militaryTime:false},__beforeRender:function(){var i=0,selectedHours=this.__settings.selectedValue,hours=[],culture=Globalize.getSmartlingCulture(),headerText=culture==="en"?"HH":Globalize.cultures[culture].calendar.timeAbbr.h,len;hours.push({value:"-1",text:headerText});if(this.__settings.militaryTime){len=23}else{len=11;i=1;hours.push({value:12,text:"12",selected:0===selectedHours})}while(i<=len){hours.push({value:i,text:i<10?"0"+i:i,selected:selectedHours===i});i++}this.__settings.options=hours;return this.__settings}});SM.MinuteSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"minute-select-menu-template",__NAME:"minuteSelectMenuView",__defaults:{increment:15},__beforeRender:function(){var len=60,increment=this.__settings.increment,selectedMinutes=this.__settings.selectedValue,minutes=[],culture=Globalize.getSmartlingCulture(),headerText=culture==="en"?"MM":Globalize.cultures[culture].calendar.timeAbbr.m,i=0;minutes.push({value:"-1",text:headerText});for(;i<len;i+=increment){minutes.push({value:i,text:i<10?"0"+i:i,selected:selectedMinutes===i})}this.__settings.options=minutes;return this.__settings}});$.extend(SM.Object,{getOneKey:function(obj){var key;_.find(obj,function(val,id){key=id;return true});return key},getOnlyKey:function(obj){var key,i=-1;_.each(obj,function(val,id){++i;if(i>0){throw new Error("getOnlyKey() called on object with more than one key")}key=id});return key}});$.extend(SM.String,{NON_BREAKING_HYPHEN:SM.Html.parse("&#8209;")[0].nodeValue,NOT_AVAILABLE:"Not Available",containsWordBoundary:function(str){return $.trim(str).length!==0},truncateMiddle:function(fullStr,strLen,separator){var charsToShow;if(fullStr.length<=strLen){return fullStr}separator=separator||"...";charsToShow=(strLen-separator.length)/2;return fullStr.substr(0,Math.ceil(charsToShow))+separator+fullStr.substr(fullStr.length-Math.floor(charsToShow))},localizeIfNotAvailable:function(text){return text===SM.String.NOT_AVAILABLE?Globalize.localize(SM.String.NOT_AVAILABLE):text},textTitle:function(title){var $titleDummy=$("<div></div>");$titleDummy.html(title);return $titleDummy.text()},htmlStrip:function(html){return $("<p>"+_.escape(html)+"</p>").text()},text:function(html){return html?$("<p>"+html+"</p>").text():html},formatNumber:function(value,isPercent,precision){var formatType=(isPercent?"p":"n")+(precision||0);return Globalize.format(value,formatType)}});(function(factory){"use strict";var root=typeof window==="undefined"?null:window;if(typeof define==="function"&&define.amd){define(function(){return factory(root)})}else if(typeof module!=="undefined"){module.exports=factory(root)}else{root.DOMPurify=factory(root)}})(function factory(window){"use strict";var DOMPurify=function(window){return factory(window)};DOMPurify.version="0.8.3";DOMPurify.removed=[];if(!window||!window.document||window.document.nodeType!==9){DOMPurify.isSupported=false;return DOMPurify}var document=window.document;var originalDocument=document;var DocumentFragment=window.DocumentFragment;var HTMLTemplateElement=window.HTMLTemplateElement;var NodeFilter=window.NodeFilter;var NamedNodeMap=window.NamedNodeMap||window.MozNamedAttrMap;var Text=window.Text;var Comment=window.Comment;var DOMParser=window.DOMParser;if(typeof HTMLTemplateElement==="function"){var template=document.createElement("template");if(template.content&&template.content.ownerDocument){document=template.content.ownerDocument}}var implementation=document.implementation;var createNodeIterator=document.createNodeIterator;var getElementsByTagName=document.getElementsByTagName;var createDocumentFragment=document.createDocumentFragment;var importNode=originalDocument.importNode;var hooks={};DOMPurify.isSupported=typeof implementation.createHTMLDocument!=="undefined"&&document.documentMode!==9;var _addToSet=function(set,array){var l=array.length;while(l--){if(typeof array[l]==="string"){array[l]=array[l].toLowerCase()}set[array[l]]=true}return set};var _cloneObj=function(object){var newObject={};var property;for(property in object){if(object.hasOwnProperty(property)){newObject[property]=object[property]}}return newObject};var ALLOWED_TAGS=null;var DEFAULT_ALLOWED_TAGS=_addToSet({},["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr","svg","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","switch","symbol","text","textpath","title","tref","tspan","view","vkern","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feMerge","feMergeNode","feMorphology","feOffset","feSpecularLighting","feTile","feTurbulence","math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmuliscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mpspace","msqrt","mystyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","#text"]);var ALLOWED_ATTR=null;var DEFAULT_ALLOWED_ATTR=_addToSet({},["accept","action","align","alt","autocomplete","background","bgcolor","border","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","coords","datetime","default","dir","disabled","download","enctype","face","for","headers","height","hidden","high","href","hreflang","id","ismap","label","lang","list","loop","low","max","maxlength","media","method","min","multiple","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","rows","rowspan","spellcheck","scope","selected","shape","size","span","srclang","start","src","step","style","summary","tabindex","title","type","usemap","valign","value","width","xmlns","accent-height","accumulate","additivive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","clip","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mode","min","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","surfacescale","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","u1","u2","unicode","values","viewbox","visibility","vert-adv-y","vert-origin-x","vert-origin-y","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","y","y1","y2","z","zoomandpan","accent","accentunder","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","display","displaystyle","fence","frame","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]);var FORBID_TAGS=null;var FORBID_ATTR=null;var ALLOW_DATA_ATTR=true;var ALLOW_UNKNOWN_PROTOCOLS=false;var SAFE_FOR_JQUERY=false;var SAFE_FOR_TEMPLATES=false;var MUSTACHE_EXPR=/\{\{[\s\S]*|[\s\S]*\}\}/gm;var ERB_EXPR=/<%[\s\S]*|[\s\S]*%>/gm;var WHOLE_DOCUMENT=false;var RETURN_DOM=false;var RETURN_DOM_FRAGMENT=false;var RETURN_DOM_IMPORT=false;var SANITIZE_DOM=true;var KEEP_CONTENT=true;var FORBID_CONTENTS=_addToSet({},["audio","head","math","script","style","svg","video"]);var DATA_URI_TAGS=_addToSet({},["audio","video","img","source"]);var URI_SAFE_ATTRIBUTES=_addToSet({},["alt","class","for","id","label","name","pattern","placeholder","summary","title","value","style","xmlns"]);var CONFIG=null;var formElement=document.createElement("form");var _parseConfig=function(cfg){if(typeof cfg!=="object"){cfg={}}ALLOWED_TAGS="ALLOWED_TAGS"in cfg?_addToSet({},cfg.ALLOWED_TAGS):DEFAULT_ALLOWED_TAGS;ALLOWED_ATTR="ALLOWED_ATTR"in cfg?_addToSet({},cfg.ALLOWED_ATTR):DEFAULT_ALLOWED_ATTR;FORBID_TAGS="FORBID_TAGS"in cfg?_addToSet({},cfg.FORBID_TAGS):{};FORBID_ATTR="FORBID_ATTR"in cfg?_addToSet({},cfg.FORBID_ATTR):{};ALLOW_DATA_ATTR=cfg.ALLOW_DATA_ATTR!==false;ALLOW_UNKNOWN_PROTOCOLS=cfg.ALLOW_UNKNOWN_PROTOCOLS||false;SAFE_FOR_JQUERY=cfg.SAFE_FOR_JQUERY||false;SAFE_FOR_TEMPLATES=cfg.SAFE_FOR_TEMPLATES||false;WHOLE_DOCUMENT=cfg.WHOLE_DOCUMENT||false;RETURN_DOM=cfg.RETURN_DOM||false;RETURN_DOM_FRAGMENT=cfg.RETURN_DOM_FRAGMENT||false;RETURN_DOM_IMPORT=cfg.RETURN_DOM_IMPORT||false;SANITIZE_DOM=cfg.SANITIZE_DOM!==false;KEEP_CONTENT=cfg.KEEP_CONTENT!==false;if(SAFE_FOR_TEMPLATES){ALLOW_DATA_ATTR=false}if(RETURN_DOM_FRAGMENT){RETURN_DOM=true}if(cfg.ADD_TAGS){if(ALLOWED_TAGS===DEFAULT_ALLOWED_TAGS){ALLOWED_TAGS=_cloneObj(ALLOWED_TAGS)}_addToSet(ALLOWED_TAGS,cfg.ADD_TAGS)}if(cfg.ADD_ATTR){if(ALLOWED_ATTR===DEFAULT_ALLOWED_ATTR){ALLOWED_ATTR=_cloneObj(ALLOWED_ATTR)}_addToSet(ALLOWED_ATTR,cfg.ADD_ATTR)}if(KEEP_CONTENT){ALLOWED_TAGS["#text"]=true}if(Object&&"freeze"in Object){Object.freeze(cfg)}CONFIG=cfg};var _forceRemove=function(node){DOMPurify.removed.push({element:node});try{node.parentNode.removeChild(node)}catch(e){node.outerHTML=""}};var _removeAttribute=function(name,node){DOMPurify.removed.push({attribute:node.getAttributeNode(name),from:node});node.removeAttribute(name)};var _initDocument=function(dirty){var doc,body;try{doc=(new DOMParser).parseFromString(dirty,"text/html")}catch(e){}if(!doc||!doc.documentElement){doc=implementation.createHTMLDocument("");body=doc.body;body.parentNode.removeChild(body.parentNode.firstElementChild);body.outerHTML=dirty}if(typeof doc.getElementsByTagName==="function"){return doc.getElementsByTagName(WHOLE_DOCUMENT?"html":"body")[0]}return getElementsByTagName.call(doc,WHOLE_DOCUMENT?"html":"body")[0]};var _createIterator=function(root){return createNodeIterator.call(root.ownerDocument||root,root,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_TEXT,function(){return NodeFilter.FILTER_ACCEPT},false)};var _isClobbered=function(elm){if(elm instanceof Text||elm instanceof Comment){return false}if(typeof elm.nodeName!=="string"||typeof elm.textContent!=="string"||typeof elm.removeChild!=="function"||!(elm.attributes instanceof NamedNodeMap)||typeof elm.removeAttribute!=="function"||typeof elm.setAttribute!=="function"){return true}return false};var _sanitizeElements=function(currentNode){var tagName,content;_executeHook("beforeSanitizeElements",currentNode,null);if(_isClobbered(currentNode)){_forceRemove(currentNode);return true}tagName=currentNode.nodeName.toLowerCase();_executeHook("uponSanitizeElement",currentNode,{tagName:tagName});if(!ALLOWED_TAGS[tagName]||FORBID_TAGS[tagName]){if(KEEP_CONTENT&&!FORBID_CONTENTS[tagName]&&typeof currentNode.insertAdjacentHTML==="function"){try{currentNode.insertAdjacentHTML("AfterEnd",currentNode.innerHTML)}catch(e){}}_forceRemove(currentNode);return true}if(SAFE_FOR_JQUERY&&!currentNode.firstElementChild&&(!currentNode.content||!currentNode.content.firstElementChild)&&/</g.test(currentNode.textContent)){DOMPurify.removed.push({element:currentNode.cloneNode()});currentNode.innerHTML=currentNode.textContent.replace(/</g,"&lt;")}if(SAFE_FOR_TEMPLATES&&currentNode.nodeType===3){content=currentNode.textContent;content=content.replace(MUSTACHE_EXPR," ");content=content.replace(ERB_EXPR," ");if(currentNode.textContent!==content){DOMPurify.removed.push({element:currentNode.cloneNode()});currentNode.textContent=content}}_executeHook("afterSanitizeElements",currentNode,null);return false};var DATA_ATTR=/^data-[\-\w.\u00B7-\uFFFF]/;var IS_ALLOWED_URI=/^(?:(?:(?:f|ht)tps?|mailto|tel):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i;var IS_SCRIPT_OR_DATA=/^(?:\w+script|data):/i;var ATTR_WHITESPACE=/[\x00-\x20\xA0\u1680\u180E\u2000-\u2029\u205f\u3000]/g;var _sanitizeAttributes=function(currentNode){var attr,name,value,lcName,idAttr,attributes,hookEvent,l;_executeHook("beforeSanitizeAttributes",currentNode,null);attributes=currentNode.attributes;if(!attributes){return}hookEvent={attrName:"",attrValue:"",keepAttr:true};l=attributes.length;while(l--){attr=attributes[l];name=attr.name;value=attr.value;lcName=name.toLowerCase();hookEvent.attrName=lcName;hookEvent.attrValue=value;hookEvent.keepAttr=true;_executeHook("uponSanitizeAttribute",currentNode,hookEvent);value=hookEvent.attrValue;if(lcName==="name"&&currentNode.nodeName==="IMG"&&attributes.id){idAttr=attributes.id;attributes=Array.prototype.slice.apply(attributes);_removeAttribute("id",currentNode);_removeAttribute(name,currentNode);if(attributes.indexOf(idAttr)>l){currentNode.setAttribute("id",idAttr.value)}}else{if(name==="id"){currentNode.setAttribute(name,"")}_removeAttribute(name,currentNode)}if(!hookEvent.keepAttr){continue}if(SANITIZE_DOM&&(lcName==="id"||lcName==="name")&&(value in window||value in document||value in formElement)){continue}if(SAFE_FOR_TEMPLATES){value=value.replace(MUSTACHE_EXPR," ");value=value.replace(ERB_EXPR," ")}if(ALLOW_DATA_ATTR&&DATA_ATTR.test(lcName)){}else if(!ALLOWED_ATTR[lcName]||FORBID_ATTR[lcName]){continue}else if(URI_SAFE_ATTRIBUTES[lcName]){}else if(IS_ALLOWED_URI.test(value.replace(ATTR_WHITESPACE,""))){}else if(lcName==="src"&&value.indexOf("data:")===0&&DATA_URI_TAGS[currentNode.nodeName.toLowerCase()]){}else if(ALLOW_UNKNOWN_PROTOCOLS&&!IS_SCRIPT_OR_DATA.test(value.replace(ATTR_WHITESPACE,""))){}else if(!value){}else{continue}try{currentNode.setAttribute(name,value);DOMPurify.removed.pop()}catch(e){}}_executeHook("afterSanitizeAttributes",currentNode,null)};var _sanitizeShadowDOM=function(fragment){var shadowNode;var shadowIterator=_createIterator(fragment);_executeHook("beforeSanitizeShadowDOM",fragment,null);while(shadowNode=shadowIterator.nextNode()){_executeHook("uponSanitizeShadowNode",shadowNode,null);if(_sanitizeElements(shadowNode)){continue}if(shadowNode.content instanceof DocumentFragment){_sanitizeShadowDOM(shadowNode.content)}_sanitizeAttributes(shadowNode)}_executeHook("afterSanitizeShadowDOM",fragment,null)};var _executeHook=function(entryPoint,currentNode,data){if(!hooks[entryPoint]){return}hooks[entryPoint].forEach(function(hook){hook.call(DOMPurify,currentNode,data,CONFIG)})};DOMPurify.sanitize=function(dirty,cfg){var body,currentNode,oldNode,nodeIterator,returnNode;if(!dirty){dirty=""}if(typeof dirty!=="string"){if(typeof dirty.toString!=="function"){throw new TypeError("toString is not a function")}else{dirty=dirty.toString()}}if(!DOMPurify.isSupported){if(typeof window.toStaticHTML==="object"||typeof window.toStaticHTML==="function"){return window.toStaticHTML(dirty)}return dirty}_parseConfig(cfg);DOMPurify.removed=[];if(!RETURN_DOM&&!WHOLE_DOCUMENT&&dirty.indexOf("<")===-1){return dirty}body=_initDocument(dirty);if(!body){return RETURN_DOM?null:""}nodeIterator=_createIterator(body);while(currentNode=nodeIterator.nextNode()){if(currentNode.nodeType===3&&currentNode===oldNode){continue}if(_sanitizeElements(currentNode)){continue}if(currentNode.content instanceof DocumentFragment){_sanitizeShadowDOM(currentNode.content)}_sanitizeAttributes(currentNode);oldNode=currentNode}if(RETURN_DOM){if(RETURN_DOM_FRAGMENT){returnNode=createDocumentFragment.call(body.ownerDocument);while(body.firstChild){returnNode.appendChild(body.firstChild)}}else{returnNode=body}if(RETURN_DOM_IMPORT){returnNode=importNode.call(originalDocument,returnNode,true)}return returnNode}return WHOLE_DOCUMENT?body.outerHTML:body.innerHTML};DOMPurify.addHook=function(entryPoint,hookFunction){if(typeof hookFunction!=="function"){return}hooks[entryPoint]=hooks[entryPoint]||[];hooks[entryPoint].push(hookFunction)};DOMPurify.removeHook=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint].pop()}};DOMPurify.removeHooks=function(entryPoint){if(hooks[entryPoint]){hooks[entryPoint]=[]}};DOMPurify.removeAllHooks=function(){hooks={}};return DOMPurify});SM.AjaxBase={init:function(){},Statuses:{SUCCESS:0,OK:200,NOT_FOUND:404,CONFLICT:409,SERVER_ERROR:500,BAD_GATEWAY:502},get:function(url,data,options){var ajaxOptions={dataType:"json",type:"GET",contentType:"application/json",processData:false,url:url,cache:false,headers:{}},urlWithQueryString,request;if(options){$.extend(true,ajaxOptions,options)}if(data){urlWithQueryString=new Uri(url);_.each(data,function(v,k){urlWithQueryString.addQueryParam(k,v)});ajaxOptions.url=urlWithQueryString.toString()}SM.log("Ajax GET:",JSON.stringify(ajaxOptions));request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request},post:function(url,data,options){var ajaxOptions={dataType:"json",type:"POST",data:JSON.stringify(data),contentType:"application/json",processData:false,url:url,cache:false,headers:{}},request;if(options){$.extend(true,ajaxOptions,options)}SM.log("Ajax POST:",JSON.stringify(ajaxOptions));request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request},destroy:function(url,data,options){var ajaxOptions={dataType:"json",type:"DELETE",data:JSON.stringify(data),contentType:"application/json",processData:false,url:url,cache:false,headers:{}},request;if(options){$.extend(true,ajaxOptions,options)}SM.log("Ajax DELETE:",JSON.stringify(ajaxOptions));request=$.ajax(ajaxOptions);request=this._normalizeRequest(request);return request},_normalizeRequest:function(request){var dfd=$.Deferred();$.when({dfd:dfd},request).done(this._done).fail(function(jqXHR,textStatus,exception){SM.Ajax._fail(dfd,jqXHR,textStatus)});return dfd},_done:function(context,doneArgs){var data=doneArgs[0],textStatus=doneArgs[1],jqXHR=doneArgs[2],dfd=context.dfd;if(data.status===SM.Ajax.Statuses.SUCCESS||data.status===SM.Ajax.Statuses.OK){if(data.data){dfd.resolve(data.data,textStatus,jqXHR)}else{dfd.resolve(data,textStatus,jqXHR)}}else{SM.log("Ajax done but not successful:",JSON.stringify(data));dfd.reject(data,textStatus,jqXHR)}},_fail:function(request,jqXHR,textStatus){var data;SM.log("Ajax fail, response text:",jqXHR.responseText);try{data=JSON.parse(jqXHR.responseText);if(data.status===SM.Ajax.Statuses.CONFLICT){SM.PubSub.publish("HTTP_CONFLICT");return}}catch(e){data={error_message:jqXHR.responseText}}request.reject(data,textStatus,jqXHR)}};SM.Ajax=$.extend(true,{},SM.AjaxBase);SM.ApiBase={Paths:{},Urls:{},basePath:null,_addUrls:function(basePath,paths){var self=this;_.each(paths,function(path,key){self.Urls[key]=basePath+path})},init:function(options){var self=this;if(!self.basePath&&options){self.basePath=options.basePath;self._addUrls(self.basePath,self.Paths)}},extend:function(basePath,api){$.extend(true,this,api.API);if(api.Paths){basePath=basePath||"";this._addUrls(basePath,api.Paths)}},FORCE_FAIL:false,_prepare:function(key,options){var url=this.Urls[key];if(!url){throw"Unknown URL Key '"+key+"'"}if(options&&options.replacements){_.each(options.replacements,function(replacement,ix){url=url.replace(replacement.key,replacement.value)})}if(this.FORCE_FAIL){url=url+"x"}return url},get:function(key,data,options){var url=this._prepare(key,options);return SM.Ajax.get(url,data,options)},post:function(key,data,options){var url=this._prepare(key,options);return SM.Ajax.post(url,data,options)},destroy:function(key,data,options){var url=this._prepare(key,options);return SM.Ajax.destroy(url,data,options)}};SM.API=$.extend(true,{},SM.ApiBase);SM.LogAPI={Paths:{LOG_INFO:"/ajax/log_info"},API:{hasLogAPI:true,logData:function(level,data,ajaxOptions){if($.type(data)==="string"){data={message:data}}data.level=level;data.url=window.location.href;return this.post("LOG_INFO",data,ajaxOptions)},logInfo:function(data,ajaxOptions){return this.logData("info",data,ajaxOptions)},logWarning:function(data,ajaxOptions){return this.logData("warning",data,ajaxOptions)},logError:function(data,ajaxOptions){return this.logData("error",data,ajaxOptions)},logDebug:function(data,ajaxOptions){return this.logData("debug",data,ajaxOptions)},logUiTrigger:null,logOptions:null,logInit:function(options){if(!options){throw"cannot init BI Logging"}if(!options.webapp){throw"no webapp set for BI Logging"}this.logOptions=options},addLogOptions:function(options){if(!this.logOptions){throw"can't add options - BI logging not init"}if(options){$.extend(true,this.logOptions,options)}},logSetUiTrigger:function(uiTrigger){this.logUiTrigger=uiTrigger},logBi:function(data,ajaxOptions){if(!this.logOptions){throw"BI Logging not initialized"}var logData=$.extend(true,{ui_trigger:this.logUiTrigger},this.logOptions,data);this.logUiTrigger=null;return this.logInfo(logData,ajaxOptions)}}};SM.Error={MAX_ERRLEN:400,init:function(){window.onerror=this._onWindowError},log:function(exception,details){var trace=exception.stack;if(!exception){return}if(!exception.message){exception.message="no message"}if(!exception.name){exception.name="UndefinedException"}if(SM.DEBUG){setTimeout(function(){if(details){SM.log(details)}if(trace){SM.log(trace)}throw exception},0)}else{if(!details){details="No details."}if(!trace){trace="No trace."}SM.API.logError({name:exception.name,message:exception.message,details:details,trace:trace})}},makeErrorMessage:function(err,msg,rs){var errMsg="Unknown Error";if(err.data&&err.data.error_message){errMsg=err.data.error_message}else if(err.exceptionMessage){errMsg=err.exceptionMessage}else if(err.error){errMsg="Error "+err.status+": "+err.error}else{errMsg="Error "+rs.status+": "+rs.statusText}errMsg=SM.String.truncate(errMsg,this.MAX_ERRLEN,true);return errMsg},_isThirdPartyScript:function(url){var splitScriptHost,splitDocumentHost;url=this._parseUrl(url);if(!url||!url.host){return false}splitScriptHost=url.host.split(".");if(splitScriptHost.length!==3){return true}splitDocumentHost=window.location.host.split(".");if(splitScriptHost[1]!==splitDocumentHost[1]){return true}return false},_parseUrl:function(url){var a;if(!url){return null}a=document.createElement("a");a.href=url;return{raw:a.href,host:a.hostname,scheme:a.protocol,path:a.pathname,query:a.query,hash:a.hash}},_onWindowError:function(message,url,lineNumber){if(SM.DEBUG||SM.TEST){return false}else{try{if(SM.Error._isThirdPartyScript(url)){SM.API.logWarning({name:"ThirdPartyException",message:message,scriptUrl:url})}else{SM.API.logError({name:"UncaughtException",message:message})}}catch(e){}window.onerror=undefined;return true}}};SM.Bi={_makeBaseLog:function(){var log={survey_id:SM.API.surveyID,user_id:SM.API.userID};return log},anViewRename:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_rename",view_id:anViewModel.ID})},anViewDelete:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_delete",view_id:anViewModel.ID,is_selected:anViewModel.isSelected})},anViewRevert:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_revert",view_id:anViewModel.ID})},anViewSelect:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_select",view_id:anViewModel.ID})},anViewCreate:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_create",view_id:anViewModel.ID})},anViewSave:function(anViewModel){return SM.API.logBi({action_type:"analyze_view_save",view_id:anViewModel.ID})},_makeExportLog:function(exportjob){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_export_create",export_format:exportjob.format,export_type:exportjob.export_type,include_openended:exportjob.export_data.include_openended,show_word_cloud:exportjob.export_data.show_word_cloud,one_question_per_page:exportjob.export_data.forced_page_break,page_dimension:exportjob.export_data.dimension,page_orientation:exportjob.export_data.orientation});if(exportjob.export_type==="full"){log.respondent_id=exportjob.export_data.respondent_id;log.timezone_offset=exportjob.export_data.timezone_offset}return log},exportCreate:function(exportjob){var log=this._makeExportLog(exportjob);return SM.API.logBi(log)},_makeRuleLog:function(ruleModel){var log=this._makeBaseLog();_.extend(log,{rule_id:ruleModel.ID,rule_type:ruleModel.ruleType,rule_family:ruleModel.ruleFamily,is_selected:ruleModel.selected,has_custom_heading:!!ruleModel.customHeader});return log},ruleApplied:function(ruleModel){var log=this._makeRuleLog(ruleModel);log.action_type="analyze_rule_changed";return SM.API.logBi(log)},ruleCopy:function(ruleModel){var log=this._makeRuleLog(ruleModel);log.action_type="analyze_rule_copy";return SM.API.logBi(log)},ruleToggle:function(ruleModel){var log=this._makeRuleLog(ruleModel);log.action_type="analyze_rule_toggle";log.is_selected=!log.is_selected;return SM.API.logBi(log)},ruleRename:function(ruleModel){var log=this._makeRuleLog(ruleModel);log.action_type="analyze_rule_rename";return SM.API.logBi(log)},ruleDelete:function(ruleModel){var log=this._makeRuleLog(ruleModel);log.action_type="analyze_rule_delete";return SM.API.logBi(log)},_makeSharedViewLog:function(sharedViewModel){var modes=sharedViewModel.get("modes"),log=this._makeBaseLog();_.extend(log,{share_view_id:sharedViewModel.id,is_public:sharedViewModel.is_public,allow_team_export:sharedViewModel.allow_team_export,has_password:sharedViewModel.has_password,hide_open_ended:sharedViewModel.hide_open_ended,mode_summary:_.contains(modes,"summary"),mode_browse:_.contains(modes,"browse"),mode_trends:_.contains(modes,"trends"),branding:sharedViewModel.branding,custom_branding:sharedViewModel.custom_branding,share_enabled:sharedViewModel.enabled,shared_view_id:sharedViewModel.sharable_view_id,default_view_id:sharedViewModel.default_view_id,share_id:sharedViewModel.id});return log},sharedViewSave:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_save";return SM.API.logBi(log)},sharedViewToggle:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_toggle";log.share_enabled=!log.share_enabled;return SM.API.logBi(log)},sharedViewRename:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_rename";return SM.API.logBi(log)},sharedViewVisit:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_visit";return SM.API.logBi(log)},sharedViewGetWeblink:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_get_weblink";return SM.API.logBi(log)},sharedViewDelete:function(sharedViewModel){var log=this._makeSharedViewLog(sharedViewModel);log.action_type="analyze_shared_view_delete";return SM.API.logBi(log)},customizeQuestion:function(customizations,applyToAll,questionModel){var log=SM.Object.deepCopy(customizations);log.action_type="analyze_question_customize";log.question_id=questionModel.ID;log.apply_to_all=applyToAll;log.customized_labels="labels"in log;delete log.labels;log.customized_colors="colors"in log;delete log.colors;return SM.API.logBi(log)},answersHide:function(questionModel){var log={action_type:"analyze_answers_hide",question_id:questionModel.ID};return SM.API.logBi(log)},answersUnhide:function(questionModel){var log={action_type:"analyze_answers_unhide",question_id:questionModel.ID};return SM.API.logBi(log)},answersUnhideAll:function(questionModel){var log={action_type:"analyze_answers_unhide_all",question_id:questionModel.ID};return SM.API.logBi(log)},answersEditCombine:function(questionModel){var log={action_type:"analyze_answers_edit_combine",question_id:questionModel.ID};return SM.API.logBi(log)},answersUncombine:function(questionModel){var log={action_type:"analyze_answers_uncombine",question_id:questionModel.ID};return SM.API.logBi(log)},answersCombine:function(questionModel){var log={action_type:"analyze_answers_combine",question_id:questionModel.ID};return SM.API.logBi(log)},_makeRespondentLog:function(respondentModel){var log=this._makeBaseLog();_.extend(log,{respondent_id:respondentModel.ID,collection_mode:respondentModel.details.collection_mode,collector_id:respondentModel.details.collector_id,ip_address:respondentModel.details.ip_address,status:respondentModel.details.status});return log},respondentDelete:function(respondentModel){var log=this._makeRespondentLog(respondentModel);log.action_type="analyze_respondent_delete";return SM.API.logBi(log)},respondentBrowse:function(){var log={action_type:"analyze_respondent_browse"};return SM.API.logBi(log)
},respondentEdit:function(respondentModel){var log=this._makeRespondentLog(respondentModel);log.action_type="analyze_respondent_edit";return SM.API.logBi(log)},trendsQuestionZoomSelected:function(question,zoom){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_question_zoom_change",question_id:question.ID,zoom:zoom});return SM.API.logBi(log)},trendsSurveyZoomSelected:function(zoom){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_survey_zoom_change",zoom:zoom});return SM.API.logBi(log)},trendsQuestionTrendBySelected:function(question,trendBy){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_question_trendby_change",question_id:question.ID,trend_by:trendBy});return SM.API.logBi(log)},trendsSurveyTrendBySelected:function(trendBy){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_survey_trendby_change",trend_by:trendBy});return SM.API.logBi(log)},trendsQuestionChartTypeSelected:function(question,chartType){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_question_chart_change",chart_type:chartType,question_id:question.ID});return SM.API.logBi(log)},trendsSurveyChartTypeSelected:function(chartType){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_survey_chart_change",chart_type:chartType});return SM.API.logBi(log)},trendsQuestionDisplayOptionsSelected:function(question,displayOption){var log=this._makeBaseLog();_.extend(log,{action_type:"analyze_trends_question_display_options_change",question_id:question.ID,display_option:displayOption});return SM.API.logBi(log)},_logBenchmarkingData:function(logData){logData.log_category="benchmarking";logData.has_paid_benchmark=SM.App.survey.dataSegmentList.hasPaidBenchmarks();logData.has_restricted=SM.App.survey.owner.benchmarkingRestrictedEnabled;return SM.API.logBi(logData)},benchmarkingProfilerDialogOpened:function(uiTrigger,source){var logData=this._makeBaseLog();_.extend(logData,{action_type:"profiler_dialog_opened",action_source:source});SM.API.logSetUiTrigger(uiTrigger);return this._logBenchmarkingData(logData)},benchmarkingProfilerDialogClosed:function(uiTrigger,source,canceled){var logData=this._makeBaseLog(),segment=SM.App.survey.dataSegmentList.getSelectedSegment();_.extend(logData,{action_type:"profiler_dialog_closed",action_source:source,canceled:canceled});if(!canceled){logData.segment_name=segment.getCanonicalName()}SM.API.logSetUiTrigger(uiTrigger);return this._logBenchmarkingData(logData)},_getQuestionData:function(questionID){var survey=SM.App.survey,data={},question;if(questionID){question=survey.getQuestion(questionID);if(question){data.logicalId=question.logicalID;data.logicalName=question.logicalName;data.logicalLangId=question.logicalLangId;return data}}},benchmarkingShowHide:function(questionID,showHide,all){var segment=SM.App.survey.dataSegmentList.getSelectedSegment(),logData=this._makeBaseLog(),questionData=this._getQuestionData(questionID);_.extend(logData,{action_type:"benchmarks_show_hide",show_hide:showHide,action_source:"question",all:all,segment_name:segment.getCanonicalName()});if(questionData){logData.question_id=questionID;logData.logical_question_id=questionData.logicalId;logData.question_name=questionData.logicalName;logData.lang_question_id=questionData.logicalLangId}SM.API.logSetUiTrigger("benchmarking_show_hide_button");return this._logBenchmarkingData(logData)},benchmarkingDownloadCSV:function(questionID,segmentID,source){var logData=this._makeBaseLog(),questionData=this._getQuestionData(questionID);_.extend(logData,{action_type:"benchmarks_download_csv",segment_id:segmentID,action_source:source});if(questionData){logData.question_id=questionID;logData.logical_question_id=questionData.logicalId;logData.question_name=questionData.logicalName;logData.lang_question_id=questionData.logicalLangId}SM.API.logSetUiTrigger("benchmarking_download_csv_menu_action");return this._logBenchmarkingData(logData)},benchmarkingAbout:function(questionID,source,destUrl,isNPS){var logData=this._makeBaseLog(),questionData=this._getQuestionData(questionID);_.extend(logData,{action_type:"benchmarks_about",action_source:source,destUrl:destUrl,isNPS:isNPS});if(questionData){logData.question_id=questionID;logData.logical_question_id=questionData.logicalId;logData.question_name=questionData.logicalName;logData.lang_question_id=questionData.logicalLangId}SM.API.logSetUiTrigger("benchmarking_about_menu_action");return this._logBenchmarkingData(logData)},benchmarkingBuyMore:function(questionID,uiTrigger,source,destUrl,hasPaid,isNPS){var logData=this._makeBaseLog(),questionData=this._getQuestionData(questionID);_.extend(logData,{action_type:"benchmarks_buy",action_source:source,destUrl:destUrl,has_restricted:hasPaid,isNPS:isNPS});if(!SM.App.survey.isStoreTemplate()){logData.action_type="benchmarks_request"}if(questionData){logData.question_id=questionID;logData.logical_question_id=questionData.logicalId;logData.question_name=questionData.logicalName;logData.lang_question_id=questionData.logicalLangId}SM.API.logSetUiTrigger(uiTrigger);return this._logBenchmarkingData(logData)},logUserProfileState:function(hasValidEntity,hasCollectorProfile,hasOptOut,hasRestricted,hasPaidBenchmark,benchmarksShown,questionSet,geiShown){var logData=this._makeBaseLog();_.extend(logData,{log_category:"benchmarking",action_type:"user_scenario_state",has_valid_entity:hasValidEntity,has_collector_profile:hasCollectorProfile,has_opt_out:hasOptOut,has_restricted:hasRestricted,has_paid_benchmark:hasPaidBenchmark,benchmarks_shown:benchmarksShown,question_set:questionSet,gei_fe_shown:geiShown,webapp:SM.API.logOptions.webapp,survey_id:SM.API.logOptions.survey_id});return SM.API.logInfo(logData)},logUpsellTooltipOpened:function(questionID){var logData=this._makeBaseLog(),questionData=this._getQuestionData(questionID);_.extend(logData,{action_type:"upsell_tooltip_opened",action_source:"question"});if(questionData){logData.question_id=questionID;logData.logical_question_id=questionData.logicalId;logData.question_name=questionData.logicalName;logData.lang_question_id=questionData.logicalLangId}SM.API.logSetUiTrigger("icon");return this._logBenchmarkingData(logData)},logProfilerMarketingDialog:function(trigger,upsellSegment){var logData=this._makeBaseLog();_.extend(logData,{action_type:"interstitial_modal_opened",action_source:"accordion",upsell_segment:upsellSegment});SM.API.logSetUiTrigger(trigger);return this._logBenchmarkingData(logData)},logSegmentSwitch:function(segmentFrom,segmentTo,source){var isTMBC=SM.App.survey.isTMBCTemplate(),logData=this._makeBaseLog();_.extend(logData,{action_type:"benchmarks_segment_switch"});logData.action_source=source||"accordion";if(segmentFrom===""){segmentFrom=isTMBC?"standout_gei_benchmark":"survey_monkey_global_benchmark"}if(segmentTo===""){segmentTo=isTMBC?"standout_gei_benchmark":"survey_monkey_global_benchmark"}logData.segment_name=segmentTo;logData.origin_segment_name=segmentFrom;return this._logBenchmarkingData(logData)},logSegmentRemoved:function(segment){var logData=this._makeBaseLog();_.extend(logData,{action_type:"benchmarks_segment_removed",action_source:"accordion"});logData.segment_name=segment;return this._logBenchmarkingData(logData)}};SM.Ajax=$.extend(true,{},SM.AjaxBase,{init:function(appVersion){SM.AjaxBase.init.call(this);this.appVersion=appVersion},__prepare:function(options){options=options||{headers:{}};if(!options.headers){options.headers={}}options.headers["SM-Analyze-Version"]=this.appVersion;return options},get:function(url,data,options){options=this.__prepare(options);return SM.AjaxBase.get.call(this,url,data,options)},post:function(url,data,options){options=this.__prepare(options);return SM.AjaxBase.post.call(this,url,data,options)},destroy:function(url,data,options){options=this.__prepare(options);return SM.AjaxBase.destroy.call(this,url,data,options)}});SM.AnalyzeAPI={Paths:{FETCH_RESPONSES:"/ajax/respondents/responses",DELETE_RESPONDENT:"/ajax/respondents/delete",FETCH_ROLLUPS:"/ajax/questions/rollups",FETCH_TREND_ROLLUPS:"/ajax/questions/trend_rollups",DELETE_VIEW:"/ajax/view/delete",DUPLICATE_VIEW:"/ajax/view/duplicate",EDIT_VIEW:"/ajax/view/edit",SWITCH_VIEW:"/ajax/view/switch",EXPORT_DELETE:"/ajax/export/delete",EXPORT_CREATE:"/ajax/export/create",EXPORT_LIST:"/ajax/export/list",TA_GET_ROLLUP_QUESTION:"/ajax/ta/rollup/by_question",TA_GET_ROLLUP_SEARCH:"/ajax/ta/rollup/by_search",TA_GET_ROLLUP_PHRASE:"/ajax/ta/rollup/by_phrase",TA_TEXT_TAG_ALL:"/ajax/ta/response_texts/tag_all",TA_TEXT_TAG_EXCEPT:"/ajax/ta/response_texts/tag_except",TA_EDIT_TAG:"/ajax/ta/question_tags/update",TA_DELETE_TAG:"/ajax/ta/question_tags/delete",TA_CREATE_TAG:"/ajax/ta/question_tags/create",FILO_BY_SEARCH:"/ajax/filo/rollup/by_search",FILO_BY_QUESTION:"/ajax/filo/rollup/by_question",FILO_DELETE:"/ajax/filo/delete/by_respondents",BM_GET_BENCHMARK_ROLLUPS:"/ajax/bm/get_benchmark_rollups",MERVEYS_COMPLETE_SURVEY_MERGE:"/ajax/merveys/merge_complete",MERVEYS_SAVE_DISPLAY_OPTIONS:"/ajax/merveys/set_display_options"},API:{fetchRespondentsAnalyze:function(data,ajaxOptions){return this.post("FETCH_RESPONSES",data,ajaxOptions)},createExportAnalyze:function(data,ajaxOptions){return this.post("EXPORT_CREATE",data,ajaxOptions)},getExportListAnalyze:function(data,ajaxOptions){return this.post("EXPORT_LIST",data,ajaxOptions)},taGetRollupQuestionAnalyze:function(data,ajaxOptions){return this.post("TA_GET_ROLLUP_QUESTION",data,ajaxOptions)}}};SM.SharingAPI={Paths:{FETCH_SHARED_RESPONSES:"/ajax/shared-view/{shared_view_key}/respondents/responses",SHARED_VIEWS_EXPORT_CREATE:"/ajax/shared-view/{shared_view_key}/export/create",SHARED_VIEWS_EXPORT_GET:"/ajax/shared-view/{shared_view_key}/export/get",TA_GET_ROLLUP_SHARED_QUESTION:"/ajax/shared-view/{shared_view_key}/ta/rollup/by_question",SHARED_VIEWS_LIST:"/ajax/shared_views{shared_view_path}"},API:{postShared:function(key,data,options){var ajaxOptions=SM.Object.extend({replacements:[{key:"{shared_view_key}",value:SM.App.sharedView.get("key")}]},options);return this.post(key,data,ajaxOptions)},fetchRespondentsShared:function(data,ajaxOptions){return this.postShared("FETCH_SHARED_RESPONSES",data,ajaxOptions)},createExportShared:function(data,ajaxOptions){return this.postShared("SHARED_VIEWS_EXPORT_CREATE",data,ajaxOptions)},getExportListShared:function(data,ajaxOptions){return this.postShared("SHARED_VIEWS_EXPORT_GET",data,ajaxOptions)},taGetRollupQuestionShared:function(data,ajaxOptions){return this.postShared("TA_GET_ROLLUP_SHARED_QUESTION",data,ajaxOptions)},fetchSharedViewList:function(data,ajaxOptions){ajaxOptions=ajaxOptions||{};if(!ajaxOptions.replacements){ajaxOptions.replacements=[{key:"{shared_view_path}",value:""}]}return this.get("SHARED_VIEWS_LIST",data,ajaxOptions)}}};SM.API=$.extend(true,{},SM.ApiBase,{init:function(surveyID){SM.ApiBase.init.call(this);this.surveyID=surveyID;this.userID=0;this.extend("/analyze",SM.LogAPI);this.logInit({webapp:"analyze",survey_id:surveyID});this.extend("/analyze",SM.AnalyzeAPI);this.extend("/results",SM.SharingAPI)},post:function(key,data,options){var requestData=SM.Object.extend({survey_id:this.surveyID},data);return SM.ApiBase.post.call(this,key,requestData,options)},_getUseStatsvc:function(){var url=new Uri(location.href);return url.getQueryParamValue("usestatsvc")},fetchRespondents:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return SM.App.isSharingApp()?this.fetchRespondentsShared(data,ajaxOptions):this.fetchRespondentsAnalyze(data,ajaxOptions)},deleteRespondent:function(data,ajaxOptions){return this.post("DELETE_RESPONDENT",data,ajaxOptions)},fetchRollups:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("FETCH_ROLLUPS",data,ajaxOptions)},fetchTrends:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("FETCH_TREND_ROLLUPS",data,ajaxOptions)},editView:function(data,ajaxOptions){return this.post("EDIT_VIEW",data,ajaxOptions)},deleteView:function(data,ajaxOptions){return this.post("DELETE_VIEW",data,ajaxOptions)},duplicateView:function(data,ajaxOptions){return this.post("DUPLICATE_VIEW",data,ajaxOptions)},switchView:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("SWITCH_VIEW",data,ajaxOptions)},createExport:function(data,ajaxOptions){SM.Bi.exportCreate(data.exportjob);return SM.App.isSharingApp()?this.createExportShared(data,ajaxOptions):this.createExportAnalyze(data,ajaxOptions)},getExportList:function(data,ajaxOptions){return SM.App.isSharingApp()?this.getExportListShared(data,ajaxOptions):this.getExportListAnalyze(data,ajaxOptions)},deleteExport:function(data,ajaxOptions){return this.post("EXPORT_DELETE",data,ajaxOptions)},setUser:function(userID){this.userID=userID},taGetRollupQuestion:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return SM.App.isSharingApp()?this.taGetRollupQuestionShared(data,ajaxOptions):this.taGetRollupQuestionAnalyze(data,ajaxOptions)},taGetRollupSearch:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("TA_GET_ROLLUP_SEARCH",data,ajaxOptions)},taGetRollupPhrase:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("TA_GET_ROLLUP_PHRASE",data,ajaxOptions)},taTagAllText:function(data,ajaxOptions){return this.post("TA_TEXT_TAG_ALL",data,ajaxOptions)},taTagExceptText:function(data,ajaxOptions){return this.post("TA_TEXT_TAG_EXCEPT",data,ajaxOptions)},taDeleteTag:function(data,ajaxOptions){return this.post("TA_DELETE_TAG",data,ajaxOptions)},taCreateTag:function(data,ajaxOptions){return this.post("TA_CREATE_TAG",data,ajaxOptions)},taEditTag:function(data,ajaxOptions){return this.post("TA_EDIT_TAG",data,ajaxOptions)},bmFetchBenchmarkRollups:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("BM_GET_BENCHMARK_ROLLUPS",data,ajaxOptions)},merveysCompleteMerge:function(data,ajaxOptions){return this.post("MERVEYS_COMPLETE_SURVEY_MERGE",data,ajaxOptions)},saveMerveysDisplayOptions:function(data,ajaxOptions){return this.post("MERVEYS_SAVE_DISPLAY_OPTIONS",data,ajaxOptions)},filoDelete:function(data,ajaxOptions){return this.post("FILO_DELETE",data,ajaxOptions)},filoBySearch:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("FILO_BY_SEARCH",data,ajaxOptions)},filoByQuestion:function(data,ajaxOptions){data.usestatsvc=this._getUseStatsvc();return this.post("FILO_BY_QUESTION",data,ajaxOptions)}});SM.FunctionTimer={time:function(func,name){var et,st=(new Date).getTime();func();et=(new Date).getTime();if(name){SM.log("Took "+(et-st)+"ms to call "+name)}else{SM.log("Took "+(et-st)+"ms")}}};SM.TrendLib={getDefaultScales:function(timeframe,active,trend_by){var hours=timeframe/this.HOUR,zoomMapping=active?this.zoomMapping:this.zoomMapping_inactive,scales={},zoom;for(zoom in zoomMapping){if(hours<=zoomMapping[zoom]){scales.zoom=zoom;scales.zoomMax=zoom;scales.trend=trend_by;scales.label=this.getLabelUnit(scales.zoom,scales.trend);break}}return scales},getLabelUnit:function(zoom,trend){if(zoom==="max"&&_.contains(["quarter","month","week","day"],trend)){return"year"}if(zoom==="year"&&trend==="week"||zoom==="three_years"&&_.contains(["week","day"],trend)){return"month"}return trend},checkLabel:function(label){return _.contains(this.timeUnits,label)},smallerTimeUnit:{week:"day",month:"week",quarter:"month",year:"quarter",three_years:"year",max:"quarter"},HOUR:1e3*3600,timeUnits:["day","week","month","quarter","year","three_years","max"],timeIdx:{day:0,week:1,month:2,quarter:3,year:4,three_years:5,max:6},Trend2ZoomOptions:{day:{list:["week","month"],selected:"week"},week:{list:["month","quarter","year"],selected:"month"},month:{list:["quarter","year","three_years"],selected:"quarter"},quarter:{list:["year","three_years","max"],selected:"year"},year:{list:["three_years","max"],selected:"three_years"}},Trend2ZoomOptions_inactive:{day:{list:["week","month"],selected:"week"},week:{list:["month","quarter","year"],selected:"month"},month:{list:["quarter","year","three_years"],selected:"quarter"},quarter:{list:["year","three_years","max"],selected:"year"},year:{list:["three_years","max"],selected:"year"}},trendMapping:{day:24,"7days":24*7,week:24*7,"30days":24*30,month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},zoomMapping:{week:24*7,month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},zoomMapping_inactive:{month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},getBucket:function(ts,unit){var bucket={startsAt:SM.TrendLib._getStartOfBucket(ts,unit).valueOf(),endsAt:SM.TrendLib._getEndOfBucket(ts,unit).valueOf(),unit:unit};return bucket},_getStartOfBucket:function(ts,unit){var firstMonthOfQuarter,mdate=this.localize(ts),quarter;switch(unit){case"hour":return moment(ts).startOf("hour");case"day":return moment(ts).startOf("day");case"week":return moment(ts).startOf("week");case"month":return moment(ts).startOf("month");case"quarter":firstMonthOfQuarter=Math.floor(mdate.month()/3)*3;quarter=mdate.month(firstMonthOfQuarter);return quarter.startOf("month");case"year":return moment(ts).startOf("year");default:return null}},_getEndOfBucket:function(ts,unit){var lastMonthOfQuarter,mdate=this.localize(ts),quarter;switch(unit){case"hour":return moment(ts).endOf("hour");case"day":return moment(ts).endOf("day");case"week":return moment(ts).endOf("week");case"month":return moment(ts).endOf("month");case"quarter":lastMonthOfQuarter=Math.floor(mdate.month()/3)*3+2;quarter=mdate.month(lastMonthOfQuarter);return quarter.endOf("month");case"year":return moment(ts).endOf("year");default:return null}},getBucketDiff:function(duration,unit){var hours=duration/this.HOUR,count=Math.ceil(hours/this.trendMapping[unit]);return count},getPreviousBucket:function(bucket,n){var mdate=this.localize(bucket.startsAt),unit=bucket.unit;if(n===undefined){n=1}switch(unit){case"hour":mdate.subtract("hour",1*n);return this.getBucket(mdate,unit);case"day":mdate.subtract("day",1*n);return this.getBucket(mdate,unit);case"week":mdate.subtract("week",1*n);return this.getBucket(mdate,unit);case"month":mdate.subtract("month",1*n);return this.getBucket(mdate,unit);case"quarter":mdate.subtract("month",3*n);return this.getBucket(mdate,unit);case"year":mdate.subtract("year",1*n);return this.getBucket(mdate,unit);default:return null}},getNextBucket:function(bucket,n){var mdate=this.localize(bucket.startsAt),unit=bucket.unit;if(n===undefined){n=1}switch(unit){case"hour":mdate.add("hour",1*n);return this.getBucket(mdate,unit);case"day":mdate.add("day",1*n);return this.getBucket(mdate,unit);case"week":mdate.add("week",1*n);return this.getBucket(mdate,unit);case"month":mdate.add("month",1*n);return this.getBucket(mdate,unit);case"quarter":mdate.add("month",3*n);return this.getBucket(mdate,unit);case"year":mdate.add("year",1*n);return this.getBucket(mdate,unit);default:return null}},getLabelName:function(ts,label){var culture=Globalize.culture(),calendar=culture.calendars.standard,shortMonths=calendar.months.namesAbbr,mdate=this.localize(ts),year,month,date,hour,labelDate;year=mdate.year();month=mdate.month();date=mdate.date();hour=mdate.hour();labelDate=new Date(year,month,date);switch(label){case"year":return year+"";case"quarter":case"month":return shortMonths[month]+" "+year;case"week":case"day":return Globalize.format(labelDate,"d");case"hour":return Globalize.normalizeHour(hour)+" "+Globalize.format(labelDate,"d");default:return"<invalid-label>"}},toDate:function(mdate){var year,month,date,thisDate;year=mdate.year();month=mdate.month();date=mdate.date();thisDate=new Date(year,month,date);return Globalize.format(thisDate,"d")},isActive:function(lastRespondentMdate){return moment().diff(lastRespondentMdate,"days")<15},localize:function(timestamp){var current_lang=moment.lang();moment.lang(current_lang,{week:{dow:1,doy:4}});return moment(timestamp).zone(moment().zone())},BucketingException:function(options){var bucketIndex=options.bucketIndex,trendDatum=options.trendDatum,respondentBucket=options.respondentBucket,message="trendBucket#"+bucketIndex+": start@"+trendDatum.start.valueOf()+" ("+trendDatum.start.toString()+")"+"; data bucket start@"+respondentBucket.start+" ("+SM.TrendLib.localize(respondentBucket.start).toString()+")"+" end@"+respondentBucket.end+" ("+SM.TrendLib.localize(respondentBucket.end).toString()+")";return{name:"TrendBucketingException",message:message,toString:function(){return this.name+": "+this.message}}}};SM.ComparedByNps={structure:function(structure){var row;structure.answers.realRows=structure.answers.rows;structure.answers.rows=_.map(structure.answers.cols,function(col){row=SM.Object.deepCopy(col);row.type="row";return row});delete structure.answers.cols;structure.type={family:"single_choice",subtype:"net_promoter_score"};return structure},rollup:function(rollup){if(rollup.type==="matrix"){rollup.type="simple"}_.each(rollup.summary.options,function(option){rollup.summary.options=option.options;if(option.stats){rollup.summary.stats=option.stats}});return rollup},choiceSetRevert:function(choiceSet,question){var questionRows,rows;choiceSet.cols=choiceSet.rows;questionRows=question.structure.answers.realRows?question.structure.answers.realRows:question.structure.answers.rows;rows=_.pluck(questionRows,"id");choiceSet.rows={};choiceSet.rows[rows[0]]=true;return choiceSet},choiceSetConvert:function(choiceSet){var choiceSetCopy=SM.Object.deepCopy(choiceSet);choiceSetCopy.rows=SM.Object.deepCopy(choiceSetCopy.cols);delete choiceSetCopy.cols;return choiceSetCopy},aggregate:function(src,crossedQuestion){var self=this,crossedRow,position,des,id,combined,summariesMapping={};_.each(src,function(val,crossedRowID){crossedRow=crossedQuestion.answers[crossedRowID];position=self._getDistributedPosition(crossedRow.position);id=self.distributed[position].id;if(_.isUndefined(summariesMapping[id])){summariesMapping[id]=[]}summariesMapping[id].push(val)});des={};_.each(summariesMapping,function(summaryList,index){combined=SM.CompositeSummaryBuilder.combineSummaries(summaryList);des[index]=combined});return des},answered_subtotals:function(src,crossedQuestion){var self=this,crossedRow,position,id,summariesMapping={};_.each(src,function(val,crossedRowID){crossedRow=crossedQuestion.answers[crossedRowID];position=self._getDistributedPosition(crossedRow.position);id=self.distributed[position].id;if(_.isUndefined(summariesMapping[id])){summariesMapping[id]=0}summariesMapping[id]+=val});return summariesMapping},calcScore:function(options,cols){var self=this,colStruct,position,score,promoters=0,detractors=0,passives=0;_.each(options,function(summaryItem,id){colStruct=_.findWhere(cols,{position:parseInt(id,10)+1});position=colStruct.position;position=self._getDistributedPosition(position);if(position===0){detractors+=summaryItem.count}else if(position===1){passives+=summaryItem.count}else{promoters+=summaryItem.count}});if(detractors+promoters+passives===0){score=0}else{score=Math.round(100*(promoters-detractors)/(detractors+promoters+passives))}return score},mergeCrossedRows:function(crossed_rows,crossedQuestion){var self=this,crossedRow,position,id,merged=[];_.each(crossed_rows,function(crossedRowID){crossedRow=crossedQuestion.answers[crossedRowID];position=self._getDistributedPosition(crossedRow.position);id=self.distributed[position].id;merged.push(id)});merged=_.uniq(merged);return merged},distributed:[{text:"Detractors (0-6)",visible:true,position:0,type:"row",id:"Detractors",question_id:null,mediaHTML:"Detractor",is_openended:false},{text:"Passives (7-8)",visible:true,position:1,type:"row",id:"Passives",question_id:null,mediaHTML:"Passive",is_openended:false},{text:"Promoters (9-10)",visible:true,position:2,type:"row",id:"Promoters",question_id:null,mediaHTML:"Promoter",is_openended:false}],detailed:[[1,2,3,4,5,6,7],[8,9],[10,11]],_getDistributedPosition:function(position){if(position<8){return 0}if(position<10){return 1}return 2},map2DistributedByQuestion:function(crossed_rows,crossedQuestion){var self=this,heading,letter_q=Globalize.localize("Question").substr(0,1),crossedRow,crossedRows=[];heading=letter_q+crossedQuestion.position+": ";_.each(crossed_rows,function(crossedRowID){crossedRow=_.findWhere(self.distributed,{id:crossedRowID});crossedRow=SM.Object.copy(crossedRow);crossedRow.text=heading+Globalize.localize(crossedRow.text);crossedRow.mediaHTML=null;crossedRow.question_id=crossedQuestion.ID;crossedRows.push(crossedRow)});return crossedRows},map2DistributedBySurvey:function(crossed_rows,survey){var self=this,crossedRow,position,distributedRow,distributedRows=[],distributedIndexes=[];_.each(crossed_rows,function(val,crossedRowID){crossedRow=survey.getAnswer(crossedRowID);position=self._getDistributedPosition(crossedRow.position);distributedIndexes.push(position)});distributedIndexes=_.uniq(distributedIndexes);_.each(distributedIndexes,function(index){distributedRow=SM.Object.copy(self.distributed[index]);distributedRows.push(distributedRow)});return distributedRows},getDetailedRows:function(position,crossedQuestion){var self=this,positions=self.detailed[position],type=crossedQuestion.family===SM.QuestionModel.QTYPE.single_choice?"row":"column";return _.map(positions,function(pos){return _.findWhere(crossedQuestion.answers,{position:pos,type:type})})},getDistributedOptions:function(crossed_rows,crossedQuestion){var self=this,crossedRow,position,heading,distributedRow,distributedRows=[],distributedIndexes=[];_.each(crossed_rows,function(val,crossedRowID){crossedRow=crossedQuestion.answers[crossedRowID];position=self._getDistributedPosition(crossedRow.position);distributedIndexes.push(position)});distributedIndexes=_.uniq(distributedIndexes);heading="Q"+crossedQuestion.position+": ";_.each(distributedIndexes,function(index){distributedRow=SM.Object.copy(self.distributed[index]);distributedRow.text=heading+distributedRow.text;distributedRow.question_id=crossedQuestion.ID;distributedRows.push(distributedRow)});return distributedRows},isDistributed:function(choiceRows,crossedQuestion){var self=this,crossedRow,position,numOfZeros=0,isDistributed=true,distributedOptionNumbers=[0,0,0],fullOptionNumbers=[7,2,2];_.each(choiceRows,function(val,crossedRowID){crossedRow=crossedQuestion.answers[crossedRowID];position=self._getDistributedPosition(crossedRow.position);distributedOptionNumbers[position]++});_.each(distributedOptionNumbers,function(number,index){if(number===0){numOfZeros++}else if(number!==fullOptionNumbers[index]){isDistributed=false}});if(numOfZeros===3){return false}return isDistributed}};SM.BasicStatsUtils={cols:[{text:"Minimum",visible:true,position:1,type:"column",id:"min",question_id:null},{text:"Maximum",visible:true,position:2,type:"column",id:"max",question_id:null},{text:"Median",visible:true,position:3,type:"column",id:"median",question_id:null},{text:"Mean",visible:true,position:4,type:"column",id:"mean",question_id:null},{text:"Standard Deviation",visible:true,position:5,type:"column",id:"std",question_id:null}],getStructure:function(type){var options=[];_.each(this.cols,function(col){var option=SM.Object.deepCopy(col);option.type=type||option.type;option.text=Globalize.localize(col.text);options.push(option)});return options},hasBasicStats:function(rollup){var values,valStats=[];if(rollup.summary.stats){return true}values=_.values(rollup.summary.options);_.each(values,function(val){var valStat=SM.Object.deepCopy(val);if(valStat.stats){valStats.push(valStat)}});if(_.size(values)>0){if(valStats.length>0){return true}values=_.values(values[0].options);if(_.size(values)>0&&values[0].stats){return true}}return false}};SM.SidiUtils={labelBySidi:function(rollup,crossedQuestion){var answers;if(crossedQuestion.hasRandomAssignment()){return}answers=rollup.crossed_cols||rollup.crossed_rows;if(_.size(answers)===0){answers=rollup.crossed_rows}_.each(answers,function(answerID,index){var answer=crossedQuestion.getAnswer(answerID);answer.sidiLabel=String.fromCharCode(65+index%26);if(Math.floor(index/26)>0){answer.sidiLabel+=Math.floor(index/26)+""}})},buildPhrase:function(ids,question){var sz=_.size(ids),sorted,removeLast,texts,str,last;sorted=_.sortBy(ids,function(id){return question.getAnswer(id).sidiLabel});switch(sz){case 0:str=null;break;case 1:str=question.getAnswer(sorted[0]).sidiLabel;break;default:last=[sorted[sz-1]];removeLast=sorted.slice(0,-1);texts=_.map(removeLast,function(id){return question.getAnswer(id).sidiLabel});str=texts.join(", ")+" and "+question.getAnswer(last[0]).sidiLabel;break}return str},join:function(ids,question){var sz=_.size(ids),sorted,texts,str;sorted=_.sortBy(ids,function(id){return question.getAnswer(id).sidiLabel});switch(sz){case 0:str=null;break;case 1:str=question.getAnswer(sorted[0]).sidiLabel;break;default:texts=_.map(sorted,function(id){return question.getAnswer(id).sidiLabel});str=texts.join("");break}return str}};SM.FiloUtils={formatSize:function(size){var sizeStr;if(size<1024){sizeStr=size+"bytes"}else if(size<1048576){sizeStr=parseInt(size/102.4,10)/10+"KB"}else if(size<1073741824){sizeStr=parseInt(size/104857.6,10)/10+"MB"}else{sizeStr=parseInt(size/107374182.4,10)/10+"GB"}return sizeStr}};SM.BaseAnView={currentSaveRequest:undefined,currentRevertRequest:undefined,isDefault:false,isCurrent:false,clone:function(name){var clone=this.dump(),view;clone.is_default=false;clone.is_current=false;clone.name=name||clone.name+" - "+Globalize.localize("COPY");view=SM.Models.create("AnView",{ID:"new_"+SM.Date.timestamp(),anView:clone});view.anviews=this.anviews;return view},save:function(){var request=SM.API.editView({view_data:this.dump(),view_id:this.ID});this.set("lastEditRequest",request);return request}};SM.Models.register("AnViewList",{viewMap:null,viewList:null,currentView:null,defaultView:null,nextSelectedViewID:null,selectedViewID:null,__create:function(options){var self=this;self.survey=options.survey;self.viewMap={};self.viewList=[]},createViewModels:function(viewData){var currentView=viewData.viewMap[viewData.currentViewID],defaultView=viewData.viewMap[viewData.defaultViewID];delete viewData.viewMap[viewData.currentViewID];delete viewData.viewMap[viewData.defaultViewID];this.selectedViewID=viewData.selectedViewID;this._initStandardViews(viewData);this.defaultView=this._initDefaultView(defaultView);this.currentView=this._initCurrentView(currentView);this.currentView.loadView(currentView);this.currentView.loadMetadata(currentView.metadata);this.currentView.on("isDirty.set",{self:this},this._onCurrentViewDirtySet)},__setters:{selectedViewID:function(self,val){var selectedView=self.getView(val),lastSelectedView=self.getView(self.selectedViewID);if(val===self.selectedViewID){return}if(self.currentView.get("isDirty")){self.set("nextSelectedViewID",val,{notify:true})}else{self.selectedViewID=val;self.updateSelectedView();selectedView.set("selected",true,{notify:true});lastSelectedView.set("selected",false,{notify:true})}}},addView:function(anView,isSelected){this.viewMap[anView.ID]=anView;this.viewList.push(anView);this._trigger({type:"viewAdded",anViewModel:anView,isSelected:isSelected});this._trigger("sizeChanged")},removeView:function(anViewModel){var self=this;$.each(this.viewList,function(i,viewItem){if(anViewModel.ID===viewItem.ID){self.viewList.splice(i,1);return false}});delete this.viewMap[anViewModel.ID];this._trigger("sizeChanged")},deleteView:function(anViewModel){var isDeletingSelectedView=anViewModel.ID===this.get("selectedViewID");if(isDeletingSelectedView){this.set("selectedViewID",this.defaultView.ID)}else if(this.get("nextViewID")===anViewModel.ID){this.set("nextViewID",null)}this.removeView(anViewModel);return SM.API.deleteView({view_id:anViewModel.ID})},copyView:function(anViewModel){var copy=anViewModel.clone(),request=SM.API.duplicateView({source_view_id:anViewModel.ID,name:copy.get("name")});this.addView(copy,false);$.when({self:this,tempID:copy.ID},request).done(this._onViewCopySuccess)
},_onViewCopySuccess:function(context,doneArgs){var self=context.self,data=doneArgs[0],anViewModel=self.getView(context.tempID);anViewModel.ID=data.new_view.view_id;self.viewMap[anViewModel.ID]=anViewModel;delete self.viewMap[context.tempID];anViewModel._trigger("copySuccess")},saveCurrentViewAs:function(name){var nextViewID=this.get("nextSelectedViewID"),currentView=this.currentView,copy=currentView.clone(name),context={self:this,tempID:copy.ID,switchToNewView:nextViewID===null,requestData:{source_view_id:currentView.ID,name:name}};currentView.set("isDirty",false,{notify:true});this.addView(copy,context.switchToNewView);this.currentView._trigger("savedToNewView");$.when(context,this.currentView.get("lastEditRequest")).always(this._makeSaveAsRequest);if(nextViewID){this.set("selectedViewID",nextViewID)}},_onViewSaveAsSuccess:function(context,doneArgs){var self=context.self,data=doneArgs[0],view=self.getView(context.tempID);view.ID=data.new_view.view_id;self.viewMap[view.ID]=view;delete self.viewMap[context.tempID];view._trigger("createSuccess");if(context.switchToNewView){self.set("selectedViewID",view.ID)}},getView:function(ID){if(this.currentView.ID===ID){return this.currentView}return this.viewMap[ID]},getSelectedView:function(){return this.getView(this.get("selectedViewID"))},_initCurrentView:function(currentView){var currentViewModel=SM.Models.create("CurrentAnView",{ID:currentView.view_id});currentViewModel.anviews=this;currentViewModel.on("committed",{self:this},this._onCurrentViewCommitted);return currentViewModel},_initDefaultView:function(defaultView){var self=this,defaultViewID=defaultView.view_id,defaultViewModel=SM.Models.create("DefaultAnView",{ID:defaultViewID,anView:defaultView,survey:self.survey});defaultViewModel.anviews=this;defaultViewModel.loadDisplayData();this.viewMap[defaultViewID]=defaultViewModel;this.viewList.push(defaultViewModel);return defaultViewModel},_makeSaveAsRequest:function(context){var request=SM.API.duplicateView(context.requestData);$.when(context,request).done(context.self._onViewSaveAsSuccess)},_initStandardViews:function(viewData){var self=this,viewMap=viewData.viewMap,view;$.each(viewMap,function(ID,anView){view=SM.Models.create("AnView",{ID:ID,anView:anView});self.viewMap[ID]=view;self.viewList.push(view);view.anviews=self})},updateSelectedView:function(){var context={pageIndex:this.survey.state.get("page"),self:this,timestamp:SM.Date.timestamp()},previousSwitchRequest=this.currentView.get("lastSwitchRequest");this.currentView.set("lastSwitchStamp",context.timestamp);this._trigger({type:"selectedViewChanged",viewID:this.get("selectedViewID")});$.when(context,previousSwitchRequest).always(function(){context.self._makeSwitchViewRequest(context)})},_makeSwitchViewRequest:function(context){var self=context.self,currentView=self.currentView,request,mode=self.survey.state.get("mode");if(currentView.get("lastSwitchStamp")===context.timestamp){request=SM.API.switchView({selected_view_id:self.get("selectedViewID"),utc_offset:SM.Date.utcOffset(),mode:mode});currentView.set("lastSwitchRequest",request,{notify:true});$.when(context,request).done(self._onViewSwitched).fail(function(data){self._onViewSwitchedFailed(context,data)})}},_onViewSwitched:function(context,response){var self=context.self,data=response[0],currentView=self.currentView,selectedViewID=data.current_view.selected_view_id,selectedView=self.getView(selectedViewID),metadata=selectedView.isDefault?selectedView.metadata:data.current_view.metadata;if(currentView.get("lastSwitchStamp")===context.timestamp){$.extend(true,[],data.current_view.metadata);selectedView.metadata=$.extend(true,[],metadata);currentView.loadView(data.current_view);currentView.loadMetadata(metadata);self._trigger({type:"selectedViewLoaded",anViewModel:selectedView,pageIndex:context.pageIndex,timestamp:context.timestamp,respondentData:data.respondent_data,benchmarkData:data.benchmark_data});selectedView.set("isLoaded",true,{notify:true})}},_onViewSwitchedFailed:function(context,errorData){var requestID=errorData&&errorData.request_id;this.currentView.set("failedLoadRequestID",requestID,{notify:true})},_onCurrentViewCommitted:function(e){var self=e.data.self,nextViewID=self.get("nextSelectedViewID");if(nextViewID){self.set("selectedViewID",nextViewID)}},_onCurrentViewDirtySet:function(e){var self=e.data.self;if(e.value===true&&self.nextSelectedViewID!==null){self.set("nextSelectedViewID",null,{notify:true})}}});SM.Models.extend("AnView",SM.BaseAnView,{__create:function(kwargs){var anView=kwargs.anView;this.ID=kwargs.ID;this.show=anView.show;if(this.show.selected===null){this.show.selected=false}this.metadata=anView.metadata;this.name=anView.name;this.viewType=anView.type;this.isDirty=false;this.loadFailed=false},dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:false,is_default:false,selected_view_id:null,name:this.name,page:null,show:this.show,type:this.viewType}}});SM.Models.extend("DefaultAnView",SM.BaseAnView,{__setters:{page:function(self,page){if(self.page!==page){self.page=page;if(!SM.App.isSharingApp()&&!self.survey.isReadOnly()){self.save()}}}},isDefault:true,_displayData:{},METADATA_COMPARE_PREFIX:"compare:",__create:function(options){var self=this,anView=options.anView;self.survey=options.survey;self.ID=options.ID;self.name=Globalize.localize(anView.name);self.viewType=anView.type;self.metadata=anView.metadata;self.page=anView.page;self.show={pages:null,questions:null,selected:false};self.filter=null;self.compare=null},loadDisplayData:function(){var self=this,questionID;_.each(self.metadata,function(metadatum){questionID=metadatum.question_id;if(!questionID){if(metadatum.value.dimensionID==="quiz_summary"){questionID=metadatum.value.dimensionID}}if(_.isEmpty(self._displayData[questionID])){self._displayData[questionID]={}}self._displayData[questionID][metadatum.key]=metadatum.value;if(metadatum.option_id==="None"){metadatum.option_id=null}})},appliedSidi:function(){var self=this,hasSidiApplied;hasSidiApplied=_.some(self._displayData,function(displayData){return displayData.show_sig_diffs===SM.QuestionDisplayModel.DISPLAY_VALUES.show});return hasSidiApplied},appliedSidiAll:function(){var self=this,displayData=self._displayData["0"];if(_.isEmpty(displayData)){return false}return displayData.show_sig_diffs===SM.QuestionDisplayModel.DISPLAY_VALUES.show},updateSidiAll:function(toApply){var self=this,updates;updates={show_sig_diffs:toApply?SM.QuestionDisplayModel.DISPLAY_VALUES.show:SM.QuestionDisplayModel.DISPLAY_VALUES.hide};self.updateSharedDisplayData({updates:updates,deletedKeys:["show_sig_diffs"],untypedKeys:SM.QuestionDisplayModel.UNTYPED_DISPLAY_OPTIONS,isCompared:true})},getDisplayData:function(questionID,options){var self=this,displayData=self._displayData[questionID],sharedDisplayData=self._displayData["0"],forTrends=!!(options&&options.forTrends);if(_.isEmpty(displayData)){displayData={}}if(!forTrends&&!!sharedDisplayData){displayData=SM.Object.extend(sharedDisplayData,displayData)}displayData=SM.Object.deepCopy(displayData);return displayData},_typifyUpdates:function(questionID,updates,options){var self=this,displayData=self.getDisplayData(questionID),typedUpdates={},typedKey,isCompared=options.isCompared,untypedKeys=options.untypedKeys,comparePrefix=self.METADATA_COMPARE_PREFIX;_.each(updates,function(value,key){typedKey=comparePrefix+key;if(isCompared){if(!untypedKeys[key]){typedUpdates[typedKey]=value}else{if(displayData[typedKey]!==undefined){typedUpdates[typedKey]=value}typedUpdates[key]=value}}else{typedUpdates[key]=value}if(questionID==="quiz_summary"){typedUpdates[key].dimensionID=questionID}});return typedUpdates},updateDisplayData:function(questionID,updates,options){var self=this,request,displayData=self._displayData[questionID],metadatum;options=options||{};if(_.isEmpty(displayData)){displayData=self._displayData[questionID]={}}updates=self._typifyUpdates(questionID,updates,options);_.each(updates,function(value,key){if(_.isEmpty(displayData[key])){metadatum=self.buildDisplayMetadatum(questionID,key,value);self.metadata.push(metadatum)}else{self.updateDisplayMetadatum(questionID,key,value)}displayData[key]=value});if(options.save!==false&&!self.survey.isReadOnly()){request=self.save();request.done(options.done).fail(options.fail)}},updateQuestionDisplayData:function(updates,questions,options){var self=this,isCompared=options.isCompared,untypedKeys=options.untypedKeys||{},request;_.each(questions,function(question){self.updateDisplayData(question.ID,updates,{save:false,isCompared:isCompared,untypedKeys:untypedKeys})});if(options.save!==false&&!self.survey.isReadOnly()){request=self.save();request.done(options.done).fail(options.fail)}},deleteDisplayData:function(questionIDs,keys,options){var self=this,request,isCompared=options.isCompared,untypedKeys=options.untypedKeys,compareKey,displayData,metadata,index;options=options||{};if(!_.isArray(questionIDs)){questionIDs=[questionIDs]}_.each(questionIDs,function(questionID){displayData=self._displayData[questionID];if(!_.isEmpty(displayData)){_.each(keys,function(key){compareKey=self.METADATA_COMPARE_PREFIX+key;key=isCompared&&!untypedKeys[key]?compareKey:key;delete displayData[key];metadata=_.filter(self.metadata,function(metadatum){return metadatum.question_id===questionID&&metadatum.view_id===self.ID&&metadatum.key===key});if(metadata){_.each(metadata,function(metadatum){index=_.indexOf(self.metadata,metadatum);self.metadata.splice(index,1)})}})}});if(options.save!==false&&!self.survey.isReadOnly()){request=self.save();request.done(options.done).fail(options.fail)}},updateSharedDisplayData:function(options){var self=this,request,updates=options.updates,deletedKeys=options.deletedKeys,untypedKeys=options.untypedKeys,isCompared=options.isCompared,npsDeletedKeys;var questionIDs=[],npsIDs=[];_.each(self.survey.questionRollups.questions,function(rollup){if(rollup.question.subtype==="net_promoter_score"){npsIDs.push(rollup.questionID)}else{questionIDs.push(rollup.questionID)}});self.updateDisplayData("0",updates,{save:false,isCompared:isCompared,untypedKeys:untypedKeys});self.deleteDisplayData(questionIDs,deletedKeys,{save:false,isCompared:isCompared,untypedKeys:untypedKeys});if(npsIDs.length>0){npsDeletedKeys=["show_chart","show_table"];self.deleteDisplayData(npsIDs,npsDeletedKeys,{save:false,isCompared:isCompared,untypedKeys:untypedKeys})}if(options.noSave!==false&&!self.survey.isReadOnly()){request=self.save();request.done(options.done).fail(options.fail)}},findMetadatumByQuestionIDAndKey:function(questionID,key){var self=this,metadatum;metadatum=_.filter(self.metadata,function(md){return md.key===key&&(md.question_id===questionID||!md.question_id&&md.value.dimensionID.indexOf("quiz_summary")===0)});return _.last(metadatum)},updateDisplayMetadatum:function(questionID,key,value){var self=this,metadatum=self.findMetadatumByQuestionIDAndKey(questionID,key);if(metadatum){metadatum.value=value}},buildDisplayMetadatum:function(questionID,key,value){var self=this;if(questionID==="quiz_summary"){return{view_id:self.ID,metadata_id:null,key:key,value:value}}return{view_id:self.ID,metadata_id:null,question_id:questionID,option_id:null,key:key,value:value}},isBenchmarkingShownForAnyQuestion:function(){var self=this,metadatumList;metadatumList=_.filter(self.metadata,function(md){return md.key==="show_benchmark"&&md.value==="show"});return metadatumList.length>0},setBenchmarkSegments:function(segmentList,options){var updates={updates:{benchmark_segments:segmentList},deletedKeys:["benchmark_segment"]};$.extend(updates,options);this.updateSharedDisplayData(updates)},getBenchmarkSegments:function(){var displayData=this.getDisplayData();return displayData.benchmark_segments},setDriverState:function(driverState,options){var updates={updates:{driver_state:driverState},deletedKeys:["show_tmbc_benchmark","tmbc_chart_type"]};$.extend(updates,options);this.updateSharedDisplayData(updates)},getDriverState:function(){var displayData=this.getDisplayData();return displayData.driver_state||{}},enableAllBenchmarks:function(enable){var self=this,metadatumList,showHide=enable?"show":"hide",update={show_benchmark:showHide},survey=self.anviews.survey,questionIds=survey.getAllBenchmarkableQuestionIds();_.each(questionIds,function(questionId){self.updateDisplayData(questionId,update,{save:false})});if(survey.isTMBCTemplate()){survey.tmbc.setTMBCShowHide(SM.TMBCModel.TMBC_TYPE_ALL,enable,{save:false})}metadatumList=_.filter(self.metadata,function(md){return md.key==="show_benchmark"&&md.value!==showHide});if(metadatumList.length>0){_.each(metadatumList,function(md){md.value=showHide});SM.API.logWarning({name:"Duplicate Metadata",message:"Survey "+survey.ID+" has "+metadatumList.length+" duplicate show_benchmark flags"})}metadatumList=_.filter(self.metadata,function(md){return md.key!=="show_tmbc_benchmark"&&md.key!=="tmbc_chart_type"});self.metadata=metadatumList;return survey.isReadOnly()?true:self.save()},enableDisableInlineProfiler:function(enable,done,fail){var updates={updates:{show_inline_profiler:enable?"show":"hide"}};if(done){updates.done=done}if(fail){updates.fail=fail}this.updateSharedDisplayData(updates)},dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,page:this.page,is_current:false,is_default:true,selected_view_id:null,name:this.name,filter:null,compare:null,type:this.viewType,show:{pages:null,questions:null,selected:false},metadata:this.metadata}},copy:function(){SM.Error.log({name:"DefaultViewCopyException",message:"Cannot copy the default view"})}});SM.Models.extend("CurrentAnView",SM.BaseAnView,{lastSaveTimeStamp:-1,lastSaveRequest:null,__setters:{isDirty:function(self,val,options){self.isDirty=val;self.anviews.getSelectedView().set("isDirty",val,options)},failedLoadRequestID:function(self,val){var hasFailed=val!==null;self.anviews.getSelectedView().set("loadFailed",hasFailed,{notify:hasFailed});self.failedLoadRequestID=val}},__create:function(kwargs){this.ID=kwargs.ID;this.isDirty=false;this.lastSwitchStamp=-1;this.lastSwitchRequest=null;this.rules=null;this.metadataLoaded=false;this.isCurrent=true;this.isSaving=false},loadView:function(anView){this.show=anView.show;this.viewType=anView.type;this.anviews.survey.updateShownLists(this.show,{notify:false});this.metadataLoaded=false},loadMetadata:function(metadata){var self=this,sortedRuleAttrs=[];this._clearRuleModels();this.metadata=metadata;_.each(metadata,function(metadataItem){if(self._metadataIsRule(metadataItem)){sortedRuleAttrs.push(metadataItem)}});sortedRuleAttrs.sort(function(a,b){return a.metadata_id-b.metadata_id});this._createRuleModels(sortedRuleAttrs);this.isDirty=false;this.metadataLoaded=true;this.set("failedLoadRequestID",null);this.set("isDirty",this._getDirtyState())},hasShowRule:function(){return this.showRule!==null},hasCompareRule:function(){return this.compareRule!==null},hasFilterRule:function(){var self=this;return _.size(self.getFilterRulesSelected())>0},getFilterRulesSelected:function(){var family_types=SM.BaseAnRule.FAMILY_TYPES,filtersSelected=[];_.each(this.ruleList,function(rule){if(rule.get("selected")&&rule.get("ruleFamily")===family_types.FILTER){filtersSelected.push(rule)}});return filtersSelected},getCompareRuleSelected:function(){var compareRule;_.each(this.ruleList,function(rule){if(rule.get("selected")&&rule.isCompare){compareRule=rule}});return compareRule},hasRAFilterSelected:function(){var self=this,filtersSelected,raFilter={};filtersSelected=self.getFilterRulesSelected();raFilter=_.find(filtersSelected,function(filter){return filter.isRA});return!!raFilter},hasRACompareSelected:function(){var self=this,compareSelected=self.getCompareRuleSelected();return compareSelected?compareSelected.isRA:false},deleteRule:function(id){var ruleList=this.ruleList;this._unbindRuleEvents(this.rules[id]);delete this.rules[id];$.each(ruleList,function(i,rule){if(id===rule.ID){ruleList.splice(i,1);return false}})},revert:function(){var selectedView=this.anviews.getSelectedView();this.loadView(selectedView.dump());this.set("isDirty",false,{notify:true});this.anviews.updateSelectedView()},commitChanges:function(){var selectedView=this.anviews.getSelectedView(),currentViewMetadata=this.dump().metadata,view;selectedView.metadata=currentViewMetadata;$.each(currentViewMetadata,function(i,metadataItem){metadataItem.metadata_id=null;metadataItem.view_id=selectedView.ID});selectedView.show=this.show;view=selectedView.dump();view.metadata=currentViewMetadata;this.set("isDirty",false,{notify:true});this._trigger("committed");return SM.API.editView({view_data:view,view_id:selectedView.ID})},addRule:function(ruleModel){this._bindRuleEvents(ruleModel);this.ruleList.push(ruleModel);this.rules[ruleModel.ID]=ruleModel;if(ruleModel.isShow){this._onShowRuleChanged(ruleModel);this.save()}else{if(ruleModel.isCompare&&ruleModel.get("selected")){if(this.compareRule){this.compareRule.set("selected",false,{notify:true})}this.compareRule=ruleModel}this.set("isSaving",true,{notify:true})}this._trigger({type:"ruleAdded",ruleModel:ruleModel})},dump:function(){var metadataList,selectedViewID=this.anviews.get("selectedViewID").toString();if(this.metadataLoaded){metadataList=[];_.each(this.ruleList,function(rule){if(!rule.get("isCorrupt")){metadataList.push(rule.dump())}})}return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:true,is_default:false,page:null,selected_view_id:selectedViewID,name:"Current View",show:this.show,type:this.viewType,metadata:metadataList}},hasActiveShowRule:function(){return this.show.selected},save:function(){var self=this,requestContext={self:this,timestamp:SM.Date.timestamp()};this.set("isSaving",true,{notify:true});this.set("isDirty",this._getDirtyState(),{notify:true});this.set("lastSaveTimeStamp",requestContext.timestamp);$.when(requestContext,this.get("lastSaveRequest")).always(function(){self._makeSaveRequest(requestContext)})},invalidateNewRules:function(){$.each(this.ruleList,function(i,ruleModel){if(!ruleModel.isPersisted()){ruleModel.set("isCorrupt",true,{notify:true})}})},_metadataIsRule:function(m){return m.key.indexOf(SM.BaseAnRule.BASE_RULE_METADATA_KEY)>=0},_getDirtyState:function(){var self=this,isDirty=false,currMetadata=this.dump().metadata,currLen=currMetadata.length,equalMetadata=false,selectedView=this.anviews.getSelectedView(),selectedMetadata=$.extend(true,[],selectedView.metadata);if(selectedView.isDefault){return this.ruleList.length>0}if(selectedMetadata.length!==currLen){return true}$.each(currMetadata,function(i,currMetadataItem){if(self._metadataIsRule(currMetadataItem)){isDirty=true;$.each(selectedMetadata,function(j,selectedMetadataItem){equalMetadata=self._checkMetadataEquality(currMetadataItem,selectedMetadataItem);if(equalMetadata){isDirty=false;selectedMetadata.splice(j,1);return false}});if(isDirty){return false}}});if(!isDirty){isDirty=!SM.Object.equals(this.show,selectedView.show)}return isDirty},_checkMetadataEquality:function(currMetadataItem,selectedMetadataItem){var isEqual=true;try{if(currMetadataItem.value.selected!==selectedMetadataItem.value.selected){isEqual=false}else{_.each(currMetadataItem.value,function(value,key){if(key!=="answers"){if(!SM.Object.equals(selectedMetadataItem.value[key],value)){isEqual=false;return}}});if(currMetadataItem.value.answers&&selectedMetadataItem.value.answers){if(!SM.Object.equals(currMetadataItem.value.answers[0],selectedMetadataItem.value.answers[0])){isEqual=false}}}}catch(e){SM.Error.log(e,"error comparing metadata");isEqual=false}return isEqual},_makeSaveRequest:function(requestContext){var self=this,request=SM.API.editView({view_data:this.dump(),view_id:this.ID});this.set("lastSaveRequest",request);$.when(request,requestContext).done(this._onSaveSuccess).always(function(){self._onSavedAlways(requestContext)})},_onShowRuleChanged:function(ruleModel){this.show=ruleModel.get("show");this.anviews.survey.updateShownLists(this.show,{notify:true});this._trigger({type:"showRuleChanged",ruleModel:ruleModel})},_createRuleModels:function(metadataList){var self=this,ruleJSON,ruleModel,params;$.each(metadataList,function(i,ruleMetadata){ruleJSON=ruleMetadata.value;params={ID:ruleMetadata.metadata_id,attrs:ruleJSON,isCorrupt:ruleMetadata.is_corrupt};ruleModel=SM.BaseAnRule.FactoryCreate(params,self.anviews.survey);ruleModel.loadSurvey(self.anviews.survey);if(ruleModel.isShow){self.showRule=ruleModel}if(ruleModel.isCompare&&ruleModel.get("selected")){self.compareRule=ruleModel}self.ruleList.push(ruleModel);self.rules[ruleModel.ID]=ruleModel;self._bindRuleEvents(ruleModel)})},_clearRuleModels:function(){var self=this;if(this.ruleList){$.each(this.ruleList,function(i,ruleModel){self._unbindRuleEvents(ruleModel)})}this.showRule=null;this.compareRule=null;this.ruleList=[];this.rules={}},_bindRuleEvents:function(ruleModel){ruleModel.on("customHeading.changed",{self:this},this._onRuleRenamed);ruleModel.on("ruleEdited",{self:this},this._onRuleEdited);ruleModel.on("ruleDeleted",{self:this},this._onRuleDeleted)},_unbindRuleEvents:function(ruleModel){ruleModel.off("customHeading.changed",this._onRuleRenamed);ruleModel.off("ruleEdited",this._onRuleEdited);ruleModel.off("ruleDeleted",this._onRuleDeleted)},_onRuleEdited:function(e){var ruleModel=e.ruleModel,lastCompareRule,self=e.data.self,selected=ruleModel.get("selected");if(ruleModel.isShow){self._onShowRuleChanged(ruleModel);self.save()}else{if(ruleModel.isCompare){lastCompareRule=self.compareRule;if(lastCompareRule&&ruleModel!==lastCompareRule&&ruleModel.get("selected")){lastCompareRule.set("selected",false,{notify:true})}self.compareRule=selected?ruleModel:null}self.set("isSaving",true,{notify:true})}self._trigger({type:"ruleEdited",ruleModel:ruleModel})},_onRuleRenamed:function(e){var self=e.data.self;self.save()},_onRuleDeleted:function(e){var self=e.data.self,ruleModel=e.ruleModel;self.deleteRule(ruleModel.ID);if(ruleModel.isShow){self.showRule=null;self._onShowRuleChanged(ruleModel);self.save()}else{if(!ruleModel.get("selected")){self.save()}else{if(ruleModel.isCompare){self.compareRule=null}self.set("isSaving",true,{notify:true})}}self._trigger({type:"ruleDeleted",ruleModel:ruleModel})},_onSaveSuccess:function(response,context){var data=response[0],newMetadataIDs=data.created_metadata_ids,self=context.self;if(self.get("lastSaveTimeStamp")===context.timestamp){self.metadata=data.view_edited.metadata;if(!newMetadataIDs){return}$.each(newMetadataIDs,function(persistedID,tempID){var newRule=self.rules[tempID];if(newRule){self.rules[persistedID]=newRule;delete self.rules[tempID];newRule.ID=persistedID}})}},_onSavedAlways:function(context){if(this.get("lastSaveTimeStamp")===context.timestamp){this.set("isSaving",false,{notify:true})}}});SM.Models.register("SharedView",{BASE_URL:"/results/ajax/shared_views",TYPES:{WEB_LINK:"weblink"},MODES:{SUMMARY:"summary",TRENDS:"trends",BROWSE:"browse"},BRANDING:{DEFAULT:"default",CUSTOM:"custom",NONE:"none"},__create:function(options){_.extend(this,{DEFAULT_NAME:Globalize.localize("Shared Data"),survey:options.survey,list:options.list,index:options.index,id:options.attrs.id});this.load(options.attrs)},isNew:function(){return!this.id},attributes:function(){var self=this,attrs={id:self.id,survey_id:self.get("survey_id"),default_view_id:self.get("default_view_id"),sharable_view_id:self.get("sharable_view_id"),key:self.get("key"),type:self.TYPES.WEB_LINK,domain:self.get("domain"),modes:self.get("modes"),enabled:self.get("enabled"),password:self.get("password"),name:self.get("name"),title:self.get("title"),description:self.get("description"),branding:self.get("branding"),hide_open_ended:self.get("hide_open_ended"),is_public:self.get("is_public"),team_only_share:self.get("team_only_share"),allow_team_export:self.get("allow_team_export")};if(!self.get("has_password")){attrs.password=null}if(!attrs.team_only_share){attrs.allow_team_export=false}return attrs},load:function(attrs){var self=this;self._setDefaults();_.each(attrs,function(v,k){self.set(k,v,{notify:false})});if(self.shareGroup()!==this.GROUP_SETTINGS.passwordShare){self.set("password",null)}},_setDefaults:function(){var subdomain,domain,segments;if(_.isEmpty(this.get("modes"))){this.set("modes",["summary"])}if(_.isEmpty(this.get("name"))){this.set("name",this._getDefaultName())}if(_.isEmpty(this.get("title"))){this.set("title",this.survey.get("title"))}if(_.isEmpty(this.get("domain"))){if(this.groupDomainLinkEnabled()){domain=this.survey.owner.getEnterpriseGroupDefaultDomain();subdomain=domain.split(".")[0]}else{subdomain=this.getCultureSubdomain();domain=new Uri(document.location.href).host();if(domain.indexOf(subdomain)!==0){segments=domain.split(".");segments[0]=subdomain;domain=segments.join(".")}}this.set("domain",domain)}if(_.isEmpty(this.get("type"))){this.set("type",this.TYPES.WEB_LINK)}if(_.isNull(this.get("enabled"))||_.isUndefined(this.get("enabled"))){this.set("enabled",true)}if(_.isNull(this.get("branding"))||_.isUndefined(this.get("branding"))){this.set("branding",this.BRANDING.DEFAULT)}if(_.isNull(this.get("hide_open_ended"))||_.isUndefined(this.get("hide_open_ended"))){this.set("hide_open_ended",true)}if(_.isNull(this.get("is_public"))||_.isUndefined(this.get("is_public"))){this.set("is_public",false)}if(_.isUndefined(this.get("allow_team_export"))){this.set("allow_team_export",false)}if(_.isNull(this.get("team_only_share"))||_.isUndefined(this.get("team_only_share"))){this.set("team_only_share",false)}},_getDefaultName:function(){var index=this.isNew()?this.survey.sharedViews.list.length:this.index;return this.DEFAULT_NAME+" "+Globalize.format(index+1,"n0")},loadView:function(view){this.sourceView=view},SHARED_VIEW_KEY:"SHARED_VIEWS_LIST",SHARED_VIEW_PATH_KEY:"{shared_view_path}",_getSharedViewOptions:function(postFix){var options={replacements:[]};postFix=postFix||"";if(this.isNew()){options.replacements.push({key:this.SHARED_VIEW_PATH_KEY,value:""})}else{options.replacements.push({key:this.SHARED_VIEW_PATH_KEY,value:"/"+this.key+postFix})}return options},save:function(){var self=this,attributes,request;self._setDefaults();attributes=self.attributes();SM.log(attributes);request=SM.API.post(this.SHARED_VIEW_KEY,attributes,self._getSharedViewOptions());$.when(request,{self:this}).done(function(doneArgs){var attrs=doneArgs[0].shared_view;self.load(attrs);self.survey.sharedViews.add(self);self._trigger("saved",{notify:true})}).fail(function(){SM.log("failed!")});return request},destroy:function(){var self=this,request;request=SM.API.destroy(this.SHARED_VIEW_KEY,{survey_id:self.get("survey_id")},self._getSharedViewOptions());$.when(request,{self:this}).done(function(){self.survey.sharedViews.remove(self)}).fail(function(){SM.log("destroy failed")});return request},isSocialShareable:function(){var shareGroup=this.shareGroup();return shareGroup===this.GROUP_SETTINGS.publicShare||shareGroup===this.GROUP_SETTINGS.linkShare},GROUP_SETTINGS:{publicShare:"share-group-public",enterpriseShare:"share-group-enterprise",passwordShare:"share-group-password",linkShare:"share-group-link"},shareGroup:function(){var self=this,shareGroup=null;if(self.isEnterpriseTeam()){shareGroup=this.GROUP_SETTINGS.enterpriseShare}else if(self.isPassword()){shareGroup=this.GROUP_SETTINGS.passwordShare}else if(self.isPublic()){shareGroup=this.GROUP_SETTINGS.publicShare}else{shareGroup=this.GROUP_SETTINGS.linkShare}return shareGroup},shareGroupLabel:function(){var self=this,shareGroup;if(self.isEnterpriseTeam()){shareGroup=Globalize.localize("Enterprise Group")}else if(self.hasPassword()){shareGroup=Globalize.localize("Password Restricted")}else if(self.isPublic()){shareGroup=Globalize.localize("Public")}else{shareGroup=Globalize.localize("Anyone with the Link")}return shareGroup},allowTeamExport:function(){return this.get("allow_team_export")},getCultureSubdomain:function(){var culture=Globalize.findClosestCulture(this.survey.language.code),uri;if(culture){switch(culture.language){case"en":return"www";case"ja":return"jp";default:return culture.language}}uri=new Uri(document.location.href);return uri.getSubDomains()[0]},sharedPageURL:function(){var url=new Uri;url.setProtocol("https");url.setHost(this.get("domain"));url.setPath(this.sharedPagePath());return url.toString()},sharedPagePath:function(){return"/results/"+this.key+"/"},toggleMode:function(mode,shouldBeDisplayed){var self=this,modes=self.get("modes"),isDisplayed=_.contains(modes,mode),index;if(shouldBeDisplayed&&!isDisplayed){modes.push(mode)}if(!shouldBeDisplayed&&isDisplayed){index=_.indexOf(modes,mode);modes.splice(index,1)}self.set("modes",modes)},hideOpenEnded:function(){return this.get("hide_open_ended")},hasCustomTitle:function(){var title=this.get("title");return!_.isEmpty(title)&&title!==this.survey.get("title")},hasDescription:function(){return!_.isEmpty(this.get("description"))},hasCustomName:function(){var name=this.get("name");return!_.isEmpty(name)&&name!==this._getDefaultName()},hasPassword:function(){return this.get("has_password")},canHavePassword:function(){return this.survey.owner.isPasswordEnabled()},canHaveTrends:function(){return this.survey.owner.hasTrends()},isTrendsTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.TRENDS)&&this.survey.owner.hasTrends()},isBrowseTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.BROWSE)},isEnabled:function(){return this.get("enabled")},isPublic:function(){return this.get("is_public")},isEnterpriseTeam:function(){return this.get("team_only_share")},isPassword:function(){return this.canHavePassword()&&this.hasPassword()},toggleEnabled:function(){this.set("enabled",!this.get("enabled"),{notify:true});this.save()},incrementNumViews:function(){SM.API.post(this.SHARED_VIEW_KEY,{survey_id:this.survey.ID},this._getSharedViewOptions("/increment"))},groupDomainLinkEnabled:function(){if(!this.survey.owner.enterprisePreferences){return false}return this.survey.owner.enterprisePreferences.custom_domain_enabled},getSelectedDomain:function(){return this.survey.owner.getEnterpriseGroupDefaultDomain()},canCustomizeBranding:function(){return this.survey.owner.canShareCustomizeBranding()},canCustomizeDomain:function(){return this.survey.owner.canShareCustomizeDomain()},hasHiddenBranding:function(){return this.get("branding")===this.BRANDING.NONE},setBranding:function(branding,isChecked){if(branding==="none"){branding=isChecked?this.BRANDING.NONE:this.BRANDING.DEFAULT}this.set("branding",branding)}});SM.Models.register("Survey",{TEMPLATE_TYPES:{SHRM:"SHRM",CSAT:"CSAT",EVENT:"EVENT",NPS:"NPS",TMBC:"TMBC"},TMBC_QUESTION_COUNT:8,DRIVER_TYPES:{TMBC:"tmbc",STD:"std"},__create:function(options){var survey_data=options.survey_data,pageModels;this.ID=survey_data.id;this.language=survey_data.language;this.dateCreated=new Date(survey_data.date_created);this.encryptedID=survey_data.mangled_id;this.templateInfo=survey_data.template_info||{};this.previewLink=survey_data.preview_link;this.resourcePath=survey_data.resource_path;this.themeSettings=survey_data.theme_settings;this.designSettings=survey_data.design_settings;this.hasLogic=survey_data.has_logic;this.hasRandomization=survey_data.has_randomization;this.hasPanelPage=survey_data.has_panel_page;this.includeOpenEnded=options.includeOpenEnded;this.isExport=options.isExport||false;this.exportFormat=options.exportFormat||null;this.exportData=options.exportData||{};this.title=survey_data.title;this.nickname=survey_data.nickname;this.surveyAlertsOn=survey_data.survey_alerts_on;this.pageIDs=survey_data.page_ids;this.pageCount=this.pageIDs.length;this.fullQuestionCount=survey_data.question_count;this.respondentCounts={};this.loadCollectors(survey_data.collectors);this.collectorCount=survey_data.collector_count;this.hasEmailCollector=survey_data.has_email_collector;this.hasOpenCollectors=survey_data.has_open_collector;this.hasCollectors=survey_data.has_collector;this.hasUnconfiguredCollector=survey_data.has_unconfigured_collector;this.hasAllClosedCollectors=survey_data.has_all_closed_collectors;
this.isQuiz=survey_data.is_quiz;this.showQuizSummary=survey_data.is_quiz;if(survey_data.source_surveys){this.createSourceSurveys(survey_data.source_surveys);this.isMergedSurvey=true;this.source_surveys_question_id=survey_data.source_surveys_question_id}pageModels=this._createPageModels({pageIDs:this.pageIDs,survey_data:survey_data,npsEnabled:options.npsEnabled,mode:options.mode});this.pages=pageModels.pages;this.pageList=pageModels.pageList;this.questions=pageModels.questions;this.questionList=pageModels.questionList;this.hasQuestions=pageModels.questionList.length>0;this.searchTerms=pageModels.searchTerms;this.answers=pageModels.answers;this.questionCount=this.questionList.length;this.quotas=survey_data.quotas;this.nltkOptionEnabled=survey_data.nltk_option_enabled;this.currentUserBenchmarksEnabled=survey_data.current_user_benchmarks_enabled},__setters:{respondentCounts:function(self,counts){if(!counts||counts.failed){self.respondentCounts={failed:true}}else{SM.Object.update(self.respondentCounts,counts);self.respondentCounts.failed=false}}},ID:"",encryptedID:"",title:"",nickname:"",pageIDs:[],pages:{},pageList:[],pageCount:0,fullQuestionCount:0,questions:{},questionList:[],questionCount:0,questionRollups:null,answers:{},searchTerms:null,respondentsList:null,respondentCounts:{},collectors:{},collectorList:[],hasEmailCollector:false,hasOpenCollectors:false,owner:null,anviews:null,SEARCH_NGRAM_SIZE:2,shownPageList:[],shownQuestionList:[],updateShownLists:function(showState,options){var pageList=this.pageList,pageCount=pageList.length,i=0,j,page,pageIndex,questionList,question,questionCount,notify=options.notify&&true;this.shownPageList=[];this.shownQuestionList=[];for(;i<pageCount;i++){page=pageList[i];page.shownQuestionList=[];if(page.isShown(showState)){this.shownPageList.push(page);questionList=page.questionList;questionCount=questionList.length;for(j=0;j<questionCount;j++){question=questionList[j];if(question.isShown(showState)){page.shownQuestionList.push(question);this.shownQuestionList.push(question)}}}}pageIndex=this._validatePage();this.state.set("page",pageIndex);if(notify){this._trigger("shownListsChanged")}},_validatePage:function(){var pageModel,pageIndex=this.state.get("page"),isAllPagesSelected=this.state.get("allPagesSelected");if(!isAllPagesSelected){pageModel=this.pageList[pageIndex];if(!pageModel.isShown()){pageModel=this.getFirstShownPage();return pageModel.position-1}}return pageIndex},getPage:function(id){return this.pages[id]},getQuestion:function(id){if(id==="merveySources"||id===this.getSourceSurveysQuestionId()){return this.getSourceSurveys()}return this.questions[id]},getSourceSurveysQuestionId:function(){return this.source_surveys_question_id},getSourceSurvey:function(sid){var self=this;return self.sourceSurveysModel.getAnswer(sid)},createSourceSurveys:function(source_surveys){var self=this,structure={answers:{},id:"merveySources",type:{family:"single_choice",subtype:"vertical"},headings:[{heading:""}],is_merged_survey:true};structure.answers.rows=source_surveys;self.sourceSurveysModel=SM.Models.create("Question",{structure:structure});self.sourceSurveysModel.loadAnswers(structure);return self.sourceSurveysModel},getSourceSurveys:function(){return this.sourceSurveysModel},getAnswer:function(id){return this.answers[id]},getRespondentByID:function(id){return this.respondentsList.map[id]},getRespondentByOffset:function(offset){return this.respondentsList.getOffset(offset)},getCollector:function(id){return this.collectors[id]},getRollup:function(questionID){if(this.questionRollups){return this.questionRollups.questions[questionID]||null}},getRandomAssignmentRollup:function(questionID,optionTypeID){var question;if(this.questionRollups){question=this.questionRollups.questions[questionID];if(question.nestedQuestionDict[optionTypeID]){return question.nestedQuestionDict[optionTypeID]}return this.getRollup(questionID)}},getBenchmarkRollup:function(questionID){if(this.benchmarkRollups){return this.benchmarkRollups.getRollup(questionID)}},getLastShownPage:function(){var count=this.shownPageList.length;if(!count){return null}return this.shownPageList[count-1]},getNextShownPage:function(currentPageIndex){var pageList=this.pageList,i=currentPageIndex+1,page,pageCount=pageList.length;for(;i<pageCount;i++){page=pageList[i];if(page.isShown()){return page}}return null},getPrevShownPage:function(currentPageIndex){var pageList=this.pageList,i=currentPageIndex-1,page;for(;i>=0;i--){page=pageList[i];if(page.isShown()){return page}}return null},getFirstShownPage:function(){var count=this.shownPageList.length;if(!count){return null}return this.shownPageList[0]},getShownQuestionIDs:function(pageIndex){var shownList;if(pageIndex!=="all"){shownList=this.survey.pageList[pageIndex].shownQuestionList}else{shownList=this.shownQuestionList}return $.map(shownList,function(question){return question.ID})},getQuestionTrend:function(questionID){if(this.trendsModel&&this.trendsModel.questionTrends){return this.trendsModel.questionTrends.questionMap[questionID]}},getResponsesTrend:function(){if(this.trendsModel&&this.trendsModel.responseTrends){return this.trendsModel.responseTrends}},getSelectedView:function(){return this.anviews.getView(this.anviews.get("selectedViewID"))},loadViews:function(viewData){this.anviews=SM.Models.create("AnViewList",{survey:this});this.anviews.createViewModels(viewData)},loadOwner:function(owner){this.owner=SM.Models.create("User",{ID:owner.id,user:owner.features,groupPreferences:owner.group_preferences});this.owner.survey=this},loadCurrentUser:function(currentUser){this.currentUserID=currentUser.id;this.currentUserEmail=currentUser.email;this.isCurrentUserReadOnly=currentUser.analyze==="read_only";this.isCurrentUserCreateReadOnly=currentUser.create==="read_only";this.isCurrentUserCollectNoAccess=currentUser.collect==="no_access"},loadRespondents:function(respondentData){var selectedOffset=respondentData.status===0?respondentData.data.respondent_offset:null;this.respondentsList=SM.Models.create("RespondentList",{selectedOffset:selectedOffset});this.respondentsList.loadSurvey(this);if(respondentData.status===0&&this.respondentCounts.total_context){this.respondentsList.loadRespondents(respondentData.data.respondents)}else if(respondentData.status!==0){this.respondentsList.set("failedLoad",true);this.respondentsList.set("failedLoadRequestID",respondentData.request_id)}},loadQuestionRollups:function(respondentData){var self=this;self.questionRollups=SM.Models.create("QuestionRollupList");self.questionRollups.loadSurvey(self);if(respondentData.status===0){self.questionRollups.loadRollups(respondentData.data.question_rollups);if(self.isQuiz){self.quizSummaryModel=SM.Models.create("QuizSummary",{survey:this,quizSummary:respondentData.data.question_rollups.quiz_summary})}}else{self.questionRollups.set("failedLoad",true);self.questionRollups.set("failedLoadRequestID",respondentData.request_id)}},loadSurveyTrends:function(respondentData){var respData=respondentData.data;this.trendsModel=SM.Models.create("SurveyTrends");this.trendsModel.loadSurvey(this);if(respondentData.status===0){if(respData.survey_respondent_trends){this.trendsModel.loadResponsesTrends(respData)}if(respData.question_responses_trends){this.trendsModel.loadQuestionTrends(respData.question_responses_trends,respData.trend_range)}}else{this.trendsModel.set("failedLoad",true);this.trendsModel.set("failedLoadRequestID",respondentData.request_id)}},loadAnalyzeState:function(state){this.state=SM.Models.create("AnalyzeState",state);this.state.survey=this},loadExportJobs:function(){this.exportJobs=SM.Models.create("ExportJobList",{config:this.config});this.exportJobs.survey=this;this.exportJobs.poller=SM.Models.create("ExportJobPoller",{config:this.config.export_poller});this.exportJobs.poller.loadJobs(this.exportJobs)},loadSharedViews:function(){this.sharedViews=SM.Models.create("SharedViewList",{survey:this});this.sharedViews.fetch()},loadConfig:function(config){this.config=config;this.config.export_formats_enabled_server_side=SM.Object.deepCopy(this.config.export_formats_enabled)},loadBenchmarkRollups:function(benchmarkRollups){this.benchmarkRollups=SM.Models.create("QuestionBenchmarkRollups",{survey:this});if(benchmarkRollups.status===0){this.benchmarkRollups.loadRollups(benchmarkRollups.data)}else{this.benchmarkRollups.set("failedLoad",true);this.benchmarkRollups.set("failedLoadRequestID",benchmarkRollups.request_id)}},loadDriverRollups:function(driverRollups){if(!this.driverRollups){this.driverRollups=SM.Models.create("DriverBenchmarkRollups",{survey:this})}if(driverRollups.status===0){this.driverRollups.loadRollups(driverRollups.data)}else{this.driverRollups.set("failedLoad",true);this.driverRollups.set("failedLoadRequestID",driverRollups.request_id)}},isExportFormatTypeEnabled:function(format,type){var formatsEnabled=this.config.export_formats_enabled[type];return!!(formatsEnabled[format]&&this.config.exports_enabled)},isExportEnabled:function(){return this.config.exports_enabled},isSharingEnabled:function(){return this.config.sharing_enabled},searchQuestions:function(searchTerm){var searchRanking={},results=[],searchTerms=this.searchTerms,words=searchTerm.toLowerCase().split(/[\s,-,?,!,(,)]+/),wordCount=words.length,ngramSize=this.SEARCH_NGRAM_SIZE,i=0,j,word,ngram,partialMatch,match,matches,matchCount,id;for(;i<wordCount;i++){word=words[i];ngram=word.substring(0,ngramSize);partialMatch=i+1===wordCount&&ngram===word;if(ngram in searchTerms){matches=searchTerms[ngram];matchCount=matches.length;for(j=0;j<matchCount;j++){match=matches[j];if(partialMatch||match.word.substring(0,word.length)===word){id=match.id;if(id in searchRanking){searchRanking[id]++}else{searchRanking[id]=1;results.push(id)}}}}}return results.sort(function(a,b){return searchRanking[b]-searchRanking[a]})},hasRespondents:function(){return this.respondentCounts.total>0},hasFilteredRespondents:function(){return this.respondentCounts.total_context>0},decrementRespondentCounts:function(){var self=this,counts={};$.each(this.respondentCounts,function(countKey,count){if(count!==null&&count!==undefined&&countKey!=="failed"){counts[countKey]=self.respondentCounts[countKey]-1}});this.set("respondentCounts",counts,{notify:true})},getRespondentUrl:function(respondentID){return"/analyze/browse/"+this.encryptedID+"?respondent_id="+respondentID},_createPageModels:function(options){var i,pageID,term,survey_data=options.survey_data,pageIDs=options.pageIDs,pageMap=survey_data.pages,questionMap=survey_data.questions,pages={},pageList=[],questions={},questionList=[],answers={},searchTerms={},pageCount=pageIDs.length,pageModel,page;for(i=0;i<pageCount;i++){pageID=pageIDs[i];page=pageMap[pageID];pageModel=SM.Models.create("Page",{ID:pageID,structure:page});pageModel.survey=this;pageModel.loadQuestions({questionMap:questionMap,questionIDs:page.question_ids,npsEnabled:options.npsEnabled,mode:options.mode});if(i===pageCount-1){pageModel.isPanelPage=this.hasPanelPage}pages[pageID]=pageModel;pageList.push(pageModel);SM.Object.update(questions,pageModel.questions);SM.Object.update(answers,pageModel.answers);for(term in pageModel.searchTerms){if(searchTerms[term]){searchTerms[term]=searchTerms[term].concat(pageModel.searchTerms[term])}else{searchTerms[term]=pageModel.searchTerms[term]}}questionList=questionList.concat(pageModel.questionList)}return{pages:pages,pageList:pageList,questions:questions,questionList:questionList,answers:answers,searchTerms:searchTerms}},isFiltered:function(){return this.respondentCounts.matching!==null&&this.respondentCounts.matching!==undefined},loadCollectors:function(collectorList){var map={},formattedTypes={weblink:"Web Link",email:"Email",audience:"Targeted Audience",popup:"Website Survey",facebook:"Facebook Link"},maxTitleLength=30,mdate,year,month,date,formattedDate;if(collectorList){this.collectorList=$.map(collectorList,function(collector_data){var collector={id:collector_data.collector_id,title:SM.String.truncateMiddle(SM.Html.strip(collector_data.title),maxTitleLength),dateCreated:new Date(collector_data.date_created),isOpen:collector_data.is_open,isClosed:collector_data.is_closed,isClearing:collector_data.is_clearing_responses,isUnconfigured:collector_data.is_new,isArchived:collector_data.is_archived,type:collector_data.collector_type,formattedType:Globalize.localize(formattedTypes[collector_data.collector_type]),isFacebook:collector_data.is_facebook,isLink:collector_data.is_weblink,isAudience:collector_data.is_audience,isEmail:collector_data.is_email,isPopup:collector_data.is_popup,link:collector_data.link,entity_id:collector_data.entity_id,formattedResponseCount:Globalize.format(collector_data.response_count,"n0")};mdate=SM.TrendLib.localize(collector_data.date_created);year=mdate.year();month=mdate.month();date=mdate.date();formattedDate=new Date(year,month,date);collector.formattedDate=Globalize.format(formattedDate,"d");map[collector.id]=collector;return collector})}this.collectors=map},hasTextAnalysis:function(){return this.owner.hasTextAnalysis()},getCountOfBenchmarkableQuestions:function(){var count=0;_.each(this.pages,function(page){count+=page.getCountOfBenchmarkableQuestions()});return count},getAllBenchmarkableQuestionIds:function(){var questionIds=[];_.each(this.pages,function(page){questionIds=questionIds.concat(page.getAllBenchmarkableQuestionIds())});return questionIds},getAllBenchmarkableQuestionLogicalIds:function(){var logicalIds=[];_.each(this.pages,function(page){logicalIds=logicalIds.concat(page.getAllBenchmarkableQuestionLogicalIds())});return logicalIds},getIndexOfFirstPageWithQuestions:function(){var thePage=_.find(this.pageList,function(page){return page.questionList.length>0});return thePage?thePage.index:0},hasSHRMQuestion:function(){var thePage=_.find(this.pages,function(page){if(page.hasSHRMQuestion()){return true}});return!_.isUndefined(thePage)},hasCSATQuestion:function(){var thePage=_.find(this.pages,function(page){if(page.hasCSATQuestion()){return true}});return!_.isUndefined(thePage)},hasEventQuestion:function(){var thePage=_.find(this.pages,function(page){if(page.hasEventQuestion()){return true}});return!_.isUndefined(thePage)},hasNPSQuestion:function(){var thePage=_.find(this.pages,function(page){if(page.hasNPSQuestion()){return true}});return!_.isUndefined(thePage)},getTemplateID:function(){return this.templateInfo.template_id},getTemplateType:function(){return this.templateInfo.template_type},getTemplateName:function(){return this.templateInfo.template_name},validateTMBCTemplate:function(){var tmbcQuestions;tmbcQuestions=_.filter(this.questions,function(question){if(question.is_tmbc&&!question.structure.is_edited){return true}});tmbcQuestions=_.uniq(tmbcQuestions);if(tmbcQuestions.length!==this.TMBC_QUESTION_COUNT){return false}return true},isSHRMTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.SHRM.toUpperCase()},isNPSTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.NPS.toUpperCase()},isCSATTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.CSAT.toUpperCase()},isEVENTTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.EVENT.toUpperCase()},isTMBCTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.TMBC},isStoreTemplate:function(){var templateType=this.getTemplateType();return templateType&&templateType!==this.TEMPLATE_TYPES.TMBC},isGenericTemplate:function(){return!this.getTemplateType()},getDriverType:function(){if(this.isTMBCTemplate()){return this.DRIVER_TYPES.TMBC}return this.DRIVER_TYPES.STD},hasProfiledCollector:function(){var collectors=_.filter(this.collectorList,function(collector){if(collector.entity_id!=="verified.0"){return collector}});return collectors.length>0},hasValidEntity:function(){return!!this.profiler&&this.profiler.hasValidEntity()||this.hasProfiledCollector()},isProfilerDriverEnabled:function(){var hasValidEntity=this.hasValidEntity(),hasCollectorProfile=this.hasProfiledCollector(),hasPaidBenchmark=this.dataSegmentList.hasPaidBenchmarks(),hasRestricted=this.dataSegmentList.hasRestrictedFeatures(),hasOptOut=this.owner.hasBenchmarkingOptOut(),benchmarksShown=this.anviews.defaultView.isBenchmarkingShownForAnyQuestion(),questionSet=this.getTemplateName(),geiShown;if(!this.profiler){return false}if(!this.isCurrentUserAlsoOwner()){return false}if(this.getCountOfBenchmarkableQuestions()>0){if(this.isTMBCTemplate()){geiShown=this.validateTMBCTemplate()&&this.hasValidEntity()}if(this.owner.benchmarkingHasOptOut||!this.hasValidEntity()){benchmarksShown=false}SM.Bi.logUserProfileState(hasValidEntity,hasCollectorProfile,hasOptOut,hasRestricted,hasPaidBenchmark,benchmarksShown,questionSet,geiShown)}return!hasValidEntity&&!hasRestricted},shouldShowProfiler:function(){if(this.owner.hasBenchmarkingRestricted()||!this.isCurrentUserAlsoOwner()&&(this.currentUserBenchmarksEnabled||!this.owner.hasBenchmarkingOptOut())){return false}return!this.owner.benchmarkingOptOutWasSet||!this.hasValidEntity()&&!this.owner.benchmarkingHasOptOut},isProfilerDialogEnabled:function(){if(!this.profiler){return false}if(!this.isCurrentUserAlsoOwner()){return false}if(this.owner.hasBenchmarkingRestricted()){return false}return this.shouldShowProfiler()||this.owner.hasBenchmarkingOptOut()},canShowBenchmarking:function(){if(!this.isCurrentUserAlsoOwner()){if(!this.profiler){return false}if(this.owner.canShowBenchmarking()||this.owner.hasBenchmarkingRestricted()){return true}if(this.currentUserBenchmarksEnabled){return true}if(this.profiler.shouldShowProfiler()||this.owner.hasBenchmarkingOptOut()){return false}}return this.owner.canShowBenchmarking()},isOwner:function(userID){return userID===this.owner.ID},isCurrentUserAlsoOwner:function(){return this.isOwner(this.currentUserID)},isReadOnly:function(){return this.isCurrentUserReadOnly},triggerProfileSaved:function(){this._trigger({type:"profiler:profile_saved"})},filoDownload:function(ids){var idsStr;if($.isArray(ids)){idsStr=ids.join(",")}else{idsStr=ids}window.location=this.filoPreviewUrl(idsStr)},filoPreviewUrl:function(id){return"/analyze/files/download/?survey_id="+this.ID+"&files="+id},filoDelete:function(files){var res=[];if(files.length===0){return}_.each(files,function(file){res.push({respondent_id:file.respondent_id,collector_id:file.collector_id,collection_mode:file.collection_mode})});SM.API.filoDelete({survey_id:this.ID,question_id:files[0].question_id,respondents:res})},getQuizSummary:function(){return this.quizSummaryModel}});SM.Models.register("User",{UNLIMITED:"unlimited",__create:function(options){this.ID=options.ID;this.packageType=options.user.package_type;this.responseLimit=options.user.analyze_response_limit;this.responseDeleteLimit=options.user.analyze_response_delete_limit;this.ruleLimit=options.user.analyze_rule_limit;this.textAnalysIsEnabled=options.user.analyze_ta_enabled;this.hasDismissedTaUpgrade=false;this.hasDismissedFiloUpgrade=false;this.shareCustomizeBrandingEnabled=options.user.analyze_can_share_customize_branding;this.shareCustomizeDomainEnabled=options.user.analyze_can_share_customize_domain;this.customizeChartsEnabled=options.user.analyze_can_customize_charts;this.saveViewEnabled=options.user.analyze_can_save_views;this.passwordEnabled=options.user.analyze_password_enabled;this.trendsEnabled=options.user.analyze_trends_enabled;this.sharingEnabled=options.user.sharing_enabled;this.hipaaEnabled=options.user.hipaa_enabled;this.sigDiffsEnabled=options.user.show_sig_diffs_enabled;this.exportEnabled=options.user.analyze_export_enabled;this.hideExportBranding=options.user.analyze_can_export_hide_branding;this.logoEnabled=options.user.create_logo_enabled;this.logicEnabled=options.user.create_skip_logic_enabled;this.fileUploadEnabled=options.user.file_upload_question_type;this.email=options.user.email||"";this.benchmarkingEnabled=options.user.benchmarking_enabled;this.benchmarkingRestrictedEnabled=options.user.benchmarking_restricted_enabled;this.benchmarkingHasOptOut=options.user.benchmarking_has_opt_out;this.benchmarkingOptOutWasSet=options.user.benchmarking_opt_out_was_set;this.whiteLabel=options.user.white_label;this.disabledExports={spss:!options.user.analyze_export_spss_enabled,ppt:!this.canExportPPT()};this.enterprisePreferences=options.groupPreferences},isOverResponseLimit:function(responseCount){return this.responseLimit!==this.UNLIMITED&&this.responseLimit<responseCount},hasRuleLimit:function(){return this.ruleLimit!==this.UNLIMITED},isOverRuleLimit:function(){var ruleList=this.survey.anviews.currentView.ruleList;if(!this.hasRuleLimit()){return false}if(!ruleList){return this.ruleLimit===0}return ruleList.length>=this.ruleLimit},canCustomizeCharts:function(){return this.customizeChartsEnabled},canSaveView:function(){return this.saveViewEnabled},isFiloEnabled:function(){return this.fileUploadEnabled},hasTextAnalysis:function(){return this.textAnalysIsEnabled},hasExports:function(){return this.exportEnabled},canExport:function(format){if(this.exportEnabled){return!this.disabledExports[format]}return false},canExportPPT:function(){return this.exportEnabled},hasTrends:function(){return this.trendsEnabled},isPasswordEnabled:function(){return this.passwordEnabled},hasSharing:function(){return this.sharingEnabled},hasBenchmarking:function(){return this.benchmarkingEnabled&&!SM.App.isSharingApp()&&!this.survey.isExport},hasBenchmarkingRestricted:function(){return this.benchmarkingRestrictedEnabled&&this.hasBenchmarking()},hasBenchmarkingOptOut:function(){return this.benchmarkingOptOutWasSet&&this.benchmarkingHasOptOut},canShowBenchmarking:function(){if(this.hasBenchmarkingRestricted()){return true}return this.hasBenchmarking()&&!this.hasBenchmarkingOptOut()},canHideExportBranding:function(){return this.hideExportBranding},canSigDiffs:function(){return this.sigDiffsEnabled},canExportTA:function(){return this.textAnalysIsEnabled},canShareCustomizeBranding:function(){return this.shareCustomizeBrandingEnabled},canShareCustomizeDomain:function(){return this.shareCustomizeDomainEnabled},getEnterpriseGroupDefaultDomain:function(){return this.enterprisePreferences.selected_domain||null},getEnterpriseGroupDomains:function(){return $.map(this.enterprisePreferences.custom_domains,function(domain){return{domain:domain}})}});SM.Models.register("QuizSummary",{QTYPE:{open_ended:"open_ended",datetime:"datetime",demographic:"demographic",numerical:"numerical",nps:"net_promoter_score",single_choice:"single_choice",multiple_choice:"multiple_choice",horiz:"horiz",matrix:"matrix",menu:"menu",menu_matrix:"menu_matrix",single:"single",simple:"simple",rating_scale:"rating",ranking:"ranking",essay:"essay",other_option:"other_option",presentation:"presentation",multi:"multi",descriptive_text:"descriptive_text",image:"image"},ID:"quiz_summary",title:"",number:null,family:null,subtype:null,displayType:null,displaySubType:null,searchTerms:{},options:null,colList:[],colChoices:{},page:null,commentField:null,randomAssignmentMap:null,__create:function(options){var structure=options.quizSummary,totalScore=structure.avg_score.total,rows=[],i;for(i=0;i<10;++i){rows.push({id:i+"",value:(i+1)*totalScore+""})}structure.answers={rows:rows};this.survey=options.survey;this.logicalID=structure.logical_id;this.logicalName=structure.logical_name;this.logicalLangId=structure.logical_lang_id;this.structure=structure;this.headings=[];this.heading="Quiz Summary";this.position=structure.position;this.loadAnswers();this.rollup=SM.Models.create("QuestionRollup",{question:this});this.rollup.load({type:"simple",answered:structure.answered,skipped:structure.skipped,summary:structure.summary})},hasRollupLoaded:function(){var model=this.getRollup();return model&&model.type!=="null_rollup"},hasTrendLoaded:function(){return false},getContextStructure:function(){if(this.isCompared()){return this.compareStructure}return this.structure},getContextAnswerStructure:function(){return this.compositeAnswerStructure?this.compositeAnswerStructure:this.getContextStructure().answers},isShown:function(){return true},getRollup:function(){return this.rollup},setCompareStructure:function(){return},loadAnswers:function(){var self=this,rows=self.structure.answers.rows,rowCount=rows.length,i,row;self.answers={};for(i=0;i<rowCount;i++){row=rows[i];self.answers[row.id]=row;row.is_openended=false}},getAnswer:function(id){return this.answers[id]},summaryType:function(){return this.getRollup().summary.type},depthType:function(){return"single"},isSimple:function(){return true},isSingleChoice:function(){return true},isMultipleChoice:function(){return false},isNPS:function(){return false},isTop2:function(){return false},isCompared:function(){return false},isNumerical:function(){return false},isMatrix:function(){return false},isMenuMatrix:function(){return false},isEmoji:function(){return false},isOpenEnded:function(){return false},isMultiResponse:function(){return false},isSimpleRating:function(){return false},isBenchmarkable:function(){return false},canSidi:function(){return false},canCombineHide:function(){return true},hasRandomAssignment:function(){return false},getCombineHideDim:function(){return"rows"},buildCompositeAnswerStructure:function(){},isQuiz:function(){return false}});SM.Models.register("Page",{__create:function(options){var page=options.structure;this.ID=options.ID;this.heading=SM.Html.strip(page.heading);this.shortHeading=SM.String.truncate(this.heading,17);this.position=page.position;this.hasHeading=this.heading.length>0;this.index=page.position-1;this.subheading=page.subheading;this.editLink=page.edit_link},ID:"",heading:"",position:null,index:null,subheading:"",questions:{},questionList:[],questionCount:null,answers:{},searchTerms:{},survey:null,shownQuestionList:[],loadedQuestionMap:{},isPanelPage:false,loadQuestions:function(options){var i=0,questionMap=options.questionMap,questionIDs=options.questionIDs,question,questionModel,questionID,term,list=[],map={},answers={},searchTerms={},questionCount=questionIDs.length;for(;i<questionCount;i++){questionID=questionIDs[i];question=questionMap[questionID];if(question.type.family==="presentation"&&!question.has_random_assignment){continue}questionModel=SM.Models.create("Question",{ID:question.id,structure:question,page:this,npsEnabled:options.npsEnabled,mode:options.mode});map[question.id]=questionModel;list.push(questionModel);questionModel.loadAnswers(question);questionModel.loadIntoSearch();for(term in questionModel.searchTerms){if(searchTerms[term]){searchTerms[term]=searchTerms[term].concat(questionModel.searchTerms[term])}else{searchTerms[term]=questionModel.searchTerms[term]}}SM.Object.update(answers,questionModel.answers)}this.questions=map;this.questionList=list;this.questionCount=this.questionList.length;this.answers=answers;this.searchTerms=searchTerms},isShown:function(showState){var shownPages;showState=showState||this.survey.anviews.currentView.show;shownPages=showState.pages;return!showState.selected||shownPages&&shownPages[this.ID]},getCountOfBenchmarkableQuestions:function(){var count=0;_.each(this.questions,function(question){if(question.isBenchmarkable()){count=count+1}});return count},getAllBenchmarkableQuestionIds:function(){var questionIds=[];_.each(this.questions,function(question){if(question.isBenchmarkable()){questionIds.push(question.ID)}});return questionIds},getAllBenchmarkableQuestionLogicalIds:function(){var questionIds=[];_.each(this.questions,function(question){if(question.isBenchmarkable()){questionIds.push(question.logicalID)}});return questionIds},hasSHRMQuestion:function(){var questionId=_.find(this.questions,function(question){if(question.is_shrm){return true}});return!_.isUndefined(questionId)},hasCSATQuestion:function(){var questionId=_.find(this.questions,function(question){if(question.is_csat){return true}});return!_.isUndefined(questionId)},hasEventQuestion:function(){var questionId=_.find(this.questions,function(question){if(question.is_event){return true}});return!_.isUndefined(questionId)},hasNPSQuestion:function(){var questionId=_.find(this.questions,function(question){if(question.isNPS()){return true}});return!_.isUndefined(questionId)},validateTMBCQuestions:function(){var badQuestion=_.find(this.questions,function(question){if(!question.is_tmbc||question.structure.is_edited){return true}});return _.isUndefined(badQuestion)}});SM.Models.register("Question",{QTYPE:{open_ended:"open_ended",datetime:"datetime",demographic:"demographic",numerical:"numerical",nps:"net_promoter_score",single_choice:"single_choice",multiple_choice:"multiple_choice",horiz:"horiz",matrix:"matrix",menu:"menu",menu_matrix:"menu_matrix",single:"single",simple:"simple",rating_scale:"rating",ranking:"ranking",essay:"essay",other_option:"other_option",presentation:"presentation",multi:"multi",descriptive_text:"descriptive_text",image:"image"},displaySubTypeMap:{star:83,heart:107,smiley:258,thumb:256},compareMap:{single_choice:"matrix",multiple_choice:"matrix",matrix:"menu_matrix",open_ended:"matrix",demographic:"matrix",datetime:"matrix"},ID:null,title:"",number:null,family:null,subtype:null,displayType:null,displaySubType:null,searchTerms:{},options:null,rowList:[],colList:[],colChoices:{},page:null,survey:null,commentField:null,randomAssignmentMap:null,__create:function(options){var self=this,structure=options.structure,questionHeading;self.page=options.page;self.survey=options.page?options.page.survey:null;if(structure.type.subtype===self.QTYPE.rating_scale&&structure.type.family===self.QTYPE.matrix){self.name=structure.type.name}self.is_shrm=structure.type.is_shrm;self.is_nps=structure.type.is_nps;self.is_event=structure.type.is_event;self.is_csat=structure.type.is_csat;self.is_tmbc=structure.type.is_tmbc;self.is_top_2=structure.type.is_top_2;self.is_quiz=structure.type.is_quiz;self.analysis_type=structure.type.analysis_type;if(options.npsEnabled&&options.mode==="summary"&&self.is_nps){structure=SM.ComparedByNps.structure(structure)}self.npsEnabled=options.npsEnabled;self.is_merged_survey=structure.is_merged_survey;self.ID=structure.id;self.logicalID=structure.logical_id;self.logicalName=structure.logical_name;self.logicalLangId=structure.logical_lang_id;self.structure=structure;self.headings=structure.headings;self.heading=SM.String.text(DOMPurify.sanitize(self.headings[0].heading));self.position=structure.position;self.family=structure.type.family;self.subtype=structure.type.display_type==="file_upload"?"file_upload":structure.type.subtype;self.displayType=structure.type.display_type;self.displaySubType=structure.type.display_subtype;self.randomAssignmentList=[];_.each(self.headings,function(variation){var heading=variation.heading,ra_variation,image_type;if(heading===""){heading=variation.description}variation.heading=DOMPurify.sanitize(heading);if(variation.random_assignment){ra_variation={heading:variation.heading,percent:variation.random_assignment.percent,variable_id:variation.random_assignment.variable_id,variable_name:variation.random_assignment.variable_name};if(variation.image){if(variation.image.s3_key){image_type="s3"}else if(variation.image.url.indexOf("http://")===0||variation.image.url.indexOf("https://")===0){image_type="url"}else{image_type="upload"}ra_variation.image={source:variation.image.s3_key===""?variation.image.url:variation.image.s3_key,type:image_type,url:variation.image.url}}self.randomAssignmentList.push(ra_variation)}});self.sanitizeRAList(self.randomAssignmentList);questionHeading=typeof SM.AnalyzeApp!=="undefined"&&"defaultRAHeader"in SM.AnalyzeApp?SM.AnalyzeApp.defaultRAHeader:SM.raHeader||"A/B Test";if(self.isPresentation()){self.heading=structure.nickname||questionHeading}else if(self.headings.length>1){self.heading=questionHeading}self.searchTerms={};self._models={}},loadIntoSearch:function(){this._addToSearchTerms("Q"+this.position);this._addToSearchTerms(this.heading)},hasRollupLoaded:function(){var model=this.getRollup();return model&&model.type!=="null_rollup"},hasTrendLoaded:function(){var model=this.getTrend();
return model.get("isLoaded")},hasRandomAssignment:function(){return!!this.randomAssignmentList&&this.randomAssignmentList.length>0},isAfterLastLoadedRollup:function(){return this.survey.questionRollups.isAfterLastLoadedQuestion(this)},isAfterLastLoadedTrend:function(){return this.survey.trendsModel.questionTrends.isAfterLastLoadedQuestion(this)},setCompareStructure:function(compareStructure){this.compareStructure=compareStructure},isComparable:function(){return!!this.compareMap[this.family]&&!(this.subtype===this.QTYPE.menu&&this.family===this.QTYPE.matrix)},hasComparableOptions:function(){return this.family===this.QTYPE.matrix&&this.subtype!==this.QTYPE.menu||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice},isBenchmarkable:function(){var self=this,structure=self.structure;if(!structure.is_benchmarkable){return false}if(self.isNPS()&&_.size(structure.answers.rows)!==11){return false}return true},hasChartView:function(){return this.family===this.QTYPE.matrix||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice||this.subtype===this.QTYPE.numerical},hasTACloud:function(){return this.getRollup().hasTaModels()&&!this.isFileUpload()},hasCloudView:function(){return this.hasTACloud()&&!this.hasRandomAssignment()&&!this.isDateTime()&&!this.isNumerical()&&!this.shouldDisableWordCloud()},getCompareType:function(){return this.compareMap[this.family]},getContextStructure:function(){if(this.isCompared()){return this.compareStructure}return this.structure},getContextAnswerStructure:function(isTop2){var compositeAnswerStructure=isTop2?this.top2compositeAnswerStructure:this.compositeAnswerStructure;if(compositeAnswerStructure){return compositeAnswerStructure}return this.getContextStructure().answers},isCompared:function(){return this.compareStructure!==undefined},isShown:function(showState){var state=showState||this.survey.anviews.currentView.show,shownQuestions=state.questions;return!state.selected||shownQuestions&&shownQuestions[this.ID]},getRollup:function(){var hasRandomAssignment=!!(this.randomAssignmentList&&this.randomAssignmentOption);if(hasRandomAssignment){return this.getRandomAssignmentRollup()}return this.survey.getRollup(this.ID)},getBenchmarkRollup:function(){return this.survey.benchmarkRollups.getRollup(this.ID)},getRandomAssignmentRollup:function(){return this.survey.getRandomAssignmentRollup(this.ID,this.randomAssignmentOption)},getRandomAssignmentOption:function(option_id){this.randomAssignmentMap=this.randomAssignmentMap||this._createRandomAssignmentMap();return this.randomAssignmentMap[option_id]},_createRandomAssignmentMap:function(){var randomAssignmentMap={},randomAssignmentList=this.randomAssignmentList,variableID;_.each(randomAssignmentList,function(randomAssignmentOption){variableID=randomAssignmentOption.variable_id;randomAssignmentMap[variableID]=randomAssignmentOption});return randomAssignmentMap},getTrend:function(){return this.survey.getQuestionTrend(this.ID)},getResponse:function(respondentID){var respondent=this.survey.respondentsList.map[respondentID];return respondent.getResponse(this.ID)},getCrossedQuestion:function(){var survey=this.survey,currentView=survey.anviews.currentView;if(this.isCompared()&&currentView.compareRule){return survey.getQuestion(currentView.compareRule.get("questionID"))}},loadAnswers:function(structure){var self=this;this.answers={};if(structure.answers.rows){if(!structure.is_merged_survey){this._parseRowAnswers(structure.answers.rows)}else{_.each(structure.answers.rows,function(row){self.answers[row.id]=row})}this.rowList=structure.answers.rows}else{structure.answers.rows=[]}if(structure.answers.cols){this._parseColAnswers(structure.answers.cols);this.colList=structure.answers.cols;if(this.subtype==="ranking"){this._initRankingWeights()}}if(structure.answers.other){this._parseOtherAnswers(structure.answers.other);this.commentFieldList=structure.answers.other;this.commentField=this.commentFieldList[0]}},getAnswer:function(id){return this.answers[id]},buildCompositeAnswerStructure:function(settings,isTop2){var self=this,structure=self.getContextStructure(),answerStructure=structure.answers,dim=self.getCombineHideDim(),dimensionTypeMaping,compositeAnswerStructure,combinedComposites,hiddenIDs,hiddenComposites,compositeCopy,compositeDimensionCopy,newComposite,minId,weightMax;if(!settings){if(isTop2){self.top2compositeAnswerStructure=null;self.top2hiddenComposites=[];self.top2combinedComposites=[]}else{self.compositeAnswerStructure=null;self.hiddenComposites=[];self.combinedComposites=[]}return}dimensionTypeMaping={rows:"row",cols:"column"};compositeAnswerStructure=SM.Object.deepCopy(answerStructure);combinedComposites=[];_.each(settings.combines,function(combineObj){_.each(compositeAnswerStructure[dim],function(composite){compositeCopy=SM.Object.deepCopy(composite);compositeCopy.combineId=combineObj.id;if(_.contains(combineObj.combine,composite.id)){combinedComposites.push(compositeCopy)}})});if(isTop2){self.top2combinedComposites=combinedComposites}else{self.combinedComposites=combinedComposites}_.each(settings.combines,function(combineObj){_.each(combineObj.combine,function(combineItem){compositeAnswerStructure[dim]=_.reject(compositeAnswerStructure[dim],function(composite){return composite.id===combineItem})})});hiddenIDs=_.pluck(settings.hides,"id");hiddenComposites=[];if(_.size(hiddenIDs)!==0){_.each(compositeAnswerStructure[dim],function(composite){if(_.contains(hiddenIDs,composite.id)){hiddenComposites.push(SM.Object.deepCopy(composite))}})}if(isTop2){self.top2hiddenComposites=hiddenComposites}else{self.hiddenComposites=hiddenComposites}_.each(settings.hides,function(hideObj){compositeAnswerStructure[dim]=_.reject(compositeAnswerStructure[dim],function(composite){return composite.id===hideObj.id})});_.each(settings.combines,function(combineObj){newComposite={text:combineObj.title,visible:true,position:999,type:dimensionTypeMaping[dim],isCombined:true,id:combineObj.id,question_id:self.ID,is_openended:false};if(self.isRating()){minId=_.min(combineObj.combine,function(id){return id});newComposite.weight=_.findWhere(answerStructure[dim],{id:minId}).weight}compositeAnswerStructure[dim].push(newComposite)});compositeAnswerStructure[dim]=_.sortBy(compositeAnswerStructure[dim],function(composite){return composite.id});if(self.isRanking()){compositeDimensionCopy=[];weightMax=_.size(compositeAnswerStructure[dim]);_.each(compositeAnswerStructure[dim],function(composite,index){compositeCopy=SM.Object.deepCopy(composite);compositeCopy.weight=weightMax-index;compositeDimensionCopy.push(compositeCopy)});compositeAnswerStructure[dim]=compositeDimensionCopy}if(isTop2){self.top2compositeAnswerStructure=compositeAnswerStructure}else{self.compositeAnswerStructure=compositeAnswerStructure}},buildCompositeMapping:function(settings,isTop2){var self=this,structure=self.getContextStructure(),answerStructure=structure.answers,dim=self.getCombineHideDim(),compositeAnswerStructure=isTop2?self.top2compositeAnswerStructure:self.compositeAnswerStructure,compositeMapping={},answer,originals,existingCombine;_.each(compositeAnswerStructure[dim],function(composite){existingCombine=_.findWhere(settings.combines,{id:composite.id});if(existingCombine){originals=existingCombine.combine;_.each(originals,function(original){answer=_.findWhere(answerStructure[dim],{id:original});compositeMapping[answer.id]=composite})}else{answer=_.findWhere(answerStructure[dim],{id:composite.id});compositeMapping[answer.id]=composite}});_.each(settings.hides,function(hideObj){answer=_.findWhere(answerStructure[dim],{id:hideObj.id});compositeMapping[answer.id]=null});return compositeMapping},getCombineHideDim:function(){var self=this;if(self.isCompared()){if(self.isMenuMatrix()){return null}return"rows"}if(self.isSimple()){return"rows"}if(self.isMatrix()){return"cols"}return null},canCombineHide:function(){var self=this;if(self.isCompared()&&self.isMenuMatrix()){return false}if(self.isOpenEnded()){return false}if(self.hasRandomAssignment()){return false}if(self.isNPS()){return false}return this.isSimple()||this.isMatrix()},otherIsAnAnswerChoice:function(){var self=this,structure=self.getContextStructure(),answerStructure=structure.answers;return answerStructure.other!==undefined&&answerStructure.other[0].options.is_answer_choice},isOther:function(id){var self=this,structure=self.getContextStructure(),answerStructure=structure.answers;return answerStructure.other!==undefined&&answerStructure.other[0].id===id},summaryType:function(){var self=this,rollup=self.getRollup(),summary=rollup.summary;return self.isCompared()?summary.summary.type:summary.type},depthType:function(){var self=this;if(self.isMatrix()){if(self.isMenuMatrix()){return self.QTYPE.menu_matrix}return self.QTYPE.matrix}return self.QTYPE.single},isNPS:function(){var self=this;if(!self.npsEnabled){return false}return this.is_nps},isSimple:function(){if(this.isCompared()){return false}return this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice},isSingleChoice:function(){return this.family===this.QTYPE.single_choice},isMultipleChoice:function(){return this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.multi},isNumerical:function(){return this.subtype===this.QTYPE.numerical},isMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix}return this.family===this.QTYPE.matrix},isMenuMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix&&this.compareStructure.type.subtype===this.QTYPE.menu}return this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.menu},isMultiResponse:function(){return this.family==="multiple_choice"||this.family==="open_ended"&&(this.subtype==="multi"||this.isNumerical())||this.family==="demographic"||this.family==="datetime"||this.family==="matrix"&&this.subtype==="multi"},isOpenEnded:function(){return this.family==="open_ended"||this.family==="demographic"||this.family==="datetime"},isPresentation:function(){return this.family===this.QTYPE.presentation},isEssay:function(){return this.family==="open_ended"&&(this.subtype==="essay"||this.subtype==="single")},isFileUpload:function(){return this.family==="open_ended"&&this.subtype==="file_upload"},isRating:function(){return this.subtype==="rating"},isRanking:function(){return this.subtype==="ranking"},isDateTime:function(){return this.family===this.QTYPE.datetime},isDemographic:function(){return this.family===this.QTYPE.demographic},isSimpleRating:function(){return this.subtype==="rating"&&!this.isCompared()&&_.size(this.structure.answers.rows)===1},isEmoji:function(){return this.displayType==="emoji"},isTop2:function(){return this.is_top_2},isTop2Ascending:function(){return this.analysis_type==="top_2_asc"},isQuiz:function(){return this.is_quiz},canSidi:function(){var self=this;if(self.isOpenEnded()){return false}if(self.hasRandomAssignment()){return false}if(self.isNPS()){return false}return this.isCompared()&&(this.isSimple()||this.isMatrix())},hasCommentsPerRow:function(){return!!(this.structure.answers.other&&this.structure.answers.other[0].options.apply_all_rows)},shouldDisableWordCloud:function(){return!!this.structure.validation&&!!this.structure.validation.type&&(this.structure.validation.type==="integer"||this.structure.validation.type.indexOf("date")!==-1||this.structure.validation.type==="email")},getOpenEndedType:function(){var family=this.family,subtype=this.subtype;if(family==="open_ended"){return subtype}if(family==="demographic"||family==="datetime"){return family}},labelByWeights:function(questionAnswerStructures){var self=this,dimension,lastIndex=0,answerStructures=SM.Object.deepCopy(questionAnswerStructures),others=answerStructures.other,otherOption,otherIsAnswer;if(self.compositeAnswerStructure||self.isNPS()||self.isRanking()||!self.getRollup().display.getDisplayData().show_basic_stats){return answerStructures}if(self.isSimple()){dimension="rows"}else if(self.isNumerical()){return answerStructures}else if(self.isCompared()){if(self.isMenuMatrix()){dimension="cols"}else{dimension="rows"}}else if(self.isMenuMatrix()){dimension="columnChoices"}else if(self.isMatrix()){dimension="cols"}if(dimension==="rows"){_.each(answerStructures.rows,function(row,index){row.text+=" ("+(index+1)+")";if(row.mediaHTML){row.mediaHTML+=" ("+(index+1)+")"}lastIndex=index+1})}else if(dimension==="cols"){_.each(answerStructures.cols,function(column,index){if(!column.options.is_na){column.text+=" ("+(index+1)+")";if(column.mediaHTML){column.mediaHTML+=" ("+(index+1)+")"}lastIndex=index+1}})}else{_.each(answerStructures.cols,function(column){_.each(column.items,function(columnChoice,index){columnChoice.text+=" ("+(index+1)+")";if(columnChoice.mediaHTML){columnChoice.mediaHTML+=" ("+(index+1)+")"}lastIndex=index+1})})}otherIsAnswer=others!==undefined&&others[0].options.is_answer_choice;if(otherIsAnswer){otherOption=answerStructures.other[0];otherOption.text+=" ("+(lastIndex+1)+")"}return answerStructures},_initRankingWeights:function(){var colList=this.colList,len=this.colList.length;$.each(colList,function(i,col){if(col.options.is_na){len--}});$.each(colList,function(i,col){if(col.options.is_na){col.options.weight=0}else{col.options.weight=len-i}})},_parseAnswers:function(rows,isOpenEnded){var rowCount=rows.length,i=0,row,answerMap=this.answers;for(;i<rowCount;i++){row=rows[i];this.sanitizeAnswer(row);answerMap[row.id]=row;this._addToSearchTerms(row.text);row.is_openended=isOpenEnded}},_parseOtherAnswers:function(otherAnswers){this._parseAnswers(otherAnswers,true)},_parseRowAnswers:function(rows){this._parseAnswers(rows,this.isOpenEnded())},_parseColAnswers:function(cols){var len=cols.length,i,j,answerMap=this.answers,col,choices,choiceCount,choice;for(i=0;i<len;i++){col=cols[i];this.sanitizeAnswer(col);if(col.options.is_na){this.naCol=col}answerMap[col.id]=col;this._addToSearchTerms(col.text);choices=col.items?col.items:[];choiceCount=choices.length;for(j=0;j<choiceCount;j++){choice=choices[j];this.sanitizeAnswer(choice);answerMap[choice.id]=choice;this._addToSearchTerms(choice.text)}}if(this.naCol&&this.naCol.position===0){cols.shift();cols.push(this.naCol);this.naCol.position=len}},_addToSearchTerms:function(searchItem){var words=searchItem.toLowerCase().split(/[\s,-,?,!,(,),\/]+/),wordCount=words.length,ngramSize=this.survey.SEARCH_NGRAM_SIZE,searchTerms=this.searchTerms,i=0,word,ngram;for(;i<wordCount;i++){word=words[i];ngram=word.substring(0,ngramSize);if(!word.length){continue}else if(ngram in searchTerms){searchTerms[ngram].push({word:word,id:this.ID})}else{searchTerms[ngram]=[{word:word,id:this.ID}]}}},mungeCompareMenuMatrix:function(rollup,crossedQuestion,mergeNPS){var heading,crossedColID,crossedRow,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRowID,crossedCol,compareStructure,structure=this.structure,rowList=this.rowList,rowLen=rowList.length,colList=this.colList,colLen=colList.length,items,i=0,j=0;compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"menu"};if(!mergeNPS){for(i=0;i<colLen;i++){compareStructure.answers.cols[i].items=[];for(j=0;j<answers.length;j++){heading=crossedQuestion.is_merged_survey?"Survey: ":"Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.cols[i].items[j]=crossedCol}else{crossedRowID=rollup.crossed_rows[j];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);if(!crossedQuestion.isEmoji()){heading=heading+crossedRow.text}compareStructure.answers.cols[i].items[j]=crossedRow}compareStructure.answers.cols[i].items[j].text=heading}}for(i=0;i<rowLen;i++){compareStructure.answers.rows[i].items=[];for(j=0;j<answers.length;j++){heading=crossedQuestion.is_merged_survey?"Survey: ":"Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.rows[i].items.push(crossedCol)}else{crossedRowID=rollup.crossed_rows[j];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);if(!crossedQuestion.isEmoji()){heading=heading+crossedRow.text}compareStructure.answers.rows[i].items.push(crossedRow)}compareStructure.answers.rows[i].items[j].text=heading}if(!compareStructure.answers.crossedOptions){compareStructure.answers.crossedOptions=compareStructure.answers.rows[i].items}}}else{items=SM.ComparedByNps.map2DistributedByQuestion(rollup.crossed_rows,crossedQuestion);_.each(compareStructure.answers.cols,function(col,index){compareStructure.answers.cols[index].items=_.map(items,_.clone)});_.each(compareStructure.answers.rows,function(row,index){compareStructure.answers.rows[index].items=_.map(items,_.clone)});if(!compareStructure.answers.crossedOptions){compareStructure.answers.crossedOptions=items}}return compareStructure},mungeCompareMenuMatrixRA:function(rollup,crossedQuestion){var heading,crossedColID,crossedRow,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRowID,crossedCol,compareStructure,structure=this.structure,rowList=this.rowList,rowLen=rowList.length,colList=this.colList,colLen=colList.length,i=0,j=0,k;if(answers.length===0){answers=rollup.crossed_rows}compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"menu"};for(i=0;i<colLen;i++){compareStructure.answers.cols[i].items=[];for(j=0;j<answers.length;j++){heading="Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.cols[i].items[j]=crossedCol}else{crossedRowID=rollup.crossed_rows[j];for(k=0;k<crossedQuestion.randomAssignmentList.length;k++){if(crossedRowID===crossedQuestion.randomAssignmentList[k].variable_id){crossedRow=crossedQuestion.randomAssignmentList[k];break}}crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading}else{heading+=crossedRow.variable_name}crossedRow.position=j+1;crossedRow.question_id=parseInt(crossedQuestion.ID,10);crossedRow.visible=true;crossedRow.type="col";compareStructure.answers.cols[i].items[j]=crossedRow}compareStructure.answers.cols[i].items[j].text=heading}}for(i=0;i<rowLen;i++){compareStructure.answers.rows[i].items=[];for(j=0;j<answers.length;j++){heading=crossedQuestion.is_merged_survey?"Survey: ":"Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[j];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.rows[i].items.push(crossedCol)}else{crossedRowID=rollup.crossed_rows[j];for(k=0;k<crossedQuestion.randomAssignmentList.length;k++){if(crossedRowID===crossedQuestion.randomAssignmentList[k].variable_id){crossedRow=crossedQuestion.randomAssignmentList[k];break}}crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading}else{heading+=crossedRow.variable_name}crossedRow.position=j+1;crossedRow.question_id=parseInt(crossedQuestion.ID,10);crossedRow.visible=true;crossedRow.type="row";compareStructure.answers.rows[i].items.push(crossedRow)}compareStructure.answers.rows[i].items[j].text=heading}if(!compareStructure.answers.crossedOptions){compareStructure.answers.crossedOptions=compareStructure.answers.rows[i].items}}return compareStructure},mungeCompareMatrix:function(rollup,crossedQuestion,mergeNPS){var structure=this.structure,compareStructure,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRow,crossedRowID,crossedColID,crossedCol,heading,i;compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"single"};if(!mergeNPS){compareStructure.answers.cols=[];for(i=0;i<answers.length;i++){heading=crossedQuestion.is_merged_survey?"Survey: ":"Q"+crossedQuestion.position+": ";if(rollup.crossed_cols){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[i];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.cols[i]=crossedCol}else{crossedRowID=rollup.crossed_rows[i];crossedRow=crossedQuestion.answers[crossedRowID];crossedRow=SM.Object.copy(crossedRow);if(!crossedQuestion.isEmoji()){heading=heading+crossedRow.text}compareStructure.answers.cols[i]=crossedRow}compareStructure.answers.cols[i].text=heading}}else{compareStructure.answers.cols=SM.ComparedByNps.map2DistributedByQuestion(rollup.crossed_rows,crossedQuestion)}compareStructure.answers.crossedOptions=compareStructure.answers.cols;if(this.isEssay()||this.isFileUpload()){compareStructure.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}]}return compareStructure},mungeCompareMatrixRA:function(rollup,crossedQuestion){var structure=this.structure,compareStructure,answers=rollup.crossed_cols||rollup.crossed_rows,crossedRow,crossedRowID,crossedColID,crossedCol,heading,i,j;if(answers.length===0){answers=rollup.crossed_rows}compareStructure=SM.Object.deepCopy(structure);compareStructure.type={family:"matrix",subtype:"single"};compareStructure.answers.cols=[];for(i=0;i<answers.length;i++){heading=crossedQuestion.is_merged_survey?"Survey: ":"Q"+crossedQuestion.position+": ";if(rollup.crossed_cols&&rollup.crossed_cols.length>0){crossedRowID=rollup.crossed_rows[0];crossedRow=crossedQuestion.answers[crossedRowID];crossedColID=rollup.crossed_cols[i];crossedCol=crossedQuestion.answers[crossedColID];crossedCol=SM.Object.copy(crossedCol);if(!crossedQuestion.isEmoji()){heading=heading+[crossedRow.text,crossedCol.text].join(": ")}else{heading=heading+crossedCol.text}compareStructure.answers.cols[i]=crossedCol}else{crossedRowID=rollup.crossed_rows[i];for(j=0;j<crossedQuestion.randomAssignmentList.length;j++){if(crossedRowID===crossedQuestion.randomAssignmentList[j].variable_id){crossedRow=crossedQuestion.randomAssignmentList[j];break}}crossedRow=SM.Object.copy(crossedRow);crossedRow.id=crossedRow.variable_id.toString();if(crossedRow.heading){heading+=crossedRow.heading}else{heading+=crossedRow.variable_name}compareStructure.answers.cols[i]=crossedRow}compareStructure.answers.cols[i].text=heading}compareStructure.answers.crossedOptions=compareStructure.answers.cols;if(this.isEssay()||this.isFileUpload()){compareStructure.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}]}return compareStructure},getSidiOptions:function(answerID,crossOptionId,captionId){var self=this,rollup=self.getRollup(),crossedQuestion=self.getCrossedQuestion(),groups,hides,sidiData,sidiOption;if(rollup.combinehideModel.isCombined(answerID)){sidiOption={isCombined:true,answerID:answerID,hasSidi:false};return sidiOption}hides=rollup.combinehideModel.getHides();if(_.size(hides)>0){sidiOption={hasHidden:true,answerID:answerID,hasSidi:false};return sidiOption}sidiData=rollup.getSidiData(answerID,crossOptionId,captionId);if(!sidiData||!sidiData.enough_responses){return null}if(!sidiData.has_significant_diffs){sidiOption={noSidi:true,hasSidi:false};return sidiOption}sidiOption={p:sidiData.p,confidence_level:sidiData.confidence_level,hasSidi:true};sidiOption.higherGroups=SM.SidiUtils.buildPhrase(sidiData.higher_diffs,crossedQuestion);sidiOption.hasHigherGroups=sidiOption.higherGroups!==null;sidiOption.lowerGroups=SM.SidiUtils.buildPhrase(sidiData.lower_diffs,crossedQuestion);sidiOption.hasLowerGroups=sidiOption.lowerGroups!==null;groups=sidiData.higher_diffs.concat(sidiData.lower_diffs);sidiOption.groups=SM.SidiUtils.join(groups,crossedQuestion);sidiOption.answerID=answerID;return sidiOption},sanitizeRAList:function(randomAssignmentList){var self=this,generatedVariableName;if(!!randomAssignmentList&&randomAssignmentList.length){if(this.isPresentation()){_.each(randomAssignmentList,function(variable,i){var id=i+1;if(variable.variable_name.length===0){if(self.subtype===self.QTYPE.image){generatedVariableName=Globalize.localize("Image Random Assignment - Image")+" "+id}else{generatedVariableName=Globalize.localize("Text Random Assignment - Text")+" "+id}variable.variable_name=generatedVariableName}},self)}return randomAssignmentList}return[]},sanitizeAnswer:function(answer){var rawSrc,safeSrc,imgTag,stripped,emptyOption="("+Globalize.localize("no label")+")",img;imgTag=SM.Html.findFirstTag(answer.text,"img");if(!imgTag){stripped=DOMPurify.sanitize(answer.text);imgTag=SM.Html.findFirstTag(stripped,"img")}if(imgTag){imgTag=SM.Html.removeExternalAttributes(imgTag);img=SM.Html.parse(imgTag)[0]}if(img){rawSrc=img.getAttribute("data-src");rawSrc=SM.String.trim(rawSrc);rawSrc=DOMPurify.sanitize(rawSrc);if(SM.String.isHttpUrl(rawSrc)){safeSrc=rawSrc}}if(safeSrc){answer.text=SM.String.afterLast(safeSrc,"/");answer.mediaHTML=SM.Template.render("img",{classes:"img-option",src:safeSrc,alt:answer.text,title:answer.text})}else{if(!answer.text){answer.text=emptyOption;if(answer.type==="row"&&this.isEmoji()){answer.text=this.displaySubTypeMap[this.displaySubType]?String.fromCharCode(this.displaySubTypeMap[this.displaySubType]):answer.label}}else{answer.text=SM.String.text(DOMPurify.sanitize(answer.text))}}}});SM.BaseAnRule={CHOICE_SET_SCHEMA:{rows:{}},BASE_RULE_METADATA_KEY:"rule_",MAX_CHOICE_HEADING_LENGTH:2,TEMP_ID_PREFIX:"new_",FAMILY_TYPES:{SHOW:"show",FILTER:"filter",COMPARE:"compare"},ruleTypeToModelMap:{filter:{respondent_data:"FilterRespondentDataAnRule",collector:"FilterCollectorAnRule",completeness:"FilterCompletenessAnRule",time_period:"FilterTimePeriodAnRule",random_assignment:"FilterRandomAssignmentRule"},compare:{random_assignment:"CompareRandomAssignmentRule"},show:{show:"ShowAnRule"}},qnaRuleModelMap:{single_choice:"QnaSimpleAnRule",multiple_choice:"QnaSimpleAnRule",matrix:"QnaMatrixAnRule",menu_matrix:"QnaMenuMatrixAnRule",open_ended:"QnaOpenEndedAnRule",demographic:"QnaOpenEndedAnRule",datetime:"QnaDatetimeAnRule",numerical:"QnaNumericalAnRule",rating_comment_per_row:"QnaRatingCommentPerRowAnRule",source_surveys:"SourceSurveysRule"},lastValidation:{isValid:true,invalids:[]},__create:function(options){if(!options.ID){this.isNew=true;this.ID=this.TEMP_ID_PREFIX+this.__uid}else{this.isNew=false;this.ID=options.ID}this.is_nps=options.is_nps;this.loadRuleMetadataValue(options.attrs);this.isCorrupt=options.isCorrupt===true;this.ruleFamily=this.isCompare?"compare":"filter";this.editMode=false;this.isDirty=false;this.isShow=false;this.isQNA=false;this.isRA=false;if(this.metadata_id){delete this.metadata_id}},loadRuleMetadataValue:function(ruleValue){this.customHeading=ruleValue.custom_heading;this.isCompare=ruleValue.is_compare_rule||false;this.selected=ruleValue.selected},FactoryCreate:function(options,survey){var type=options.attrs.rule_type,questionModel,modelKeyword,ruleModel,ruleName,family;if(type==="show"){family="show"}else if(type==="random_assignment"&&options.attrs.is_compare_rule){family="compare"}else{family="filter"}if(type==="qna"){questionModel=survey.getQuestion(options.attrs.question_id);modelKeyword=questionModel.family;if(questionModel.isNPS()){modelKeyword="single_choice"}if(questionModel.family==="matrix"&&questionModel.subtype==="menu"){modelKeyword="menu_matrix"}else if(questionModel.subtype==="numerical"){modelKeyword="numerical"}if(questionModel.commentField&&questionModel.commentField.options.apply_all_rows){modelKeyword="rating_comment_per_row"}if(options.attrs.question_id===survey.getSourceSurveysQuestionId()){modelKeyword="source_surveys"}ruleName=this.qnaRuleModelMap[modelKeyword];options.is_nps=questionModel.isNPS();ruleModel=SM.Models.create(ruleName,options);if(options.attrs.is_compare_rule){ruleModel.ruleFamily="compare";ruleModel.isCompare=true}}else if(type==="random_assignment"){ruleName=this.ruleTypeToModelMap[family][type];ruleModel=SM.Models.create(ruleName,options);if(options.attrs.is_compare_rule){ruleModel.ruleFamily="compare";ruleModel.isCompare=true}}else{ruleName=this.ruleTypeToModelMap[family][type];ruleModel=SM.Models.create(ruleName,options)}return ruleModel},loadSurvey:function(survey){this.survey=survey},__setters:{editMode:function(self,val){if(val===true){self._ruleBackup=self.dumpRuleValue()}else if(self._ruleBackup){self.loadRuleMetadataValue(self._ruleBackup);delete self._ruleBackup}self.editMode=val}},__getters:{heading:function(self){return self.customHeading||self.getHeading()},selected:function(self){return self.selected&&!self.isCorrupt}},applyRule:function(){if(this.isNew){this.survey.anviews.currentView.addRule(this);this.isNew=false}else{this._trigger({type:"ruleEdited",ruleModel:this})}},copyRule:function(){var rule=this.copy();this.survey.anviews.currentView.addRule(rule);this.survey.anviews.currentView.save()},toggleRule:function(){var val=!this.get("selected");this.set("selected",val);this._trigger({type:"ruleEdited",ruleModel:this})},deleteRule:function(){this._trigger({type:"ruleDeleted",ruleModel:this})},copy:function(){var copy=SM.Models.create(this.__NAME,{ID:null,is_nps:this.is_nps,attrs:this.dumpRuleValue()}),heading=copy.customHeading||this.get("heading");heading=heading+" - "+Globalize.localize("COPY");copy.set("customHeading",heading);copy.loadSurvey(this.survey);copy.set("selected",false);copy.set("isNew",false);return copy},isPersisted:function(){return this.ID.substr(0,4)!==this.TEMP_ID_PREFIX},dump:function(){var key=this.BASE_RULE_METADATA_KEY,metadata_id=this.ID,val,tempID=null;key=[key,this.ruleFamily,"_",this.get("ruleType")].join("");val=this.dumpRuleValue();if(!this.isPersisted()){metadata_id=null;tempID=this.ID}return{key:key,temp_id:tempID,is_corrupt:this.isCorrupt,metadata_id:metadata_id,option_id:null,question_id:null,value:val,view_id:this.survey.anviews.currentView.ID}},sanitize:function(){},dumpRuleValue:function(){var ruleValue={};ruleValue.rule_type=this.ruleType;ruleValue.selected=this.selected;ruleValue.custom_heading=this.customHeading;return SM.Object.deepCopy(ruleValue)},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.isValid){delete this._ruleBackup;this.editMode=false}return this.lastValidation.isValid},_getNpsChoiceSetHeading:function(choiceSet){var text,heading="",len,i=0,max=this.MAX_CHOICE_HEADING_LENGTH,survey=this.survey,indexOfLastChoice;choiceSet=SM.ComparedByNps.map2DistributedBySurvey(choiceSet,survey);_.each(choiceSet,function(choice){text=Globalize.localize(choice.text);if(i<max){heading+=text+", "}len=i+1;i++});heading=heading.substring(0,heading.length-2);indexOfLastChoice=heading.length;if(len>max){heading+=" +"+(len-max)}return{heading:heading,numChoices:i,indexOfLastChoice:indexOfLastChoice}
},_getChoiceSetHeading:function(choiceSet,getChoiceText){var text,heading="",len,i=0,choiceSetIDs,max=this.MAX_CHOICE_HEADING_LENGTH,indexOfLastChoice;choiceSetIDs=_.keys(choiceSet);choiceSetIDs=_.sortBy(choiceSetIDs,function(choiceId){return choiceId});_.each(choiceSetIDs,function(choiceID){text=getChoiceText(choiceID);if(i<max){heading+=text+", "}len=i+1;i++});heading=heading.substring(0,heading.length-2);indexOfLastChoice=heading.length;if(len>max){heading+=" +"+(len-max)}return{heading:heading,numChoices:i,indexOfLastChoice:indexOfLastChoice}}};SM.Models.extend("FilterRespondentDataAnRule",SM.BaseAnRule,{__create:function(options){this.ruleType="respondent_data";SM.BaseAnRule.__create.call(this,options)},loadRuleMetadataValue:function(ruleValue){var self=this;SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.timeTotal=ruleValue.time_total;if(!this.get("timeTotal")){this.set("timeTotal",{op:">",unit:"s",value:""})}if(ruleValue.txt_rows){$.each(this.respondentAttributes,function(i,attribute){if(ruleValue.txt_rows[attribute.key]){self.set(attribute.id,ruleValue.txt_rows[attribute.key])}})}},__validators:{email:function(self,value){var emailRegEx=/\S+@\S+\.\S+/,validation={message:Globalize.localize(self._errorMessages.email),isValid:true};if(value&&value.length>0){validation.isValid=emailRegEx.test(value)}return validation},ip:function(self,value){var ip=$.trim(value||""),validation={message:Globalize.localize(self._errorMessages.ip),isValid:true},match=null,regex=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;if(ip.length>0){match=ip.match(regex);if(match){$.each(match,function(i,currMatch){currMatch=parseInt(currMatch,10);if(currMatch>255||currMatch<0){validation.isValid=false}})}else{validation.isValid=false}}return validation},timeTotal:function(self,timeTotal){var timeTotalValue=timeTotal.value||"",isValid=true,timeValParsed;timeTotalValue=$.trim(timeTotalValue);if(timeTotalValue.length>0){timeValParsed=parseInt(timeTotalValue,10);if(isNaN(timeValParsed)||!isFinite(timeTotalValue)||timeValParsed===0){isValid=false}}return{isValid:isValid}}},_errorMessages:{ip:"Please enter a valid IP address",email:"Please enter a valid email"},respondentAttributes:[{id:"ip",key:"ip",textLabel:"IP Address"},{id:"email",key:"email",textLabel:"Email Address"},{id:"firstName",key:"first_name",textLabel:"First Name"},{id:"lastName",key:"last_name",textLabel:"Last Name"},{id:"custom",key:"custom",textLabel:"Custom Data",popout_id:"custom-data-popout"}],dumpRuleValue:function(){var ruleAttrs=SM.BaseAnRule.dumpRuleValue.call(this),self=this,timeData=self.get("timeTotal"),textInputs={},setter,text;$.each(this.respondentAttributes,function(i,attribute){setter=attribute.id;if(self.get(setter)){text=$.trim(self.get(setter)||"");if(text){textInputs[attribute.key]=text}}});ruleAttrs.txt_rows=textInputs;if(timeData.value){ruleAttrs.time_total=timeData}return SM.Object.deepCopy(ruleAttrs)},getHeading:function(){var timeChoice=this.get("timeTotal"),self=this,heading="",max=2,count=0,culture=Globalize.culture();if(timeChoice&&$.trim(timeChoice.value)){heading+=Globalize.localize("Response time");heading+=" "+timeChoice.op+" "+timeChoice.value;heading+=culture.calendar.timeAbbr[timeChoice.unit]+", ";count++}$.each(this.respondentAttributes,function(i,attribute){if(self.get(attribute.id)){if(count<max){heading+=Globalize.localize(attribute.textLabel);heading+=" = "+self.get(attribute.id)+", "}count++}});heading=heading.substring(0,heading.length-2);if(count>max){heading+=" + "+(count-max)}return heading},attributeIsVisible:function(attr){if(attr==="first_name"||attr==="last_name"||attr==="email"){return this.survey.hasEmailCollector}return true}});SM.Models.extend("FilterCollectorAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="collector"},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");return SM.Object.deepCopy(ruleValue)},getHeading:function(){var survey=this.survey,choiceSetHeading;choiceSetHeading=this._getChoiceSetHeading(this.get("rows"),function(collectorID){var collector=survey.getCollector(collectorID);return collector.title});return choiceSetHeading.heading}});SM.Models.extend("FilterCompletenessAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="completeness"},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");return SM.Object.deepCopy(ruleValue)},getHeading:function(){var checkedRows=this.get("rows"),complete=Globalize.localize("complete responses"),partial=Globalize.localize("partial responses"),disqualified=Globalize.localize("disqualified responses"),overquota=Globalize.localize("responses over quota"),heading=[];if(checkedRows.completely){heading.push(complete)}if(checkedRows.partially){heading.push(partial)}if(checkedRows.disqualified){heading.push(disqualified)}if(checkedRows.overquota){heading.push(overquota)}heading=heading.join(", ");heading=heading[0].toUpperCase()+heading.substr(1);return heading}});SM.Models.extend("FilterTimePeriodAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="time_period"},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.startDate=ruleValue.start_date;this.endDate=ruleValue.end_date;this.timeType=ruleValue.time_type},__validators:{endDate:function(self,value){if(!value){return{isValid:false}}return{isValid:true}},startDate:function(self,value){if(!value){return{isValid:false}}return{isValid:true}}},getHeading:function(){return Globalize.format(new Date(this.get("startDate")),"d")+" - "+Globalize.format(new Date(this.get("endDate")),"d")},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.start_date=this.get("startDate");ruleValue.end_date=this.get("endDate");ruleValue.time_type=this.get("timeType")||"custom";return SM.Object.deepCopy(ruleValue)}});SM.Models.extend("BaseQnaAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="qna";this.isQNA=true},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.questionID=ruleValue.question_id},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getHeading:function(){var questionModel=this.getQuestion(),letter_q=Globalize.localize("Question").substr(0,1),heading=letter_q+questionModel.position+": ";return heading+this._getQnaHeading()},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);if(this.is_nps_distributed){ruleValue.is_nps_distributed=true}if(this.choiceSet){ruleValue.answers=[this.choiceSet.dump()]}ruleValue.is_compare_rule=this.isCompare;ruleValue.question_id=this.questionID;return SM.Object.deepCopy(ruleValue)},_addCommentFieldHeading:function(headingData,commentChoiceSet){var heading=headingData.heading,commentField=this.getQuestion().commentField,searchTerm,max=this.MAX_CHOICE_HEADING_LENGTH;if(commentChoiceSet.get("commentFieldSelected")){headingData.numChoices++;if(headingData.numChoices<=max){searchTerm=commentChoiceSet.get("searchTerm");if(headingData.numChoices>1){heading+=", "}heading+=commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("")}headingData.indexOfLastChoice=heading.length}else{heading=heading.substring(0,headingData.indexOfLastChoice)+" +"+(headingData.numChoices-max)}headingData.heading=heading}return headingData}});SM.Models.extend("QnaSimpleAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{}},loadRuleMetadataValue:function(ruleValue){var self=this,choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);this.is_nps_distributed=ruleValue.is_nps_distributed||false;if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{if(self.is_nps){choiceSetData=SM.ComparedByNps.choiceSetConvert(ruleValue.answers[0])}else{choiceSetData=ruleValue.answers[0]}}this.choiceSet=SM.Models.create("SimpleQnaRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate()}},sanitize:function(){var text=this.choiceSet.get("searchTerm");if(text){this.choiceSet.set("searchTerm",_.string.trim(text))}},_getQnaHeading:function(){var self=this,survey=this.survey,headingData;if(self.is_nps){self.is_nps_distributed=SM.ComparedByNps.isDistributed(self.choiceSet.rows,self.getQuestion())}else{self.is_nps_distributed=false}headingData=self.is_nps_distributed?self._getNpsChoiceSetHeading(self.choiceSet.rows):this._getChoiceSetHeading(this.choiceSet.rows,function(choiceID){return survey.getAnswer(choiceID).text});headingData=this._addCommentFieldHeading(headingData,this.get("choiceSet"));return headingData.heading}});SM.Models.extend("SourceSurveysRule",SM.QnaSimpleAnRuleModel,{loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);this.is_nps_distributed=false;if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{choiceSetData=ruleValue.answers[0]}this.choiceSet=SM.Models.create("SimpleQnaRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows},getHeading:function(){var survey=this.survey,headingData;headingData=_.map(this.choiceSet.rows,function(value,choiceID){return survey.getSourceSurvey(choiceID).text});return headingData.join()}});SM.Models.extend("QnaOpenEndedAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_type:"all",rows:{},search_term:""}},loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{choiceSetData=ruleValue.answers[0]}this.choiceSet=SM.Models.create("QnaOpenEndedRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate()}},loadSurvey:function(survey){var questionModel;SM.BaseQnaAnRuleModel.loadSurvey.call(this,survey);questionModel=this.getQuestion();if(questionModel.isEssay()||questionModel.isFileUpload()){this.choiceSet.set("selectedRowID","0")}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSet=this.choiceSet,lastChar,heading;if(questionModel.isEssay()||questionModel.isFileUpload()){heading=questionModel.heading}else{heading=questionModel.getAnswer(choiceSet.get("selectedRowID")).text}lastChar=heading.substr(-1);if(lastChar===":"||lastChar==="="){heading=heading.substring(0,heading.length-1)}heading+=' = "'+choiceSet.get("searchTerm")+'"';return heading}});SM.Models.extend("QnaDatetimeAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_term:undefined,rows:{},op:"="}},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate()}},_choiceSetModel:"QnaDateTimeRuleChoiceSet",loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{choiceSetData=ruleValue.answers[0]}this.choiceSet=SM.Models.create(this._choiceSetModel,choiceSetData);this.choiceSet.loadRule(this)},_getQnaHeading:function(){var questionModel=this.getQuestion(),operator=this.choiceSet.get("op"),heading=questionModel.getAnswer(this.choiceSet.get("selectedRowID")).text,validation=questionModel.structure.validation,dateFormat=validation&&validation.type,dateMoment=this.choiceSet.selectedDate,date=new Date(dateMoment.year(),dateMoment.month(),dateMoment.date(),dateMoment.hours(),dateMoment.minutes());if(questionModel.subtype==="date_only"){if(dateFormat==="date_intl"){heading+=" "+operator+" "+Globalize.format(date,"d/M/yyyy")}else{heading+=" "+operator+" "+Globalize.format(date,"d")}}else if(questionModel.subtype==="time_only"){heading+=" "+operator+" "+Globalize.format(date,"t")}else{if(dateFormat==="date_intl"){heading+=" "+operator+" "+Globalize.format(date,"d/M/yyyy h:mm tt")}else{heading+=" "+operator+" "+Globalize.format(date,"M/d/yyyy h:mm tt")}}return heading}});SM.Models.extend("QnaNumericalAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{op:"=",rows:{},search_term:""}},loadRuleMetadataValue:function(ruleValue){var choiceSetData;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);if(_.isEmpty(ruleValue.answers)){choiceSetData=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{choiceSetData=ruleValue.answers[0]}this.choiceSet=SM.Models.create("QnaNumericalRuleChoiceSet",choiceSetData);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(self,choiceSet){return choiceSet.validate()}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSet=this.choiceSet,heading=questionModel.getAnswer(choiceSet.get("selectedRowID")).text,lastChar;lastChar=heading.substr(-1);if(lastChar===":"||lastChar==="="){heading=heading.substring(0,heading.length-1)}heading+=" "+this.choiceSet.get("op")+' "'+choiceSet.get("searchTerm")+'"';return heading},sanitize:function(){var number=Globalize.parseFloat(this.choiceSet.searchTerm,10);this.choiceSet.searchTerm=number.toString()}});SM.Models.register("BaseQnaRuleChoiceSet",{__create:function(choiceSet){var comment=choiceSet.comment;if(comment){this.set("commentFieldSelected",true);this.searchType=comment.search_type;this.searchTerm=comment.search_term}this.rows=choiceSet.rows},loadRule:function(parentRuleModel){this.ruleModel=parentRuleModel},__validators:{searchTerm:function(self,value){var validation={isValid:true};if(!self.get("commentFieldSelected")){return validation}if(_.isEmpty(value)){return validation}if(!SM.String.containsWordBoundary(value)){validation.isValid=false}return validation}},dump:function(){var questionModel=this.ruleModel.getQuestion(),choiceSet=SM.Object.deepCopy({rows:this.rows}),commentField=questionModel.commentField;if(this.get("commentFieldSelected")&&commentField){choiceSet.comment={search_term:this.get("searchTerm")||null,rows:{}};choiceSet.comment.rows[commentField.id]=true;if(choiceSet.comment.search_term){choiceSet.comment.search_type=this.get("searchType")||"all"}}return choiceSet}});SM.Models.extend("SimpleQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{dump:function(){var questionModel=this.ruleModel.getQuestion(),choiceSet=SM.BaseQnaRuleChoiceSetModel.dump.call(this),comment=choiceSet.comment;if(this.ruleModel.is_nps){choiceSet=SM.ComparedByNps.choiceSetRevert(choiceSet,questionModel)}if(this.get("commentFieldSelected")&&comment&&!comment.search_term){choiceSet.comment.search_term=""}return choiceSet}});SM.Models.extend("MatrixQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){SM.BaseQnaRuleChoiceSetModel.__create.call(this,choiceSet);this.cols=choiceSet.cols;if(choiceSet.colChoices){this.colChoices=choiceSet.colChoices}},dump:function(){var choices=SM.BaseQnaRuleChoiceSetModel.dump.call(this);choices.cols=SM.Object.deepCopy(this.cols);if(this.colChoices){choices.col_choices=SM.Object.deepCopy(this.colChoices)}return choices}});SM.Models.extend("QnaDateTimeRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){var answerID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1",dateMoment;this.op=choiceSet.comment.op;this.selectedRowID=answerID;if(answerID==="-1"){dateMoment=moment(new Date);dateMoment.startOf("day")}else{dateMoment=moment.utc(choiceSet.comment.search_term)}this.set("selectedDate",dateMoment);this.set("selectedTime",{hours:dateMoment.hours(),minutes:dateMoment.minutes()})},__validators:{selectedDate:function(self,dateVal){var questionModel=self.ruleModel.getQuestion();if(questionModel.subtype==="date_only"||questionModel.subtype==="both"){return{isValid:!!dateVal}}return{isValid:true}},selectedTime:function(self,timeVal){var questionModel=self.ruleModel.getQuestion();if(questionModel.subtype==="time_only"||questionModel.subtype==="both"){if(!timeVal||timeVal.minutes===-1||timeVal.hours===-1){return{isValid:false}}}return{isValid:true}},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false}return validation}},dump:function(){var value={rows:{},search_term:this.dumpDateTime(),op:this.get("op")};value.rows[this.get("selectedRowID")]=true;return{comment:value}},dumpDateTime:function(){var dateMoment=this.get("selectedDate")||moment(),time=this.get("selectedTime")||{hours:0,minutes:0};dateMoment.hours(time.hours);dateMoment.minutes(time.minutes);return moment(dateMoment).utc().format("YYYY-MM-DD[T]HH:mm:ss")}});SM.Models.extend("QnaOpenEndedRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(choiceSet){this.searchTerm=choiceSet.comment.search_term;this.searchType=choiceSet.comment.search_type;this.selectedRowID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1"},__validators:{searchTerm:function(self,value){var validation={isValid:true};if(!SM.String.containsWordBoundary(value)){validation.isValid=false}return validation},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false}return validation}},dump:function(){var questionModel=this.ruleModel.getQuestion(),value={search_term:this.get("searchTerm"),search_type:this.get("searchType")};if(questionModel.isMultiResponse()){value.rows={};value.rows[this.selectedRowID]=true}return{comment:value}}});SM.Models.extend("QnaNumericalRuleChoiceSet",SM.QnaOpenEndedRuleChoiceSetModel,{__create:function(choiceSet){SM.BaseQnaRuleChoiceSetModel.__create.call(this,choiceSet);this.op=choiceSet.comment.op;this.selectedRowID=SM.Object.getOneKey(choiceSet.comment.rows)||"-1"},__validators:{searchTerm:function(self,value){var validation={isValid:true},number=parseFloat(value,10);if(isNaN(number)||number<0){validation.isValid=false}return validation},selectedRowID:function(self,value){var validation={isValid:true};if(value==="-1"){validation.isValid=false}return validation}},dump:function(){var dump=SM.QnaOpenEndedRuleChoiceSetModel.dump.call(this);delete dump.comment.search_type;dump.comment.op=this.get("op");return dump}});SM.Models.extend("QnaMatrixAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{},cols:{}},__validators:{choiceSetList:function(self,choiceSetList){var allValid=[];if(choiceSetList.length===0&&!self.commentChoiceSet){return false}_.each(choiceSetList,function(choiceSet){var setValid=choiceSet.validate();allValid.push(setValid)});return allValid},commentChoiceSet:function(self,commentChoiceSet){if(commentChoiceSet.get("commentFieldSelected")){return commentChoiceSet.validate()}return false}},__create:function(options){SM.BaseQnaAnRuleModel.__create.call(this,options)},loadRuleMetadataValue:function(ruleValue){var self=this,answers=ruleValue.answers,comment=ruleValue.comment;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,ruleValue);this.choiceSetList=[];if(_.isEmpty(answers)){this.addChoiceSet()}else{_.each(answers,function(choiceSet){self.loadChoiceSet({rows:choiceSet.rows,cols:choiceSet.cols,colChoices:choiceSet.col_choices})})}this.commentChoiceSet=SM.Models.create("MatrixQnaRuleChoiceSet",{comment:comment});this.commentChoiceSet.loadRule(this)},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.invalids.commentChoiceSet){this.lastValidation.isValid=this.lastValidation.invalids.commentChoiceSet.isValid}else{this.lastValidation.isValid=this.lastValidation.invalids.choiceSetList}if(this.lastValidation.isValid){this.lastValidation.invalids=[];delete this._ruleBackup;this.editMode=false}return this.lastValidation.isValid},addChoiceSet:function(){var choiceSetModel=this.loadChoiceSet(SM.Object.deepCopy(this.CHOICE_SET_SCHEMA));choiceSetModel.loadRule(this);return choiceSetModel},loadChoiceSet:function(choiceSetData){var choiceSetModel;if(!choiceSetData.cols){return}choiceSetModel=SM.Models.create("MatrixQnaRuleChoiceSet",choiceSetData);this.choiceSetList.push(choiceSetModel);choiceSetModel.loadRule(this);return choiceSetModel},isInvalidSet:function(choiceSet){return SM.Object.getOnlyKey(choiceSet.get("rows"))===undefined||SM.Object.getOneKey(choiceSet.get("cols"))===undefined||choiceSet.get("colChoices")&&SM.Object.getOneKey(choiceSet.get("colChoices"))===undefined},sanitize:function(){var choiceSetList=this.choiceSetList,commentChoiceSet=this.commentChoiceSet,text=commentChoiceSet.get("searchTerm"),choiceSetModel,self=this,i=0;for(;i<choiceSetList.length;i++){choiceSetModel=choiceSetList[i];if(self.isInvalidSet(choiceSetModel)){choiceSetList.splice(i,1);i--}}if(text){commentChoiceSet.set("searchTerm",_.string.trim(text))}},_dumpAnswers:function(){var answers=[],self=this;_.each(this.choiceSetList,function(choiceSetModel){if(!self.isInvalidSet(choiceSetModel)){answers.push(choiceSetModel.dump())}});return answers},dumpRuleValue:function(){var questionModel=this.getQuestion(),ruleValue=SM.BaseQnaAnRuleModel.dumpRuleValue.call(this),commentField=questionModel.commentField,commentChoiceSet=this.get("commentChoiceSet"),commentFieldID,commentFieldSelected,text,commentRow;ruleValue.question_id=this.questionID;ruleValue.answers=this._dumpAnswers();commentFieldSelected=this.get("commentFieldSelected")||commentChoiceSet&&commentChoiceSet.get("commentFieldSelected");if(commentField&&commentFieldSelected){ruleValue.comment=this.commentChoiceSet.dump().comment;commentFieldID=commentField.id;text=$.trim(ruleValue.comment.search_term||null);commentRow={rows:{}};commentRow.rows[commentFieldID]={search_type:ruleValue.comment.search_type||null,search_term:text};ruleValue.answers.push(commentRow)}return SM.Object.deepCopy(ruleValue)},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSetList=this.choiceSetList,survey=this.survey,getAnswerText=function(choiceID){return survey.getAnswer(choiceID).text},heading,rowID,searchTerm,headingData;if(choiceSetList.length>0){rowID=SM.Object.getOnlyKey(choiceSetList[0].get("rows"));if(rowID){heading=questionModel.getAnswer(rowID).text+": ";if(questionModel.isEmoji()){heading=""}headingData=this._getChoiceSetHeading(choiceSetList[0].get("cols"),getAnswerText);heading=heading+this._addCommentFieldHeading(headingData,choiceSetList[0]).heading;if(choiceSetList.length>1){rowID=SM.Object.getOnlyKey(choiceSetList[1].get("rows"));heading+="; "+questionModel.getAnswer(rowID).text+": ";if(choiceSetList[1].cols){headingData=this._getChoiceSetHeading(choiceSetList[1].get("cols"),getAnswerText);heading=heading+this._addCommentFieldHeading(headingData,choiceSetList[1]).heading}if(choiceSetList.length>2){heading+="..."}}}}if(this.commentChoiceSet.get("commentFieldSelected")){if(choiceSetList.length<this.MAX_CHOICE_HEADING_LENGTH){searchTerm=this.commentChoiceSet.get("searchTerm");if(heading){heading+="; "}else{heading=""}heading+=this.getQuestion().commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("")}}else{heading+="..."}}return heading}});SM.Models.extend("QnaRatingCommentPerRowAnRule",SM.QnaMatrixAnRuleModel,{dumpRuleValue:function(){var ruleValue=SM.QnaMatrixAnRuleModel.dumpRuleValue.call(this);ruleValue.answers=this._dumpAnswers();return SM.Object.deepCopy(ruleValue)}});SM.Models.extend("QnaMenuMatrixAnRule",SM.QnaMatrixAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{},cols:{},colChoices:{}},_getQnaHeading:function(){var questionModel=this.getQuestion(),choiceSetList=this.choiceSetList,heading="",survey=this.survey,searchTerm;if(choiceSetList.length>0){heading+=this._getRowColHeading(questionModel,choiceSetList[0].rows,choiceSetList[0].cols);heading+=this._getChoiceSetHeading(choiceSetList[0].colChoices,function(choiceID){return survey.getAnswer(choiceID).text}).heading;if(choiceSetList.length>1){heading+="; "+this._getRowColHeading(questionModel,choiceSetList[1].rows,choiceSetList[1].cols);heading+=this._getChoiceSetHeading(choiceSetList[1].colChoices,function(choiceID){return survey.getAnswer(choiceID).text}).heading;if(choiceSetList.length>2){heading+="..."}}}if(this.commentChoiceSet.get("commentFieldSelected")){if(choiceSetList.length<this.MAX_CHOICE_HEADING_LENGTH){searchTerm=this.commentChoiceSet.get("searchTerm");heading+="; "+this.getQuestion().commentField.text;if(searchTerm){heading+=[' = "',searchTerm,'"'].join("")}}else{heading+="..."}}return heading},_getRowColHeading:function(questionModel,rowSet,colSet){var subheading="",answerID=SM.Object.getOnlyKey(rowSet);subheading+=questionModel.getAnswer(answerID).text+", ";answerID=SM.Object.getOnlyKey(colSet);subheading+=questionModel.getAnswer(answerID).text+": ";return subheading}});SM.Models.extend("ShowAnRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleFamily="show";this.isShow=true;this.ruleType="show"},__getters:{show:function(self){var show=self.get("showSet").dump();show.selected=self.get("selected");return show}},loadSurvey:function(survey){this.survey=survey;this.showSet=SM.Models.create("ShowSet");this.showSet.loadView(this.survey.anviews.currentView);this.set("selected",this.get("selected")||false)},getHeading:function(){var self=this,showSet=self.showSet,heading="",pageWord=Globalize.localize("Page"),letterQ=Globalize.localize("Question").substr(0,1),maxPageCount=2,pageCount=0;$.each(this.survey.pageList,function(i,page){if(showSet.hasPage(page)){if(pageCount<maxPageCount){heading+=pageWord+" "+page.position;if(showSet.pageQuestionsCheckedCount!==page.questionList.length){heading+=": ";$.each(page.questionList,function(j,question){if(showSet.hasQuestion(question)){heading+=letterQ+question.position+", "}});heading=heading.replace(/,\s$/,"; ")}else{heading+=", "}}pageCount++}});heading=heading.substring(0,heading.length-1);if(pageCount>maxPageCount){heading+=" +"+(pageCount-maxPageCount)}return heading},deleteRule:function(){this.showSet.clear();this.set("selected",false);this._trigger({type:"ruleDeleted",ruleModel:this})}});SM.Models.register("ShowSet",{show:null,survey:null,pageQuestionCounts:null,totalQuestionCount:0,totalPageCount:0,loadView:function(view){var show=view.show,self=this;self.survey=view.anviews.survey;self.clear();if(show.pages){_.each(show.pages,function(pTest,pID){self.show.pages[pID]=true;self.totalPageCount++})}if(show.questions){_.each(show.questions,function(qTest,qID){var q=self.survey.getQuestion(qID);if(q){self.show.questions[qID]=true;self.pageQuestionCounts[q.page.ID]++;self.totalQuestionCount++}})}},__create:function(){this.show={pages:{},questions:{}}},allSelected:function(){return this.totalQuestionCount===this.survey.questionCount},togglePage:function(page){if(this.show.pages[page.ID]){if(this.pageQuestionCounts[page.ID]===page.questionList.length){this.removePage(page);return false}this.addPage(page);return true}this.addPage(page);return true},toggleQuestion:function(question){if(this.show.questions[question.ID]){this.removeQuestion(question);return false}this.addQuestion(question);return true},toggleAll:function(){if(this.allSelected()){this.clear();return false}this.addAll();return true},addAll:function(){var pageList=this.survey.pageList,i=0,j,q,page;this.totalQuestionCount=this.survey.questionCount;this.totalPageCount=this.survey.pageList.length;for(;i<pageList.length;i++){page=pageList[i];if(page.questionList.length>0){this.show.pages[page.ID]=true;for(j=0;j<page.questionList.length;j++){q=page.questionList[j];this.show.questions[q.ID]=true;this.pageQuestionCounts[page.ID]++}}}},clear:function(){var pageQuestionCounts={},i=0,pageList=this.survey.pageList,len=pageList.length;for(;i<len;i++){pageQuestionCounts[pageList[i].ID]=0}this.pageQuestionCounts=pageQuestionCounts;this.show.pages={};this.show.questions={};this.totalQuestionCount=0;this.totalPageCount=0},addQuestion:function(q){if(!this.show.questions[q.ID]){this.show.questions[q.ID]=true;if(!this.show.pages[q.page.ID]){this.show.pages[q.page.ID]=true}this.pageQuestionCounts[q.page.ID]++;this.totalQuestionCount++}},addPage:function(page){var i=0,len=page.questionList.length;if(!this.show.pages[page.ID]){this.show.pages[page.ID]=true;this.totalPageCount++}this.pageQuestionCounts[page.ID]=len;for(;i<len;i++){if(!this.show.questions[page.questionList[i].ID]){this.show.questions[page.questionList[i].ID]=true;this.totalQuestionCount++}}},removePage:function(page){var i=0,q;if(this.show.pages[page.ID]){for(;i<page.questionList.length;i++){q=page.questionList[i];if(this.show.questions[q.ID]){delete this.show.questions[q.ID];this.totalQuestionCount--}}delete this.show.pages[page.ID];this.pageQuestionCounts[page.ID]=0;this.totalPageCount--}},removeQuestion:function(question){if(this.show.questions[question.ID]){this.totalQuestionCount--;this.pageQuestionCounts[question.page.ID]--;delete this.show.questions[question.ID]}if(this.pageQuestionCounts[question.page.ID]===0){delete this.show.pages[question.page.ID]}},hasPage:function(page,set){var self=set||this;return self.show.pages[page.ID]},hasQuestion:function(question,set){var self=set||this;return self.show.questions[question.ID]},questionCheckedCount:function(){return this.totalQuestionCount},pageQuestionsCheckedCount:function(page){return this.pageQuestionCounts[page.ID]||0},dump:function(){var show=this.show;if(this.isEmpty()){show.questions=null;show.pages=null}return SM.Object.deepCopy(this.show)},isEmpty:function(){return $.isEmptyObject(this.show.questions)||$.isEmptyObject(this.show.pages)},_toNumberList:function(list,total,hasItem){var i=0,str="";if(total===list.length||total===0){return Globalize.localize("All")}for(;i<list.length;i++){if(hasItem(list[i],this)){str+=[list[i].position,", "].join("")}}return str.substring(0,str.length-2)},getPageString:function(){return this._toNumberList(this.survey.pageList,this.totalPageCount,this.hasPage)},getQuestionString:function(){return this._toNumberList(this.survey.questionList,this.totalQuestionCount,this.hasQuestion)}});SM.Models.extend("FilterRandomAssignmentRule",SM.BaseAnRule,{__create:function(options){SM.BaseAnRule.__create.call(this,options);this.ruleType="random_assignment";this.isRA=true},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");ruleValue.question_id=this.get("questionID");ruleValue.family=this.getFamily();ruleValue.subtype=this.getSubtype();return SM.Object.deepCopy(ruleValue)},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;this.questionID=ruleValue.question_id},getFamily:function(){return this.getQuestion().family},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test",menu:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype]},getHeading:function(){var question=this.getQuestion(),rows=this.get("rows"),rowsText=[],heading;_.each(rows,function(value,row){_.each(question.randomAssignmentList,function(option){if(option.variable_id.toString()===row){rowsText.push(option.variable_name||option.heading)}})});heading="Q"+question.position+": "+Globalize.localize("("+this._mapTypeToText(question.family,question.subtype)+")")+" "+rowsText.join(", ");
return heading},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList},getSubtype:function(){return this.getQuestion().subtype}});SM.Models.extend("CompareRandomAssignmentRule",SM.BaseAnRule,{__create:function(options){options.attrs.is_compare_rule=true;SM.BaseAnRule.__create.call(this,options);this.ruleType="random_assignment";this.isRA=true},dumpRuleValue:function(){var ruleValue=SM.BaseAnRule.dumpRuleValue.call(this);ruleValue.rows=this.get("rows");ruleValue.cols=this.get("cols");ruleValue.question_id=this.get("questionID");ruleValue.family=this.getFamily();ruleValue.subtype=this.getSubtype();ruleValue.is_compare_rule=true;return SM.Object.deepCopy(ruleValue)},loadRuleMetadataValue:function(ruleValue){SM.BaseAnRule.loadRuleMetadataValue.call(this,ruleValue);this.rows=_.isEmpty(ruleValue.rows)?{}:ruleValue.rows;this.questionID=ruleValue.question_id},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test",menu:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype]},getHeading:function(){var letter_q=Globalize.localize("Question").substr(0,1),question=this.getQuestion(),rows=this.get("rows"),rowsText=[],heading;_.each(rows,function(value,row){_.each(question.randomAssignmentList,function(option){if(option.variable_id.toString()===row){rowsText.push(option.variable_name||option.heading)}})});heading=letter_q+question.position+": "+Globalize.localize("("+this._mapTypeToText(question.family,question.subtype)+")")+" "+rowsText.join(", ");return heading},getFamily:function(){return this.getQuestion().family},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList},getSubtype:function(){return this.getQuestion().subtype}});SM.Models.register("AnalyzeState",{SUMMARY_MODE:"summary",BROWSE_MODE:"browse",TREND_MODE:"trends",__create:function(kwargs){this.page=kwargs.pageIndex;this.mode=kwargs.mode;this.viewID=kwargs.viewID;this.nextViewID=null},__setters:{page:function(self,val){self.page=val;self.survey.anviews.defaultView.set("page",val)},mode:function(self,val){self.mode=val}},__getters:{page:function(self){return self.survey.anviews.defaultView.get("page")},mode:function(self){return self.mode},allPagesSelected:function(self){return self.get("page")==="all"||self.survey&&self.survey.pageList.length<=1}},isBrowseMode:function(){return this.mode===this.BROWSE_MODE},isSummaryMode:function(){return this.mode===this.SUMMARY_MODE},isTrendMode:function(){return this.mode===this.TREND_MODE},survey:null});(function($,undefined){var lastActive,baseClasses="ui-button ui-widget ui-state-default ui-corner-all",typeClasses="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",formResetHandler=function(){var form=$(this);setTimeout(function(){form.find(":ui-button").button("refresh")},1)},radioGroup=function(radio){var name=radio.name,form=radio.form,radios=$([]);if(name){name=name.replace(/'/g,"\\'");if(form){radios=$(form).find("[name='"+name+"']")}else{radios=$("[name='"+name+"']",radio.ownerDocument).filter(function(){return!this.form})}}return radios};$.widget("ui.button",{version:"1.10.4",defaultElement:"<button>",options:{disabled:null,text:true,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,formResetHandler);if(typeof this.options.disabled!=="boolean"){this.options.disabled=!!this.element.prop("disabled")}else{this.element.prop("disabled",this.options.disabled)}this._determineButtonType();this.hasTitle=!!this.buttonElement.attr("title");var that=this,options=this.options,toggleButton=this.type==="checkbox"||this.type==="radio",activeClass=!toggleButton?"ui-state-active":"";if(options.label===null){options.label=this.type==="input"?this.buttonElement.val():this.buttonElement.html()}this._hoverable(this.buttonElement);this.buttonElement.addClass(baseClasses).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){if(options.disabled){return}if(this===lastActive){$(this).addClass("ui-state-active")}}).bind("mouseleave"+this.eventNamespace,function(){if(options.disabled){return}$(this).removeClass(activeClass)}).bind("click"+this.eventNamespace,function(event){if(options.disabled){event.preventDefault();event.stopImmediatePropagation()}});this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}});if(toggleButton){this.element.bind("change"+this.eventNamespace,function(){that.refresh()})}if(this.type==="checkbox"){this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled){return false}})}else if(this.type==="radio"){this.buttonElement.bind("click"+this.eventNamespace,function(){if(options.disabled){return false}$(this).addClass("ui-state-active");that.buttonElement.attr("aria-pressed","true");var radio=that.element[0];radioGroup(radio).not(radio).map(function(){return $(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")})}else{this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(options.disabled){return false}$(this).addClass("ui-state-active");lastActive=this;that.document.one("mouseup",function(){lastActive=null})}).bind("mouseup"+this.eventNamespace,function(){if(options.disabled){return false}$(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(event){if(options.disabled){return false}if(event.keyCode===$.ui.keyCode.SPACE||event.keyCode===$.ui.keyCode.ENTER){$(this).addClass("ui-state-active")}}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){$(this).removeClass("ui-state-active")});if(this.buttonElement.is("a")){this.buttonElement.keyup(function(event){if(event.keyCode===$.ui.keyCode.SPACE){$(this).click()}})}}this._setOption("disabled",options.disabled);this._resetButton()},_determineButtonType:function(){var ancestor,labelSelector,checked;if(this.element.is("[type=checkbox]")){this.type="checkbox"}else if(this.element.is("[type=radio]")){this.type="radio"}else if(this.element.is("input")){this.type="input"}else{this.type="button"}if(this.type==="checkbox"||this.type==="radio"){ancestor=this.element.parents().last();labelSelector="label[for='"+this.element.attr("id")+"']";this.buttonElement=ancestor.find(labelSelector);if(!this.buttonElement.length){ancestor=ancestor.length?ancestor.siblings():this.element.siblings();this.buttonElement=ancestor.filter(labelSelector);if(!this.buttonElement.length){this.buttonElement=ancestor.find(labelSelector)}}this.element.addClass("ui-helper-hidden-accessible");checked=this.element.is(":checked");if(checked){this.buttonElement.addClass("ui-state-active")}this.buttonElement.prop("aria-pressed",checked)}else{this.buttonElement=this.element}},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible");this.buttonElement.removeClass(baseClasses+" ui-state-active "+typeClasses).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html());if(!this.hasTitle){this.buttonElement.removeAttr("title")}},_setOption:function(key,value){this._super(key,value);if(key==="disabled"){this.element.prop("disabled",!!value);if(value){this.buttonElement.removeClass("ui-state-focus")}return}this._resetButton()},refresh:function(){var isDisabled=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");if(isDisabled!==this.options.disabled){this._setOption("disabled",isDisabled)}if(this.type==="radio"){radioGroup(this.element[0]).each(function(){if($(this).is(":checked")){$(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true")}else{$(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}})}else if(this.type==="checkbox"){if(this.element.is(":checked")){this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true")}else{this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false")}}},_resetButton:function(){if(this.type==="input"){if(this.options.label){this.element.val(this.options.label)}return}var buttonElement=this.buttonElement.removeClass(typeClasses),buttonText=$("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(buttonElement.empty()).text(),icons=this.options.icons,multipleIcons=icons.primary&&icons.secondary,buttonClasses=[];if(icons.primary||icons.secondary){if(this.options.text){buttonClasses.push("ui-button-text-icon"+(multipleIcons?"s":icons.primary?"-primary":"-secondary"))}if(icons.primary){buttonElement.prepend("<span class='ui-button-icon-primary ui-icon "+icons.primary+"'></span>")}if(icons.secondary){buttonElement.append("<span class='ui-button-icon-secondary ui-icon "+icons.secondary+"'></span>")}if(!this.options.text){buttonClasses.push(multipleIcons?"ui-button-icons-only":"ui-button-icon-only");if(!this.hasTitle){buttonElement.attr("title",$.trim(buttonText))}}}else{buttonClasses.push("ui-button-text-only")}buttonElement.addClass(buttonClasses.join(" "))}});$.widget("ui.buttonset",{version:"1.10.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(key,value){if(key==="disabled"){this.buttons.button("option",key,value)}this._super(key,value)},refresh:function(){var rtl=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").button("refresh").end().not(":ui-button").button().end().map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(rtl?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(rtl?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset");this.buttons.map(function(){return $(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}})})(jQuery);(function($){function modifier(fn){return function(){var previous=this.element.val();fn.apply(this,arguments);this._refresh();if(previous!==this.element.val()){this._trigger("change")}}}$.widget("ui.spinner",{version:"1.10.4",defaultElement:"<input>",widgetEventPrefix:"spin",options:{culture:null,icons:{down:"ui-icon-triangle-1-s",up:"ui-icon-triangle-1-n"},incremental:true,max:null,min:null,numberFormat:null,page:10,step:1,change:null,spin:null,start:null,stop:null},_create:function(){this._setOption("max",this.options.max);this._setOption("min",this.options.min);this._setOption("step",this.options.step);if(this.value()!==""){this._value(this.element.val(),true)}this._draw();this._on(this._events);this._refresh();this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_getCreateOptions:function(){var options={},element=this.element;$.each(["min","max","step"],function(i,option){var value=element.attr(option);if(value!==undefined&&value.length){options[option]=value}});return options},_events:{keydown:function(event){if(this._start(event)&&this._keydown(event)){event.preventDefault()}},keyup:"_stop",focus:function(){this.previous=this.element.val()},blur:function(event){if(this.cancelBlur){delete this.cancelBlur;return}this._stop();this._refresh();if(this.previous!==this.element.val()){this._trigger("change",event)}},mousewheel:function(event,delta){if(!delta){return}if(!this.spinning&&!this._start(event)){return false}this._spin((delta>0?1:-1)*this.options.step,event);clearTimeout(this.mousewheelTimer);this.mousewheelTimer=this._delay(function(){if(this.spinning){this._stop(event)}},100);event.preventDefault()},"mousedown .ui-spinner-button":function(event){var previous;previous=this.element[0]===this.document[0].activeElement?this.previous:this.element.val();function checkFocus(){var isActive=this.element[0]===this.document[0].activeElement;if(!isActive){this.element.focus();this.previous=previous;this._delay(function(){this.previous=previous})}}event.preventDefault();checkFocus.call(this);this.cancelBlur=true;this._delay(function(){delete this.cancelBlur;checkFocus.call(this)});if(this._start(event)===false){return}this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseup .ui-spinner-button":"_stop","mouseenter .ui-spinner-button":function(event){if(!$(event.currentTarget).hasClass("ui-state-active")){return}if(this._start(event)===false){return false}this._repeat(null,$(event.currentTarget).hasClass("ui-spinner-up")?1:-1,event)},"mouseleave .ui-spinner-button":"_stop"},_draw:function(){var uiSpinner=this.uiSpinner=this.element.addClass("ui-spinner-input").attr("autocomplete","off").wrap(this._uiSpinnerHtml()).parent().append(this._buttonHtml());this.element.attr("role","spinbutton");this.buttons=uiSpinner.find(".ui-spinner-button").attr("tabIndex",-1).button().removeClass("ui-corner-all");if(this.buttons.height()>Math.ceil(uiSpinner.height()*.5)&&uiSpinner.height()>0){uiSpinner.height(uiSpinner.height())}if(this.options.disabled){this.disable()}},_keydown:function(event){var options=this.options,keyCode=$.ui.keyCode;switch(event.keyCode){case keyCode.UP:this._repeat(null,1,event);return true;case keyCode.DOWN:this._repeat(null,-1,event);return true;case keyCode.PAGE_UP:this._repeat(null,options.page,event);return true;case keyCode.PAGE_DOWN:this._repeat(null,-options.page,event);return true}return false},_uiSpinnerHtml:function(){return"<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>"},_buttonHtml:function(){return""+"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'>"+"<span class='ui-icon "+this.options.icons.up+"'>&#9650;</span>"+"</a>"+"<a class='ui-spinner-button ui-spinner-down ui-corner-br'>"+"<span class='ui-icon "+this.options.icons.down+"'>&#9660;</span>"+"</a>"},_start:function(event){if(!this.spinning&&this._trigger("start",event)===false){return false}if(!this.counter){this.counter=1}this.spinning=true;return true},_repeat:function(i,steps,event){i=i||500;clearTimeout(this.timer);this.timer=this._delay(function(){this._repeat(40,steps,event)},i);this._spin(steps*this.options.step,event)},_spin:function(step,event){var value=this.value()||0;if(!this.counter){this.counter=1}value=this._adjustValue(value+step*this._increment(this.counter));if(!this.spinning||this._trigger("spin",event,{value:value})!==false){this._value(value);this.counter++}},_increment:function(i){var incremental=this.options.incremental;if(incremental){return $.isFunction(incremental)?incremental(i):Math.floor(i*i*i/5e4-i*i/500+17*i/200+1)}return 1},_precision:function(){var precision=this._precisionOf(this.options.step);if(this.options.min!==null){precision=Math.max(precision,this._precisionOf(this.options.min))}return precision},_precisionOf:function(num){var str=num.toString(),decimal=str.indexOf(".");return decimal===-1?0:str.length-decimal-1},_adjustValue:function(value){var base,aboveMin,options=this.options;base=options.min!==null?options.min:0;aboveMin=value-base;aboveMin=Math.round(aboveMin/options.step)*options.step;value=base+aboveMin;value=parseFloat(value.toFixed(this._precision()));if(options.max!==null&&value>options.max){return options.max}if(options.min!==null&&value<options.min){return options.min}return value},_stop:function(event){if(!this.spinning){return}clearTimeout(this.timer);clearTimeout(this.mousewheelTimer);this.counter=0;this.spinning=false;this._trigger("stop",event)},_setOption:function(key,value){if(key==="culture"||key==="numberFormat"){var prevValue=this._parse(this.element.val());this.options[key]=value;this.element.val(this._format(prevValue));return}if(key==="max"||key==="min"||key==="step"){if(typeof value==="string"){value=this._parse(value)}}if(key==="icons"){this.buttons.first().find(".ui-icon").removeClass(this.options.icons.up).addClass(value.up);this.buttons.last().find(".ui-icon").removeClass(this.options.icons.down).addClass(value.down)}this._super(key,value);if(key==="disabled"){if(value){this.element.prop("disabled",true);this.buttons.button("disable")}else{this.element.prop("disabled",false);this.buttons.button("enable")}}},_setOptions:modifier(function(options){this._super(options);this._value(this.element.val())}),_parse:function(val){if(typeof val==="string"&&val!==""){val=window.Globalize&&this.options.numberFormat?Globalize.parseFloat(val,10,this.options.culture):+val}return val===""||isNaN(val)?null:val},_format:function(value){if(value===""){return""}return window.Globalize&&this.options.numberFormat?Globalize.format(value,this.options.numberFormat,this.options.culture):value},_refresh:function(){this.element.attr({"aria-valuemin":this.options.min,"aria-valuemax":this.options.max,"aria-valuenow":this._parse(this.element.val())})},_value:function(value,allowAny){var parsed;if(value!==""){parsed=this._parse(value);if(parsed!==null){if(!allowAny){parsed=this._adjustValue(parsed)}value=this._format(parsed)}}this.element.val(value);this._refresh()},_destroy:function(){this.element.removeClass("ui-spinner-input").prop("disabled",false).removeAttr("autocomplete").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow");this.uiSpinner.replaceWith(this.element)},stepUp:modifier(function(steps){this._stepUp(steps)}),_stepUp:function(steps){if(this._start()){this._spin((steps||1)*this.options.step);this._stop()}},stepDown:modifier(function(steps){this._stepDown(steps)}),_stepDown:function(steps){if(this._start()){this._spin((steps||1)*-this.options.step);this._stop()}},pageUp:modifier(function(pages){this._stepUp((pages||1)*this.options.page)}),pageDown:modifier(function(pages){this._stepDown((pages||1)*this.options.page)}),value:function(newVal){if(!arguments.length){return this._parse(this.element.val())}modifier(this._value).call(this,newVal)},widget:function(){return this.uiSpinner}})})(jQuery);SM.SharedViewsRouter=function(options){var self=this;self.initialize=function(opts){self.survey=opts.survey};self.newSharedView=function(opts){var defaultViewID=self.survey.anviews.defaultView.ID,sharableViewID=opts&&_.has(opts,"view")?opts.view.ID:self.survey.anviews.currentView.ID,sharedView=SM.Models.create("SharedView",{survey:self.survey,attrs:{survey_id:self.survey.ID,default_view_id:defaultViewID,sharable_view_id:sharableViewID}});_renderSharedViewFormView(sharedView)};self.edit=function(sharedView,view_link){_renderSharedViewFormView(sharedView,view_link)};self.show=function(sharedView){window.open(sharedView.sharedPageURL())};self.destroy=function(sharedView){sharedView.destroy()};function _renderSharedViewFormView(sharedView,view_link){var dialogView,formView;dialogView=SM.Views.create(SM.DialogView,{isModal:true,width:710,easyClose:true,closeBtn:true,templateID:"shared-view-dialog-template"});formView=SM.Views.create(SM.SharedViewFormView,{dialogView:dialogView,sharedView:sharedView});dialogView.$el.find("[shared-view-form-container]").append(formView.$el);dialogView.open();formView.setViewLink(!!view_link)}self.initialize(options)};SM.Models.register("ExportJobPoller",{EXPONENTIAL_COEFFICIENT:1.5,KILL_SWITCH_CAP:30,interval:6e3,iterations:0,isActive:false,__create:function(data){var config=data.config;this.START_INTERVAL=config.start_interval||6e3;this.INTERVAL_CAP=config.interval_cap||6e4;this.ITERATION_CAP=config.iteration_cap||15},loadJobs:function(jobs){this.exportJobs=jobs},start:function(){this.iterations=0;this.interval=this.START_INTERVAL;if(this.get("isActive")||!this.hasJobsPending()){return}this.set("isActive",true,{notify:true});this._poll()},_poll:function(){var self=this;if(this.iterations>this.ITERATION_CAP){if(this.iterations<this.KILL_SWITCH_CAP){this.interval=this.INTERVAL_CAP*5}else{this.stop();return}}else{if(this.interval>this.INTERVAL_CAP){this.interval=this.INTERVAL_CAP}}this.intervalID=setTimeout(function(){self._onePoll()},this.interval)},_onePoll:function(){if(!this.get("isActive")||!this.hasJobsPending()){this.stop();return}this.interval*=this.EXPONENTIAL_COEFFICIENT;this.iterations++;this.updateStatuses();this._poll()},hasJobsPending:function(){var jobsList=this.exportJobs.list,len=jobsList.length,i=0,job;for(;i<len;i++){job=jobsList[i];if(job.pending()){return true}}return false},stop:function(){this.set("isActive",false,{notify:true});clearTimeout(this.intervalID);delete this.intervalID},updateStatuses:function(){var params=null,jobIds,request;if(SM.App.isSharingApp()){jobIds=[];$.each(this.exportJobs.list,function(index,job){jobIds.push(job.ID)});params={exportjob_ids:jobIds}}request=SM.API.getExportList(params);$.when(request,{self:this}).done(this._onFetchedStatuses)},_onFetchedStatuses:function(response,context){var data=response[0],self=context.self,serverJob,serverJobs=SM.Models.create("ExportJobList");serverJobs.loadJobs(data.exportjob_list);$.each(self.exportJobs.list,function(i,currJob){serverJob=serverJobs.map[currJob.ID];if(serverJob){if(serverJob.status!==currJob.status){currJob.downloadLink=serverJob.downloadLink;currJob.set("status",serverJob.status,{notify:true})}}});if(!self.hasJobsPending()){self.stop()}}});SM.Models.register("ExportJobList",{EXPORT:"export",isLoaded:false,__create:function(data){this.list=null;this.map=null;this._cancelledJobs={};this.isUnavailable=false;this.isUserInBillingRetry=false;this.isDriveAuthorized=false;this.config=data},isAvailable:function(){return!this.isUnavailable},isNotAllowedToExport:function(){return this.isUserInBillingRetry},requiresDriveAuth:function(){return!this.isDriveAuthorized},onAuthEstablished:function(job){if(job){job.finalizeExportData();this.addJob(job)}this.isDriveAuthorized=true},createJob:function(jobInfo){var job=SM.Models.create("ExportJob",{data:jobInfo});job.exportJobs=this;return job},addJob:function(job){var sourceView=job.sourceView,edited,request;job.createJobInfo(sourceView);if(sourceView.isCurrent){job.jobInfo.view_name=this.survey.anviews.getSelectedView().name;if(sourceView.get("isDirty")){edited=Globalize.localize("edited");job.jobInfo.view_name+="("+edited+")"}}job.loadDate("createDate",(new Date).getTime());job.on("status.changed",{self:this,job:job},this._onJobStatusChanged);this.map[job.ID]=job;this.list.unshift(job);request=SM.API.createExport({view_id:sourceView.ID,exportjob:job.dump()});$.when(request,{exportID:job.ID,self:this}).done(this._onExportCreated).fail(function(data){job.set("failedRequestID",data.request_id);if(data.status===601){job.set("status",job.STATUS.TOO_LARGE_ERROR,{notify:true})}else{job.set("status",job.STATUS.SERVER_ERROR,{notify:true})}});this._trigger({type:"jobAdded",job:job})},_onExportCreated:function(response,context){var self=context.self,jobID=response[0].export_job.exportjob_id,localJob=self.map[context.exportID],cancelledJob=self._cancelledJobs[context.exportID];if(localJob){delete self.map[localJob.ID];localJob.set("ID",jobID);self.map[jobID]=localJob;self.poller.start()}else if(cancelledJob){delete self._cancelledJobs[context.exportID];cancelledJob.set("ID",jobID);cancelledJob.deleteJob()}},loadJobs:function(jobs){var self=this;if(!this.get("isLoaded")){this.list=[];this.map={}}_.each(jobs,function(data){var job=SM.Models.create("ExportJob",{data:data});self.map[job.ID]=job;self.list.push(job);job.exportJobs=self;job.on("status.changed",{self:self,job:job},self._onJobStatusChanged)});this.set("isLoaded",true,{notify:true})},hasFullExportPending:function(){var isExporting=false,list=this.list||[];$.each(list,function(i,export_job){if(export_job.type==="full"&&export_job.pending()){isExporting=true;return false}});return isExporting},getPendingFullExports:function(){var list=this.list||[];return $.map(list,function(export_job){if(export_job.type==="full"&&export_job.pending()){return export_job}})},deleteJob:function(exportJob){var self=this;exportJob.deleteJob();delete self.map[exportJob.ID];exportJob.off("status.changed",self._onJobStatusChanged);self._spliceJob(exportJob.ID);this._trigger({type:"jobDeleted",job:exportJob})},cancelJob:function(exportJob){var self=this;exportJob.set("isCancelled",true,{notify:true});self._cancelledJobs[exportJob.ID]=exportJob;delete self.map[exportJob.ID];exportJob.off("status.changed",self._onJobStatusChanged);self._spliceJob(exportJob.ID);this._trigger({type:"jobCancelled",job:exportJob})},_onJobStatusChanged:function(e){var self=e.data.self;self._trigger({type:"jobStatusChanged",job:e.data.job})},fetchJobs:function(){var self=this;if(!self.survey.owner.hasExports()||self.survey.isReadOnly()||SM.App.isSharingApp()){self.loadJobs()}else if(!self.get("isLoaded")){$.when(SM.API.getExportList(),{self:self}).done(self._onFetchedJobs).fail(function(data){self._onJobFetchFailed(data)})}},_spliceJob:function(exportID){var self=this;$.each(self.list,function(i,currJob){if(exportID===currJob.ID){self.list.splice(i,1);return false}})},_onFetchedJobs:function(response,context){var self=context.self,data=response[0];self.set("unavailableErrorID","");self.set("isUnavailable",false,{notify:true});self.set("isUserInBillingRetry",data.is_user_in_billing_retry);self.set("isDriveAuthorized",data.is_drive_authorized);self.loadJobs(data.exportjob_list);self.poller.start()},_onJobFetchFailed:function(data){if(data.status===503){this.set("unavailableErrorID",data.request_id);this.set("isUnavailable",true,{notify:true})}}});SM.Models.register("ExportJob",{STATUS:{SUCCESS:"succeeded",ENQUEUED:"enqueued",STARTED:"started",SERVER_ERROR:"server_error",FILTER_ERROR:"filter_error",CROSSTAB_ERROR:"crosstab_error",TOO_LARGE_ERROR:"too_large_error"},FORMAT:{CSV:"csv",EXCEL:"excel",EXCEL_PLUS:"excel_plus",GIF:"gif",HTML:"html",JPG:"jpg",PDF:"pdf",PNG:"png",PPT:"ppt",SPSS:"spss"},TYPE:{SUMMARY_EXPORT:"summary",ALL_EXPORT:"full",CHART_EXPORT:"chart"},NOTIFICATION_MESSAGES:{succeeded:"Your export is complete",server_error:"There was a problem exporting your data",filter_error:"There was a problem exporting your data",crosstab_error:"There was a problem exporting your data",too_large_error:"Your export file is too large to process"},sourceView:null,exportExtensionMap:{csv:".zip",excel:".zip",excel_plus:".zip",gif:".zip",html:".zip",jpg:".zip",pdf:".pdf",png:".png",gss:"",ppt:".pptx",spss:".zip"},__create:function(options){this.load(options.data)},__setters:{includeOpenended:function(self,value){self.exportData.include_openended=value},showWordCloud:function(self,value){self.exportData.show_word_cloud=value},includeChart:function(self,value){self.exportData.include_chart=value},pdfOrientation:function(self,value){self.exportData.orientation=value},pdfPaperSize:function(self,value){self.exportData.dimension=value},format:function(self,value){if(value===undefined){return}self.format=value;self.name=self.generateFileName();self.initExport()},questionDisplay:function(self,value){self.exportData.question_display=value},columnSetting:function(self,value){self.exportData.column_setting=value},cellType:function(self,value){self.exportData.cell_type=value},useNonBrandedTemplate:function(self,value){self.exportData.non_branded_template=value},forcedPageBreak:function(self,value){self.exportData.forced_page_break=value}},__getters:{includeOpenended:function(self){return self.exportData.include_openended},showWordCloud:function(self){return self.exportData.show_word_cloud},includeChart:function(self){return self.exportData.include_chart},pdfOrientation:function(self){return self.exportData.orientation},pdfPaperSize:function(self){return self.exportData.dimension},isSingleQuestionMode:function(self){return self.exportData&&self.exportData.question_id!==undefined},isSingleResponseMode:function(self){return self.exportData&&self.exportData.respondent_id!=="all"},forcedPageBreak:function(self){return self.exportData.forced_page_break}},initExport:function(){var typeInitFuncs=this._initByTypeFormat[this.type],typeFormatInitFunc;if(this.exportData.show_word_cloud){this.shouldShowWordCloud=true}this.exportData={};if(typeInitFuncs){typeFormatInitFunc=typeInitFuncs[this.format];if(typeFormatInitFunc){typeFormatInitFunc(this)}}this.exportData.timezone_offset=SM.Date.stdTimezoneOffset()*6e4},_initByTypeFormat:{summary:{pdf:function(self){var shouldIncludeOpenEnded=false;self.createPDFSettings(shouldIncludeOpenEnded);if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber}},excel:function(self){self.exportData={question_display:"multiple_sheets",include_openended:false,include_chart:true};if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber}},csv:function(self){self.exportData={include_openended:false};if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber}},ppt:function(self){self.exportData={non_branded_template:false,include_openended:false,show_word_cloud:false,include_charts:true,include_tables:true,zoomFactor:"1",question_ids:[],survey_title:SM.String.textTitle(self.exportJobs.survey.title),todays_date:Globalize.format(new Date,"D"),survey_summary:{summary_translations:{complete_responses:Globalize.localize("Complete Responses"),date_created:Globalize.localize("Date Created"),total_responses:Globalize.localize("Total Responses")},total_responses:0,complete_responses:0,date_created:Globalize.format(self.exportJobs.survey.dateCreated,"D")},css_selectors:".sm-chart,.sm-data-table-container"};if(self.questionID){self.exportData.question_id=self.questionID;self.exportData.questionNumber=self.questionNumber}}},chart:{png:function(self){self.exportData={show_word_cloud:false,question_id:self.questionID,questionNumber:self.questionNumber,css_selectors:[".sm-export-question-view"]};if(self.shouldShowWordCloud){self.exportData.show_word_cloud=true;delete self.shouldShowWordCloud}}},full:{excel:function(self){self.exportData={column_setting:"condensed",cell_type:"actual_choice_text"}},pdf:function(self){var shouldIncludeOpenEnded=true;self.createPDFSettings(shouldIncludeOpenEnded);self.exportData.respondent_id=self.respondentID}}},createPDFSettings:function(shouldIncludeOpenEnded){var self=this,hideBranding=self.exportJobs.survey.owner.canHideExportBranding(),phantomjs_pdf_settings={headerHeight:"0.8cm",footerHeight:"0.8cm",marginTop:"0.1cm",marginLeft:"1cm",marginRight:"1cm",marginBottom:"0.1cm",header:SM.Template.render("phantom-pdf-header-template"),footer:SM.Template.render("phantom-pdf-footer-template"),phantomjs_pdf_enabled:true},wkhtmltopdf_pdf_settings={marginTop:"15mm",marginBottom:"15mm",headerSpacing:"3",footerSpacing:"2",phantomjs_pdf_enabled:false},headerTemplate;self.exportData={orientation:"portrait",include_openended:shouldIncludeOpenEnded,show_word_cloud:false,dimension:"letter",zoomFactor:".95",forced_page_break:true};if(self.exportJobs.survey.config.phantomjs_pdf_enabled){_.extend(self.exportData,phantomjs_pdf_settings)}else{_.extend(self.exportData,wkhtmltopdf_pdf_settings);headerTemplate=hideBranding?"pdf-header-template":"pdf-branded-header-template";self.exportData.header=SM.Template.render(headerTemplate);
self.exportData.footer=SM.Template.render("pdf-footer-template")}},load:function(jobData){this.ID=jobData.exportjob_id||"exp-"+this.__uid;this.email=jobData.email||"";this.jobInfo=jobData.job_info||{};this.filterData=jobData.filter_data||null;this.compareData=jobData.crosstab||null;this.format=jobData.format;this.type=jobData.export_type;this.loadDate("createDate",jobData.create_date);this.loadDate("startDate",jobData.start_date);this.loadDate("endDate",jobData.end_date);this.exportPreferences=this.export_pref;this.downloadLink=jobData.download_link;this.status=jobData.job_status||"enqueued";this.size=jobData.size;this.exportData=jobData.export_data;if(jobData.export_data){this.questionID=jobData.export_data.question_id;this.respondentID=jobData.export_data.respondent_id}this.questionNumber=jobData.questionNumber;this.respondentNumber=jobData.respondentNumber;this.name=jobData.custom_filename||this.generateFileName()},dump:function(){var questionDisplay=this.exportData.question_display;if(this.type==="summary"&&this.format==="excel"&&questionDisplay!=="multiple_sheets"){this.set("includeChart",false)}return{custom_filename:this.name,format:this.format,email:this.email,export_data:this.exportData,export_type:this.type,job_info:this.jobInfo,type:this.type}},generateFileName:function(name){var date=new Date,type=this.type,format=this.format,ext=this.exportExtensionMap[format],filename,chart,question,data,all,respondent,number;if(name){return name+ext}if(type==="chart"){chart=this.exportData.show_word_cloud?"Cloud":Globalize.localize("Chart");question=Globalize.localize("Question")[0];name=chart+"_"+question+this.questionNumber}else if(type==="summary"&&this.questionNumber!==undefined){data=Globalize.localize("Data");question=Globalize.localize("Question")[0];name=data+"_"+question+this.questionNumber}else if(type==="full"&&format==="pdf"){if(this.exportData.respondent_id!=="all"){respondent=Globalize.localize("Response");number=this.respondentNumber}else{respondent=Globalize.localize("Responses");number=Globalize.localize("All")}name=respondent+"_"+number}else{data=Globalize.localize("Data");all=Globalize.localize("All");name=data+"_"+all}filename=[name+"_",date.getFullYear().toString().substring(2,4),this.doubleDigify(date.getMonth()+1),this.doubleDigify(date.getDate())].join("")+ext;return filename},loadDate:function(key,datetime){if(datetime){this[key]=new Date(datetime)}else{this[key]=null}if(key==="createDate"&&datetime){this.expirationDate=new Date(datetime);this.expirationDate.setDate(this.expirationDate.getDate()+14)}},doubleDigify:function(num){num=num.toString();if(num.length<2){num="0"+num}return num},failed:function(){return this.status===this.STATUS.CROSSTAB_ERROR||this.status===this.STATUS.FILTER_ERROR||this.status===this.STATUS.TOO_LARGE_ERROR||this.status===this.STATUS.SERVER_ERROR},createJobInfo:function(view){var showSet=SM.Models.create("ShowSet");showSet.loadView(view);this.jobInfo={view_name:view.name,pages:showSet.getPageString(),questions:showSet.getQuestionString()}},getReadableStatus:function(){if(this.failed()){return"failed"}if(this.done()){return"finished"}if(this.pending()){return"processing"}},done:function(){return this.status===this.STATUS.SUCCESS},pending:function(){return this.status===this.STATUS.ENQUEUED||this.status===this.STATUS.STARTED},deleteJob:function(){SM.API.deleteExport({export_id:this.ID});this._trigger("deleted")},toDateString:function(date){if(!date){return"N/A"}return Globalize.format(date,"d")},isNew:function(){return SM.String.beginsWith(this.ID,"exp-")},isDrive:function(){return this.format==="gss"},finalizeExportData:function(){if(this.format===this.FORMAT.PPT){this.finalizePptExportData()}},finalizePptExportData:function(){var exportData=this.exportData,survey=this.exportJobs.survey,questionList;if(exportData.question_id){questionList=[survey.getQuestion(exportData.question_id)]}else if(this.sourceView.isCurrent){questionList=survey.shownQuestionList}else{questionList=survey.questionList}_.each(questionList,function(question){if(this.canExportQuestionInPPT(question)){exportData.question_ids.push(question.ID)}},this)},canExportQuestionInPPT:function(question){var isOpenEnded=question.isOpenEnded()&&!question.isNumerical();return!(isOpenEnded||question.hasRandomAssignment())}});SM.Models.register("SharedViewList",{__defaults:{isLoaded:false},__create:function(options){this.survey=options.survey;this.list=[];_.bindAll(this,"_onViewsFetched","_onViewsFetchFailed")},add:function(sharedView){var self=this,index;index=_.indexOf(_.pluck(self.list,"key"),sharedView.get("key"));if(index===-1){self.list.push(sharedView);self._trigger({type:"add",sharedView:sharedView})}},remove:function(sharedView){var self=this,index;index=_.indexOf(self.list,sharedView);self.list.splice(index,1);self._trigger({type:"remove",sharedView:sharedView})},load:function(sharedViewsAttrs){var self=this,sharedView,options;_.each(sharedViewsAttrs,function(sharedViewAttrs,index){options={survey:self.survey,list:self,attrs:sharedViewAttrs,index:index};sharedView=SM.Models.create("SharedView",options);self.list.push(sharedView)});self.set("isLoaded",true,{notify:true})},fetch:function(){var data={survey_id:this.survey.ID};if(this.survey.isReadOnly()){this.load()}else{$.when(SM.API.fetchSharedViewList(data),{self:this}).done(this._onViewsFetched).fail(this._onViewsFetchFailed)}},_onViewsFetched:function(doneArgs){var data=doneArgs[0],sharedViewsAttrs=data.shared_views;this.load(sharedViewsAttrs)},_onViewsFetchFailed:function(){}});SM.Models.register("Quota",{__create:function(options){var self=this;self.totalContext=options.quota_data.current_response_count;self.total=options.quota_data.max_response_count;self.label=options.quota_data.display_label;self.filter_group_id=options.quota_data.filter_group_id;self.quota_id=options.quota_data.quota_id;self.quota_equation_id=options.quota_data.quota_equation_id;self.status=options.quota_data.status;if(self.totalContext>self.total){self.totalContext=self.total}self.percent=self.totalContext/self.total}});SM.Models.register("QuotaList",{__create:function(options){var self=this;self.quota_list_data=options.quota_data.model;self.quota_list=[];self.total=0;self.totalContext=0;$.each(self.quota_list_data.equations,function(i,q){self.quota_list.push(SM.Models.create("Quota",{quota_data:q}));self.totalContext+=self.quota_list[i].totalContext;self.total+=self.quota_list[i].total});if(self.totalContext>self.total){self.totalContext=self.total}self.numQuotas=self.quota_list.length;self.percent=self.totalContext/self.total}});SM.Models.register("DataSegment",{__create:function(options){this.segmentList=options.segmentList;this.segmentData=options.segmentData;if(!this.segmentData.isFake){this.segmentData.isFake=false}},getData:function(){return this.segmentData},isDefault:function(){return this.segmentData.isDefault},isFake:function(){return this.segmentData.isFake},name:function(){return this.segmentData.name},getCanonicalName:function(){var isTMBC=this.segmentList.survey.isTMBCTemplate(),isLegacy=this.isLegacy(),isDefault=this.isDefault(),name=isLegacy?this.segmentId:isDefault?"":this.segmentData.id;if(name===""){name=isTMBC?"standout_gei_benchmark":"survey_monkey_global_benchmark"}return name},setName:function(name){this.segmentData.name=name},id:function(){return this.segmentData.id},isLegacy:function(){return!this.id()&&!this.isDefault()},isDerived:function(){return!!this.segmentData._derivedFrom},derivedFrom:function(){return this.segmentData._derivedFrom},segmentId:function(){return this.segmentData.segmentId},keys:function(){return this.segmentData.keys},dateStart:function(){return this.segmentData.date_start},dateEnd:function(){return this.segmentData.date_end},percentileStart:function(){return this.segmentData.percentile_start||0},percentileEnd:function(){return this.segmentData.percentile_end||100},isSelected:function(){return this.segmentData.isSelected},logName:function(){var id=this.id()||this.segmentId(),name=this.name()+"["+id+"]";return name+(this.isDefault()?"(default)":"")},setSelected:function(selected){this.segmentData.isSelected=selected;SM.log((selected?"Selecting ":"Deselecting ")+this.logName())},downloadCSV:function(){var form,hiddenField;form=document.createElement("form");form.setAttribute("method","post");form.setAttribute("action","/analyze/ajax/bm/download_benchmark_data");hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","qids");hiddenField.setAttribute("value",JSON.stringify(this.segmentList.survey.getAllBenchmarkableQuestionLogicalIds()));form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","filter_keys");hiddenField.setAttribute("value",JSON.stringify(this.keys()));form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","date_start");hiddenField.setAttribute("value",this.dateStart());form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","date_end");hiddenField.setAttribute("value",this.dateEnd());form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","percentile_start");hiddenField.setAttribute("value",this.percentileStart());form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","percentile_end");hiddenField.setAttribute("value",this.percentileEnd());form.appendChild(hiddenField);hiddenField=document.createElement("input");hiddenField.setAttribute("type","hidden");hiddenField.setAttribute("name","survey_id");hiddenField.setAttribute("value",this.segmentList.survey.ID);form.appendChild(hiddenField);document.body.appendChild(form);form.submit()}});SM.Models.register("DataSegmentList",{DEFAULT_NAME:"SurveyMonkey Global Benchmark",DATA_SEGMENT_SAVED:"benchmarking:data-segment-saved",DATA_SEGMENT_ERROR:"benchmarking:data-segment-error",DATA_SEGMENT_LOADED:"benchmarking:data-segment-loaded",DATA_SEGMENT_DELETED:"benchmarking:segmentDeleted",DATA_SEGMENT_ADDED:"benchmarking:segmentAdded",DATA_SEGMENT_SELECTION_CHANGED:"benchmarking:selectionChanged",DATA_SEGMENT_SHOWN_CHANGED:"benchmarking:benchmarkShownChanged",PROTOTYPE_SEGMENT_DESCRIPTOR:{name:"No Name",isFake:false,isDefault:false,isSelected:false,keys:[],percentile_start:0,percentile_end:100,date_start:0,date_end:0},__create:function(options){var self=this,isTMBC=options.survey.isTMBCTemplate(),newSegment,selectedSegment,segmentList;this.survey=options.survey;this.defaultView=options.defaultView;this.benchmarkQuestions=options.benchmarkQuestions;this.segmentData=options.segmentData.error?undefined:options.segmentData.data;this.questionMap=this._buildQuestionMap(this.benchmarkQuestions);this.segmentList=[];this.segmentMap={};segmentList=this.defaultView.getBenchmarkSegments();if(!segmentList||segmentList.length===0){newSegment=this._makeSegmentDescriptor(this.DEFAULT_NAME,false);newSegment.isDefault=true;newSegment.isSelected=true;segmentList=[newSegment]}if(this.survey.isCurrentUserAlsoOwner()&&!this.survey.owner.hasBenchmarkingRestricted()){segmentList=segmentList.slice(0,1);newSegment=this._makeSegmentDescriptor(Globalize.localize("Professional Services"),true);segmentList.push(newSegment);newSegment=this._makeSegmentDescriptor(Globalize.localize("Consumer Products"),true);segmentList.push(newSegment)}if(isTMBC){segmentList[0].isSelected=true}_.each(segmentList,function(segmentInfo){var existingSegment;if(isTMBC&&!(segmentInfo.isDefault||segmentInfo.isFake)){return}if(self.segmentData){if(segmentInfo.isDefault&&!!segmentInfo.id){delete segmentInfo.id}if(segmentInfo.id){if(segmentInfo._derivedFrom===segmentList[0].segmentId){existingSegment=segmentList[0]}else if(segmentInfo.isFake){existingSegment=segmentInfo}else{existingSegment=_.find(self.segmentData,function(segment){if(segment.name===segmentInfo.id||segment.name===segmentInfo._derivedFrom){return segment}});if(existingSegment&&existingSegment.logical_bank_question_ids.length===0){existingSegment=null;if(segmentInfo.isSelected){segmentInfo.isSelected=false;self.segmentList[0].setSelected(true)}}}}else{if(segmentInfo.keys.length===1){existingSegment=_.find(self.segmentData,function(segment){if(segment.name===segmentInfo.keys[0]){return segment}});if(existingSegment){existingSegment=null;if(segmentInfo.isSelected){segmentInfo.isSelected=false;self.segmentList[0].setSelected(true)}}else{existingSegment=segmentInfo}}else{existingSegment=segmentInfo}}}else{existingSegment=segmentInfo}if(existingSegment){segmentInfo.date_start=self._make_start_date();segmentInfo.date_end=self._make_end_date();if(segmentInfo._derivedFrom){segmentInfo.name="Top 25%: "+(existingSegment.label||existingSegment.name)}newSegment=self.addSegment(segmentInfo);if(!newSegment){SM.log("Could not create segment for "+segmentInfo.id)}}});if(isTMBC){self.segmentList[0].setName(SM.TMBCModel.TMBC_DEFAULT_NAME)}else{_.each(this.segmentData,function(segment,canonicalName){var segmentInfo;if(segment.logical_bank_question_ids.length>0){segmentInfo={name:segment.label,isDefault:false,isSelected:false,percentile_start:0,percentile_end:100,date_start:self._make_start_date(),date_end:self._make_end_date()};segmentInfo.id=canonicalName;segmentInfo.keys=[canonicalName];self.addSegment(segmentInfo)}})}selectedSegment=_.find(this.segmentList,function(segment){if(segment.segmentData.isSelected){return true}});if(!selectedSegment){this.segmentList[0].segmentData.isSelected=true}},_makeSegmentDescriptor:function(name,isFake){var descriptor=$.extend(true,{},this.PROTOTYPE_SEGMENT_DESCRIPTOR);descriptor.name=name;descriptor.segmentId=this._makeSegmentId(name);if(isFake){descriptor.id=descriptor.segmentId}descriptor.isFake=isFake;descriptor.date_start=this._make_start_date();descriptor.date_end=this._make_end_date();descriptor.percentile_start=0;descriptor.percentile_end=100;return descriptor},addDerivedSegment:function(sourceSegment,derivationType){var onDone=function(){self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ADDED,segment:context.segment});SM.Bi.logSegmentSwitch(segmentFrom,segmentTo);self._fetchAllBenchmarkRollups(context)},onFail=function(){var errName="Save New Segment failed",errMsg="Save segment ["+sourceSegment.name+"] failed.";SM.API.logError({name:errName,message:errMsg});self._removeSegment(context.segment.segmentId());context.previouslySelectedSegment.segmentData.isSelected=true;errMsg="We were unable to save your new data segment. Please try again later.";self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})};var self=this,derivedInfo=$.extend({},sourceSegment.segmentData),context={self:this},newSegment,segmentFrom=sourceSegment.getCanonicalName(),segmentTo;if(derivationType==="top25"){derivedInfo.name="Top 25%: "+sourceSegment.name();derivedInfo.isDefault=false;derivedInfo.isSelected=false;derivedInfo.percentile_start=75;derivedInfo.id=sourceSegment.segmentId()+"_top_25";derivedInfo.segmentId=derivedInfo.id;derivedInfo._derivedFrom=sourceSegment.segmentId();newSegment=this.addSegment(derivedInfo);if(newSegment){segmentTo=newSegment.getCanonicalName();context.segment=newSegment;context.previouslySelectedSegment=this.getSelectedSegment();context.previouslySelectedSegment.segmentData.isSelected=false;context.segment.segmentData.isSelected=true;if(self.survey.isReadOnly()){onDone()}else{SM.API.logSetUiTrigger("segment_tile_add");self.save({done:onDone,fail:onFail})}}else{SM.log("Could not create segment for "+derivedInfo.id)}}else{SM.log("addDerivedSegment: derivation type "+derivationType+" not yet supported")}},loadSegmentData:function(){},_get_quarter_start:function(){var monthNow=moment().month(),quarterMoment;monthNow=Math.floor(monthNow/3)*3;quarterMoment=moment().month(monthNow);quarterMoment.date(1);return quarterMoment},_make_start_date:function(){var startMoment=this._get_quarter_start();startMoment.subtract(1,"y");return startMoment.unix()},_make_end_date:function(){var endMoment=this._get_quarter_start();endMoment.subtract(1,"d");return endMoment.unix()},hasBenchmarking:function(){return this.survey.owner.hasBenchmarking()},hasRestrictedFeatures:function(){return this.survey.owner.hasBenchmarkingRestricted()},getCountOfBenchmarkableQuestions:function(){return this.survey.getCountOfBenchmarkableQuestions()},hasPaidBenchmarks:function(){return!!_.find(this.segmentList,function(segment){if(!segment.isLegacy()&&!segment.isDerived()&&!segment.isDefault()&&!segment.isFake()){return true}})},_buildQuestionMap:function(questionList){var map={};_.each(questionList,function(question){map[question.name]=question});return map},getQuestionOptions:function(){var questions=this.benchmarkQuestions,options=[{label:Globalize.localize("Choose"),value:"",selected:true},{label:Globalize.localize("All Organizations"),value:"all",selected:false}];_.each(questions,function(question){options.push({label:question.attributes.label,value:question.name,selected:false})});return options},getOptionOptions:function(optionType){var question=this.questionMap[optionType],options=[{label:Globalize.localize("Choose"),value:"",selected:true}];_.each(question.answers.rows,function(answer){options.push({label:answer.text,value:answer.name,selected:false})});return options},getKeyInfo:function(question,key){var keyInfo=_.find(question.answers.rows,function(row){return row.name===key});return keyInfo},getSegmentInfoForKey:function(key){var self=this,segmentInfo={};_.each(this.questionMap,function(question,optionType){var keyInfo=self.getKeyInfo(question,key);if(keyInfo){segmentInfo.type=optionType;segmentInfo.typeName=question.attributes.label;segmentInfo.key=key;segmentInfo.keyName=keyInfo.text}});return segmentInfo},_makeSegmentName:function(segmentDescriptor){var self=this,name="";if(segmentDescriptor.isDefault){return segmentDescriptor.name}if(segmentDescriptor.keys.length>0){_.each(segmentDescriptor.keys,function(key,index){var segmentInfo=self.getSegmentInfoForKey(key);if(index>0){name=name+", "}name=name+segmentInfo.typeName+": "+segmentInfo.keyName})}else{name=Globalize.localize("All Organizations")}if(segmentDescriptor.percentile_start===75){name=Globalize.localize("Top 25%, ")+name}else if(segmentDescriptor.percentile_start===90){name=Globalize.localize("Top 10%, ")+name}return name},_makeSegmentId:function(name){if(name){return name.replace(/ /g,"_")}},buildSegmentDescriptor:function(segmentChoice,subsegmentChoice,percentileChoice){var segmentDescriptor={keys:[],percentile_end:100};if(segmentChoice!=="all"){if(subsegmentChoice===""){segmentDescriptor.keys.push(segmentChoice)}else{segmentDescriptor.keys.push(subsegmentChoice)}}segmentDescriptor.percentile_start=percentileChoice;segmentDescriptor.name=this._makeSegmentName(segmentDescriptor);segmentDescriptor.segmentId=this._makeSegmentId(segmentDescriptor.name);segmentDescriptor.date_start=this._make_start_date();segmentDescriptor.date_end=this._make_end_date();return segmentDescriptor},save:function(options){var segmentData=[];options=options||{};_.each(this.segmentList,function(segment){if(!segment.isFake()){segmentData.push(segment.getData())}});this.defaultView.setBenchmarkSegments(segmentData,options)},_onFetchBenchmarkRollupsDone:function(context,args){var self=context.self,data=args[0],$accordion,accordion;SM.log("bmFetchBenchmarkRollups succeeded.");SM.log("triggering newSegmentLoaded");self.survey.benchmarkRollups.loadRollups(data,true);self.survey.driverRollups.loadRollups(data);self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_LOADED,segment:context.segment,benchmarkData:data});self.set("isLoading",false,{notify:true});$accordion=$(".analyze-secondary-column.accordion");accordion=$accordion.accordion().data("accordion");if(accordion){accordion.open("DataSegmentBuilderViewContainer")}},_onFetchBenchmarkRollupsFail:function(context,data){var errName="Fetch Benchmark data failed",errMsg="bmFetchBenchmarkRollups failed with "+data;this.set("isLoading",false,{notify:true});SM.API.logError({name:errName,message:errMsg});errMsg="We were unable to retrieve the benchmark data at this time. Please try again later.";this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})},_fetchAllBenchmarkRollups:function(context){var self=this,params={view_data:this.defaultView.dump(),question_ids:[]};self.set("isLoading",true,{notify:true});self.lastFetchRequest=SM.API.bmFetchBenchmarkRollups(params);$.when(context,self.lastFetchRequest).done(self._onFetchBenchmarkRollupsDone).fail(function(data){self._onFetchBenchmarkRollupsFail(context,data)})},createNewSegment:function(segmentChoice,subsegmentChoice,percentileChoice){var onDone=function(){self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ADDED,segment:context.segment});SM.Bi.logSegmentSwitch(segmentFrom,segmentTo);self._fetchAllBenchmarkRollups(context)},onFail=function(){var errName="Save New Segment failed",errMsg="Save segment ["+segmentChoice+", "+subsegmentChoice+", "+percentileChoice+"] failed.";SM.API.logError({name:errName,message:errMsg});self._removeSegment(context.segment.segmentId());errMsg="We were unable to save your new data segment. Please try again later.";self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})};var self=this,context={self:this},segmentDescriptor=this.buildSegmentDescriptor(segmentChoice,subsegmentChoice,percentileChoice),currentSegment=this.getSelectedSegment().id(),segmentFrom=currentSegment.getCanonicalName(),segmentTo;if(this._validateId(segmentDescriptor.segmentId)){this.deselectAll();segmentDescriptor.isDefault=false;segmentDescriptor.isSelected=true;context.segment=this.addSegment(segmentDescriptor);if(context.segment){segmentTo=context.segment.getCanonicalName();SM.API.logSetUiTrigger("segment_tile_add");this.save({done:onDone,fail:onFail})}return true}SM.log("Attempted to create duplicate segment");return false},_onEnableBenchmarksDone:function(){SM.log("EnableBenchmarks succeeded");this._fetchAllBenchmarkRollups({self:this})},_onEnableBenchmarksFail:function(){var errName="Show/Hide Benchmark(s) failed",errMsg="We were unable to show or hide your benchmark(s) at this time. Please try again later.";SM.API.logError({name:errName,message:errName});this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})},enableAllBenchmarks:function(enable){var self=this,request=self.defaultView.enableAllBenchmarks(enable);if(request===true){self._onEnableBenchmarksDone()}else{request.done(function(data){self._onEnableBenchmarksDone(data)}).fail(function(msg,err,rq){self._onEnableBenchmarksFail(msg,err,rq)})}},deselectAll:function(){_.each(this.segmentList,function(segment){segment.setSelected(false)})},toggleSelection:function(dataSegment){if(!dataSegment.isDefault()||this.count()>1){SM.API.logSetUiTrigger("segment_tile");this.selectSegment(dataSegment)}},getSelectedSegment:function(){var selectedSegment;_.each(this.segmentList,function(segment){if(segment.isSelected()){selectedSegment=segment}});return selectedSegment},_onSwitchSegmentDone:function(context,args){var self=context.self,data=args[0];SM.log("SwitchSegment succeeded");SM.log("triggering segmentSelectionChanged");self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_SELECTION_CHANGED});self.set("isLoading",false,{notify:true});SM.log("triggering newSegmentLoaded");self.survey.benchmarkRollups.loadRollups(data,true);SM.Bi.logSegmentSwitch(context.segmentFrom,context.segmentTo,context.source)},_onSwitchSegmentFail:function(context,data){var errName="Switch Segment Failed",errMsg="Switch segment failed with "+data;this.set("isLoading",false,{notify:true});SM.API.logError({name:errName,message:errMsg});errMsg="We were unable to switch segments. Please try again later.";this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})},switchSegment:function(segmentDescriptor,segmentFrom,segmentTo,source){var self=this,params={view_data:this.defaultView.dump(),question_ids:[]},context={self:this,segmentFrom:segmentFrom,segmentTo:segmentTo,source:source};context.segment=segmentDescriptor;self.set("isLoading",true,{notify:true});self.lastFetchRequest=SM.API.bmFetchBenchmarkRollups(params);$.when(context,self.lastFetchRequest).done(self._onSwitchSegmentDone).fail(function(data){self._onSwitchSegmentFail(context,data)})},selectSegment:function(dataSegment,segmentFrom,source){var self=this,currentSegment=self.getSelectedSegment(),segmentTo;var onDone=function(){self.switchSegment(dataSegment.getData(),segmentFrom,segmentTo,source)};var onFail=function(){self._onSwitchSegmentFail({self:this},"Select Segment failed")};if(!segmentFrom){if(!currentSegment){segmentFrom=""}else{segmentFrom=currentSegment.getCanonicalName()}}if(!dataSegment.isSelected()){this.deselectAll();dataSegment.setSelected(true)}else if(dataSegment.isDefault()){return}else{dataSegment.setSelected(false);dataSegment=this.getDefault();dataSegment.setSelected(true)}segmentTo=dataSegment.getCanonicalName();if(self.survey.isReadOnly()){onDone()}else{self.save({done:onDone,fail:onFail})}},_validateId:function(id){var found=false;if(!id){return false}_.each(this.segmentList,function(segment){if(id===segment.segmentId()){found=true}});return!found},count:function(){return this.segmentList.length},countSelected:function(){var count=0;_.each(this.segmentList,function(segment){if(segment.isSelected()){count+=1}});return count},getDefault:function(){var defaultSegment=_.find(this.segmentList,function(segment){if(segment.isDefault()){return segment}});if(!defaultSegment){SM.log("Error: no default segment!")}return defaultSegment},_findFirstOldSegmentIndex:function(){var first=-1;$.each(this.segmentList,function(i,segment){if(!segment.isDefault()&&!segment.id()){first=i;return false}});return first},_findDerivedFromIndex:function(derivedFrom){var index=-1;if(this.segmentList[0]&&derivedFrom===this.segmentList[0].segmentId()){return 0}$.each(this.segmentList,function(i,segment){if(segment.id()===derivedFrom){index=i;return false}});return index},findDerived:function(segment){var derived=_.find(this.segmentList,function(otherSegment){if(segment.isDefault()){if(segment.segmentId()===otherSegment.derivedFrom()){return otherSegment}}else if(segment.id()===otherSegment.derivedFrom()){return otherSegment}});return derived},_createSegment:function(segmentData){var segment,index=-1;segment=SM.Models.create("DataSegment",{segmentList:this,segmentData:segmentData});this.segmentMap[segmentData.segmentId]=segment;SM.log("Creating segment "+segment.logName());if(segmentData.id){if(segment.isDerived()){index=this._findDerivedFromIndex(segment.derivedFrom());if(index<0){SM.API.logWarning({message:"Segment "+segment.logName()+"was derived from cannot be found"});index=this._findFirstOldSegmentIndex()}if(index<0){this.segmentList.push(segment)}else{this.segmentList.splice(index+1,0,segment)}}else{index=this._findFirstOldSegmentIndex();if(index<0){this.segmentList.push(segment)}else{this.segmentList.splice(index,0,segment)}}}else{this.segmentList.push(segment)}SM.log("added "+segment.logName());return segment},_removeSegments:function(segments){var self=this;_.each(segments,function(thisSegment){var segmentId=thisSegment.segmentId(),index=self.getSegmentIndex(segmentId);SM.log("removing "+thisSegment.logName());self.segmentList.splice(index,1);delete self.segmentMap[segmentId]})},_removeSegment:function(segmentId){var self=this,segment=this.segmentMap[segmentId],index=this.getSegmentIndex(segmentId),derivedFrom=segment.id(),segmentsToRemove=[segment];if(index){if(!segment.isDerived()&&!segment.isLegacy()){_.each(self.segmentList,function(otherSegment){if(derivedFrom===otherSegment.derivedFrom()){segmentsToRemove.push(otherSegment)}})}this._removeSegments(segmentsToRemove);return true}SM.log("Couldn't find segment with id "+segmentId);return},addSegment:function(segmentData){var id=segmentData.segmentId,segment;if(segmentData.isDefault){segmentData.name="SurveyMonkey Global Benchmark";id="sm_average_global"}if(!id||id===""){if(segmentData.id){id=segmentData.id}else{id=this._makeSegmentId(segmentData.name)}}if(this._validateId(id)){segmentData.segmentId=id;segment=this._createSegment(segmentData);return segment}},getSegmentIndex:function(segmentId){var index=-1;_.find(this.segmentList,function(segment,i){if(segment.segmentId()===segmentId){index=i;return true}});if(index===-1){SM.log("Could not find segment with id "+segmentId)}return index},findSegmentById:function(segmentId){return _.find(this.segmentList,function(segment){if(segment.id()===segmentId||segment.segmentId()===segmentId){return true}})},deleteSegment:function(segment){var self=this,segmentId=segment.segmentId(),segmentRemoved=segment.getCanonicalName(),removed=this._removeSegment(segmentId),defaultSegment=this.getDefault();var onDone=function(){self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_DELETED,segmentId:segmentId});SM.Bi.logSegmentRemoved(segmentRemoved)};var onFail=function(){var segmentData=segment.getData(),errName="Failed to Delete Segment",errMsg="Failed to delete segment with id "+segmentId;SM.API.logError({name:errName,message:errMsg});self._createSegment(segmentData);errMsg="We were unable to delete that data segment. Please try again later.";self._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})};if(removed){if(self.countSelected()===0){SM.API.logSetUiTrigger("segment_tile_remove");self.selectSegment(defaultSegment,segmentRemoved)}else if(self.survey.isReadOnly()){onDone()}else{self.save({done:onDone,fail:onFail})}}}});SM.AnalyzeLoaderView=SM.Views.register({__NAME:"analyzeLoaderView",__templateID:"analyze-content-loader-template",__defaults:{defaultTop:200,isFixed:false},__getters:{isFixed:function(self){if(SM.Browser.isIE7){return false}return self.__settings.isFixed}},show:function(){if(this.get("isFixed")){this.$el.css({position:"fixed",top:"50%",marginTop:-(this.$el.outerHeight()/2)})}else{this.$el.css({position:"absolute",top:this.get("defaultTop"),marginTop:0})}this.$el.removeClass("exit").removeClass("hide");this._isShown=true},hide:function(){var self=this;if(self._isShown){self._isShown=false;setTimeout(function(){if(!self._isShown){self.$el.addClass("exit");self.$el.css("top","-=200");setTimeout(function(){if(!self._isShown){self.$el.addClass("hide")}},400)}},400)}}});SM.ResponseLimitUpgradeView=SM.Views.register({__NAME:"responseLimitUpgradeView",__model:"survey",__templateID:"upgrade-response-limit-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountChange)},__beforeRender:function(){var counts=this.survey.respondentCounts,owner=this.survey.owner;if(this.survey.hasFilteredRespondents()){return{responseCount:Globalize.format(counts.total,"n0"),responseLimit:Globalize.format(owner.responseLimit,"n0"),packageType:owner.packageType,classes:this.__settings.classes,linkSource:this.__settings.linkSource}}return{classes:this.__settings.classes,linkSource:this.__settings.linkSource}},_onCountChange:function(e){var self=e.data.self;self.render()}});SM.NoResponsesView=SM.Views.register({__NAME:"noResponsesView",__templateID:"no-responses-template",__model:"survey",__beforeRender:function(){var survey=this.survey;return{surveyIDEncryption:survey.encryptedID,classes:this.__settings.classes,shouldShowBuyResponsesButton:survey.isCurrentUserAlsoOwner()&&Globalize.culture().name==="en",isCollectNoAccess:survey.isCurrentUserCollectNoAccess,surveyID:survey.ID,onSharedPage:SM.App.isSharingApp()}}});SM.AnalyzeContentView=SM.Views.register({__NAME:"analyzeContentView",__model:"survey",__templateID:"analyze-pages-content-container",__init:function(){var survey=this.survey,state=survey.state;
if(state.isSummaryMode()){this.bindModel(survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);if(survey.owner.hasBenchmarking()){this.bindModel(survey.benchmarkRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(survey.dataSegmentList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}}else if(state.isBrowseMode()){this.bindModel(survey,"respondentCounts.changed",{self:this},this._onRespondentCountChanged);this.bindModel(survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}else if(state.isTrendMode()){this.bindModel(survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged)}this.bindModel(state,"page.changed",{self:this},this._onPageChange);this.bindModel(survey,"shownListsChanged",{self:this},this._onPageChange)},__beforeRender:function(){var hasBenchmarkableQuestions=this.survey.getCountOfBenchmarkableQuestions()>0,hasFilteredRespondents=this.survey.hasFilteredRespondents(),hasRespondents=this.survey.hasRespondents(),hasShownQuestions=this.survey.shownQuestionList.length>0,hasQuestions=this.survey.questionCount>0,state=this.survey.state;if(state.isSummaryMode()&&!SM.App.isSharingApp()&&!hasFilteredRespondents&&hasBenchmarkableQuestions){hasFilteredRespondents=true;hasRespondents=true}return{hasQuestions:hasQuestions,hasShownQuestions:hasShownQuestions,hasRespondents:hasRespondents,hasFilteredResponses:hasFilteredRespondents}},__afterRender:function(md){var self=this,content,survey=self.survey,surveyState=survey.state,modelState=self._getModelState();if(modelState.failed){content=SM.Template.renderHTML("content-load-error-template",{classes:"mod-no-header",requestID:modelState.requestID})}else if(!md.hasQuestions){content=SM.Template.renderHTML("no-questions-template",{surveyIDEncryption:survey.encryptedID,classes:"mod-no-header"})}else if(!md.hasRespondents){content=SM.Views.create(SM.NoResponsesView,{model:survey,classes:"mod-no-header"}).el}else if(!md.hasFilteredResponses){content=SM.Template.renderHTML("filtered-no-responses-template",{classes:"mod-no-header"})}else if(surveyState.isSummaryMode()){if(survey.isQuiz){self.quizSummaryView=SM.Views.create(SM.SummaryQuizSummaryView,{model:survey.getQuizSummary(),isExport:false});self.el.appendChild(self.quizSummaryView.el);if(!surveyState.get("allPagesSelected")&&surveyState.get("page")>0){$(self.quizSummaryView.el).addClass("hide")}}content=SM.Views.create(SM.SummaryPageListView,{model:survey}).el}else if(surveyState.isBrowseMode()){content=SM.Views.create(SM.RespondentListView,{model:survey}).el}else if(surveyState.isTrendMode()){content=SM.Views.create(SM.TrendContainerView,{model:survey.trendsModel}).el}self.el.appendChild(content)},_getModelState:function(){var survey=this.survey,state=survey.state;if(state.isSummaryMode()){return{requestID:survey.questionRollups.get("failedLoadRequestID"),failed:survey.questionRollups.get("failedLoad")}}else if(state.isBrowseMode()){return{requestID:survey.respondentsList.get("failedLoadRequestID"),failed:survey.respondentsList.get("failedLoad")}}else if(state.isTrendMode()){return{requestID:survey.trendsModel.get("failedLoadRequestID"),failed:survey.trendsModel.get("failedLoad")}}},_onIsLoadingChanged:function(e){var self=e.data.self,isLoading=e.value;if(!isLoading){self.render();self.$el.removeClass("disabled")}else{self.$el.addClass("disabled")}},_onRespondentCountChanged:function(e){var self=e.data.self;if(!self.survey.hasFilteredRespondents()){self.render()}},_onPageChange:function(e){var self=e.data.self,survey=self.survey;if(survey.isQuiz&&self.quizSummaryView){$(self.quizSummaryView.el).toggleClass("hide",!survey.state.get("allPagesSelected")&&survey.state.get("page")>0)}}});SM.AnalyzeContentWrapperView=SM.Views.register({__NAME:"analyzeContentWrapperView",__model:"survey",__templateID:"analyze-pages-content-wrapper-container",__init:function(){var state=this.survey.state;if(state.isSummaryMode()){this.bindModel(this.survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.questionRollups,"isUpdating.changed",{self:this},this._onIsUpdatingChanged);if(this.survey.owner.hasBenchmarking()){this.bindModel(this.survey.benchmarkRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.dataSegmentList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}}else if(state.isBrowseMode()){this.bindModel(this.survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}else if(state.isTrendMode()){this.bindModel(this.survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged)}this._isLoading=false;this._isUpdating=false},__destroy:function(){$(window).off("scroll."+this.__uid+"."+this.__NAME);this._loaderView=null},__afterRender:function(){var contentView;this._loaderView=SM.Views.create(SM.AnalyzeLoaderView);contentView=SM.Views.create(SM.AnalyzeContentView,{model:this.survey});this.el.appendChild(this._loaderView.el);this.el.appendChild(contentView.el)},_showSpinner:function(){this.$el.css({height:this.$el.height(),width:this.$el.width()});this.$el.find("[analyze-mode-spinner-backdrop]").removeClass("hide").addClass("disabled");this._loaderView.show();$(window).on("scroll."+this.__uid+"."+this.__NAME,{self:this},this._onScroll);$(window).scroll()},_hideSpinner:function(){this.$el.find("[analyze-mode-spinner-backdrop]").addClass("hide").removeClass("disabled");this.$el.css({height:"auto",width:"auto"});$(window).off("scroll."+this.__uid+"."+this.__NAME,this._onScroll);this._loaderView.hide()},_onIsLoadingChanged:function(e){var self=e.data.self,isLoading=e.value;if(isLoading){self._isLoading=true;setTimeout(function(){if(!self._isLoading){return}self._showSpinner()},400)}else{self._isLoading=false;setTimeout(function(){self._hideSpinner()},0)}},_onIsUpdatingChanged:function(e){var self=e.data.self,isUpdating=e.value;if(isUpdating){self._isUpdating=true;self._showSpinner()}else{self._isUpdating=false;setTimeout(function(){self._hideSpinner()},0)}},_onScroll:function(e){var self=e.data.self,parentOffset=self.$el.offset(),scrollTop=$(window).scrollTop();if(scrollTop<parentOffset.top){self._loaderView.$el.css("top",100)}else{self._loaderView.$el.css("top",100+scrollTop-parentOffset.top)}}});SM.AnRuleListItemView=SM.Views.register({__model:"ruleModel",__templateID:"rule-list-item-view",__NAME:"AnRuleListItemView",__defaults:{rule_id:undefined,isToggleable:true,isDisabled:false,renameMode:false},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onRuleClick);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":this._deleteClick,"FunctionListItem.DeleteView.cancelClicked":this.showMenu,"FunctionListItem.RenameView.Canceled":this.showMenu,"FunctionListItem.RenameView.Renamed":function(e){self.ruleModel.set("customHeading",e.newName,{notify:true});SM.Bi.ruleRename(self.ruleModel);self.__settings.isToggleable=true;self.__settings.renameMode=false;self.render()}},{self:this});this.bindModel(this.ruleModel,"ruleEdited",{self:this},this._onRuleChanged);this.bindModel(this.ruleModel,"isCorrupt.changed",{self:this},this._onRuleChanged);if(this.ruleModel.isCompare){this.bindModel(this.ruleModel,"selected.changed",{self:this},this._onCompareSelectedChanged)}},__beforeRender:function(){var self=this,md;if(this.ruleModel.get("isCorrupt")){this.__settings.deleteMode=true}try{md={name:this.ruleModel.get("heading"),isDisabled:this.__settings.isDisabled,isActive:this.ruleModel.get("selected"),renameMode:this.__settings.renameMode,deleteMode:this.__settings.deleteMode,toggleAnimate:this.__settings.toggleAnimate,isToggleable:this.__settings.isToggleable,isCorrupt:this.ruleModel.get("isCorrupt"),ruleFamily:Globalize.localize(this.ruleModel.ruleFamily)+": ",rule_id:this.ruleModel.ID}}catch(e){self.ruleModel.set("isCorrupt",true);self.__settings.deleteMode=true;md={name:"Corrupted",isDisabled:true,isActive:false,renameMode:false,isCorrupt:true,toggleAnimate:false,isToggleable:false,deleteMode:this.__settings.deleteMode,rule_id:this.ruleModel.ID};self._handleRenderingError(e)}return md},__afterRender:function(md){var functionListWidgetView,menuIsShown=!this.__settings.renameMode&&!this.__settings.deleteMode,$listItem=this.$el.children(".list-item");if(menuIsShown){this.$el.find("a.btn-menu-down").actionMenu({templateID:"rule-menu-template",isActive:md.isActive,isDisabled:this.__settings.isDisabled,includeMenuCopy:!this.ruleModel.isShow,disableMenuCopy:this.ruleModel.survey.owner.hasRuleLimit()})}else{if(this.__settings.renameMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:md.name});functionListWidgetView.open()}else if(this.__settings.deleteMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true,hasCancel:!this.ruleModel.get("isCorrupt")})}$listItem.prepend(functionListWidgetView.el)}if(this.__settings.toggleAnimate){this.$el.toggleClass("active",md.isActive)}},_handleRenderingError:function(exception){var self=this;SM.Error.log(exception,"RuleRenderingException: Rule#"+self.ruleModel.ID+", Survey#"+SM.App.survey.ID)},showMenu:function(e){var self=e.data.self;self.__settings.renameMode=false;self.__settings.deleteMode=false;self.__settings.isToggleable=true;self.__settings.toggleAnimate=false;self.render()},_onRuleChanged:function(e){e.data.self.render()},_disable:function(e){var self=e.data.self;self.__settings.isToggleable=false;self.__settings.isDisabled=true;self.__settings.toggleAnimate=false;self.render()},_enable:function(e){var self=e.data.self;self.__settings.isToggleable=true;self.__settings.isDisabled=false;self.__settings.toggleAnimate=false;self.render()},_deleteClick:function(e){var self=e.data.self;SM.Bi.ruleDelete(e.data.self.ruleModel);e.data.self.ruleModel.deleteRule();self.$el.remove()},_onCompareSelectedChanged:function(e){var self=e.data.self;self.__settings.toggleAnimate=true;self.render()},_onMenuAction:function(e){var self=e.data.self;self[e.action]()},_menuCopyClick:function(){SM.Bi.uiTrigger="copyRuleItemMenu";SM.Bi.ruleCopy(this.ruleModel);this.ruleModel.copyRule()},_menuEditClick:function(){SM.Bi.uiTrigger="editRuleItemMenu";this.trigger("editClicked")},_menuDeleteClick:function(){SM.Bi.uiTrigger="deleteRuleItemMenu";this.__settings.isToggleable=false;this.__settings.deleteMode=true;this.__settings.toggleAnimate=false;this.render()},_menuRenameClick:function(){SM.Bi.uiTrigger="renameRuleItemMenu";this.__settings.renameMode=true;this.__settings.isToggleable=false;this.__settings.toggleAnimate=false;this.render()},_menuToggleRule:function(){SM.Bi.uiTrigger="applyRuleItemMenu";this._toggleRule()},_onRuleClick:function(e){var self=e.data.self;e.preventDefault();if(self.ruleModel.get("isCorrupt")){return}if(!self.__settings.isDisabled&&self.__settings.isToggleable){SM.Bi.uiTrigger="ruleItem";self._toggleRule()}},_toggleRule:function(){SM.Bi.ruleToggle(this.ruleModel);this.__settings.toggleAnimate=true;this.ruleModel.toggleRule()}});SM.AnRuleView=SM.Views.register({__model:"ruleModel",__templateID:"an-rule-template",__NAME:"AnRuleView",__init:function(){var self=this,selfDestruct=function(){self.$el.remove()};this.$el.on({"RuleView.destroy":function(){self.ruleModel.set("editMode",false);selfDestruct()},"RuleView.applied":function(){if(!self.ruleModel.isNew){setTimeout(selfDestruct,self.COLLAPSE_DELAY)}else{selfDestruct()}},"RuleButtons.cancelClicked":function(){self.ruleModel.set("editMode",false);if(!self.ruleModel.isNew){setTimeout(selfDestruct,self.COLLAPSE_DELAY)}else{selfDestruct()}}})},COLLAPSE_DELAY:300,modelEditViewMap:{FilterRespondentDataAnRule:"RespDataRuleEditView",FilterCollectorAnRule:"CollectorRuleEditView",FilterCompletenessAnRule:"CompletenessRuleEditView",FilterTimePeriodAnRule:"TimePeriodRuleEditView",FilterRandomAssignmentRule:"RARuleEditView",CompareRandomAssignmentRule:"RARuleEditView",QnaMatrixAnRule:"QNAMatrixRuleEditView",QnaRatingCommentPerRowAnRule:"QNAMatrixRuleEditView",QnaMenuMatrixAnRule:"QNAMenuMatrixRuleEditView",SourceSurveysRule:"SourceSurveysRuleEditView",QnaSimpleAnRule:"QNASimpleRuleEditView",QnaOpenEndedAnRule:"QNA_OEndedRuleEditView",QnaDatetimeAnRule:"QNA_DatetimeRuleEditView",QnaNumericalAnRule:"QNA_NumericalRuleView",ShowAnRule:"ShowRuleEditView"},__afterRender:function(){var editViewClass=this.modelEditViewMap[this.ruleModel.__NAME];var editView=SM.Views.create(SM[editViewClass],{model:this.ruleModel});this.el.appendChild(editView.el)}});SM.BaseRuleEditView={__model:"ruleModel",__templateID:"rule-edit-view",__init:function(){this.$el.on("submit",{self:this},this._onFormSubmit).on("RuleButtons.applyClicked",{self:this},this._applyClk);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet);if(this.ruleModel.isNew){this.buttons.applyDisable()}this.$el.find(".plate").on("click",{self:this},this._onEditSidi)},__setters:{applyEnabled:function(self,value){if(value){self.buttons.applyEnable()}else{self.buttons.applyDisable()}}},_buildChoiceGroup:function(options){var self=this;return $.map(options,function(option){return SM.Views.create(SM.SimpleRuleChoiceView,{model:self.ruleModel,text:option.text,showCollectorType:option.showCollectorType,type:option.type,id:option.id}).el})},__afterRender:function(){var sourceSurveysQuestionId;if(SM.App.isMerveysApp()){sourceSurveysQuestionId=SM.App.survey.getSourceSurveysQuestionId()}this.buttons=SM.Views.create(SM.RuleButtonsView,{model:this.ruleModel});this._renderChoices();this._afterRenderChoices();if(this.ruleModel.isCompare&&this.ruleModel.get("questionID")!==sourceSurveysQuestionId){this._renderSidiRuleEdit();this.$el.find(".q").popout()}this.$el.append(this.buttons.el)},_renderSidiRuleEdit:function(){var self=this,html,checked,canBuy,question=self.ruleModel.getQuestion(),survey=question.survey,enoughResponses=survey.respondentCounts.total>=30,upgradeSidi=!survey.owner.canSigDiffs();if(!self.ruleModel.isCompare||!survey.state.isSummaryMode()||question.hasRandomAssignment()){return}if(upgradeSidi){html=SM.Template.renderHTML("sidi-rule-edit-view-upgrade",{hide:this.__NAME==="QNAMatrixRuleView"})}else{canBuy=Globalize.culture().name==="en";if(enoughResponses){checked=survey.anviews.defaultView.appliedSidi()}html=SM.Template.renderHTML("sidi-rule-edit-view",{hide:this.__NAME==="QNAMatrixRuleView"&&self.ruleModel.get("editMode")!==true,surveyID:survey.ID,checked:checked,canBuy:canBuy,enoughResponses:enoughResponses})}$(this.el).append(html)},_onEditSidi:function(e){var self=e.data.self,$el,$plate;$el=self.$el.find(".sidi-switch");$plate=$el.find(".plate");if(!$plate.hasClass("disabled")){$el.toggleClass("off");self.ruleModel.set("isDirty",true,{notify:true})}},_onShowUpgradeDialog:function(){this._showUpgradeDialog("sig-diff-upgrade-dialog-template")},_showUpgradeDialog:function(templateID){var upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID});upgradeDialog.open()},_onUpgradeBtnClicked:function(e){e.stopImmediatePropagation()},_afterRenderChoices:function(){},_renderChoices:function(){},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.get("rows"))!==undefined;self.set("applyEnabled",applyEnabled)},_onFormSubmit:function(e){e.data.self._applyClk(e)},_applyClk:function(e){var self=e.data.self,ruleModel=self.ruleModel,valid=self.ruleModel.commit(),$el,checked;SM.Bi.ruleApplied(self.ruleModel);e.preventDefault();if(!valid){self.render();return}$el=self.$el.find(".sidi-switch");if($el.length){checked=!$el.hasClass("off");self.ruleModel.getQuestion().page.survey.anviews.defaultView.updateSidiAll(checked)}if(!ruleModel.get("selected")||ruleModel.get("isDirty")){ruleModel.set("selected",true);ruleModel.applyRule();self.dirty=false}self.$el.trigger("RuleView.applied",self)}};SM.RuleButtonsView=SM.Views.register({__NAME:"RuleButtonsView",__templateID:"rule-buttons-template",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CLICK,".btn.cancel",{self:this},this._cancelClk);if(!this._hasUpgradeButton()){this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},this._applyClk)}else{this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},function(e){e.preventDefault();SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"rules-upgrade-dialog-template"}).open()})}},__defaults:{applyDisabled:false},__beforeRender:function(){return{applyDisabled:this.__settings.applyDisabled}},applyDisable:function(){if(this._hasUpgradeButton()){return}this.__settings.applyDisabled=true;this.render()},applyEnable:function(){if(this._hasUpgradeButton()){return}this.__settings.applyDisabled=false;this.render()},_hasUpgradeButton:function(){var user=this.ruleModel.survey.owner;return user.isOverRuleLimit()&&this.ruleModel.isNew},_cancelClk:function(e){e.preventDefault();e.data.self.$el.trigger("RuleButtons.cancelClicked")},_applyClk:function(e){var self=e.data.self;e.preventDefault();if(!self.__settings.applyDisabled){self.$el.trigger("RuleButtons.applyClicked")}}});SM.QNARuleEditView=SM.Object.extend(SM.BaseRuleEditView,{__templateID:"qna-rule-edit-view",_afterRenderChoices:function(){var question=this.ruleModel.getQuestion(),commentFieldChoiceView;if(!this.ruleModel.isCompare){if(question.commentField){commentFieldChoiceView=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.choiceSet});this.$el.append(commentFieldChoiceView.el)}}},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.choiceSet.get("rows"))!==undefined;self.set("applyEnabled",applyEnabled)},_buildChoiceGroup:function(options){var self=this;return _.map(options,function(option){return SM.Views.create(SM.QNA_SimpleRuleChoiceView,{model:self.ruleModel.choiceSet,text:option.text,id:option.id}).el})},__beforeRender:function(){var q=this.ruleModel.getQuestion();return{position:q.position,heading:q.heading}}});SM.QNASimpleRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNASimpleRuleView",_renderChoices:function(){var ruleModel=this.ruleModel,question=ruleModel.getQuestion(),choices;if(question.isNPS()){choices=this._buildChoiceGroupNps(question.rowList)}else{choices=this._buildChoiceGroup(question.rowList)}this.$el.find("[rule-choices]").append(choices)},_buildChoiceGroupNps:function(){var self=this,npsOptions=SM.ComparedByNps.distributed;return _.map(npsOptions,function(option){return SM.Views.create(SM.QNA_NpsRuleChoiceView,{model:self.ruleModel.choiceSet,text:option.text,id:option.id,position:option.position}).el})},_onRuleDirtySet:function(e){var self=e.data.self,applyEnabled=SM.Object.getOneKey(self.ruleModel.choiceSet.get("rows"))!==undefined;applyEnabled=applyEnabled||self.ruleModel.choiceSet.get("commentFieldSelected");self.set("applyEnabled",applyEnabled)}});SM.SourceSurveysRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"SourceSurveysRuleView",__beforeRender:function(){return{heading:Globalize.localize("survey"),is_source_surveys_rule:true}},_renderChoices:function(){var options;options=$.map(this.ruleModel.survey.getSourceSurveys().answers,function(source_survey_option){return{text:source_survey_option.text,id:source_survey_option.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options))}});SM.QNAMatrixRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNAMatrixRuleView",__init:function(){SM.QNARuleEditView.__init.call(this);this.$el.on(SM.Event.CLICK,"[add-new-row-btn]",{self:this},this._onAddNewMatrixSelection)},_renderChoices:function(){var choiceSetList=this.ruleModel.choiceSetList,self=this,addNewRowBtn,emptyChoiceSetList=choiceSetList.length===0;if(emptyChoiceSetList){this.ruleModel.addChoiceSet()}_.each(choiceSetList,function(choiceSetModel){if(choiceSetModel.cols){self._appendMatrixSelectionView(choiceSetModel)}});addNewRowBtn=SM.Template.renderHTML("add-matrix-selection-template");if(this.ruleModel.isNew||this.ruleModel.isCompare||emptyChoiceSetList){$(addNewRowBtn).hide()}self.$el.append(addNewRowBtn)},_afterRenderChoices:function(){var question=this.ruleModel.getQuestion(),commentFieldChoiceView;if(!this.ruleModel.isCompare){if(question.commentField&&!question.commentField.options.apply_all_rows){commentFieldChoiceView=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.commentChoiceSet});this.$el.append(commentFieldChoiceView.el)}}},_appendMatrixSelectionView:function(choiceSetModel){var choicesContainer=this.$el.find("[rule-choices]").get(0),choiceView=SM.Views.create(SM.QNA_MatrixRuleChoiceSetView,{model:choiceSetModel});choicesContainer.appendChild(choiceView.el)},_hasAllSectionsComplete:function(choiceSetName){var allComplete=true,choiceSetList=this.ruleModel.choiceSetList;_.each(choiceSetList,function(choiceSet){if(SM.Object.getOneKey(choiceSet[choiceSetName])===undefined){allComplete=false;return false}});return allComplete},_hasOneSectionComplete:function(choiceSetName){var oneSectionComplete=false,choiceSetList=this.ruleModel.choiceSetList;_.each(choiceSetList,function(choiceSet){if(choiceSetName!=="comment"){if(SM.Object.getOneKey(choiceSet[choiceSetName])!==undefined){oneSectionComplete=true}}else{oneSectionComplete=choiceSet.commentFieldSelected}if(oneSectionComplete){return false}});return oneSectionComplete},_onRuleDirtySet:function(e){var self=e.data.self,question=self.ruleModel.getQuestion(),rowsComplete=self._hasAllSectionsComplete("rows"),colsComplete=self._hasOneSectionComplete("cols"),commentFieldComplete,$addRowBtn=self.$el.find("[add-new-row-btn]"),$sidi;if(question.commentField&&question.commentField.options.apply_all_rows){commentFieldComplete=self._hasOneSectionComplete("comment")}else{commentFieldComplete=self.ruleModel.commentChoiceSet.get("commentFieldSelected")}if(rowsComplete&&!self.ruleModel.isCompare&&!question.isEmoji()){$addRowBtn.show()}else{$addRowBtn.hide()}$sidi=self.$el.find(".sidi-rule-edit");if(self.ruleModel.isCompare&&$sidi.length){if(rowsComplete){$sidi.removeClass("hide")}else{$sidi.addClass("hide")}}if(colsComplete||commentFieldComplete){self.buttons.applyEnable()}else{self.buttons.applyDisable()}},_onAddNewMatrixSelection:function(e){var self=e.data.self,choiceSetModel=self.ruleModel.addChoiceSet();e.preventDefault();self.$el.find("[add-new-row-btn]").hide();self._appendMatrixSelectionView(choiceSetModel)}});SM.QNAMenuMatrixRuleEditView=SM.Views.extend(SM.QNAMatrixRuleEditView,{__NAME:"QNAMenuMatrixRuleView",_appendMatrixSelectionView:function(choiceSetModel){var choicesContainer=this.$el.find("[rule-choices]").get(0),choiceView=SM.Views.create(SM.QNA_MenuMatrixRuleChoiceSetView,{model:choiceSetModel});choicesContainer.appendChild(choiceView.el)},_onRuleDirtySet:function(e){var self=e.data.self,rowsComplete=self._hasAllSectionsComplete("rows"),colsComplete=self._hasAllSectionsComplete("cols"),commentFieldSelected=self.ruleModel.commentChoiceSet.get("commentFieldSelected"),colChoicesComplete=self._hasOneSectionComplete("colChoices"),$addRowBtn=self.$el.find("[add-new-row-btn]");if(rowsComplete&&colsComplete&&!self.ruleModel.isCompare){$addRowBtn.show()}else{$addRowBtn.hide()}if(colChoicesComplete||commentFieldSelected){self.buttons.applyEnable()}else{self.buttons.applyDisable()}}});SM.QNA_OEndedRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_OEndedRuleView",_onRuleDirtySet:function(e){var self=e.data.self;self._validateApplyBtn()},_validateApplyBtn:function(){var invalids=this.ruleModel.lastValidation.invalids,applyEnabled=!invalids.searchTerm&&!invalids.selectedRowID;this.set("applyEnabled",applyEnabled)},_renderChoices:function(){var choiceView=SM.QNA_SingleOpenEndedRuleChoiceView;if(this.ruleModel.getQuestion().isMultiResponse()){choiceView=SM.QNA_MultiOpenEndedRuleChoiceView}this.openEndedChoice=SM.Views.create(choiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.openEndedChoice.el);this._validateApplyBtn()}});SM.QNA_DatetimeRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_DatetimeRuleEditView",_renderChoices:function(){this.dateChoice=SM.Views.create(SM.QNA_DateTimeRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.dateChoice.el)},_onRuleDirtySet:function(e){var self=e.data.self,invalids=self.ruleModel.lastValidation.invalids;if(invalids.selectedRowID||invalids.selectedTime||invalids.selectedDate){self.buttons.applyDisable()}else{self.buttons.applyEnable()}}});SM.QNA_NumericalRuleView=SM.Views.extend(SM.QNA_OEndedRuleEditView,{__NAME:"QNA_NumericalRuleView",_renderChoices:function(){this.numericalChoice=SM.Views.create(SM.QNA_NumericalRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.numericalChoice.el)}});SM.RespDataRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RespDataRuleView",__create:function(){this.survey=this.ruleModel.survey},__beforeRender:function(){return{heading:Globalize.localize("respondent metadata")}},_renderChoices:function(){var $choices=this.$el.find("[rule-choices]"),textAttrs;this.timeChoice=SM.Views.create(SM.TimeTotalRuleChoiceView,{model:this.ruleModel});$choices.append(this.timeChoice.el);textAttrs=this._renderTxtAttrs();$choices.append(textAttrs)},_renderTxtAttrs:function(){var ruleModel=this.ruleModel;return $.map(ruleModel.respondentAttributes,function(textInput){return SM.Views.create(SM.TextRuleChoiceView,{textLabel:Globalize.localize(textInput.textLabel),model:ruleModel,id:textInput.id,popout_id:textInput.popout_id}).el})},_onRuleDirtySet:function(e){var self=e.data.self,ruleModel=self.ruleModel,ruleIsPopulated=false,timeTotalChoice=ruleModel.get("timeTotal"),input;if(timeTotalChoice.value!==""){ruleIsPopulated=true}if(!ruleIsPopulated){$.each(ruleModel.respondentAttributes,function(i,attribute){input=ruleModel.get(attribute.id);if(input!==""&&input!==undefined){ruleIsPopulated=true;return false}})}if(ruleIsPopulated){self.buttons.applyEnable()}else{self.buttons.applyDisable()}}});SM.ShowRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"ShowRuleView",__templateID:"show-rule-edit-view",__defaults:{selectAllChecked:false,applyEnabled:false},__init:function(){var self=this;this.$el.on("submit",{self:this},this._onFormSubmit);this.$el.on("RuleButtons.applyClicked",{self:this},this._applyClk);this.expandStates={};this.bindModel(this.ruleModel,"isDirty.set",{self:this},function(){self.render()});this.$el.on(SM.Event.CLICK,".rule-select-all",{self:this},this._onSelectAllClicked).on("pageExpandToggled",function(e,expandState){self.expandStates[expandState.ID]=expandState.val}).on("RuleButtons.cancelClicked",function(){self.ruleModel.showSet=SM.Models.create("ShowSet");self.ruleModel.showSet.loadView(self.ruleModel.survey.anviews.currentView)})},__beforeRender:function(){return{hasSelectAll:true,applyEnabled:this.__settings.applyEnabled,selectAllChecked:this.ruleModel.showSet.allSelected(),showRuleModel:this.ruleModel}},_renderChoices:function(){var self=this,pageList=this.ruleModel.survey.pageList,showSet=this.ruleModel.showSet,$choices=this.$el.find("[rule-choices]"),expandStates=this.expandStates||{},views;views=$.map(pageList,function(page,i){return SM.Views.create(SM.ShowPageRuleChoiceView,{model:self.ruleModel,pageID:page.ID,isFirstChoice:i===0,isLastChoice:i===pageList.length-1,expanded:expandStates[page.ID]||false}).el});$choices.append(views);if(showSet.isEmpty()){this.buttons.applyDisable()}else{this.$el.find(".rule-select-all").prop("indeterminate",showSet.questionCheckedCount()<this.ruleModel.survey.questionCount);this.buttons.applyEnable()}},_onSelectAllClicked:function(e){var self=e.data.self,isChecked=self.ruleModel.showSet.toggleAll();self.__settings.selectAllChecked=isChecked;self.__settings.applyEnabled=isChecked;self.ruleModel.set("isDirty",true,{notify:true})}});SM.TimePeriodRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"TimePeriodRuleView",__init:function(){SM.BaseRuleEditView.__init.call(this);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet)},__beforeRender:function(){return{heading:Globalize.localize("time period")}},_renderChoices:function(){var timeRangeChoice=SM.Views.create(SM.TimeRangeRuleChoiceView,{model:this.ruleModel});this.$el.find("[rule-choices]").append(timeRangeChoice.el)},_onRuleDirtySet:function(e){var self=e.data.self;if(self.ruleModel.get("startDate")&&self.ruleModel.get("endDate")){self.buttons.applyEnable()}else{self.buttons.applyDisable()}}});SM.CompletenessRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CompletenessRuleView",__beforeRender:function(){return{heading:Globalize.localize("completeness")}},_options:[{text:"Complete responses",id:"completely"},{text:"Partial responses",id:"partially"},{text:"Disqualified responses",id:"disqualified"},{text:"Responses over quota",id:"overquota"}],_renderChoices:function(){var options=$.map(this._options,function(option){return{text:Globalize.localize(option.text),id:option.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options))}});SM.CollectorRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CollectorRuleView",__beforeRender:function(){return{heading:Globalize.localize("collector")}},_renderChoices:function(){var options;options=$.map(this.ruleModel.survey.collectorList,function(collector){var showCollectorType=Globalize.culture().name!=="en"&&!!collector.type;return{showCollectorType:showCollectorType,text:collector.title,type:collector.formattedType,id:collector.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options))}});SM.RARuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RARuleEditView",_renderChoices:function(){var options;options=$.map(this.ruleModel.getRandomAssignmentList(),function(randomAssignment){return{text:randomAssignment.variable_name||randomAssignment.heading,id:randomAssignment.variable_id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(options))},__beforeRender:function(){var question=this.ruleModel.getQuestion();return{position:question.position,heading:question.heading}}});SM.SimpleRuleChoiceView=SM.Views.register({__NAME:"SimpleRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__init:function(){this.$el.on(SM.Event.CLICK,"[rule-choice-checkbox]",{self:this},this._checkboxChanged)},__beforeRender:function(){var id=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,showCollectorType:this.__settings.showCollectorType,type:this.__settings.type,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.ruleModel.rows[id]}},_toggleRow:function(rows,id){if(rows[id]){delete rows[id]}else{rows[id]=true}this.render();this.$el.find("input:first").focus()},_checkboxChanged:function(e){var self=e.data.self,id=self.__settings.id,rows=self.ruleModel.get("rows");self._toggleRow(rows,id);self.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_SimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_SimpleRuleChoiceView",__model:"choiceSet",__beforeRender:function(){var id=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,isIndented:this.__settings.isIndented,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.choiceSet.rows[id]}},_checkboxChanged:function(e){var self=e.data.self,id=self.__settings.id,rows=self.choiceSet.get("rows");self._toggleRow(rows,id);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_NpsSimpleRuleChoiceView=SM.Views.extend(SM.QNA_SimpleRuleChoiceView,{__NAME:"QNA_NpsSimpleRuleChoiceView",__model:"choiceSet",__init:function(){var self=this;self.$el.on(SM.Event.CHANGE,"input[rule-choice-checkbox]",function(){self._toggleRow(self.choiceSet.rows,self.__settings.id);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})})},_toggleRow:function(rows,id){var self=this,question=self.choiceSet.ruleModel.getQuestion();
if(rows[id]){delete rows[id]}else{rows[id]=true}self.choiceSet.ruleModel.is_nps_distributed=SM.ComparedByNps.isDistributed(rows,question);this.render();this.$el.find("input:first").focus()}});SM.QNA_NpsRuleChoiceView=SM.Views.register({__NAME:"QNA_NpsRuleChoiceView",__model:"choiceSet",__templateID:"rule-choice-nps",__defaults:{expanded:false},__init:function(){var self=this;this.bindModel(this.choiceSet.ruleModel,"isDirty.set",{self:this},function(){self.render()});this.$el.on(SM.Event.CLICK,".choice-expander",function(){self.__settings.expanded=!self.__settings.expanded;self.render()}).on(SM.Event.CLICK,"input[rule-choice-checkbox][page-checkbox]",function(){var checked=$(this).prop("checked");self._toggleRows(checked);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})})},_toggleRows:function(checked){var self=this,choiceRows=self.choiceSet.get("rows"),rowList=self._getDetailedRows(),ids=_.pluck(rowList,"id"),hasSomeRowsChecked=self._hasSomeRowsChecked(ids,choiceRows);_.each(ids,function(id){if(checked||hasSomeRowsChecked){choiceRows[id]=true}else{if(choiceRows[id]){delete choiceRows[id]}}});self.choiceSet.ruleModel.is_nps_distributed=SM.ComparedByNps.isDistributed(choiceRows,self.choiceSet.ruleModel.getQuestion());self.render()},_hasSomeRowsChecked:function(ids,choiceRows){var numChoicesApplied=0;_.each(ids,function(id){if(!_.isUndefined(choiceRows[id])){numChoicesApplied++}});return numChoicesApplied<ids.length},_hasAllRowsChecked:function(ids,choiceRows){var numChoicesApplied=0;_.each(ids,function(id){if(!_.isUndefined(choiceRows[id])){numChoicesApplied++}});return numChoicesApplied===ids.length},_isCheckedDistributionOption:function(choiceRows){var self=this,position=self.__settings.position,options=SM.ComparedByNps.getDistributedOptions(choiceRows,self.choiceSet.ruleModel.getQuestion()),positions=_.pluck(options,"position");return _.contains(positions,position)},_getDetailedRows:function(){var self=this,position=self.__settings.position;return SM.ComparedByNps.getDetailedRows(position,self.choiceSet.ruleModel.getQuestion())},__beforeRender:function(){var self=this,choiceRows=self.choiceSet.get("rows"),isChecked;isChecked=self._isCheckedDistributionOption(choiceRows);return{text:Globalize.localize(this.__settings.text),id:this.__settings.id,expanded:this.__settings.expanded,isChecked:isChecked,choiceViewID:this.__NAME+"_"+this.__uid}},__afterRender:function(){var self=this,rowList=self._getDetailedRows(),numRows=rowList.length,numRowsSelected=0,$detailedChoices=this.$el.find(".question-choices"),choices;_.each(rowList,function(row){if(self.choiceSet.rows[row.id]){numRowsSelected++}});if(this.__settings.expanded){choices=$.map(rowList,function(row){return SM.Views.create(SM.QNA_NpsSimpleRuleChoiceView,{id:row.id,text:row.text,isIndented:true,model:self.choiceSet}).el});$detailedChoices.append(choices)}else{$detailedChoices.html("")}if(numRowsSelected>0&&numRowsSelected<numRows){this.$el.find("input[rule-choice-checkbox][page-checkbox]").prop("indeterminate",true)}}});SM.QNA_SingleOpenEndedRuleChoiceView=SM.Views.register({__NAME:"QNA_SingleOpenEndedRuleChoiceView",__templateID:"rule-choice-qna-text",__model:"choiceSet",__create:function(){this.question=this.choiceSet.ruleModel.getQuestion()},__init:function(){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered);this.$el.on(SM.Event.CHANGE,".search-type",{self:this},this._onSearchTypeChanged)},__beforeRender:function(){var md,searchType,validation,choiceSetInvalids;searchType=this.choiceSet.get("searchType");validation=this.choiceSet.ruleModel.lastValidation;choiceSetInvalids=validation.invalids.choiceSet?validation.invalids.choiceSet.invalids:undefined;if(!choiceSetInvalids){choiceSetInvalids=validation.invalids.commentChoiceSet?validation.invalids.commentChoiceSet.invalids:undefined}md={searchType:{},searchTerm:this.choiceSet.get("searchTerm"),rowSelected:true,invalidInput:choiceSetInvalids};md.searchType[searchType]="selected";return md},_onTextEntered:function(e){var self=e.data.self,text=$(e.currentTarget).val();self.choiceSet.set("searchTerm",text);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})},_onSearchTypeChanged:function(e){var searchType=$(this).val(),self=e.data.self;self.choiceSet.set("searchType",searchType);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_MultiOpenEndedRuleChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_MultiOpenEndedRuleChoiceView",_operationToTemplateMap:{">":"opGreaterThan","<":"opLessThan","=":"opEquals"},__init:function(){SM.QNA_SingleOpenEndedRuleChoiceView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged)},__beforeRender:function(){var rowID=this.choiceSet.get("selectedRowID"),validation=this.choiceSet.ruleModel.lastValidation,choiceSetInvalids=validation.invalids.choiceSet?validation.invalids.choiceSet.invalids:undefined,md={searchType:{},isMulti:true,rowSelected:this.choiceSet.get("selectedRowID")!=="-1",rows:$.extend(true,[],this.question.structure.answers.rows),invalidInput:choiceSetInvalids,searchTerm:this.choiceSet.get("searchTerm")},searchType=this.choiceSet.get("searchType")||"all";md.searchType[searchType]="selected";if(rowID!=="-1"){$.each(md.rows,function(i,answerRow){if(rowID===answerRow.id){answerRow.selected=true;return false}})}return md},_onAnswerRowChanged:function(e){var self=e.data.self,rowID=$(this).val();self.choiceSet.set("selectedRowID",rowID);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render()}});SM.QNA_DateTimeRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_DateTimeRuleChoiceView",__templateID:"datetime-qna-choice",_formats:{date_intl:"d/M/yyyy",date_us:"M/d/yyyy"},_onAnswerRowChanged:function(e){var self=e.data.self,rowID=$(this).val();self.choiceSet.set("selectedRowID",rowID);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render()},__init:function(){this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged);this.$el.on("datepicker.dateSelected",".datepicker",{self:this},this._onDateSelected).on("timepicker.change",".timepicker",{self:this},this._onTimeSelected).on("change","[op-select]",{self:this},this._onOperatorChanged)},__beforeRender:function(){var questionModel=this.question,md=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),opSelection=this._operationToTemplateMap[this.choiceSet.get("op")];md.hasDatePicker=questionModel.subtype==="date_only"||questionModel.subtype==="both";md.hasTimePicker=questionModel.subtype==="time_only"||questionModel.subtype==="both";md.isMilitaryTime=Globalize.usesMilitaryTime();md[opSelection]=true;return md},__afterRender:function(){var time=this.choiceSet.get("selectedTime"),validation=this.question.structure.validation,dateMoment=this.choiceSet.get("selectedDate"),date=new Date(dateMoment.year(),dateMoment.month(),dateMoment.date(),dateMoment.hour(),dateMoment.minute()),dateFormat;if(!time||(time.hours===-1||time.minutes===-1)){time=undefined}else{time=new Date(0,0,0,time.hours,time.minutes)}if(validation&&validation.type){dateFormat=this._formats[validation.type]||"d"}else{dateFormat="d"}if(this.question.subtype==="date_only"||this.question.subtype==="both"){this.$el.find(".datepicker").datepicker({selectedDate:date,selectMenus:true,dateFormat:dateFormat,minDate:new Date(1900,0,1),maxDate:new Date(2050,11,31)})}if(this.question.subtype==="time_only"||this.question.subtype==="both"){this.$el.find(".timepicker").timepicker({time:time,minuteIncrement:1,militaryTime:Globalize.usesMilitaryTime()})}},_onOperatorChanged:function(e){e.data.self.choiceSet.set("op",$(this).val())},_onTimeSelected:function(e){var self=e.data.self,time=self.$el.find(".timepicker").data("timepicker").get("time");self.choiceSet.set("selectedTime",time);self.choiceSet.ruleModel.set("isDirty",true,{notify:true})},_onDateSelected:function(e){var self=e.data.self,selectedDate=self.$el.find(".datepicker").data("datepicker").get("selectedDate");self.choiceSet.set("selectedDate",moment.utc(selectedDate));self.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_NumericalRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_NumericalRuleChoiceView",__templateID:"qna-rule-numeric-choice",__init:function(){this.$el.on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged).on(SM.Event.CHANGE,"[op-select]",{self:this},this._onOperatorChanged)},__beforeRender:function(){var md=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),opSelection=this._operationToTemplateMap[this.choiceSet.get("op")];md[opSelection]=true;if(this.question.rowList.length===1){md.isMulti=false;md.rows[0].selected=true;md.rowSelected=true;this.choiceSet.set("selectedRowID",this.question.rowList[0].id)}return md},_onOperatorChanged:function(e){var self=e.data.self,operator=$(this).val();self.choiceSet.set("op",operator);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render()}});SM.QNA_CommentFieldChoiceView=SM.Views.register({__NAME:"QNA_CommentFieldChoiceView",__model:"choiceSet",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"input[type='checkbox']",{self:this},this._checkboxChanged)},_checkboxChanged:function(e){var self=e.data.self,includeComment=self.choiceSet.get("commentFieldSelected");includeComment=!includeComment;self.choiceSet.set("commentFieldSelected",includeComment);self.choiceSet.ruleModel.set("isDirty",true,{notify:true});self.render();if(includeComment){self.$el.find("input[match-input]").focus()}},__afterRender:function(){var includeComment=this.choiceSet.get("commentFieldSelected"),choiceViewElem,questionModel=this.choiceSet.ruleModel.getQuestion();if(includeComment&&!this.choiceSet.ruleModel.isCompare){choiceViewElem=SM.Views.create(SM.QNA_ExpandedCommentFieldChoiceView,{model:this.choiceSet}).el}else{choiceViewElem=SM.Template.renderHTML("rule-choice-simple",{isChecked:this.choiceSet.get("commentFieldSelected"),text:questionModel.commentField.text,choiceViewID:this.__NAME+"_"+this.__uid})}this.$el.append(choiceViewElem)}});SM.QNA_ExpandedCommentFieldChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_ExpandedCommentFieldChoiceView",__beforeRender:function(options){var md=SM.QNA_SingleOpenEndedRuleChoiceView.__beforeRender.call(this,options),questionModel=this.choiceSet.ruleModel.getQuestion();md.isCommentField=true;md.commentFieldHeading=questionModel.commentField.text;return md}});SM.QNA_MatrixSimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_MatrixSimpleRuleChoiceView",__model:"choiceSetModel",__beforeRender:function(){var id=this.__settings.id,choiceSetName=this.__settings.choiceSetName;return{text:this.__settings.text,isVisible:this.__settings.visible,id:id,isChecked:this.choiceSetModel.get(choiceSetName)[id],choiceViewID:this.__NAME+"_"+this.__uid}},_checkboxChanged:function(e){var self=e.data.self,choiceSetName=self.__settings.choiceSetName,id=self.__settings.id,answerSet=self.choiceSetModel[choiceSetName];if(answerSet[id]){delete answerSet[id]}else{answerSet[id]=true}self.render();self.$el.find("input").focus();self.choiceSetModel.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_MatrixSelectRuleChoiceView=SM.Views.register({__model:"choiceSetModel",__NAME:"matrixSelectRuleChoiceView",__templateID:"rule-choice-matrix-select",__defaults:{prompt:"Choose a row..."},__create:function(){this.__settings.prompt=Globalize.localize(this.__settings.prompt)},__beforeRender:function(){var questionModel=this.choiceSetModel.ruleModel.getQuestion(),choiceSetName=this.__settings.choiceSetName,answerList=$.extend(true,[],questionModel.structure.answers[choiceSetName]),checkedID=SM.Object.getOnlyKey(this.choiceSetModel[choiceSetName]);if(checkedID){_.each(answerList,function(answer){if(answer.id===checkedID){answer.selected="selected";return false}})}return{choiceSetName:choiceSetName,answerList:answerList,placeholderPrompt:this.__settings.prompt,isDisabled:this.__settings.isDisabled}}});SM.QNA_MatrixRuleChoiceSetView=SM.Views.register({__NAME:"QNA_MatrixRuleChoiceSetView",__model:"choiceSetModel",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"[answer-set='rows']",{self:this},this._onRowChanged)},__afterRender:function(){var rows=this.choiceSetModel.rows,rowIsSelected=SM.Object.getOnlyKey(rows)!==undefined,questionModel=this.choiceSetModel.ruleModel.getQuestion(),choiceList=questionModel.structure.answers.cols,rowId;if(questionModel.isEmoji()&&!(questionModel.rowList.length>1)){rowId=questionModel.rowList[0].id;this.choiceSetModel.rows[rowId]=true;rowIsSelected=true;this.choiceSetModel.ruleModel.set("editMode",true)}else{this._addSelectList("rows",false)}if(rowIsSelected){this._buildChoiceList(choiceList,"cols")}},_onRowChanged:function(e){var self=e.data.self,value=$(this).val(),choiceSet=self.choiceSetModel;choiceSet.rows={};choiceSet.cols={};if(value!=="-1"){choiceSet.rows[value]=true}self.render();self.$el.find("input[type='checkbox']:first").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true})},_addSelectList:function(choiceSetName,isDisabled){var selectView=SM.Views.create(SM.QNA_MatrixSelectRuleChoiceView,{model:this.choiceSetModel,choiceSetName:choiceSetName,isDisabled:isDisabled});this.$el.append(selectView.el)},_buildChoiceList:function(choiceList,choiceSetName){var self=this,choices=_.map(choiceList,function(answer){return SM.Views.create(SM.QNA_MatrixSimpleRuleChoiceView,{model:self.choiceSetModel,text:answer.text,id:answer.id,choiceSetName:choiceSetName}).el});this.$el.append(choices)}});SM.QNA_MenuMatrixRuleChoiceSetView=SM.Views.extend(SM.QNA_MatrixRuleChoiceSetView,{__NAME:"QNA_MenuMatrixRuleChoiceView",__templateID:"rule-qna-choice-wrapper",__init:function(){SM.QNA_MatrixRuleChoiceSetView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[answer-set='cols']",{self:this},this._onColChanged)},__afterRender:function(){var choiceSetModel=this.choiceSetModel,rows=choiceSetModel.rows,cols=choiceSetModel.cols,rowIsSelected=SM.Object.getOnlyKey(rows)!==undefined,colIsSelected=SM.Object.getOnlyKey(cols)!==undefined,questionModel=choiceSetModel.ruleModel.getQuestion(),answerList,colId,colObj;if(_.isEmpty(cols)){answerList=questionModel.structure.answers.cols[0].items}else{_.each(cols,function(value,col){colId=col});colObj=_.find(questionModel.structure.answers.cols,function(col){return col.id===colId});answerList=colObj.items}this._addSelectList("rows");this._addSelectList("cols",!rowIsSelected);if(rowIsSelected&&colIsSelected){this._buildChoiceList(answerList,"colChoices")}},_onColChanged:function(e){var self=e.data.self,choiceSet=self.choiceSetModel,value=$(this).val();choiceSet.cols={};choiceSet.colChoices={};if(value!=="-1"){choiceSet.cols[value]=true}self.render();self.$el.find("input[type='checkbox']:first").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true})},_onRowChanged:function(e){var self=e.data.self,value=$(this).val(),choiceSet=self.choiceSetModel;choiceSet.rows={};choiceSet.cols={};choiceSet.colChoices={};if(value!=="-1"){choiceSet.rows[value]=true}self.render();self.$el.find("select[answer-set='cols']").focus();choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.TimeTotalRuleChoiceView=SM.Views.register({__NAME:"TimeTotalRuleChoiceView",__templateID:"rule-choice-time-total",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CHANGE,".time-unit",{self:this,setter:"unit"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.KEYUP,".time-value",{self:this,setter:"value"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.CHANGE,".op-select",{self:this,setter:"op"},this._onTotalTimeAttributeChanged)},__beforeRender:function(){var timeData=this.ruleModel.get("timeTotal"),validation=this.ruleModel.lastValidation,isValid=!validation.invalids.timeTotal,md={selected:{},timetext:timeData.value,isValid:isValid};md.selected[timeData.unit]=true;if(timeData.op===">"){md.selected.greaterthan=true}else if(timeData.op==="<"){md.selected.lessthan=true}return md},_onTotalTimeAttributeChanged:function(e){var self=e.data.self,timeTotalObject=self.ruleModel.get("timeTotal");timeTotalObject[e.data.setter]=$(this).val();self.ruleModel.set("isDirty",true,{notify:true})}});SM.TextRuleChoiceView=SM.Views.register({__NAME:"TextRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-text",__init:function(){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.BLUR,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered)},__beforeRender:function(){var md=this.__settings,id=this.__settings.id,validation=this.ruleModel.lastValidation;this.popout_id=this.__settings.popout_id;md.isVisible=this.ruleModel.attributeIsVisible(id);md.textEntered=this.ruleModel.get(id);md.isValid=true;if(validation.invalids[id]){md.validationErrorMsg=validation.invalids[id].message;md.isValid=false}return md},_onTextEntered:function(e){var self=e.data.self,textEntered=$(e.currentTarget).val(),id=self.__settings.id;self.ruleModel.set(id,textEntered);self.ruleModel.set("isDirty",true,{notify:true})},__afterRender:function(){this.$textBox=this.$el.find(".fv-textbox");this.$textLabel=this.$el.find(".fv-textlabel");this.$errorMsg=this.$el.find(".fv-error");if(!!this.popout_id){this.$el.append(SM.Views.create(SM.RuleBuilderPopouts,{templateID:this.popout_id}).el)}}});SM.ShowPageRuleChoiceView=SM.Views.register({__NAME:"ShowRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-show",__defaults:{expanded:false,isFirstChoice:false,isLastChoice:false},__init:function(){var self=this,pageModel=this.ruleModel.survey.getPage(this.__settings.pageID);this.$el.on(SM.Event.CLICK,".choice-expander",function(){self.__settings.expanded=!self.__settings.expanded;self.$el.trigger("pageExpandToggled",{ID:pageModel.ID,val:self.__settings.expanded});self.render()}).on(SM.Event.CHANGE,"input[rule-choice-checkbox][page-checkbox]",function(){self.ruleModel.showSet.togglePage(pageModel);self.ruleModel.set("isDirty",true,{notify:true})})},__beforeRender:function(){var pageModel=this.ruleModel.survey.getPage(this.__settings.pageID),heading=""+pageModel.position,showSet=this.ruleModel.showSet;if(pageModel.heading.length>0){heading+=": "+pageModel.heading}return{text:heading,id:pageModel.ID,isExpandable:true,isFirstChoice:this.__settings.isFirstChoice,isLastChoice:this.__settings.isLastChoice,hasQuestions:pageModel.questionList.length>0,expanded:this.__settings.expanded,isChecked:showSet.hasPage(pageModel),choiceViewID:this.__NAME+"_"+this.__uid}},__afterRender:function(){var pageModel=this.ruleModel.survey.getPage(this.__settings.pageID),self=this,questionList=pageModel.questionList,shownQuestions=this.ruleModel.showSet.pageQuestionsCheckedCount(pageModel),$questionChoices=this.$el.find(".question-choices"),choices;if(this.__settings.expanded){choices=$.map(questionList,function(questionModel,i){return SM.Views.create(SM.ShowQuestionRuleChoiceView,{questionID:questionModel.ID,model:self.ruleModel,isFirstChoice:i===0,isLastChoice:i===questionList.length-1}).el});$questionChoices.append(choices)}else{$questionChoices.html("")}if(shownQuestions>0){if(shownQuestions<questionList.length){this.$el.find("input[rule-choice-checkbox][page-checkbox]").prop("indeterminate",true)}}if(self.ruleModel.survey.isReadOnly()){self.$el.find('input[type="checkbox"]').prop("disabled",true)}}});SM.ShowQuestionRuleChoiceView=SM.Views.register({__NAME:"ShowQuestionRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__defaults:{isFirstChoice:false,isLastChoice:false},__init:function(){var self=this,questionModel=this.ruleModel.survey.getQuestion(this.__settings.questionID);this.$el.on(SM.Event.CHANGE,"input[rule-choice-checkbox]",function(){self.ruleModel.showSet.toggleQuestion(questionModel);self.ruleModel.set("isDirty",true,{notify:true})})},__beforeRender:function(){var questionModel=this.ruleModel.survey.getQuestion(this.__settings.questionID),heading=Globalize.localize("Question")[0]+questionModel.position;if(questionModel.heading&&questionModel.heading.length>0){heading+=": "+questionModel.heading}return{text:heading,id:questionModel.ID,isIndented:true,isLastChoice:this.__settings.isLastChoice,isFirstChioce:this.__settings.isFirstChoice,isHighlighted:this.__settings.isHighlighted,isVisible:true,isChecked:this.ruleModel.showSet.hasQuestion(questionModel),choiceViewID:this.__NAME+"_"+this.__uid}}});SM.TimeRangeRuleChoiceView=SM.Views.register({__NAME:"TimeRangeRuleChoiceView",__templateID:"rule-choice-date",__model:"ruleModel",__init:function(){this.$el.on("datepicker.afterClose",{self:this},this._onDateChanged)},__afterRender:function(){var startDate=this.ruleModel.get("startDate"),endDate=this.ruleModel.get("endDate");this.$el.dateRangePicker({startMinDate:new Date(1999,0,1),endMaxDate:new Date(2020,11,31),selectMenus:true});this.daterange=this.$el.data("dateRangePicker");if(startDate){this.daterange.set("startSelectedDate",new Date(startDate));this.daterange.set("endSelectedDate",new Date(endDate))}},_onDateChanged:function(e){var self=e.data.self,dateRangePicker=self.$el.data("dateRangePicker"),start=dateRangePicker.get("startSelectedDate"),end=dateRangePicker.get("endSelectedDate");if(start!==null){self.ruleModel.set("startDate",start.getTime())}if(end!==null){self.ruleModel.set("endDate",end.getTime())}self.ruleModel.set("isDirty",true,{notify:true})}});SM.QNARulePickerView=SM.Views.register({__model:"survey",__NAME:"QNARulePickerView",__templateID:"QNARulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){this.$el.on("autocomplete.selected","[qna-search-text]",{self:this},this._searchResultSelected).on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick);this._autocomplete=this.$el.find("[qna-search-text]").autocomplete({search:function(term){var survey=this.get("survey"),results=survey.searchQuestions(term),question,disabled,isCompare=this.get("isCompare");results=$.map(results,function(questionID){question=survey.questions[questionID];disabled=isCompare&&!question.hasComparableOptions()||question.isPresentation()||isCompare&&question.isNPS();return{value:question.ID,text:"Q"+question.position+": "+question.heading,isDisabled:disabled}});this.set("results",results)},isCompare:this.__settings.builder_type===this._compareBuilderType,minLength:this.survey.SEARCH_NGRAM_SIZE,survey:this.survey,classes:["searchresults-menu","long"]})},__destroy:function(){if(this._autocomplete){if(this._autocomplete.menu){if(this._autocomplete.menu.$el){this._autocomplete.menu.$el.remove()}this._autocomplete.menu=undefined}this._autocomplete=undefined}},__beforeRender:function(){var questions=this.survey.questionList,i=0,len,option,q,isCompare=this.__settings.builder_type===this._compareBuilderType,md={questions:[],isCompare:isCompare};len=questions.length;for(;i<len;i++){q=questions[i];option={text:q.position+": "+q.heading,id:q.ID};md.questions.push(option);if(isCompare&&!q.hasComparableOptions()||q.isPresentation()||isCompare&&q.isNPS()){md.questions[i].isDisabled=true}}return md},reset:function(){this.$el.find("[qna-search-text]").val("");this.$el.find("select").val("-1")},_onCancelClick:function(e){var self=e.data.self;e.preventDefault();self.reset();self.$el.trigger("QNARulePickerView.cancelClicked")},_onSelectChange:function(e){var self=e.data.self;if(parseInt(this.value,10)>0){self.$el.trigger("QNARulePickerView.questionSelected",{questionID:this.value});self.reset()}},_searchResultSelected:function(e){var self=e.data.self;self.$el.trigger("QNARulePickerView.questionSelected",{questionID:e.value});self.reset()}});SM.RandomAssignmentRulePickerView=SM.Views.register({__model:"survey",__NAME:"RandomAssignmentRulePickerView",__templateID:"RandomAssignmentRulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){this.$el.on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick)},__destroy:function(){},_mapTypeToText:function(family,subtype){var mapper={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test",menu:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return mapper[family][subtype]},__parseParams:function(value){return parseInt(value.split("_")[1],10)},__makeParams:function(qID){return"qid_"+qID},__beforeRender:function(){var self=this,questions=self.survey.questionList,isCompare=self.__settings.builder_type===self._compareBuilderType,md={randomAssignments:[],hasRandomAssignment:false,isCompare:isCompare};_.each(questions,function(q){var isDisabled;if(q.randomAssignmentList.length>0){isDisabled=q.family==="datetime"||q.family==="open_ended"||q.family==="demographic";md.hasRandomAssignment=true;md.randomAssignments.push({text:Globalize.localize("Question").substr(0,1)+q.position+": "+Globalize.localize("("+self._mapTypeToText(q.family,q.subtype)+")")+" "+q.heading,questionID:q.ID,params:self.__makeParams(q.ID),isDisabled:isDisabled})}});return md},reset:function(){this.$el.find("select").val("-1")},_onCancelClick:function(e){var self=e.data.self;e.preventDefault();self.reset();self.$el.trigger("RandomAssignmentRulePickerView.cancelClicked")},_onSelectChange:function(e){var self=e.data.self,questionID=self.__parseParams(this.value);if(questionID>0){self.$el.trigger("RandomAssignmentRulePickerView.variationSelected",{questionID:questionID});self.reset()}}});SM.BaseCompareAndFilterBuilderView={__model:"survey",isCompareBuilder:false,BI_BUTTON_NAME:"",ruleTypes:{COLLECTOR:"collector",COMPLETENESS:"completeness",QNA:"qna",RANDOM_ASSIGNMENT:"random_assignment",RESPONDENT_DATA:"respondent_data",TIME_PERIOD:"time_period"},__init:function(){var self=this;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleAdded",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleEdited",{self:this},this.close);this.$el.on("waterpark.shift",{self:this},this._createRuleModel).on("waterpark.afterShift",{self:this},this._onAfterShift).on(SM.Event.CLICK,".back-shifter",{self:this},this._onBackShifterClick).on("RuleButtons.cancelClicked",{self:this},this.close).on("RuleView.applied",{self:this},this.close).on("QNARulePickerView.cancelClicked",{self:this},this.close).on("QNARulePickerView.questionSelected",{self:this,ruleType:this.ruleTypes.QNA},this._createQNAOrRARuleModel).on("RandomAssignmentRulePickerView.variationSelected",{self:this,ruleType:this.ruleTypes.RANDOM_ASSIGNMENT},this._createQNAOrRARuleModel);this.wpark=this.$el.waterpark().data("waterpark");if(self.survey.isReadOnly()){self.$el.off("click","a.shifter").on("click","a.shifter",function(e){e.preventDefault()})}},__beforeRender:function(){return{id:this.__NAME,is_merged_survey:SM.App.isMerveysApp()}},__afterRender:function(){this.questionPicker=SM.Views.create(SM.QNARulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.qna.select").append(this.questionPicker.el);this.raPicker=SM.Views.create(SM.RandomAssignmentRulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.random_assignment.select").append(this.raPicker.el)},_isMultiSlideSelect:function(ruleType){if(ruleType===this.ruleTypes.QNA||ruleType===this.ruleTypes.RANDOM_ASSIGNMENT){return true}return false},_createQNAOrRARuleModel:function(e,data){var self=e.data.self,ruleType=e.data.ruleType,isCompareBuilder=self.isCompareBuilder;self._createAndAddRule(ruleType,isCompareBuilder,data.questionID);SM.Bi.uiTrigger=self.BI_BUTTON_NAME;self.wpark.set("location",{slide:2,lane:ruleType})},_createRuleModel:function(e){var self=e.data.self,location=self.wpark.get("location"),ruleType=location.lane;if(location.slide===1&&!self._isMultiSlideSelect(ruleType)){self._createAndAddRule(ruleType,self.isCompareBuilder,null)}},_createAndAddRule:function(ruleType,isCompare,questionID){var ruleModel;if(ruleType==="qna-source-surveys"){ruleType="qna";questionID=this.survey.getSourceSurveysQuestionId()}ruleModel=SM.BaseAnRule.FactoryCreate({ID:null,attrs:{is_compare_rule:isCompare,question_id:questionID,rule_type:ruleType,selected:true}},this.survey);ruleModel.loadSurvey(this.survey);this._appendRule(ruleModel);return ruleModel},_appendRule:function(ruleModel){var ruleType,slideSelector,ruleView,sourceSurveysQuestionID=this.survey.getSourceSurveysQuestionId();ruleType=ruleModel.get("ruleType");if(ruleType==="qna"&&ruleModel.get("questionID")===sourceSurveysQuestionID){ruleType="qna-source-surveys"}slideSelector="section."+ruleType;ruleView=SM.Views.create(SM.AnRuleView,{model:ruleModel,editMode:true});if(ruleModel.isQNA&&ruleType!=="qna-source-surveys"||ruleModel.isRA){slideSelector+=":last"}this.$el.find(slideSelector).append(ruleView.el)},_onBackShifterClick:function(e){var self=e.data.self;self.$el.find(".an-rule").trigger("RuleView.destroy")},_onAfterShift:function(e){var self=e.data.self,waterpark=e.waterpark,location=waterpark.get("location");self.$el.find(".slide").eq(location.slide).find("."+location.lane).eq(0).find("input, select, button, textarea").eq(0).focus()},onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.wpark.set("location",{slide:0})},close:function(e){var self=e.data.self,location=self.wpark.get("location");if(location.slide!==0){self._close()}},_close:function(){this.wpark.set("location",{slide:0})}};SM.FilterBuilderView=SM.Views.extend(SM.BaseCompareAndFilterBuilderView,{__NAME:"FilterBuilderView",__templateID:"filterBuildersTemplate",BI_BUTTON_NAME:"NewFilterRuleButton"});SM.CompareBuilderView=SM.Views.extend(SM.BaseCompareAndFilterBuilderView,{__NAME:"CompareBuilderView",__templateID:"compareBuildersTemplate",BI_BUTTON_NAME:"NewCompareRuleButton",isCompareBuilder:true});SM.ShowBuilderView=SM.Views.register({__NAME:"ShowBuilderView",__templateID:"ShowBuilderTemplate",__model:"survey",BI_BUTTON_NAME:"NewShowRuleButton",onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy")},open:function(){var self=this,ruleModel=SM.Models.create("ShowAnRule",{ID:null,attrs:{selected:false}}),ruleView;SM.Bi.uiTrigger=self.BI_BUTTON_NAME;ruleModel.loadSurvey(this.survey);ruleView=SM.Views.create(SM.AnRuleView,{model:ruleModel,editMode:true});this.el.appendChild(ruleView.el);if(self.survey.isReadOnly()){self.$el.find('input[type="checkbox"]').prop("disabled",true)}else{self.$el.find("input").first().focus()}}});SM.RuleBuilderPopouts=SM.Views.register({__NAME:"RuleBuilderPopouts",__templateID:"rule-popout",__afterRender:function(){this.$el.popout()}});SM.RuleListContainerView=SM.Views.register({__model:"currentView",__NAME:"RulesContainerView",__templateID:"RulesContainerTemplate",__afterRender:function(){this.$ruleListSlide=this.$el.find("[rules_slide]");this.$editSlide=this.$el.find("[edit_slide]");this.ruleListView=SM.Views.create(SM.RuleListView,{model:this.currentView});this.$ruleListSlide.append(this.ruleListView.$el);this.resetSlider();return this},__init:function(){var self=this;this.bindModel(this.currentView.anviews,"selectedViewLoaded",{self:this},this._onRulesChanged);this.slider=this.$el.waterpark().data("waterpark");
this.$el.on("RuleButtons.cancelClicked","[edit_slide]",function(){self.resetSlider()}).on("RuleView.applied","[edit_slide]",function(){self.resetSlider()}).on("AnRuleListItemView.editClicked","[rules_slide]",{self:this},this._onRuleEditClicked).on("waterpark.afterShift",{self:this},this._onAfterShift)},__destroy:function(){delete this.slider},hide:function(){this.$el.hide();return this},_onRulesChanged:function(e){var self=e.data.self;self.render()},FADE_SPEED:250,resetSlider:function(){if(this.slider){this.slider.calculateAttributes();this.slider.set("location",{slide:0})}this.$el.show()},_onRuleEditClicked:function(e){var ruleListItem=e.AnRuleListItemView,ruleModel=ruleListItem.ruleModel,self=e.data.self;ruleModel.set("editMode",true);self.$editSlide.append(SM.Views.create(SM.AnRuleView,{AnRuleListItemView:ruleListItem,model:ruleModel}).$el);self.slider.set("location",{slide:1})},_onAfterShift:function(e){var self=e.data.self,waterpark=e.waterpark,location=waterpark.get("location");self.$el.find(".slide").eq(location.slide).find("input, select, button, textarea").eq(0).focus()}});SM.RuleListView=SM.Views.register({__model:"currentView",__templateID:"RuleListTemplate",__NAME:"RuleListView",__init:function(){this.bindModel(this.currentView,"ruleDeleted",{self:this},this._onRuleDeleted);this.bindModel(this.currentView,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(this.currentView,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad)},__beforeRender:function(){var owner=this.currentView.anviews.survey.owner;return{hasNoRules:this.currentView.ruleList.length===0,hasUpgradeTrigger:owner.isOverRuleLimit()}},__afterRender:function(){var user=this.currentView.anviews.survey.owner,hasRuleLimit=user.hasRuleLimit(),ruleList=this.currentView.ruleList,len=ruleList.length,self=this,owner=this.currentView.anviews.survey.owner,$listContainer=this.$el.find("ul"),$messageContainer=this.$el.find("[rule-list-messages]"),isDisabled,failedLoadRequestID=this.currentView.get("failedLoadRequestID"),ruleView;if(failedLoadRequestID!==null){$messageContainer.html(SM.Template.render("view-switch-failed",{requestID:failedLoadRequestID,classes:"mod-no-header"}));return}if(owner.isOverRuleLimit()){$messageContainer.html(SM.Template.render("rule-limit-upgrade-message-template"))}_.each(ruleList,function(ruleModel,i){if(!hasRuleLimit||i>=len-user.ruleLimit){isDisabled=false}else{isDisabled=true}ruleView=SM.Views.create(SM.AnRuleListItemView,{isDisabled:isDisabled,model:ruleModel});$listContainer.prepend(ruleView.$el);self.$el.find(".q").popout()})},_onCurrentViewFailedToLoad:function(e){e.data.self.render()},_onRuleAdded:function(e){e.data.self.render()},_onRuleDeleted:function(e){var self=e.data.self;if(self.currentView.ruleList.length===0){self.render()}}});SM.RuleBuilderContainerView=SM.Views.register({__templateID:"RuleBuilderContainerTemplate",__defaults:{},__model:"survey",__NAME:"RuleBuilderContainerView",_lastPanel:null,_lastTab:null,__beforeRender:function(){return{showTabTitle:this._getShowTabTitle(),compareTabTitle:this._getCompareTabTitle(),shouldDisableShowTab:this._shouldDisableShowTab(),shouldDisableCompareTab:this._shouldDisableCompareTab()}},_getShowTabTitle:function(){if(this._shouldDisableShowTab()){return Globalize.localize("You can apply only one SHOW rule")}return Globalize.localize("Show only certain questions")},_getCompareTabTitle:function(){if(this._shouldDisableCompareTab()){if(this.survey.state.isBrowseMode()){return Globalize.localize("Compare is not allowed for Individual Responses")}if(this.survey.state.isTrendMode()){return Globalize.localize("Compare is not allowed in Data Trends")}return Globalize.localize("Compare is not allowed")}return Globalize.localize("Crosstabulate your data")},_shouldDisableShowTab:function(){return this.survey.anviews.currentView.hasShowRule()},_shouldDisableCompareTab:function(){return this.survey.state.isTrendMode()},__afterRender:function(){this._cacheElements();this._initWidgets()},_initWidgets:function(){this.$el.find(".q").popout()},__init:function(){var currentView=this.survey.anviews.currentView;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this._disable);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._enable);this.bindModel(currentView,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad);this.bindModel(currentView,"savedToNewView",{self:this},this._disable);this.bindModel(currentView,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(currentView,"ruleDeleted",{self:this},this._onRuleDelete);this.$el.on(SM.Event.CLICK,"a.tab",{self:this},this._onTabClick);this.$el.on(SM.Event.CLICK,"#rule_limit_upgrade_message .learn-more",function(e){e.preventDefault();SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"rules-upgrade-dialog-template"}).open()});this.$el.on({"RuleView.ruleClosed":this._closeTabs,"RuleView.applied":this._closeTabs,"RuleButtons.cancelClicked":this._closeTabs,"QNARulePickerView.cancelClicked":this._closeTabs},{self:this});this.$el.on(SM.Event.CLICK,".waterpark .cancel.btn",{self:this},this._closeTabs)},__destroy:function(){delete this.tabs},_cacheElements:function(){var panels=this.$el.find(".panels").get(0);this.showBuilder=SM.Views.create(SM.ShowBuilderView,{model:this.survey});this.compareBuilder=SM.Views.create(SM.CompareBuilderView,{model:this.survey});this.filterBuilder=SM.Views.create(SM.FilterBuilderView,{model:this.survey});panels.appendChild(this.filterBuilder.el);panels.appendChild(this.compareBuilder.el);panels.appendChild(this.showBuilder.el);this.showTab=this.$el.find("#ShowBuilderTab");this.currRules=SM.Views.create(SM.RuleListContainerView,{model:this.survey.anviews.currentView});this.el.appendChild(this.currRules.el);return this},_onTabClick:function(e){var self=e.data.self,lastPanel=self._lastPanel,$tab=$(this),panel=$tab.attr("target");e.preventDefault();if($tab.hasClass("disabled")){return}if(!!lastPanel){self.closeTabs()}if(lastPanel!==panel){self._lastPanel=panel;self._lastTab=$tab.attr("id");self._beforeTabOpen();$(panel).addClass("open");$tab.data("title",$tab.attr("title"));$tab.addClass("active").removeAttr("title")}},_beforeTabOpen:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.currRules.hide();if(this._lastPanel==="#ShowBuilderView"){this.showBuilder.open()}},_closeTabs:function(e){var self=e.data.self,$lastTab,lastPanel=self._lastPanel;if(lastPanel){$(lastPanel).removeClass("open");$lastTab=$("#"+self._lastTab);$lastTab.removeClass("active");if(!$lastTab.attr("title")){$lastTab.attr("title",$lastTab.data("title"))}self._lastTab=null;self._lastPanel=null;self._afterTabClose(lastPanel)}},closeTabs:function(){this._closeTabs({data:{self:this}})},_afterTabClose:function(lastPanel){if(lastPanel==="#ShowBuilderView"){this.showBuilder.onTabClose()}else if(lastPanel==="#FilterBuilderView"){this.filterBuilder.onTabClose()}else if(lastPanel==="#CompareBuilderView"){this.compareBuilder.onTabClose()}this.currRules.resetSlider()},_disable:function(e){var self=e.data.self;self.closeTabs();self.$el.find(".rules-loading-icon").fadeIn(100);self.$el.find(".rules-ui-blocker").fadeIn(100);self.$el.find(".tab").addClass("disabled")},_enable:function(e){var self=e.data.self;self.$el.find(".rules-loading-icon").hide();self.$el.find(".rules-ui-blocker").hide();self.$el.find(".tab").removeClass("disabled");self._renderShowTab();self._renderCompareTab();self._initWidgets()},_onCurrentViewFailedToLoad:function(e){var self=e.data.self;self.$el.find(".rules-loading-icon").hide();self.$el.find(".rules-ui-blocker").hide()},_renderShowTab:function(){var $tab=$("#ShowBuilderTab");if(this._shouldDisableShowTab()){$tab.addClass("disabled")}else{$tab.removeClass("disabled")}},_renderCompareTab:function(){var $tab=$("#CompareBuilderTab");if(this._shouldDisableCompareTab()){$tab.addClass("disabled")}else{$tab.removeClass("disabled")}},_onRuleAdded:function(e){if(e.ruleModel.isShow){$("#ShowBuilderTab").addClass("disabled").attr("title",Globalize.localize("You can apply only one SHOW rule"))}},_onRuleDelete:function(e){if(e.ruleModel.isShow){$("#ShowBuilderTab").removeClass("disabled").attr("title",Globalize.localize("Create a show rule"))}}});SM.AnalyzeSecondaryView=SM.Views.register({__NAME:"AnalyzeSecondaryView",__model:"survey",__templateID:"analyze-secondary-column",__init:function(){var self=this;this.$el.accordion({multiOpen:true,overflowAuto:false});this.$el.on({"accordion.beforeOpen":function(e){if(e.id==="ExportListContainer"){self.exportsHeadingView.set("isOpen",true);self.exportsHeadingView.render()}if(e.id==="SharedViewsListContainer"){self.sharedViewsHeadingView.set("isOpen",true);self.sharedViewsHeadingView.render()}},"accordion.afterClose":function(e){if(e.id==="ExportListContainer"){self.exportsHeadingView.set("isOpen",false);self.exportsHeadingView.render()}if(e.id==="SharedViewsListContainer"){self.sharedViewsHeadingView.set("isOpen",false);self.sharedViewsHeadingView.render()}}})},__beforeRender:function(){return{isReadOnly:this.survey.isReadOnly(),exportsEnabled:this._shouldShowExportsKey(),sharingEnabled:this._shouldShowSharedViewsKey(),showBenchmarkingKey:this._shouldShowBenchmarkingKey(),benchmarkingEnabled:this._shouldOpenBenchmarkingKey()}},__afterRender:function(){this._renderRulesKey();if(this._shouldShowBenchmarkingKey()){this._renderBenchmarkingKey()}this._renderSavedViewsKey();if(this._shouldShowExportsKey()){this._renderExportsKey()}if(this._shouldShowSharedViewsKey()){this._renderSharedViewsKey()}this.$el.find(".q").popout()},_renderRulesKey:function(){var ruleList;ruleList=SM.Views.create(SM.RuleBuilderContainerView,{model:this.survey});this.$el.find("#RuleBuilderViewContainer").append(ruleList.$el)},_renderBenchmarkingKey:function(){this.dataSegmentContainerView=SM.Views.create(SM.DataSegmentContainerView,{model:this.survey});this.$el.find("#DataSegmentBuilderViewContainer").append(this.dataSegmentContainerView.$el)},_renderSavedViewsKey:function(){var headingView,savedViewList;savedViewList=SM.Views.create(SM.AnViewListView,{model:this.survey.anviews,isOpen:true});headingView=SM.Views.create(SM.SavedViewsHeadingView,{model:this.survey.anviews});this.$el.find("[saved-views-key] .keyOpener").append(headingView.$el);this.$el.find("#view-list-area").append(savedViewList.$el)},_renderExportsKey:function(){var listView;listView=SM.Views.create(SM.ExportJobListView,{model:this.survey.exportJobs});this.exportsHeadingView=SM.Views.create(SM.ExportHeadingView,{model:this.survey.exportJobs,isLoading:this.survey.exportJobs.poller.get("isActive"),hideCount:!this.survey.exportJobs.get("isLoaded")});this.$el.find("[exports-key] .keyOpener").append(this.exportsHeadingView.$el);this.$el.find("#export-job-list-area").append(listView.$el)},_renderSharedViewsKey:function(){var listView;listView=SM.Views.create(SM.SharedViewListView,{survey:this.survey,sharedViews:this.survey.sharedViews});this.sharedViewsHeadingView=SM.Views.create(SM.SharedViewsKeyHeadingView,{sharedViews:this.survey.sharedViews});this.$el.find("[shared-views-key] .keyOpener").append(this.sharedViewsHeadingView.$el);this.$el.find("[shared-view-list]").append(listView.$el)},_shouldShowExportsKey:function(){return this.survey.isExportEnabled()},_shouldShowSharedViewsKey:function(){return SM.App.isSharingEnabled()},_shouldShowBenchmarkingKey:function(){if(this.survey.getCountOfBenchmarkableQuestions()===0){return false}if(!this.survey.isCurrentUserAlsoOwner()){return this.survey.canShowBenchmarking()}return this.survey.owner.hasBenchmarking()&&this.survey.state.isSummaryMode()},_shouldOpenBenchmarkingKey:function(){if(!this.survey.profiler){return false}return true}});SM.ExportNullStateView=SM.Views.register({__NAME:"ExportNullStateView",__model:"survey",__templateID:"export-null-state-template",__afterRender:function(){var $menuElem=this.$el.find("p[export-menu]"),exportMenuView=SM.Views.create(SM.ExportAllBtnView,{model:this.survey,buttonName:"ExportEmptyAccordionButton"});$menuElem.append(exportMenuView.el)}});SM.AnalyzeCTAView=SM.Views.register({__NAME:"AnalyzeCTAView",__model:"survey",__templateID:"analyze-cta",__beforeRender:function(){return{encryptedSurveyID:this.survey.encryptedID}},__afterRender:function(){this.$el.find("[export-btn]").append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true}).el)}});SM.PageNavView=SM.Views.register({__NAME:"pageNavView",__model:"survey",__templateID:"page-nav-container-template",__init:function(){this.survey.on("shownListsChanged",{self:this},this._onShownListChange)},__destroy:function(){this.survey.off("shownListsChanged",this._onShownListChange)},__beforeRender:function(){return{pageCount:this.survey.pageCount}},__afterRender:function(md){var pageArrowBtnsView,pageMenuBtnView;if(md.pageCount>1){pageMenuBtnView=SM.Views.create(SM.PageMenuBtnView,{model:this.survey});pageArrowBtnsView=SM.Views.create(SM.PageArrowBtnsView,{model:this.survey});this.el.appendChild(pageArrowBtnsView.el);this.el.appendChild(pageMenuBtnView.el)}},_onShownListChange:function(e){var self=e.data.self;self.render()}});SM.PageMenuBtnView=SM.Views.register({__NAME:"pageMenuBtnView",__model:"survey",__templateID:"page-menu-btn-template",__init:function(){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.actionMenu({menuView:"PageMenuView",model:this.survey,selectedAction:this.survey.state.get("page").toString(),saveState:true}).on("actionMenu.actionSelected",{self:this},this._onPageSelected).on("actionMenu.beforeOpen",{self:this},this._onBeforeMenuOpen)},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange)},__beforeRender:function(){var pageNumber,pageIndex=this.survey.state.get("page"),hasActiveShowRule=this.survey.anviews.currentView.hasActiveShowRule(),allPagesSelected=this.survey.state.get("allPagesSelected");if(pageIndex!=="all"){pageNumber=pageIndex+1}return{hasShowRule:hasActiveShowRule,allPagesSelected:allPagesSelected,pageNumber:pageNumber}},_onPageSelected:function(e){var self=e.data.self,newPageIndex=e.action;if(newPageIndex!=="all"){newPageIndex=parseInt(newPageIndex,10)}self.survey.state.set("page",newPageIndex,{notify:true})},_onBeforeMenuOpen:function(e){e.actionMenu.get("menuView").render()},_onPageChange:function(e){var self=e.data.self,actionMenu=self.$el.data("actionMenu");actionMenu.set("selectedAction",self.survey.state.get("page"));self.render()}});SM.PageMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"pageMenuView",__model:"survey",__templateID:"page-menu-template",__beforeRender:function(){var pageLen=this.survey.pageCount,hasShowRule=this.survey.anviews.currentView.hasActiveShowRule(),pages=[],pageData,pageModel,i=0;for(;i<pageLen;i++){pageModel=this.survey.pageList[i];pageData={};pageData.title=pageModel.heading;pageData.number=pageModel.position;pageData.index=pageModel.position-1;pageData.isShown=pageModel.isShown();pages.push(pageData)}return{pages:pages,hasShowRule:hasShowRule}}});SM.PageArrowBtnsView=SM.Views.register({__NAME:"pageArrowBtnsView",__model:"survey",__templateID:"page-arrow-btns-template",__init:function(){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.on(SM.Event.CLICK,"[sm-prev-btn]",{self:this},this._onPrevPageClick).on(SM.Event.CLICK,"[sm-next-btn]",{self:this},this._onNextPageClick)},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange)},__beforeRender:function(){var page=this.survey.state.get("page"),lastPage=this.survey.getLastShownPage(),firstPage=this.survey.getFirstShownPage(),onFirstPage=page<=firstPage.position-1,onLastPage=page>=lastPage.position-1,isAllPagesSelected=this.survey.state.get("allPagesSelected");return{prevBtnDisabled:isAllPagesSelected||onFirstPage,nextBtnDisabled:isAllPagesSelected||onLastPage}},_onPageChange:function(e){var self=e.data.self;self.render()},_onNextPageClick:function(e){var self=e.data.self,currPageIndex=self.survey.state.get("page"),isAllPagesSelected=self.survey.state.get("allPagesSelected"),nextPage;e.preventDefault();if(isAllPagesSelected){return}nextPage=self.survey.getNextShownPage(currPageIndex);if(!nextPage){return}self.survey.state.set("page",nextPage.position-1,{notify:true})},_onPrevPageClick:function(e){var self=e.data.self,currPageIndex=self.survey.state.get("page"),isAllPagesSelected=self.survey.state.get("allPagesSelected"),prevPage;e.preventDefault();if(isAllPagesSelected){return}prevPage=self.survey.getPrevShownPage(currPageIndex);if(!prevPage){return}self.survey.state.set("page",prevPage.position-1,{notify:true})}});SM.ContentNavView=SM.Views.register({__NAME:"contentNavView",__model:"survey",__templateID:"content-nav-view-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountUpdate);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._onSelectedViewLoaded);this.bindModel(this.survey,"shownListsChanged",{self:this},this._onShownListChange)},__beforeRender:function(){var pageCount=this.survey.pageCount,isBrowseMode=this.survey.state.isBrowseMode(),hasRespondents=this.survey.respondentCounts.total_context>1,hasRespondent=this.survey.respondentCounts.total_context===1,hasRespondentNav=isBrowseMode&&hasRespondents,hasShownQuestions=this.survey.shownQuestionList.length>0,hasShownPages=this.survey.shownPageList.length>0,hasPageNav=(hasRespondents||hasRespondent)&&pageCount>1&&hasShownQuestions&&hasShownPages;return{hasPageNav:hasPageNav,hasRespondentNav:hasRespondentNav,isHidden:!hasPageNav&&!hasRespondentNav}},__afterRender:function(md){var pageNav,respondentNav;if(!md.isHidden){if(md.hasPageNav){pageNav=SM.Views.create(SM.PageNavView,{model:this.survey});this.el.appendChild(pageNav.el)}if(md.hasRespondentNav){respondentNav=SM.Views.create(SM.RespondentNavView,{model:this.survey});this.el.appendChild(respondentNav.el)}}},_onCountUpdate:function(e){var self=e.data.self;self.render()},_onShownListChange:function(e){var self=e.data.self;self.render()},_onSelectedViewLoaded:function(e){var self=e.data.self;self.render()}});SM.StatsHeaderView=SM.Views.register({__NAME:"statsHeaderView",__templateID:"analyze-stats-header-template",__model:"survey",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountChange)},__beforeRender:function(){var counts=this.survey.respondentCounts,isFiltered=this.survey.isFiltered(),currentView=this.survey.anviews.currentView,compareRule=currentView.hasCompareRule(),filterRule=currentView.hasFilterRule(),hasBoth=compareRule&&filterRule;return{totalContext:Globalize.format(counts.total_context,"n0"),isFiltered:isFiltered,compareRule:compareRule,filterRule:filterRule,hasBoth:hasBoth,failedCount:counts.failed,total:Globalize.format(counts.total,"n0"),encryptedID:this.survey.encryptedID}},__afterRender:function(){var $btnContainer=this.$el.find("[global-share-menu]");if(this._shouldShowShareBtn()){$btnContainer.append(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:true}).el)}if(this._shouldShowExportBtn()){$btnContainer.append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true,buttonName:"ExportStatsHeaderButton"}).el)}},_onCountChange:function(e){var self=e.data.self;self.render()},_shouldShowShareBtn:function(){return SM.App.isSharingEnabled()},_shouldShowExportBtn:function(){return this.survey.isExportEnabled()},_shouldShowMerveysBtn:function(){return this.survey.isMergedSurvey}});SM.QuotasHeaderView=SM.Views.register({__NAME:"quotasHeaderView",__templateID:"analyze-quotas-header-template",__model:"quotas",__init:function(){var self=this;this.$el.accordion();this.$el.on({"accordion.beforeOpen":function(){self.$el.find("#progress-bar-main").hide();self.$el.find(".q").show()},"accordion.afterClose":function(){self.$el.find(".q").hide();self.$el.find("#progress-bar-main").show()}})},__beforeRender:function(options){this.quotaList=SM.Models.create("QuotaList",{quota_data:options});return{totalContext:Globalize.format(this.quotaList.totalContext,"n0"),total:Globalize.format(this.quotaList.total,"n0"),totalPercent:Globalize.formatPercent(this.quotaList.percent,0),numQuotas:Globalize.format(this.quotaList.numQuotas,"n0")}},__afterRender:function(){var self=this,quotaListView;self.$el.find(".accordion").accordion();self.$el.find(".q").popout();self.$el.find(".q").hide();self.$el.find(".progress-bar").css("width",self.quotaList.percent*100+"%");if(self.quotaList.percent===1){self.$el.find(".progress-bar").css("background-color","#A7C23D")}quotaListView=SM.Views.create(SM.QuotaListView,{model:self.quotaList});self.$el.find("#QuotasViewContainer").append(quotaListView.$el)}});SM.QuotaView=SM.Views.register({__NAME:"quotaView",__templateID:"analyze-quotas-template",__model:"quota",__init:function(){},__beforeRender:function(options){this.quota_data=options.model;return{totalContext:Globalize.format(this.quota_data.totalContext,"n0"),total:Globalize.format(this.quota_data.total,"n0"),percent:Globalize.formatPercent(this.quota_data.percent,0),quota_name:this.quota_data.label}},__afterRender:function(){this.$el.find(".progress-bar").css("width",Globalize.formatPercent(this.quota_data.percent,2));if(this.quota_data.percent===1){this.$el.find(".progress-bar").css("background-color","#A7C23D")}}});SM.QuotaListView=SM.Views.register({__NAME:"quotaListView",__templateID:"analyze-quotas-list-template",__model:"quotaList",__init:function(){},__afterRender:function(){var listViewElement=this.$el;$.each(this.quotaList.quota_list,function(i,q){var quotaView=SM.Views.create(SM.QuotaView,{model:q});listViewElement.append(quotaView.$el)})}});SM.ModeTabsView=SM.Views.register({__NAME:"modeTabsView",__templateID:"analyze-mode-tabs-template",__model:"survey",__beforeRender:function(){var survey=this.survey;return{isSummaryMode:survey.state.isSummaryMode(),isBrowseMode:survey.state.isBrowseMode(),isTrendMode:survey.state.isTrendMode(),displayBrowseTab:this._displayBrowseTab(),displayTrendTab:this._displayTrendsTab(),disableTrendTab:!survey.owner.hasTrends()&&survey.isReadOnly(),summaryTabURL:this._summaryTabURL(),browseTabURL:this._browseTabURL(),trendsTabURL:this._trendsTabURL(),isDebug:SM.DEBUG}},__afterRender:function(){var $tabsText=this.$el.find("[sm-tab-text]");$tabsText.each(function(i,el){var $el=$(el),text=$el.text(),newText="",words=text.match(/[^\s]+/g);$.each(words,function(j,word){newText+=word;if(j===words.length-1){return false}if(words[j+1].length<=3){newText+=" "}else{newText+="<br/>"}});$el.html(newText)})},__init:function(){this.$el.on(SM.Event.CLICK,"#mode_tab_trends",{self:this},this._onTrendsTabClick)},_onTrendsTabClick:function(e){var self=e.data.self,dialog;if(!self.survey.owner.hasTrends()){e.preventDefault();if(!self.survey.isReadOnly()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"trends-upgrade-dialog-template"});dialog.open()}}},_displayBrowseTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isBrowseTabEnabled()}return SM.DISPLAY_BROWSE_TAB},_displayTrendsTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isTrendsTabEnabled()}return SM.DISPLAY_TREND_TAB},_buildTabURL:function(path){var url=new Uri(path);return url.toString()},_summaryTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath()}else{path="/analyze/"+this.survey.encryptedID}return this._buildTabURL(path)},_browseTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath()+"browse/"}else{path="/analyze/browse/"+this.survey.encryptedID}return this._buildTabURL(path)},_trendsTabURL:function(){var path;if(SM.App.isSharingApp()){path=SM.App.sharedView.sharedPagePath()+"data-trends/"}else{path="/analyze/data-trends/"+this.survey.encryptedID}return this._buildTabURL(path)}});SM.AnalyzeHeaderView=SM.Views.register({__NAME:"AnalyzeHeaderView",__model:"survey",__templateID:"analyze-header-container-template",__afterRender:function(){this._renderStatsHeaderView();if(this._shouldRenderQuotasHeaderView()){this._renderQuotasHeaderView()}this._renderModeTabsView()},_renderStatsHeaderView:function(){var statsHeaderView=SM.Views.create(SM.StatsHeaderView,{model:this.survey});this.el.appendChild(statsHeaderView.el)},_renderQuotasHeaderView:function(){var quotasHeaderView=SM.Views.create(SM.QuotasHeaderView,{model:this.survey.quotas});this.el.appendChild(quotasHeaderView.el)},_renderModeTabsView:function(){var modeTabsView=SM.Views.create(SM.ModeTabsView,{model:this.survey});this.el.appendChild(modeTabsView.el)},_shouldRenderQuotasHeaderView:function(){return this.survey.quotas&&!!this.survey.quotas.equations}});SM.AnalyzeMainView=SM.Views.register({__NAME:"analyzeMainView",__model:"survey",__templateID:"analyze-main-column-template",__create:function(){this.userIsOverResponseLimit=this.survey.owner.isOverResponseLimit(this.survey.respondentCounts.total)},__beforeRender:function(){return{isOverResponseLimit:this.userIsOverResponseLimit}},__afterRender:function(){if(this._shouldRenderResponseLimitUpgradeView()){this._renderResponseLimitUpgradeView()}if(this._shouldRenderProfilerDriverView()){this._renderProfilerDriverView()}this._renderAnalyzeHeaderView();this._renderContentNavView();this._renderAnalyzeContentWrapperView();if(this.survey.state.isSummaryMode()&&!SM.App.isSharingApp()){this.survey.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onDataSegmentLoaded)}},_renderAnalyzeHeaderView:function(){var view=SM.Views.create(SM.AnalyzeHeaderView,{model:this.survey});this.el.appendChild(view.el)},_renderContentNavView:function(){var view=SM.Views.create(SM.ContentNavView,{model:this.survey});this.el.appendChild(view.el)},_renderAnalyzeContentWrapperView:function(){var view=SM.Views.create(SM.AnalyzeContentWrapperView,{model:this.survey});this.el.appendChild(view.el)},_renderResponseLimitUpgradeView:function(){var view=SM.Views.create(SM.ResponseLimitUpgradeView,{model:this.survey,classes:"sm-corner-a spacer-mbl",linkSource:"wall_responselimit&ut_source2=new_analyze"});this.el.appendChild(view.el)},_renderProfilerDriverView:function(){var profilerDriverView=SM.Views.create(SM.ProfilerDriverView,{model:this.survey});this.el.appendChild(profilerDriverView.el)},_onDataSegmentLoaded:function(e){var self=e.data.self;self.$el.find(".profiler-driver-ctnr").hide()},_shouldRenderResponseLimitUpgradeView:function(){if(this.survey.isReadOnly()||SM.App.isSharingApp()){return false}return this.userIsOverResponseLimit},_shouldRenderProfilerDriverView:function(){if(!this.survey.state.isSummaryMode()||this.survey.isReadOnly()||SM.App.isSharingApp()){return false}return this.survey.isProfilerDriverEnabled()}});SM.FunctionListItemSaveView=SM.Views.register({__NAME:"FunctionListItem.SaveView",__templateID:"functionlist-save-template",__defaults:{visible:false,hasSaveBtn:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,"[view-save-btn]",{self:this},this._publishSave).on(SM.Event.CLICK,"[view-revert-btn]",{self:this},this._publishRevert)},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[view-save-btn]").click()},_publishSave:function(e){var self=e.data.self;e.preventDefault();self.trigger("saveClicked");self.__settings.visible=false;self.render()},_publishRevert:function(e){var self=e.data.self;e.preventDefault();self.trigger("revertClicked");self.__settings.visible=false;self.render()}});SM.FunctionListItemDeleteView=SM.Views.register({__NAME:"FunctionListItem.DeleteView",__templateID:"functionlist-delete-template",__defaults:{visible:false,hasCancel:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit);this.$el.on(SM.Event.CLICK,"[view-delete-btn]",{self:this},this._publishDelete);this.$el.on(SM.Event.CLICK,"[view-delete-cancel-btn]",{self:this},this._publishCancel)},__beforeRender:function(){return{visible:this.__settings.visible,hasCancel:this.__settings.hasCancel}},__afterRender:function(){if(this.__settings.visible){this.$el.removeClass("hide")}},open:function(){this.__settings.visible=true;this.render();this.$el.find("[view-delete-btn]").focus()},close:function(){this.__settings.visible=false;this.render()},_publishDelete:function(e){var self=e.data.self;e.preventDefault();self.close();self.trigger("deleteClicked")},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[view-delete-btn]").click()},_publishCancel:function(e){var self=e.data.self;self.close();self.trigger("cancelClicked")}});SM.FunctionListItemRenameView=SM.Views.register({__NAME:"FunctionListItem.RenameView",__templateID:"functionlist-rename-template",__defaults:{placeholder:"",visible:false},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,"[rename-save-btn]",{self:this},this._publishRename).on(SM.Event.CLICK,"[rename-cancel-btn]",{self:this},this._publishCancel).on(SM.Event.KEYUP,"[rename-text]",{self:this},this._onRename)},__beforeRender:function(){return{placeholder:this.__settings.placeholder,visible:this.__settings.visible}},__afterRender:function(){if(this.__settings.visible){this.$el.removeClass("hide")}this.$el.find("[rename-text]").select().focus()},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[rename-save-btn]").click()},_publishRename:function(e){var self=e.data.self,name;e.preventDefault();name=$.trim(self.$el.find("[rename-text]").val());if(name.length>0){self.trigger({type:"Renamed",newName:name});self.close()}},_publishCancel:function(e){var self=e.data.self;self.trigger("Canceled");self.close()},open:function(){this.__settings.visible=true;this.render()},close:function(){this.__settings.visible=false;this.render()},_onRename:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self._publishCancel(e);e.preventDefault()}}});SM.AnViewListView=SM.Views.register({__NAME:"AnViewList",__model:"anviews",__templateID:"anview-list-template",__init:function(){this.anviews.on("viewAdded",{self:this},this._onViewCreate)},__destroy:function(){this.anviews.off("viewAdded",this._onViewCreate)},__afterRender:function(){var len,v,viewsContainer,selectedViewID,isSelectedView,i=0;this._cacheElements();len=this.anviews.viewList.length;viewsContainer=this.$viewList.get(0);selectedViewID=this.anviews.get("selectedViewID");v=this.anviews.defaultView;isSelectedView=v.ID===selectedViewID;viewsContainer.appendChild(SM.Views.create(SM.AnView,{model:v,isSelected:isSelectedView,isSelectable:!isSelectedView}).el);for(;i<len;i++){v=this.anviews.viewList[i];if(!v.isDefault){isSelectedView=v.ID===selectedViewID;this.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:v,isSelected:isSelectedView,isSelectable:!isSelectedView}).el)}}this.saveAsView=SM.Views.create(SM.AnViewSaveAsView,{model:this.anviews.survey,disabled:!this.anviews.currentView.get("isDirty"),buttonName:"saveAsButton"});this.el.appendChild(this.saveAsView.el);this.$saveAsBtn=this.$el.find(".saveas-btn")},_onViewCreate:function(e){var self=e.data.self;SM.Bi.anViewCreate(e.anViewModel);self.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:e.anViewModel,showMenu:false,isSelected:false,isLoading:true,isDisabled:true,isSelectable:false}).el)},_cacheElements:function(){this.$viewList=this.$el.find("ul.view-item-list");return this}});SM.BaseAccordionHeadingView={__NAME:"AccordionHeadingView",__templateID:"accordion-heading-view",__defaults:{number:0,isOpen:false,title:null,isLoading:false},__setters:{isOpen:function(self,value){self.__settings.isOpen=value}}};SM.ExportHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"exportJobs",_title:"Exports",__init:function(){this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJobs.poller,"isActive.changed",{self:this},this._onPollerActiveChanged);
this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted)},__setters:{isOpen:function(self,value){self.__settings.isOpen=value;if(value===true&&!self.exportJobs.get("isLoaded")){self.exportJobs.fetchJobs()}}},__beforeRender:function(){var isLoading=!this.__settings.isOpen&&this.exportJobs.poller.get("isActive");return{isOpen:this.__settings.isOpen,isLoading:isLoading,title:Globalize.localize(this._title),number:this.exportJobs.list?this.exportJobs.list.length:null}},_onJobAdded:function(e){var self=e.data.self;self.$el.closest(".accordion").data("accordion").open("ExportListContainer");self.__settings.isOpen=true},_onJobDeleted:function(e){e.data.self.render()},_onExportJobsLoadedChanged:function(e){e.data.self.render()},_onPollerActiveChanged:function(e){e.data.self.render()}});SM.SavedViewsHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"anviews",__init:function(){this.bindModel(this.anviews,"sizeChanged",{self:this},this._onSizeChanged)},__beforeRender:function(){return{isLoading:this.__settings.isLoading,title:Globalize.localize("Saved Views"),number:this.anviews.viewList.length}},_onSizeChanged:function(e){e.data.self.render()}});SM.BenchmarkingHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"benchmarkRollups",__init:function(){this.bindModel(this.benchmarkRollups,"sizeChanged",{self:this},this._onSizeChanged)},__beforeRender:function(){return{isLoading:this.__settings.isLoading,title:Globalize.localize("Benchmarking")}},_onSizeChanged:function(e){e.data.self.render()}});SM.AnViewSaveAsView=SM.Views.register({__NAME:"AnViewSaveAsView",__model:"survey",__templateID:"viewlist-saveas-template",__defaults:{isOpen:false,warn:false,disabled:true},__init:function(){this.bindModel(this.survey.anviews.currentView,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(this.survey.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.$el.on(SM.Event.CLICK,"[saveas-btn]",{self:this},this._onSaveAsBtnClick).on("submit","form",{self:this},this._onSubmit).on(SM.Event.CLICK,"[save-new-btn]",{self:this},this._onSaveNewBtnClick).on(SM.Event.CLICK,"[cancel-btn]",{self:this},this._onCancelSaveAs).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onNameKeyup)},__beforeRender:function(){var survey=this.survey,selectedView=survey.getSelectedView();return{isOpen:this.__settings.isOpen,disabled:this.__settings.disabled,warn:this.__settings.warn,saveViewDisabled:!survey.owner.canSaveView(),viewName:selectedView.isDefault?Globalize.localize("Saved View"):selectedView.name+", "+Globalize.format(new Date,"D")}},__afterRender:function(){if(this.__settings.isOpen){this.$newName=this.$el.find("input");this.$newName.focus();this.$newName.select()}},_onNextViewIDChanged:function(e){var self=e.data.self,nextSelectedViewID=e.value,defaultViewSelected=self.survey.getSelectedView().ID===self.survey.anviews.defaultView.ID;if(defaultViewSelected&&nextSelectedViewID!==null){self.__settings.warn=true;self.render()}},_onSaveAsBtnClick:function(e){var self=e.data.self,dialog;e.preventDefault();if(!self.survey.owner.canSaveView()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});dialog.open()}else if(!self.__settings.disabled){self.__settings.isOpen=true;self.render()}},_onNameKeyup:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){e.preventDefault();self.$el.find("[cancel-btn]").click()}},_onSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[save-new-btn]").click()},_onSaveNewBtnClick:function(e){var self=e.data.self,name;SM.Bi.uiTrigger=self.__settings.buttonName;e.preventDefault();name=$.trim(self.$newName.val());if(name.length===0){return}self.survey.anviews.saveCurrentViewAs(name);self.__settings.isOpen=false;self.__settings.warn=false;self.__settings.disabled=true;self.render()},_onCancelSaveAs:function(e){var self=e.data.self;self.survey.anviews.set("nextSelectedViewID",null);self.__settings.isOpen=false;self.__settings.warn=false;self.render()},_onIsDirtyChanged:function(e){var self=e.data.self,isDirty=e.value;if(isDirty){self.__settings.disabled=false}else{self.__settings.disabled=true;self.__settings.isOpen=false;self.__settings.warn=false}self.render()}});SM.AnView=SM.Views.register({__model:"anViewModel",__NAME:"AnView",__templateID:"anview-item-template",__defaults:{isLoading:false,isSelected:false,isDirty:false,isDisabled:false,isSelectable:true,deleteMode:false,renameMode:false},__init:function(){var self=this,anViewModel=this.anViewModel;this.bindModel(anViewModel,"isLoaded.set",{self:this},this._onLoadedSet);this.bindModel(anViewModel,"selected.changed",{self:this},this._onSelectedChange);this.bindModel(anViewModel,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(anViewModel,"copySuccess",{self:this},this._onViewReady);this.bindModel(anViewModel,"createSuccess",{self:this},this._onViewReady);this.bindModel(anViewModel,"loadFailed.set",{self:this},this._onLoadFail);this.bindModel(anViewModel.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.bindModel(anViewModel.anviews.currentView,"isSaving.changed",{self:this},this._onCurrentViewSavingChanged);this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.RenameView.Renamed":function(e){SM.Bi.uiTrigger="renameViewItemMenu";SM.Bi.anViewRename(self.anViewModel);self.__settings.renameMode=false;self.__settings.isSelectable=!self.__settings.isSelected;self.anViewModel.name=e.newName;self.anViewModel.save();self.render()},"FunctionListItem.DeleteView.deleteClicked":function(){SM.Bi.uiTrigger="deleteViewItemMenu";SM.Bi.anViewDelete(self.anViewModel);self.anViewModel.anviews.deleteView(self.anViewModel);self.$el.remove()},"FunctionListItem.RenameView.Canceled":function(){self.__settings.isSelectable=!self.__settings.isSelected;self.__settings.renameMode=false;self.render()},"FunctionListItem.DeleteView.cancelClicked":function(){self.__settings.isSelectable=!self.__settings.isSelected;self.__settings.deleteMode=false;self.render()},"FunctionListItem.SaveView.saveClicked":function(){SM.Bi.uiTrigger="saveViewItemButton";SM.Bi.anViewSave(self.anViewModel.anviews.getSelectedView());self.anViewModel.anviews.currentView.commitChanges()},"FunctionListItem.SaveView.revertClicked":function(){SM.Bi.uiTrigger="revertViewItemButton";SM.Bi.anViewRevert(self.anViewModel);self.anViewModel.anviews.currentView.revert()}},{self:this})},__beforeRender:function(){var canSaveView=this.anViewModel.anviews.survey.owner.canSaveView(),isDisabled=this.__settings.isDisabled||!this.anViewModel.isDefault&&!canSaveView,isDefault=this.anViewModel.isDefault,isDirty=this.anViewModel.get("isDirty"),hideMenu=isDirty||this.__settings.isLoading||this.__settings.renameMode||this.__settings.deleteMode||!this.anViewModel.anviews.survey.isExportEnabled()&&isDefault||this.anViewModel.get("loadFailed");this.__settings.isSelectable=!isDisabled&&this.__settings.isSelectable;return{name:this.anViewModel.name,isDefault:isDefault,isLoading:this.__settings.isLoading,isSelected:this.__settings.isSelected,isSelectable:this.__settings.isSelectable,deleteMode:this.__settings.deleteMode,showMenu:!hideMenu,isDisabled:isDisabled,renameMode:this.__settings.renameMode&&!isDirty,isDirty:isDirty,loadFailed:this.anViewModel.get("loadFailed")}},__afterRender:function(md){var $listItem=this.$el.children(".list-item"),functionListWidgetView=null;if(md.showMenu){this.$el.find("a.btn-menu-down").actionMenu({menuView:"AnViewMenuView",isReadOnly:this.anViewModel.anviews.survey.isReadOnly(),isDefault:this.anViewModel.isDefault,exportsEnabled:this.anViewModel.anviews.survey.isExportEnabled(),sharingEnabled:SM.App.isSharingEnabled(),saveViewDisabled:!this.anViewModel.anviews.survey.owner.canSaveView(),canDeleteView:this.anViewModel.anviews.survey.owner.canSaveView()})}else{if(this.__settings.renameMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:md.name});functionListWidgetView.open()}else if(this.__settings.deleteMode){functionListWidgetView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true})}else if(this.anViewModel.get("isDirty")){functionListWidgetView=SM.Views.create(SM.FunctionListItemSaveView,{visible:true,warn:this.anViewModel.anviews.get("nextSelectedViewID"),hasSaveBtn:!this.anViewModel.isDefault});this.saveView=functionListWidgetView}if(functionListWidgetView){$listItem.prepend(functionListWidgetView.el)}}},_onIsDirtyChanged:function(e){var self=e.data.self;self.render()},_onNextViewIDChanged:function(e){var self=e.data.self;if(self.anViewModel===self.anViewModel.anviews.getSelectedView()){self.render()}},_onSelectedChange:function(e){var self=e.data.self,isSelected=self.anViewModel.get("selected");self.__settings.isSelected=isSelected;self.__settings.isLoading=isSelected;self.__settings.isSelectable=!isSelected;self.render()},_onLoadedSet:function(e){var self=e.data.self;if(self.anViewModel.get("isLoaded")){self.__settings.isLoading=false;self.render()}},_onCurrentViewSavingChanged:function(e){var self=e.data.self;self.__settings.isSelectable=!e.value},_onViewReady:function(e){var self=e.data.self,isSelectedView=self.anViewModel.ID===self.anViewModel.anviews.get("selectedViewID");self.__settings.isLoading=false;self.__settings.isDisabled=false;self.__settings.isSelectable=!isSelectedView;self.render()},_onSelect:function(e){var self=e.data.self,anviews=self.anViewModel.anviews,survey=self.anViewModel.anviews.survey,dialog;e.preventDefault();SM.Bi.anViewSelect(self.anViewModel);if(self.__settings.isSelectable&&survey.owner.canSaveView()){anviews.set("selectedViewID",self.anViewModel.ID)}else if(!survey.owner.canSaveView()&&!survey.isReadOnly()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});dialog.open()}},_onCurrentReset:function(e){var self=e.data.AnView;if(self.anViewModel.isDefault){self.__settings.isSelected=true;self.__settings.isLoading=true;self.render()}else if(self.__settings.isSelected){self.__settings.isSelected=false;self.render()}},_onLoadFail:function(e){e.data.self.render()},_onMenuAction:function(e){var self=e.data.self;self[e.action]()},_menuRenameClick:function(){this.__settings.isSelectable=false;this.__settings.renameMode=true;this.render()},_menuCopyClick:function(){SM.Bi.uiTrigger="copyViewItemMenu";this.anViewModel.anviews.copyView(this.anViewModel);this.render()},_menuUpgradeClick:function(){var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});dialog.open()},_menuShareClick:function(){var dialog,anViewModel=this.anViewModel,survey=anViewModel.anviews.survey;if(!survey.owner.canSaveView()&&!anViewModel.isDefault){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});dialog.open()}else{SM.Bi.uiTrigger="shareViewItemMenu";SM.AnalyzeApp.SharedViewsRouter.newSharedView({view:anViewModel})}},_menuExportClick:function(){var self=this,survey=this.anViewModel.anviews.survey,dialog;if(!survey.owner.hasExports()){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"export-upgrade-dialog-template"});dialog.open()}else{if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"export",onContinueClick:function(){self._createExportDialog(survey)}});dialog.open()}else{self._createExportDialog(survey)}}},_createExportDialog:function(survey){var exportJob,dialog;exportJob=survey.exportJobs.createJob({email:survey.currentUserEmail,export_type:"summary",export_data:{respondent_id:"all"}});exportJob.sourceView=this.anViewModel;dialog=SM.Views.create(SM.ExportDialogView,{model:exportJob,viewSelectMode:this.anViewModel.isCurrent});survey.exportJobs.fetchJobs();dialog.open()},_menuDeleteClick:function(){this.__settings.isSelectable=false;this.__settings.deleteMode=true;this.render()}});SM.AnViewMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"AnViewMenuView",__templateID:"anview-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.ExportAllBtnView=SM.Views.register({__NAME:"ExportAllBtnView",__model:"survey",__templateID:"export-all-btn-view-template",__init:function(){var self=this,isReadOnly=self.survey.isReadOnly();this.$el.actionMenu({menuView:"ExportAllMenuView",isReadOnly:isReadOnly,exportEnabled:isReadOnly||this.survey.owner.hasExports(),singleMode:this.__settings.singleMode,disallowResponses:this.__settings.disallowResponses,hasTACloud:this.__settings.hasTACloud,taEnabled:isReadOnly||this.survey.owner.canExportTA(),hasCloudView:this.__settings.hasCloudView,hasChartView:this.__settings.hasChartView}).on("actionMenu.actionSelected",{self:this},this._onMenuAction).on("click",{self:this},function(e){SM.Bi.uiTrigger=e.data.self.__settings.buttonName});if(this.survey.anviews.currentView.hasCompareRule()&&this.survey.anviews.currentView.compareRule.isRA){this._disableDotNETExports()}else if(this.survey.anviews.currentView.hasFilterRule()&&this.survey.anviews.currentView.hasRAFilterSelected()){this._disableDotNETExports()}else{this._enableDotNETExports()}this.question=this.__settings.question},__beforeRender:function(){return{noBorder:this.__settings.noBorder,singleMode:this.__settings.singleMode,disallowResponses:this.__settings.disallowResponses}},__afterRender:function(){this.$el.find(".q").popout()},_disableDotNETExports:function(){var self=this;self.survey.config.export_formats_enabled.full.excel=false;self.survey.config.export_formats_enabled.full.excel_plus=false;self.survey.config.export_formats_enabled.full.spss=false;self.survey.config.export_formats_enabled.full.gss=false;self.survey.config.export_formats_enabled.summary.excel=false;self.survey.config.export_formats_enabled.summary.csv=false},_enableDotNETExports:function(){var self=this;self.survey.config.export_formats_enabled.full.excel=self.survey.config.export_formats_enabled_server_side.full.excel;self.survey.config.export_formats_enabled.full.excel_plus=self.survey.config.export_formats_enabled_server_side.full.excel_plus;self.survey.config.export_formats_enabled.full.spss=self.survey.config.export_formats_enabled_server_side.full.spss;self.survey.config.export_formats_enabled.full.gss=self.survey.config.export_formats_enabled_server_side.full.gss;self.survey.config.export_formats_enabled.summary.excel=self.survey.config.export_formats_enabled_server_side.summary.excel;self.survey.config.export_formats_enabled.summary.csv=self.survey.config.export_formats_enabled_server_side.summary.csv},_onMenuAction:function(e){var dialog,templateID,self=e.data.self,exportType=e.action,survey=self.survey,exportEnabled=self.survey.owner.hasExports(),individualResponseMode=exportType==="individual";if(exportType==="individual"){exportType="full"}if(!exportEnabled){templateID="export-upgrade-dialog-template";if(self.__settings.singleMode){switch(exportType){case"summary":templateID="export-single-upgrade-dialog-template";break;case"cloud":templateID="ta-upgrade-dialog-template";break;case"chart":templateID="export-chart-upgrade-dialog-template";break;default:break}}dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID});dialog.open()}else{if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"export",onContinueClick:function(){self._createExportDialog(survey,exportType,individualResponseMode)}});dialog.open()}else{self._createExportDialog(survey,exportType,individualResponseMode)}}},_createExportDialog:function(survey,exportType,individualResponseMode){var dialog,jobData,jobModel,currentView=survey.anviews.currentView;jobData={email:survey.currentUserEmail,export_type:exportType==="cloud"?"chart":exportType,export_data:{respondent_id:"all"}};if(this.question!==undefined){jobData.export_data.question_id=this.question.ID;jobData.questionNumber=this.question.position;if(exportType==="chart"||exportType==="cloud"){jobData.format="png"}if(exportType==="cloud"){jobData.export_data.show_word_cloud=true;jobData.export_data.include_openended=true}}jobModel=survey.exportJobs.createJob(jobData);jobModel.sourceView=currentView;dialog=SM.Views.create(SM.ExportDialogView,{model:jobModel,viewSelectMode:true,disallowResponses:this.__settings.disallowResponses,individualResponseMode:individualResponseMode,hasChartView:this.__settings.hasChartView,question:this.question});survey.exportJobs.fetchJobs();dialog.open()}});SM.NewExportBtnView=SM.Views.extend(SM.ExportAllBtnView,{__NAME:"NewExportBtnView",__templateID:"new-export-btn-view-template"});SM.ExportAllMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportAllMenuView",__templateID:"export-all-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.ExportJobListView=SM.Views.register({__NAME:"ExportJobListView",__model:"exportJobs",__templateID:"export-job-list-template",__init:function(){this.$el.on(SM.Event.CLICK,".upgrade-message a[learn-more]",function(e){e.preventDefault();SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"export-upgrade-dialog-template"}).open()});this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoaded);this.bindModel(this.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);this.bindModel(this.exportJobs,"clickedExportPreferenceUpgradeTrigger",{self:this},this._exportPreferenceUpgradeTrigger)},__beforeRender:function(){return{isLoaded:this.exportJobs.get("isLoaded"),exportsIsUnavailable:this.exportJobs.isUnavailable,upgradeRequired:!this.exportJobs.survey.owner.hasExports()}},__afterRender:function(){var self=this,survey=self.exportJobs.survey,user=survey.owner,$jobsList=this.$el.children(".exported-jobs-list"),view,html;if(!user.hasExports()&&!survey.isReadOnly()){this.el.appendChild(SM.Template.renderHTML("export-upgrade-message-template"));return}if(this.exportJobs.get("isLoaded")){if(this.exportJobs.list.length===0){view=SM.Views.create(SM.ExportNullStateView,{model:survey});$jobsList.append(view.$el)}else{$.each(this.exportJobs.list,function(i,job){if(job&&job.exportData){view=SM.Views.create(SM.ExportJobView,{model:job,upgradeRequired:!user.hasExports()});$jobsList.append(view.$el)}else if(job){SM.log("Removing export that wasn't deleted properly type: "+job.type+"Job format: "+job.format);this.exportJobs.deleteJob(job)}});this.$el.find("[export-btn]").append(SM.Views.create(SM.NewExportBtnView,{model:survey,noBorder:true,buttonName:"ExportAccordionButton"}).el)}}else if(this.exportJobs.isUnavailable){html=SM.Template.render("exports-unavailable-template",{requestID:this.exportJobs.unavailableErrorID});this.$el.html(html)}},_onExportJobsUnavailable:function(e){if(e.value){e.data.self.render()}},_onExportDialogOpen:function(e){var self=e.data.ExportJobListView,exportDialogView=SM.Views.create(SM.ExportDialogView,{model:e.exportJob,viewModel:e.view||self.exportJobs.survey.anviews.currentView,viewSelectMode:!e.view,tab:e.exportType||"summary"});exportDialogView.open()},_onJobAdded:function(e){var self=e.data.self;self.render()},_onJobDeleted:function(e){var self=e.data.self,exportEnabled=self.exportJobs.survey.owner.hasExports();if(self.exportJobs.list.length===0&&exportEnabled){self.render()}},_onExportJobsLoaded:function(e){e.data.self.render()},_exportPreferenceUpgradeTrigger:function(e){var upgradeTemplate=e.upgradeTemplate,upgradeDialog;upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:upgradeTemplate});upgradeDialog.open()}});SM.ExportJobView=SM.Views.register({__NAME:"ExportJobView",__model:"exportJob",__templateID:"export-job-template",__defaults:{detailsOn:false,renameMode:false,upgradeRequired:true},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":function(){if(self.exportJob.isNew()){self.exportJob.exportJobs.cancelJob(self.exportJob)}else{self.exportJob.exportJobs.deleteJob(self.exportJob)}},"FunctionListItem.DeleteView.cancelClicked":function(){self.__settings.deleteMode=false;self.render()}},{self:this});this.bindModel(this.exportJob,"deleted",{self:this},this._onDelete);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDelete);this.bindModel(this.exportJob,"status.changed",{self:this},this._onStatusChanged)},_readableFormat:{excel:"xls",pdf:"pdf",html:"html",spss:"spss",excel_plus:"xls+",csv:"csv",ppt:"ppt",png:"png",gss:"drive"},_readableFormatDesc:{excel:"XLS",pdf:"PDF",html:"HTML",spss:"SPSS",excel_plus:"XLS+",csv:"CSV",ppt:"PPT",png:"PNG",gss:"Google Sheet"},__beforeRender:function(){var job=this.exportJob,viewName=this._shortenDisplayName(job.jobInfo.view_name)||"",jobName=this._shortenDisplayName(job.name),fullExport=job.type==="full",jobFormat=this._readableFormat[job.format],jobFormatDesc=this._readableFormatDesc[job.format],chartMode=job.type==="chart",summaryMode=chartMode||fullExport&&job.format!=="pdf",showWordCloud=chartMode&&job.exportData.show_word_cloud===true,pages,questions;pages=job.jobInfo.pages;questions=job.jobInfo.questions;return{job:job,jobName:jobName,pages:pages,questions:questions,jobFormat:jobFormat,jobFormatDesc:jobFormatDesc,fullExport:fullExport,createDate:job.toDateString(job.createDate),endDate:job.toDateString(job.expirationDate),jobFailed:job.failed(),detailsOn:this.__settings.detailsOn,inProgress:job.pending(),viewName:viewName,upgradeRequired:this.__settings.upgradeRequired,summaryMode:summaryMode,deleteMode:this.__settings.deleteMode,chartMode:chartMode,showWordCloud:showWordCloud,singleMode:job.get("isSingleQuestionMode"),questionNumber:job.exportData.questionNumber}},__afterRender:function(md){var deleteView,$listItem=this.$el.find(".list-item");if(this.__settings.deleteMode){deleteView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});$listItem.prepend(deleteView.$el)}else{this.$el.find("a.btn-menu-down").actionMenu({menuView:"ExportJobMenuView",detailsOn:md.detailsOn,isDisabled:this.__settings.isDisabled,jobFailed:md.jobFailed,job:md.job})}},_onStatusChanged:function(e){var self=e.data.self,notificationTitleMap=self.exportJob.NOTIFICATION_MESSAGES,notification,message,notificationTitle;if(self.exportJob.done()){notificationTitle=notificationTitleMap[self.exportJob.status];message=self.exportJob.isDrive()?"A link to Google Drive will appear under EXPORTS for 14 days.":"Files are stored under EXPORTS for 14 days.";notification=SM.Notifications.success({title:Globalize.localize(notificationTitle),message:Globalize.localize(message),duration:2e4,classes:"export-job-success-notification",tabMessage:Globalize.localize("Export complete"),content:SM.Template.render("export-job-notification-download-link-template",{job:self.exportJob})});notification.$el.on("click",".download-btn",function(evt){var link=$(evt.target).attr("link"),target=$(evt.target).attr("target");evt.preventDefault();if(target==="_blank"){window.open(link)}else{window.location=link}notification.close()})}else if(self.exportJob.failed()){notificationTitle=notificationTitleMap[self.exportJob.status];notification=SM.Notifications.error({title:Globalize.localize(notificationTitle),classes:"export-job-failed-notification",tabMessage:Globalize.localize("Export failed"),content:SM.Template.render("export-job-notification-error-message-template",{job:self.exportJob,exportTooLarge:self.exportJob.get("status")===self.exportJob.STATUS.TOO_LARGE_ERROR}),duration:1e4})}e.data.self.render()},_onSelect:function(e){var self=e.data.self,job=self.exportJob;e.preventDefault();if(!self.__settings.deleteMode){if(job.done()){if(self.exportJob.isDrive()){window.open(job.downloadLink)}else{window.location=job.downloadLink}}else{self._menuDetailsClick()}}},_onDelete:function(e){var self=e.data.self;self.$el.remove()},_onMenuAction:function(e){var self=e.data.self;self[e.action]()},_menuDetailsClick:function(){this.__settings.detailsOn=!this.__settings.detailsOn;this.render()},_menuDownloadClick:function(){},_menuDisabledDownloadClick:function(){},_menuRetryClick:function(){},_menuDeleteClick:function(){this.__settings.deleteMode=true;this.render()},_shortenDisplayName:function(name){if(!!name&&name.length>25){name=name.substring(0,20)+"..."}return name}});SM.ExportJobMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportJobMenuView",__templateID:"export-job-menu-template"});SM.ExportDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"ExportJobDialogView",__model:"exportJob",__templateID:"export-dialog-view",__defaults:{viewSelectMode:false,responseSelectMode:false,confirmDisabled:true,isModal:true,width:750,disallowResponses:false,individualResponseMode:false},__init:function(options){var self=this;this.viewID=options.viewID;this.errors={};this.$el.on(SM.Event.CLICK,"div .confirm-btn",{self:this},this._onConfirm).on(SM.Event.CLICK,"div .cancel-btn",{self:this},this._closeDialog).on(SM.Event.CLICK,"ul li a.export-summary-tab",{self:this},this._onSummaryTabClick).on(SM.Event.CLICK,"a[edit-view-select]",{self:this},this._onEditViewSelection).on(SM.Event.CLICK,"ul li a.all-response-tab",{self:this},this._onAllResponseTabClick).on(SM.Event.CLICK,"input[type='radio'][value='current']",{self:this,view:"currentView"},this._onEditViewSelection).on(SM.Event.CLICK,"input[type='radio'][value='original']",{self:this,view:"defaultView"},this._onEditViewSelection).on({formatClicked:function(){self.buttonsView.render()}});this.bindModel(this.exportJob.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJob.exportJobs,"jobStatusChanged",{self:this},this._onJobStatusChanged);this.bindModel(this.exportJob.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);this.bindModel(this.exportJob.exportJobs,"clickedExportPreferenceUpgradeTrigger",{self:this},this._closeDialog)},__onAfterClose:function(){this.$el.remove()},_onJobStatusChanged:function(e){var self=e.data.self;if(e.job.type==="full"&&!e.job.pending()){self.render()}},_onJobDeleted:function(e){var self=e.data.self;if(!self.exportJob.exportJobs.hasFullExportPending()){self.render()}},_onExportJobsLoadedChanged:function(e){var self=e.data.self;self.render()},_hasNoMatchingResponses:function(){return!this.exportJob.exportJobs.survey.hasFilteredRespondents()||this.__settings.question&&this.__settings.question.getRollup().summary.answered===0&&!this.__settings.question.hasRandomAssignment()},__beforeRender:function(){var exportJob=this.exportJob,exportJobs=exportJob.exportJobs,summaryMode=exportJob.type===exportJob.TYPE.SUMMARY_EXPORT,md={viewModel:this.exportJob.sourceView,viewSelectMode:this.__settings.viewSelectMode,responseSelectMode:this.__settings.responseSelectMode,fullExportsInProgress:!summaryMode&&exportJobs.hasFullExportPending(),exportsLoaded:exportJobs.get("isLoaded"),exportsIsUnavailable:exportJobs.isUnavailable,isAllowedToExport:!exportJobs.isNotAllowedToExport(),singleMode:exportJob.get("isSingleQuestionMode"),showWordCloud:exportJob.exportData.show_word_cloud,disallowResponses:this.__settings.disallowResponses};md[exportJob.type+"Mode"]=true;return md},__afterRender:function(){var html,exportJob=this.exportJob,exportJobs=exportJob.exportJobs,survey=exportJobs.survey,summaryMode=exportJob.type===exportJob.TYPE.SUMMARY_EXPORT,chartMode=exportJob.type===exportJob.TYPE.CHART_EXPORT,showWordCloud=exportJob.exportData.show_word_cloud,fullExportsInProgress=!summaryMode&&exportJobs.hasFullExportPending(),params={model:exportJob,hasChartView:this.__settings.hasChartView,question:this.__settings.question};SM.DialogView.__afterRender.call(this);if(exportJobs.isAvailable()){if(exportJobs.isNotAllowedToExport()){html=SM.Template.render("retry-export-warning");this.$el.children("section").append(html)}else{if(fullExportsInProgress){this.panel=SM.Views.create(SM.FullExportPendingListView,{model:exportJobs});this.$el.children("section").append(this.panel.el)}else if(this._hasNoMatchingResponses()&&!showWordCloud){this.panel=SM.Views.create(SM.ExportDialogNoMatchingResponsesView,{survey:survey});this.$el.find("div.current-panel").append(this.panel.$el)}else{if(summaryMode){this.panel=SM.Views.create(SM.ExportDialogSummaryView,params)}else if(chartMode){this.panel=SM.Views.create(SM.ChartExportDialogView,params)}else{this.panel=SM.Views.create(SM.ExportDialogAllResponseView,{model:exportJob,individualResponseMode:this.__settings.individualResponseMode})}this.$el.find("div.current-panel").append(this.panel.$el)}this.buttonsView=SM.Views.create(SM.ExportDialogButtonView,{model:exportJob,dialogDisabled:fullExportsInProgress||this._hasNoMatchingResponses()&&!showWordCloud,exportsLoaded:exportJobs.get("isLoaded")});this.$el.find(".buttons-wrapper").append(this.buttonsView.$el)}}else{html=SM.Template.render("exports-unavailable-template",{requestID:exportJobs.unavailableErrorID});this.$el.children("section").html(html)}this.$el.find(".q").popout()},_onExportJobsUnavailable:function(e){if(e.value){e.data.self.render()}},_onEditViewSelection:function(e){var self=e.data.self,view=e.data.view;self.exportJob.sourceView=self.exportJob.exportJobs.survey.anviews.get(view)},_onSummaryTabClick:function(e){var self=e.data.self;e.preventDefault();self.exportJob.type=self.exportJob.TYPE.SUMMARY_EXPORT;self.exportJob.format=undefined;self.render()},_onAllResponseTabClick:function(e){var self=e.data.self;e.preventDefault();self.exportJob.type=self.exportJob.TYPE.ALL_EXPORT;self.exportJob.format=undefined;self.render()},_closeDialog:function(e){e.preventDefault();e.data.self.close()},_onConfirm:function(e){var self=e.data.self;e.preventDefault();if(self.exportJob.format!==undefined){if(self.panel.validate()){self.close();if(self.exportJob.format==="gss"&&self.exportJob.exportJobs.requiresDriveAuth()){window.SM.authPendingDialogViewInstance=self;window.open("/analyze/export/drive/auth-req/?state=launch")}else{self.close();self.exportJob.finalizeExportData();self.exportJob.exportJobs.addJob(self.exportJob)}}else{self.panel.render()}}},onAuthEstablished:function(){this.exportJob.exportJobs.onAuthEstablished(this.exportJob)},onAuthFailed:function(){SM.Notifications.error({title:Globalize.localize("There was a problem exporting your data"),classes:"export-job-failed-notification",tabMessage:Globalize.localize("Export failed"),content:SM.Template.render("export-job-notification-error-message-template",{job:this.exportJob,exportTooLarge:false}),duration:1e4})}});SM.FullExportPendingListView=SM.Views.register({__NAME:"FullExportPendingListView",__templateID:"pending-full-exports-list-template",__model:"exportJobs",__afterRender:function(){var self=this,$ul=self.$el.find("ul"),jobs=this.exportJobs.getPendingFullExports();$.each(jobs,function(i,job){var view=SM.Views.create(SM.FullExportPendingView,{model:job});$ul.append(view.el)})}});SM.FullExportPendingView=SM.Views.register({__NAME:"FullExportPendingView",__templateID:"pending-full-export-template",__model:"exportJob",__init:function(){this.$el.on("click","[cancel-btn]",{self:this},this._onCancelClick);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDeleteJob);
this.bindModel(this.exportJob,"deleted",{self:this},this._onDeleteJob)},__beforeRender:function(){return{job:this.exportJob}},_onDeleteJob:function(e){var self=e.data.self;self.$el.remove()},_onCancelClick:function(e){var self=e.data.self,exportJob=self.exportJob,exportJobs=exportJob.exportJobs;e.preventDefault();if(exportJob.isNew()){exportJobs.cancelJob(exportJob)}else{exportJobs.deleteJob(exportJob)}}});SM.ExportDialogButtonView=SM.Views.register({__NAME:"ExportDialogButtonView",__model:"exportJob",__settings:{dialogDisabled:false,exportsLoaded:true},__templateID:"export-dialog-button-view",__beforeRender:function(){var owner=this.exportJob.exportJobs.survey.owner,exportJob=this.exportJob,exportType=exportJob.format;return{dialogDisabled:this.__settings.dialogDisabled,upgradeRequired:!owner.canExport(this.exportJob.format),confirmDisabled:exportJob.format===undefined,exportsLoaded:this.__settings.exportsLoaded,exportType:exportType,isPPT:exportType===exportJob.FORMAT.PPT,isSPSS:exportType===exportJob.FORMAT.SPSS}},__defaults:{confirmDisabled:true}});SM.BaseExportDialogPanelView={__model:"exportJob",__templateID:"export-panel-view",__init:function(){var self=this,formatsEnabled=this.exportJob.exportJobs.survey.config.export_formats_enabled;this.$el.on({emailEnter:function(e,val){self.exportJob.email=val},filenameEnter:function(e,val){self.exportJob.name=val},formatClicked:function(e,format){if(formatsEnabled[self.exportJob.type][format]){if(self.exportJob.format===format){self.exportJob.set("format",undefined)}else{self.exportJob.set("format",format)}self.render();self.$el.find(".error-msg").hide()}},useOneExcelSheetChanged:function(e,val){self.exportJob.set("questionDisplay",val)}})},_addTextInputs:function(){var errors=this.errors||{},exportJob=this.exportJob,fileview;this.exportJob.name=this.exportJob.generateFileName();fileview=SM.Views.create(SM.ExportDialogTextInputView,{label:Globalize.localize("File Name"),preferenceType:"filename",textValue:this.exportJob.name,error:errors.filename,isPPT:!!!errors.filename&&exportJob.format===exportJob.FORMAT.PPT});this.el.appendChild(fileview.el)},__beforeRender:function(){var md={format:this.exportJob.format,isSingleMode:this.exportJob.get("isSingleQuestionMode"),chartMode:this.exportJob.type==="chart",showWordCloud:this.exportJob.exportData.show_word_cloud,summaryMode:this.exportJob.type===this.exportJob.TYPE.SUMMARY_EXPORT};if(md.format){md[md.format+"Selected"]=true}else{md.selectType=null}return md},__afterRender:function(){var i=0,len=this._exportFormats.length,exportType=this.exportJob.type,formatsEnabled=this.exportJob.exportJobs.survey.config.export_formats_enabled[exportType],selectedFormat=this.exportJob.format,exportTypeList=this.$el.find("tr").get(0);for(;i<len;i++){exportTypeList.appendChild(SM.Views.create(SM.ExportDialogFormatView,{isSelected:this._exportFormats[i]===this.exportJob.format,format:this._exportFormats[i],type:this.exportJob.type,isDisabled:!formatsEnabled[this._exportFormats[i]]}).el)}if(selectedFormat){this.renderPreferences(this);this._addTextInputs()}this.$el.find(".q").popout()},validate:function(){var nameRegEx=/\S+/,name=$.trim(SM.String.htmlStrip(this.exportJob.name)),email=SM.String.htmlStrip(this.exportJob.email),dotIndex;this.errors={};if(!name.length){name=this.exportJob.generateFileName()}dotIndex=name.lastIndexOf(".");if(dotIndex!==-1){name=name.substr(0,dotIndex)}if(name.length>250){this.errors.filename=Globalize.localize("Max filename length is 250 characters")+".";return false}if(!nameRegEx.test(name)){this.errors.filename=Globalize.localize("Please enter a valid filename")+".";return false}this.exportJob.email=email;this.exportJob.name=this.exportJob.generateFileName(name);return true}};SM.ExportDialogNoMatchingResponsesView=SM.Views.register({__NAME:"ExportDialogNoMatchingResponsesView",__templateID:"export-panel-view-no-matching-responses",__beforeRender:function(options){var md={surveyHasRespondents:options.survey.hasRespondents()};return md}});SM.ExportDialogSummaryView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogSummaryView",__init:function(options){var self=this;SM.BaseExportDialogPanelView.__init.call(this,options);this.$el.on({pdfOrientationChanged:function(e,val){self.exportJob.set("pdfOrientation",val)},pdfPaperSizeChanged:function(e,val){self.exportJob.set("pdfPaperSize",val)},includeOpenendedChanged:function(e,val){self.exportJob.set("includeOpenended",val)},showWordCloudChanged:function(e,val){self.exportJob.set("showWordCloud",val)},useNonBrandedTemplateChanged:function(e,val){self.exportJob.set("useNonBrandedTemplate",val)},forcedPageBreakChanged:function(e,val){self.exportJob.set("forcedPageBreak",val)}})},__afterRender:function(md){var exportType=this.exportJob.type,formatsEnabled=this.exportJob.exportJobs.survey.config.export_formats_enabled[exportType];formatsEnabled.ppt=this.isPPTExportEnabled();SM.BaseExportDialogPanelView.__afterRender.call(this,md)},isPPTExportEnabled:function(){var isSingleMode=this.exportJob.get("isSingleQuestionMode"),currentView=this.exportJob.exportJobs.survey.anviews.currentView,question;if(currentView.hasRACompareSelected()){return false}else if(isSingleMode){question=this.__settings.question;return this.exportJob.canExportQuestionInPPT(question)}return true},hasEnabledOpenEndedInExports:function(){return!SM.SharedAnalyzeApp||!SM.SharedAnalyzeApp.data.shared_view.hide_open_ended},_exportFormats:["pdf","ppt","excel","csv"],renderPreferences:function(){var inputViews=[],inputView,exportJob=this.exportJob,self=this;inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView);if(exportJob.format===exportJob.FORMAT.PDF){inputView=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob});inputViews.push(inputView)}if(exportJob.format===exportJob.FORMAT.EXCEL){inputView=SM.Views.create(SM.ExportDialogXlsSheetChoiceView,{model:this.exportJob});inputViews.push(inputView)}if(exportJob.format!==exportJob.FORMAT.PPT){if(self.hasEnabledOpenEndedInExports()){inputViews.push(SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"includeOpenended",isChecked:this.__settings.hasChartView===false,label:Globalize.localize("Open-ended responses"),isCheckedWordCloud:this.__settings.hasChartView===false,labelWordCloud:Globalize.localize("Word Clouds"),isUpgradeTrigger:false}))}}else{inputView=SM.Views.create(SM.ExportDialogChartAndOrTableChoiceView,{model:exportJob});inputViews.push(inputView);inputView=SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"useNonBrandedTemplate",isChecked:false,label:Globalize.localize("Hide SurveyMonkey Branding"),isUpgradeTrigger:!exportJob.exportJobs.survey.owner.canHideExportBranding(),upgradeTemplate:"export-hide-branding-upgrade-dialog-template",exportJobs:exportJob.exportJobs});inputViews.push(inputView)}_.each(inputViews,function(view){self.$el.append(view.$el)});if(self.__settings.hasChartView===false){self.exportJob.set("includeOpenended",true);self.exportJob.set("showWordCloud",true)}}});SM.ChartExportDialogView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ChartExportDialogView",__init:function(options){SM.BaseExportDialogPanelView.__init.call(this,options);this.exportJob.initExport()},__afterRender:function(md){SM.BaseExportDialogPanelView.__afterRender.call(this,md);this.$el.find(".disabled .folded").hide()},renderPreferences:function(){var inputViews=[],inputView,self=this;inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView);$.each(inputViews,function(i,view){self.$el.append(view.$el)})},_exportFormats:["png","","",""]});SM.ExportDialogAllResponseView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogAllResponseView",_exportFormats:["excel","excel_plus","gss","spss","pdf"],__defaults:{individualResponseMode:false},__init:function(options){var self=this;SM.BaseExportDialogPanelView.__init.call(this,options);this.$el.on({xlsColumnChoiceChanged:function(e,val){self.exportJob.set("columnSetting",val)},xlsCellChoiceChanged:function(e,val){self.exportJob.set("cellType",val)},pdfPaperSizeChanged:function(e,val){self.exportJob.set("pdfPaperSize",val)},respondentChanged:function(){self.render()},forcedPageBreakChanged:function(e,val){self.exportJob.set("forcedPageBreak",val)}});if(this.__settings.individualResponseMode){self.$el.trigger("formatClicked","pdf")}},renderPreferences:function(){var inputViews=[],exportJob=this.exportJob,inputView,responseSelectMode=exportJob.respondentID!=="all",self=this;inputView=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});inputViews.push(inputView);if(exportJob.format==="excel"){inputView=SM.Views.create(SM.ExportDialogXlsColumnCellChoiceView,{model:exportJob});inputViews.push(inputView)}if(exportJob.format==="pdf"){inputView=SM.Views.create(SM.ExportDialogResponseSelectView,{model:this.exportJob,responseSelectMode:responseSelectMode});inputViews.push(inputView);inputView=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob,onlyPaperSize:true});inputViews.push(inputView)}$.each(inputViews,function(i,view){self.$el.append(view.$el)})}});SM.ExportDialogCheckboxInputView=SM.Views.register({__NAME:"ExportDialogCheckboxInputView",__templateID:"export-dialog-preference-checkbox",__defaults:{type:null,label:null,isChecked:false,isUpgradeTrigger:false,isDisabled:false,upgradeTemplate:null,exportJobs:null},__init:function(){var self=this,exportJobs;this.$el.on(SM.Event.CLICK,function(){if(self.__settings.isUpgradeTrigger){exportJobs=self.__settings.exportJobs;exportJobs._trigger({type:"clickedExportPreferenceUpgradeTrigger",upgradeTemplate:self.__settings.upgradeTemplate})}else if(!self.__settings.isDisabled){self.__settings.isChecked=!self.__settings.isChecked;self.$el.trigger(self.__settings.type+"Changed",self.__settings.isChecked);self.render()}})},__beforeRender:function(){return{type:this.__settings.type,isChecked:this.__settings.isChecked,checkboxLabel:this.__settings.label,isInclude:this.__settings.type==="includeOpenended",isUpgradeTrigger:this.__settings.isUpgradeTrigger,isDisabled:this.__settings.isDisabled}}});SM.ExportDialogCheckboxInputViewV1=SM.Views.register({__NAME:"ExportDialogCheckboxInputView",__templateID:"export-dialog-preference-checkbox",__defaults:{type:null,label:null,isChecked:false,isUpgradeTrigger:false,isDisabled:false,upgradeTemplate:null,exportJobs:null},__init:function(){var self=this,exportJobs;this.$el.on(SM.Event.CLICK,function(e){var value=e.target.value,checked=$(e.target).prop("checked");if(self.__settings.isUpgradeTrigger){exportJobs=self.__settings.exportJobs;exportJobs._trigger({type:"clickedExportPreferenceUpgradeTrigger",upgradeTemplate:self.__settings.upgradeTemplate})}else if(!self.__settings.isDisabled){if(value==="cloud"){self.__settings.isCheckedWordCloud=checked;self.$el.trigger("showWordCloudChanged",checked)}else{self.__settings.isChecked=checked;self.$el.trigger(self.__settings.type+"Changed",checked)}self.render()}})},__beforeRender:function(){return{type:this.__settings.type,label:this.__settings.label,isChecked:this.__settings.isChecked,isDisabled:this.__settings.isDisabled,isInclude:this.__settings.type==="includeOpenended",labelWordCloud:this.__settings.labelWordCloud,isCheckedWordCloud:this.__settings.isCheckedWordCloud,isUpgradeTrigger:this.__settings.isUpgradeTrigger}}});SM.ExportDialogTextInputView=SM.Views.register({__NAME:"ExportDialogTextInputView",__templateID:"export-dialog-text-input",__init:function(){var self=this;this.$el.on(SM.Event.KEYUP,"input",function(){self.$el.trigger(self.__settings.preferenceType+"Enter",$(this).val())})},__defaults:{textValue:null,label:null,isLastSection:false,preferenceType:null}});SM.ExportDialogDataFilterView=SM.Views.register({__NAME:"ExportDialogDataFilterView",__model:"exportJob",__templateID:"export-data-filter-view",__init:function(){return},__beforeRender:function(){var exportJob=this.exportJob,md={viewModel:this.exportJob.sourceView,viewSelectMode:true,singleMode:exportJob.get("isSingleQuestionMode"),localizedQuestionLabel:Globalize.localize("Question")+" #"+exportJob.questionNumber};return md}});SM.ExportDialogPdfInputView=SM.Views.register({__NAME:"ExportDialogPdfInputView",__model:"exportJob",__templateID:"export-dialog-pdf-input-template",__defaults:{onlyPaperSize:false},__init:function(){var self=this;this.$el.on("selectMenu.change","a[orientation]",function(e){self.$el.trigger("pdfOrientationChanged",e.value)}).on("selectMenu.change","a[paper-size]",function(e){self.$el.trigger("pdfPaperSizeChanged",e.value)})},__beforeRender:function(){var md={onlyPaperSize:this.__settings.onlyPaperSize};return md},__afterRender:function(){this.renderPreferences();this.$el.find("a[orientation]").selectMenu({selectedValue:this.exportJob.get("pdfOrientation"),options:[{text:Globalize.localize("Portrait (Vertical)"),value:"portrait"},{text:Globalize.localize("Landscape (Horizontal)"),value:"landscape"}]});this.$el.find("a[paper-size]").selectMenu({selectedValue:this.exportJob.get("pdfPaperSize"),options:[{text:Globalize.localize('Letter (8.5" x 11")'),value:"letter"},{text:Globalize.localize('Legal (8.5" x 14")'),value:"legal"},{text:Globalize.localize("A4 (210mm \xd7 297mm)"),value:"A4"}]})},renderPreferences:function(){var self=this,exportJob=this.exportJob,summaryMode=exportJob.type===exportJob.TYPE.SUMMARY_EXPORT,summaryLabel="Start each question on a new page",browseLabel="Start each response on a new page",inputView=SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"forcedPageBreak",isChecked:true,label:Globalize.localize(summaryMode?summaryLabel:browseLabel),isUpgradeTrigger:false,isDisabled:this.isPageBreakPreferenceDisabled()});self.$el.append(inputView.$el)},isPageBreakPreferenceDisabled:function(){var exportJob=this.exportJob,exportType=exportJob.type,summaryExport=exportType===exportJob.TYPE.SUMMARY_EXPORT,fullExport=exportType===exportJob.TYPE.ALL_EXPORT,singleQuestionMode=exportJob.get("isSingleQuestionMode"),singleResponseMode=exportJob.get("isSingleResponseMode");if(singleQuestionMode&&summaryExport){return true}else if(singleResponseMode&&fullExport){return true}return false}});SM.ExportDialogResponseSelectView=SM.Views.register({__NAME:"ExportDialogResponseSelectView",__model:"exportJob",__templateID:"export-dialog-response-select-template",__defaults:{responseSelectMode:false},__init:function(){this.$el.on("change","input[type='radio'][name='response']",{self:this},this._onEditResponseSelection)},__beforeRender:function(){var exportJob=this.exportJob,individualResponse=exportJob.exportData.respondent_id!=="all",md={responseSelectMode:this.__settings.responseSelectMode,individualResponse:individualResponse,respondentID:exportJob.respondentID,respondentNumber:exportJob.respondentNumber,singleRespondentID:this.__NAME+this.__uid+"radio-single-respondent",allRespondentsID:this.__NAME+this.__uid+"radio-all-respondents"};return md},_onEditResponseSelection:function(e){var self=e.data.self;self.exportJob.exportData.respondent_id=e.currentTarget.value;self.exportJob.name=self.exportJob.generateFileName();self.$el.trigger("respondentChanged",e.currentTarget.value)}});SM.ExportDialogXlsSheetChoiceView=SM.Views.register({__NAME:"ExportDialogXlsSheetChoiceView",__templateID:"export-dialog-xls-sheet-choice-view",__model:"exportJob",__init:function(){var self=this;this.$el.on(SM.Event.CLICK,"input",function(){self.$el.trigger("useOneExcelSheetChanged",$(this).val())})},__beforeRender:function(){return{singleMode:this.exportJob.get("isSingleQuestionMode")}}});SM.ExportDialogXlsColumnCellChoiceView=SM.Views.register({__NAME:"ExportDialogXlsColumnCellChoiceView",__model:"exportJob",__templateID:"export-dialog-xls-column-cell-choice-view",__init:function(){var self=this;this.$el.on("selectMenu.change","a[column]",function(e){self.$el.trigger("xlsColumnChoiceChanged",e.value)}).on("selectMenu.change","a[cell]",function(e){self.$el.trigger("xlsCellChoiceChanged",e.value)})},__afterRender:function(){this.$el.find("a[column]").selectMenu({options:[{text:Globalize.localize("Condensed"),value:"condensed"},{text:Globalize.localize("Expanded"),value:"expanded"}],selectedValue:this.exportJob.exportData.column_setting});this.$el.find("a[cell]").selectMenu({options:[{text:Globalize.localize("Actual Answer Text"),value:"actual_choice_text"},{text:Globalize.localize("Numerical Value (1-n)"),value:"numerical_value"}],selectedValue:this.exportJob.exportData.cell_type})}});SM.ExportDialogChartAndOrTableChoiceViewV1=SM.Views.register({__NAME:"ExportDialogChartAndOrTableChoiceView",__model:"exportJob",__templateID:"export-dialog-chart-and-or-table-choice-view",__init:function(){this.$el.on("change","input[type='checkbox'][name='chart-and-or-table']",{self:this},this._onEditChartAndOrTableSelection)},_onEditChartAndOrTableSelection:function(e){var self=e.data.self,option=e.currentTarget.value,checked=$(e.currentTarget).prop("checked"),exportData=self.exportJob.exportData;switch(option){case"chart":exportData.include_charts=checked;break;case"table":exportData.include_tables=checked;break;case"cloud":exportData.show_word_cloud=checked;break;default:break}}});SM.ExportDialogChartAndOrTableChoiceView=SM.Views.register({__NAME:"ExportDialogChartAndOrTableChoiceView",__model:"exportJob",__templateID:"export-dialog-chart-and-or-table-choice-view",__init:function(){this.$el.on("change","input[type='radio'][name='chart-and-or-table']",{self:this},this._onEditChartAndOrTableSelection)},_onEditChartAndOrTableSelection:function(e){var self=e.data.self,option=e.currentTarget.value,exportData=self.exportJob.exportData;switch(option){case"chart-and-table":exportData.include_charts=true;exportData.include_tables=true;break;case"chart-only":exportData.include_charts=true;exportData.include_tables=false;break;case"table-only":exportData.include_charts=false;exportData.include_tables=true;break;default:break}}});SM.ExportDialogFormatView=SM.Views.register({__templateID:"export-dialog-format-view",__NAME:"ExportDialogFormatView",__init:function(){var self=this;this.$el.on(SM.Event.CLICK,function(){if(!self.__settings.isDisabled){self.$el.trigger("formatClicked",self.__settings.format)}})},styleMap:{csv:{ext:".csv",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Opens in most analytics software"},excel:{ext:".xls",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Opens in Microsoft Excel"},excel_plus:{ext:".xls+",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Open in advanced statistical and analytical software"},rdb:{ext:".rdb",icon:"\xbc",labelColor:"exp-purple",iconClass:"smf-icon icon",description:"Provides a separate file for each database table"},spss:{ext:"spss",icon:"\xbc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Open in your SPSS analytical software"},gss:{ext:"drive",icon:"N",labelColor:"exp-blue",iconClass:"smf-icon-2 gss-icon",description:"Downloads directly to Google Sheets"},html:{ext:".html",icon:"\xdc",labelColor:"exp-purple",iconClass:"smf-icon icon",description:"Ideal for posting directly to a website"},png:{ext:".png",icon:"\xdc",labelColor:"exp-orange",iconClass:"smf-icon icon",description:"Best for adding charts as images to presentations"},pdf:{ext:".pdf",icon:"\xdc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Ideal for sharing and printing"},ppt:{ext:".ppt",icon:"\xdc",labelColor:"exp-light-purple",iconClass:"smf-icon icon",description:"Ideal for presenting in Microsoft PowerPoint"},pdf_chart:{ext:".pdf",icon:"\xdc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Ideal for sharing and opening on all computers"}},__defaults:{isSelected:false,isDisabled:false,format:null},__beforeRender:function(){var md=SM.Object.copy(this.styleMap[this.__settings.format]);md.description=Globalize.localize(md.description);md.isSelected=this.__settings.isSelected;md.format=this.__settings.format;md.isDisabled=this.__settings.isDisabled;return md}});SM.AnalyzeWarningDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"AnalyzeWarningDialogView",__model:"survey",__defaults:{width:800},__create:function(options){var self=this;self.onContinueClick=options.onContinueClick},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,".continue-btn",{self:self},self._onContinueClick)},_onContinueClick:function(e){var self=e.data.self;self.onContinueClick()}});SM.HipaaExportWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"HipaaExportWarningView",__templateID:"hipaa-export-warning",__model:"survey",__defaults:{jobType:"export",width:800},__beforeRender:function(){var jobType=this.__settings.jobType+"Mode",md={};md[jobType]=true;return md}});SM.QuotaEditWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"QuotaEditWarningView",__templateID:"quota-edit-warning",__defaults:{width:600,isModal:true}});SM.FiloDeleteWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"FiloDeleteWarningView",__templateID:"filo-delete-warning",__model:"files",__defaults:{width:600,isModal:true},__beforeRender:function(){var singleMode=this.files.length===1,md={singleMode:singleMode};if(singleMode){md.fileName=this.files[0].name;md.fileSize=SM.FiloUtils.formatSize(this.files[0].file_size)}else{md.fileCount=this.files.length}return md}});SM.BenchmarkActionMenu={actionMenu:function(owner,$el,dataSegment,source,e,useRefCount,$parentEl){var survey=dataSegment.segmentList.survey,isDefault=dataSegment.isDefault(),isLegacy=dataSegment.isLegacy(),isDerived=dataSegment.isDerived(),hasDerived=isDerived||isLegacy?false:dataSegment.segmentList.findDerived(dataSegment),hasPaid=survey.owner.hasBenchmarkingRestricted(),templateName=survey.getTemplateName(),isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate(),isReadOnly=survey.isReadOnly(),options={menuView:"BenchmarkMenuView",user_id:survey.currentUserID,surveyId:survey.ID,isDefault:isDefault,isReadOnly:isReadOnly,hasPaid:hasPaid,hasDownload:hasPaid,buy:isDefault||!isLegacy,isTMBC:!isReadOnly&&isTMBC,toStore:toStore,isNPS:survey.isNPSTemplate(),source:source,segment:dataSegment,position:{collision:"none none"}},menu,menuView,posx,posy;options.questionID="0";if(source==="segment"){if(!isTMBC){options.top25=hasPaid&&!hasDerived&&(isDefault||!isLegacy&&!isDerived);options.remove=isDerived||isLegacy}}else if(source==="question"){options.top25=false;options.remove=false;options.questionID=owner.question.ID;options.source2="&ut_source2=question_menu";if(hasPaid){options.viewList=[];_.each(dataSegment.segmentList.segmentList,function(segment){if(segment!==dataSegment){options.viewList.push({segmentName:segment.name(),segmentId:segment.id()||segment.segmentId()})}})}}if(!!templateName){options.templateName="&Template="+templateName}if($parentEl&&$parentEl.length>0){options.parentEl=$parentEl[0]}$el.actionMenu(options);$el.on({"actionMenu.actionSelected":this._onMenuAction},{self:this,owner:owner});this._useRefCount=useRefCount;if(useRefCount){owner._menuCt=0}this._dataSegment=dataSegment;if(e){menu=$el.data("actionMenu");menuView=menu.get("menuView");if(e.pageX||e.pageY){posx=e.pageX;posy=e.pageY}else if(e.clientX||e.clientY){posx=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;posy=e.clientY+document.body.scrollTop+document.documentElement.scrollTop}menuView.$el.css({left:posx+"px",top:posy+"px"})}},_canNotify:function(owner){if(this._useRefCount){owner._menuCt=owner._menuCt+1;return owner._menuCt===1}return true},_onMenuAction:function(e){var self=e.data.self,owner=e.data.owner,href,source,questionID,logicalID,canonicalName,requestDialog,survey,hasPaid,question,isNPS,templateName,toStore=e.actionMenu.get("toStore"),isTMBC=e.actionMenu.get("isTMBC");function onDone(){if(toStore){window.location.href=href}else{requestDialog=SM.Views.create(SM.BenchmarkRequestDialogView,{model:survey,type:survey.getTemplateType(),triggeredFrom:"accordion",lqid:logicalID,canonical_name:canonicalName});requestDialog.open()}}e.preventDefault();e.stopPropagation();if(!self._canNotify(owner)){return}if(e.action==="_menuAboutSMBClick"||e.action==="_menuBuyMoreClick"){href=e.$action.attr("link");source=e.actionMenu.get("source");if(source===""){source="unknown"}questionID="0";survey=e.actionMenu.get("segment").segmentList.survey;isNPS=survey.isNPSTemplate();if(source==="question"){questionID=e.actionMenu.get("questionID");question=survey.getQuestion(questionID);logicalID=question.logicalID;canonicalName=question.logicalName;if(question){isNPS=question.isNPS()}}if(e.action==="_menuBuyMoreClick"){hasPaid=e.actionMenu.get("hasPaid");templateName=survey.getTemplateName();if(!isTMBC){href=href+"?userid="+e.actionMenu.get("user_id")+"&surveyID="+survey.ID+"&qbcat="+templateName+"&source="+(hasPaid?"analyze_paid":"analyze_QPQP")+"&ut_source="+"analyze"}SM.Bi.benchmarkingBuyMore(questionID,"benchmarking_buy_menu_action",source,href,hasPaid,isNPS).done(onDone).fail(onDone)}else{SM.Bi.benchmarkingAbout(questionID,source,href,isNPS);window.open(href,"_blank")}}else if(self[e.action]){self[e.action](e)}else if(owner&&owner[e.action]){owner[e.action]()}},_menuDownloadCSV:function(e){var owner=e.data.owner,segment=owner.dataSegment?owner.dataSegment:e.actionMenu.get("segment"),source=e.actionMenu.get("source"),questionID=e.actionMenu.get("questionID");segment.downloadCSV();SM.Bi.benchmarkingDownloadCSV(questionID,segment.segmentId(),source)},_menuShowTop25Click:function(e){var segment=e.actionMenu.get("segment");segment.segmentList.addDerivedSegment(segment,"top25")},_menuViewClick:function(e){var segment=e.actionMenu.get("segment"),$tgt=$(e.actionMenu._menu._$options[e.actionMenu._menu._currentIndex]),segmentId=$tgt.attr("segment-id"),newSegment=segment.segmentList.findSegmentById(segmentId);if(newSegment){SM.API.logSetUiTrigger("action_menu");segment.segmentList.selectSegment(newSegment,segment.getCanonicalName(),"question")}},_menuUpgradeClick:function(){var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"data-segment-upgrade-dialog-template"});dialog.open()}};SM.BenchmarkMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"BenchmarkMenuView",__templateID:"data-segment-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.BenchmarkRequestDialogContentView=SM.Views.register({__NAME:"benchmarkRequestDialogContentView",__templateID:"benchmark-request-dialog-content-template",__model:"survey",__beforeRender:function(){var md={template_id:this.survey.getTemplateID(),logical_question_id:this.get("lqid"),canonical_name:this.get("canonical_name"),email:this.survey.owner.email,survey_id:this.survey.ID,has_restricted:this.survey.owner.hasBenchmarkingRestricted(),user_id:this.survey.owner.ID};return md}});SM.BenchmarkRequestDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"benchmarkRequestDialogView",__templateID:"benchmark-request-dialog-template",__model:"survey",__defaults:{isModal:true,width:728,height:575,position:{my:"center",at:"center",collision:"none"},easyClose:true,closeBtn:true,lqid:"None",canonical_name:"None"},__onBeforeOpen:function(){var $contentCtnr=this.$el.find("[benchmark-request-content-ctnr]"),source="accordion",contentView=SM.Views.create(SM.BenchmarkRequestDialogContentView,{model:this.survey,type:this.__settings.type,dlg:this,source:source,triggeredFrom:this.get("triggeredFrom"),lqid:this.get("lqid"),canonical_name:this.get("canonical_name")});$contentCtnr.append(contentView.$el);SM.DialogView.__onBeforeOpen.call(this)},__onAfterClose:function(){$("<div>").append(this.$el).empty()}});SM.DataSegmentView=SM.Views.register({__model:"dataSegment",__NAME:"DataSegmentView",__templateID:"data-segment-item-template",__defaults:{isSelectable:true,isSelected:false,deleteMode:false},__init:function(){this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onDataSegmentClicked);this.$el.on({"DataSegmentItem.DeleteView.deleteClicked":this._onDeleteClicked,"DataSegmentItem.DeleteView.cancelClicked":this._onCancelClicked},{self:this})},__beforeRender:function(){var self=this,dataSegment=self.dataSegment,isFake=dataSegment.isFake(),isDefault=dataSegment.isDefault(),isSelected=dataSegment.isSelected(),isLocked=isDefault&&isSelected&&dataSegment.segmentList.countSelected()===1,isReadOnly=dataSegment.segmentList.survey.isReadOnly(),deleteMode=self.get("deleteMode");return{segmentId:dataSegment.segmentId(),name:dataSegment.name(),isSelected:isSelected,isLocked:isLocked,isDefault:isDefault,isFake:isFake,deleteMode:deleteMode,isDisabled:!deleteMode&&!isSelected&&isReadOnly,showMenu:!(deleteMode||isFake||isReadOnly&&!isSelected)}},__afterRender:function(md){var $listItem=this.$el.children(".list-item"),dataSegmentWidgetView=null;if(md.showMenu){SM.BenchmarkActionMenu.actionMenu(this,this.$el.find("a.btn-menu-down"),this.dataSegment,"segment")}else{if(this.get("deleteMode")){dataSegmentWidgetView=SM.Views.create(SM.DataSegmentDeleteView,{visible:true})}if(dataSegmentWidgetView){$listItem.prepend(dataSegmentWidgetView.el)}}},_onDataSegmentClicked:function(e){var self=e.data.self,survey=self.dataSegment.segmentList.survey,isOwner=survey.isCurrentUserAlsoOwner(),marketingDialog;if(survey.isReadOnly()){return}if(self.dataSegment.isFake()){if(isOwner){marketingDialog=SM.Views.create(SM.ProfilerMarketingDialogView,{model:survey.profiler,type:survey.getTemplateType(),triggeredFrom:"accordion",segmentName:self.dataSegment.name()});marketingDialog.open()}return}if(self.get("isSelectable")&&!self.dataSegment.isSelected()){self.dataSegment.segmentList.toggleSelection(self.dataSegment)}},_menuUpgradeClick:function(){var dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"data-segment-upgrade-dialog-template"});dialog.open()},_menuDeleteClick:function(){this.set("isSelectable",false);this.set("deleteMode",true);this.render()},_onCancelClicked:function(e){var self=e.data.self;self.set("deleteMode",false);self.render()},_onDeleteClicked:function(e){var self=e.data.self;self.dataSegment.segmentList.deleteSegment(self.dataSegment);self.set("isSelectable",true);self.set("deleteMode",false);self.render()}});SM.DataSegmentMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"DataSegmenMenuView",__templateID:"data-segment-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.DataSegmentDeleteView=SM.Views.register({__NAME:"DataSegmentItem.DeleteView",__templateID:"data-segment-delete-template",__defaults:{visible:false,hasCancel:true},__init:function(){this.$el.on(SM.Event.CLICK,"[data-segment-delete-btn]",{self:this},this._publishDelete);this.$el.on(SM.Event.CLICK,"[data-segment-delete-cancel-btn]",{self:this},this._publishCancel)},__beforeRender:function(){return{visible:this.__settings.visible,hasCancel:this.__settings.hasCancel}},__afterRender:function(){if(this.__settings.visible){this.$el.removeClass("hide")}},open:function(){this.__settings.visible=true;this.render();this.$el.find("[data-segment-delete-btn]").focus()},close:function(){this.__settings.visible=false;this.render()},_publishDelete:function(e){var self=e.data.self;e.preventDefault();self.close();self.trigger("deleteClicked")},_publishCancel:function(e){var self=e.data.self;self.close();self.trigger("cancelClicked")}});SM.DataSegmentContainerView=SM.Views.register({__NAME:"DataSegmentContainerView",__templateID:"data-segment-container-template",__model:"survey",__afterRender:function(){this.dataSegmentBuilderView=SM.Views.create(SM.DataSegmentBuilderView,{model:this.survey.dataSegmentList});this.$el.append(this.dataSegmentBuilderView.$el);this.dataSegmentBuilderView.$el.hide();this.dataSegmentListView=SM.Views.create(SM.DataSegmentListView,{model:this.survey.dataSegmentList});this.$el.append(this.dataSegmentListView.$el);this.inProgressNotification=null},__init:function(){this.survey.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_ERROR,{self:this},this._onDataSegmentError);
this.survey.anviews.currentView.on("ruleEdited",{self:this},this._onRuleEdited)},_onDataSegmentError:function(e){var self=e.data.self,errName=e.name,errMsg=e.message;if(self.inProgressNotification){self.inProgressNotification.close();self.inProgressNotification=null}self.inProgressNotification=SM.Notifications.error({title:Globalize.localize(errName),classes:"data-segment-error-notification",tabMessage:Globalize.localize(errMsg),content:SM.Template.render("data-segment-error-message-template",{message:Globalize.localize(errMsg)}),duration:1e4})},_onRuleEdited:function(e){var self=e.data.self,ruleModel=e.ruleModel,isCompare=ruleModel.ruleFamily==="compare";if(isCompare){self.render()}}});SM.DataSegmentBuilderView=SM.Views.register({__NAME:"DataSegmentBuilderView",__templateID:"data-segment-builder-template",__model:"dataSegmentList",__beforeRender:function(){return{segmentChoices:this.dataSegmentList.getQuestionOptions()}},__afterRender:function(){this._$subsegmentChooser=this.$el.find(".subsegment-chooser");this._$subsegmentChooser.hide();this._$percentileChooser=this.$el.find(".data-percentile-chooser");this._$percentileChooser.hide();this._$applyBtn=this.$el.find("[new-segment-apply]");this._$applyBtn.hide()},__init:function(){this.$el.on(SM.Event.CLICK,"[new-segment-cancel]",{self:this},this._onNewSegmentCancelClicked);this.$el.on(SM.Event.CLICK,"[new-segment-apply]",{self:this},this._onNewSegmentApplyClicked);this.$el.on(SM.Event.CHANGE,"[segment-choice-list]",{self:this},this._onSegmentChoiceChanged);this.$el.on(SM.Event.CHANGE,"[subsegment-choice-list]",{self:this},this._onSubsegmentChoiceChanged);this.$el.on(SM.Event.CHANGE,"[segment-percentile-list]",{self:this},this._onPercentileChoiceChanged);this.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onNewSegmentLoaded)},_onSegmentChoiceChanged:function(e){var self=e.data.self,$tgt=$(e.target),choice=$tgt.val(),md={};e.preventDefault();e.stopPropagation();if(choice===""||choice==="all"){self._$subsegmentChooser.hide();if(choice==="all"){self._$percentileChooser.show();self._$applyBtn.show()}else{self._$percentileChooser.hide();self._$applyBtn.hide()}}else{md.subsegmentChoices=self.dataSegmentList.getOptionOptions(choice);self._$subsegmentChooser.html(SM.Template.render("subsegment-chooser-template",md));self._$subsegmentChooser.show();self._$percentileChooser.hide();self._$applyBtn.hide()}},_onSubsegmentChoiceChanged:function(e){var self=e.data.self,$tgt=$(e.target),choice=$tgt.val();e.preventDefault();e.stopPropagation();if(choice===""){self._$percentileChooser.hide();self._$applyBtn.hide()}else{self._$percentileChooser.show();self._$applyBtn.show()}},_onPercentileChoiceChanged:function(e){e.preventDefault();e.stopPropagation()},_onNewSegmentCancelClicked:function(e){var self=e.data.self,$segmentListHolder=self.$el.closest("[data-segment-ctnr]").find("[benchmark-segment-list]");e.preventDefault();e.stopPropagation();self.$el.hide();$segmentListHolder.show()},_onNewSegmentLoaded:function(e){var self=e.data.self,$segmentListHolder=self.$el.closest("[data-segment-ctnr]").find("[benchmark-segment-list]");$segmentListHolder.show();self.$el.hide()},_onNewSegmentApplyClicked:function(e){var self=e.data.self,$segmentChoiceList=self.$el.find("[segment-choice-list]"),segmentChoice=$segmentChoiceList.val(),$subsegmentChoice=self.$el.find("[subsegment-choice-list]"),subsegmentChoice=$subsegmentChoice.val(),$percentileChoice=self.$el.find("[segment-percentile-list]"),percentileChoice=parseInt($percentileChoice.val(),10),valid;e.preventDefault();e.stopPropagation();if(!!segmentChoice){valid=self.dataSegmentList.createNewSegment(segmentChoice,subsegmentChoice,percentileChoice);if(!valid){self.dataSegmentList._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:Globalize.localize("You have already created a segment for that benchmark."),message:Globalize.localize("Please change your segment choices and try again.")})}}}});SM.DataSegmentListView=SM.Views.register({__model:"dataSegmentList",__templateID:"data-segment-list-template",__NAME:"DataSegmentListView",__init:function(){this.$el.on(SM.Event.CLICK,"[new-segment]",{self:this},this._onNewSegmentClicked);this.$el.on(SM.Event.CLICK,"[show-benchmarks-btn]",{self:this},this._onShowBenchmarksClicked);this.$el.on(SM.Event.CLICK,".data-segment-cta a",{self:this},this._onCTAClicked);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_ADDED,{self:this},this._onDataSegmentAdded);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_DELETED,{self:this},this._onDataSegmentDeleted);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_SELECTION_CHANGED,{self:this},this._onDataSegmentSelectionChanged);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_SHOWN_CHANGED,{self:this},this._onBenchmarkShownChanged);this.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onDataSegmentAdded)},__beforeRender:function(){var survey=this.dataSegmentList.survey,shouldShowSegments=survey.profiler&&survey.canShowBenchmarking()&&!survey.shouldShowProfiler(),isCompared=survey.anviews.currentView.getCompareRuleSelected();return{benchmarkingDisabled:!this.dataSegmentList.hasBenchmarking(),benchmarkingRestrictedEnabled:this.dataSegmentList.hasRestrictedFeatures(),ctBenchmarks:this.dataSegmentList.getCountOfBenchmarkableQuestions(),showCompleteMsg:!shouldShowSegments,isNPS:survey.isNPSTemplate(),isSHRM:survey.isSHRMTemplate(),isGeneric:survey.isGenericTemplate(),userid:this.dataSegmentList.survey.currentUserID,isCompared:isCompared}},__afterRender:function(){var self=this,$ulDefault=self.$el.find("[default-data-segment]"),$ulPaid=self.$el.find("[paid-segment]").detach(),$ulLegacy=self.$el.find("[legacy-segment-list]").detach(),$curUl=$ulDefault,$newUl,sawLegacy=false,shouldShowFake=self.dataSegmentList.survey.isStoreTemplate(),hasRestrictedFeatures=this.dataSegmentList.hasRestrictedFeatures();if(this.dataSegmentList.hasBenchmarking()){_.each(this.dataSegmentList.segmentList,function(segment){var view;if(segment.isDefault()){view=SM.Views.create(SM.DataSegmentView,{model:segment});$ulDefault.append(view.$el)}else if(hasRestrictedFeatures||segment.isFake()&&shouldShowFake){if(segment.isLegacy()){if(!sawLegacy){$curUl.after($ulLegacy);$curUl=$ulLegacy;sawLegacy=true}}else{if(!segment.isDerived()){$newUl=$ulPaid.clone();$curUl.after($newUl);$curUl=$newUl}}view=SM.Views.create(SM.DataSegmentView,{model:segment,isSelectable:!segment.isFake()});$curUl.append(view.$el)}});this._showOrHideSegmentList();this.$el.find(".q").popout()}},_clearSegmentBuilder:function(){var $segmentChoiceList=$("[segment-choice-list]"),$subsegmentChoice=$("[subsegment-choice-list]"),$percentileChoice=$("[segment-percentile-list]"),$subsegmentChooser=$(".subsegment-chooser"),$percentileChooser=$(".data-percentile-chooser");$segmentChoiceList.val("");$subsegmentChoice.val("");$percentileChoice.val("");$percentileChooser.hide();$subsegmentChooser.hide()},_onNewSegmentClicked:function(e){var self=e.data.self,$segmentRuleBuilder=self.$el.closest("[data-segment-ctnr]").find("[data-segment-builder]");e.preventDefault();e.stopPropagation();if(self.dataSegmentList.hasRestrictedFeatures){self.$el.hide();self._clearSegmentBuilder();$segmentRuleBuilder.show()}},_onCTAClicked:function(e){var self=e.data.self,survey=self.dataSegmentList.survey,requestDialog;e.preventDefault();e.stopPropagation();requestDialog=SM.Views.create(SM.BenchmarkRequestDialogView,{model:survey,type:survey.getTemplateType(),triggeredFrom:"accordion"});requestDialog.open()},_onDataSegmentAdded:function(e){var self=e.data.self;SM.log("DataSegmentListView._onDataSegmentAdded - rerendering.");self.render()},_onDataSegmentDeleted:function(e){var self=e.data.self;self.render()},_onDataSegmentSelectionChanged:function(e){var self=e.data.self;SM.log("DataSegmentListView._onDataSegmentSelectionChanged - rerendering.");self.render()},_onBenchmarkShownChanged:function(e){var self=e.data.self;self._showOrHideSegmentList()},_showOrHideSegmentList:function(){var $msgs=this.$el.find("[data-segment-list-messages]"),$segments=this.$el.find("[data-segment-list-ctnr]"),$cta=this.$el.find("[data-segment-cta]"),survey=this.dataSegmentList.survey,shouldShowSegments=survey.profiler&&survey.canShowBenchmarking()&&!survey.shouldShowProfiler();if(shouldShowSegments){$msgs.hide();$segments.show()}else{$msgs.show();$segments.hide()}if(shouldShowSegments&&!survey.isStoreTemplate()){$cta.show()}else{$cta.hide()}},_onShowBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),survey=self.dataSegmentList.survey,isOwner=survey.isCurrentUserAlsoOwner(),profilerDialog,onDone=function(){self.dataSegmentList.enableAllBenchmarks(true)},onFail=function(){var errName="Failed to save profile",errMsg="We were unable to save your profile. Please try again later.";SM.Ajax.logError({name:errName,message:errMsg});self.dataSegmentList._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:errName,message:errMsg})};e.preventDefault();e.stopPropagation();if($tgt.hasClass("disabled")||self.dataSegmentList.survey.isReadOnly()){return}if(!isOwner){if(!survey.isProfilerDialogEnabled()){self.dataSegmentList.enableAllBenchmarks(true)}}else if(survey.isProfilerDialogEnabled()){profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"accordion",triggeredFrom:"accordion_complete_profile_button"});profilerDialog.open()}else if(survey.profiler.profileSaved){self.dataSegmentList.enableAllBenchmarks(true)}else{survey.profiler.save({done:onDone,fail:onFail})}}});SM.FileUploadPreviewView=SM.Views.deepExtend(SM.DialogView,{__NAME:"FileUploadPreviewView",__templateID:"filo-preview-template",__defaults:{isModal:true},_ZOOM_STEP:1.25,__beforeRender:function(options){var self=this;if(options){self.files=options.files||[options.filoItem];self.index=options.index||0;self.currentFilo=self.files[self.index];self.filoList=options.filoList;self.survey=options.survey}$("body").addClass("preview-modal");return this._makeFiloModel(self.index)},__init:function(){var self=this,updateLayout=_.debounce(function(){self._afterResize()},300);self.$el.on("click",".filo-preview-close",function(){self.close()}).on("click",".prev",{self:self},self._onPrev).on("click",".next",{self:self},self._onNext).on("click",".zoom-in",{self:self},self._onZoomIn).on("click",".zoom-out",{self:self},self._onZoomOut).on("click",".download-btn",{self:self},self._onDownload);if(self.filoList){self.filoList.on("appended",{self:self},self._onResponsesAppended)}$(window).on("resize",updateLayout)},__destroy:function(){if(this.filoList){this.filoList.off("appended",this._onResponsesAppended)}},__afterRender:function(){var self=this;self._afterResize();if(self.filoList){if(self.index===0){self.$el.find(".prev").hide()}if(self.index===self.files.length-1&&self.filoList.isFullyLoaded()){self.$el.find(".next").hide()}}},__onAfterOpen:function(){var el=$(".dialog-container");el.addClass("filo-preview").find(".filo-preview-container").attr("style","");if(this.files.length===1){el.addClass("single-file")}},__onAfterClose:function(){$("body").removeClass("preview-modal")},_onDownload:function(e){var self=e.data.self;e.preventDefault();self.survey.filoDownload(self.currentFilo.file_id)},_loadImg:function(){var self=this,imgEl;imgEl=$('<img id="filo-preview-img" />');imgEl.css("visibility","hidden").on("load",self._onImgLoaded);self.$el.find(".filo-preview-row td").empty().append(imgEl);imgEl.attr("src",self.survey.filoPreviewUrl(self.currentFilo.file_id))},_onImgLoaded:function(){var imgEl=$("#filo-preview-img"),contentEl=imgEl.closest(".filo-preview-content"),contentHeight=contentEl.height(),contentWidth=contentEl.width(),imgHeight=imgEl.height(),imgWidth=imgEl.width(),ratio=Math.min(contentHeight/imgHeight,contentWidth/imgWidth);if(ratio<1){imgHeight=Math.floor(imgHeight*ratio);imgEl.css("height",imgHeight-8+"px")}imgEl.hide().css("visibility","visible").fadeIn()},_onResponsesAppended:function(e){var self=e.data.self;self.files=_.filter(self.filoList.get("filoData").files,function(file){return file.file_status===3});self._onNext(e)},_onNext:function(e){var self=e.data.self,files=self.files;e.preventDefault();if(self.index+1<files.length){self.currentFilo=files[++self.index];self.render()}else if(!self.filoList.isFullyLoaded()){self.filoList.fetchMoreResponses()}},_onPrev:function(e){var self=e.data.self,files=self.files;e.preventDefault();self.currentFilo=files[--self.index];self.render()},_onZoomIn:function(e){var self=e.data.self,imgEl=self.$el.find(".filo-preview-content img");e.preventDefault();imgEl.css("height",imgEl.height()*self._ZOOM_STEP+"px")},_onZoomOut:function(e){var self=e.data.self,imgEl=self.$el.find(".filo-preview-content img");e.preventDefault();imgEl.css("height",imgEl.height()/self._ZOOM_STEP+"px")},_afterResize:function(){var self=this;self.$el.find(".filo-preview-content").css("height",$(window).height()-62+"px");setTimeout(function(){if(self._canPreview(self.currentFilo)){self._loadImg()}else{$(".filo-no-preview-msg").hide().fadeIn("")}},10)},_canPreview:function(data){if(data.file_status!==3){return false}switch(data.content_type){case"image/jpeg":case"image/gif":case"image/png":return true;case"application/msword":case"application/pdf":default:return false}},_makeFiloModel:function(index){var data=this.files[index],created=new Date(data.date),deleted=data.date_deleted?new Date(data.date_deleted):false;return{name:data.name,size:SM.FiloUtils.formatSize(data.file_size),noPreview:!this._canPreview(data),date:Globalize.format(created,"d")+" "+Globalize.format(created,"t"),status:data.file_status,deleted:deleted?Globalize.format(deleted,"d")+" "+Globalize.format(deleted,"t"):"",count:this.files.length,index:index+1}}});SM.ShareAllBtnView=SM.Views.register({__NAME:"ShareAllBtnView",__model:"survey",__templateID:"share-all-btn-view-template",__create:function(options){this.survey=options.survey;_.bindAll(this,"_onClick")},__beforeRender:function(){return{noBorder:this.__settings.noBorder}},__afterRender:function(){this.$el.find(".q").popout()},__init:function(){this.$el.on("click",{self:this},this._onClick)},_renderSharedViewFormView:function(dialogView){var $target,sharedView,sharedViewFormView;$target=dialogView.$el.find("[shared-view-form-container]");sharedView=SM.Models.create("SharedView",{survey_id:this.survey.ID,view_id:this.survey.anviews.currentView.ID,name:"My Shared View",title:"The Survey Title"});sharedView.survey=this.survey;sharedViewFormView=SM.Views.create(SM.SharedViewFormView,{dialogView:dialogView,sharedView:sharedView});$target.html(sharedViewFormView.el)},_onClick:function(e){var dialog,self=e.data.self,survey=self.survey;e.preventDefault();if(this.survey.isReadOnly()){return}if(survey.owner.get("hipaaEnabled")){dialog=SM.Views.create(SM.HipaaExportWarningView,{model:survey,jobType:"share",onContinueClick:function(){SM.AnalyzeApp.SharedViewsRouter.newSharedView()}});dialog.open()}else{SM.AnalyzeApp.SharedViewsRouter.newSharedView()}}});SM.SharedViewsKeyHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"anviews",__create:function(options){this.sharedViews=options.sharedViews;this.set("isOpen",true)},__beforeRender:function(){var self=this,numViews=self.sharedViews.list.length;return{isLoading:this.__settings.isLoading,title:Globalize.localize("Shared Data"),number:numViews?numViews.toString():null}},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewsChanged)},_onSharedViewsChanged:function(e){e.data.self.render()}});SM.SharedViewListView=SM.Views.register({__NAME:"SharedViewListView",__model:"sharedViewList",__templateID:"shared-view-list-template",__create:function(options){this.survey=options.survey;this.sharedViews=options.sharedViews;_.bindAll(this,"_onSharedViewsLoaded","_onSharedViewAdded","_onSharedViewRemoved")},__beforeRender:function(){return{isLoaded:this.sharedViews.get("isLoaded"),hasScrollbar:this.sharedViews.list.length>5}},__afterRender:function(){if(this.sharedViews.get("isLoaded")){if(this.sharedViews.list.length>0){this._renderSharedViewListItemViews()}else{this._renderNullStateView()}}},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsLoaded);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewAdded);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewRemoved)},_renderNullStateView:function(){var view=SM.Views.create(SM.ShareViewsNullStateView,{model:this.survey});this.$el.append(view.el)},_renderSharedViewListItemViews:function(){var self=this,sortedSharedViews;sortedSharedViews=_.sortBy(self.sharedViews.list,function(sharedView){return 1-sharedView.id});_.each(sortedSharedViews,function(sharedView){var view=SM.Views.create(SM.SharedViewListItemView,{sharedView:sharedView});self.$el.find("[shared-view-list]").append(view.el)})},_onSharedViewsLoaded:function(){this.render()},_onSharedViewAdded:function(){this.render()},_onSharedViewRemoved:function(){this.render()}});SM.ShareViewsNullStateView=SM.Views.register({__NAME:"SharedViewsNullStateView",__model:"survey",__templateID:"shared-views-null-state-template",__afterRender:function(){this._renderShareAllBtn()},_renderShareAllBtn:function(){var $shareAllBtn=this.$el.find("[share-all-btn]");$shareAllBtn.replaceWith(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:false}).el)}});SM.SharedViewListItemView=SM.Views.register({__NAME:"SharedViewListItemView",__model:"sharedView",__templateID:"shared-view-list-item-template",__settings:{deleteMode:false,renameMode:false},__create:function(options){this.sharedView=options.sharedView;this.title=Globalize.localize("Click to view shared data");_.bindAll(this,"render","_onSelect","_onActionMenuInit","_onMenuAction","_onDeleteClick","_onCancelDeleteClick","_onRenameClick","_onCancelRenameClick","_setClipboardText")},__beforeRender:function(){return{sharedView:this.sharedView,deleteMode:this.get("deleteMode"),renameMode:this.get("renameMode")}},__afterRender:function(){var self=this,name=this.sharedView.get("name"),isDeleting=this.get("deleteMode"),isRenaming=this.get("renameMode"),$listItem=this.$el.find("[list-item]"),$actionMenuBtn=this.$el.find("[btn-action-menu]"),deleteView,renameView;if(isDeleting){deleteView=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});$listItem.prepend(deleteView.$el)}else if(isRenaming){renameView=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:name});renameView.open();$listItem.prepend(renameView.$el)}if(isRenaming||isDeleting){self.$el.removeAttr("title")}else{$listItem.on(SM.Event.CLICK,{self:self},self._onSelect);self.$el.attr("title",self.title)}$actionMenuBtn.actionMenu({menuView:"SharedViewListItemMenuView",sharedView:this.sharedView}).on("actionMenu.menuInit",this._onActionMenuInit)},__init:function(){this.bindModel(this.sharedView,"enabled.changed",{self:this},this.render);this.bindModel(this.sharedView,"saved",{self:this},this.render);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":this._onDeleteClick,"FunctionListItem.DeleteView.cancelClicked":this._onCancelDeleteClick,"FunctionListItem.RenameView.Renamed":this._onRenameClick,"FunctionListItem.RenameView.Canceled":this._onCancelRenameClick},{self:this})},_onActionMenuInit:function(e){var actionMenu=e.actionMenu,menuView=actionMenu.get("menuView");menuView.$el.find(".q").popout()},_onSelect:function(e){e.preventDefault();SM.Bi.uiTrigger="sharedViewItem";SM.Bi.sharedViewVisit(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onMenuAction:function(e){var self=this;e.preventDefault();if(e.action==="show-view"){self._onShowViewMenuItemClick()}else if(e.action==="get-link"){self._onGetLinkMenuItemClick()}else if(e.action==="edit-view"){self._onEditViewMenuItemClick()}else if(e.action==="delete-view"){self._onDeleteViewMenuItemClick()}else if(e.action==="rename-view"){self._onRenameViewMenuItemClick()}else if(e.action==="copy-link"){self._onCopyLinkMenuItemClick()}else if(e.action==="toggle-view"){self._onToggleMenuItemClick()}},_onShowViewMenuItemClick:function(){SM.Bi.uiTrigger="viewSharedViewItemMenu";SM.Bi.sharedViewVisit(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onCopyLinkMenuItemClick:function(){SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")})},_onGetLinkMenuItemClick:function(){SM.Bi.uiTrigger="getLinkSharedViewItemMenu";SM.Bi.sharedViewGetWeblink(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.edit(this.sharedView,true)},_onEditViewMenuItemClick:function(){SM.Bi.uiTrigger="editSharedViewItemMenu";SM.AnalyzeApp.SharedViewsRouter.edit(this.sharedView,false)},_onToggleMenuItemClick:function(){SM.Bi.sharedViewToggle(this.sharedView);this.sharedView.toggleEnabled()},_onDeleteViewMenuItemClick:function(){SM.Bi.uiTrigger="deleteSharedViewItemMenu";this.set("deleteMode",true);this.render()},_onDeleteClick:function(e){SM.Bi.sharedViewDelete(this.sharedView);e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.destroy(this.sharedView)},_onCancelDeleteClick:function(e){var self=this;e.preventDefault();self.set("deleteMode",false);self.render()},_onRenameViewMenuItemClick:function(){SM.Bi.uiTrigger="renameSharedViewItemMenu";this.set("renameMode",true);this.render()},_onRenameClick:function(e){var self=this;e.preventDefault();self.sharedView.set("name",e.newName);SM.Bi.sharedViewRename(self.sharedView);self.sharedView.save();self.set("renameMode",false);self.render()},_onCancelRenameClick:function(e){var self=this;e.preventDefault();self.set("renameMode",false);self.render()},_setClipboardText:function(){return this.sharedView.sharedPageURL()}});SM.SharedViewListItemMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"SharedViewListItemMenuView",__templateID:"shared-view-list-item-menu-template",__create:function(){this.sharedView=this.__settings.sharedView},__beforeRender:function(){return{toggleEnabledText:this.sharedView.isEnabled()?Globalize.localize("Turn sharing off"):Globalize.localize("Turn sharing on"),isEnterpriseShare:this.sharedView.isEnterpriseTeam()}}});SM.SharedViewFormView=SM.Views.register({__NAME:"NewSharedViewView",__templateID:"shared-view-form-template",__create:function(options){this.dialogView=options.dialogView;this.sharedView=options.sharedView;if(!this.sharedView.isNew()){this.selectedShareGroup=this.sharedView.shareGroup()}else{this.selectedShareGroup=null}this.errors=[];this.validations={"#shared_view_title":{type:"presence",message:Globalize.localize("You must enter a title")},"#shared_view_description":{type:"length",max:4e3,message:Globalize.localize("Please enter a description less than 4000 characters")},"#shared_view_password":{type:"length",min:4,max:35,message:Globalize.localize("Please enter a password between 4 and 35 characters"),"if":function(){return $("#edit_shared_view_attrs .share-option-list").hasClass("share-group-password")}}};_.bindAll(this,"_onSelectShareGroup","_onShowUpgradeDialog","_onShareOptionChange","_onSharedViewLinkClick","_setClipboardText","_onBackClick","_onSaveClick","_onCancelClick","_onCopyClick","_onPreviewClick","_onCustomizeClick","_onCustomizeMenuActionSelected","_onCustomizeSaveClick","_onCustomizeCancelClick")},__beforeRender:function(){var sharedView=this.sharedView,isNew=sharedView.isNew(),shareGroup=sharedView.shareGroup();if(isNew){shareGroup=null}if(!sharedView.canCustomizeBranding()){sharedView.setBranding("none",false)}return{sharedView:sharedView,shareGroup:shareGroup,isSharedPublic:shareGroup===sharedView.GROUP_SETTINGS.publicShare,isSharedLink:shareGroup===sharedView.GROUP_SETTINGS.linkShare,isSharedPassword:shareGroup===sharedView.GROUP_SETTINGS.passwordShare,isSharedEnterprise:shareGroup===sharedView.GROUP_SETTINGS.enterpriseShare,title:$("<div></div>").html(sharedView.title).text(),hideOpenEnded:sharedView.hideOpenEnded(),hasCustomTitle:sharedView.hasCustomTitle(),hasCustomName:sharedView.hasCustomTitle(),hasDescription:sharedView.hasDescription(),hasPassword:sharedView.hasPassword(),canHavePassword:sharedView.canHavePassword(),browseTabEnabled:sharedView.isBrowseTabEnabled(),trendsTabEnabled:sharedView.isTrendsTabEnabled(),canHaveTrends:sharedView.canHaveTrends(),sharedPageURL:sharedView.sharedPageURL(),userHasTrends:sharedView.survey.owner.hasTrends(),canCustomizeBranding:sharedView.canCustomizeBranding(),hasHiddenBranding:sharedView.hasHiddenBranding()&&sharedView.canCustomizeBranding(),isResearchDomain:this.isResearchDomain(sharedView.get("domain")),canCustomizeDomain:sharedView.canCustomizeDomain(),allowTeamExport:sharedView.allowTeamExport()}},__init:function(){var self=this,$el=self.$el;self.$spinner=$el.find(".sm-spin");self.form=$el.find("form").form({formView:self}).data("form");$el.find("[customize-domain-btn]").actionMenu({menuView:"CustomizeSharedViewHostMenuView",parentEl:$el,sharedView:self.sharedView});$el.on("click",".share-group-list td",self._onSelectShareGroup).on("click",'.upgrade-trigger input[type="checkbox"]',self._onShowUpgradeDialog).on("click",".option-checkbox",self._onShareOptionChange).on("click","[shared-view-link]",self._onSharedViewLinkClick).on("click","[preview-link]",self._onPreviewClick).on("click","[save-btn]",self._onSaveClick).on("click","[copy-btn]",self._onCopyClick).on("click","[back-btn]",self._onBackClick).on("click","[cancel-btn], [close-btn]",self._onCancelClick).on("click","[customize-btn]",self._onCustomizeClick).on("click","[customize-save-btn]",self._onCustomizeSaveClick).on("click","[customize-cancel-btn]",self._onCustomizeCancelClick).on("actionMenu.actionSelected",self._onCustomizeMenuActionSelected);$el.find(".q").popout()},_showUpgradeDialog:function(e,templateID){var upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID}),$formDialog=this.$el.parents(".dialog:eq(0)");$formDialog.fadeOut(250,function(){upgradeDialog.open()});upgradeDialog.$el.on("dialog.afterClose",function(){$formDialog.fadeIn(250)});if($(e.target).attr("data-branding")){e.stopImmediatePropagation();$(e.currentTarget).prop("checked",false)}},_setDefaultsForGroup:function(group){var sharedView=this.sharedView,isSharedEnterprise=group===sharedView.GROUP_SETTINGS.enterpriseShare;sharedView.set("is_public",group===sharedView.GROUP_SETTINGS.publicShare);sharedView.set("has_password",group===sharedView.GROUP_SETTINGS.passwordShare);sharedView.set("team_only_share",isSharedEnterprise);sharedView.set("allow_team_export",isSharedEnterprise&&$("#shared_view_allow_team_export").prop("checked"))},_closeCustomDomainEditor:function(){var self=this,sharedViewLinkContainer=self.$el.find(".shared-view-link-container");if(!sharedViewLinkContainer.hasClass("not-customizing")){self.$el.find("[shared-view-link]").val(self.sharedView.sharedPageURL());sharedViewLinkContainer.addClass("not-customizing")}},setViewLink:function(isViewLink){var self=this,sharedView=self.sharedView;self.$el.toggleClass("view-link",isViewLink);if(isViewLink){self.$el.parent().siblings(".shared_group_upgrade_message").addClass("hide")}self._removeSocialSharingView();if(isViewLink&&!sharedView.isNew()&&sharedView.isSocialShareable()){self._createSocialSharingView()}self.$el.find(".customize-btns").toggleClass("hide",sharedView.isEnterpriseTeam())},isResearchDomain:function(domainString){var researchDomain=this.sharedView.survey.config.research_domain;return domainString===researchDomain},_onSelectShareGroup:function(e){var self=this,$shareOptionList=self.$el.find(".share-option-list"),$shareOptionListContainer=$shareOptionList.parent(),$selectedOpt=$(e.target).closest("td"),selectedGroup=$selectedOpt.attr("data-group"),templateID;e.stopImmediatePropagation();if(self.selectedShareGroup===selectedGroup){return}if($selectedOpt.hasClass("upgrade-trigger")){templateID;if(selectedGroup===self.sharedView.GROUP_SETTINGS.passwordShare){templateID="password-sharing-upgrade-dialog-template"}if(templateID){self._showUpgradeDialog(e,templateID)}return}if(self.selectedShareGroup){$selectedOpt.parent().find("td.selected").removeClass("selected");$shareOptionList.removeClass(self.selectedShareGroup)}else{self.$el.find("[save-btn]").removeClass("disabled")}if(selectedGroup===self.sharedView.GROUP_SETTINGS.enterpriseShare&&$(".share-option-branding").hasClass("hide")){$(".share-option-branding").toggleClass("hide",false)}if(self.selectedShareGroup===self.sharedView.GROUP_SETTINGS.enterpriseShare){self.sharedView.set("domain",self.sharedView.getSelectedDomain());self.$el.find("[shared-view-link]").val(self.sharedView.sharedPageURL());self.sharedView.set("team_only_share",false)}self.selectedShareGroup=selectedGroup;$selectedOpt.addClass("selected");$shareOptionList.addClass(selectedGroup);self._setDefaultsForGroup(selectedGroup);if($shareOptionListContainer.hasClass("hide")){$shareOptionListContainer.removeClass("hide");$(window).trigger("resize")}},_onShowUpgradeDialog:function(e){this._showUpgradeDialog(e,"hide-logo-sharing-upgrade-dialog-template")},_onShareOptionChange:function(e){var $target=$(e.target),isChecked=$target.prop("checked"),sharedView=this.sharedView;switch($target.attr("id")){case"shared_view_modes_trends":case"shared_view_modes_browse":sharedView.toggleMode($target.attr("data-mode"),isChecked);break;case"shared_view_hide_open_ended":sharedView.set("hide_open_ended",!isChecked);break;case"shared_view_allow_team_export":sharedView.set("allow_team_export",isChecked);break;case"shared_view_branding":sharedView.setBranding($target.attr("data-branding"),isChecked);break;default:break}},_onSharedViewLinkClick:function(e){$(e.target).select()},_onSaveClick:function(e){var self=this,sharedView=self.sharedView,uri;e.preventDefault();if(!$(e.target).closest("a").hasClass("disabled")&&self.form.isValid()){if(sharedView.isEnterpriseTeam()){uri=new Uri(document.location.href);sharedView.set("domain",uri.host())}self._save(function(){self.$el.find("[shared-view-link]").val(sharedView.sharedPageURL());self.setViewLink(true)},function(){})}},_onBackClick:function(e){var $el=this.$el;e.preventDefault();this._closeCustomDomainEditor();$el.removeClass("view-link");$el.parent().siblings(".shared_group_upgrade_message").removeClass("hide");$el.find(".twitter-container").empty();$el.find(".facebook-container").empty();$el.find(".google-plus-container").empty();$el.find(".linkedin-container").empty();$(window).trigger("resize")},_onCopyClick:function(e){e.preventDefault();SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")})},_onPreviewClick:function(e){e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onCancelClick:function(e){e.preventDefault();this.dialogView.close()},_onCustomizeClick:function(e){var $el=this.$el,sharedView=this.sharedView;e.preventDefault();if(sharedView.survey.isReadOnly()){return}$el.find("[shared-view-link]").val("");$el.find(".url-host").text(sharedView.get("domain"));$el.find("#share_view_path").text(sharedView.sharedPagePath());$el.find(".shared-view-link-container").removeClass("not-customizing")},_onCustomizeSaveClick:function(e){var self=this,sharedView=self.sharedView,host=self.$el.find(".url-host").text(),isResearchDomain=this.isResearchDomain(host);e.preventDefault();if(sharedView.canCustomizeDomain()){sharedView.set("domain",host);if(isResearchDomain){sharedView.setBranding("none",true);$("#shared_view_branding").prop("checked",true)
}$(".share-option-branding").toggleClass("hide",isResearchDomain);self._save();if(!sharedView.isNew()&&sharedView.isSocialShareable()){self._removeSocialSharingView();self._createSocialSharingView()}}self._closeCustomDomainEditor()},_onCustomizeCancelClick:function(e){e.preventDefault();this._closeCustomDomainEditor()},_onCustomizeMenuActionSelected:function(e){var self=this;e.preventDefault();if(!self.sharedView.canCustomizeDomain()&&e.action==="userCannotCustomize"){self._showUpgradeDialog(e,"white-label-sharing-upgrade-dialog-template")}else{self.$el.find(".url-host").text(e.action)}},_removeSocialSharingView:function(){var self=this;if(self.socialSharingView){self.socialSharingView.destroy();self.$el.find(".social-sharing-buttons-container").remove();self.socialSharingView=null}},_createSocialSharingView:function(){var self=this;self.socialSharingView=SM.Views.create(SM.SocialSharingButtonsView,{dataUrl:self.sharedView.sharedPageURL(),sharedViewTitle:self.sharedView.title})},_save:function(onDone,onFail){var self=this,request;self.$spinner.show();self.sharedView.load(self.form.attrs());SM.Bi.sharedViewSave(this.sharedView);request=this.sharedView.save();$.when(request,{self:this}).done(function(){self.$spinner.hide();if(onDone){onDone()}}).fail(function(){self.$spinner.hide();if(onFail){onFail()}})},_setClipboardText:function(){return this.sharedView.sharedPageURL()}});SM.CustomizeSharedViewHostMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"CustomizeSharedViewHostMenuView",__templateID:"customize-shared-view-host-menu-template",__create:function(options){this.sharedView=options.sharedView},__beforeRender:function(){var uri=new Uri(document.location.href),sharedView=this.sharedView,subdomain=sharedView.getCultureSubdomain(),user=sharedView.survey.owner,userCannotCustomize=!user.canShareCustomizeDomain(),defaultHost,proHost="",proHostData="";if(!userCannotCustomize&&sharedView.groupDomainLinkEnabled()){defaultHost=sharedView.get("domain");proHost=defaultHost;proHostData=user.getEnterpriseGroupDomains()}else if(user.canShareCustomizeDomain()){defaultHost=uri.host();proHost=this.sharedView.survey.config.research_domain;proHostData=userCannotCustomize?"userCannotCustomize":proHost}if(defaultHost.indexOf(subdomain)!==0){defaultHost=defaultHost.split(".");defaultHost[0]=subdomain;defaultHost=defaultHost.join(".")}return{defaultHost:defaultHost,proHost:proHost,proHostData:proHostData,userCannotCustomize:userCannotCustomize,hasDomainOptions:sharedView.groupDomainLinkEnabled()}},__init:function(){SM.ActionMenuView.__init.call(this);this.$el.find(".q").popout()}});SM.SocialSharingButtonsView=SM.Views.register({__NAME:"SocialSharingButtonsView",__templateID:"social-sharing-buttons-template",__create:function(options){this.dataUrl=options.dataUrl;this.sharedViewTitle=options.sharedViewTitle},__beforeRender:function(){return{dataUrl:this.dataUrl,sharedViewTitle:this.sharedViewTitle}},__afterRender:function(){this.loadTwitterShareButton();this.loadFacebookShareButton();this.loadGooglePlusShareButton();this.loadLinkedInShareButton(".linkedin-container");$("#social-sharing-container").append(this.el);try{IN.parse()}catch(e){}},loadTwitterShareButton:function(){try{twttr.widgets.load(this.el)}catch(e){}},loadFacebookShareButton:function(){try{FB.XFBML.parse(this.el)}catch(e){}},loadGooglePlusShareButton:function(){try{gapi.plus.go(this.el)}catch(e){}},loadLinkedInShareButton:function(){var linkedInButton='<script type="IN/Share" ';if(!!this.dataUrl){linkedInButton=linkedInButton+"data-url="+this.dataUrl}linkedInButton=linkedInButton+"></script>";this.$el.find(".linkedin-container").html(linkedInButton)}});SM.PubSub.subscribe("HTTP_CONFLICT",function(){SM.Notifications.success({expires:false,title:Globalize.localize("New version available!"),message:Globalize.localize("Fresher bananas are available, let us reload this page for you...")});setTimeout(function(){location.reload()},5e3)});SM.BaseApp={ERROR_CODES:{MODELS:"1",VIEWS:"2",ROUTERS:"3"},initializers:{beforeInit:[],afterInit:[]},__beforeInit:function(options){var self=this;SM.Error.init();SM.Tooltips.init();SM.Ajax.init(options.version);SM.API.init(options.survey_id);self._renderLoaderView();self._runInitializers("before",options)},__afterInit:function(options){var self=this;self._runInitializers("after",options)},init:function(options){var self=this;SM.App=self;SM.Browser.support.needsBrowserUpgrade();self.el=options.el;self.version=options.version;self.dataURL=self._setDataURL(options.data_url);self.surveyTitle=options.survey_title;self.JClipboardMovieUrl=options.jclipboard_movie_url;self.dfd=$.Deferred();SM.raHeader="A/B Test";self.__beforeInit(options);if(self.dataURL){_.bindAll(this,"_onSuccess","_onFail","_onAlways","_loadData");SM.Ajax.get(self.dataURL).done(self._onSuccess,function(){self.__afterInit(options)}).fail(self._onFail).always(self._onAlways)}else{self._onAlways()}return self.dfd},_buildSurveyModel:function(data,options){var self=this,survey,owner;SM.API.setUser(data.current_user.id);self.setCulture(data.survey_data);survey=SM.Models.create("Survey",{survey_data:data.survey_data,npsEnabled:data.config.nps_enabled,mode:data.analyze_mode,includeOpenEnded:data.include_openended||options.includeOpenEnded});survey.loadAnalyzeState({mode:data.analyze_mode,pageIndex:data.page_index});survey.loadConfig(data.config);survey.loadOwner(data.owner);owner=survey.owner;survey.loadCurrentUser(data.current_user);survey.loadViews({viewMap:data.views,currentViewID:data.current_view_id,defaultViewID:data.default_view_id,selectedViewID:data.selected_view_id});if(options.loadSharedViews){survey.loadSharedViews(data.shared_views)}if(options.loadExportJobs){survey.loadExportJobs(data.exportjob_list)}if(data.respondent_data.status===0){survey.set("respondentCounts",data.respondent_data.data.respondent_counts)}else{survey.set("respondentCounts",{failed:true})}if(survey.state.isBrowseMode()){survey.loadRespondents(data.respondent_data)}else if(survey.state.isSummaryMode()){if(!this.isSharingApp()){if(!data.profiler_data||data.profiler_data.status!==0||(!data.segment_data||data.segment_data.status!==0)){survey.owner.benchmarkingEnabled=false;owner=null}survey.dataSegmentList=SM.Models.create("DataSegmentList",{survey:survey,defaultView:survey.anviews.defaultView,benchmarkQuestions:data.survey_data.benchmark_questions,segmentData:data.segment_data});survey.loadBenchmarkRollups(data.benchmark_data);survey.profiler=SM.Models.create("Profiler",{parent:survey,user:owner,profiler_data:data.profiler_data,basePath:"/analyze",webapp:"anweb",source:"profilerDialog",showHeading:true,disableOrgAC:false,showDefaultCB:false,showOptInCB:true,disableAccordion:true,showQuestionText:false,openIfInvalid:true,hasCollectorProfile:survey.hasProfiledCollector()})}survey.driverState=SM.Models.create("DriverState",{survey:survey,driverState:survey.anviews.defaultView.getDriverState()});if(survey.isTMBCTemplate()){survey.tmbc=SM.Models.create("TMBC",{survey:survey,tmbcData:data.driver_data,wasEdited:!survey.validateTMBCTemplate()})}survey.loadDriverRollups(data.benchmark_data);survey.loadQuestionRollups(data.respondent_data)}else if(survey.state.isTrendMode()){survey.loadSurveyTrends(data.respondent_data)}return survey},_renderLoaderView:function(){var self=this;self._loaderView=SM.Views.create(SM.AnalyzeLoaderView,{isFixed:true});self.el.appendChild(self._loaderView.el);self._loaderView.show()},_setDataURL:function(dataURL){var url=new Uri(dataURL);url.setProtocol("https");url.addQueryParam("utc_offset",SM.Date.utcOffset().toString());url=url.toString();SM.log("data.js URL: "+url);return url},_handleLoadingError:function(options){var html=SM.Template.renderHTML("content-load-error-template",{requestID:options.requestID,errorCode:options.errorCode,classes:"analyze-failed-load mod-no-header"});$(this.el).html(html)},_onSuccess:function(data){this.data=data;this._loadData(data);this.dfd.resolve()},_onFail:function(data){this._handleLoadingError({requestID:data.request_id,encryptedSurveyID:data.survey_id_encryption});this.dfd.reject()},_onAlways:function(){this._loaderView.hide()},_runInitializers:function(stage,options){var initializers;if(_.isEmpty(this.initializers)){return}initializers=this.initializers[stage+"Init"];if(initializers.length){_.each(initializers,function(initializer){initializer.call(this,SM.App,options)})}},isSharingApp:function(){return false},isExportApp:function(){return false},isMerveysApp:function(){return this.survey.isMergedSurvey},isSharingEnabled:function(){return this.survey.isSharingEnabled()&&this.survey.owner.hasSharing()},isDebug:function(){return!!SM.DEBUG},setCulture:function(){var culture=Globalize.getSmartlingCulture();Globalize.culture(culture);Globalize.addCultureInfo(culture,{messages:SM.translations})}};SM.AnalyzeApp=SM.Object.deepExtend(SM.BaseApp,{_loadData:function(data){var self=this;if("is_merge_completed"in data.survey_data&&!data.survey_data.is_merge_completed){window.location.href="/analyze/merve/design-tool/"+data.survey_id_encryption;return}try{self._initConstants(data);self.survey=self.survey=self._buildSurveyModel(data,{includeOpenEnded:true,loadSharedViews:true,loadExportJobs:true})}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.MODELS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to initialize models");return}try{self._initRouters()}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.ROUTERS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to initialize routers");return}try{self._render(self.survey)}catch(e){self.dfd.reject();self._handleLoadingError({errorCode:self.ERROR_CODES.VIEWS,encryptedSurveyID:data.survey_id_encryption});SM.Error.log(e,"AnalyzeApp failed to render");return}try{$(".sidetab").sideTab()}catch(e){self.dfd.reject();SM.Error.log(e,"AnalyzeApp sidetabs/tours failed")}},_initConstants:function(data){SM.DISPLAY_BROWSE_TAB=data.display_browse_tab;SM.DISPLAY_TREND_TAB=data.display_trend_tab},_initRouters:function(){this.SharedViewsRouter=new SM.SharedViewsRouter({survey:this.survey})},_render:function(survey){var profilerDialog;var benchmarkRollups=this.survey.benchmarkRollups;var segmentOverride=benchmarkRollups?benchmarkRollups.getSegmentOverride():"";this._renderMainView(survey);if(segmentOverride==="sm_average_global"&&survey.isProfilerDialogEnabled()){profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"question",triggeredFrom:"question_benchmarking_button"});profilerDialog.open()}},_renderMainView:function(survey){var view=SM.Views.create(SM.AnalyzeMainView,{model:survey});this.el.appendChild(view.el);view=SM.Views.create(SM.AnalyzeSecondaryView,{model:survey});this.el.appendChild(view.el)}});