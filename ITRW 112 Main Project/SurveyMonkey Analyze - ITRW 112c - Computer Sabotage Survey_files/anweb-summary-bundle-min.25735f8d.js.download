(function(){function s(a,b){var c;a||(a={});for(c in b)a[c]=b[c];return a}function w(){var a,b=arguments,c,d={},e=function(a,b){var c,d;typeof a!=="object"&&(a={});for(d in b)b.hasOwnProperty(d)&&(c=b[d],a[d]=c&&typeof c==="object"&&Object.prototype.toString.call(c)!=="[object Array]"&&d!=="renderTo"&&typeof c.nodeType!=="number"?e(a[d]||{},c):b[d]);return a};b[0]===!0&&(d=b[1],b=Array.prototype.slice.call(b,2));c=b.length;for(a=0;a<c;a++)d=e(d,b[a]);return d}function x(a,b){return parseInt(a,b||10)}function ga(a){return typeof a==="string"}function $(a){return typeof a==="object"}function La(a){return Object.prototype.toString.call(a)==="[object Array]"}function ya(a){return typeof a==="number"}function za(a){return T.log(a)/T.LN10}function ha(a){return T.pow(10,a)}function ia(a,b){for(var c=a.length;c--;)if(a[c]===b){a.splice(c,1);break}}function r(a){return a!==u&&a!==null}function z(a,b,c){var d,e;if(ga(b))r(c)?a.setAttribute(b,c):a&&a.getAttribute&&(e=a.getAttribute(b));else if(r(b)&&$(b))for(d in b)a.setAttribute(d,b[d]);return e}function na(a){return La(a)?a:[a]}function o(){var a=arguments,b,c,d=a.length;for(b=0;b<d;b++)if(c=a[b],typeof c!=="undefined"&&c!==null)return c}function D(a,b){if(Aa&&!X&&b&&b.opacity!==u)b.filter="alpha(opacity="+b.opacity*100+")";s(a.style,b)}function V(a,b,c,d,e){a=y.createElement(a);b&&s(a,b);e&&D(a,{padding:0,border:O,margin:0});c&&D(a,c);d&&d.appendChild(a);return a}function ja(a,b){var c=function(){};c.prototype=new a;s(c.prototype,b);return c}function Ga(a,b,c,d){var e=L.lang,a=+a||0,f=b===-1?(a.toString().split(".")[1]||"").length:isNaN(b=N(b))?2:b,b=c===void 0?e.decimalPoint:c,d=d===void 0?e.thousandsSep:d,e=a<0?"-":"",c=String(x(a=N(a).toFixed(f))),g=c.length>3?c.length%3:0;return e+(g?c.substr(0,g)+d:"")+c.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+d)+(f?b+N(a-c).toFixed(f).slice(2):"")}function Ha(a,b){return Array((b||2)+1-String(a).length).join(0)+a}function Ma(a,b,c){var d=a[b];a[b]=function(){var a=Array.prototype.slice.call(arguments);a.unshift(d);return c.apply(this,a)}}function Ia(a,b){for(var c="{",d=!1,e,f,g,h,i,j=[];(c=a.indexOf(c))!==-1;){e=a.slice(0,c);if(d){f=e.split(":");g=f.shift().split(".");i=g.length;e=b;for(h=0;h<i;h++)e=e[g[h]];if(f.length)f=f.join(":"),g=/\.([0-9])/,h=L.lang,i=void 0,/f$/.test(f)?(i=(i=f.match(g))?i[1]:-1,e=Ga(e,i,h.decimalPoint,f.indexOf(",")>-1?h.thousandsSep:"")):e=bb(f,e)}j.push(e);a=a.slice(c+1);c=(d=!d)?"}":"{"}j.push(a);return j.join("")}function mb(a){return T.pow(10,S(T.log(a)/T.LN10))}function nb(a,b,c,d){var e,c=o(c,1);e=a/c;b||(b=[1,2,2.5,5,10],d&&d.allowDecimals===!1&&(c===1?b=[1,2,5,10]:c<=.1&&(b=[1/c])));for(d=0;d<b.length;d++)if(a=b[d],e<=(b[d]+(b[d+1]||b[d]))/2)break;a*=c;return a}function Bb(){this.symbol=this.color=0}function ob(a,b){var c=a.length,d,e;for(e=0;e<c;e++)a[e].ss_i=e;a.sort(function(a,c){d=b(a,c);return d===0?a.ss_i-c.ss_i:d});for(e=0;e<c;e++)delete a[e].ss_i}function Na(a){for(var b=a.length,c=a[0];b--;)a[b]<c&&(c=a[b]);return c}function Ba(a){for(var b=a.length,c=a[0];b--;)a[b]>c&&(c=a[b]);return c}function Oa(a,b){for(var c in a)a[c]&&a[c]!==b&&a[c].destroy&&a[c].destroy(),delete a[c]}function Pa(a){cb||(cb=V(Ja));a&&cb.appendChild(a);cb.innerHTML=""}function oa(a,b){var c="Highcharts error #"+a+": www.highcharts.com/errors/"+a;if(b)throw c;else G.console&&console.log(c)}function aa(a){return parseFloat(a.toPrecision(14))}function Qa(a,b){sa=o(a,b.animation)}function Cb(){var a=L.global.useUTC,b=a?"getUTC":"get",c=a?"setUTC":"set";Ra=(a&&L.global.timezoneOffset||0)*6e4;db=a?Date.UTC:function(a,b,c,g,h,i){return new Date(a,b,o(c,1),o(g,0),o(h,0),o(i,0)).getTime()};pb=b+"Minutes";qb=b+"Hours";rb=b+"Day";Xa=b+"Date";eb=b+"Month";fb=b+"FullYear";Db=c+"Minutes";Eb=c+"Hours";sb=c+"Date";Fb=c+"Month";Gb=c+"FullYear"}function ta(){}function Sa(a,b,c,d){this.axis=a;this.pos=b;this.type=c||"";this.isNew=!0;!c&&!d&&this.addLabel()}function ka(){this.init.apply(this,arguments)}function Ya(){this.init.apply(this,arguments)}function Hb(a,b,c,d,e,f){var g=a.chart.inverted;this.axis=a;this.isNegative=c;this.options=b;this.x=d;this.total=null;this.points={};this.stack=e;this.percent=f==="percent";this.alignOptions={align:b.align||(g?c?"left":"right":"center"),verticalAlign:b.verticalAlign||(g?"middle":c?"bottom":"top"),y:o(b.y,g?4:c?14:-6),x:o(b.x,g?c?-6:6:0)};this.textAlign=b.textAlign||(g?c?"right":"left":"center")}var u,y=document,G=window,T=Math,v=T.round,S=T.floor,Ka=T.ceil,t=T.max,E=T.min,N=T.abs,W=T.cos,ba=T.sin,la=T.PI,Ca=la*2/360,ua=navigator.userAgent,Ib=G.opera,Aa=/msie/i.test(ua)&&!Ib,gb=y.documentMode===8,hb=/AppleWebKit/.test(ua),Ta=/Firefox/.test(ua),Jb=/(Mobile|Android|Windows Phone)/.test(ua),Da="http://www.w3.org/2000/svg",X=!!y.createElementNS&&!!y.createElementNS(Da,"svg").createSVGRect,Ob=Ta&&parseInt(ua.split("Firefox/")[1],10)<4,ca=!X&&!Aa&&!!y.createElement("canvas").getContext,Za,$a,Kb={},tb=0,cb,L,bb,sa,ub,B,Ea=function(){},Y=[],Ja="div",O="none",Pb=/^[0-9]+$/,Lb="stroke-width",db,Ra,pb,qb,rb,Xa,eb,fb,Db,Eb,sb,Fb,Gb,J={},Q=G.Highcharts=G.Highcharts?oa(16,!0):{};bb=function(a,b,c){if(!r(b)||isNaN(b))return"Invalid date";var a=o(a,"%Y-%m-%d %H:%M:%S"),d=new Date(b-Ra),e,f=d[qb](),g=d[rb](),h=d[Xa](),i=d[eb](),j=d[fb](),k=L.lang,l=k.weekdays,d=s({a:l[g].substr(0,3),A:l[g],d:Ha(h),e:h,b:k.shortMonths[i],B:k.months[i],m:Ha(i+1),y:j.toString().substr(2,2),Y:j,H:Ha(f),I:Ha(f%12||12),l:f%12||12,M:Ha(d[pb]()),p:f<12?"AM":"PM",P:f<12?"am":"pm",S:Ha(d.getSeconds()),L:Ha(v(b%1e3),3)},Q.dateFormats);for(e in d)for(;a.indexOf("%"+e)!==-1;)a=a.replace("%"+e,typeof d[e]==="function"?d[e](b):d[e]);return c?a.substr(0,1).toUpperCase()+a.substr(1):a};Bb.prototype={wrapColor:function(a){if(this.color>=a)this.color=0},wrapSymbol:function(a){if(this.symbol>=a)this.symbol=0}};B=function(){for(var a=0,b=arguments,c=b.length,d={};a<c;a++)d[b[a++]]=b[a];return d}("millisecond",1,"second",1e3,"minute",6e4,"hour",36e5,"day",864e5,"week",6048e5,"month",26784e5,"year",31556952e3);ub={init:function(a,b,c){var b=b||"",d=a.shift,e=b.indexOf("C")>-1,f=e?7:3,g,b=b.split(" "),c=[].concat(c),h,i,j=function(a){for(g=a.length;g--;)a[g]==="M"&&a.splice(g+1,0,a[g+1],a[g+2],a[g+1],a[g+2])};e&&(j(b),j(c));a.isArea&&(h=b.splice(b.length-6,6),i=c.splice(c.length-6,6));if(d<=c.length/f&&b.length===c.length)for(;d--;)c=[].concat(c).splice(0,f).concat(c);a.shift=0;if(b.length)for(a=c.length;b.length<a;)d=[].concat(b).splice(b.length-f,f),e&&(d[f-6]=d[f-2],d[f-5]=d[f-1]),b=b.concat(d);h&&(b=b.concat(h),c=c.concat(i));return[b,c]},step:function(a,b,c,d){var e=[],f=a.length;if(c===1)e=d;else if(f===b.length&&c<1)for(;f--;)d=parseFloat(a[f]),e[f]=isNaN(d)?a[f]:c*parseFloat(b[f]-d)+d;else e=b;return e}};(function(a){G.HighchartsAdapter=G.HighchartsAdapter||a&&{init:function(b){var c=a.fx,d=c.step,e,f=a.Tween,g=f&&f.propHooks;e=a.cssHooks.opacity;a.extend(a.easing,{easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c}});a.each(["cur","_default","width","height","opacity"],function(a,b){var e=d,k;b==="cur"?e=c.prototype:b==="_default"&&f&&(e=g[b],b="set");(k=e[b])&&(e[b]=function(c){var d,c=a?c:this;if(c.prop!=="align")return d=c.elem,d.attr?d.attr(c.prop,b==="cur"?u:c.now):k.apply(this,arguments)})});Ma(e,"get",function(a,b,c){return b.attr?b.opacity||0:a.call(this,b,c)});e=function(a){var c=a.elem,d;if(!a.started)d=b.init(c,c.d,c.toD),a.start=d[0],a.end=d[1],a.started=!0;c.attr("d",b.step(a.start,a.end,a.pos,c.toD))};f?g.d={set:e}:d.d=e;this.each=Array.prototype.forEach?function(a,b){return Array.prototype.forEach.call(a,b)}:function(a,b){for(var c=0,d=a.length;c<d;c++)if(b.call(a[c],a[c],c,a)===!1)return c};a.fn.highcharts=function(){var a="Chart",b=arguments,c,d;ga(b[0])&&(a=b[0],b=Array.prototype.slice.call(b,1));c=b[0];if(c!==u)c.chart=c.chart||{},c.chart.renderTo=this[0],new Q[a](c,b[1]),d=this;c===u&&(d=Y[z(this[0],"data-highcharts-chart")]);return d}},getScript:a.getScript,inArray:a.inArray,adapterRun:function(b,c){return a(b)[c]()},grep:a.grep,map:function(a,c){for(var d=[],e=0,f=a.length;e<f;e++)d[e]=c.call(a[e],a[e],e,a);return d},offset:function(b){return a(b).offset()},addEvent:function(b,c,d){a(b).bind(c,d)},removeEvent:function(b,c,d){var e=y.removeEventListener?"removeEventListener":"detachEvent";y[e]&&b&&!b[e]&&(b[e]=function(){});a(b).unbind(c,d)},fireEvent:function(b,c,d,e){var f=a.Event(c),g="detached"+c,h;!Aa&&d&&(delete d.layerX,delete d.layerY);s(f,d);b[c]&&(b[g]=b[c],b[c]=null);a.each(["preventDefault","stopPropagation"],function(a,b){var c=f[b];f[b]=function(){try{c.call(f)}catch(a){b==="preventDefault"&&(h=!0)}}});a(b).trigger(f);b[g]&&(b[c]=b[g],b[g]=null);e&&!f.isDefaultPrevented()&&!h&&e(f)},washMouseEvent:function(a){var c=a.originalEvent||a;if(c.pageX===u)c.pageX=a.pageX,c.pageY=a.pageY;return c},animate:function(b,c,d){var e=a(b);if(!b.style)b.style={};if(c.d)b.toD=c.d,c.d=1;e.stop();c.opacity!==u&&b.attr&&(c.opacity+="px");e.animate(c,d)},stop:function(b){a(b).stop()}}})(G.jQuery);var R=G.HighchartsAdapter,F=R||{};R&&R.init.call(R,ub);var ib=F.adapterRun,Qb=F.getScript,va=F.inArray,p=F.each,vb=F.grep,Rb=F.offset,Ua=F.map,C=F.addEvent,U=F.removeEvent,I=F.fireEvent,Sb=F.washMouseEvent,jb=F.animate,ab=F.stop,F={enabled:!0,x:0,y:15,style:{color:"#666",cursor:"default",fontSize:"11px"}};L={colors:"#2f7ed8,#0d233a,#8bbc21,#910000,#1aadce,#492970,#f28f43,#77a1e5,#c42525,#a6c96a".split(","),symbols:["circle","diamond","square","triangle","triangle-down"],lang:{loading:"Loading...",months:"January,February,March,April,May,June,July,August,September,October,November,December".split(","),shortMonths:"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(","),decimalPoint:".",numericSymbols:"k,M,G,T,P,E".split(","),resetZoom:"Reset zoom",resetZoomTitle:"Reset zoom level 1:1",thousandsSep:","},global:{useUTC:!0,canvasToolsURL:"http://code.highcharts.com/3.0.10/modules/canvas-tools.js",VMLRadialGradientURL:"http://code.highcharts.com/3.0.10/gfx/vml-radial-gradient.png"},chart:{borderColor:"#4572A7",borderRadius:5,defaultSeriesType:"line",ignoreHiddenSeries:!0,spacing:[10,10,15,10],backgroundColor:"#FFFFFF",plotBorderColor:"#C0C0C0",resetZoomButton:{theme:{zIndex:20},position:{align:"right",x:-10,y:10}}},title:{text:"Chart title",align:"center",margin:15,style:{color:"#274b6d",fontSize:"16px"}},subtitle:{text:"",align:"center",style:{color:"#4d759e"}},plotOptions:{line:{allowPointSelect:!1,showCheckbox:!1,animation:{duration:1e3},events:{},lineWidth:2,marker:{enabled:!0,lineWidth:0,radius:4,lineColor:"#FFFFFF",states:{hover:{enabled:!0},select:{fillColor:"#FFFFFF",lineColor:"#000000",lineWidth:2}}},point:{events:{}},dataLabels:w(F,{align:"center",enabled:!1,formatter:function(){return this.y===null?"":Ga(this.y,-1)},verticalAlign:"bottom",y:0}),cropThreshold:300,pointRange:0,states:{hover:{marker:{}},select:{marker:{}}},stickyTracking:!0,turboThreshold:1e3}},labels:{style:{position:"absolute",color:"#3E576F"}},legend:{enabled:!0,align:"center",layout:"horizontal",labelFormatter:function(){return this.name},borderWidth:1,borderColor:"#909090",borderRadius:5,navigation:{activeColor:"#274b6d",inactiveColor:"#CCC"},shadow:!1,itemStyle:{color:"#274b6d",fontSize:"12px"},itemHoverStyle:{color:"#000"},itemHiddenStyle:{color:"#CCC"},itemCheckboxStyle:{position:"absolute",width:"13px",height:"13px"},symbolPadding:5,verticalAlign:"bottom",x:0,y:0,title:{style:{fontWeight:"bold"}}},loading:{labelStyle:{fontWeight:"bold",position:"relative",top:"1em"},style:{position:"absolute",backgroundColor:"white",opacity:.5,textAlign:"center"}},tooltip:{enabled:!0,animation:X,backgroundColor:"rgba(255, 255, 255, .85)",borderWidth:1,borderRadius:3,dateTimeLabelFormats:{millisecond:"%A, %b %e, %H:%M:%S.%L",second:"%A, %b %e, %H:%M:%S",minute:"%A, %b %e, %H:%M",hour:"%A, %b %e, %H:%M",day:"%A, %b %e, %Y",week:"Week from %A, %b %e, %Y",month:"%B %Y",year:"%Y"},headerFormat:'<span style="font-size: 10px">{point.key}</span><br/>',pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',shadow:!0,snap:Jb?25:10,style:{color:"#333333",cursor:"default",fontSize:"12px",padding:"8px",whiteSpace:"nowrap"}},credits:{enabled:!0,text:"Highcharts.com",href:"http://www.highcharts.com",position:{align:"right",x:-10,verticalAlign:"bottom",y:-5},style:{cursor:"pointer",color:"#909090",fontSize:"9px"}}};var Z=L.plotOptions,R=Z.line;Cb();var Tb=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]?(?:\.[0-9]+)?)\s*\)/,Ub=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,Vb=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/,wa=function(a){var b=[],c,d;(function(a){a&&a.stops?d=Ua(a.stops,function(a){return wa(a[1])}):(c=Tb.exec(a))?b=[x(c[1]),x(c[2]),x(c[3]),parseFloat(c[4],10)]:(c=Ub.exec(a))?b=[x(c[1],16),x(c[2],16),x(c[3],16),1]:(c=Vb.exec(a))&&(b=[x(c[1]),x(c[2]),x(c[3]),1])})(a);return{get:function(c){var f;d?(f=w(a),f.stops=[].concat(f.stops),p(d,function(a,b){f.stops[b]=[f.stops[b][0],a.get(c)]})):f=b&&!isNaN(b[0])?c==="rgb"?"rgb("+b[0]+","+b[1]+","+b[2]+")":c==="a"?b[3]:"rgba("+b.join(",")+")":a;return f},brighten:function(a){if(d)p(d,function(b){b.brighten(a)});else if(ya(a)&&a!==0){var c;for(c=0;c<3;c++)b[c]+=x(a*255),b[c]<0&&(b[c]=0),b[c]>255&&(b[c]=255)}return this},rgba:b,setOpacity:function(a){b[3]=a;return this}}};ta.prototype={init:function(a,b){this.element=b==="span"?V(b):y.createElementNS(Da,b);this.renderer=a;this.attrSetters={}},opacity:1,animate:function(a,b,c){b=o(b,sa,!0);ab(this);if(b){b=w(b,{});if(c)b.complete=c;jb(this,a,b)}else this.attr(a),c&&c()},attr:function(a,b){var c,d,e,f,g=this.element,h=g.nodeName.toLowerCase(),i=this.renderer,j,k=this.attrSetters,l=this.shadows,m,n,q=this;ga(a)&&r(b)&&(c=a,a={},a[c]=b);if(ga(a))c=a,h==="circle"?c={x:"cx",y:"cy"}[c]||c:c==="strokeWidth"&&(c="stroke-width"),q=z(g,c)||this[c]||0,c!=="d"&&c!=="visibility"&&c!=="fill"&&(q=parseFloat(q));else{for(c in a)if(j=!1,d=a[c],e=k[c]&&k[c].call(this,d,c),e!==!1){e!==u&&(d=e);if(c==="d")d&&d.join&&(d=d.join(" ")),/(NaN| {2}|^$)/.test(d)&&(d="M 0 0");else if(c==="x"&&h==="text")for(e=0;e<g.childNodes.length;e++)f=g.childNodes[e],z(f,"x")===z(g,"x")&&z(f,"x",d);else if(this.rotation&&(c==="x"||c==="y"))n=!0;else if(c==="fill")d=i.color(d,g,c);else if(h==="circle"&&(c==="x"||c==="y"))c={x:"cx",y:"cy"}[c]||c;else if(h==="rect"&&c==="r")z(g,{rx:d,ry:d}),j=!0;else if(c==="translateX"||c==="translateY"||c==="rotation"||c==="verticalAlign"||c==="scaleX"||c==="scaleY")j=n=!0;else if(c==="stroke")d=i.color(d,g,c);else if(c==="dashstyle")if(c="stroke-dasharray",d=d&&d.toLowerCase(),d==="solid")d=O;else{if(d){d=d.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(e=d.length;e--;)d[e]=x(d[e])*o(a["stroke-width"],this["stroke-width"]);d=d.join(",")}}else if(c==="width")d=x(d);else if(c==="align")c="text-anchor",d={left:"start",center:"middle",right:"end"}[d];else if(c==="title")e=g.getElementsByTagName("title")[0],e||(e=y.createElementNS(Da,"title"),g.appendChild(e)),e.textContent=d;c==="strokeWidth"&&(c="stroke-width");if(c==="stroke-width"||c==="stroke"){this[c]=d;if(this.stroke&&this["stroke-width"])z(g,"stroke",this.stroke),z(g,"stroke-width",this["stroke-width"]),this.hasStroke=!0;else if(c==="stroke-width"&&d===0&&this.hasStroke)g.removeAttribute("stroke"),this.hasStroke=!1;j=!0}this.symbolName&&/^(x|y|width|height|r|start|end|innerR|anchorX|anchorY)/.test(c)&&(m||(this.symbolAttr(a),m=!0),j=!0);if(l&&/^(width|height|visibility|x|y|d|transform|cx|cy|r)$/.test(c))for(e=l.length;e--;)z(l[e],c,c==="height"?t(d-(l[e].cutHeight||0),0):d);if((c==="width"||c==="height")&&h==="rect"&&d<0)d=0;this[c]=d;if(c==="text"){if(d!==this.textStr)delete this.bBox,this.textStr=d,this.added&&i.buildText(this)}else j||d!==void 0&&g.setAttribute(c,d)}n&&this.updateTransform()}return q},addClass:function(a){var b=this.element,c=z(b,"class")||"";c.indexOf(a)===-1&&z(b,"class",c+" "+a);return this},symbolAttr:function(a){var b=this;p("x,y,r,start,end,width,height,innerR,anchorX,anchorY".split(","),function(c){b[c]=o(a[c],b[c])});b.attr({d:b.renderer.symbols[b.symbolName](b.x,b.y,b.width,b.height,b)})},clip:function(a){return this.attr("clip-path",a?"url("+this.renderer.url+"#"+a.id+")":O)},crisp:function(a){var b,c={},d,e=a.strokeWidth||this.strokeWidth||this.attr&&this.attr("stroke-width")||0;d=v(e)%2/2;a.x=S(a.x||this.x||0)+d;a.y=S(a.y||this.y||0)+d;a.width=S((a.width||this.width||0)-2*d);a.height=S((a.height||this.height||0)-2*d);a.strokeWidth=e;for(b in a)this[b]!==a[b]&&(this[b]=c[b]=a[b]);return c},css:function(a){var b=this.styles,c={},d=this.element,e,f,g="";e=!b;if(a&&a.color)a.fill=a.color;if(b)for(f in a)a[f]!==b[f]&&(c[f]=a[f],e=!0);if(e){e=this.textWidth=a&&a.width&&d.nodeName.toLowerCase()==="text"&&x(a.width);b&&(a=s(b,c));this.styles=a;e&&(ca||!X&&this.renderer.forExport)&&delete a.width;if(Aa&&!X)D(this.element,a);else{b=function(a,b){return"-"+b.toLowerCase()};for(f in a)g+=f.replace(/([A-Z])/g,b)+":"+a[f]+";";z(d,"style",g)}e&&this.added&&this.renderer.buildText(this)}return this},on:function(a,b){var c=this,d=c.element;$a&&a==="click"?(d.ontouchstart=function(a){c.touchEventFired=Date.now();a.preventDefault();b.call(d,a)},d.onclick=function(a){(ua.indexOf("Android")===-1||Date.now()-(c.touchEventFired||0)>1100)&&b.call(d,a)}):d["on"+a]=b;return this},setRadialReference:function(a){this.element.radialReference=a;return this},translate:function(a,b){return this.attr({translateX:a,translateY:b})},invert:function(){this.inverted=!0;this.updateTransform();return this},updateTransform:function(){var a=this.translateX||0,b=this.translateY||0,c=this.scaleX,d=this.scaleY,e=this.inverted,f=this.rotation;e&&(a+=this.attr("width"),b+=this.attr("height"));a=["translate("+a+","+b+")"];e?a.push("rotate(90) scale(-1,1)"):f&&a.push("rotate("+f+" "+(this.x||0)+" "+(this.y||0)+")");(r(c)||r(d))&&a.push("scale("+o(c,1)+" "+o(d,1)+")");a.length&&z(this.element,"transform",a.join(" "))},toFront:function(){var a=this.element;a.parentNode.appendChild(a);return this},align:function(a,b,c){var d,e,f,g,h={};e=this.renderer;f=e.alignedObjects;if(a){if(this.alignOptions=a,this.alignByTranslate=b,!c||ga(c))this.alignTo=d=c||"renderer",ia(f,this),f.push(this),c=null}else a=this.alignOptions,b=this.alignByTranslate,d=this.alignTo;c=o(c,e[d],e);d=a.align;e=a.verticalAlign;f=(c.x||0)+(a.x||0);g=(c.y||0)+(a.y||0);if(d==="right"||d==="center")f+=(c.width-(a.width||0))/{right:1,center:2}[d];h[b?"translateX":"x"]=v(f);if(e==="bottom"||e==="middle")g+=(c.height-(a.height||0))/({bottom:1,middle:2}[e]||1);h[b?"translateY":"y"]=v(g);this[this.placed?"animate":"attr"](h);this.placed=!0;this.alignAttr=h;return this},getBBox:function(){var a=this.bBox,b=this.renderer,c,d,e=this.rotation;c=this.element;var f=this.styles,g=e*Ca;d=this.textStr;var h;if(d===""||Pb.test(d))h=d.toString().length+(f?"|"+f.fontSize+"|"+f.fontFamily:""),a=b.cache[h];if(!a){if(c.namespaceURI===Da||b.forExport){try{a=c.getBBox?s({},c.getBBox()):{width:c.offsetWidth,height:c.offsetHeight}}catch(i){}if(!a||a.width<0)a={width:0,height:0}}else a=this.htmlGetBBox();if(b.isSVG){c=a.width;d=a.height;if(Aa&&f&&f.fontSize==="11px"&&d.toPrecision(3)==="16.9")a.height=d=14;if(e)a.width=N(d*ba(g))+N(c*W(g)),a.height=N(d*W(g))+N(c*ba(g))}this.bBox=a;h&&(b.cache[h]=a)}return a},show:function(a){return this.attr({visibility:a?"inherit":"visible"})},hide:function(){return this.attr({visibility:"hidden"})},fadeOut:function(a){var b=this;b.animate({opacity:0},{duration:a||150,complete:function(){b.hide()}})},add:function(a){var b=this.renderer,c=a||b,d=c.element||b.box,e=this.element,f=this.zIndex,g,h;if(a)this.parentGroup=a;this.parentInverted=a&&a.inverted;this.textStr!==void 0&&b.buildText(this);if(f)c.handleZ=!0,f=x(f);if(c.handleZ){a=d.childNodes;for(g=0;g<a.length;g++)if(b=a[g],c=z(b,"zIndex"),b!==e&&(x(c)>f||!r(f)&&r(c))){d.insertBefore(e,b);h=!0;break}}h||d.appendChild(e);this.added=!0;if(this.onAdd)this.onAdd();return this},safeRemoveChild:function(a){var b=a.parentNode;b&&b.removeChild(a)},destroy:function(){var a=this,b=a.element||{},c=a.shadows,d=a.renderer.isSVG&&b.nodeName==="SPAN"&&a.parentGroup,e,f;b.onclick=b.onmouseout=b.onmouseover=b.onmousemove=b.point=null;ab(a);if(a.clipPath)a.clipPath=a.clipPath.destroy();if(a.stops){for(f=0;f<a.stops.length;f++)a.stops[f]=a.stops[f].destroy();a.stops=null}a.safeRemoveChild(b);for(c&&p(c,function(b){a.safeRemoveChild(b)});d&&d.div.childNodes.length===0;)b=d.parentGroup,a.safeRemoveChild(d.div),delete d.div,d=b;a.alignTo&&ia(a.renderer.alignedObjects,a);for(e in a)delete a[e];return null},shadow:function(a,b,c){var d=[],e,f,g=this.element,h,i,j,k;if(a){i=o(a.width,3);j=(a.opacity||.15)/i;k=this.parentInverted?"(-1,-1)":"("+o(a.offsetX,1)+", "+o(a.offsetY,1)+")";for(e=1;e<=i;e++){f=g.cloneNode(0);h=i*2+1-2*e;z(f,{isShadow:"true",stroke:a.color||"black","stroke-opacity":j*e,"stroke-width":h,transform:"translate"+k,fill:O});if(c)z(f,"height",t(z(f,"height")-h,0)),f.cutHeight=h;b?b.element.appendChild(f):g.parentNode.insertBefore(f,g);d.push(f)}this.shadows=d}return this}};var pa=function(){this.init.apply(this,arguments)};pa.prototype={Element:ta,init:function(a,b,c,d,e){var f=location,g,d=this.createElement("svg").attr({version:"1.1"}).css(this.getStyle(d));g=d.element;a.appendChild(g);a.innerHTML.indexOf("xmlns")===-1&&z(g,"xmlns",Da);this.isSVG=!0;this.box=g;this.boxWrapper=d;this.alignedObjects=[];this.url=(Ta||hb)&&y.getElementsByTagName("base").length?f.href.replace(/#.*?$/,"").replace(/([\('\)])/g,"\\$1").replace(/ /g,"%20"):"";this.createElement("desc").add().element.appendChild(y.createTextNode("Created with Highcharts 3.0.10"));this.defs=this.createElement("defs").add();this.forExport=e;this.gradients={};this.cache={};this.setSize(b,c,!1);var h;if(Ta&&a.getBoundingClientRect)this.subPixelFix=b=function(){D(a,{left:0,top:0});h=a.getBoundingClientRect();D(a,{left:Ka(h.left)-h.left+"px",top:Ka(h.top)-h.top+"px"})},b(),C(G,"resize",b)},getStyle:function(a){return this.style=s({fontFamily:'"Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif',fontSize:"12px"},a)},isHidden:function(){return!this.boxWrapper.getBBox().width},destroy:function(){var a=this.defs;this.box=null;this.boxWrapper=this.boxWrapper.destroy();Oa(this.gradients||{});this.gradients=null;if(a)this.defs=a.destroy();this.subPixelFix&&U(G,"resize",this.subPixelFix);return this.alignedObjects=null},createElement:function(a){var b=new this.Element;b.init(this,a);return b},draw:function(){},buildText:function(a){for(var b=a.element,c=this,d=c.forExport,e=o(a.textStr,"").toString().replace(/<(b|strong)>/g,'<span style="font-weight:bold">').replace(/<(i|em)>/g,'<span style="font-style:italic">').replace(/<a/g,"<span").replace(/<\/(b|strong|i|em|a)>/g,"</span>").split(/<br.*?>/g),f=b.childNodes,g=/<.*style="([^"]+)".*>/,h=/<.*href="(http[^"]+)".*>/,i=z(b,"x"),j=a.styles,k=a.textWidth,l=j&&j.lineHeight,m=f.length,n=function(a){return l?x(l):c.fontMetrics(/(px|em)$/.test(a&&a.style.fontSize)?a.style.fontSize:j.fontSize||11).h};m--;)b.removeChild(f[m]);k&&!a.added&&this.box.appendChild(b);e[e.length-1]===""&&e.pop();p(e,function(e,f){var l,m=0,e=e.replace(/<span/g,"|||<span").replace(/<\/span>/g,"</span>|||");l=e.split("|||");p(l,function(e){if(e!==""||l.length===1){var q={},o=y.createElementNS(Da,"tspan"),p;g.test(e)&&(p=e.match(g)[1].replace(/(;| |^)color([ :])/,"$1fill$2"),z(o,"style",p));h.test(e)&&!d&&(z(o,"onclick",'location.href="'+e.match(h)[1]+'"'),D(o,{cursor:"pointer"}));e=(e.replace(/<(.|\n)*?>/g,"")||" ").replace(/&lt;/g,"<").replace(/&gt;/g,">");if(e!==" "&&(o.appendChild(y.createTextNode(e)),m?q.dx=0:q.x=i,z(o,q),!m&&f&&(!X&&d&&D(o,{display:"block"}),z(o,"dy",n(o),hb&&o.offsetHeight)),b.appendChild(o),m++,k))for(var e=e.replace(/([^\^])-/g,"$1- ").split(" "),q=e.length>1&&j.whiteSpace!=="nowrap",r,t,s=a._clipHeight,A=[],v=n(),u=1;q&&(e.length||A.length);)delete a.bBox,r=a.getBBox(),t=r.width,!X&&c.forExport&&(t=c.measureSpanWidth(o.firstChild.data,a.styles)),r=t>k,!r||e.length===1?(e=A,A=[],e.length&&(u++,s&&u*v>s?(e=["..."],a.attr("title",a.textStr)):(o=y.createElementNS(Da,"tspan"),z(o,{dy:v,x:i}),p&&z(o,"style",p),b.appendChild(o),t>k&&(k=t)))):(o.removeChild(o.firstChild),A.unshift(e.pop())),e.length&&o.appendChild(y.createTextNode(e.join(" ").replace(/- /g,"-")))}})})},button:function(a,b,c,d,e,f,g,h,i){var j=this.label(a,b,c,i,null,null,null,null,"button"),k=0,l,m,n,q,o,p,a={x1:0,y1:0,x2:0,y2:1},e=w({"stroke-width":1,stroke:"#CCCCCC",fill:{linearGradient:a,stops:[[0,"#FEFEFE"],[1,"#F6F6F6"]]},r:2,padding:5,style:{color:"black"}},e);n=e.style;delete e.style;f=w(e,{stroke:"#68A",fill:{linearGradient:a,stops:[[0,"#FFF"],[1,"#ACF"]]}},f);q=f.style;delete f.style;g=w(e,{stroke:"#68A",fill:{linearGradient:a,stops:[[0,"#9BD"],[1,"#CDF"]]}},g);o=g.style;delete g.style;h=w(e,{style:{color:"#CCC"}},h);p=h.style;delete h.style;C(j.element,Aa?"mouseover":"mouseenter",function(){k!==3&&j.attr(f).css(q)});C(j.element,Aa?"mouseout":"mouseleave",function(){k!==3&&(l=[e,f,g][k],m=[n,q,o][k],j.attr(l).css(m))});j.setState=function(a){(j.state=k=a)?a===2?j.attr(g).css(o):a===3&&j.attr(h).css(p):j.attr(e).css(n)};return j.on("click",function(){k!==3&&d.call(j)}).attr(e).css(s({cursor:"default"},n))},crispLine:function(a,b){a[1]===a[4]&&(a[1]=a[4]=v(a[1])-b%2/2);a[2]===a[5]&&(a[2]=a[5]=v(a[2])+b%2/2);return a},path:function(a){var b={fill:O};La(a)?b.d=a:$(a)&&s(b,a);return this.createElement("path").attr(b)},circle:function(a,b,c){a=$(a)?a:{x:a,y:b,r:c};return this.createElement("circle").attr(a)},arc:function(a,b,c,d,e,f){if($(a))b=a.y,c=a.r,d=a.innerR,e=a.start,f=a.end,a=a.x;a=this.symbol("arc",a||0,b||0,c||0,c||0,{innerR:d||0,start:e||0,end:f||0});a.r=c;return a},rect:function(a,b,c,d,e,f){var e=$(a)?a.r:e,g=this.createElement("rect"),a=$(a)?a:a===u?{}:{x:a,y:b,width:t(c,0),height:t(d,0)};if(f!==u)a.strokeWidth=f,a=g.crisp(a);if(e)a.r=e;return g.attr(a)},setSize:function(a,b,c){var d=this.alignedObjects,e=d.length;this.width=a;this.height=b;for(this.boxWrapper[o(c,!0)?"animate":"attr"]({width:a,height:b});e--;)d[e].align()},g:function(a){var b=this.createElement("g");return r(a)?b.attr({"class":"highcharts-"+a}):b},image:function(a,b,c,d,e){var f={preserveAspectRatio:O};arguments.length>1&&s(f,{x:b,y:c,width:d,height:e});f=this.createElement("image").attr(f);f.element.setAttributeNS?f.element.setAttributeNS("http://www.w3.org/1999/xlink","href",a):f.element.setAttribute("hc-svg-href",a);return f},symbol:function(a,b,c,d,e,f){var g,h=this.symbols[a],h=h&&h(v(b),v(c),d,e,f),i=/^url\((.*?)\)$/,j,k;if(h)g=this.path(h),s(g,{symbolName:a,x:b,y:c,width:d,height:e}),f&&s(g,f);else if(i.test(a))k=function(a,b){a.element&&(a.attr({width:b[0],height:b[1]}),a.alignByTranslate||a.translate(v((d-b[0])/2),v((e-b[1])/2)))},j=a.match(i)[1],a=Kb[j],g=this.image(j).attr({x:b,y:c}),g.isImg=!0,a?k(g,a):(g.attr({width:0,height:0}),V("img",{onload:function(){k(g,Kb[j]=[this.width,this.height])},src:j}));return g},symbols:{circle:function(a,b,c,d){var e=.166*c;return["M",a+c/2,b,"C",a+c+e,b,a+c+e,b+d,a+c/2,b+d,"C",a-e,b+d,a-e,b,a+c/2,b,"Z"]},square:function(a,b,c,d){return["M",a,b,"L",a+c,b,a+c,b+d,a,b+d,"Z"]},triangle:function(a,b,c,d){return["M",a+c/2,b,"L",a+c,b+d,a,b+d,"Z"]},"triangle-down":function(a,b,c,d){return["M",a,b,"L",a+c,b,a+c/2,b+d,"Z"]},diamond:function(a,b,c,d){return["M",a+c/2,b,"L",a+c,b+d/2,a+c/2,b+d,a,b+d/2,"Z"]},arc:function(a,b,c,d,e){var f=e.start,c=e.r||c||d,g=e.end-.001,d=e.innerR,h=e.open,i=W(f),j=ba(f),k=W(g),g=ba(g),e=e.end-f<la?0:1;return["M",a+c*i,b+c*j,"A",c,c,0,e,1,a+c*k,b+c*g,h?"M":"L",a+d*k,b+d*g,"A",d,d,0,e,0,a+d*i,b+d*j,h?"":"Z"]}},clipRect:function(a,b,c,d){var e="highcharts-"+tb++,f=this.createElement("clipPath").attr({id:e}).add(this.defs),a=this.rect(a,b,c,d,0).add(f);a.id=e;a.clipPath=f;return a},color:function(a,b,c){var d=this,e,f=/^rgba/,g,h,i,j,k,l,m,n=[];a&&a.linearGradient?g="linearGradient":a&&a.radialGradient&&(g="radialGradient");if(g){c=a[g];h=d.gradients;j=a.stops;b=b.radialReference;La(c)&&(a[g]=c={x1:c[0],y1:c[1],x2:c[2],y2:c[3],gradientUnits:"userSpaceOnUse"});g==="radialGradient"&&b&&!r(c.gradientUnits)&&(c=w(c,{cx:b[0]-b[2]/2+c.cx*b[2],cy:b[1]-b[2]/2+c.cy*b[2],r:c.r*b[2],gradientUnits:"userSpaceOnUse"}));for(m in c)m!=="id"&&n.push(m,c[m]);for(m in j)n.push(j[m]);n=n.join(",");h[n]?a=h[n].id:(c.id=a="highcharts-"+tb++,h[n]=i=d.createElement(g).attr(c).add(d.defs),i.stops=[],p(j,function(a){f.test(a[1])?(e=wa(a[1]),k=e.get("rgb"),l=e.get("a")):(k=a[1],l=1);a=d.createElement("stop").attr({offset:a[0],"stop-color":k,"stop-opacity":l}).add(i);i.stops.push(a)}));return"url("+d.url+"#"+a+")"}else return f.test(a)?(e=wa(a),z(b,c+"-opacity",e.get("a")),e.get("rgb")):(b.removeAttribute(c+"-opacity"),a)},text:function(a,b,c,d){var e=ca||!X&&this.forExport;if(d&&!this.forExport)return this.html(a,b,c);b=v(o(b,0));c=v(o(c,0));a=this.createElement("text").attr({x:b,y:c,text:a});e&&a.css({position:"absolute"});a.x=b;a.y=c;return a},fontMetrics:function(a){var a=a||this.style.fontSize,a=/px/.test(a)?x(a):/em/.test(a)?parseFloat(a)*12:12,a=a<24?a+4:v(a*1.2),b=v(a*.8);return{h:a,b:b}},label:function(a,b,c,d,e,f,g,h,i){function j(){var a,b;a=q.element.style;K=(Va===void 0||wb===void 0||n.styles.textAlign)&&q.textStr&&q.getBBox();n.width=(Va||K.width||0)+2*P+kb;n.height=(wb||K.height||0)+2*P;xa=P+m.fontMetrics(a&&a.fontSize).b;if(y){if(!o)a=v(-t*P),b=h?-xa:0,n.box=o=d?m.symbol(d,a,b,n.width,n.height,A):m.rect(a,b,n.width,n.height,0,A[Lb]),o.attr("fill",O).add(n);o.isImg||o.attr(w({width:n.width,height:n.height},A));A=null}}function k(){var a=n.styles,a=a&&a.textAlign,b=kb+P*(1-t),c;c=h?0:xa;if(r(Va)&&K&&(a==="center"||a==="right"))b+={center:.5,right:1}[a]*(Va-K.width);(b!==q.x||c!==q.y)&&q.attr({x:b,y:c});q.x=b;q.y=c}function l(a,b){o?o.attr(a,b):A[a]=b}var m=this,n=m.g(i),q=m.text("",0,0,g).attr({zIndex:1}),o,K,t=0,P=3,kb=0,Va,wb,xb,yb,H=0,A={},xa,g=n.attrSetters,y;n.onAdd=function(){q.add(n);n.attr({text:a,x:b,y:c});o&&r(e)&&n.attr({anchorX:e,anchorY:f})};g.width=function(a){Va=a;return!1};g.height=function(a){wb=a;return!1};g.padding=function(a){r(a)&&a!==P&&(P=a,k());return!1};g.paddingLeft=function(a){r(a)&&a!==kb&&(kb=a,k());return!1};g.align=function(a){t={left:0,center:.5,right:1}[a];return!1};g.text=function(a,b){q.attr(b,a);j();k();return!1};g[Lb]=function(a,b){a&&(y=!0);H=a%2/2;l(b,a);return!1};g.stroke=g.fill=g.r=function(a,b){b==="fill"&&a&&(y=!0);l(b,a);return!1};g.anchorX=function(a,b){e=a;l(b,a+H-xb);return!1};g.anchorY=function(a,b){f=a;l(b,a-yb);return!1};g.x=function(a){n.x=a;a-=t*((Va||K.width)+P);xb=v(a);n.attr("translateX",xb);return!1};g.y=function(a){yb=n.y=v(a);n.attr("translateY",yb);return!1};var x=n.css;return s(n,{css:function(a){if(a){var b={},a=w(a);p("fontSize,fontWeight,fontFamily,color,lineHeight,width,textDecoration,textShadow".split(","),function(c){a[c]!==u&&(b[c]=a[c],delete a[c])});q.css(b)}return x.call(n,a)},getBBox:function(){return{width:K.width+2*P,height:K.height+2*P,x:K.x-P,y:K.y-P}},shadow:function(a){o&&o.shadow(a);return n},destroy:function(){U(n.element,"mouseenter");U(n.element,"mouseleave");q&&(q=q.destroy());o&&(o=o.destroy());ta.prototype.destroy.call(n);n=m=j=k=l=null}})}};Za=pa;s(ta.prototype,{htmlCss:function(a){var b=this.element;if(b=a&&b.tagName==="SPAN"&&a.width)delete a.width,this.textWidth=b,this.updateTransform();this.styles=s(this.styles,a);D(this.element,a);return this},htmlGetBBox:function(){var a=this.element,b=this.bBox;if(!b){if(a.nodeName==="text")a.style.position="absolute";b=this.bBox={x:a.offsetLeft,y:a.offsetTop,width:a.offsetWidth,height:a.offsetHeight}}return b},htmlUpdateTransform:function(){if(this.added){var a=this.renderer,b=this.element,c=this.translateX||0,d=this.translateY||0,e=this.x||0,f=this.y||0,g=this.textAlign||"left",h={left:0,center:.5,right:1}[g],i=this.shadows;
D(b,{marginLeft:c,marginTop:d});i&&p(i,function(a){D(a,{marginLeft:c+1,marginTop:d+1})});this.inverted&&p(b.childNodes,function(c){a.invertChild(c,b)});if(b.tagName==="SPAN"){var j=this.rotation,k,l=x(this.textWidth),m=[j,g,b.innerHTML,this.textWidth].join(",");if(m!==this.cTT){k=a.fontMetrics(b.style.fontSize).b;r(j)&&this.setSpanRotation(j,h,k);i=o(this.elemWidth,b.offsetWidth);if(i>l&&/[ \-]/.test(b.textContent||b.innerText))D(b,{width:l+"px",display:"block",whiteSpace:"normal"}),i=l;this.getSpanCorrection(i,k,h,j,g)}D(b,{left:e+(this.xCorr||0)+"px",top:f+(this.yCorr||0)+"px"});if(hb)k=b.offsetHeight;this.cTT=m}}else this.alignOnAdd=!0},setSpanRotation:function(a,b,c){var d={},e=Aa?"-ms-transform":hb?"-webkit-transform":Ta?"MozTransform":Ib?"-o-transform":"";d[e]=d.transform="rotate("+a+"deg)";d[e+(Ta?"Origin":"-origin")]=d.transformOrigin=b*100+"% "+c+"px";D(this.element,d)},getSpanCorrection:function(a,b,c){this.xCorr=-a*c;this.yCorr=-b}});s(pa.prototype,{html:function(a,b,c){var d=this.createElement("span"),e=d.attrSetters,f=d.element,g=d.renderer;e.text=function(a){a!==f.innerHTML&&delete this.bBox;f.innerHTML=this.textStr=a;return!1};e.x=e.y=e.align=e.rotation=function(a,b){b==="align"&&(b="textAlign");d[b]=a;d.htmlUpdateTransform();return!1};d.attr({text:a,x:v(b),y:v(c)}).css({position:"absolute",whiteSpace:"nowrap",fontFamily:this.style.fontFamily,fontSize:this.style.fontSize});d.css=d.htmlCss;if(g.isSVG)d.add=function(a){var b,c=g.box.parentNode,e=[];if(this.parentGroup=a){if(b=a.div,!b){for(;a;)e.push(a),a=a.parentGroup;p(e.reverse(),function(a){var d;b=a.div=a.div||V(Ja,{className:z(a.element,"class")},{position:"absolute",left:(a.translateX||0)+"px",top:(a.translateY||0)+"px"},b||c);d=b.style;s(a.attrSetters,{translateX:function(a){d.left=a+"px"},translateY:function(a){d.top=a+"px"},visibility:function(a,b){d[b]=a}})})}}else b=c;b.appendChild(f);d.added=!0;d.alignOnAdd&&d.htmlUpdateTransform();return d};return d}});var da;if(!X&&!ca){Q.VMLElement=da={init:function(a,b){var c=["<",b,' filled="f" stroked="f"'],d=["position: ","absolute",";"],e=b===Ja;(b==="shape"||e)&&d.push("left:0;top:0;width:1px;height:1px;");d.push("visibility: ",e?"hidden":"visible");c.push(' style="',d.join(""),'"/>');if(b)c=e||b==="span"||b==="img"?c.join(""):a.prepVML(c),this.element=V(c);this.renderer=a;this.attrSetters={}},add:function(a){var b=this.renderer,c=this.element,d=b.box,d=a?a.element||a:d;a&&a.inverted&&b.invertChild(c,d);d.appendChild(c);this.added=!0;this.alignOnAdd&&!this.deferUpdateTransform&&this.updateTransform();if(this.onAdd)this.onAdd();return this},updateTransform:ta.prototype.htmlUpdateTransform,setSpanRotation:function(){var a=this.rotation,b=W(a*Ca),c=ba(a*Ca);D(this.element,{filter:a?["progid:DXImageTransform.Microsoft.Matrix(M11=",b,", M12=",-c,", M21=",c,", M22=",b,", sizingMethod='auto expand')"].join(""):O})},getSpanCorrection:function(a,b,c,d,e){var f=d?W(d*Ca):1,g=d?ba(d*Ca):0,h=o(this.elemHeight,this.element.offsetHeight),i;this.xCorr=f<0&&-a;this.yCorr=g<0&&-h;i=f*g<0;this.xCorr+=g*b*(i?1-c:c);this.yCorr-=f*b*(d?i?c:1-c:1);e&&e!=="left"&&(this.xCorr-=a*c*(f<0?-1:1),d&&(this.yCorr-=h*c*(g<0?-1:1)),D(this.element,{textAlign:e}))},pathToVML:function(a){for(var b=a.length,c=[];b--;)if(ya(a[b]))c[b]=v(a[b]*10)-5;else if(a[b]==="Z")c[b]="x";else if(c[b]=a[b],a.isArc&&(a[b]==="wa"||a[b]==="at"))c[b+5]===c[b+7]&&(c[b+7]+=a[b+7]>a[b+5]?1:-1),c[b+6]===c[b+8]&&(c[b+8]+=a[b+8]>a[b+6]?1:-1);return c.join(" ")||"x"},attr:function(a,b){var c,d,e,f=this.element||{},g=f.style,h=f.nodeName,i=this.renderer,j=this.symbolName,k,l=this.shadows,m,n=this.attrSetters,q=this;ga(a)&&r(b)&&(c=a,a={},a[c]=b);if(ga(a))c=a,q=c==="strokeWidth"||c==="stroke-width"?this.strokeweight:this[c];else for(c in a)if(d=a[c],m=!1,e=n[c]&&n[c].call(this,d,c),e!==!1&&d!==null){e!==u&&(d=e);if(j&&/^(x|y|r|start|end|width|height|innerR|anchorX|anchorY)/.test(c))k||(this.symbolAttr(a),k=!0),m=!0;else if(c==="d"){d=d||[];this.d=d.join(" ");f.path=d=this.pathToVML(d);if(l)for(e=l.length;e--;)l[e].path=l[e].cutOff?this.cutOffPath(d,l[e].cutOff):d;m=!0}else if(c==="visibility"){d==="inherit"&&(d="visible");if(l)for(e=l.length;e--;)l[e].style[c]=d;h==="DIV"&&(d=d==="hidden"?"-999em":0,gb||(g[c]=d?"visible":"hidden"),c="top");g[c]=d;m=!0}else if(c==="zIndex")d&&(g[c]=d),m=!0;else if(va(c,["x","y","width","height"])!==-1)this[c]=d,c==="x"||c==="y"?c={x:"left",y:"top"}[c]:d=t(0,d),this.updateClipping?(this[c]=d,this.updateClipping()):g[c]=d,m=!0;else if(c==="class"&&h==="DIV")f.className=d;else if(c==="stroke")d=i.color(d,f,c),c="strokecolor";else if(c==="stroke-width"||c==="strokeWidth")f.stroked=d?!0:!1,c="strokeweight",this[c]=d,ya(d)&&(d+="px");else if(c==="dashstyle")(f.getElementsByTagName("stroke")[0]||V(i.prepVML(["<stroke/>"]),null,null,f))[c]=d||"solid",this.dashstyle=d,m=!0;else if(c==="fill")if(h==="SPAN")g.color=d;else{if(h!=="IMG")f.filled=d!==O?!0:!1,d=i.color(d,f,c,this),c="fillcolor"}else if(c==="opacity")m=!0;else if(h==="shape"&&c==="rotation")this[c]=f.style[c]=d,f.style.left=-v(ba(d*Ca)+1)+"px",f.style.top=v(W(d*Ca))+"px";else if(c==="translateX"||c==="translateY"||c==="rotation")this[c]=d,this.updateTransform(),m=!0;m||(gb?f[c]=d:z(f,c,d))}return q},clip:function(a){var b=this,c;a?(c=a.members,ia(c,b),c.push(b),b.destroyClip=function(){ia(c,b)},a=a.getCSS(b)):(b.destroyClip&&b.destroyClip(),a={clip:gb?"inherit":"rect(auto)"});return b.css(a)},css:ta.prototype.htmlCss,safeRemoveChild:function(a){a.parentNode&&Pa(a)},destroy:function(){this.destroyClip&&this.destroyClip();return ta.prototype.destroy.apply(this)},on:function(a,b){this.element["on"+a]=function(){var a=G.event;a.target=a.srcElement;b(a)};return this},cutOffPath:function(a,b){var c,a=a.split(/[ ,]/);c=a.length;if(c===9||c===11)a[c-4]=a[c-2]=x(a[c-2])-10*b;return a.join(" ")},shadow:function(a,b,c){var d=[],e,f=this.element,g=this.renderer,h,i=f.style,j,k=f.path,l,m,n,q;k&&typeof k.value!=="string"&&(k="x");m=k;if(a){n=o(a.width,3);q=(a.opacity||.15)/n;for(e=1;e<=3;e++){l=n*2+1-2*e;c&&(m=this.cutOffPath(k.value,l+.5));j=['<shape isShadow="true" strokeweight="',l,'" filled="false" path="',m,'" coordsize="10 10" style="',f.style.cssText,'" />'];h=V(g.prepVML(j),null,{left:x(i.left)+o(a.offsetX,1),top:x(i.top)+o(a.offsetY,1)});if(c)h.cutOff=l+1;j=['<stroke color="',a.color||"black",'" opacity="',q*e,'"/>'];V(g.prepVML(j),null,null,h);b?b.element.appendChild(h):f.parentNode.insertBefore(h,f);d.push(h)}this.shadows=d}return this}};da=ja(ta,da);var ea={Element:da,isIE8:ua.indexOf("MSIE 8.0")>-1,init:function(a,b,c,d){var e;this.alignedObjects=[];d=this.createElement(Ja).css(s(this.getStyle(d),{position:"relative"}));e=d.element;a.appendChild(d.element);this.isVML=!0;this.box=e;this.boxWrapper=d;this.cache={};this.setSize(b,c,!1);if(!y.namespaces.hcv){y.namespaces.add("hcv","urn:schemas-microsoft-com:vml");try{y.createStyleSheet().cssText="hcv\\:fill, hcv\\:path, hcv\\:shape, hcv\\:stroke{ behavior:url(#default#VML); display: inline-block; } "}catch(f){y.styleSheets[0].cssText+="hcv\\:fill, hcv\\:path, hcv\\:shape, hcv\\:stroke{ behavior:url(#default#VML); display: inline-block; } "}}},isHidden:function(){return!this.box.offsetWidth},clipRect:function(a,b,c,d){var e=this.createElement(),f=$(a);return s(e,{members:[],left:(f?a.x:a)+1,top:(f?a.y:b)+1,width:(f?a.width:c)-1,height:(f?a.height:d)-1,getCSS:function(a){var b=a.element,c=b.nodeName,a=a.inverted,d=this.top-(c==="shape"?b.offsetTop:0),e=this.left,b=e+this.width,f=d+this.height,d={clip:"rect("+v(a?e:d)+"px,"+v(a?f:b)+"px,"+v(a?b:f)+"px,"+v(a?d:e)+"px)"};!a&&gb&&c==="DIV"&&s(d,{width:b+"px",height:f+"px"});return d},updateClipping:function(){p(e.members,function(a){a.css(e.getCSS(a))})}})},color:function(a,b,c,d){var e=this,f,g=/^rgba/,h,i,j=O;a&&a.linearGradient?i="gradient":a&&a.radialGradient&&(i="pattern");if(i){var k,l,m=a.linearGradient||a.radialGradient,n,q,o,K,r,P="",a=a.stops,t,s=[],v=function(){h=['<fill colors="'+s.join(",")+'" opacity="',o,'" o:opacity2="',q,'" type="',i,'" ',P,'focus="100%" method="any" />'];V(e.prepVML(h),null,null,b)};n=a[0];t=a[a.length-1];n[0]>0&&a.unshift([0,n[1]]);t[0]<1&&a.push([1,t[1]]);p(a,function(a,b){g.test(a[1])?(f=wa(a[1]),k=f.get("rgb"),l=f.get("a")):(k=a[1],l=1);s.push(a[0]*100+"% "+k);b?(o=l,K=k):(q=l,r=k)});if(c==="fill")if(i==="gradient")c=m.x1||m[0]||0,a=m.y1||m[1]||0,n=m.x2||m[2]||0,m=m.y2||m[3]||0,P='angle="'+(90-T.atan((m-a)/(n-c))*180/la)+'"',v();else{var j=m.r,u=j*2,y=j*2,w=m.cx,A=m.cy,xa=b.radialReference,x,j=function(){xa&&(x=d.getBBox(),w+=(xa[0]-x.x)/x.width-.5,A+=(xa[1]-x.y)/x.height-.5,u*=xa[2]/x.width,y*=xa[2]/x.height);P='src="'+L.global.VMLRadialGradientURL+'" size="'+u+","+y+'" origin="0.5,0.5" position="'+w+","+A+'" color2="'+r+'" ';v()};d.added?j():d.onAdd=j;j=K}else j=k}else if(g.test(a)&&b.tagName!=="IMG")f=wa(a),h=["<",c,' opacity="',f.get("a"),'"/>'],V(this.prepVML(h),null,null,b),j=f.get("rgb");else{j=b.getElementsByTagName(c);if(j.length)j[0].opacity=1,j[0].type="solid";j=a}return j},prepVML:function(a){var b=this.isIE8,a=a.join("");b?(a=a.replace("/>",' xmlns="urn:schemas-microsoft-com:vml" />'),a=a.indexOf('style="')===-1?a.replace("/>",' style="display:inline-block;behavior:url(#default#VML);" />'):a.replace('style="','style="display:inline-block;behavior:url(#default#VML);')):a=a.replace("<","<hcv:");return a},text:pa.prototype.html,path:function(a){var b={coordsize:"10 10"};La(a)?b.d=a:$(a)&&s(b,a);return this.createElement("shape").attr(b)},circle:function(a,b,c){var d=this.symbol("circle");if($(a))c=a.r,b=a.y,a=a.x;d.isCircle=!0;d.r=c;return d.attr({x:a,y:b})},g:function(a){var b;a&&(b={className:"highcharts-"+a,"class":"highcharts-"+a});return this.createElement(Ja).attr(b)},image:function(a,b,c,d,e){var f=this.createElement("img").attr({src:a});arguments.length>1&&f.attr({x:b,y:c,width:d,height:e});return f},createElement:function(a){return a==="rect"?this.symbol(a):pa.prototype.createElement.call(this,a)},invertChild:function(a,b){var c=this,d=b.style,e=a.tagName==="IMG"&&a.style;D(a,{flip:"x",left:x(d.width)-(e?x(e.top):1),top:x(d.height)-(e?x(e.left):1),rotation:-90});p(a.childNodes,function(b){c.invertChild(b,a)})},symbols:{arc:function(a,b,c,d,e){var f=e.start,g=e.end,h=e.r||c||d,c=e.innerR,d=W(f),i=ba(f),j=W(g),k=ba(g);if(g-f===0)return["x"];f=["wa",a-h,b-h,a+h,b+h,a+h*d,b+h*i,a+h*j,b+h*k];e.open&&!c&&f.push("e","M",a,b);f.push("at",a-c,b-c,a+c,b+c,a+c*j,b+c*k,a+c*d,b+c*i,"x","e");f.isArc=!0;return f},circle:function(a,b,c,d,e){e&&(c=d=2*e.r);e&&e.isCircle&&(a-=c/2,b-=d/2);return["wa",a,b,a+c,b+d,a+c,b+d/2,a+c,b+d/2,"e"]},rect:function(a,b,c,d,e){var f=a+c,g=b+d,h;!r(e)||!e.r?f=pa.prototype.symbols.square.apply(0,arguments):(h=E(e.r,c,d),f=["M",a+h,b,"L",f-h,b,"wa",f-2*h,b,f,b+2*h,f-h,b,f,b+h,"L",f,g-h,"wa",f-2*h,g-2*h,f,g,f,g-h,f-h,g,"L",a+h,g,"wa",a,g-2*h,a+2*h,g,a+h,g,a,g-h,"L",a,b+h,"wa",a,b,a+2*h,b+2*h,a,b+h,a+h,b,"x","e"]);return f}}};Q.VMLRenderer=da=function(){this.init.apply(this,arguments)};da.prototype=w(pa.prototype,ea);Za=da}pa.prototype.measureSpanWidth=function(a,b){var c=y.createElement("span"),d;d=y.createTextNode(a);c.appendChild(d);D(c,b);this.box.appendChild(c);d=c.offsetWidth;Pa(c);return d};var Mb;if(ca)Q.CanVGRenderer=da=function(){Da="http://www.w3.org/1999/xhtml"},da.prototype.symbols={},Mb=function(){function a(){var a=b.length,d;for(d=0;d<a;d++)b[d]();b=[]}var b=[];return{push:function(c,d){b.length===0&&Qb(d,a);b.push(c)}}}(),Za=da;Sa.prototype={addLabel:function(){var a=this.axis,b=a.options,c=a.chart,d=a.horiz,e=a.categories,f=a.names,g=this.pos,h=b.labels,i=a.tickPositions,d=d&&e&&!h.step&&!h.staggerLines&&!h.rotation&&c.plotWidth/i.length||!d&&(c.margin[3]||c.chartWidth*.33),j=g===i[0],k=g===i[i.length-1],l,f=e?o(e[g],f[g],g):g,e=this.label,m=i.info;a.isDatetimeAxis&&m&&(l=b.dateTimeLabelFormats[m.higherRanks[g]||m.unitName]);this.isFirst=j;this.isLast=k;b=a.labelFormatter.call({axis:a,chart:c,isFirst:j,isLast:k,dateTimeLabelFormat:l,value:a.isLog?aa(ha(f)):f});g=d&&{width:t(1,v(d-2*(h.padding||10)))+"px"};g=s(g,h.style);if(r(e))e&&e.attr({text:b}).css(g);else{l={align:a.labelAlign};if(ya(h.rotation))l.rotation=h.rotation;if(d&&h.ellipsis)l._clipHeight=a.len/i.length;this.label=r(b)&&h.enabled?c.renderer.text(b,0,0,h.useHTML).attr(l).css(g).add(a.labelGroup):null}},getLabelSize:function(){var a=this.label,b=this.axis;return a?a.getBBox()[b.horiz?"height":"width"]:0},getLabelSides:function(){var a=this.label.getBBox(),b=this.axis,c=b.horiz,d=b.options.labels,a=c?a.width:a.height,b=c?d.x-a*{left:0,center:.5,right:1}[b.labelAlign]:0;return[b,c?a+b:a]},handleOverflow:function(a,b){var c=!0,d=this.axis,e=this.isFirst,f=this.isLast,g=d.horiz?b.x:b.y,h=d.reversed,i=d.tickPositions,j=this.getLabelSides(),k=j[0],j=j[1],l,m,n,q=this.label.line||0;l=d.labelEdge;m=d.justifyLabels&&(e||f);l[q]===u||g+k>l[q]?l[q]=g+j:m||(c=!1);if(m){l=(m=d.justifyToPlot)?d.pos:0;m=m?l+d.len:d.chart.chartWidth;do a+=e?1:-1,n=d.ticks[i[a]];while(i[a]&&(!n||n.label.line!==q));d=n&&n.label.xy&&n.label.xy.x+n.getLabelSides()[e?0:1];e&&!h||f&&h?g+k<l&&(g=l-k,n&&g+j>d&&(c=!1)):g+j>m&&(g=m-j,n&&g+k<d&&(c=!1));b.x=g}return c},getPosition:function(a,b,c,d){var e=this.axis,f=e.chart,g=d&&f.oldChartHeight||f.chartHeight;return{x:a?e.translate(b+c,null,null,d)+e.transB:e.left+e.offset+(e.opposite?(d&&f.oldChartWidth||f.chartWidth)-e.right-e.left:0),y:a?g-e.bottom+e.offset-(e.opposite?e.height:0):g-e.translate(b+c,null,null,d)-e.transB}},getLabelPosition:function(a,b,c,d,e,f,g,h){var i=this.axis,j=i.transA,k=i.reversed,l=i.staggerLines,m=i.chart.renderer.fontMetrics(e.style.fontSize).b,n=e.rotation,a=a+e.x-(f&&d?f*j*(k?-1:1):0),b=b+e.y-(f&&!d?f*j*(k?1:-1):0);n&&i.side===2&&(b-=m-m*W(n*Ca));!r(e.y)&&!n&&(b+=m-c.getBBox().height/2);if(l)c.line=g/(h||1)%l,b+=c.line*(i.labelOffset/l);return{x:a,y:b}},getMarkPath:function(a,b,c,d,e,f){return f.crispLine(["M",a,b,"L",a+(e?0:-c),b+(e?c:0)],d)},render:function(a,b,c){var d=this.axis,e=d.options,f=d.chart.renderer,g=d.horiz,h=this.type,i=this.label,j=this.pos,k=e.labels,l=this.gridLine,m=h?h+"Grid":"grid",n=h?h+"Tick":"tick",q=e[m+"LineWidth"],p=e[m+"LineColor"],K=e[m+"LineDashStyle"],t=e[n+"Length"],m=e[n+"Width"]||0,r=e[n+"Color"],s=e[n+"Position"],n=this.mark,v=k.step,x=!0,y=d.tickmarkOffset,w=this.getPosition(g,j,y,b),H=w.x,w=w.y,A=g&&H===d.pos+d.len||!g&&w===d.pos?-1:1;this.isActive=!0;if(q){j=d.getPlotLinePath(j+y,q*A,b,!0);if(l===u){l={stroke:p,"stroke-width":q};if(K)l.dashstyle=K;if(!h)l.zIndex=1;if(b)l.opacity=0;this.gridLine=l=q?f.path(j).attr(l).add(d.gridGroup):null}if(!b&&l&&j)l[this.isNew?"attr":"animate"]({d:j,opacity:c})}if(m&&t)s==="inside"&&(t=-t),d.opposite&&(t=-t),h=this.getMarkPath(H,w,t,m*A,g,f),n?n.animate({d:h,opacity:c}):this.mark=f.path(h).attr({stroke:r,"stroke-width":m,opacity:c}).add(d.axisGroup);if(i&&!isNaN(H))i.xy=w=this.getLabelPosition(H,w,i,g,k,y,a,v),this.isFirst&&!this.isLast&&!o(e.showFirstLabel,1)||this.isLast&&!this.isFirst&&!o(e.showLastLabel,1)?x=!1:!d.isRadial&&!k.step&&!k.rotation&&!b&&c!==0&&(x=this.handleOverflow(a,w)),v&&a%v&&(x=!1),x&&!isNaN(w.y)?(w.opacity=c,i[this.isNew?"attr":"animate"](w),this.isNew=!1):i.attr("y",-9999)},destroy:function(){Oa(this,this.axis)}};Q.PlotLineOrBand=function(a,b){this.axis=a;if(b)this.options=b,this.id=b.id};Q.PlotLineOrBand.prototype={render:function(){var a=this,b=a.axis,c=b.horiz,d=(b.pointRange||0)/2,e=a.options,f=e.label,g=a.label,h=e.width,i=e.to,j=e.from,k=r(j)&&r(i),l=e.value,m=e.dashStyle,n=a.svgElem,q=[],p,K=e.color,s=e.zIndex,P=e.events,v=b.chart.renderer;b.isLog&&(j=za(j),i=za(i),l=za(l));if(h){if(q=b.getPlotLinePath(l,h),d={stroke:K,"stroke-width":h},m)d.dashstyle=m}else if(k){if(j=t(j,b.min-d),i=E(i,b.max+d),q=b.getPlotBandPath(j,i,e),d={fill:K},e.borderWidth)d.stroke=e.borderColor,d["stroke-width"]=e.borderWidth}else return;if(r(s))d.zIndex=s;if(n)if(q)n.animate({d:q},null,n.onGetPath);else{if(n.hide(),n.onGetPath=function(){n.show()},g)a.label=g=g.destroy()}else if(q&&q.length&&(a.svgElem=n=v.path(q).attr(d).add(),P))for(p in e=function(b){n.on(b,function(c){P[b].apply(a,[c])})},P)e(p);if(f&&r(f.text)&&q&&q.length&&b.width>0&&b.height>0){f=w({align:c&&k&&"center",x:c?!k&&4:10,verticalAlign:!c&&k&&"middle",y:c?k?16:10:k?6:-4,rotation:c&&!k&&90},f);if(!g)a.label=g=v.text(f.text,0,0,f.useHTML).attr({align:f.textAlign||f.align,rotation:f.rotation,zIndex:s}).css(f.style).add();b=[q[1],q[4],o(q[6],q[1])];q=[q[2],q[5],o(q[7],q[2])];c=Na(b);k=Na(q);g.align(f,!1,{x:c,y:k,width:Ba(b)-c,height:Ba(q)-k});g.show()}else g&&g.hide();return a},destroy:function(){ia(this.axis.plotLinesAndBands,this);delete this.axis;Oa(this)}};ka.prototype={defaultOptions:{dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e. %b",week:"%e. %b",month:"%b '%y",year:"%Y"},endOnTick:!1,gridLineColor:"#C0C0C0",labels:F,lineColor:"#C0D0E0",lineWidth:1,minPadding:.01,maxPadding:.01,minorGridLineColor:"#E0E0E0",minorGridLineWidth:1,minorTickColor:"#A0A0A0",minorTickLength:2,minorTickPosition:"outside",startOfWeek:1,startOnTick:!1,tickColor:"#C0D0E0",tickLength:5,tickmarkPlacement:"between",tickPixelInterval:100,tickPosition:"outside",tickWidth:1,title:{align:"middle",style:{color:"#4d759e",fontWeight:"bold"}},type:"linear"},defaultYAxisOptions:{endOnTick:!0,gridLineWidth:1,tickPixelInterval:72,showLastLabel:!0,labels:{x:-8,y:3},lineWidth:0,maxPadding:.05,minPadding:.05,startOnTick:!0,tickWidth:0,title:{rotation:270,text:"Values"},stackLabels:{enabled:!1,formatter:function(){return Ga(this.total,-1)},style:F.style}},defaultLeftAxisOptions:{labels:{x:-8,y:null},title:{rotation:270}},defaultRightAxisOptions:{labels:{x:8,y:null},title:{rotation:90}},defaultBottomAxisOptions:{labels:{x:0,y:14},title:{rotation:0}},defaultTopAxisOptions:{labels:{x:0,y:-5},title:{rotation:0}},init:function(a,b){var c=b.isX;this.horiz=a.inverted?!c:c;this.coll=(this.isXAxis=c)?"xAxis":"yAxis";this.opposite=b.opposite;this.side=b.side||(this.horiz?this.opposite?0:2:this.opposite?1:3);this.setOptions(b);var d=this.options,e=d.type;this.labelFormatter=d.labels.formatter||this.defaultLabelFormatter;this.userOptions=b;this.minPixelPadding=0;this.chart=a;this.reversed=d.reversed;this.zoomEnabled=d.zoomEnabled!==!1;this.categories=d.categories||e==="category";this.names=[];this.isLog=e==="logarithmic";this.isDatetimeAxis=e==="datetime";this.isLinked=r(d.linkedTo);this.tickmarkOffset=this.categories&&d.tickmarkPlacement==="between"?.5:0;this.ticks={};this.labelEdge=[];this.minorTicks={};this.plotLinesAndBands=[];this.alternateBands={};this.len=0;this.minRange=this.userMinRange=d.minRange||d.maxZoom;this.range=d.range;this.offset=d.offset||0;this.stacks={};this.oldStacks={};this.min=this.max=null;this.crosshair=o(d.crosshair,na(a.options.tooltip.crosshairs)[c?0:1],!1);var f,d=this.options.events;va(this,a.axes)===-1&&(c&&!this.isColorAxis?a.axes.splice(a.xAxis.length,0,this):a.axes.push(this),a[this.coll].push(this));this.series=this.series||[];if(a.inverted&&c&&this.reversed===u)this.reversed=!0;this.removePlotLine=this.removePlotBand=this.removePlotBandOrLine;for(f in d)C(this,f,d[f]);if(this.isLog)this.val2lin=za,this.lin2val=ha},setOptions:function(a){this.options=w(this.defaultOptions,this.isXAxis?{}:this.defaultYAxisOptions,[this.defaultTopAxisOptions,this.defaultRightAxisOptions,this.defaultBottomAxisOptions,this.defaultLeftAxisOptions][this.side],w(L[this.coll],a))},defaultLabelFormatter:function(){var a=this.axis,b=this.value,c=a.categories,d=this.dateTimeLabelFormat,e=L.lang.numericSymbols,f=e&&e.length,g,h=a.options.labels.format,a=a.isLog?b:a.tickInterval;if(h)g=Ia(h,this);else if(c)g=b;else if(d)g=bb(d,b);else if(f&&a>=1e3)for(;f--&&g===u;)c=Math.pow(1e3,f+1),a>=c&&e[f]!==null&&(g=Ga(b/c,-1)+e[f]);g===u&&(g=b>=1e4?Ga(b,0):Ga(b,-1,u,""));return g},getSeriesExtremes:function(){var a=this,b=a.chart;a.hasVisibleSeries=!1;a.dataMin=a.dataMax=null;a.buildStacks&&a.buildStacks();p(a.series,function(c){if(c.visible||!b.options.chart.ignoreHiddenSeries){var d;d=c.options.threshold;var e;a.hasVisibleSeries=!0;a.isLog&&d<=0&&(d=null);if(a.isXAxis){if(d=c.xData,d.length)a.dataMin=E(o(a.dataMin,d[0]),Na(d)),a.dataMax=t(o(a.dataMax,d[0]),Ba(d))}else{c.getExtremes();e=c.dataMax;c=c.dataMin;if(r(c)&&r(e))a.dataMin=E(o(a.dataMin,c),c),a.dataMax=t(o(a.dataMax,e),e);if(r(d))if(a.dataMin>=d)a.dataMin=d,a.ignoreMinPadding=!0;else if(a.dataMax<d)a.dataMax=d,a.ignoreMaxPadding=!0}}})},translate:function(a,b,c,d,e,f){var g=1,h=0,i=d?this.oldTransA:this.transA,d=d?this.oldMin:this.min,j=this.minPixelPadding,e=(this.options.ordinal||this.isLog&&e)&&this.lin2val;if(!i)i=this.transA;if(c)g*=-1,h=this.len;this.reversed&&(g*=-1,h-=g*(this.sector||this.len));b?(a=a*g+h,a-=j,a=a/i+d,e&&(a=this.lin2val(a))):(e&&(a=this.val2lin(a)),f==="between"&&(f=.5),a=g*(a-d)*i+h+g*j+(ya(f)?i*f*this.pointRange:0));return a},toPixels:function(a,b){return this.translate(a,!1,!this.horiz,null,!0)+(b?0:this.pos)},toValue:function(a,b){return this.translate(a-(b?0:this.pos),!0,!this.horiz,null,!0)},getPlotLinePath:function(a,b,c,d,e){var f=this.chart,g=this.left,h=this.top,i,j,k=c&&f.oldChartHeight||f.chartHeight,l=c&&f.oldChartWidth||f.chartWidth,m;i=this.transB;e=o(e,this.translate(a,null,null,c));a=c=v(e+i);i=j=v(k-e-i);if(isNaN(e))m=!0;else if(this.horiz){if(i=h,j=k-this.bottom,a<g||a>g+this.width)m=!0}else if(a=g,c=l-this.right,i<h||i>h+this.height)m=!0;return m&&!d?null:f.renderer.crispLine(["M",a,i,"L",c,j],b||1)},getLinearTickPositions:function(a,b,c){for(var d,b=aa(S(b/a)*a),c=aa(Ka(c/a)*a),e=[];b<=c;){e.push(b);b=aa(b+a);if(b===d)break;d=b}return e},getMinorTickPositions:function(){var a=this.options,b=this.tickPositions,c=this.minorTickInterval,d=[],e;if(this.isLog){e=b.length;for(a=1;a<e;a++)d=d.concat(this.getLogTickPositions(c,b[a-1],b[a],!0))}else if(this.isDatetimeAxis&&a.minorTickInterval==="auto")d=d.concat(this.getTimeTicks(this.normalizeTimeTickInterval(c),this.min,this.max,a.startOfWeek)),d[0]<this.min&&d.shift();else for(b=this.min+(b[0]-this.min)%c;b<=this.max;b+=c)d.push(b);return d},adjustForMinRange:function(){var a=this.options,b=this.min,c=this.max,d,e=this.dataMax-this.dataMin>=this.minRange,f,g,h,i,j;if(this.isXAxis&&this.minRange===u&&!this.isLog)r(a.min)||r(a.max)?this.minRange=null:(p(this.series,function(a){i=a.xData;for(g=j=a.xIncrement?1:i.length-1;g>0;g--)if(h=i[g]-i[g-1],f===u||h<f)f=h}),this.minRange=E(f*5,this.dataMax-this.dataMin));if(c-b<this.minRange){var k=this.minRange;d=(k-c+b)/2;d=[b-d,o(a.min,b-d)];if(e)d[2]=this.dataMin;b=Ba(d);c=[b+k,o(a.max,b+k)];if(e)c[2]=this.dataMax;c=Na(c);c-b<k&&(d[0]=c-k,d[1]=o(a.min,c-k),b=Ba(d))}this.min=b;this.max=c},setAxisTranslation:function(a){var b=this,c=b.max-b.min,d=b.axisPointRange||0,e,f=0,g=0,h=b.linkedParent,i=!!b.categories,j=b.transA;if(b.isXAxis||i||d)h?(f=h.minPointOffset,g=h.pointRangePadding):p(b.series,function(a){var h=t(b.isXAxis?a.pointRange:b.axisPointRange||0,+i),j=a.options.pointPlacement,n=a.closestPointRange;h>c&&(h=0);d=t(d,h);f=t(f,ga(j)?0:h/2);g=t(g,j==="on"?0:h);!a.noSharedTooltip&&r(n)&&(e=r(e)?E(e,n):n)}),h=b.ordinalSlope&&e?b.ordinalSlope/e:1,b.minPointOffset=f*=h,b.pointRangePadding=g*=h,b.pointRange=E(d,c),b.closestPointRange=e;if(a)b.oldTransA=j;b.translationSlope=b.transA=j=b.len/(c+g||1);b.transB=b.horiz?b.left:b.bottom;b.minPixelPadding=j*f},setTickPositions:function(a){var b=this,c=b.chart,d=b.options,e=b.isLog,f=b.isDatetimeAxis,g=b.isXAxis,h=b.isLinked,i=b.options.tickPositioner,j=d.maxPadding,k=d.minPadding,l=d.tickInterval,m=d.minTickInterval,n=d.tickPixelInterval,q,qa=b.categories;h?(b.linkedParent=c[b.coll][d.linkedTo],c=b.linkedParent.getExtremes(),b.min=o(c.min,c.dataMin),b.max=o(c.max,c.dataMax),d.type!==b.linkedParent.options.type&&oa(11,1)):(b.min=o(b.userMin,d.min,b.dataMin),b.max=o(b.userMax,d.max,b.dataMax));if(e)!a&&E(b.min,o(b.dataMin,b.min))<=0&&oa(10,1),b.min=aa(za(b.min)),b.max=aa(za(b.max));if(b.range&&r(b.max))b.userMin=b.min=t(b.min,b.max-b.range),b.userMax=b.max,b.range=null;b.beforePadding&&b.beforePadding();b.adjustForMinRange();if(!qa&&!b.axisPointRange&&!b.usePercentage&&!h&&r(b.min)&&r(b.max)&&(c=b.max-b.min)){if(!r(d.min)&&!r(b.userMin)&&k&&(b.dataMin<0||!b.ignoreMinPadding))b.min-=c*k;if(!r(d.max)&&!r(b.userMax)&&j&&(b.dataMax>0||!b.ignoreMaxPadding))b.max+=c*j}b.min===b.max||b.min===void 0||b.max===void 0?b.tickInterval=1:h&&!l&&n===b.linkedParent.options.tickPixelInterval?b.tickInterval=b.linkedParent.tickInterval:(b.tickInterval=o(l,qa?1:(b.max-b.min)*n/t(b.len,n)),!r(l)&&b.len<n&&!this.isRadial&&!this.isLog&&!qa&&d.startOnTick&&d.endOnTick&&(q=!0,b.tickInterval/=4));g&&!a&&p(b.series,function(a){a.processData(b.min!==b.oldMin||b.max!==b.oldMax)});b.setAxisTranslation(!0);b.beforeSetTickPositions&&b.beforeSetTickPositions();if(b.postProcessTickInterval)b.tickInterval=b.postProcessTickInterval(b.tickInterval);if(b.pointRange)b.tickInterval=t(b.pointRange,b.tickInterval);if(!l&&b.tickInterval<m)b.tickInterval=m;if(!f&&!e&&!l)b.tickInterval=nb(b.tickInterval,null,mb(b.tickInterval),d);b.minorTickInterval=d.minorTickInterval==="auto"&&b.tickInterval?b.tickInterval/5:d.minorTickInterval;b.tickPositions=a=d.tickPositions?[].concat(d.tickPositions):i&&i.apply(b,[b.min,b.max]);if(!a)!b.ordinalPositions&&(b.max-b.min)/b.tickInterval>t(2*b.len,200)&&oa(19,!0),a=f?b.getTimeTicks(b.normalizeTimeTickInterval(b.tickInterval,d.units),b.min,b.max,d.startOfWeek,b.ordinalPositions,b.closestPointRange,!0):e?b.getLogTickPositions(b.tickInterval,b.min,b.max):b.getLinearTickPositions(b.tickInterval,b.min,b.max),q&&a.splice(1,a.length-2),b.tickPositions=a;if(!h)e=a[0],f=a[a.length-1],h=b.minPointOffset||0,d.startOnTick?b.min=e:b.min-h>e&&a.shift(),d.endOnTick?b.max=f:b.max+h<f&&a.pop(),a.length===1&&(d=N(b.max||1)*.001,b.min-=d,b.max+=d)},setMaxTicks:function(){var a=this.chart,b=a.maxTicks||{},c=this.tickPositions,d=this._maxTicksKey=[this.coll,this.pos,this.len].join("-");if(!this.isLinked&&!this.isDatetimeAxis&&c&&c.length>(b[d]||0)&&this.options.alignTicks!==!1)b[d]=c.length;a.maxTicks=b},adjustTickAmount:function(){var a=this._maxTicksKey,b=this.tickPositions,c=this.chart.maxTicks;if(c&&c[a]&&!this.isDatetimeAxis&&!this.categories&&!this.isLinked&&this.options.alignTicks!==!1&&this.min!==u){var d=this.tickAmount,e=b.length;this.tickAmount=a=c[a];if(e<a){for(;b.length<a;)b.push(aa(b[b.length-1]+this.tickInterval));this.transA*=(e-1)/(a-1);this.max=b[b.length-1]}if(r(d)&&a!==d)this.isDirty=!0}},setScale:function(){var a=this.stacks,b,c,d,e;this.oldMin=this.min;this.oldMax=this.max;this.oldAxisLength=this.len;this.setAxisSize();e=this.len!==this.oldAxisLength;p(this.series,function(a){if(a.isDirtyData||a.isDirty||a.xAxis.isDirty)d=!0});if(e||d||this.isLinked||this.forceRedraw||this.userMin!==this.oldUserMin||this.userMax!==this.oldUserMax){if(!this.isXAxis)for(b in a)for(c in a[b])a[b][c].total=null,a[b][c].cum=0;this.forceRedraw=!1;this.getSeriesExtremes();this.setTickPositions();this.oldUserMin=this.userMin;this.oldUserMax=this.userMax;if(!this.isDirty)this.isDirty=e||this.min!==this.oldMin||this.max!==this.oldMax}else if(!this.isXAxis){if(this.oldStacks)a=this.stacks=this.oldStacks;for(b in a)for(c in a[b])a[b][c].cum=a[b][c].total}this.setMaxTicks()},setExtremes:function(a,b,c,d,e){var f=this,g=f.chart,c=o(c,!0),e=s(e,{min:a,max:b});I(f,"setExtremes",e,function(){f.userMin=a;f.userMax=b;f.eventArgs=e;f.isDirtyExtremes=!0;c&&g.redraw(d)})},zoom:function(a,b){var c=this.dataMin,d=this.dataMax,e=this.options;this.allowZoomOutside||(r(c)&&a<=E(c,o(e.min,c))&&(a=u),r(d)&&b>=t(d,o(e.max,d))&&(b=u));this.displayBtn=a!==u||b!==u;this.setExtremes(a,b,!1,u,{trigger:"zoom"});return!0},setAxisSize:function(){var a=this.chart,b=this.options,c=b.offsetLeft||0,d=b.offsetRight||0,e=this.horiz,f,g;this.left=g=o(b.left,a.plotLeft+c);this.top=f=o(b.top,a.plotTop);this.width=c=o(b.width,a.plotWidth-c+d);this.height=b=o(b.height,a.plotHeight);this.bottom=a.chartHeight-b-f;this.right=a.chartWidth-c-g;this.len=t(e?c:b,0);this.pos=e?g:f},getExtremes:function(){var a=this.isLog;return{min:a?aa(ha(this.min)):this.min,max:a?aa(ha(this.max)):this.max,dataMin:this.dataMin,dataMax:this.dataMax,userMin:this.userMin,userMax:this.userMax}},getThreshold:function(a){var b=this.isLog,c=b?ha(this.min):this.min,b=b?ha(this.max):this.max;c>a||a===null?a=c:b<a&&(a=b);return this.translate(a,0,1,0,1)},autoLabelAlign:function(a){a=(o(a,0)-this.side*90+720)%360;return a>15&&a<165?"right":a>195&&a<345?"left":"center"},getOffset:function(){var a=this,b=a.chart,c=b.renderer,d=a.options,e=a.tickPositions,f=a.ticks,g=a.horiz,h=a.side,i=b.inverted?[1,0,3,2][h]:h,j,k=0,l,m=0,n=d.title,q=d.labels,qa=0,K=b.axisOffset,s=b.clipOffset,P=[-1,1,1,-1][h],v,w=1,x=o(q.maxStaggerLines,5),y,z,H,A;a.hasData=j=a.hasVisibleSeries||r(a.min)&&r(a.max)&&!!e;a.showAxis=b=j||o(d.showEmpty,!0);a.staggerLines=a.horiz&&q.staggerLines;if(!a.axisGroup)a.gridGroup=c.g("grid").attr({zIndex:d.gridZIndex||1}).add(),a.axisGroup=c.g("axis").attr({zIndex:d.zIndex||2}).add(),a.labelGroup=c.g("axis-labels").attr({zIndex:q.zIndex||7}).addClass("highcharts-"+a.coll.toLowerCase()+"-labels").add();if(j||a.isLinked){a.labelAlign=o(q.align||a.autoLabelAlign(q.rotation));p(e,function(b){f[b]?f[b].addLabel():f[b]=new Sa(a,b)});if(a.horiz&&!a.staggerLines&&x&&!q.rotation){for(v=a.reversed?[].concat(e).reverse():e;w<x;){j=[];y=!1;for(q=0;q<v.length;q++)z=v[q],H=(H=f[z].label&&f[z].label.getBBox())?H.width:0,A=q%w,H&&(z=a.translate(z),j[A]!==u&&z<j[A]&&(y=!0),j[A]=z+H);if(y)w++;else break}if(w>1)a.staggerLines=w}p(e,function(b){if(h===0||h===2||{1:"left",3:"right"}[h]===a.labelAlign)qa=t(f[b].getLabelSize(),qa)});if(a.staggerLines)qa*=a.staggerLines,a.labelOffset=qa}else for(v in f)f[v].destroy(),delete f[v];if(n&&n.text&&n.enabled!==!1){if(!a.axisTitle)a.axisTitle=c.text(n.text,0,0,n.useHTML).attr({zIndex:7,rotation:n.rotation||0,align:n.textAlign||{low:"left",middle:"center",high:"right"}[n.align]}).addClass("highcharts-"+this.coll.toLowerCase()+"-title").css(n.style).add(a.axisGroup),a.axisTitle.isNew=!0;if(b)k=a.axisTitle.getBBox()[g?"height":"width"],m=o(n.margin,g?5:10),l=n.offset;a.axisTitle[b?"show":"hide"]()}a.offset=P*o(d.offset,K[h]);a.axisTitleMargin=o(l,qa+m+(h!==2&&qa&&P*d.labels[g?"y":"x"]));K[h]=t(K[h],a.axisTitleMargin+k+P*a.offset);s[i]=t(s[i],S(d.lineWidth/2)*2)},getLinePath:function(a){var b=this.chart,c=this.opposite,d=this.offset,e=this.horiz,f=this.left+(c?this.width:0)+d,d=b.chartHeight-this.bottom-(c?this.height:0)+d;c&&(a*=-1);return b.renderer.crispLine(["M",e?this.left:f,e?d:this.top,"L",e?b.chartWidth-this.right:f,e?d:b.chartHeight-this.bottom],a)},getTitlePosition:function(){var a=this.horiz,b=this.left,c=this.top,d=this.len,e=this.options.title,f=a?b:c,g=this.opposite,h=this.offset,i=x(e.style.fontSize||12),d={low:f+(a?0:d),middle:f+d/2,high:f+(a?d:0)}[e.align],b=(a?c+this.height:b)+(a?1:-1)*(g?-1:1)*this.axisTitleMargin+(this.side===2?i:0);return{x:a?d:b+(g?this.width:0)+h+(e.x||0),y:a?b-(g?this.height:0)+h:d+(e.y||0)}},render:function(){var a=this,b=a.horiz,c=a.reversed,d=a.chart,e=d.renderer,f=a.options,g=a.isLog,h=a.isLinked,i=a.tickPositions,j,k=a.axisTitle,l=a.ticks,m=a.minorTicks,n=a.alternateBands,q=f.stackLabels,o=f.alternateGridColor,K=a.tickmarkOffset,t=f.lineWidth,v=d.hasRendered&&r(a.oldMin)&&!isNaN(a.oldMin),s=a.hasData,w=a.showAxis,x,y=f.labels.overflow,z=a.justifyLabels=b&&y!==!1,H;a.labelEdge.length=0;a.justifyToPlot=y==="justify";p([l,m,n],function(a){for(var b in a)a[b].isActive=!1});if(s||h)if(a.minorTickInterval&&!a.categories&&p(a.getMinorTickPositions(),function(b){m[b]||(m[b]=new Sa(a,b,"minor"));v&&m[b].isNew&&m[b].render(null,!0);m[b].render(null,!1,1)}),i.length&&(j=i.slice(),(b&&c||!b&&!c)&&j.reverse(),z&&(j=j.slice(1).concat([j[0]])),p(j,function(b,c){z&&(c=c===j.length-1?0:c+1);if(!h||b>=a.min&&b<=a.max)l[b]||(l[b]=new Sa(a,b)),v&&l[b].isNew&&l[b].render(c,!0,.1),l[b].render(c,!1,1)}),K&&a.min===0&&(l[-1]||(l[-1]=new Sa(a,-1,null,!0)),l[-1].render(-1))),o&&p(i,function(b,c){if(c%2===0&&b<a.max)n[b]||(n[b]=new Q.PlotLineOrBand(a)),x=b+K,H=i[c+1]!==u?i[c+1]+K:a.max,n[b].options={from:g?ha(x):x,to:g?ha(H):H,color:o},n[b].render(),n[b].isActive=!0
}),!a._addedPlotLB)p((f.plotLines||[]).concat(f.plotBands||[]),function(b){a.addPlotBandOrLine(b)}),a._addedPlotLB=!0;p([l,m,n],function(a){var b,c,e=[],f=sa?sa.duration||500:0,g=function(){for(c=e.length;c--;)a[e[c]]&&!a[e[c]].isActive&&(a[e[c]].destroy(),delete a[e[c]])};for(b in a)if(!a[b].isActive)a[b].render(b,!1,0),a[b].isActive=!1,e.push(b);a===n||!d.hasRendered||!f?g():f&&setTimeout(g,f)});if(t)b=a.getLinePath(t),a.axisLine?a.axisLine.animate({d:b}):a.axisLine=e.path(b).attr({stroke:f.lineColor,"stroke-width":t,zIndex:7}).add(a.axisGroup),a.axisLine[w?"show":"hide"]();if(k&&w)k[k.isNew?"attr":"animate"](a.getTitlePosition()),k.isNew=!1;q&&q.enabled&&a.renderStackTotals();a.isDirty=!1},redraw:function(){var a=this.chart.pointer;a&&a.reset(!0);this.render();p(this.plotLinesAndBands,function(a){a.render()});p(this.series,function(a){a.isDirty=!0})},destroy:function(a){var b=this,c=b.stacks,d,e=b.plotLinesAndBands;a||U(b);for(d in c)Oa(c[d]),c[d]=null;p([b.ticks,b.minorTicks,b.alternateBands],function(a){Oa(a)});for(a=e.length;a--;)e[a].destroy();p("stackTotalGroup,axisLine,axisTitle,axisGroup,cross,gridGroup,labelGroup".split(","),function(a){b[a]&&(b[a]=b[a].destroy())});this.cross&&this.cross.destroy()},drawCrosshair:function(a,b){if(this.crosshair)if((r(b)||!o(this.crosshair.snap,!0))===!1)this.hideCrosshair();else{var c,d=this.crosshair,e=d.animation;o(d.snap,!0)?r(b)&&(c=this.chart.inverted!=this.horiz?b.plotX:this.len-b.plotY):c=this.horiz?a.chartX-this.pos:this.len-a.chartY+this.pos;c=this.isRadial?this.getPlotLinePath(this.isXAxis?b.x:o(b.stackY,b.y)):this.getPlotLinePath(null,null,null,null,c);if(c===null)this.hideCrosshair();else if(this.cross)this.cross.attr({visibility:"visible"})[e?"animate":"attr"]({d:c},e);else{e={"stroke-width":d.width||1,stroke:d.color||"#C0C0C0",zIndex:d.zIndex||2};if(d.dashStyle)e.dashstyle=d.dashStyle;this.cross=this.chart.renderer.path(c).attr(e).add()}}},hideCrosshair:function(){this.cross&&this.cross.hide()}};s(ka.prototype,{getPlotBandPath:function(a,b){var c=this.getPlotLinePath(b),d=this.getPlotLinePath(a);d&&c?d.push(c[4],c[5],c[1],c[2]):d=null;return d},addPlotBand:function(a){this.addPlotBandOrLine(a,"plotBands")},addPlotLine:function(a){this.addPlotBandOrLine(a,"plotLines")},addPlotBandOrLine:function(a,b){var c=new Q.PlotLineOrBand(this,a).render(),d=this.userOptions;c&&(b&&(d[b]=d[b]||[],d[b].push(a)),this.plotLinesAndBands.push(c));return c},removePlotBandOrLine:function(a){for(var b=this.plotLinesAndBands,c=this.options,d=this.userOptions,e=b.length;e--;)b[e].id===a&&b[e].destroy();p([c.plotLines||[],d.plotLines||[],c.plotBands||[],d.plotBands||[]],function(b){for(e=b.length;e--;)b[e].id===a&&ia(b,b[e])})}});ka.prototype.getTimeTicks=function(a,b,c,d){var e=[],f={},g=L.global.useUTC,h,i=new Date(b-Ra),j=a.unitRange,k=a.count;if(r(b)){j>=B.second&&(i.setMilliseconds(0),i.setSeconds(j>=B.minute?0:k*S(i.getSeconds()/k)));if(j>=B.minute)i[Db](j>=B.hour?0:k*S(i[pb]()/k));if(j>=B.hour)i[Eb](j>=B.day?0:k*S(i[qb]()/k));if(j>=B.day)i[sb](j>=B.month?1:k*S(i[Xa]()/k));j>=B.month&&(i[Fb](j>=B.year?0:k*S(i[eb]()/k)),h=i[fb]());j>=B.year&&(h-=h%k,i[Gb](h));if(j===B.week)i[sb](i[Xa]()-i[rb]()+o(d,1));b=1;Ra&&(i=new Date(i.getTime()+Ra));h=i[fb]();for(var d=i.getTime(),l=i[eb](),m=i[Xa](),n=g?Ra:(864e5+i.getTimezoneOffset()*6e4)%864e5;d<c;)e.push(d),j===B.year?d=db(h+b*k,0):j===B.month?d=db(h,l+b*k):!g&&(j===B.day||j===B.week)?d=db(h,l,m+b*k*(j===B.day?1:7)):d+=j*k,b++;e.push(d);p(vb(e,function(a){return j<=B.hour&&a%B.day===n}),function(a){f[a]="day"})}e.info=s(a,{higherRanks:f,totalRange:j*k});return e};ka.prototype.normalizeTimeTickInterval=function(a,b){var c=b||[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1,2]],["week",[1,2]],["month",[1,2,3,4,6]],["year",null]],d=c[c.length-1],e=B[d[0]],f=d[1],g;for(g=0;g<c.length;g++)if(d=c[g],e=B[d[0]],f=d[1],c[g+1]&&a<=(e*f[f.length-1]+B[c[g+1][0]])/2)break;e===B.year&&a<5*e&&(f=[1,2,5]);c=nb(a/e,f,d[0]==="year"?t(mb(a/e),1):1);return{unitRange:e,count:c,unitName:d[0]}};ka.prototype.getLogTickPositions=function(a,b,c,d){var e=this.options,f=this.len,g=[];if(!d)this._minorAutoInterval=null;if(a>=.5)a=v(a),g=this.getLinearTickPositions(a,b,c);else if(a>=.08)for(var f=S(b),h,i,j,k,l,e=a>.3?[1,2,4]:a>.15?[1,2,4,6,8]:[1,2,3,4,5,6,7,8,9];f<c+1&&!l;f++){i=e.length;for(h=0;h<i&&!l;h++)j=za(ha(f)*e[h]),j>b&&(!d||k<=c)&&g.push(k),k>c&&(l=!0),k=j}else if(b=ha(b),c=ha(c),a=e[d?"minorTickInterval":"tickInterval"],a=o(a==="auto"?null:a,this._minorAutoInterval,(c-b)*(e.tickPixelInterval/(d?5:1))/((d?f/this.tickPositions.length:f)||1)),a=nb(a,null,mb(a)),g=Ua(this.getLinearTickPositions(a,b,c),za),!d)this._minorAutoInterval=a/5;if(!d)this.tickInterval=a;return g};var Nb=Q.Tooltip=function(){this.init.apply(this,arguments)};Nb.prototype={init:function(a,b){var c=b.borderWidth,d=b.style,e=x(d.padding);this.chart=a;this.options=b;this.crosshairs=[];this.now={x:0,y:0};this.isHidden=!0;this.label=a.renderer.label("",0,0,b.shape,null,null,b.useHTML,null,"tooltip").attr({padding:e,fill:b.backgroundColor,"stroke-width":c,r:b.borderRadius,zIndex:8}).css(d).css({padding:0}).add().attr({y:-9999});ca||this.label.shadow(b.shadow);this.shared=b.shared},destroy:function(){if(this.label)this.label=this.label.destroy();clearTimeout(this.hideTimer);clearTimeout(this.tooltipTimeout)},move:function(a,b,c,d){var e=this,f=e.now,g=e.options.animation!==!1&&!e.isHidden;s(f,{x:g?(2*f.x+a)/3:a,y:g?(f.y+b)/2:b,anchorX:g?(2*f.anchorX+c)/3:c,anchorY:g?(f.anchorY+d)/2:d});e.label.attr(f);if(g&&(N(a-f.x)>1||N(b-f.y)>1))clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){e&&e.move(a,b,c,d)},32)},hide:function(){var a=this,b;clearTimeout(this.hideTimer);if(!this.isHidden)b=this.chart.hoverPoints,this.hideTimer=setTimeout(function(){a.label.fadeOut();a.isHidden=!0},o(this.options.hideDelay,500)),b&&p(b,function(a){a.setState()}),this.chart.hoverPoints=null},getAnchor:function(a,b){var c,d=this.chart,e=d.inverted,f=d.plotTop,g=0,h=0,i,a=na(a);c=a[0].tooltipPos;this.followPointer&&b&&(b.chartX===u&&(b=d.pointer.normalize(b)),c=[b.chartX-d.plotLeft,b.chartY-f]);c||(p(a,function(a){i=a.series.yAxis;g+=a.plotX;h+=(a.plotLow?(a.plotLow+a.plotHigh)/2:a.plotY)+(!e&&i?i.top-f:0)}),g/=a.length,h/=a.length,c=[e?d.plotWidth-h:g,this.shared&&!e&&a.length>1&&b?b.chartY-f:e?d.plotHeight-g:h]);return Ua(c,v)},getPosition:function(a,b,c){var d=this.chart,e=d.plotLeft,f=d.plotTop,g=d.plotWidth,h=d.plotHeight,i=o(this.options.distance,12),j=isNaN(c.plotX)?0:c.plotX,c=c.plotY,d=j+e+(d.inverted?i:-a-i),k=c-b+f+15,l;d<7&&(d=e+t(j,0)+i);d+a>e+g&&(d-=d+a-(e+g),k=c-b+f-i,l=!0);k<f+5&&(k=f+5,l&&c>=k&&c<=k+b&&(k=c+f+i));k+b>f+h&&(k=t(f,f+h-b-i));return{x:d,y:k}},defaultFormatter:function(a){var b=this.points||na(this),c=b[0].series,d;d=[a.tooltipHeaderFormatter(b[0])];p(b,function(a){c=a.series;d.push(c.tooltipFormatter&&c.tooltipFormatter(a)||a.point.tooltipFormatter(c.tooltipOptions.pointFormat))});d.push(a.options.footerFormat||"");return d.join("")},refresh:function(a,b){var c=this.chart,d=this.label,e=this.options,f,g,h={},i,j=[];i=e.formatter||this.defaultFormatter;var h=c.hoverPoints,k,l=this.shared;clearTimeout(this.hideTimer);this.followPointer=na(a)[0].series.tooltipOptions.followPointer;g=this.getAnchor(a,b);f=g[0];g=g[1];l&&(!a.series||!a.series.noSharedTooltip)?(c.hoverPoints=a,h&&p(h,function(a){a.setState()}),p(a,function(a){a.setState("hover");j.push(a.getLabelConfig())}),h={x:a[0].category,y:a[0].y},h.points=j,a=a[0]):h=a.getLabelConfig();i=i.call(h,this);h=a.series;i===!1?this.hide():(this.isHidden&&(ab(d),d.attr("opacity",1).show()),d.attr({text:i}),k=e.borderColor||a.color||h.color||"#606060",d.attr({stroke:k}),this.updatePosition({plotX:f,plotY:g}),this.isHidden=!1);I(c,"tooltipRefresh",{text:i,x:f+c.plotLeft,y:g+c.plotTop,borderColor:k})},updatePosition:function(a){var b=this.chart,c=this.label,c=(this.options.positioner||this.getPosition).call(this,c.width,c.height,a);this.move(v(c.x),v(c.y),a.plotX+b.plotLeft,a.plotY+b.plotTop)},tooltipHeaderFormatter:function(a){var b=a.series,c=b.tooltipOptions,d=c.dateTimeLabelFormats,e=c.xDateFormat,f=b.xAxis,g=f&&f.options.type==="datetime"&&ya(a.key),c=c.headerFormat,f=f&&f.closestPointRange,h;if(g&&!e){if(f)for(h in B){if(B[h]>=f||B[h]<=B.day&&a.key%B[h]>0){e=d[h];break}}else e=d.day;e=e||d.year}g&&e&&(c=c.replace("{point.key}","{point.key:"+e+"}"));return Ia(c,{point:a,series:b})}};var fa;$a=y.documentElement.ontouchstart!==u;var Wa=Q.Pointer=function(a,b){this.init(a,b)};Wa.prototype={init:function(a,b){var c=b.chart,d=c.events,e=ca?"":c.zoomType,c=a.inverted,f;this.options=b;this.chart=a;this.zoomX=f=/x/.test(e);this.zoomY=e=/y/.test(e);this.zoomHor=f&&!c||e&&c;this.zoomVert=e&&!c||f&&c;this.runChartClick=d&&!!d.click;this.pinchDown=[];this.lastValidTouch={};if(Q.Tooltip&&b.tooltip.enabled)a.tooltip=new Nb(a,b.tooltip);this.setDOMEvents()},normalize:function(a,b){var c,d,a=a||G.event,a=Sb(a);if(!a.target)a.target=a.srcElement;d=a.touches?a.touches.item(0):a;if(!b)this.chartPosition=b=Rb(this.chart.container);d.pageX===u?(c=t(a.x,a.clientX-b.left),d=a.y):(c=d.pageX-b.left,d=d.pageY-b.top);return s(a,{chartX:v(c),chartY:v(d)})},getCoordinates:function(a){var b={xAxis:[],yAxis:[]};p(this.chart.axes,function(c){b[c.isXAxis?"xAxis":"yAxis"].push({axis:c,value:c.toValue(a[c.horiz?"chartX":"chartY"])})});return b},getIndex:function(a){var b=this.chart;return b.inverted?b.plotHeight+b.plotTop-a.chartY:a.chartX-b.plotLeft},runPointActions:function(a){var b=this.chart,c=b.series,d=b.tooltip,e,f,g=b.hoverPoint,h=b.hoverSeries,i,j,k=b.chartWidth,l=this.getIndex(a);if(d&&this.options.tooltip.shared&&(!h||!h.noSharedTooltip)){f=[];i=c.length;for(j=0;j<i;j++)if(c[j].visible&&c[j].options.enableMouseTracking!==!1&&!c[j].noSharedTooltip&&c[j].singularTooltips!==!0&&c[j].tooltipPoints.length&&(e=c[j].tooltipPoints[l])&&e.series)e._dist=N(l-e.clientX),k=E(k,e._dist),f.push(e);for(i=f.length;i--;)f[i]._dist>k&&f.splice(i,1);if(f.length&&f[0].clientX!==this.hoverX)d.refresh(f,a),this.hoverX=f[0].clientX}if(h&&h.tracker&&(!d||!d.followPointer)){if((e=h.tooltipPoints[l])&&e!==g)e.onMouseOver(a)}else d&&d.followPointer&&!d.isHidden&&(c=d.getAnchor([{}],a),d.updatePosition({plotX:c[0],plotY:c[1]}));if(d&&!this._onDocumentMouseMove)this._onDocumentMouseMove=function(a){if(r(fa))Y[fa].pointer.onDocumentMouseMove(a)},C(y,"mousemove",this._onDocumentMouseMove);p(b.axes,function(b){b.drawCrosshair(a,o(e,g))})},reset:function(a){var b=this.chart,c=b.hoverSeries,d=b.hoverPoint,e=b.tooltip,f=e&&e.shared?b.hoverPoints:d;(a=a&&e&&f)&&na(f)[0].plotX===u&&(a=!1);if(a)e.refresh(f),d&&d.setState(d.state,!0);else{if(d)d.onMouseOut();if(c)c.onMouseOut();e&&e.hide();if(this._onDocumentMouseMove)U(y,"mousemove",this._onDocumentMouseMove),this._onDocumentMouseMove=null;p(b.axes,function(a){a.hideCrosshair()});this.hoverX=null}},scaleGroups:function(a,b){var c=this.chart,d;p(c.series,function(e){d=a||e.getPlotBox();e.xAxis&&e.xAxis.zoomEnabled&&(e.group.attr(d),e.markerGroup&&(e.markerGroup.attr(d),e.markerGroup.clip(b?c.clipRect:null)),e.dataLabelsGroup&&e.dataLabelsGroup.attr(d))});c.clipRect.attr(b||c.clipBox)},dragStart:function(a){var b=this.chart;b.mouseIsDown=a.type;b.cancelClick=!1;b.mouseDownX=this.mouseDownX=a.chartX;b.mouseDownY=this.mouseDownY=a.chartY},drag:function(a){var b=this.chart,c=b.options.chart,d=a.chartX,e=a.chartY,f=this.zoomHor,g=this.zoomVert,h=b.plotLeft,i=b.plotTop,j=b.plotWidth,k=b.plotHeight,l,m=this.mouseDownX,n=this.mouseDownY;d<h?d=h:d>h+j&&(d=h+j);e<i?e=i:e>i+k&&(e=i+k);this.hasDragged=Math.sqrt(Math.pow(m-d,2)+Math.pow(n-e,2));if(this.hasDragged>10){l=b.isInsidePlot(m-h,n-i);if(b.hasCartesianSeries&&(this.zoomX||this.zoomY)&&l&&!this.selectionMarker)this.selectionMarker=b.renderer.rect(h,i,f?1:j,g?1:k,0).attr({fill:c.selectionMarkerFill||"rgba(69,114,167,0.25)",zIndex:7}).add();this.selectionMarker&&f&&(d-=m,this.selectionMarker.attr({width:N(d),x:(d>0?0:d)+m}));this.selectionMarker&&g&&(d=e-n,this.selectionMarker.attr({height:N(d),y:(d>0?0:d)+n}));l&&!this.selectionMarker&&c.panning&&b.pan(a,c.panning)}},drop:function(a){var b=this.chart,c=this.hasPinched;if(this.selectionMarker){var d={xAxis:[],yAxis:[],originalEvent:a.originalEvent||a},e=this.selectionMarker,f=e.x,g=e.y,h;if(this.hasDragged||c)p(b.axes,function(a){if(a.zoomEnabled){var b=a.horiz,c=a.toValue(b?f:g),b=a.toValue(b?f+e.width:g+e.height);!isNaN(c)&&!isNaN(b)&&(d[a.coll].push({axis:a,min:E(c,b),max:t(c,b)}),h=!0)}}),h&&I(b,"selection",d,function(a){b.zoom(s(a,c?{animation:!1}:null))});this.selectionMarker=this.selectionMarker.destroy();c&&this.scaleGroups()}if(b)D(b.container,{cursor:b._cursor}),b.cancelClick=this.hasDragged>10,b.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[]},onContainerMouseDown:function(a){a=this.normalize(a);a.preventDefault&&a.preventDefault();this.dragStart(a)},onDocumentMouseUp:function(a){r(fa)&&Y[fa].pointer.drop(a)},onDocumentMouseMove:function(a){var b=this.chart,c=this.chartPosition,d=b.hoverSeries,a=this.normalize(a,c);c&&d&&!this.inClass(a.target,"highcharts-tracker")&&!b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)&&this.reset()},onContainerMouseLeave:function(){var a=Y[fa];if(a)a.pointer.reset(),a.pointer.chartPosition=null;fa=null},onContainerMouseMove:function(a){var b=this.chart;fa=b.index;a=this.normalize(a);b.mouseIsDown==="mousedown"&&this.drag(a);(this.inClass(a.target,"highcharts-tracker")||b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop))&&!b.openMenu&&this.runPointActions(a)},inClass:function(a,b){for(var c;a;){if(c=z(a,"class"))if(c.indexOf(b)!==-1)return!0;else if(c.indexOf("highcharts-container")!==-1)return!1;a=a.parentNode}},onTrackerMouseOut:function(a){var b=this.chart.hoverSeries,c=(a=a.relatedTarget||a.toElement)&&a.point&&a.point.series;if(b&&!b.options.stickyTracking&&!this.inClass(a,"highcharts-tooltip")&&c!==b)b.onMouseOut()},onContainerClick:function(a){var b=this.chart,c=b.hoverPoint,d=b.plotLeft,e=b.plotTop,f=b.inverted,g,h,i,a=this.normalize(a);a.cancelBubble=!0;if(!b.cancelClick)c&&this.inClass(a.target,"highcharts-tracker")?(g=this.chartPosition,h=c.plotX,i=c.plotY,s(c,{pageX:g.left+d+(f?b.plotWidth-i:h),pageY:g.top+e+(f?b.plotHeight-h:i)}),I(c.series,"click",s(a,{point:c})),b.hoverPoint&&c.firePointEvent("click",a)):(s(a,this.getCoordinates(a)),b.isInsidePlot(a.chartX-d,a.chartY-e)&&I(b,"click",a))},setDOMEvents:function(){var a=this,b=a.chart.container;b.onmousedown=function(b){a.onContainerMouseDown(b)};b.onmousemove=function(b){a.onContainerMouseMove(b)};b.onclick=function(b){a.onContainerClick(b)};C(b,"mouseleave",a.onContainerMouseLeave);C(y,"mouseup",a.onDocumentMouseUp);if($a)b.ontouchstart=function(b){a.onContainerTouchStart(b)},b.ontouchmove=function(b){a.onContainerTouchMove(b)},C(y,"touchend",a.onDocumentTouchEnd)},destroy:function(){var a;U(this.chart.container,"mouseleave",this.onContainerMouseLeave);U(y,"mouseup",this.onDocumentMouseUp);U(y,"touchend",this.onDocumentTouchEnd);clearInterval(this.tooltipTimeout);for(a in this)this[a]=null}};s(Q.Pointer.prototype,{pinchTranslate:function(a,b,c,d,e,f,g,h){a&&this.pinchTranslateDirection(!0,c,d,e,f,g,h);b&&this.pinchTranslateDirection(!1,c,d,e,f,g,h)},pinchTranslateDirection:function(a,b,c,d,e,f,g,h){var i=this.chart,j=a?"x":"y",k=a?"X":"Y",l="chart"+k,m=a?"width":"height",n=i["plot"+(a?"Left":"Top")],q,o,p=h||1,t=i.inverted,r=i.bounds[a?"h":"v"],v=b.length===1,s=b[0][l],u=c[0][l],w=!v&&b[1][l],x=!v&&c[1][l],y,c=function(){!v&&N(s-w)>20&&(p=h||N(u-x)/N(s-w));o=(n-u)/p+s;q=i["plot"+(a?"Width":"Height")]/p};c();b=o;b<r.min?(b=r.min,y=!0):b+q>r.max&&(b=r.max-q,y=!0);y?(u-=.8*(u-g[j][0]),v||(x-=.8*(x-g[j][1])),c()):g[j]=[u,x];t||(f[j]=o-n,f[m]=q);f=t?1/p:p;e[m]=q;e[j]=b;d[t?a?"scaleY":"scaleX":"scale"+k]=p;d["translate"+k]=f*n+(u-f*s)},pinch:function(a){var b=this,c=b.chart,d=b.pinchDown,e=c.tooltip&&c.tooltip.options.followTouchMove,f=a.touches,g=f.length,h=b.lastValidTouch,i=b.zoomHor||b.pinchHor,j=b.zoomVert||b.pinchVert,k=i||j,l=b.selectionMarker,m={},n=g===1&&(b.inClass(a.target,"highcharts-tracker")&&c.runTrackerClick||c.runChartClick),q={};(k||e)&&!n&&a.preventDefault();Ua(f,function(a){return b.normalize(a)});if(a.type==="touchstart")p(f,function(a,b){d[b]={chartX:a.chartX,chartY:a.chartY}}),h.x=[d[0].chartX,d[1]&&d[1].chartX],h.y=[d[0].chartY,d[1]&&d[1].chartY],p(c.axes,function(a){if(a.zoomEnabled){var b=c.bounds[a.horiz?"h":"v"],d=a.minPixelPadding,e=a.toPixels(a.dataMin),f=a.toPixels(a.dataMax),g=E(e,f),e=t(e,f);b.min=E(a.pos,g-d);b.max=t(a.pos+a.len,e+d)}});else if(d.length){if(!l)b.selectionMarker=l=s({destroy:Ea},c.plotBox);b.pinchTranslate(i,j,d,f,m,l,q,h);b.hasPinched=k;b.scaleGroups(m,q);!k&&e&&g===1&&this.runPointActions(b.normalize(a))}},onContainerTouchStart:function(a){var b=this.chart;fa=b.index;a.touches.length===1?(a=this.normalize(a),b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)?(this.runPointActions(a),this.pinch(a)):this.reset()):a.touches.length===2&&this.pinch(a)},onContainerTouchMove:function(a){(a.touches.length===1||a.touches.length===2)&&this.pinch(a)},onDocumentTouchEnd:function(a){r(fa)&&Y[fa].pointer.drop(a)}});if(G.PointerEvent||G.MSPointerEvent){var ra={},zb=!!G.PointerEvent,Wb=function(){var a,b=[];b.item=function(a){return this[a]};for(a in ra)ra.hasOwnProperty(a)&&b.push({pageX:ra[a].pageX,pageY:ra[a].pageY,target:ra[a].target});return b},Ab=function(a,b,c,d){a=a.originalEvent||a;if((a.pointerType==="touch"||a.pointerType===a.MSPOINTER_TYPE_TOUCH)&&Y[fa])d(a),d=Y[fa].pointer,d[b]({type:c,target:a.currentTarget,preventDefault:Ea,touches:Wb()})};s(Wa.prototype,{onContainerPointerDown:function(a){Ab(a,"onContainerTouchStart","touchstart",function(a){ra[a.pointerId]={pageX:a.pageX,pageY:a.pageY,target:a.currentTarget}})},onContainerPointerMove:function(a){Ab(a,"onContainerTouchMove","touchmove",function(a){ra[a.pointerId]={pageX:a.pageX,pageY:a.pageY};if(!ra[a.pointerId].target)ra[a.pointerId].target=a.currentTarget})},onDocumentPointerUp:function(a){Ab(a,"onContainerTouchEnd","touchend",function(a){delete ra[a.pointerId]})},batchMSEvents:function(a){a(this.chart.container,zb?"pointerdown":"MSPointerDown",this.onContainerPointerDown);a(this.chart.container,zb?"pointermove":"MSPointerMove",this.onContainerPointerMove);a(y,zb?"pointerup":"MSPointerUp",this.onDocumentPointerUp)}});Ma(Wa.prototype,"init",function(a,b,c){D(b.container,{"-ms-touch-action":O,"touch-action":O});a.call(this,b,c)});Ma(Wa.prototype,"setDOMEvents",function(a){a.apply(this);this.batchMSEvents(C)});Ma(Wa.prototype,"destroy",function(a){this.batchMSEvents(U);a.call(this)})}var lb=Q.Legend=function(a,b){this.init(a,b)};lb.prototype={init:function(a,b){var c=this,d=b.itemStyle,e=o(b.padding,8),f=b.itemMarginTop||0;this.options=b;if(b.enabled)c.baseline=x(d.fontSize)+3+f,c.itemStyle=d,c.itemHiddenStyle=w(d,b.itemHiddenStyle),c.itemMarginTop=f,c.padding=e,c.initialItemX=e,c.initialItemY=e-5,c.maxItemWidth=0,c.chart=a,c.itemHeight=0,c.lastLineHeight=0,c.symbolWidth=o(b.symbolWidth,16),c.pages=[],c.render(),C(c.chart,"endResize",function(){c.positionCheckboxes()})},colorizeItem:function(a,b){var c=this.options,d=a.legendItem,e=a.legendLine,f=a.legendSymbol,g=this.itemHiddenStyle.color,c=b?c.itemStyle.color:g,h=b?a.legendColor||a.color||"#CCC":g,g=a.options&&a.options.marker,i={stroke:h,fill:h},j;d&&d.css({fill:c,color:c});e&&e.attr({stroke:h});if(f){if(g&&f.isMarker)for(j in g=a.convertAttribs(g),g)d=g[j],d!==u&&(i[j]=d);f.attr(i)}},positionItem:function(a){var b=this.options,c=b.symbolPadding,b=!b.rtl,d=a._legendItemPos,e=d[0],d=d[1],f=a.checkbox;a.legendGroup&&a.legendGroup.translate(b?e:this.legendWidth-e-2*c-4,d);if(f)f.x=e,f.y=d},destroyItem:function(a){var b=a.checkbox;p(["legendItem","legendLine","legendSymbol","legendGroup"],function(b){a[b]&&(a[b]=a[b].destroy())});b&&Pa(a.checkbox)},destroy:function(){var a=this.group,b=this.box;if(b)this.box=b.destroy();if(a)this.group=a.destroy()},positionCheckboxes:function(a){var b=this.group.alignAttr,c,d=this.clipHeight||this.legendHeight;if(b)c=b.translateY,p(this.allItems,function(e){var f=e.checkbox,g;f&&(g=c+f.y+(a||0)+3,D(f,{left:b.translateX+e.legendItemWidth+f.x-20+"px",top:g+"px",display:g>c-6&&g<c+d-6?"":O}))})},renderTitle:function(){var a=this.padding,b=this.options.title,c=0;if(b.text){if(!this.title)this.title=this.chart.renderer.label(b.text,a-3,a-4,null,null,null,null,null,"legend-title").attr({zIndex:1}).css(b.style).add(this.group);a=this.title.getBBox();c=a.height;this.offsetWidth=a.width;this.contentGroup.attr({translateY:c})}this.titleHeight=c},renderItem:function(a){var b=this.chart,c=b.renderer,d=this.options,e=d.layout==="horizontal",f=this.symbolWidth,g=d.symbolPadding,h=this.itemStyle,i=this.itemHiddenStyle,j=this.padding,k=e?o(d.itemDistance,8):0,l=!d.rtl,m=d.width,n=d.itemMarginBottom||0,q=this.itemMarginTop,p=this.initialItemX,r=a.legendItem,s=a.series&&a.series.drawLegendSymbol?a.series:a,u=s.options,u=this.createCheckboxForItem&&u&&u.showCheckbox,x=d.useHTML;if(!r)a.legendGroup=c.g("legend-item").attr({zIndex:1}).add(this.scrollGroup),s.drawLegendSymbol(this,a),a.legendItem=r=c.text(d.labelFormat?Ia(d.labelFormat,a):d.labelFormatter.call(a),l?f+g:-g,this.baseline,x).css(w(a.visible?h:i)).attr({align:l?"left":"right",zIndex:2}).add(a.legendGroup),this.setItemEvents&&this.setItemEvents(a,r,x,h,i),this.colorizeItem(a,a.visible),u&&this.createCheckboxForItem(a);c=r.getBBox();f=a.legendItemWidth=d.itemWidth||a.legendItemWidth||f+g+c.width+k+(u?20:0);this.itemHeight=g=v(a.legendItemHeight||c.height);if(e&&this.itemX-p+f>(m||b.chartWidth-2*j-p-d.x))this.itemX=p,this.itemY+=q+this.lastLineHeight+n,this.lastLineHeight=0;this.maxItemWidth=t(this.maxItemWidth,f);this.lastItemY=q+this.itemY+n;this.lastLineHeight=t(g,this.lastLineHeight);a._legendItemPos=[this.itemX,this.itemY];e?this.itemX+=f:(this.itemY+=q+g+n,this.lastLineHeight=g);this.offsetWidth=m||t((e?this.itemX-p-k:f)+j,this.offsetWidth)},getAllItems:function(){var a=[];p(this.chart.series,function(b){var c=b.options;if(o(c.showInLegend,!r(c.linkedTo)?u:!1,!0))a=a.concat(b.legendItems||(c.legendType==="point"?b.data:b))});return a},render:function(){var a=this,b=a.chart,c=b.renderer,d=a.group,e,f,g,h,i=a.box,j=a.options,k=a.padding,l=j.borderWidth,m=j.backgroundColor;a.itemX=a.initialItemX;a.itemY=a.initialItemY;a.offsetWidth=0;a.lastItemY=0;if(!d)a.group=d=c.g("legend").attr({zIndex:7}).add(),a.contentGroup=c.g().attr({zIndex:1}).add(d),a.scrollGroup=c.g().add(a.contentGroup);a.renderTitle();e=a.getAllItems();ob(e,function(a,b){return(a.options&&a.options.legendIndex||0)-(b.options&&b.options.legendIndex||0)});j.reversed&&e.reverse();a.allItems=e;a.display=f=!!e.length;p(e,function(b){a.renderItem(b)});g=j.width||a.offsetWidth;h=a.lastItemY+a.lastLineHeight+a.titleHeight;h=a.handleOverflow(h);if(l||m){g+=k;h+=k;if(i){if(g>0&&h>0)i[i.isNew?"attr":"animate"](i.crisp({width:g,height:h})),i.isNew=!1}else a.box=i=c.rect(0,0,g,h,j.borderRadius,l||0).attr({stroke:j.borderColor,"stroke-width":l||0,fill:m||O}).add(d).shadow(j.shadow),i.isNew=!0;i[f?"show":"hide"]()}a.legendWidth=g;a.legendHeight=h;p(e,function(b){a.positionItem(b)});f&&d.align(s({width:g,height:h},j),!0,"spacingBox");b.isResizing||this.positionCheckboxes()},handleOverflow:function(a){var b=this,c=this.chart,d=c.renderer,e=this.options,f=e.y,f=c.spacingBox.height+(e.verticalAlign==="top"?-f:f)-this.padding,g=e.maxHeight,h,i=this.clipRect,j=e.navigation,k=o(j.animation,!0),l=j.arrowSize||12,m=this.nav,n=this.pages,q,t=this.allItems;e.layout==="horizontal"&&(f/=2);g&&(f=E(f,g));n.length=0;if(a>f&&!e.useHTML){this.clipHeight=h=f-20-this.titleHeight-this.padding;this.currentPage=o(this.currentPage,1);this.fullHeight=a;p(t,function(a,b){var c=a._legendItemPos[1],d=v(a.legendItem.getBBox().height),e=n.length;if(!e||c-n[e-1]>h&&(q||c)!==n[e-1])n.push(q||c),e++;b===t.length-1&&c+d-n[e-1]>h&&n.push(c);c!==q&&(q=c)});if(!i)i=b.clipRect=d.clipRect(0,this.padding,9999,0),b.contentGroup.clip(i);i.attr({height:h});if(!m)this.nav=m=d.g().attr({zIndex:1}).add(this.group),this.up=d.symbol("triangle",0,0,l,l).on("click",function(){b.scroll(-1,k)}).add(m),this.pager=d.text("",15,10).css(j.style).add(m),this.down=d.symbol("triangle-down",0,0,l,l).on("click",function(){b.scroll(1,k)}).add(m);b.scroll(0);a=f}else if(m)i.attr({height:c.chartHeight}),m.hide(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0;return a},scroll:function(a,b){var c=this.pages,d=c.length,e=this.currentPage+a,f=this.clipHeight,g=this.options.navigation,h=g.activeColor,g=g.inactiveColor,i=this.pager,j=this.padding;e>d&&(e=d);if(e>0)b!==u&&Qa(b,this.chart),this.nav.attr({translateX:j,translateY:f+this.padding+7+this.titleHeight,visibility:"visible"}),this.up.attr({fill:e===1?g:h}).css({cursor:e===1?"default":"pointer"}),i.attr({text:e+"/"+d}),this.down.attr({x:18+this.pager.getBBox().width,fill:e===d?g:h}).css({cursor:e===d?"default":"pointer"}),c=-c[e-1]+this.initialItemY,this.scrollGroup.animate({translateY:c}),this.currentPage=e,this.positionCheckboxes(c)}};F=Q.LegendSymbolMixin={drawRectangle:function(a,b){var c=a.options.symbolHeight||12;b.legendSymbol=this.chart.renderer.rect(0,a.baseline-5-c/2,a.symbolWidth,c,o(a.options.symbolRadius,2)).attr({zIndex:3}).add(b.legendGroup)},drawLineMarker:function(a){var b=this.options,c=b.marker,d;d=a.symbolWidth;var e=this.chart.renderer,f=this.legendGroup,a=a.baseline-v(e.fontMetrics(a.options.itemStyle.fontSize).b*.3),g;if(b.lineWidth){g={"stroke-width":b.lineWidth};if(b.dashStyle)g.dashstyle=b.dashStyle;this.legendLine=e.path(["M",0,a,"L",d,a]).attr(g).add(f)}if(c&&c.enabled)b=c.radius,this.legendSymbol=d=e.symbol(this.symbol,d/2-b,a-b,2*b,2*b).add(f),d.isMarker=!0}};(/Trident\/7\.0/.test(ua)||Ta)&&Ma(lb.prototype,"positionItem",function(a,b){var c=this,d=function(){b._legendItemPos&&a.call(c,b)};c.chart.renderer.forExport?d():setTimeout(d)});Ya.prototype={init:function(a,b){var c,d=a.series;a.series=null;c=w(L,a);c.series=a.series=d;this.userOptions=a;d=c.chart;this.margin=this.splashArray("margin",d);this.spacing=this.splashArray("spacing",d);var e=d.events;this.bounds={h:{},v:{}};this.callback=b;this.isResizing=0;this.options=c;this.axes=[];this.series=[];this.hasCartesianSeries=d.showAxes;var f=this,g;f.index=Y.length;Y.push(f);d.reflow!==!1&&C(f,"load",function(){f.initReflow()});if(e)for(g in e)C(f,g,e[g]);f.xAxis=[];f.yAxis=[];f.animation=ca?!1:o(d.animation,!0);f.pointCount=0;f.counters=new Bb;f.firstRender()},initSeries:function(a){var b=this.options.chart;(b=J[a.type||b.type||b.defaultSeriesType])||oa(17,!0);b=new b;b.init(this,a);return b},isInsidePlot:function(a,b,c){var d=c?b:a,a=c?a:b;return d>=0&&d<=this.plotWidth&&a>=0&&a<=this.plotHeight},adjustTickAmounts:function(){this.options.chart.alignTicks!==!1&&p(this.axes,function(a){a.adjustTickAmount()});this.maxTicks=null},redraw:function(a){var b=this.axes,c=this.series,d=this.pointer,e=this.legend,f=this.isDirtyLegend,g,h,i=this.isDirtyBox,j=c.length,k=j,l=this.renderer,m=l.isHidden(),n=[];Qa(a,this);m&&this.cloneRenderTo();for(this.layOutTitles();k--;)if(a=c[k],a.options.stacking&&(g=!0,a.isDirty)){h=!0;break}if(h)for(k=j;k--;)if(a=c[k],a.options.stacking)a.isDirty=!0;p(c,function(a){a.isDirty&&a.options.legendType==="point"&&(f=!0)});if(f&&e.options.enabled)e.render(),this.isDirtyLegend=!1;g&&this.getStacks();if(this.hasCartesianSeries){if(!this.isResizing)this.maxTicks=null,p(b,function(a){a.setScale()});this.adjustTickAmounts();this.getMargins();p(b,function(a){a.isDirty&&(i=!0)});p(b,function(a){if(a.isDirtyExtremes)a.isDirtyExtremes=!1,n.push(function(){I(a,"afterSetExtremes",s(a.eventArgs,a.getExtremes()));delete a.eventArgs});(i||g)&&a.redraw()})}i&&this.drawChartBox();p(c,function(a){a.isDirty&&a.visible&&(!a.isCartesian||a.xAxis)&&a.redraw()});d&&d.reset(!0);l.draw();I(this,"redraw");m&&this.cloneRenderTo(!0);p(n,function(a){a.call()})},get:function(a){var b=this.axes,c=this.series,d,e;for(d=0;d<b.length;d++)if(b[d].options.id===a)return b[d];for(d=0;d<c.length;d++)if(c[d].options.id===a)return c[d];for(d=0;d<c.length;d++){e=c[d].points||[];for(b=0;b<e.length;b++)if(e[b].id===a)return e[b]}return null},getAxes:function(){var a=this,b=this.options,c=b.xAxis=na(b.xAxis||{}),b=b.yAxis=na(b.yAxis||{});p(c,function(a,b){a.index=b;a.isX=!0});p(b,function(a,b){a.index=b});c=c.concat(b);p(c,function(b){new ka(a,b)});a.adjustTickAmounts()},getSelectedPoints:function(){var a=[];p(this.series,function(b){a=a.concat(vb(b.points||[],function(a){return a.selected}))});return a},getSelectedSeries:function(){return vb(this.series,function(a){return a.selected})},getStacks:function(){var a=this;p(a.yAxis,function(a){if(a.stacks&&a.hasVisibleSeries)a.oldStacks=a.stacks});p(a.series,function(b){if(b.options.stacking&&(b.visible===!0||a.options.chart.ignoreHiddenSeries===!1))b.stackKey=b.type+o(b.options.stack,"")})},setTitle:function(a,b,c){var g;var d=this,e=d.options,f;f=e.title=w(e.title,a);g=e.subtitle=w(e.subtitle,b),e=g;p([["title",a,f],["subtitle",b,e]],function(a){var b=a[0],c=d[b],e=a[1],a=a[2];c&&e&&(d[b]=c=c.destroy());a&&a.text&&!c&&(d[b]=d.renderer.text(a.text,0,0,a.useHTML).attr({align:a.align,"class":"highcharts-"+b,zIndex:a.zIndex||4}).css(a.style).add())});d.layOutTitles(c)},layOutTitles:function(a){var b=0,c=this.title,d=this.subtitle,e=this.options,f=e.title,e=e.subtitle,g=this.spacingBox.width-44;if(c&&(c.css({width:(f.width||g)+"px"}).align(s({y:15},f),!1,"spacingBox"),!f.floating&&!f.verticalAlign))b=c.getBBox().height,b>=18&&b<=25&&(b=15);d&&(d.css({width:(e.width||g)+"px"}).align(s({y:b+f.margin},e),!1,"spacingBox"),!e.floating&&!e.verticalAlign&&(b=Ka(b+d.getBBox().height)));c=this.titleOffset!==b;this.titleOffset=b;if(!this.isDirtyBox&&c)this.isDirtyBox=c,this.hasRendered&&o(a,!0)&&this.isDirtyBox&&this.redraw()},getChartSize:function(){var a=this.options.chart,b=a.width,a=a.height,c=this.renderToClone||this.renderTo;if(!r(b))this.containerWidth=ib(c,"width");if(!r(a))this.containerHeight=ib(c,"height");this.chartWidth=t(0,b||this.containerWidth||600);this.chartHeight=t(0,o(a,this.containerHeight>19?this.containerHeight:400))},cloneRenderTo:function(a){var b=this.renderToClone,c=this.container;a?b&&(this.renderTo.appendChild(c),Pa(b),delete this.renderToClone):(c&&c.parentNode===this.renderTo&&this.renderTo.removeChild(c),this.renderToClone=b=this.renderTo.cloneNode(0),D(b,{position:"absolute",top:"-9999px",display:"block"}),b.style.setProperty&&b.style.setProperty("display","block","important"),y.body.appendChild(b),c&&b.appendChild(c))},getContainer:function(){var a,b=this.options.chart,c,d,e;this.renderTo=a=b.renderTo;e="highcharts-"+tb++;if(ga(a))this.renderTo=a=y.getElementById(a);a||oa(13,!0);c=x(z(a,"data-highcharts-chart"));!isNaN(c)&&Y[c]&&Y[c].hasRendered&&Y[c].destroy();z(a,"data-highcharts-chart",this.index);a.innerHTML="";!b.skipClone&&!a.offsetWidth&&this.cloneRenderTo();this.getChartSize();c=this.chartWidth;d=this.chartHeight;this.container=a=V(Ja,{className:"highcharts-container"+(b.className?" "+b.className:""),id:e},s({position:"relative",overflow:"hidden",width:c+"px",height:d+"px",textAlign:"left",lineHeight:"normal",zIndex:0,"-webkit-tap-highlight-color":"rgba(0,0,0,0)"},b.style),this.renderToClone||a);this._cursor=a.style.cursor;this.renderer=b.forExport?new pa(a,c,d,b.style,!0):new Za(a,c,d,b.style);ca&&this.renderer.create(this,a,c,d)},getMargins:function(){var a=this.spacing,b,c=this.legend,d=this.margin,e=this.options.legend,f=o(e.margin,10),g=e.x,h=e.y,i=e.align,j=e.verticalAlign,k=this.titleOffset;this.resetMargins();b=this.axisOffset;if(k&&!r(d[0]))this.plotTop=t(this.plotTop,k+this.options.title.margin+a[0]);if(c.display&&!e.floating)if(i==="right"){if(!r(d[1]))this.marginRight=t(this.marginRight,c.legendWidth-g+f+a[1])}else if(i==="left"){if(!r(d[3]))this.plotLeft=t(this.plotLeft,c.legendWidth+g+f+a[3])
}else if(j==="top"){if(!r(d[0]))this.plotTop=t(this.plotTop,c.legendHeight+h+f+a[0])}else if(j==="bottom"&&!r(d[2]))this.marginBottom=t(this.marginBottom,c.legendHeight-h+f+a[2]);this.extraBottomMargin&&(this.marginBottom+=this.extraBottomMargin);this.extraTopMargin&&(this.plotTop+=this.extraTopMargin);this.hasCartesianSeries&&p(this.axes,function(a){a.getOffset()});r(d[3])||(this.plotLeft+=b[3]);r(d[0])||(this.plotTop+=b[0]);r(d[2])||(this.marginBottom+=b[2]);r(d[1])||(this.marginRight+=b[1]);this.setChartSize()},reflow:function(a){var b=this,c=b.options.chart,d=b.renderTo,e=c.width||ib(d,"width"),f=c.height||ib(d,"height"),c=a?a.target:G,d=function(){if(b.container)b.setSize(e,f,!1),b.hasUserSize=null};if(!b.hasUserSize&&e&&f&&(c===G||c===y)){if(e!==b.containerWidth||f!==b.containerHeight)clearTimeout(b.reflowTimeout),a?b.reflowTimeout=setTimeout(d,100):d();b.containerWidth=e;b.containerHeight=f}},initReflow:function(){var a=this,b=function(b){a.reflow(b)};C(G,"resize",b);C(a,"destroy",function(){U(G,"resize",b)})},setSize:function(a,b,c){var d=this,e,f,g;d.isResizing+=1;g=function(){d&&I(d,"endResize",null,function(){d.isResizing-=1})};Qa(c,d);d.oldChartHeight=d.chartHeight;d.oldChartWidth=d.chartWidth;if(r(a))d.chartWidth=e=t(0,v(a)),d.hasUserSize=!!e;if(r(b))d.chartHeight=f=t(0,v(b));(sa?jb:D)(d.container,{width:e+"px",height:f+"px"},sa);d.setChartSize(!0);d.renderer.setSize(e,f,c);d.maxTicks=null;p(d.axes,function(a){a.isDirty=!0;a.setScale()});p(d.series,function(a){a.isDirty=!0});d.isDirtyLegend=!0;d.isDirtyBox=!0;d.getMargins();d.redraw(c);d.oldChartHeight=null;I(d,"resize");sa===!1?g():setTimeout(g,sa&&sa.duration||500)},setChartSize:function(a){var b=this.inverted,c=this.renderer,d=this.chartWidth,e=this.chartHeight,f=this.options.chart,g=this.spacing,h=this.clipOffset,i,j,k,l;this.plotLeft=i=v(this.plotLeft);this.plotTop=j=v(this.plotTop);this.plotWidth=k=t(0,v(d-i-this.marginRight));this.plotHeight=l=t(0,v(e-j-this.marginBottom));this.plotSizeX=b?l:k;this.plotSizeY=b?k:l;this.plotBorderWidth=f.plotBorderWidth||0;this.spacingBox=c.spacingBox={x:g[3],y:g[0],width:d-g[3]-g[1],height:e-g[0]-g[2]};this.plotBox=c.plotBox={x:i,y:j,width:k,height:l};d=2*S(this.plotBorderWidth/2);b=Ka(t(d,h[3])/2);c=Ka(t(d,h[0])/2);this.clipBox={x:b,y:c,width:S(this.plotSizeX-t(d,h[1])/2-b),height:S(this.plotSizeY-t(d,h[2])/2-c)};a||p(this.axes,function(a){a.setAxisSize();a.setAxisTranslation()})},resetMargins:function(){var a=this.spacing,b=this.margin;this.plotTop=o(b[0],a[0]);this.marginRight=o(b[1],a[1]);this.marginBottom=o(b[2],a[2]);this.plotLeft=o(b[3],a[3]);this.axisOffset=[0,0,0,0];this.clipOffset=[0,0,0,0]},drawChartBox:function(){var a=this.options.chart,b=this.renderer,c=this.chartWidth,d=this.chartHeight,e=this.chartBackground,f=this.plotBackground,g=this.plotBorder,h=this.plotBGImage,i=a.borderWidth||0,j=a.backgroundColor,k=a.plotBackgroundColor,l=a.plotBackgroundImage,m=a.plotBorderWidth||0,n,q=this.plotLeft,o=this.plotTop,p=this.plotWidth,t=this.plotHeight,r=this.plotBox,s=this.clipRect,v=this.clipBox;n=i+(a.shadow?8:0);if(i||j)if(e)e.animate(e.crisp({width:c-n,height:d-n}));else{e={fill:j||O};if(i)e.stroke=a.borderColor,e["stroke-width"]=i;this.chartBackground=b.rect(n/2,n/2,c-n,d-n,a.borderRadius,i).attr(e).addClass("highcharts-background").add().shadow(a.shadow)}if(k)f?f.animate(r):this.plotBackground=b.rect(q,o,p,t,0).attr({fill:k}).add().shadow(a.plotShadow);if(l)h?h.animate(r):this.plotBGImage=b.image(l,q,o,p,t).add();s?s.animate({width:v.width,height:v.height}):this.clipRect=b.clipRect(v);if(m)g?g.animate(g.crisp({x:q,y:o,width:p,height:t})):this.plotBorder=b.rect(q,o,p,t,0,-m).attr({stroke:a.plotBorderColor,"stroke-width":m,fill:O,zIndex:1}).add();this.isDirtyBox=!1},propFromSeries:function(){var a=this,b=a.options.chart,c,d=a.options.series,e,f;p(["inverted","angular","polar"],function(g){c=J[b.type||b.defaultSeriesType];f=a[g]||b[g]||c&&c.prototype[g];for(e=d&&d.length;!f&&e--;)(c=J[d[e].type])&&c.prototype[g]&&(f=!0);a[g]=f})},linkSeries:function(){var a=this,b=a.series;p(b,function(a){a.linkedSeries.length=0});p(b,function(b){var d=b.options.linkedTo;if(ga(d)&&(d=d===":previous"?a.series[b.index-1]:a.get(d)))d.linkedSeries.push(b),b.linkedParent=d})},renderSeries:function(){p(this.series,function(a){a.translate();a.setTooltipPoints&&a.setTooltipPoints();a.render()})},render:function(){var a=this,b=a.axes,c=a.renderer,d=a.options,e=d.labels,f=d.credits,g;a.setTitle();a.legend=new lb(a,d.legend);a.getStacks();p(b,function(a){a.setScale()});a.getMargins();a.maxTicks=null;p(b,function(a){a.setTickPositions(!0);a.setMaxTicks()});a.adjustTickAmounts();a.getMargins();a.drawChartBox();a.hasCartesianSeries&&p(b,function(a){a.render()});if(!a.seriesGroup)a.seriesGroup=c.g("series-group").attr({zIndex:3}).add();a.renderSeries();e.items&&p(e.items,function(b){var d=s(e.style,b.style),f=x(d.left)+a.plotLeft,g=x(d.top)+a.plotTop+12;delete d.left;delete d.top;c.text(b.html,f,g).attr({zIndex:2}).css(d).add()});if(f.enabled&&!a.credits)g=f.href,a.credits=c.text(f.text,0,0).on("click",function(){if(g)location.href=g}).attr({align:f.position.align,zIndex:8}).css(f.style).add().align(f.position);a.hasRendered=!0},destroy:function(){var a=this,b=a.axes,c=a.series,d=a.container,e,f=d&&d.parentNode;I(a,"destroy");Y[a.index]=u;a.renderTo.removeAttribute("data-highcharts-chart");U(a);for(e=b.length;e--;)b[e]=b[e].destroy();for(e=c.length;e--;)c[e]=c[e].destroy();p("title,subtitle,chartBackground,plotBackground,plotBGImage,plotBorder,seriesGroup,clipRect,credits,pointer,scroller,rangeSelector,legend,resetZoomButton,tooltip,renderer".split(","),function(b){var c=a[b];c&&c.destroy&&(a[b]=c.destroy())});if(d)d.innerHTML="",U(d),f&&Pa(d);for(e in a)delete a[e]},isReadyToRender:function(){var a=this;return!X&&G==G.top&&y.readyState!=="complete"||ca&&!G.canvg?(ca?Mb.push(function(){a.firstRender()},a.options.global.canvasToolsURL):y.attachEvent("onreadystatechange",function(){y.detachEvent("onreadystatechange",a.firstRender);y.readyState==="complete"&&a.firstRender()}),!1):!0},firstRender:function(){var a=this,b=a.options,c=a.callback;if(a.isReadyToRender()){a.getContainer();I(a,"init");a.resetMargins();a.setChartSize();a.propFromSeries();a.getAxes();p(b.series||[],function(b){a.initSeries(b)});a.linkSeries();I(a,"beforeRender");if(Q.Pointer)a.pointer=new Wa(a,b);a.render();a.renderer.draw();c&&c.apply(a,[a]);p(a.callbacks,function(b){b.apply(a,[a])});a.cloneRenderTo(!0);I(a,"load")}},splashArray:function(a,b){var c=b[a],c=$(c)?c:[c,c,c,c];return[o(b[a+"Top"],c[0]),o(b[a+"Right"],c[1]),o(b[a+"Bottom"],c[2]),o(b[a+"Left"],c[3])]}};Ya.prototype.callbacks=[];da=Q.CenteredSeriesMixin={getCenter:function(){var a=this.options,b=this.chart,c=2*(a.slicedOffset||0),d,e=b.plotWidth-2*c,f=b.plotHeight-2*c,b=a.center,a=[o(b[0],"50%"),o(b[1],"50%"),a.size||"100%",a.innerSize||0],g=E(e,f),h;return Ua(a,function(a,b){h=/%$/.test(a);d=b<2||b===2&&h;return(h?[e,f,g,g][b]*x(a)/100:a)+(d?c:0)})}};var Fa=function(){};Fa.prototype={init:function(a,b,c){this.series=a;this.applyOptions(b,c);this.pointAttr={};if(a.options.colorByPoint&&(b=a.options.colors||a.chart.options.colors,this.color=this.color||b[a.colorCounter++],a.colorCounter===b.length))a.colorCounter=0;a.chart.pointCount++;return this},applyOptions:function(a,b){var c=this.series,d=c.pointValKey,a=Fa.prototype.optionsToObject.call(this,a);s(this,a);this.options=this.options?s(this.options,a):a;if(d)this.y=this[d];if(this.x===u&&c)this.x=b===u?c.autoIncrement():b;return this},optionsToObject:function(a){var b={},c=this.series,d=c.pointArrayMap||["y"],e=d.length,f=0,g=0;if(typeof a==="number"||a===null)b[d[0]]=a;else if(La(a)){if(a.length>e){c=typeof a[0];if(c==="string")b.name=a[0];else if(c==="number")b.x=a[0];f++}for(;g<e;)b[d[g++]]=a[f++]}else if(typeof a==="object"){b=a;if(a.dataLabels)c._hasPointLabels=!0;if(a.marker)c._hasPointMarkers=!0}return b},destroy:function(){var a=this.series.chart,b=a.hoverPoints,c;a.pointCount--;if(b&&(this.setState(),ia(b,this),!b.length))a.hoverPoints=null;if(this===a.hoverPoint)this.onMouseOut();if(this.graphic||this.dataLabel)U(this),this.destroyElements();this.legendItem&&a.legend.destroyItem(this);for(c in this)this[c]=null},destroyElements:function(){for(var a="graphic,dataLabel,dataLabelUpper,group,connector,shadowGroup".split(","),b,c=6;c--;)b=a[c],this[b]&&(this[b]=this[b].destroy())},getLabelConfig:function(){return{x:this.category,y:this.y,key:this.name||this.category,series:this.series,point:this,percentage:this.percentage,total:this.total||this.stackTotal}},tooltipFormatter:function(a){var b=this.series,c=b.tooltipOptions,d=o(c.valueDecimals,""),e=c.valuePrefix||"",f=c.valueSuffix||"";p(b.pointArrayMap||["y"],function(b){b="{point."+b;if(e||f)a=a.replace(b+"}",e+b+"}"+f);a=a.replace(b+"}",b+":,."+d+"f}")});return Ia(a,{point:this,series:this.series})}};var M=function(){};M.prototype={isCartesian:!0,type:"line",pointClass:Fa,sorted:!0,requireSorting:!0,pointAttrToOptions:{stroke:"lineColor","stroke-width":"lineWidth",fill:"fillColor",r:"radius"},axisTypes:["xAxis","yAxis"],colorCounter:0,parallelArrays:["x","y"],init:function(a,b){var c=this,d,e,f=a.series,g=function(a,b){return o(a.options.index,a._i)-o(b.options.index,b._i)};c.chart=a;c.options=b=c.setOptions(b);c.linkedSeries=[];c.bindAxes();s(c,{name:b.name,state:"",pointAttr:{},visible:b.visible!==!1,selected:b.selected===!0});if(ca)b.animation=!1;e=b.events;for(d in e)C(c,d,e[d]);if(e&&e.click||b.point&&b.point.events&&b.point.events.click||b.allowPointSelect)a.runTrackerClick=!0;c.getColor();c.getSymbol();p(c.parallelArrays,function(a){c[a+"Data"]=[]});c.setData(b.data,!1);if(c.isCartesian)a.hasCartesianSeries=!0;f.push(c);c._i=f.length-1;ob(f,g);this.yAxis&&ob(this.yAxis.series,g);p(f,function(a,b){a.index=b;a.name=a.name||"Series "+(b+1)})},bindAxes:function(){var a=this,b=a.options,c=a.chart,d;p(a.axisTypes||[],function(e){p(c[e],function(c){d=c.options;if(b[e]===d.index||b[e]!==u&&b[e]===d.id||b[e]===u&&d.index===0)c.series.push(a),a[e]=c,c.isDirty=!0});!a[e]&&a.optionalAxis!==e&&oa(18,!0)})},updateParallelArrays:function(a,b){var c=a.series,d=arguments;p(c.parallelArrays,typeof b==="number"?function(d){var f=d==="y"&&c.toYData?c.toYData(a):a[d];c[d+"Data"][b]=f}:function(a){Array.prototype[b].apply(c[a+"Data"],Array.prototype.slice.call(d,2))})},autoIncrement:function(){var a=this.options,b=this.xIncrement,b=o(b,a.pointStart,0);this.pointInterval=o(this.pointInterval,a.pointInterval,1);this.xIncrement=b+this.pointInterval;return b},getSegments:function(){var a=-1,b=[],c,d=this.points,e=d.length;if(e)if(this.options.connectNulls){for(c=e;c--;)d[c].y===null&&d.splice(c,1);d.length&&(b=[d])}else p(d,function(c,g){c.y===null?(g>a+1&&b.push(d.slice(a+1,g)),a=g):g===e-1&&b.push(d.slice(a+1,g+1))});this.segments=b},setOptions:function(a){var b=this.chart,c=b.options.plotOptions,b=b.userOptions||{},d=b.plotOptions||{},e=c[this.type];this.userOptions=a;c=w(e,c.series,a);this.tooltipOptions=w(L.tooltip,L.plotOptions[this.type].tooltip,b.tooltip,d.series&&d.series.tooltip,d[this.type]&&d[this.type].tooltip,a.tooltip);e.marker===null&&delete c.marker;return c},getColor:function(){var a=this.options,b=this.userOptions,c=this.chart.options.colors,d=this.chart.counters,e;e=a.color||Z[this.type].color;if(!e&&!a.colorByPoint)r(b._colorIndex)?a=b._colorIndex:(b._colorIndex=d.color,a=d.color++),e=c[a];this.color=e;d.wrapColor(c.length)},getSymbol:function(){var a=this.userOptions,b=this.options.marker,c=this.chart,d=c.options.symbols,c=c.counters;this.symbol=b.symbol;if(!this.symbol)r(a._symbolIndex)?a=a._symbolIndex:(a._symbolIndex=c.symbol,a=c.symbol++),this.symbol=d[a];if(/^url/.test(this.symbol))b.radius=0;c.wrapSymbol(d.length)},drawLegendSymbol:F.drawLineMarker,setData:function(a,b,c,d){var e=this,f=e.points,g=f&&f.length||0,h,i=e.options,j=e.chart,k=null,l=e.xAxis,m=l&&!!l.categories,n=e.tooltipPoints,q=i.turboThreshold,t=this.xData,r=this.yData,s=(h=e.pointArrayMap)&&h.length,a=a||[];h=a.length;b=o(b,!0);if(d!==!1&&h&&g===h&&!e.cropped&&!e.hasGroupedData)p(a,function(a,b){f[b].update(a,!1)});else{e.xIncrement=null;e.pointRange=m?1:i.pointRange;e.colorCounter=0;p(this.parallelArrays,function(a){e[a+"Data"].length=0});if(q&&h>q){for(c=0;k===null&&c<h;)k=a[c],c++;if(ya(k)){m=o(i.pointStart,0);i=o(i.pointInterval,1);for(c=0;c<h;c++)t[c]=m,r[c]=a[c],m+=i;e.xIncrement=m}else if(La(k))if(s)for(c=0;c<h;c++)i=a[c],t[c]=i[0],r[c]=i.slice(1,s+1);else for(c=0;c<h;c++)i=a[c],t[c]=i[0],r[c]=i[1];else oa(12)}else for(c=0;c<h;c++)if(a[c]!==u&&(i={series:e},e.pointClass.prototype.applyOptions.apply(i,[a[c]]),e.updateParallelArrays(i,c),m&&i.name))l.names[i.x]=i.name;ga(r[0])&&oa(14,!0);e.data=[];e.options.data=a;for(c=g;c--;)f[c]&&f[c].destroy&&f[c].destroy();if(n)n.length=0;if(l)l.minRange=l.userMinRange;e.isDirty=e.isDirtyData=j.isDirtyBox=!0;c=!1}b&&j.redraw(c)},processData:function(a){var b=this.xData,c=this.yData,d=b.length,e;e=0;var f,g,h=this.xAxis,i=this.options,j=i.cropThreshold,k=this.isCartesian;if(k&&!this.isDirty&&!h.isDirty&&!this.yAxis.isDirty&&!a)return!1;if(k&&this.sorted&&(!j||d>j||this.forceCrop))if(a=h.min,h=h.max,b[d-1]<a||b[0]>h)b=[],c=[];else if(b[0]<a||b[d-1]>h)e=this.cropData(this.xData,this.yData,a,h),b=e.xData,c=e.yData,e=e.start,f=!0;for(h=b.length-1;h>=0;h--)d=b[h]-b[h-1],d>0&&(g===u||d<g)?g=d:d<0&&this.requireSorting&&oa(15);this.cropped=f;this.cropStart=e;this.processedXData=b;this.processedYData=c;if(i.pointRange===null)this.pointRange=g||1;this.closestPointRange=g},cropData:function(a,b,c,d){var e=a.length,f=0,g=e,h=o(this.cropShoulder,1),i;for(i=0;i<e;i++)if(a[i]>=c){f=t(0,i-h);break}for(;i<e;i++)if(a[i]>d){g=i+h;break}return{xData:a.slice(f,g),yData:b.slice(f,g),start:f,end:g}},generatePoints:function(){var a=this.options.data,b=this.data,c,d=this.processedXData,e=this.processedYData,f=this.pointClass,g=d.length,h=this.cropStart||0,i,j=this.hasGroupedData,k,l=[],m;if(!b&&!j)b=[],b.length=a.length,b=this.data=b;for(m=0;m<g;m++)i=h+m,j?l[m]=(new f).init(this,[d[m]].concat(na(e[m]))):(b[i]?k=b[i]:a[i]!==u&&(b[i]=k=(new f).init(this,a[i],d[m])),l[m]=k);if(b&&(g!==(c=b.length)||j))for(m=0;m<c;m++)if(m===h&&!j&&(m+=g),b[m])b[m].destroyElements(),b[m].plotX=u;this.data=b;this.points=l},getExtremes:function(a){var b=this.yAxis,c=this.processedXData,d,e=[],f=0;d=this.xAxis.getExtremes();var g=d.min,h=d.max,i,j,k,l,a=a||this.stackedYData||this.processedYData;d=a.length;for(l=0;l<d;l++)if(j=c[l],k=a[l],i=k!==null&&k!==u&&(!b.isLog||k.length||k>0),j=this.getExtremesFromAll||this.cropped||(c[l+1]||j)>=g&&(c[l-1]||j)<=h,i&&j)if(i=k.length)for(;i--;)k[i]!==null&&(e[f++]=k[i]);else e[f++]=k;this.dataMin=o(void 0,Na(e));this.dataMax=o(void 0,Ba(e))},translate:function(){this.processedXData||this.processData();this.generatePoints();for(var a=this.options,b=a.stacking,c=this.xAxis,d=c.categories,e=this.yAxis,f=this.points,g=f.length,h=!!this.modifyValue,i=a.pointPlacement,j=i==="between"||ya(i),k=a.threshold,a=0;a<g;a++){var l=f[a],m=l.x,n=l.y,q=l.low,p=b&&e.stacks[(this.negStacks&&n<k?"-":"")+this.stackKey];if(e.isLog&&n<=0)l.y=n=null;l.plotX=c.translate(m,0,0,0,1,i,this.type==="flags");if(b&&this.visible&&p&&p[m])p=p[m],n=p.points[this.index],q=n[0],n=n[1],q===0&&(q=o(k,e.min)),e.isLog&&q<=0&&(q=null),l.total=l.stackTotal=p.total,l.percentage=p.total&&l.y/p.total*100,l.stackY=n,p.setOffset(this.pointXOffset||0,this.barW||0);l.yBottom=r(q)?e.translate(q,0,1,0,1):null;h&&(n=this.modifyValue(n,l));l.plotY=typeof n==="number"&&n!==Infinity?e.translate(n,0,1,0,1):u;l.clientX=j?c.translate(m,0,0,0,1):l.plotX;l.negative=l.y<(k||0);l.category=d&&d[l.x]!==u?d[l.x]:l.x}this.getSegments()},animate:function(a){var b=this,c=b.chart,d=c.renderer,e;e=b.options.animation;var f=c.clipBox,g=c.inverted,h;if(e&&!$(e))e=Z[b.type].animation;h="_sharedClip"+e.duration+e.easing;if(a)a=c[h],e=c[h+"m"],a||(c[h]=a=d.clipRect(s(f,{width:0})),c[h+"m"]=e=d.clipRect(-99,g?-c.plotLeft:-c.plotTop,99,g?c.chartWidth:c.chartHeight)),b.group.clip(a),b.markerGroup.clip(e),b.sharedClipKey=h;else{if(a=c[h])a.animate({width:c.plotSizeX},e),c[h+"m"].animate({width:c.plotSizeX+99},e);b.animate=null;b.animationTimeout=setTimeout(function(){b.afterAnimate()},e.duration)}},afterAnimate:function(){var a=this.chart,b=this.sharedClipKey,c=this.group;c&&this.options.clip!==!1&&(c.clip(a.clipRect),this.markerGroup.clip());setTimeout(function(){b&&a[b]&&(a[b]=a[b].destroy(),a[b+"m"]=a[b+"m"].destroy())},100)},drawPoints:function(){var a,b=this.points,c=this.chart,d,e,f,g,h,i,j,k,l=this.options.marker,m=this.pointAttr[""],n,q=this.markerGroup;if(l.enabled||this._hasPointMarkers)for(f=b.length;f--;)if(g=b[f],d=S(g.plotX),e=g.plotY,k=g.graphic,i=g.marker||{},a=l.enabled&&i.enabled===u||i.enabled,n=c.isInsidePlot(v(d),e,c.inverted),a&&e!==u&&!isNaN(e)&&g.y!==null)if(a=g.pointAttr[g.selected?"select":""]||m,h=a.r,i=o(i.symbol,this.symbol),j=i.indexOf("url")===0,k)k.attr({visibility:n?"inherit":"hidden"}).animate(s({x:d-h,y:e-h},k.symbolName?{width:2*h,height:2*h}:{}));else{if(n&&(h>0||j))g.graphic=c.renderer.symbol(i,d-h,e-h,2*h,2*h).attr(a).add(q)}else if(k)g.graphic=k.destroy()},convertAttribs:function(a,b,c,d){var e=this.pointAttrToOptions,f,g,h={},a=a||{},b=b||{},c=c||{},d=d||{};for(f in e)g=e[f],h[f]=o(a[g],b[f],c[f],d[f]);return h},getAttribs:function(){var a=this,b=a.options,c=Z[a.type].marker?b.marker:b,d=c.states,e=d.hover,f,g=a.color;f={stroke:g,fill:g};var h=a.points||[],i,j=[],k,l=a.pointAttrToOptions;k=a.hasPointSpecificOptions;var m=b.negativeColor,n=c.lineColor,q=c.fillColor;i=b.turboThreshold;var o;b.marker?(e.radius=e.radius||c.radius+2,e.lineWidth=e.lineWidth||c.lineWidth+1):e.color=e.color||wa(e.color||g).brighten(e.brightness).get();j[""]=a.convertAttribs(c,f);p(["hover","select"],function(b){j[b]=a.convertAttribs(d[b],j[""])});a.pointAttr=j;g=h.length;if(!i||g<i||k)for(;g--;){i=h[g];if((c=i.options&&i.options.marker||i.options)&&c.enabled===!1)c.radius=0;if(i.negative&&m)i.color=i.fillColor=m;k=b.colorByPoint||i.color;if(i.options)for(o in l)r(c[l[o]])&&(k=!0);if(k){c=c||{};k=[];d=c.states||{};f=d.hover=d.hover||{};if(!b.marker)f.color=f.color||!i.options.color&&e.color||wa(i.color).brighten(f.brightness||e.brightness).get();f={color:i.color};if(!q)f.fillColor=i.color;if(!n)f.lineColor=i.color;k[""]=a.convertAttribs(s(f,c),j[""]);k.hover=a.convertAttribs(d.hover,j.hover,k[""]);k.select=a.convertAttribs(d.select,j.select,k[""])}else k=j;i.pointAttr=k}},destroy:function(){var a=this,b=a.chart,c=/AppleWebKit\/533/.test(ua),d,e,f=a.data||[],g,h,i;I(a,"destroy");U(a);p(a.axisTypes||[],function(b){if(i=a[b])ia(i.series,a),i.isDirty=i.forceRedraw=!0});a.legendItem&&a.chart.legend.destroyItem(a);for(e=f.length;e--;)(g=f[e])&&g.destroy&&g.destroy();a.points=null;clearTimeout(a.animationTimeout);p("area,graph,dataLabelsGroup,group,markerGroup,tracker,graphNeg,areaNeg,posClip,negClip".split(","),function(b){a[b]&&(d=c&&b==="group"?"hide":"destroy",a[b][d]())});if(b.hoverSeries===a)b.hoverSeries=null;ia(b.series,a);for(h in a)delete a[h]},getSegmentPath:function(a){var b=this,c=[],d=b.options.step;p(a,function(e,f){var g=e.plotX,h=e.plotY,i;b.getPointSpline?c.push.apply(c,b.getPointSpline(a,e,f)):(c.push(f?"L":"M"),d&&f&&(i=a[f-1],d==="right"?c.push(i.plotX,h):d==="center"?c.push((i.plotX+g)/2,i.plotY,(i.plotX+g)/2,h):c.push(g,i.plotY)),c.push(e.plotX,e.plotY))});return c},getGraphPath:function(){var a=this,b=[],c,d=[];p(a.segments,function(e){c=a.getSegmentPath(e);e.length>1?b=b.concat(c):d.push(e[0])});a.singlePoints=d;return a.graphPath=b},drawGraph:function(){var a=this,b=this.options,c=[["graph",b.lineColor||this.color]],d=b.lineWidth,e=b.dashStyle,f=b.linecap!=="square",g=this.getGraphPath(),h=b.negativeColor;h&&c.push(["graphNeg",h]);p(c,function(c,h){var k=c[0],l=a[k];if(l)ab(l),l.animate({d:g});else if(d&&g.length)l={stroke:c[1],"stroke-width":d,fill:O,zIndex:1},e?l.dashstyle=e:f&&(l["stroke-linecap"]=l["stroke-linejoin"]="round"),a[k]=a.chart.renderer.path(g).attr(l).add(a.group).shadow(!h&&b.shadow)})},clipNeg:function(){var a=this.options,b=this.chart,c=b.renderer,d=a.negativeColor||a.negativeFillColor,e,f=this.graph,g=this.area,h=this.posClip,i=this.negClip;e=b.chartWidth;var j=b.chartHeight,k=t(e,j),l=this.yAxis;if(d&&(f||g)){d=v(l.toPixels(a.threshold||0,!0));d<0&&(k-=d);a={x:0,y:0,width:k,height:d};k={x:0,y:d,width:k,height:k};if(b.inverted)a.height=k.y=b.plotWidth-d,c.isVML&&(a={x:b.plotWidth-d-b.plotLeft,y:0,width:e,height:j},k={x:d+b.plotLeft-e,y:0,width:b.plotLeft+d,height:e});l.reversed?(b=k,e=a):(b=a,e=k);h?(h.animate(b),i.animate(e)):(this.posClip=h=c.clipRect(b),this.negClip=i=c.clipRect(e),f&&this.graphNeg&&(f.clip(h),this.graphNeg.clip(i)),g&&(g.clip(h),this.areaNeg.clip(i)))}},invertGroups:function(){function a(){var a={width:b.yAxis.len,height:b.xAxis.len};p(["group","markerGroup"],function(c){b[c]&&b[c].attr(a).invert()})}var b=this,c=b.chart;if(b.xAxis)C(c,"resize",a),C(b,"destroy",function(){U(c,"resize",a)}),a(),b.invertGroups=a},plotGroup:function(a,b,c,d,e){var f=this[a],g=!f;g&&(this[a]=f=this.chart.renderer.g(b).attr({visibility:c,zIndex:d||.1}).add(e));f[g?"attr":"animate"](this.getPlotBox());return f},getPlotBox:function(){return{translateX:this.xAxis?this.xAxis.left:this.chart.plotLeft,translateY:this.yAxis?this.yAxis.top:this.chart.plotTop,scaleX:1,scaleY:1}},render:function(){var a=this.chart,b,c=this.options,d=c.animation&&!!this.animate&&a.renderer.isSVG,e=this.visible?"visible":"hidden",f=c.zIndex,g=this.hasRendered,h=a.seriesGroup;b=this.plotGroup("group","series",e,f,h);this.markerGroup=this.plotGroup("markerGroup","markers",e,f,h);d&&this.animate(!0);this.getAttribs();b.inverted=this.isCartesian?a.inverted:!1;this.drawGraph&&(this.drawGraph(),this.clipNeg());this.drawDataLabels&&this.drawDataLabels();this.visible&&this.drawPoints();this.drawTracker&&this.options.enableMouseTracking!==!1&&this.drawTracker();a.inverted&&this.invertGroups();c.clip!==!1&&!this.sharedClipKey&&!g&&b.clip(a.clipRect);d?this.animate():g||this.afterAnimate();this.isDirty=this.isDirtyData=!1;this.hasRendered=!0},redraw:function(){var a=this.chart,b=this.isDirtyData,c=this.group,d=this.xAxis,e=this.yAxis;c&&(a.inverted&&c.attr({width:a.plotWidth,height:a.plotHeight}),c.animate({translateX:o(d&&d.left,a.plotLeft),translateY:o(e&&e.top,a.plotTop)}));this.translate();this.setTooltipPoints(!0);this.render();b&&I(this,"updatedData")}};Hb.prototype={destroy:function(){Oa(this,this.axis)},render:function(a){var b=this.options,c=b.format,c=c?Ia(c,this):b.formatter.call(this);this.label?this.label.attr({text:c,visibility:"hidden"}):this.label=this.axis.chart.renderer.text(c,0,0,b.useHTML).css(b.style).attr({align:this.textAlign,rotation:b.rotation,visibility:"hidden"}).add(a)},setOffset:function(a,b){var c=this.axis,d=c.chart,e=d.inverted,f=this.isNegative,g=c.translate(this.percent?100:this.total,0,0,0,1),c=c.translate(0),c=N(g-c),h=d.xAxis[0].translate(this.x)+a,i=d.plotHeight,f={x:e?f?g:g-c:h,y:e?i-h-b:f?i-g-c:i-g,width:e?c:b,height:e?b:c};if(e=this.label)e.align(this.alignOptions,null,f),f=e.alignAttr,e[this.options.crop===!1||d.isInsidePlot(f.x,f.y)?"show":"hide"](!0)}};ka.prototype.buildStacks=function(){var a=this.series,b=o(this.options.reversedStacks,!0),c=a.length;if(!this.isXAxis){for(this.usePercentage=!1;c--;)a[b?c:a.length-c-1].setStackedPoints();if(this.usePercentage)for(c=0;c<a.length;c++)a[c].setPercentStacks()}};ka.prototype.renderStackTotals=function(){var a=this.chart,b=a.renderer,c=this.stacks,d,e,f=this.stackTotalGroup;if(!f)this.stackTotalGroup=f=b.g("stack-labels").attr({visibility:"visible",zIndex:6}).add();f.translate(a.plotLeft,a.plotTop);for(d in c)for(e in a=c[d],a)a[e].render(f)};M.prototype.setStackedPoints=function(){if(this.options.stacking&&!(this.visible!==!0&&this.chart.options.chart.ignoreHiddenSeries!==!1)){var a=this.processedXData,b=this.processedYData,c=[],d=b.length,e=this.options,f=e.threshold,g=e.stack,e=e.stacking,h=this.stackKey,i="-"+h,j=this.negStacks,k=this.yAxis,l=k.stacks,m=k.oldStacks,n,q,o,p,r;for(o=0;o<d;o++){p=a[o];r=b[o];q=(n=j&&r<f)?i:h;l[q]||(l[q]={});if(!l[q][p])m[q]&&m[q][p]?(l[q][p]=m[q][p],l[q][p].total=null):l[q][p]=new Hb(k,k.options.stackLabels,n,p,g,e);q=l[q][p];q.points[this.index]=[q.cum||0];e==="percent"?(n=n?h:i,j&&l[n]&&l[n][p]?(n=l[n][p],q.total=n.total=t(n.total,q.total)+N(r)||0):q.total=aa(q.total+(N(r)||0))):q.total=aa(q.total+(r||0));q.cum=(q.cum||0)+(r||0);q.points[this.index].push(q.cum);c[o]=q.cum}if(e==="percent")k.usePercentage=!0;this.stackedYData=c;k.oldStacks={}}};M.prototype.setPercentStacks=function(){var a=this,b=a.stackKey,c=a.yAxis.stacks,d=a.processedXData;p([b,"-"+b],function(b){var e;for(var f=d.length,g,h;f--;)if(g=d[f],e=(h=c[b]&&c[b][g])&&h.points[a.index],g=e)h=h.total?100/h.total:0,g[0]=aa(g[0]*h),g[1]=aa(g[1]*h),a.stackedYData[f]=g[1]})};s(Ya.prototype,{addSeries:function(a,b,c){var d,e=this;a&&(b=o(b,!0),I(e,"addSeries",{options:a},function(){d=e.initSeries(a);e.isDirtyLegend=!0;e.linkSeries();b&&e.redraw(c)}));return d},addAxis:function(a,b,c,d){var e=b?"xAxis":"yAxis",f=this.options;new ka(this,w(a,{index:this[e].length,isX:b}));f[e]=na(f[e]||{});f[e].push(a);o(c,!0)&&this.redraw(d)},showLoading:function(a){var b=this.options,c=this.loadingDiv,d=b.loading;if(!c)this.loadingDiv=c=V(Ja,{className:"highcharts-loading"},s(d.style,{zIndex:10,display:O}),this.container),this.loadingSpan=V("span",null,d.labelStyle,c);this.loadingSpan.innerHTML=a||b.lang.loading;if(!this.loadingShown)D(c,{opacity:0,display:"",left:this.plotLeft+"px",top:this.plotTop+"px",width:this.plotWidth+"px",height:this.plotHeight+"px"}),jb(c,{opacity:d.style.opacity},{duration:d.showDuration||0}),this.loadingShown=!0},hideLoading:function(){var a=this.options,b=this.loadingDiv;b&&jb(b,{opacity:0},{duration:a.loading.hideDuration||100,complete:function(){D(b,{display:O})}});this.loadingShown=!1}});s(Fa.prototype,{update:function(a,b,c){var d=this,e=d.series,f=d.graphic,g,h=e.data,i=e.chart,j=e.options,b=o(b,!0);d.firePointEvent("update",{options:a},function(){d.applyOptions(a);if($(a)){e.getAttribs();if(f)a&&a.marker&&a.marker.symbol?d.graphic=f.destroy():f.attr(d.pointAttr[d.state||""]);if(a&&a.dataLabels&&d.dataLabel)d.dataLabel=d.dataLabel.destroy()}g=va(d,h);e.updateParallelArrays(d,g);j.data[g]=d.options;e.isDirty=e.isDirtyData=!0;if(!e.fixedBox&&e.hasCartesianSeries)i.isDirtyBox=!0;j.legendType==="point"&&i.legend.destroyItem(d);b&&i.redraw(c)})},remove:function(a,b){var c=this,d=c.series,e=d.points,f=d.chart,g,h=d.data;Qa(b,f);a=o(a,!0);c.firePointEvent("remove",null,function(){g=va(c,h);h.length===e.length&&e.splice(g,1);h.splice(g,1);d.options.data.splice(g,1);d.updateParallelArrays(c,"splice",g,1);c.destroy();d.isDirty=!0;d.isDirtyData=!0;a&&f.redraw()})}});s(M.prototype,{addPoint:function(a,b,c,d){var e=this.options,f=this.data,g=this.graph,h=this.area,i=this.chart,j=this.xAxis&&this.xAxis.names,k=g&&g.shift||0,l=e.data,m,n=this.xData;Qa(d,i);c&&p([g,h,this.graphNeg,this.areaNeg],function(a){if(a)a.shift=k+1});if(h)h.isArea=!0;b=o(b,!0);d={series:this};this.pointClass.prototype.applyOptions.apply(d,[a]);g=d.x;h=n.length;if(this.requireSorting&&g<n[h-1])for(m=!0;h&&n[h-1]>g;)h--;this.updateParallelArrays(d,"splice",h,0,0);this.updateParallelArrays(d,h);if(j)j[g]=d.name;l.splice(h,0,a);m&&(this.data.splice(h,0,null),this.processData());e.legendType==="point"&&this.generatePoints();c&&(f[0]&&f[0].remove?f[0].remove(!1):(f.shift(),this.updateParallelArrays(d,"shift"),l.shift()));this.isDirtyData=this.isDirty=!0;b&&(this.getAttribs(),i.redraw())},remove:function(a,b){var c=this,d=c.chart,a=o(a,!0);if(!c.isRemoving)c.isRemoving=!0,I(c,"remove",null,function(){c.destroy();d.isDirtyLegend=d.isDirtyBox=!0;d.linkSeries();a&&d.redraw(b)});c.isRemoving=!1},update:function(a,b){var c=this.chart,d=this.type,e=J[d].prototype,f,a=w(this.userOptions,{animation:!1,index:this.index,pointStart:this.xData[0]},{data:this.options.data},a);this.remove(!1);for(f in e)e.hasOwnProperty(f)&&(this[f]=u);s(this,J[a.type||d].prototype);this.init(c,a);o(b,!0)&&c.redraw(!1)}});s(ka.prototype,{update:function(a,b){var c=this.chart,a=c.options[this.coll][this.options.index]=w(this.userOptions,a);this.destroy(!0);this._addedPlotLB=this.userMin=this.userMax=u;this.init(c,s(a,{events:u}));c.isDirtyBox=!0;o(b,!0)&&c.redraw()},remove:function(a){for(var b=this.chart,c=this.coll,d=this.series,e=d.length;e--;)d[e]&&d[e].remove(!1);ia(b.axes,this);ia(b[c],this);b.options[c].splice(this.options.index,1);p(b[c],function(a,b){a.options.index=b});this.destroy();b.isDirtyBox=!0;o(a,!0)&&b.redraw()},setTitle:function(a,b){this.update({title:a},b)},setCategories:function(a,b){this.update({categories:a},b)}});ea=ja(M);J.line=ea;Z.area=w(R,{threshold:0});var ma=ja(M,{type:"area",getSegments:function(){var a=[],b=[],c=[],d=this.xAxis,e=this.yAxis,f=e.stacks[this.stackKey],g={},h,i,j=this.points,k=this.options.connectNulls,l,m,n;if(this.options.stacking&&!this.cropped){for(m=0;m<j.length;m++)g[j[m].x]=j[m];for(n in f)f[n].total!==null&&c.push(+n);c.sort(function(a,b){return a-b});p(c,function(a){if(!k||g[a]&&g[a].y!==null)g[a]?b.push(g[a]):(h=d.translate(a),l=f[a].percent?f[a].total?f[a].cum*100/f[a].total:0:f[a].cum,i=e.toPixels(l,!0),b.push({y:null,plotX:h,clientX:h,plotY:i,yBottom:i,onMouseOver:Ea}))});b.length&&a.push(b)}else M.prototype.getSegments.call(this),a=this.segments;this.segments=a},getSegmentPath:function(a){var b=M.prototype.getSegmentPath.call(this,a),c=[].concat(b),d,e=this.options;d=b.length;var f=this.yAxis.getThreshold(e.threshold),g;d===3&&c.push("L",b[1],b[2]);if(e.stacking&&!this.closedStacks)for(d=a.length-1;d>=0;d--)g=o(a[d].yBottom,f),d<a.length-1&&e.step&&c.push(a[d+1].plotX,g),c.push(a[d].plotX,g);else this.closeSegment(c,a,f);this.areaPath=this.areaPath.concat(c);return b},closeSegment:function(a,b,c){a.push("L",b[b.length-1].plotX,c,"L",b[0].plotX,c)},drawGraph:function(){this.areaPath=[];M.prototype.drawGraph.apply(this);var a=this,b=this.areaPath,c=this.options,d=c.negativeColor,e=c.negativeFillColor,f=[["area",this.color,c.fillColor]];(d||e)&&f.push(["areaNeg",d,e]);p(f,function(d){var e=d[0],f=a[e];f?f.animate({d:b}):a[e]=a.chart.renderer.path(b).attr({fill:o(d[2],wa(d[1]).setOpacity(o(c.fillOpacity,.75)).get()),zIndex:0}).add(a.group)})},drawLegendSymbol:F.drawRectangle});J.area=ma;Z.spline=w(R);ea=ja(M,{type:"spline",getPointSpline:function(a,b,c){var d=b.plotX,e=b.plotY,f=a[c-1],g=a[c+1],h,i,j,k;if(f&&g){a=f.plotY;j=g.plotX;var g=g.plotY,l;h=(1.5*d+f.plotX)/2.5;i=(1.5*e+a)/2.5;j=(1.5*d+j)/2.5;k=(1.5*e+g)/2.5;l=(k-i)*(j-d)/(j-h)+e-k;i+=l;k+=l;i>a&&i>e?(i=t(a,e),k=2*e-i):i<a&&i<e&&(i=E(a,e),k=2*e-i);k>g&&k>e?(k=t(g,e),i=2*e-k):k<g&&k<e&&(k=E(g,e),i=2*e-k);b.rightContX=j;b.rightContY=k}c?(b=["C",f.rightContX||f.plotX,f.rightContY||f.plotY,h||d,i||e,d,e],f.rightContX=f.rightContY=null):b=["M",d,e];return b}});J.spline=ea;Z.areaspline=w(Z.area);ma=ma.prototype;ea=ja(ea,{type:"areaspline",closedStacks:!0,getSegmentPath:ma.getSegmentPath,closeSegment:ma.closeSegment,drawGraph:ma.drawGraph,drawLegendSymbol:F.drawRectangle});J.areaspline=ea;Z.column=w(R,{borderColor:"#FFFFFF",borderWidth:1,borderRadius:0,groupPadding:.2,marker:null,pointPadding:.1,minPointLength:0,cropThreshold:50,pointRange:null,states:{hover:{brightness:.1,shadow:!1},select:{color:"#C0C0C0",borderColor:"#000000",shadow:!1}},dataLabels:{align:null,verticalAlign:null,y:null},stickyTracking:!1,threshold:0});ea=ja(M,{type:"column",pointAttrToOptions:{stroke:"borderColor","stroke-width":"borderWidth",fill:"color",r:"borderRadius"},cropShoulder:0,trackerGroups:["group","dataLabelsGroup"],negStacks:!0,init:function(){M.prototype.init.apply(this,arguments);var a=this,b=a.chart;b.hasRendered&&p(b.series,function(b){if(b.type===a.type)b.isDirty=!0})},getColumnMetrics:function(){var a=this,b=a.options,c=a.xAxis,d=a.yAxis,e=c.reversed,f,g={},h,i=0;b.grouping===!1?i=1:p(a.chart.series,function(b){var c=b.options,e=b.yAxis;
if(b.type===a.type&&b.visible&&d.len===e.len&&d.pos===e.pos)c.stacking?(f=b.stackKey,g[f]===u&&(g[f]=i++),h=g[f]):c.grouping!==!1&&(h=i++),b.columnIndex=h});var c=E(N(c.transA)*(c.ordinalSlope||b.pointRange||c.closestPointRange||c.tickInterval||1),c.len),j=c*b.groupPadding,k=(c-2*j)/i,l=b.pointWidth,b=r(l)?(k-l)/2:k*b.pointPadding,l=o(l,k-2*b);return a.columnMetrics={width:l,offset:b+(j+((e?i-(a.columnIndex||0):a.columnIndex)||0)*k-c/2)*(e?-1:1)}},translate:function(){var a=this.chart,b=this.options,c=b.borderWidth,d=this.yAxis,e=this.translatedThreshold=d.getThreshold(b.threshold),f=o(b.minPointLength,5),b=this.getColumnMetrics(),g=b.width,h=this.barW=Ka(t(g,1+2*c)),i=this.pointXOffset=b.offset,j=-(c%2?.5:0),k=c%2?.5:1;a.renderer.isVML&&a.inverted&&(k+=1);M.prototype.translate.apply(this);p(this.points,function(a){var b=o(a.yBottom,e),c=E(t(-999-b,a.plotY),d.len+999+b),q=a.plotX+i,p=h,r=E(c,b),s,c=t(c,b)-r;N(c)<f&&f&&(c=f,r=v(N(r-e)>f?b-f:e-(d.translate(a.y,0,1,0,1)<=e?f:0)));a.barX=q;a.pointWidth=g;b=N(q)<.5;p=v(q+p)+j;q=v(q)+j;p-=q;s=N(r)<.5;c=v(r+c)+k;r=v(r)+k;c-=r;b&&(q+=1,p-=1);s&&(r-=1,c+=1);a.shapeType="rect";a.shapeArgs={x:q,y:r,width:p,height:c}})},getSymbol:Ea,drawLegendSymbol:F.drawRectangle,drawGraph:Ea,drawPoints:function(){var a=this,b=a.options,c=this.chart.renderer,d=b.animationLimit||250,e;p(a.points,function(f){var g=f.plotY,h=f.graphic;if(g!==u&&!isNaN(g)&&f.y!==null)e=f.shapeArgs,h?(ab(h),h[a.points.length<d?"animate":"attr"](w(e))):f.graphic=c[f.shapeType](e).attr(f.pointAttr[f.selected?"select":""]).add(a.group).shadow(b.shadow,null,b.stacking&&!b.borderRadius);else if(h)f.graphic=h.destroy()})},animate:function(a){var b=this.yAxis,c=this.options,d=this.chart.inverted,e={};if(X)a?(e.scaleY=.001,a=E(b.pos+b.len,t(b.pos,b.toPixels(c.threshold))),d?e.translateX=a-b.len:e.translateY=a,this.group.attr(e)):(e.scaleY=1,e[d?"translateX":"translateY"]=b.pos,this.group.animate(e,this.options.animation),this.animate=null)},remove:function(){var a=this,b=a.chart;b.hasRendered&&p(b.series,function(b){if(b.type===a.type)b.isDirty=!0});M.prototype.remove.apply(a,arguments)}});J.column=ea;Z.bar=w(Z.column);ma=ja(ea,{type:"bar",inverted:!0});J.bar=ma;Z.scatter=w(R,{lineWidth:0,tooltip:{headerFormat:'<span style="font-size: 10px; color:{series.color}">{series.name}</span><br/>',pointFormat:"x: <b>{point.x}</b><br/>y: <b>{point.y}</b><br/>",followPointer:!0},stickyTracking:!1});ma=ja(M,{type:"scatter",sorted:!1,requireSorting:!1,noSharedTooltip:!0,trackerGroups:["markerGroup"],takeOrdinalPosition:!1,singularTooltips:!0,drawGraph:function(){this.options.lineWidth&&M.prototype.drawGraph.call(this)}});J.scatter=ma;Z.pie=w(R,{borderColor:"#FFFFFF",borderWidth:1,center:[null,null],clip:!1,colorByPoint:!0,dataLabels:{distance:30,enabled:!0,formatter:function(){return this.point.name}},ignoreHiddenPoint:!0,legendType:"point",marker:null,size:null,showInLegend:!1,slicedOffset:10,states:{hover:{brightness:.1,shadow:!1}},stickyTracking:!1,tooltip:{followPointer:!0}});R={type:"pie",isCartesian:!1,pointClass:ja(Fa,{init:function(){Fa.prototype.init.apply(this,arguments);var a=this,b;if(a.y<0)a.y=null;s(a,{visible:a.visible!==!1,name:o(a.name,"Slice")});b=function(b){a.slice(b.type==="select")};C(a,"select",b);C(a,"unselect",b);return a},setVisible:function(a){var b=this,c=b.series,d=c.chart;b.visible=b.options.visible=a=a===u?!b.visible:a;c.options.data[va(b,c.data)]=b.options;p(["graphic","dataLabel","connector","shadowGroup"],function(c){if(b[c])b[c][a?"show":"hide"](!0)});b.legendItem&&d.legend.colorizeItem(b,a);if(!c.isDirty&&c.options.ignoreHiddenPoint)c.isDirty=!0,d.redraw()},slice:function(a,b,c){var d=this.series;Qa(c,d.chart);o(b,!0);this.sliced=this.options.sliced=a=r(a)?a:!this.sliced;d.options.data[va(this,d.data)]=this.options;a=a?this.slicedTranslation:{translateX:0,translateY:0};this.graphic.animate(a);this.shadowGroup&&this.shadowGroup.animate(a)}}),requireSorting:!1,noSharedTooltip:!0,trackerGroups:["group","dataLabelsGroup"],axisTypes:[],pointAttrToOptions:{stroke:"borderColor","stroke-width":"borderWidth",fill:"color"},singularTooltips:!0,getColor:Ea,animate:function(a){var b=this,c=b.points,d=b.startAngleRad;if(!a)p(c,function(a){var c=a.graphic,a=a.shapeArgs;c&&(c.attr({r:b.center[3]/2,start:d,end:d}),c.animate({r:a.r,start:a.start,end:a.end},b.options.animation))}),b.animate=null},setData:function(a,b,c,d){M.prototype.setData.call(this,a,!1,c,d);this.processData();this.generatePoints();o(b,!0)&&this.chart.redraw(c)},generatePoints:function(){var a,b=0,c,d,e,f=this.options.ignoreHiddenPoint;M.prototype.generatePoints.call(this);c=this.points;d=c.length;for(a=0;a<d;a++)e=c[a],b+=f&&!e.visible?0:e.y;this.total=b;for(a=0;a<d;a++)e=c[a],e.percentage=b>0?e.y/b*100:0,e.total=b},translate:function(a){this.generatePoints();var b=0,c=this.options,d=c.slicedOffset,e=d+c.borderWidth,f,g,h,i=c.startAngle||0,j=this.startAngleRad=la/180*(i-90),i=(this.endAngleRad=la/180*(o(c.endAngle,i+360)-90))-j,k=this.points,l=c.dataLabels.distance,c=c.ignoreHiddenPoint,m,n=k.length,p;if(!a)this.center=a=this.getCenter();this.getX=function(b,c){h=T.asin(E((b-a[1])/(a[2]/2+l),1));return a[0]+(c?-1:1)*W(h)*(a[2]/2+l)};for(m=0;m<n;m++){p=k[m];f=j+b*i;if(!c||p.visible)b+=p.percentage/100;g=j+b*i;p.shapeType="arc";p.shapeArgs={x:a[0],y:a[1],r:a[2]/2,innerR:a[3]/2,start:v(f*1e3)/1e3,end:v(g*1e3)/1e3};h=(g+f)/2;h>1.5*la?h-=2*la:h<-la/2&&(h+=2*la);p.slicedTranslation={translateX:v(W(h)*d),translateY:v(ba(h)*d)};f=W(h)*a[2]/2;g=ba(h)*a[2]/2;p.tooltipPos=[a[0]+f*.7,a[1]+g*.7];p.half=h<-la/2||h>la/2?1:0;p.angle=h;e=E(e,l/2);p.labelPos=[a[0]+f+W(h)*l,a[1]+g+ba(h)*l,a[0]+f+W(h)*e,a[1]+g+ba(h)*e,a[0]+f,a[1]+g,l<0?"center":p.half?"right":"left",h]}},drawGraph:null,drawPoints:function(){var a=this,b=a.chart.renderer,c,d,e=a.options.shadow,f,g;if(e&&!a.shadowGroup)a.shadowGroup=b.g("shadow").add(a.group);p(a.points,function(h){d=h.graphic;g=h.shapeArgs;f=h.shadowGroup;if(e&&!f)f=h.shadowGroup=b.g("shadow").add(a.shadowGroup);c=h.sliced?h.slicedTranslation:{translateX:0,translateY:0};f&&f.attr(c);d?d.animate(s(g,c)):h.graphic=d=b[h.shapeType](g).setRadialReference(a.center).attr(h.pointAttr[h.selected?"select":""]).attr({"stroke-linejoin":"round"}).attr(c).add(a.group).shadow(e,f);h.visible!==void 0&&h.setVisible(h.visible)})},sortByAngle:function(a,b){a.sort(function(a,d){return a.angle!==void 0&&(d.angle-a.angle)*b})},drawLegendSymbol:F.drawRectangle,getCenter:da.getCenter,getSymbol:Ea};R=ja(M,R);J.pie=R;M.prototype.drawDataLabels=function(){var a=this,b=a.options,c=b.cursor,d=b.dataLabels,b=a.points,e,f,g,h;if(d.enabled||a._hasPointLabels)a.dlProcessOptions&&a.dlProcessOptions(d),h=a.plotGroup("dataLabelsGroup","data-labels",a.visible?"visible":"hidden",d.zIndex||6),f=d,p(b,function(b){var j,k=b.dataLabel,l,m,n=b.connector,p=!0;e=b.options&&b.options.dataLabels;j=o(e&&e.enabled,f.enabled);if(k&&!j)b.dataLabel=k.destroy();else if(j){d=w(f,e);j=d.rotation;l=b.getLabelConfig();g=d.format?Ia(d.format,l):d.formatter.call(l,d);d.style.color=o(d.color,d.style.color,a.color,"black");if(k)if(r(g))k.attr({text:g}),p=!1;else{if(b.dataLabel=k=k.destroy(),n)b.connector=n.destroy()}else if(r(g)){k={fill:d.backgroundColor,stroke:d.borderColor,"stroke-width":d.borderWidth,r:d.borderRadius||0,rotation:j,padding:d.padding,zIndex:1};for(m in k)k[m]===u&&delete k[m];k=b.dataLabel=a.chart.renderer[j?"text":"label"](g,0,-999,null,null,null,d.useHTML).attr(k).css(s(d.style,c&&{cursor:c})).add(h).shadow(d.shadow)}k&&a.alignDataLabel(b,k,d,null,p)}})};M.prototype.alignDataLabel=function(a,b,c,d,e){var f=this.chart,g=f.inverted,h=o(a.plotX,-999),i=o(a.plotY,-999),j=b.getBBox();if(a=this.visible&&(a.series.forceDL||f.isInsidePlot(h,v(i),g)||d&&f.isInsidePlot(h,g?d.x+1:d.y+d.height-1,g)))d=s({x:g?f.plotWidth-i:h,y:v(g?f.plotHeight-h:i),width:0,height:0},d),s(c,{width:j.width,height:j.height}),c.rotation?(g={align:c.align,x:d.x+c.x+d.width/2,y:d.y+c.y+d.height/2},b[e?"attr":"animate"](g)):(b.align(c,null,d),g=b.alignAttr,o(c.overflow,"justify")==="justify"?this.justifyDataLabel(b,c,g,j,d,e):o(c.crop,!0)&&(a=f.isInsidePlot(g.x,g.y)&&f.isInsidePlot(g.x+j.width,g.y+j.height)));if(!a)b.attr({y:-999}),b.placed=!1};M.prototype.justifyDataLabel=function(a,b,c,d,e,f){var g=this.chart,h=b.align,i=b.verticalAlign,j,k;j=c.x;if(j<0)h==="right"?b.align="left":b.x=-j,k=!0;j=c.x+d.width;if(j>g.plotWidth)h==="left"?b.align="right":b.x=g.plotWidth-j,k=!0;j=c.y;if(j<0)i==="bottom"?b.verticalAlign="top":b.y=-j,k=!0;j=c.y+d.height;if(j>g.plotHeight)i==="top"?b.verticalAlign="bottom":b.y=g.plotHeight-j,k=!0;if(k)a.placed=!f,a.align(b,null,e)};if(J.pie)J.pie.prototype.drawDataLabels=function(){var a=this,b=a.data,c,d=a.chart,e=a.options.dataLabels,f=o(e.connectorPadding,10),g=o(e.connectorWidth,1),h=d.plotWidth,d=d.plotHeight,i,j,k=o(e.softConnector,!0),l=e.distance,m=a.center,n=m[2]/2,q=m[1],r=l>0,s,u,w,x,y=[[],[]],z,B,E,H,A,D=[0,0,0,0],J=function(a,b){return b.y-a.y};if(a.visible&&(e.enabled||a._hasPointLabels)){M.prototype.drawDataLabels.apply(a);p(b,function(a){a.dataLabel&&a.visible&&y[a.half].push(a)});for(H=0;!x&&b[H];)x=b[H]&&b[H].dataLabel&&(b[H].dataLabel.getBBox().height||21),H++;for(H=2;H--;){var b=[],I=[],F=y[H],G=F.length,C;a.sortByAngle(F,H-.5);if(l>0){for(A=q-n-l;A<=q+n+l;A+=x)b.push(A);u=b.length;if(G>u){c=[].concat(F);c.sort(J);for(A=G;A--;)c[A].rank=A;for(A=G;A--;)F[A].rank>=u&&F.splice(A,1);G=F.length}for(A=0;A<G;A++){c=F[A];w=c.labelPos;c=9999;var O,L;for(L=0;L<u;L++)O=N(b[L]-w[1]),O<c&&(c=O,C=L);if(C<A&&b[A]!==null)C=A;else for(u<G-A+C&&b[A]!==null&&(C=u-G+A);b[C]===null;)C++;I.push({i:C,y:b[C]});b[C]=null}I.sort(J)}for(A=0;A<G;A++){c=F[A];w=c.labelPos;s=c.dataLabel;E=c.visible===!1?"hidden":"visible";c=w[1];if(l>0){if(u=I.pop(),C=u.i,B=u.y,c>B&&b[C+1]!==null||c<B&&b[C-1]!==null)B=c}else B=c;z=e.justify?m[0]+(H?-1:1)*(n+l):a.getX(C===0||C===b.length-1?c:B,H);s._attr={visibility:E,align:w[6]};s._pos={x:z+e.x+({left:f,right:-f}[w[6]]||0),y:B+e.y-10};s.connX=z;s.connY=B;if(this.options.size===null)u=s.width,z-u<f?D[3]=t(v(u-z+f),D[3]):z+u>h-f&&(D[1]=t(v(z+u-h+f),D[1])),B-x/2<0?D[0]=t(v(-B+x/2),D[0]):B+x/2>d&&(D[2]=t(v(B+x/2-d),D[2]))}}if(Ba(D)===0||this.verifyDataLabelOverflow(D))this.placeDataLabels(),r&&g&&p(this.points,function(b){i=b.connector;w=b.labelPos;if((s=b.dataLabel)&&s._pos)E=s._attr.visibility,z=s.connX,B=s.connY,j=k?["M",z+(w[6]==="left"?5:-5),B,"C",z,B,2*w[2]-w[4],2*w[3]-w[5],w[2],w[3],"L",w[4],w[5]]:["M",z+(w[6]==="left"?5:-5),B,"L",w[2],w[3],"L",w[4],w[5]],i?(i.animate({d:j}),i.attr("visibility",E)):b.connector=i=a.chart.renderer.path(j).attr({"stroke-width":g,stroke:e.connectorColor||b.color||"#606060",visibility:E}).add(a.group);else if(i)b.connector=i.destroy()})}},J.pie.prototype.placeDataLabels=function(){p(this.points,function(a){var a=a.dataLabel,b;if(a)(b=a._pos)?(a.attr(a._attr),a[a.moved?"animate":"attr"](b),a.moved=!0):a&&a.attr({y:-999})})},J.pie.prototype.alignDataLabel=Ea,J.pie.prototype.verifyDataLabelOverflow=function(a){var b=this.center,c=this.options,d=c.center,e=c=c.minSize||80,f;d[0]!==null?e=t(b[2]-t(a[1],a[3]),c):(e=t(b[2]-a[1]-a[3],c),b[0]+=(a[3]-a[1])/2);d[1]!==null?e=t(E(e,b[2]-t(a[0],a[2])),c):(e=t(E(e,b[2]-a[0]-a[2]),c),b[1]+=(a[0]-a[2])/2);e<b[2]?(b[2]=e,this.translate(b),p(this.points,function(a){if(a.dataLabel)a.dataLabel._pos=null}),this.drawDataLabels&&this.drawDataLabels()):f=!0;return f};if(J.column)J.column.prototype.alignDataLabel=function(a,b,c,d,e){var f=this.chart,g=f.inverted,h=a.dlBox||a.shapeArgs,i=a.below||a.plotY>o(this.translatedThreshold,f.plotSizeY),j=o(c.inside,!!this.options.stacking);if(h&&(d=w(h),g&&(d={x:f.plotWidth-d.y-d.height,y:f.plotHeight-d.x-d.width,width:d.height,height:d.width}),!j))g?(d.x+=i?0:d.width,d.width=0):(d.y+=i?d.height:0,d.height=0);c.align=o(c.align,!g||j?"center":i?"right":"left");c.verticalAlign=o(c.verticalAlign,g||j?"middle":i?"top":"bottom");M.prototype.alignDataLabel.call(this,a,b,c,d,e)};R=Q.TrackerMixin={drawTrackerPoint:function(){var a=this,b=a.chart,c=b.pointer,d=a.options.cursor,e=d&&{cursor:d},f=function(c){var d=c.target,e;if(b.hoverSeries!==a)a.onMouseOver();for(;d&&!e;)e=d.point,d=d.parentNode;if(e!==u&&e!==b.hoverPoint)e.onMouseOver(c)};p(a.points,function(a){if(a.graphic)a.graphic.element.point=a;if(a.dataLabel)a.dataLabel.element.point=a});if(!a._hasTracking)p(a.trackerGroups,function(b){if(a[b]&&(a[b].addClass("highcharts-tracker").on("mouseover",f).on("mouseout",function(a){c.onTrackerMouseOut(a)}).css(e),$a))a[b].on("touchstart",f)}),a._hasTracking=!0},drawTrackerGraph:function(){var a=this,b=a.options,c=b.trackByArea,d=[].concat(c?a.areaPath:a.graphPath),e=d.length,f=a.chart,g=f.pointer,h=f.renderer,i=f.options.tooltip.snap,j=a.tracker,k=b.cursor,l=k&&{cursor:k},k=a.singlePoints,m,n=function(){if(f.hoverSeries!==a)a.onMouseOver()},o="rgba(192,192,192,"+(X?1e-4:.002)+")";if(e&&!c)for(m=e+1;m--;)d[m]==="M"&&d.splice(m+1,0,d[m+1]-i,d[m+2],"L"),(m&&d[m]==="M"||m===e)&&d.splice(m,0,"L",d[m-2]+i,d[m-1]);for(m=0;m<k.length;m++)e=k[m],d.push("M",e.plotX-i,e.plotY,"L",e.plotX+i,e.plotY);j?j.attr({d:d}):(a.tracker=h.path(d).attr({"stroke-linejoin":"round",visibility:a.visible?"visible":"hidden",stroke:o,fill:c?o:O,"stroke-width":b.lineWidth+(c?0:2*i),zIndex:2}).add(a.group),p([a.tracker,a.markerGroup],function(a){a.addClass("highcharts-tracker").on("mouseover",n).on("mouseout",function(a){g.onTrackerMouseOut(a)}).css(l);if($a)a.on("touchstart",n)}))}};if(J.column)ea.prototype.drawTracker=R.drawTrackerPoint;if(J.pie)J.pie.prototype.drawTracker=R.drawTrackerPoint;if(J.scatter)ma.prototype.drawTracker=R.drawTrackerPoint;s(lb.prototype,{setItemEvents:function(a,b,c,d,e){var f=this;(c?b:a.legendGroup).on("mouseover",function(){a.setState("hover");b.css(f.options.itemHoverStyle)}).on("mouseout",function(){b.css(a.visible?d:e);a.setState()}).on("click",function(b){var c=function(){a.setVisible()},b={browserEvent:b};a.firePointEvent?a.firePointEvent("legendItemClick",b,c):I(a,"legendItemClick",b,c)})},createCheckboxForItem:function(a){a.checkbox=V("input",{type:"checkbox",checked:a.selected,defaultChecked:a.selected},this.options.itemCheckboxStyle,this.chart.container);C(a.checkbox,"click",function(b){I(a,"checkboxClick",{checked:b.target.checked},function(){a.select()})})}});L.legend.itemStyle.cursor="pointer";s(Ya.prototype,{showResetZoom:function(){var a=this,b=L.lang,c=a.options.chart.resetZoomButton,d=c.theme,e=d.states,f=c.relativeTo==="chart"?null:"plotBox";this.resetZoomButton=a.renderer.button(b.resetZoom,null,null,function(){a.zoomOut()},d,e&&e.hover).attr({align:c.position.align,title:b.resetZoomTitle}).add().align(c.position,!1,f)},zoomOut:function(){var a=this;I(a,"selection",{resetSelection:!0},function(){a.zoom()})},zoom:function(a){var b,c=this.pointer,d=!1,e;!a||a.resetSelection?p(this.axes,function(a){b=a.zoom()}):p(a.xAxis.concat(a.yAxis),function(a){var e=a.axis,h=e.isXAxis;if(c[h?"zoomX":"zoomY"]||c[h?"pinchX":"pinchY"])b=e.zoom(a.min,a.max),e.displayBtn&&(d=!0)});e=this.resetZoomButton;if(d&&!e)this.showResetZoom();else if(!d&&$(e))this.resetZoomButton=e.destroy();b&&this.redraw(o(this.options.chart.animation,a&&a.animation,this.pointCount<100))},pan:function(a,b){var c=this,d=c.hoverPoints,e;d&&p(d,function(a){a.setState()});p(b==="xy"?[1,0]:[1],function(b){var d=a[b?"chartX":"chartY"],h=c[b?"xAxis":"yAxis"][0],i=c[b?"mouseDownX":"mouseDownY"],j=(h.pointRange||0)/2,k=h.getExtremes(),l=h.toValue(i-d,!0)+j,i=h.toValue(i+c[b?"plotWidth":"plotHeight"]-d,!0)-j;h.series.length&&l>E(k.dataMin,k.min)&&i<t(k.dataMax,k.max)&&(h.setExtremes(l,i,!1,!1,{trigger:"pan"}),e=!0);c[b?"mouseDownX":"mouseDownY"]=d});e&&c.redraw(!1);D(c.container,{cursor:"move"})}});s(Fa.prototype,{select:function(a,b){var c=this,d=c.series,e=d.chart,a=o(a,!c.selected);c.firePointEvent(a?"select":"unselect",{accumulate:b},function(){c.selected=c.options.selected=a;d.options.data[va(c,d.data)]=c.options;c.setState(a&&"select");b||p(e.getSelectedPoints(),function(a){if(a.selected&&a!==c)a.selected=a.options.selected=!1,d.options.data[va(a,d.data)]=a.options,a.setState(""),a.firePointEvent("unselect")})})},onMouseOver:function(a){var b=this.series,c=b.chart,d=c.tooltip,e=c.hoverPoint;if(e&&e!==this)e.onMouseOut();this.firePointEvent("mouseOver");d&&(!d.shared||b.noSharedTooltip)&&d.refresh(this,a);this.setState("hover");c.hoverPoint=this},onMouseOut:function(){var a=this.series.chart,b=a.hoverPoints;if(!b||va(this,b)===-1)this.firePointEvent("mouseOut"),this.setState(),a.hoverPoint=null},firePointEvent:function(a,b,c){var d=this,e=this.series.options;(e.point.events[a]||d.options&&d.options.events&&d.options.events[a])&&this.importEvents();a==="click"&&e.allowPointSelect&&(c=function(a){d.select(null,a.ctrlKey||a.metaKey||a.shiftKey)});I(this,a,b,c)},importEvents:function(){if(!this.hasImportedEvents){var a=w(this.series.options.point,this.options).events,b;this.events=a;for(b in a)C(this,b,a[b]);this.hasImportedEvents=!0}},setState:function(a,b){var c=this.plotX,d=this.plotY,e=this.series,f=e.options.states,g=Z[e.type].marker&&e.options.marker,h=g&&!g.enabled,i=g&&g.states[a],j=i&&i.enabled===!1,k=e.stateMarkerGraphic,l=this.marker||{},m=e.chart,n=this.pointAttr,a=a||"",b=b&&k;if(!(a===this.state&&!b||this.selected&&a!=="select"||f[a]&&f[a].enabled===!1||a&&(j||h&&!i.enabled)||a&&l.states&&l.states[a]&&l.states[a].enabled===!1)){if(this.graphic)f=g&&this.graphic.symbolName&&n[a].r,this.graphic.attr(w(n[a],f?{x:c-f,y:d-f,width:2*f,height:2*f}:{}));else{if(a&&i)if(f=i.radius,l=l.symbol||e.symbol,k&&k.currentSymbol!==l&&(k=k.destroy()),k)k[b?"animate":"attr"]({x:c-f,y:d-f});else e.stateMarkerGraphic=k=m.renderer.symbol(l,c-f,d-f,2*f,2*f).attr(n[a]).add(e.markerGroup),k.currentSymbol=l;if(k)k[a&&m.isInsidePlot(c,d,m.inverted)?"show":"hide"]()}this.state=a}}});s(M.prototype,{onMouseOver:function(){var a=this.chart,b=a.hoverSeries;if(b&&b!==this)b.onMouseOut();this.options.events.mouseOver&&I(this,"mouseOver");this.setState("hover");a.hoverSeries=this},onMouseOut:function(){var a=this.options,b=this.chart,c=b.tooltip,d=b.hoverPoint;if(d)d.onMouseOut();this&&a.events.mouseOut&&I(this,"mouseOut");c&&!a.stickyTracking&&(!c.shared||this.noSharedTooltip)&&c.hide();this.setState();b.hoverSeries=null},setState:function(a){var b=this.options,c=this.graph,d=this.graphNeg,e=b.states,b=b.lineWidth,a=a||"";if(this.state!==a)this.state=a,e[a]&&e[a].enabled===!1||(a&&(b=e[a].lineWidth||b+1),c&&!c.dashstyle&&(a={"stroke-width":b},c.attr(a),d&&d.attr(a)))},setVisible:function(a,b){var c=this,d=c.chart,e=c.legendItem,f,g=d.options.chart.ignoreHiddenSeries,h=c.visible;f=(c.visible=a=c.userOptions.visible=a===u?!h:a)?"show":"hide";p(["group","dataLabelsGroup","markerGroup","tracker"],function(a){if(c[a])c[a][f]()});if(d.hoverSeries===c)c.onMouseOut();e&&d.legend.colorizeItem(c,a);c.isDirty=!0;c.options.stacking&&p(d.series,function(a){if(a.options.stacking&&a.visible)a.isDirty=!0});p(c.linkedSeries,function(b){b.setVisible(a,!1)});if(g)d.isDirtyBox=!0;b!==!1&&d.redraw();I(c,f)},setTooltipPoints:function(a){var b=[],c,d,e=this.xAxis,f=e&&e.getExtremes(),g=e?e.tooltipLen||e.len:this.chart.plotSizeX,h,i,j=[];if(!(this.options.enableMouseTracking===!1||this.singularTooltips)){if(a)this.tooltipPoints=null;p(this.segments||this.points,function(a){b=b.concat(a)});e&&e.reversed&&(b=b.reverse());this.orderTooltipPoints&&this.orderTooltipPoints(b);a=b.length;for(i=0;i<a;i++)if(e=b[i],c=e.x,c>=f.min&&c<=f.max){h=b[i+1];c=d===u?0:d+1;for(d=b[i+1]?E(t(0,S((e.clientX+(h?h.wrappedClientX||h.clientX:g))/2)),g):g;c>=0&&c<=d;)j[c++]=e}this.tooltipPoints=j}},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},select:function(a){this.selected=a=a===u?!this.selected:a;if(this.checkbox)this.checkbox.checked=a;I(this,a?"select":"unselect")},drawTracker:R.drawTrackerGraph});s(Q,{Axis:ka,Chart:Ya,Color:wa,Point:Fa,Tick:Sa,Renderer:Za,Series:M,SVGElement:ta,SVGRenderer:pa,arrayMin:Na,arrayMax:Ba,charts:Y,dateFormat:bb,format:Ia,pathAnim:ub,getOptions:function(){return L},hasBidiBug:Ob,isTouchDevice:Jb,numberFormat:Ga,seriesTypes:J,setOptions:function(a){L=w(!0,L,a);Cb();return L},addEvent:C,removeEvent:U,createElement:V,discardElement:Pa,css:D,each:p,extend:s,map:Ua,merge:w,pick:o,splat:na,extendClass:ja,pInt:x,wrap:Ma,svg:X,canvas:ca,vml:!X&&!ca,product:"Highcharts",version:"3.0.10"})})();(function(l,C){function J(a,b,c){this.init.call(this,a,b,c)}var N=l.arrayMin,O=l.arrayMax,t=l.each,y=l.extend,o=l.merge,P=l.map,q=l.pick,w=l.pInt,p=l.getOptions().plotOptions,h=l.seriesTypes,x=l.extendClass,K=l.splat,r=l.wrap,L=l.Axis,z=l.Tick,G=l.Point,Q=l.Pointer,R=l.TrackerMixin,S=l.CenteredSeriesMixin,s=l.Series,v=Math,D=v.round,A=v.floor,T=v.max,U=l.Color,u=function(){};y(J.prototype,{init:function(a,b,c){var d=this,f=d.defaultOptions;d.chart=b;if(b.angular)f.background={};d.options=a=o(f,a);(a=a.background)&&t([].concat(K(a)).reverse(),function(a){var e=a.backgroundColor,a=o(d.defaultBackgroundOptions,a);if(e)a.backgroundColor=e;a.color=a.backgroundColor;c.options.plotBands.unshift(a)})},defaultOptions:{center:["50%","50%"],size:"85%",startAngle:0},defaultBackgroundOptions:{shape:"circle",borderWidth:1,borderColor:"silver",backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#FFF"],[1,"#DDD"]]},from:Number.MIN_VALUE,innerRadius:0,to:Number.MAX_VALUE,outerRadius:"105%"}});var F=L.prototype,z=z.prototype,V={getOffset:u,redraw:function(){this.isDirty=!1},render:function(){this.isDirty=!1},setScale:u,setCategories:u,setTitle:u},M={isRadial:!0,defaultRadialGaugeOptions:{labels:{align:"center",x:0,y:null},minorGridLineWidth:0,minorTickInterval:"auto",minorTickLength:10,minorTickPosition:"inside",minorTickWidth:1,tickLength:10,tickPosition:"inside",tickWidth:2,title:{rotation:0},zIndex:2},defaultRadialXOptions:{gridLineWidth:1,labels:{align:null,distance:15,x:0,y:null},maxPadding:0,minPadding:0,showLastLabel:!1,tickLength:0},defaultRadialYOptions:{gridLineInterpolation:"circle",labels:{align:"right",x:-3,y:-2},showLastLabel:!1,title:{x:4,text:null,rotation:90}},setOptions:function(a){a=this.options=o(this.defaultOptions,this.defaultRadialOptions,a);if(!a.plotBands)a.plotBands=[]},getOffset:function(){F.getOffset.call(this);this.chart.axisOffset[this.side]=0;this.center=this.pane.center=S.getCenter.call(this.pane)},getLinePath:function(a,b){var c=this.center,b=q(b,c[2]/2-this.offset);return this.chart.renderer.symbols.arc(this.left+c[0],this.top+c[1],b,b,{start:this.startAngleRad,end:this.endAngleRad,open:!0,innerR:0})},setAxisTranslation:function(){F.setAxisTranslation.call(this);if(this.center)this.transA=this.isCircular?(this.endAngleRad-this.startAngleRad)/(this.max-this.min||1):this.center[2]/2/(this.max-this.min||1),this.minPixelPadding=this.isXAxis?this.transA*this.minPointOffset:0},beforeSetTickPositions:function(){this.autoConnect&&(this.max+=this.categories&&1||this.pointRange||this.closestPointRange||0)},setAxisSize:function(){F.setAxisSize.call(this);if(this.isRadial){this.center=this.pane.center=l.CenteredSeriesMixin.getCenter.call(this.pane);if(this.isCircular)this.sector=this.endAngleRad-this.startAngleRad;this.len=this.width=this.height=this.center[2]*q(this.sector,1)/2}},getPosition:function(a,b){if(!this.isCircular)b=this.translate(a),a=this.min;return this.postTranslate(this.translate(a),q(b,this.center[2]/2)-this.offset)},postTranslate:function(a,b){var c=this.chart,d=this.center,a=this.startAngleRad+a;return{x:c.plotLeft+d[0]+Math.cos(a)*b,y:c.plotTop+d[1]+Math.sin(a)*b}},getPlotBandPath:function(a,b,c){var d=this.center,f=this.startAngleRad,g=d[2]/2,e=[q(c.outerRadius,"100%"),c.innerRadius,q(c.thickness,10)],k=/%$/,n,m=this.isCircular;this.options.gridLineInterpolation==="polygon"?d=this.getPlotLinePath(a).concat(this.getPlotLinePath(b,!0)):(m||(e[0]=this.translate(a),e[1]=this.translate(b)),e=P(e,function(a){k.test(a)&&(a=w(a,10)*g/100);return a}),c.shape==="circle"||!m?(a=-Math.PI/2,b=Math.PI*1.5,n=!0):(a=f+this.translate(a),b=f+this.translate(b)),d=this.chart.renderer.symbols.arc(this.left+d[0],this.top+d[1],e[0],e[0],{start:a,end:b,innerR:q(e[1],e[0]-e[2]),open:n}));return d},getPlotLinePath:function(a,b){var c=this.center,d=this.chart,f=this.getPosition(a),g,e,k;this.isCircular?k=["M",c[0]+d.plotLeft,c[1]+d.plotTop,"L",f.x,f.y]:this.options.gridLineInterpolation==="circle"?(a=this.translate(a))&&(k=this.getLinePath(0,a)):(g=d.xAxis[0],k=[],a=this.translate(a),c=g.tickPositions,g.autoConnect&&(c=c.concat([c[0]])),b&&(c=[].concat(c).reverse()),t(c,function(c,b){e=g.getPosition(c,a);k.push(b?"L":"M",e.x,e.y)}));return k},getTitlePosition:function(){var a=this.center,b=this.chart,c=this.options.title;return{x:b.plotLeft+a[0]+(c.x||0),y:b.plotTop+a[1]-{high:.5,middle:.25,low:0}[c.align]*a[2]+(c.y||0)}}};r(F,"init",function(a,b,c){var i;var d=b.angular,f=b.polar,g=c.isX,e=d&&g,k,n;n=b.options;var m=c.pane||0;if(d){if(y(this,e?V:M),k=!g)this.defaultRadialOptions=this.defaultRadialGaugeOptions}else if(f)y(this,M),this.defaultRadialOptions=(k=g)?this.defaultRadialXOptions:o(this.defaultYAxisOptions,this.defaultRadialYOptions);a.call(this,b,c);if(!e&&(d||f)){a=this.options;if(!b.panes)b.panes=[];this.pane=(i=b.panes[m]=b.panes[m]||new J(K(n.pane)[m],b,this),m=i);m=m.options;b.inverted=!1;n.chart.zoomType=null;this.startAngleRad=b=(m.startAngle-90)*Math.PI/180;this.endAngleRad=n=(q(m.endAngle,m.startAngle+360)-90)*Math.PI/180;this.offset=a.offset||0;if((this.isCircular=k)&&c.max===C&&n-b===2*Math.PI)this.autoConnect=!0}});r(z,"getPosition",function(a,b,c,d,f){var g=this.axis;return g.getPosition?g.getPosition(c):a.call(this,b,c,d,f)});r(z,"getLabelPosition",function(a,b,c,d,f,g,e,k,n){var m=this.axis,i=g.y,j=g.align,h=(m.translate(this.pos)+m.startAngleRad+Math.PI/2)/Math.PI*180%360;m.isRadial?(a=m.getPosition(this.pos,m.center[2]/2+q(g.distance,-25)),g.rotation==="auto"?d.attr({rotation:h}):i===null&&(i=m.chart.renderer.fontMetrics(d.styles.fontSize).b-d.getBBox().height/2),j===null&&(j=m.isCircular?h>20&&h<160?"left":h>200&&h<340?"right":"center":"center",d.attr({align:j})),a.x+=g.x,a.y+=i):a=a.call(this,b,c,d,f,g,e,k,n);return a});r(z,"getMarkPath",function(a,b,c,d,f,g,e){var k=this.axis;k.isRadial?(a=k.getPosition(this.pos,k.center[2]/2+d),b=["M",b,c,"L",a.x,a.y]):b=a.call(this,b,c,d,f,g,e);return b});p.arearange=o(p.area,{lineWidth:1,marker:null,threshold:null,tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b><br/>'},trackByArea:!0,dataLabels:{verticalAlign:null,xLow:0,xHigh:0,yLow:0,yHigh:0}});h.arearange=x(h.area,{type:"arearange",pointArrayMap:["low","high"],toYData:function(a){return[a.low,a.high]},pointValKey:"low",getSegments:function(){var a=this;t(a.points,function(b){if(!a.options.connectNulls&&(b.low===null||b.high===null))b.y=null;else if(b.low===null&&b.high!==null)b.y=b.high});s.prototype.getSegments.call(this)},translate:function(){var a=this.yAxis;h.area.prototype.translate.apply(this);t(this.points,function(b){var c=b.low,d=b.high,f=b.plotY;d===null&&c===null?b.y=null:c===null?(b.plotLow=b.plotY=null,b.plotHigh=a.translate(d,0,1,0,1)):d===null?(b.plotLow=f,b.plotHigh=null):(b.plotLow=f,b.plotHigh=a.translate(d,0,1,0,1))})},getSegmentPath:function(a){var b,c=[],d=a.length,f=s.prototype.getSegmentPath,g,e;e=this.options;var k=e.step;for(b=HighchartsAdapter.grep(a,function(a){return a.plotLow!==null});d--;)g=a[d],g.plotHigh!==null&&c.push({plotX:g.plotX,plotY:g.plotHigh});a=f.call(this,b);if(k)k===!0&&(k="left"),e.step={left:"right",center:"center",right:"left"}[k];c=f.call(this,c);e.step=k;e=[].concat(a,c);c[0]="L";this.areaPath=this.areaPath.concat(a,c);return e},drawDataLabels:function(){var a=this.data,b=a.length,c,d=[],f=s.prototype,g=this.options.dataLabels,e,k=this.chart.inverted;if(g.enabled||this._hasPointLabels){for(c=b;c--;)e=a[c],e.y=e.high,e._plotY=e.plotY,e.plotY=e.plotHigh,d[c]=e.dataLabel,e.dataLabel=e.dataLabelUpper,e.below=!1,k?(g.align="left",g.x=g.xHigh):g.y=g.yHigh;f.drawDataLabels&&f.drawDataLabels.apply(this,arguments);for(c=b;c--;)e=a[c],e.dataLabelUpper=e.dataLabel,e.dataLabel=d[c],e.y=e.low,e.plotY=e._plotY,e.below=!0,k?(g.align="right",g.x=g.xLow):g.y=g.yLow;f.drawDataLabels&&f.drawDataLabels.apply(this,arguments)}},alignDataLabel:function(){h.column.prototype.alignDataLabel.apply(this,arguments)},getSymbol:h.column.prototype.getSymbol,drawPoints:u});p.areasplinerange=o(p.arearange);h.areasplinerange=x(h.arearange,{type:"areasplinerange",getPointSpline:h.spline.prototype.getPointSpline});(function(){var a=h.column.prototype;p.columnrange=o(p.column,p.arearange,{lineWidth:1,pointRange:null});h.columnrange=x(h.arearange,{type:"columnrange",translate:function(){var b=this,c=b.yAxis,d;a.translate.apply(b);t(b.points,function(a){var g=a.shapeArgs,e=b.options.minPointLength,k;a.plotHigh=d=c.translate(a.high,0,1,0,1);a.plotLow=a.plotY;k=d;a=a.plotY-d;a<e&&(e-=a,a+=e,k-=e/2);g.height=a;g.y=k})},trackerGroups:["group","dataLabels"],drawGraph:u,pointAttrToOptions:a.pointAttrToOptions,drawPoints:a.drawPoints,drawTracker:a.drawTracker,animate:a.animate,getColumnMetrics:a.getColumnMetrics})})();p.gauge=o(p.line,{dataLabels:{enabled:!0,y:15,borderWidth:1,borderColor:"silver",borderRadius:3,crop:!1,style:{fontWeight:"bold"},verticalAlign:"top",zIndex:2},dial:{},pivot:{},tooltip:{headerFormat:""},showInLegend:!1});G={type:"gauge",pointClass:x(G,{setState:function(a){this.state=a}}),angular:!0,drawGraph:u,fixedBox:!0,forceDL:!0,trackerGroups:["group","dataLabels"],translate:function(){var a=this.yAxis,b=this.options,c=a.center;this.generatePoints();t(this.points,function(d){var f=o(b.dial,d.dial),g=w(q(f.radius,80))*c[2]/200,e=w(q(f.baseLength,70))*g/100,k=w(q(f.rearLength,10))*g/100,n=f.baseWidth||3,m=f.topWidth||1,i=b.overshoot,j=a.startAngleRad+a.translate(d.y,null,null,null,!0);i&&typeof i==="number"?(i=i/180*Math.PI,j=Math.max(a.startAngleRad-i,Math.min(a.endAngleRad+i,j))):b.wrap===!1&&(j=Math.max(a.startAngleRad,Math.min(a.endAngleRad,j)));j=j*180/Math.PI;d.shapeType="path";d.shapeArgs={d:f.path||["M",-k,-n/2,"L",e,-n/2,g,-m/2,g,m/2,e,n/2,-k,n/2,"z"],translateX:c[0],translateY:c[1],rotation:j};d.plotX=c[0];d.plotY=c[1]})},drawPoints:function(){var a=this,b=a.yAxis.center,c=a.pivot,d=a.options,f=d.pivot,g=a.chart.renderer;t(a.points,function(e){var c=e.graphic,b=e.shapeArgs,f=b.d,i=o(d.dial,e.dial);c?(c.animate(b),b.d=f):e.graphic=g[e.shapeType](b).attr({stroke:i.borderColor||"none","stroke-width":i.borderWidth||0,fill:i.backgroundColor||"black",rotation:b.rotation}).add(a.group)});c?c.animate({translateX:b[0],translateY:b[1]}):a.pivot=g.circle(0,0,q(f.radius,5)).attr({"stroke-width":f.borderWidth||0,stroke:f.borderColor||"silver",fill:f.backgroundColor||"black"}).translate(b[0],b[1]).add(a.group)},animate:function(a){var b=this;if(!a)t(b.points,function(a){var d=a.graphic;d&&(d.attr({rotation:b.yAxis.startAngleRad*180/Math.PI}),d.animate({rotation:a.shapeArgs.rotation},b.options.animation))}),b.animate=null},render:function(){this.group=this.plotGroup("group","series",this.visible?"visible":"hidden",this.options.zIndex,this.chart.seriesGroup);s.prototype.render.call(this);this.group.clip(this.chart.clipRect)},setData:function(a,b){s.prototype.setData.call(this,a,!1);this.processData();this.generatePoints();q(b,!0)&&this.chart.redraw()},drawTracker:R.drawTrackerPoint};h.gauge=x(h.line,G);p.boxplot=o(p.column,{fillColor:"#FFFFFF",lineWidth:1,medianWidth:2,states:{hover:{brightness:-.3}},threshold:null,tooltip:{pointFormat:'<span style="color:{series.color};font-weight:bold">{series.name}</span><br/>Maximum: {point.high}<br/>Upper quartile: {point.q3}<br/>Median: {point.median}<br/>Lower quartile: {point.q1}<br/>Minimum: {point.low}<br/>'},whiskerLength:"50%",whiskerWidth:2});h.boxplot=x(h.column,{type:"boxplot",pointArrayMap:["low","q1","median","q3","high"],toYData:function(a){return[a.low,a.q1,a.median,a.q3,a.high]},pointValKey:"high",pointAttrToOptions:{fill:"fillColor",stroke:"color","stroke-width":"lineWidth"},drawDataLabels:u,translate:function(){var a=this.yAxis,b=this.pointArrayMap;
h.column.prototype.translate.apply(this);t(this.points,function(c){t(b,function(b){c[b]!==null&&(c[b+"Plot"]=a.translate(c[b],0,1,0,1))})})},drawPoints:function(){var a=this,b=a.points,c=a.options,d=a.chart.renderer,f,g,e,k,n,m,i,j,h,l,p,H,r,o,I,u,x,s,v,w,z,y,E=a.doQuartiles!==!1,B=parseInt(a.options.whiskerLength,10)/100;t(b,function(b){h=b.graphic;z=b.shapeArgs;p={};o={};u={};y=b.color||a.color;if(b.plotY!==C)if(f=b.pointAttr[b.selected?"selected":""],x=z.width,s=A(z.x),v=s+x,w=D(x/2),g=A(E?b.q1Plot:b.lowPlot),e=A(E?b.q3Plot:b.lowPlot),k=A(b.highPlot),n=A(b.lowPlot),p.stroke=b.stemColor||c.stemColor||y,p["stroke-width"]=q(b.stemWidth,c.stemWidth,c.lineWidth),p.dashstyle=b.stemDashStyle||c.stemDashStyle,o.stroke=b.whiskerColor||c.whiskerColor||y,o["stroke-width"]=q(b.whiskerWidth,c.whiskerWidth,c.lineWidth),u.stroke=b.medianColor||c.medianColor||y,u["stroke-width"]=q(b.medianWidth,c.medianWidth,c.lineWidth),u["stroke-linecap"]="round",i=p["stroke-width"]%2/2,j=s+w+i,l=["M",j,e,"L",j,k,"M",j,g,"L",j,n,"z"],E&&(i=f["stroke-width"]%2/2,j=A(j)+i,g=A(g)+i,e=A(e)+i,s+=i,v+=i,H=["M",s,e,"L",s,g,"L",v,g,"L",v,e,"L",s,e,"z"]),B&&(i=o["stroke-width"]%2/2,k+=i,n+=i,r=["M",j-w*B,k,"L",j+w*B,k,"M",j-w*B,n,"L",j+w*B,n]),i=u["stroke-width"]%2/2,m=D(b.medianPlot)+i,I=["M",s,m,"L",v,m,"z"],h)b.stem.animate({d:l}),B&&b.whiskers.animate({d:r}),E&&b.box.animate({d:H}),b.medianShape.animate({d:I});else{b.graphic=h=d.g().add(a.group);b.stem=d.path(l).attr(p).add(h);if(B)b.whiskers=d.path(r).attr(o).add(h);if(E)b.box=d.path(H).attr(f).add(h);b.medianShape=d.path(I).attr(u).add(h)}})}});p.errorbar=o(p.boxplot,{color:"#000000",grouping:!1,linkedTo:":previous",tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.low}</b> - <b>{point.high}</b><br/>'},whiskerWidth:null});h.errorbar=x(h.boxplot,{type:"errorbar",pointArrayMap:["low","high"],toYData:function(a){return[a.low,a.high]},pointValKey:"high",doQuartiles:!1,drawDataLabels:h.arearange?h.arearange.prototype.drawDataLabels:u,getColumnMetrics:function(){return this.linkedParent&&this.linkedParent.columnMetrics||h.column.prototype.getColumnMetrics.call(this)}});p.waterfall=o(p.column,{lineWidth:1,lineColor:"#333",dashStyle:"dot",borderColor:"#333"});h.waterfall=x(h.column,{type:"waterfall",upColorProp:"fill",pointArrayMap:["low","y"],pointValKey:"y",init:function(a,b){b.stacking=!0;h.column.prototype.init.call(this,a,b)},translate:function(){var a=this.options,b=this.yAxis,c,d,f,g,e,k,n,m,i;c=a.threshold;a=a.borderWidth%2/2;h.column.prototype.translate.apply(this);m=c;f=this.points;for(d=0,c=f.length;d<c;d++){g=f[d];e=g.shapeArgs;k=this.getStack(d);i=k.points[this.index];if(isNaN(g.y))g.y=this.yData[d];n=T(m,m+g.y)+i[0];e.y=b.translate(n,0,1);g.isSum||g.isIntermediateSum?(e.y=b.translate(i[1],0,1),e.height=b.translate(i[0],0,1)-e.y):m+=k.total;e.height<0&&(e.y+=e.height,e.height*=-1);g.plotY=e.y=D(e.y)-a;e.height=D(e.height);g.yBottom=e.y+e.height}},processData:function(a){var b=this.yData,c=this.points,d,f=b.length,g=this.options.threshold||0,e,k,n,m,i,j;k=e=n=m=g;for(j=0;j<f;j++)i=b[j],d=c&&c[j]?c[j]:{},i==="sum"||d.isSum?b[j]=k:i==="intermediateSum"||d.isIntermediateSum?(b[j]=e,e=g):(k+=i,e+=i),n=Math.min(k,n),m=Math.max(k,m);s.prototype.processData.call(this,a);this.dataMin=n;this.dataMax=m},toYData:function(a){if(a.isSum)return"sum";else if(a.isIntermediateSum)return"intermediateSum";return a.y},getAttribs:function(){h.column.prototype.getAttribs.apply(this,arguments);var a=this.options,b=a.states,c=a.upColor||this.color,a=l.Color(c).brighten(.1).get(),d=o(this.pointAttr),f=this.upColorProp;d[""][f]=c;d.hover[f]=b.hover.upColor||a;d.select[f]=b.select.upColor||c;t(this.points,function(a){if(a.y>0&&!a.color)a.pointAttr=d,a.color=c})},getGraphPath:function(){var a=this.data,b=a.length,c=D(this.options.lineWidth+this.options.borderWidth)%2/2,d=[],f,g,e;for(e=1;e<b;e++)g=a[e].shapeArgs,f=a[e-1].shapeArgs,g=["M",f.x+f.width,f.y+c,"L",g.x,f.y+c],a[e-1].y<0&&(g[2]+=f.height,g[5]+=f.height),d=d.concat(g);return d},getExtremes:u,getStack:function(a){var b=this.yAxis.stacks,c=this.stackKey;this.processedYData[a]<this.options.threshold&&(c="-"+c);return b[c][a]},drawGraph:s.prototype.drawGraph});p.bubble=o(p.scatter,{dataLabels:{inside:!0,style:{color:"white",textShadow:"0px 0px 3px black"},verticalAlign:"middle"},marker:{lineColor:null,lineWidth:1},minSize:8,maxSize:"20%",tooltip:{pointFormat:"({point.x}, {point.y}), Size: {point.z}"},turboThreshold:0,zThreshold:0});h.bubble=x(h.scatter,{type:"bubble",pointArrayMap:["y","z"],parallelArrays:["x","y","z"],trackerGroups:["group","dataLabelsGroup"],bubblePadding:!0,pointAttrToOptions:{stroke:"lineColor","stroke-width":"lineWidth",fill:"fillColor"},applyOpacity:function(a){var b=this.options.marker,c=q(b.fillOpacity,.5),a=a||b.fillColor||this.color;c!==1&&(a=U(a).setOpacity(c).get("rgba"));return a},convertAttribs:function(){var a=s.prototype.convertAttribs.apply(this,arguments);a.fill=this.applyOpacity(a.fill);return a},getRadii:function(a,b,c,d){var f,g,e,k=this.zData,n=[],m=this.options.sizeBy!=="width";for(g=0,f=k.length;g<f;g++)e=b-a,e=e>0?(k[g]-a)/(b-a):.5,m&&e>=0&&(e=Math.sqrt(e)),n.push(v.ceil(c+e*(d-c))/2);this.radii=n},animate:function(a){var b=this.options.animation;if(!a)t(this.points,function(a){var d=a.graphic,a=a.shapeArgs;d&&a&&(d.attr("r",1),d.animate({r:a.r},b))}),this.animate=null},translate:function(){var a,b=this.data,c,d,f=this.radii;h.scatter.prototype.translate.call(this);for(a=b.length;a--;)c=b[a],d=f?f[a]:0,c.negative=c.z<(this.options.zThreshold||0),d>=this.minPxSize/2?(c.shapeType="circle",c.shapeArgs={x:c.plotX,y:c.plotY,r:d},c.dlBox={x:c.plotX-d,y:c.plotY-d,width:2*d,height:2*d}):c.shapeArgs=c.plotY=c.dlBox=C},drawLegendSymbol:function(a,b){var c=w(a.itemStyle.fontSize)/2;b.legendSymbol=this.chart.renderer.circle(c,a.baseline-c,c).attr({zIndex:3}).add(b.legendGroup);b.legendSymbol.isMarker=!0},drawPoints:h.column.prototype.drawPoints,alignDataLabel:h.column.prototype.alignDataLabel});L.prototype.beforePadding=function(){var a=this,b=this.len,c=this.chart,d=0,f=b,g=this.isXAxis,e=g?"xData":"yData",k=this.min,n={},m=v.min(c.plotWidth,c.plotHeight),i=Number.MAX_VALUE,j=-Number.MAX_VALUE,h=this.max-k,l=b/h,p=[];this.tickPositions&&(t(this.series,function(b){var e=b.options;if(b.bubblePadding&&(b.visible||!c.options.chart.ignoreHiddenSeries))if(a.allowZoomOutside=!0,p.push(b),g)t(["minSize","maxSize"],function(a){var b=e[a],g=/%$/.test(b),b=w(b);n[a]=g?m*b/100:b}),b.minPxSize=n.minSize,b=b.zData,b.length&&(i=v.min(i,v.max(N(b),e.displayNegative===!1?e.zThreshold:-Number.MAX_VALUE)),j=v.max(j,O(b)))}),t(p,function(a){var b=a[e],c=b.length,m;g&&a.getRadii(i,j,n.minSize,n.maxSize);if(h>0)for(;c--;)typeof b[c]==="number"&&(m=a.radii[c],d=Math.min((b[c]-k)*l-m,d),f=Math.max((b[c]-k)*l+m,f))}),p.length&&h>0&&q(this.options.min,this.userMin)===C&&q(this.options.max,this.userMax)===C&&(f-=b,l*=(b+d-f)/b,this.min+=d/l,this.max+=f/l))};(function(){function a(a,b,c){a.call(this,b,c);if(this.chart.polar)this.closeSegment=function(a){var b=this.xAxis.center;a.push("L",b[0],b[1])},this.closedStacks=!0}function b(a,b){var c=this.chart,d=this.options.animation,f=this.group,i=this.markerGroup,j=this.xAxis.center,h=c.plotLeft,l=c.plotTop;if(c.polar){if(c.renderer.isSVG)if(d===!0&&(d={}),b){if(c={translateX:j[0]+h,translateY:j[1]+l,scaleX:.001,scaleY:.001},f.attr(c),i)i.attrSetters=f.attrSetters,i.attr(c)}else c={translateX:h,translateY:l,scaleX:1,scaleY:1},f.animate(c,d),i&&i.animate(c,d),this.animate=null}else a.call(this,b)}var c=s.prototype,d=Q.prototype,f;c.toXY=function(a){var b,c=this.chart,d=a.plotX;b=a.plotY;a.rectPlotX=d;a.rectPlotY=b;d=(d/Math.PI*180+this.xAxis.pane.options.startAngle)%360;d<0&&(d+=360);a.clientX=d;b=this.xAxis.postTranslate(a.plotX,this.yAxis.len-b);a.plotX=a.polarPlotX=b.x-c.plotLeft;a.plotY=a.polarPlotY=b.y-c.plotTop};c.orderTooltipPoints=function(a){if(this.chart.polar&&(a.sort(function(a,b){return a.clientX-b.clientX}),a[0]))a[0].wrappedClientX=a[0].clientX+360,a.push(a[0])};h.area&&r(h.area.prototype,"init",a);h.areaspline&&r(h.areaspline.prototype,"init",a);h.spline&&r(h.spline.prototype,"getPointSpline",function(a,b,c,d){var f,i,j,h,l,p,o;if(this.chart.polar){f=c.plotX;i=c.plotY;a=b[d-1];j=b[d+1];this.connectEnds&&(a||(a=b[b.length-2]),j||(j=b[1]));if(a&&j)h=a.plotX,l=a.plotY,b=j.plotX,p=j.plotY,h=(1.5*f+h)/2.5,l=(1.5*i+l)/2.5,j=(1.5*f+b)/2.5,o=(1.5*i+p)/2.5,b=Math.sqrt(Math.pow(h-f,2)+Math.pow(l-i,2)),p=Math.sqrt(Math.pow(j-f,2)+Math.pow(o-i,2)),h=Math.atan2(l-i,h-f),l=Math.atan2(o-i,j-f),o=Math.PI/2+(h+l)/2,Math.abs(h-o)>Math.PI/2&&(o-=Math.PI),h=f+Math.cos(o)*b,l=i+Math.sin(o)*b,j=f+Math.cos(Math.PI+o)*p,o=i+Math.sin(Math.PI+o)*p,c.rightContX=j,c.rightContY=o;d?(c=["C",a.rightContX||a.plotX,a.rightContY||a.plotY,h||f,l||i,f,i],a.rightContX=a.rightContY=null):c=["M",f,i]}else c=a.call(this,b,c,d);return c});r(c,"translate",function(a){a.call(this);if(this.chart.polar&&!this.preventPostTranslate)for(var a=this.points,b=a.length;b--;)this.toXY(a[b])});r(c,"getSegmentPath",function(a,b){var c=this.points;if(this.chart.polar&&this.options.connectEnds!==!1&&b[b.length-1]===c[c.length-1]&&c[0].y!==null)this.connectEnds=!0,b=[].concat(b,[c[0]]);return a.call(this,b)});r(c,"animate",b);r(c,"setTooltipPoints",function(a,b){this.chart.polar&&y(this.xAxis,{tooltipLen:360});return a.call(this,b)});if(h.column)f=h.column.prototype,r(f,"animate",b),r(f,"translate",function(a){var b=this.xAxis,c=this.yAxis.len,d=b.center,f=b.startAngleRad,h=this.chart.renderer,j,l;this.preventPostTranslate=!0;a.call(this);if(b.isRadial){b=this.points;for(l=b.length;l--;)j=b[l],a=j.barX+f,j.shapeType="path",j.shapeArgs={d:h.symbols.arc(d[0],d[1],c-j.plotY,null,{start:a,end:a+j.pointWidth,innerR:c-q(j.yBottom,c)})},this.toXY(j)}}),r(f,"alignDataLabel",function(a,b,d,f,h,i){if(this.chart.polar){a=b.rectPlotX/Math.PI*180;if(f.align===null)f.align=a>20&&a<160?"left":a>200&&a<340?"right":"center";if(f.verticalAlign===null)f.verticalAlign=a<45||a>315?"bottom":a>135&&a<225?"top":"middle";c.alignDataLabel.call(this,b,d,f,h,i)}else a.call(this,b,d,f,h,i)});r(d,"getIndex",function(a,b){var c,d=this.chart,f;d.polar?(f=d.xAxis[0].center,c=b.chartX-f[0]-d.plotLeft,d=b.chartY-f[1]-d.plotTop,c=180-Math.round(Math.atan2(c,d)/Math.PI*180)):c=a.call(this,b);return c});r(d,"getCoordinates",function(a,b){var c=this.chart,d={xAxis:[],yAxis:[]};c.polar?t(c.axes,function(a){var f=a.isXAxis,g=a.center,h=b.chartX-g[0]-c.plotLeft,g=b.chartY-g[1]-c.plotTop;d[f?"xAxis":"yAxis"].push({axis:a,value:a.translate(f?Math.PI-Math.atan2(h,g):Math.sqrt(Math.pow(h,2)+Math.pow(g,2)),!0)})}):d=a.call(this,b);return d})})()})(Highcharts);SM.InfiniteScroll=SM.Widgets.register({__NAME:"infiniteScroll",__defaults:{threshold:100,markerID:"",windowScroll:false,onReachedEnd:function(self){},isActive:true},LATENCY:200,removeMarker:function(){this._getMarker().remove()},__init:function(){var self=this;this._$window=$(window);this.__settings.markerID="#"+this.__settings.markerID;this._hasLeftThreshold=true;if(this.__settings.isActive){this._bindEvents();setTimeout(function(){if(self._isInThreshold()){self._hitThreshold()}},0)}},__setters:{isActive:function(self,val){if(val){self._activate()}else{self._deactivate()}}},_activate:function(){if(!this._hasMarker()){this._deactivate()}if(!this.__settings.isActive){this.__settings.isActive=true;this._hasLeftThreshold=true;this._bindEvents();if(this._isInThreshold()){this._hitThreshold()}}},_deactivate:function(){if(this.__settings.isActive||!this._hasMarker()){this.__settings.isActive=false;this._unbindEvents()}},__destroy:function(){this.set("isActive",false)},_bindEvents:function(){if(this.get("windowScroll")){this._$window.on("scroll",{self:this},this._onScroll)}else{this.$el.on("scroll",{self:this},this._onScroll)}this._$window.on("resize",{self:this},this._onScroll)},_unbindEvents:function(){if(this.get("windowScroll")){this._$window.off("scroll",this._onScroll)}else{this.$el.off("scroll",this._onScroll)}this._$window.off("resize",this._onScroll)},_hasMarker:function(){return this._getMarker().length>0},_hitThreshold:function(){if(this.__settings.isActive){this.set("isActive",false);this.__settings.onReachedEnd(this);this.trigger("reachedEnd")}},_getScrollBottom:function(){if(this.__settings.windowScroll){return this._$window.scrollTop()+this._$window.height()}else{return this.$el.scrollTop()+this.el.clientHeight}},_getMarker:function(){return $(this.get("markerID"))},_getMarkerTop:function(){var $marker=this._getMarker(),coords;if(this.__settings.windowScroll){coords=SM.DOM.getCoordinates($marker[0])}else{coords=SM.DOM.getCoordinates($marker[0],this.$el[0])}return coords.top},_isInThreshold:function(){var isInThreshold;if(!this._hasMarker()){this.set("isActive",false);return false}isInThreshold=this._getScrollBottom()>=this._getMarkerTop()-this.get("threshold");return isInThreshold},_checkIfHitThreshold:function(){var isInThresholdNow=this._isInThreshold();if(isInThresholdNow){if(this._hasLeftThreshold){this._hitThreshold()}}this._hasLeftThreshold=!isInThresholdNow},_onScroll:function(e){var self=e.data.self;if(!self._isThrottling&&self.__settings.isActive){self._isThrottling=true;self._checkIfHitThreshold();setTimeout(function(){if(self.__settings.isActive){self._checkIfHitThreshold()}self._isThrottling=false},self.LATENCY)}}});SM.MultiSelect=SM.Widgets.register({__NAME:"multiselect",__defaults:{checkboxSelector:'input[type="checkbox"]'},__init:function(){this.set("lastTarget",null);this._checkedSelector=this.get("checkboxSelector")+":checked";$(document).on("keydown",{self:this},this._onKeydown).on("keyup",{self:this},this._onKeyup);this.$el.on("change",this.get("checkboxSelector"),{self:this},this._onCheckboxChange)},__destroy:function(){this.set("lastTarget",null);$(document).off("keydown",this._onKeydown).off("keyup",this._onKeyup)},reset:function(){this.set("lastTarget",null)},_applySelection:function(target){var lastTarget=this._getLastTarget(),$checkboxes,lastIndex,firstIndex,tempIndex;$checkboxes=this.$el.find(this.get("checkboxSelector"));lastIndex=$checkboxes.index(lastTarget);firstIndex=$checkboxes.index(target);if(lastIndex===firstIndex){return}if(lastIndex<firstIndex){tempIndex=lastIndex;lastIndex=firstIndex;firstIndex=tempIndex}$checkboxes=$checkboxes.slice(firstIndex,lastIndex+1);$checkboxes.each(function(){this.checked=true});this.trigger({type:"applied",$checkboxes:$checkboxes})},_getLastTarget:function(){return this.get("lastTarget")||this.$el.find(this.get("checkboxSelector")).first().get(0)},_onCheckboxChange:function(e){var self=e.data.self,$target=$(e.target),isChecked=$target.prop("checked");if(isChecked&&self._isShiftPressed){self._applySelection(e.target)}self.set("lastTarget",e.target);if(!isChecked&&!self.$el.find(self._checkedSelector).length){self.reset()}},_onKeyup:function(e){if(e.which===SM.KeyCodes.SHIFT){e.data.self._isShiftPressed=false}},_onKeydown:function(e){if(e.which===SM.KeyCodes.SHIFT){e.data.self._isShiftPressed=true}}});(function($){$.fn.scrollIntoView=function(duration,easing,complete){var opts=$.extend({},$.fn.scrollIntoView.defaults);if($.type(duration)=="object"){$.extend(opts,duration)}else if($.type(duration)=="number"){$.extend(opts,{duration:duration,easing:easing,complete:complete})}else if(duration==false){opts.smooth=false}var elY=Infinity,elH=0;if(this.size()==1)(elY=this.get(0).offsetTop)==null||(elH=elY+this.get(0).offsetHeight);else this.each(function(i,el){el.offsetTop<elY?elY=el.offsetTop:el.offsetTop+el.offsetHeight>elH?elH=el.offsetTop+el.offsetHeight:null});elH-=elY;var pEl=this.commonAncestor().get(0);var wH=$(window).height();while(pEl){var pY=pEl.scrollTop,pH=pEl.clientHeight;if(pH>wH)pH=wH;if(pH==0&&pEl.tagName=="BODY")pH=wH;if(pEl.scrollTop!=((pEl.scrollTop+=1)==null||pEl.scrollTop)&&(pEl.scrollTop-=1)!=null||pEl.scrollTop!=((pEl.scrollTop-=1)==null||pEl.scrollTop)&&(pEl.scrollTop+=1)!=null){if(elY<=pY)scrollTo(pEl,elY);else if(elY+elH>pY+pH)scrollTo(pEl,elY+elH-pH);else scrollTo(pEl,undefined);return}pEl=pEl.parentNode}function scrollTo(el,scrollTo){if(scrollTo===undefined){if($.isFunction(opts.complete))opts.complete.call(el)}else if(opts.smooth){$(el).stop().animate({scrollTop:scrollTo},opts)}else{el.scrollTop=scrollTo;if($.isFunction(opts.complete))opts.complete.call(el)}}return this};$.fn.scrollIntoView.defaults={smooth:true,duration:null,easing:$.easing&&$.easing.easeOutExpo?"easeOutExpo":null,complete:$.noop(),step:null,specialEasing:{}};$.fn.isOutOfView=function(completely){var outOfView=true;this.each(function(){var pEl=this.parentNode,pY=pEl.scrollTop,pH=pEl.clientHeight,elY=this.offsetTop,elH=this.offsetHeight;if(completely?elY>pY+pH:elY+elH>pY+pH){}else if(completely?elY+elH<pY:elY<pY){}else outOfView=false});return outOfView};$.fn.commonAncestor=function(){var parents=[];var minlen=Infinity;$(this).each(function(){var curparents=$(this).parents();parents.push(curparents);minlen=Math.min(minlen,curparents.length)});for(var i=0;i<parents.length;i++){parents[i]=parents[i].slice(parents[i].length-minlen)}for(var i=0;i<parents[0].length;i++){var equal=true;for(var j in parents){if(parents[j][i]!=parents[0][i]){equal=false;break}}if(equal)return $(parents[0][i])}return $([])}})(jQuery);SM.Hightables=new function(){var self=this;self.renderTable=function(options){var tableData=options.tableData,tableClasses=options.tableClasses,tableAttrs=options.tableAttrs,$target=options.target,tableHTML,$table=$('<table cellpadding="0" cellspacing="0"></table>'),$thead=$("<thead></thead>"),$tbody=$("<tbody></tbody>"),$tfoot=$("<tfoot></tfoot>");if(tableData.caption){_renderTableCaption(tableData.caption,$table)}if(tableData.thead.rows){_renderTableRows(tableData.thead.rows,$thead);$table.append($thead)}_renderTableRows(tableData.tbody.rows,$tbody);$table.append($tbody);if(tableData.tfoot){_renderTableRows(tableData.tfoot.rows,$tfoot);$table.append($tfoot)}$table.addClass(tableClasses);_.each(tableAttrs,function(value,key){$table.attr("data-"+key,value)});if(options.useDivs||options.flattenNestedTables){tableHTML=$table[0].outerHTML;if(options.useDivs){tableHTML=_convertTableTagsToDivs(tableHTML)}if(options.flattenNestedTables){tableHTML=_flattenNestedTables(tableHTML)}$table=$(tableHTML)}_bindEvents($table,options.events);$target.append($table)};function _renderTableCaption(caption,$table){var captionHTML=SM.Template.renderHTML(caption.template,caption.context);$table.append(captionHTML)}function _renderTableRows(tableRows,tableSection){var rowHTML,cellHTML,$tr;_.each(tableRows,function(tableRow){rowHTML=_renderTableRow(tableRow);$tr=$(rowHTML);if(tableRow.cells){_.each(tableRow.cells,function(tableCell){cellHTML=_renderTableCell(tableCell);$tr.append(cellHTML)})}tableSection.append($tr)})}function _renderTableRow(tableRow){var rowHTML;if(tableRow.template){rowHTML=SM.Template.renderHTML(tableRow.template,tableRow.context)}else{rowHTML="<tr></tr>"}return rowHTML}function _renderTableCell(tableCell){var cellHTML=SM.Template.renderHTML(tableCell.template,tableCell.context);return cellHTML}function _convertTableTagsToDivs(tableHTML){var tags=["table","caption","thead","tbody","tfoot","tr","th","td"];_.each(tags,function(tag){var openingTagRegex=new RegExp("<"+tag,"g"),openingHTML="<div display='"+tag+"'",closingTagRegex=new RegExp("</"+tag,"g"),closingHTML="</div";tableHTML=tableHTML.replace(openingTagRegex,openingHTML).replace(closingTagRegex,closingHTML)});return tableHTML}function _flattenNestedTables(tableHTML){var $table=$(tableHTML),$nestedTable=$table.find(".nested-table"),nestedTableHTML;if($nestedTable.length){nestedTableHTML=$nestedTable.html();$nestedTable.remove();tableHTML=$table[0].outerHTML+nestedTableHTML}return tableHTML}function _bindEvents($table,eventHandlers){var onCaptionClick=eventHandlers.captionClick,onTdMouseEnter=eventHandlers.tdMouseEnter,onTdMouseLeave=eventHandlers.tdMouseLeave,onThClick=eventHandlers.thClick,onTdClick=eventHandlers.tdClick;$table.on("click","caption",function(e){if(onCaptionClick){onCaptionClick(e)}});$table.on("click","th",function(e){if(onThClick){onThClick(e)}});$table.on("click","td",function(e){if(onTdClick){onTdClick(e)}});$table.on("mouseenter","td",function(e){if(onTdMouseEnter){onTdMouseEnter(e)}});$table.on("mouseleave","td",function(e){if(onTdMouseLeave){onTdMouseLeave(e)}})}};SM.Highcharts={};SM.Highcharts.CHART_WIDTH=594;SM.Highcharts.MARGIN_TOP=0;SM.Highcharts.MARGIN_BOTTOM=40;SM.Highcharts.MARGIN_LEFT=95;SM.Highcharts.PLOT_AREA_WIDTH=SM.Highcharts.CHART_WIDTH-SM.Highcharts.MARGIN_LEFT;SM.Highcharts.X_AXIS_MAX_VISIBLE_LINES=4;SM.Highcharts.Y_AXIS_MAX_VISIBLE_LINES=3;SM.Highcharts.AXIS_LABEL_CHARACTER_WIDTH=8;SM.Highcharts.DATA_LABEL_CHARACTER_WIDTH=8;SM.Highcharts.DATA_LABEL_CHARACTER_HEIGHT=15;SM.Highcharts.DATA_LABEL_PADDING=10;SM.Highcharts.LEGEND_MARGIN_TOP=20;SM.Highcharts.NUM_SIGNIFICANT_DIGITS=2;SM.Highcharts.MAX_TITLE_CHARS=85;SM.Highcharts.calculateBarHeight=function(numBars){return Math.max(120-Math.ceil(numBars/2)*20,50)};SM.Highcharts.calculateChartHeight=function(chartType,options){var answerStructures=options.answerStructures,titleHeight=options.titleHeight,labelHeight=options.labelHeight,legendHeight=options.legendHeight,totalHeight,minHeight=chartType==="pie"?320:250,plotAreaHeight=chartType==="boxplot"?145:200,marginTop=SM.Highcharts.calculateMarginTop(titleHeight),marginBottom=SM.Highcharts.calculateMarginBottom(labelHeight,legendHeight),numRows;if(chartType==="bar"){plotAreaHeight=SM.Highcharts.calculateBarChartHeight(options)}if(chartType==="pie"||chartType==="donut"){numRows=answerStructures.rows.length;plotAreaHeight=numRows*18}totalHeight=plotAreaHeight+marginTop+marginBottom;return Math.max(totalHeight,minHeight)};SM.Highcharts.calculateBarChartHeight=function(options){var rows=options.answerStructures.rows,columns=options.answerStructures.cols,chartIndex=options.chartIndex,hasColumns=!_.isEmpty(columns),hasColumnChoices=hasColumns&&!_.isEmpty(columns[0].items),columnChoices=hasColumnChoices?columns[0].items:null,numColumnChoices=0,numBars,barHeight,plotAreaHeight;numBars=rows.length;if(hasColumnChoices){numColumnChoices=_.isArray(columnChoices)?_.size(columnChoices):_.size(_.keys(columnChoices))}if(options.isStacked){if(hasColumns){if(options.isMirrored){if(hasColumnChoices){numBars=numColumnChoices}else{numBars=columns.length}}else{numBars=rows.length}}else{numBars=1}}else{if(hasColumns){if(options.isDistribution){numBars=numBars*columns.length;if(hasColumnChoices){if(options.isCompared){numBars=_.flatten(_.map(columns,function(c){return c.items})).length}else{numBars=columns[chartIndex].items.length*columns.length}}}else{if(hasColumnChoices){if(options.isCompared){numBars=numColumnChoices}else{numBars=rows.length}}else{if(options.isMirrored){numBars=columns.length}else{numBars=rows.length}}}}}barHeight=SM.Highcharts.calculateBarHeight(numBars);plotAreaHeight=numBars*barHeight;return plotAreaHeight};SM.Highcharts.calculateTrendChartHeight=function(chartType,titleHeight,labelHeight,legendHeight,spacingBottom){var totalHeight,minHeight=250,plotAreaHeight=200,marginTop=SM.Highcharts.calculateMarginTop(titleHeight),marginBottom=SM.Highcharts.calculateMarginBottom(labelHeight,legendHeight);spacingBottom=spacingBottom||0;totalHeight=plotAreaHeight+marginTop+marginBottom+spacingBottom;return Math.max(totalHeight,minHeight)};SM.Highcharts.calculateChartWidth=function(chartType,options){var multiplier,calculatedWidth=0,numPoints;var numSeries=options.numSeries,numXAxisLabels=options.numXAxisLabels,isCompared=options.isCompared;if(options.isStacked){numPoints=numXAxisLabels}else if(isCompared){if(_.include(["line","area"],chartType)){numPoints=numSeries}else{numPoints=numXAxisLabels*numSeries}}else{numPoints=Math.max(numSeries,numXAxisLabels)}multiplier=Math.max(100-Math.ceil(numPoints/5)*20,30);if(_.contains(["column","line","area"],chartType)){calculatedWidth=multiplier*numPoints}return Math.max(calculatedWidth,SM.Highcharts.CHART_WIDTH)};SM.Highcharts.calculateMarginTop=function(defaultMargin,titleHeight){var marginTop=defaultMargin;if(titleHeight){marginTop+=titleHeight}return marginTop};SM.Highcharts.calculateMarginBottom=function(labelHeight,legendHeight,spacingBottom){var labelMarginBottom=10,legendMarginTop=SM.Highcharts.LEGEND_MARGIN_TOP,marginBottom;marginBottom=labelMarginBottom+labelHeight;if(legendHeight&&legendHeight>0){marginBottom+=legendMarginTop+legendHeight}if(spacingBottom){marginBottom+=spacingBottom}return marginBottom};SM.Highcharts.calculateSpacingBottom=function(spacingBottom,legendHeight){if(legendHeight&&legendHeight>0){spacingBottom+=SM.Highcharts.LEGEND_MARGIN_TOP+legendHeight}return spacingBottom};SM.Highcharts.calculateMarginBottom=function(labelHeight,legendHeight){var defaultMarginBottom=20,legendMarginTop=SM.Highcharts.LEGEND_MARGIN_TOP,marginBottom;marginBottom=defaultMarginBottom+labelHeight;if(legendHeight&&legendHeight>0){marginBottom+=legendMarginTop+legendHeight}return marginBottom};SM.Highcharts.calculateLegendHeight=function(series){var legendWidth=SM.Highcharts.PLOT_AREA_WIDTH,legendSwatchWidth=18,legendSwatchMarginRight=10,legendItemHeight=15,legendItemMarginTop=5,legendItemMarginBottom=5,legendItemOuterHeight=legendItemHeight+legendItemMarginTop+legendItemMarginBottom,legendItemWidth,legendItemTextWidth,legendItemCharacterWidth=5,currentLineWidth=0,numLines=1,legendItems;if(!_.isEmpty(series)){legendItems=series[0].name?series:series[0].data;_.each(legendItems,function(legendItem){if(legendItem.showInLegend!==false){legendItemTextWidth=(legendItem.name?legendItem.name.length:0)*legendItemCharacterWidth+6;legendItemWidth=legendSwatchWidth+legendSwatchMarginRight+legendItemTextWidth;if(currentLineWidth+legendItemWidth>legendWidth){currentLineWidth=legendItemWidth;numLines+=1}else{currentLineWidth+=legendItemWidth}}})}return numLines*legendItemOuterHeight};SM.Highcharts.calculateLegendHeight_fixedItemWidth=function(series){var legendWidth=SM.Highcharts.PLOT_AREA_WIDTH,legendItemHeight=15,legendItemMarginTop=5,legendItemMarginBottom=5,legendItemOuterHeight=legendItemHeight+legendItemMarginTop+legendItemMarginBottom,legendMarginTop=20,legendItemWidthLimit=99,legendItemLines=1,legendItemWidth=99,charWidth=3.5,numLegendsPerLine,legendItems=series[0].name?series:series[0].data;if(series[0].name){legendItemWidth=series[0].name.length*charWidth;if(legendItemWidthLimit<legendItemWidth){legendItemLines=Math.ceil(legendItemWidth/legendItemWidthLimit)}}numLegendsPerLine=Math.floor(legendWidth/legendItemWidthLimit);return legendItemLines*_.size(legendItems)*legendItemOuterHeight/numLegendsPerLine+legendMarginTop};SM.Highcharts.calculateXAxisLabelHeight=function(chartType,labels){var maxLabelLength,maxLabelWidth,maxCharsPerLine,numLines,maxNumLines,visibleNumLines;if(_.isEmpty(labels)){return 0}if(_.contains(["column","line","area"],chartType)){maxLabelLength=_.max(_.map(labels,function(l){return l.length}));maxLabelWidth=514/labels.length;maxCharsPerLine=Math.ceil(maxLabelWidth/SM.Highcharts.AXIS_LABEL_CHARACTER_WIDTH);numLines=Math.ceil(maxLabelLength/maxCharsPerLine);maxNumLines=SM.Highcharts.X_AXIS_MAX_VISIBLE_LINES;visibleNumLines=numLines>maxNumLines?maxNumLines:numLines;return visibleNumLines*15}return 30};SM.Highcharts.formatAxisLabel=function(value,maxWidth,maxNumLines){return _.isNumber(value)&&_.isFinite(value)?SM.Highcharts.formatNumericAxisLabel(value):SM.Highcharts.formatTextualAxisLabel(value,maxWidth,maxNumLines)};SM.Highcharts.formatNumericAxisLabel=function(x){var s,e;if(Math.abs(x)<=1e3){return x}s=["k","M","B","T"];e=Math.floor(Math.log(Math.abs(x))/Math.log(1e3));return x/Math.pow(1e3,e)+s[e-1]};SM.Highcharts.formatTextualAxisLabel=function(value,maxWidth,maxNumLines){var maxCharsPerLine=Math.ceil(maxWidth/SM.Highcharts.AXIS_LABEL_CHARACTER_WIDTH),lines=[],visibleLines,tokens,numLines,lastLine,currentLine;if(value.length>maxCharsPerLine){tokens=value.replace(/\ /g,"\xa0").split("\xa0");currentLine="";_.each(tokens,function(token,tokenIndex){if(token.length+1+currentLine.length<=maxCharsPerLine){currentLine+=" "+token}else{if(tokenIndex!==0){lines.push(currentLine)}if(token.length>=maxCharsPerLine){numLines=Math.ceil(token.length/maxCharsPerLine);_.times(numLines,function(i){currentLine=token.slice(i*maxCharsPerLine,(i+1)*maxCharsPerLine);if(currentLine.length===maxCharsPerLine&&i!==numLines-1){lines.push(currentLine)}})}else{currentLine=token}}if(tokenIndex===tokens.length-1){lines.push(currentLine)}});lines=_.map(lines,function(l){return $.trim(l)});visibleLines=lines.slice(0,maxNumLines);if(lines.length>maxNumLines){lastLine=visibleLines[visibleLines.length-1];if(lastLine.length+3>maxCharsPerLine){visibleLines[visibleLines.length-1]=lastLine.slice(0,maxCharsPerLine-3)+"..."}else{visibleLines[visibleLines.length-1]+="..."}}value=_.map(visibleLines,function(line){return"<div>"+_.escape(line)+"</div>"});value=value.join(" ")}else{value=_.escape(value)}return value};SM.Highcharts.xAxisLabelFormatter=function(){var numCategories=this.axis.options.categories.length,maxWidth=this.axis.width/numCategories,maxNumLines=SM.Highcharts.X_AXIS_MAX_VISIBLE_LINES;return SM.Highcharts.formatAxisLabel(this.value,maxWidth,maxNumLines)};SM.Highcharts.yAxisLabelFormatter=function(){var maxWidth=100,maxNumLines=SM.Highcharts.Y_AXIS_MAX_VISIBLE_LINES,value=this.value;if(_.isNumber(value)&&_.isFinite(value)&&this.axis.max<value){return""}return SM.Highcharts.formatAxisLabel(value,maxWidth,maxNumLines)};SM.Highcharts.percentageLabelFormatter=function(){var value=this.value;if(_.isNumber(value)&&_.isFinite(value)&&this.axis.max<value){return""}return value+"%"};SM.Highcharts.highchartsRenderLegendItem=Highcharts.Legend.prototype.renderItem;SM.Highcharts.renderLegendItem=function(item){var hideItem=item.userOptions&&item.userOptions.__options?item.userOptions.__options.hideLegendItem:false;if(!hideItem){SM.Highcharts.highchartsRenderLegendItem.call(this,item)}};Highcharts.Legend.prototype.renderItem=SM.Highcharts.renderLegendItem;Highcharts.Legend.prototype.preExistingPositionItem=Highcharts.Legend.prototype.positionItem;SM.Highcharts.legendPositionItem=function(item){var hideItem=item.userOptions&&item.userOptions.__options?item.userOptions.__options.hideLegendItem:false;if(!hideItem){Highcharts.Legend.prototype.preExistingPositionItem.call(this,item)}};Highcharts.Legend.prototype.positionItem=SM.Highcharts.legendPositionItem;SM.Highcharts.legendFormatter=function(){var self=this;self.name=_.escape(self.name);self.name=_.string.truncate(self.name,90);return self.name};SM.Highcharts.legendUnescapedFormatter=function(){var self=this;self.name=_.string.truncate(self.name,90);return self.name};SM.Highcharts.formatTooltip=function(){var absoluteY=SM.Highcharts.formatYValue(this.point.absoluteY,"absolute",0),percentageY=SM.Highcharts.formatYValue(this.point.percentageY,"percent",2),html;if(percentageY){html="<span>"+absoluteY+"</span>"+" "+"<span>("+percentageY+")</span>"}else if(absoluteY){html="<span>"+absoluteY+"</span>"}return html};SM.Highcharts.formatTooltipNpsScore=function(){var absoluteY=SM.Highcharts.formatYValue(this.point.absoluteY,"absolute",0),html;if(absoluteY){html="<span>"+absoluteY+"</span>"}return html};SM.Highcharts.formatTooltipNpsDetailed=function(){var absoluteY=SM.Highcharts.formatYValue(this.point.absoluteY,"absolute",0),percentageY=SM.Highcharts.formatYValue(this.point.percentageY,"percent",2),pointName="",name,html;if(this.point.name){pointName=this.point.name}else if(this.series.name){pointName=this.series.name}name='<span style="font-weight: bold; text-align:center">'+pointName+"</span><br>";if(percentageY){html=name+"<span>"+absoluteY+"</span>"+" "+"<span>("+percentageY+")</span>"}else if(absoluteY){html="<span>"+absoluteY+"</span>"}return html};SM.Highcharts.getGlobalizeFormatType=function(scaleType,decimalPlaces){var formatType;if(scaleType==="percent"){formatType="p"+decimalPlaces}else{formatType="n"+decimalPlaces
}return formatType};SM.Highcharts.formatYValue=function(yValue,scaleType,decimalPlaces){var formatType=SM.Highcharts.getGlobalizeFormatType(scaleType,decimalPlaces);if(yValue){if(scaleType==="percent"){yValue=parseFloat(yValue)/100}yValue=Globalize.format(yValue,formatType)}return yValue};SM.Highcharts.floatingPointFormatter=function(){return Globalize.format(this.point.y,"n2")};SM.Highcharts.integerPointFormatter=function(){return Globalize.format(this.point.y,"n0")};SM.Highcharts.bindYAxisEvents=function($chartContainer,yAxis){if(yAxis&&yAxis.ticks){_.each(yAxis.ticks,function(tick,tickPos){var $el=$(tick.label.element);$el.unbind("click");$el.click({tickPos:tickPos,self:self},function(e){if(self.display&&!self.display.getBenchmarkDisplay()){SM.CustomizeActionMenu.actionMenu.call(self,e,"yAxisLabel",{parent:$chartContainer})}})})}};SM.Highcharts.bindXAxisEvents=function(){};SM.Highcharts.bindAreaChartEvents=function($chartContainer){var $paths=$chartContainer.find(".highcharts-series path");$paths.click(function(e){if(self.display&&!self.display.getBenchmarkDisplay()){SM.CustomizeActionMenu.actionMenu.call(self,e,"area",{parent:$chartContainer})}})};SM.Highcharts.onPointMouseOver=function(e){SM.Highcharts.toggleLegendItemHighlighting(e)};SM.Highcharts.onPointMouseOut=function(e){SM.Highcharts.toggleLegendItemHighlighting(e)};SM.Highcharts.toggleLegendItemHighlighting=function(e){var chart=e.currentTarget.series.chart,chartHasLegend=chart.options.legend.enabled,chartType=chart.options.chart.type,$legendItem=[];if(chartHasLegend){if(chartType==="pie"||chartType==="donut"){$legendItem=$(e.currentTarget.legendItem.element)}else{if(e.currentTarget.series.legendItem){$legendItem=$(e.currentTarget.series.legendItem.element)}}if($legendItem.length){$legendItem.toggleClass("point-hovered")}}};SM.Highcharts.calculateSeriesRange=function(series){var maxes,mins,yValues;maxes=_.map(series,function(s){yValues=_.map(s.data,function(d){return d.y});return _.max(yValues)});mins=_.map(series,function(s){yValues=_.map(s.data,function(d){return d.y});return _.min(yValues)});return{max:_.max(maxes),min:_.min(mins)}};SM.Highcharts.calculateStackedSeriesRange=function(series){var stackedTotals=[],stackedTotal,numCategories;if(_.isEmpty(series)){return{min:0,max:0}}numCategories=series[0].data.length;_.times(numCategories,function(i){stackedTotal=0;_.map(series,function(s){stackedTotal+=s.data[i].y});stackedTotals.push(stackedTotal)});return{min:_.min(stackedTotals),max:_.max(stackedTotals)}};SM.Highcharts.calculateYAxisScaleOptions=function(max,min){var tickInterval,factor=1,isDefault=false,range;if(_.isUndefined(min)){min=0;isDefault=true}range=max-min||10;if(!_.isFinite(range)){range=10}if(range>100){while(range>100){range/=10;factor*=10}}else if(range<10){while(range<10){range*=10;factor/=10}}if(range<=5){range=5;tickInterval=1}else if(range<=10){range=10;tickInterval=1}else if(range<=20){range=20;tickInterval=2}else if(range<=50){range=50;tickInterval=10}else if(range<=100){range=100;tickInterval=10}if(isDefault){min=Math.floor(min*factor/tickInterval)*tickInterval;max=Math.ceil((min+range)*factor/tickInterval)*tickInterval}return{min:min,max:max,tickInterval:tickInterval*factor}};SM.Highcharts.renderGaugeShapes=function(chart,score,$container,isExport){var options=$.extend(true,{},SM.Highcharts.NPS_SCORE_CHART_MISC_OPTIONS),labels=chart.userOptions.labels?chart.userOptions.labels:options.labels,noResponses=chart.userOptions&&chart.userOptions.chart&&chart.userOptions.chart.noResponses,scoreString=score+"",scoreTextX;if(chart.userOptions.chart.showingBenchmark){options.innerradius=50.5;options.tHeight=20;options.alpha=14;options.radius=52/options.handRatio}_.each(labels,function(label){chart.renderer.text(label.text,label.x,label.y).css(options.labelCSS).attr({zIndex:999}).add()});if(isExport){scoreTextX=options.cx-scoreString.length/2*options.letterSize;chart.renderer.text(scoreString,scoreTextX,options.scoreTextY).attr(options.exportInnerScoreCSS).add();chart.renderer.text("NPS",options.npsTextX,options.npsTextY).attr(options.exportInnerTextCSS).add();SM.Highcharts.renderGaugeClockHandForExports(chart,options,score)}else{if(chart.renderer.isVML||(SM.Browser.isIE||SM.Browser.isSafari&&window.navigator.userAgent.indexOf("Chrome")===-1)){SM.Highcharts.renderGaugeClockHandForExports(chart,options,score)}else{SM.Highcharts.renderGaugeClockHand(chart,options,score)}setTimeout(function(){var html,textX,textY,$gaugeTextContainer,$gaugeInnerText,$gaugeTopText,$gaugeBottomText,pos=$container.position(),left=33;html=SM.Template.render("highcharts-gauge-text-template",{scoreString:scoreString,noResponses:noResponses});$container.after(html);$gaugeTextContainer=$container.siblings(".gauge-text").last();if(chart.userOptions.chart.showingBenchmark){left=0}if(chart.userOptions.chart.isBenchmark){left+=chart.plotWidth}$gaugeTextContainer.css({left:left+"px",top:pos.top+"px"});$gaugeInnerText=$gaugeTextContainer.find(".gauge-inner-text");$gaugeTopText=$gaugeTextContainer.find(".gauge-top-text");$gaugeBottomText=$gaugeTextContainer.find(".gauge-bottom-text");if(!noResponses){$gaugeTopText.css("padding-left",4-scoreString.length);$gaugeTopText.css("letter-spacing",-1.5);if(score===-100||score===100){$gaugeTopText.css("font-size",42)}}textX=chart.plotLeft+chart.plotWidth*.5+$gaugeInnerText.width()*-.5;textY=chart.plotTop+chart.plotHeight*.5+$gaugeInnerText.height()*-.5+3;$gaugeInnerText.css("left",textX);$gaugeInnerText.css("top",textY);if(chart.userOptions&&chart.userOptions.__options&&chart.userOptions.__options.innerTextColor){$gaugeTopText.css("color",chart.userOptions.__options.innerTextColor);$gaugeBottomText.css("color",chart.userOptions.__options.innerTextColor)}},0)}};SM.Highcharts.renderGaugeClockHand=function(chart,options,score){var noResponses=chart.userOptions&&chart.userOptions.chart&&chart.userOptions.chart.noResponses,topx,topy,leftx,lefty,rightx,righty,path,angle,filter,$svg,$defs,$shadow,defsHtml;filter="\n"+'    <filter id="gaugeShadow" x="0" y="0" height="130%" width="100%">\n'+'    <feoffset dx="0" dy="1" in="SourceAlpha" result="offsetOut"></feoffset>\n'+'    <feColorMatrix result="matrixOut" in="offsetOut" type="matrix"\n'+'     values="0.3 0.3 0.3 0.3 0 0.3 0.3 0.3 0.3 0 0.3 0.3 0.3 0.3 0 0.3 0.3 0.3 0.3 0" />\n'+'       <fegaussianblur result="blurOut" in="matrixOut" stdDeviation="1"></fegaussianblur>\n'+'       <feblend in="SourceGraphic" in2="blurOut" mode="normal"></feblend>\n'+"    </filter>\n";$svg=$(chart.container).find("svg");$defs=$svg.find("defs");$shadow=$defs.find("#gaugeShadow");if($shadow.length===0){defsHtml=$defs.html()+filter;$defs.html(defsHtml)}options.cx=chart.chartWidth/2;options.cy=chart.chartHeight/2;if(noResponses){chart.renderer.circle(options.cx,options.cy,options.innerradius).attr(options.clockHandCSS).attr("filter","url(#gaugeShadow)").add()}else{angle=score/100*360/5*2;topx=options.cx+(options.innerradius+options.tHeight)*Math.sin(angle/360*(2*Math.PI));topy=options.cy-(options.innerradius+options.tHeight)*Math.cos(angle/360*(2*Math.PI));leftx=options.cx+options.innerradius*Math.sin((angle-options.alpha)/360*(2*Math.PI));lefty=options.cy-options.innerradius*Math.cos((angle-options.alpha)/360*(2*Math.PI));rightx=options.cx+options.innerradius*Math.sin((angle+options.alpha)/360*(2*Math.PI));righty=options.cy-options.innerradius*Math.cos((angle+options.alpha)/360*(2*Math.PI));path=["M",rightx,righty,"A",options.innerradius,options.innerradius,0,1,1,leftx,lefty,"L",topx,topy,"Z"];chart.renderer.path(path).attr(options.clockHandCSS).attr("filter","url(#gaugeShadow)").add()}};SM.Highcharts.renderGaugeClockHandForExports=function(chart,options,score){var angle,handRadius,topx,topy,leftx,lefty,rightx,righty,path;options.cx=chart.chartWidth/2;options.cy=chart.chartHeight/2;chart.renderer.circle(options.cx,options.cy,options.innerradius).attr(options.exportInnerCircleCSS).add();angle=score/100*360/5*2;handRadius=options.innerradius;topx=options.cx+(handRadius+options.tHeight)*Math.sin(angle/360*(2*Math.PI));topy=options.cy-(handRadius+options.tHeight)*Math.cos(angle/360*(2*Math.PI));leftx=options.cx+(handRadius-2)*Math.sin((angle-options.alpha)/360*(2*Math.PI));lefty=options.cy-(handRadius-2)*Math.cos((angle-options.alpha)/360*(2*Math.PI));rightx=options.cx+(handRadius-2)*Math.sin((angle+options.alpha)/360*(2*Math.PI));righty=options.cy-(handRadius-2)*Math.cos((angle+options.alpha)/360*(2*Math.PI));path=["M",topx,topy,"L",leftx,lefty,"L",rightx,righty,"Z"];chart.renderer.path(path).attr(options.clockHandCSSExport).add()};SM.Highcharts.renderTMBCShapes=function(chart,score,$container,isExport){var options=$.extend(true,{},SM.Highcharts.NPS_SCORE_CHART_MISC_OPTIONS),userOptions=chart.userOptions||{},chartOptions=userOptions.chart||{},noResponses=chartOptions.noResponses,scoreString=score+"",usePercent=chartOptions.tmbcType==="tmbc_engagement"||chartOptions.isTop2,isBenchmark=chartOptions.isBenchmark,isGEI=chartOptions.tmbcType==="tmbc_gei"&&!isBenchmark,scoreTextX;if(isExport){scoreTextX=options.cx-scoreString.length/2*options.letterSize;if(usePercent){scoreString=scoreString+"%"}chart.renderer.text(scoreString,scoreTextX,options.scoreTextY).attr(options.exportInnerScoreCSS).add()}else{setTimeout(function(){var html,textX,textY,$gaugeTextContainer,$gaugeInnerText,$gaugeTopText,$gaugeBottomText,pos=$container.position(),top=pos.top-5,left=0;html=SM.Template.render("highcharts-tmbc-text-template",{scoreString:scoreString,noResponses:noResponses,usePercent:usePercent,isGEI:isGEI});$container.after(html);$gaugeTextContainer=$container.siblings(".gauge-text").last();$gaugeInnerText=$gaugeTextContainer.find(".gauge-inner-text");if(!usePercent&&!isBenchmark){$gaugeInnerText.append('<div class="popout sidi-popout tmbc"></div>');$gaugeInnerText.tmbcpopout(userOptions.tooltip.settings)}if(!chart.userOptions.chart.showingBenchmark){top+=20}if(isBenchmark){left+=chart.plotWidth}$gaugeTextContainer.css({left:left+"px",top:top+"px"});$gaugeTopText=$gaugeTextContainer.find(".gauge-top-text");$gaugeBottomText=$gaugeTextContainer.find(".gauge-bottom-text");if(!noResponses){$gaugeTopText.css("padding-left",4-scoreString.length);$gaugeTopText.css("letter-spacing",-1.5);if(score===-100||score===100){$gaugeTopText.css("font-size",42)}}textX=chart.plotLeft+chart.plotWidth*.5+$gaugeInnerText.width()*-.5;textY=chart.plotTop+chart.plotHeight*.5+$gaugeInnerText.height()*-.5+3;$gaugeInnerText.css("left",textX);$gaugeInnerText.css("top",textY);if(chart.userOptions&&chart.userOptions.__options&&chart.userOptions.__options.innerTextColor){$gaugeTopText.css("color",chart.userOptions.__options.innerTextColor);$gaugeBottomText.css("color",chart.userOptions.__options.innerTextColor)}},0)}};SM.Highcharts.renderBoxPlotLabels=function(chart,data,isPlotLineData){var labelList=[],min,range,fontsize,labelCSS,ypos,formatNum,forcePercent=chart.userOptions&&chart.userOptions.chart&&chart.userOptions.chart.forcePercent||false,resolveOverlaps=function(labels,plotWidth){var newlbs,rightMost,leftMost;rightMost=0;newlbs=[];$.each(labels,function(index,label){if(rightMost>label.left){label.left=rightMost+1}newlbs.push(label);rightMost=label.left+label.width});labels=newlbs.reverse();leftMost=plotWidth;newlbs=[];$.each(labels,function(index,label){if(leftMost<label.left+label.width){label.left=leftMost-label.width-1}newlbs.push(label);leftMost=label.left});return newlbs};fontsize=SM.Highcharts.BOX_PLOT_LABELING_OPTIONS.fontsize;labelCSS=SM.Highcharts.BOX_PLOT_LABELING_OPTIONS.labelCSS;ypos=isPlotLineData?SM.Highcharts.BOX_PLOT_LABELING_OPTIONS.plotLabelY:SM.Highcharts.BOX_PLOT_LABELING_OPTIONS.ypos;min=chart.userOptions.yAxis.min;range=chart.userOptions.yAxis.max-min;formatNum=!chart.userOptions.chart.isNPS||isPlotLineData;$.each(data,function(index,num){var doFormat,value,numlen,xpos,formatType;if(forcePercent){formatType=SM.Highcharts.getGlobalizeFormatType("percent",0);value=Globalize.format(num/100,formatType)}else{doFormat=formatNum&&num!==Math.floor(num);value=doFormat?Globalize.format(num,"n2"):""+num}numlen=value.length;xpos=(num-min)/range*chart.plotWidth;labelList.push({val:value,left:xpos-fontsize*numlen/2,width:fontsize*numlen})});labelList=resolveOverlaps(labelList,chart.plotWidth);$.each(labelList,function(index,label){chart.renderer.text(label.val,chart.plotLeft+label.left,chart.plotTop+ypos).css(labelCSS).attr({zIndex:999}).add()})};SM.Highcharts.DEFAULT_COLORS=["#CED428","#33BDBF","#F7AF1C","#898A7A","#2F606E","#CFCDBE","#5B5A4B","#A9BD38","#C8441A","#00898B"];SM.Highcharts.DEFAULT_BENCHMARK_COLORS=["#A9BD38","#2D606F","#33BDBF","#F7AF1C","#898B7A","#CFCDBE","#00898B","#CDD52A","#5B5A4B","#C8441A"];SM.Highcharts.NPS_BENCHMARK_DISTRIBUTION_COLORS=["#FD8623","#FFE651","#C6D9%C","#999A8A","#3F707E","#DFDDCE","#6B6A5B","#B9CD48","#D8542A","#10999B"];SM.Highcharts.NPS_DISTRIBUTION_COLORS=["#FC7613","#FFD641","#B6C94C","#898A7A","#2F606E","#CFCDBE","#5B5A4B","#A9BD38","#C8441A","#00898B"];SM.Highcharts.NPS_DETAILED_DISTRIBUTION_COLORS=["#870504","#9C0A09","#B10F0D","#C51716","#D81E1D","#EC2624","#FF2B2A","#F3BA2F","#FFD641","#BED056","#91AD43"];SM.Highcharts.NPS_SCORE_CHART_BASE_OPTIONS={chart:{margin:[0,0,0,0],spacingTop:0,spacingBottom:0,spacingLeft:0,spacingRight:0,style:{fontFamily:"Arial"},plotBackgroundColor:"#FFF",type:"pie",width:594,height:240,renderTo:{},events:{}},title:{text:null},colors:["#355F6D","#355F6D","#355F6D","#355F6D"],plotOptions:{series:{animation:false,point:{events:{}},events:{},innerSize:"50%"},pie:{marker:{states:{hover:{enabled:false}}},size:"90%",center:["50%","50%"],colorByPoint:true,borderWidth:2,dataLabels:{enabled:false},startAngle:-144,endAngle:144}},legend:{enabled:false},tooltip:{enabled:false},credits:{enabled:false},series:[{data:[{y:1},{y:1},{y:1},{y:1}]}]};SM.Highcharts.NPS_SCORE_CHART_MISC_OPTIONS={innerradius:60,radius:85,tHeight:20,cx:297,cy:120,handRatio:.73,alpha:14,letterSize:28,exportInnerCircleCSS:{fill:"#F0F0F0",zIndex:99},exportInnerScoreCSS:{color:"#366",textAlign:"center","font-family":"Arial","font-weight":"bold","font-size":"50px",zIndex:999},exportInnerTextCSS:{textAlign:"center",color:"#366","font-size":"16px",zIndex:999},labelCSS:{textAlign:"center",color:"#333","font-family":"Arial","font-weight":"bold","font-size":"13px",zIndex:999},clockHandCSS:{fill:"#FFFFFF",zIndex:999},clockHandCSSExport:{fill:"#F0F0F0",zIndex:999},scoreTextY:135,npsTextX:280,npsTextY:155,labels:[{text:"0",x:293,y:10},{text:"-50",x:180,y:90},{text:"50",x:395,y:90},{text:"-100",x:224,y:215},{text:"100",x:345,y:215}]};SM.Highcharts.NPS_SCORE_BAR_CHART_OPTIONS={xAxis:{labels:{gridLineWidth:2},lineWidth:0,lineColor:"#FFF"},yAxis:{plotLines:[{color:"#DEDEDE",zIndex:1,width:2,value:0}]}};SM.Highcharts.DEFAULT_OPTIONS={chart:{marginLeft:SM.Highcharts.MARGIN_LEFT,spacingRight:0,style:{fontFamily:"Arial"},plotBackgroundColor:"#F0F0F0"},title:{text:null,style:{fontFamily:"Arial",fontWeight:"bold",fontSize:"18px",color:"#333"}},colors:SM.Highcharts.DEFAULT_COLORS,xAxis:{title:{text:null},labels:{style:{fontFamily:"Arial",fontWeight:"bold",color:"#333"},gridLineColor:"#FFF",overflow:"justify",useHTML:true},lineColor:"#CCCCCC",tickLength:0},yAxis:{labels:{overflow:"justify",style:{fontFamily:"Arial",paddingTop:"10px",color:"#333"},useHTML:true},title:{text:null},offset:0,lineColor:"#DEDEDE",lineWidth:2,gridLineColor:"#FFF"},plotOptions:{series:{pointPadding:.05,groupPadding:.1,animation:false,dataLabels:{style:{fontWeight:"bold",fontSize:"12px",color:"#000"},useHTML:true},point:{events:{legendItemClick:function(){return false}}},events:{legendItemClick:function(){return false}}}},legend:{labelFormatter:SM.Highcharts.legendFormatter,enabled:false,floating:true,borderWidth:0,x:0,y:0,useHTML:true,itemDistance:20,itemMarginTop:5,itemMarginBottom:5,itemStyle:{display:"block",color:"#000",fontFamily:"Arial",fontSize:"11px",lineHeight:"14px"}},tooltip:{animation:false,hideDelay:100,backgroundColor:"#000",borderWidth:0,shadow:false,headerFormat:"",followPointer:true,style:{fontFamily:"Arial",fontSize:"12px",color:"#FFF"},useHTML:true,formatter:SM.Highcharts.formatTooltip},credits:{enabled:false}};SM.Highcharts.BOX_PLOT_LABELING_OPTIONS={fontsize:7,labelCSS:{color:"#333","font-family":"Lucida Grande","font-weight":"bold","font-size":"10px"},min:-100,range:200,ypos:48,plotLabelY:135};SM.Highcharts.QUIZ_SUMMARY_CHART_OPTIONS={chart:{marginTop:0,marginLeft:75,spacingRight:0,style:{fontFamily:"Arial"},plotBackgroundColor:"#F0F0F0"},title:{text:null},colors:["#2F6B79"],xAxis:{title:{text:null,style:{color:"#333",fontFamily:"HelveticaNeue-Medium",fontWeight:"normal"}},labels:{style:{fontFamily:"Arial",fontWeight:"normal",whiteSpace:"nowrap",color:"#333"},gridLineColor:"#FFF",overflow:"justify",y:25,useHTML:true},lineColor:"#CCCCCC",tickLength:0},yAxis:{labels:{overflow:"justify",style:{fontFamily:"Arial",paddingTop:"10px",color:"#333"},useHTML:true},title:{text:null,margin:20,style:{color:"#333",fontFamily:"HelveticaNeue-Medium",fontWeight:"normal"}},offset:0,lineColor:"#DEDEDE",lineWidth:2,gridLineColor:"#FFF",startOnTick:false,endOnTick:false},plotOptions:{column:{colorByPoint:true,borderWidth:0,dataLabels:{enabled:false,x:0,y:-10}},series:{pointPadding:.05,pointWidth:32,groupPadding:.1,animation:false,point:{events:{legendItemClick:function(){return false}}},events:{legendItemClick:function(){return false}}}},legend:{enabled:false},tooltip:{animation:false,hideDelay:100,backgroundColor:"#000",borderWidth:0,shadow:false,headerFormat:"",followPointer:true,style:{fontFamily:"Arial",fontSize:"12px",color:"#FFF"},useHTML:true},credits:{enabled:false}};SM.CustomizeActionMenu={};SM.CustomizeActionMenu.ActionMenuOptionsSettings={h1:{template:"customize-label-action-menu-template",visibleOptions:{labels:true},isTable:false},background:{template:"chart-customization-bg-action-menu-template",isTable:false},dataPoint:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:true,customize:true}},dataLabel:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:false,customize:true}},dataPointNPS:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:false,customize:true}},legend:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:true,customize:true}},legendNPS:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:false,customize:true}},area:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:true,customize:true}},yAxisLabel:{template:"chart-customization-action-menu-template",isTable:false,visibleOptions:{change:false,customize:true}},xAxisLabel:{template:"chart-customization-xAxis-action-menu-template",isTable:false},th:{template:"chart-customization-thead-action-menu-template",visibleOptions:{ascending:true,descending:true,unsorted:true,labels:true},isTable:true},caption:{template:"customize-label-action-menu-template",isTable:true},td:{template:"customize-label-action-menu-template",isTable:true,visibleOptions:{labels:true}}};SM.CustomizeActionMenu.actionMenu=function(evt,type,options){var showing=false,actionMenuSettings=SM.CustomizeActionMenu.ActionMenuOptionsSettings[type],visibleOptions,$el=actionMenuSettings.isTable?$(evt.currentTarget):$(evt.target),menu=$el.data("actionMenu"),time=0,posx,posy,offset,menuView;if(type==="merveys-th"){time=3e3}visibleOptions=options.visibleOptions?SM.Object.deepExtend(actionMenuSettings.visibleOptions,options.visibleOptions):actionMenuSettings.visibleOptions;if(!menu){$el.actionMenu({templateID:actionMenuSettings.template,visibleOptions:visibleOptions,isReadOnly:$(".analyze-container.read-only").length>0,answerID:options.answerID,position:{collision:"none none"}});menu=$el.data("actionMenu");$el.one("actionMenu.afterOpen",function(e){menuView=e.actionMenu.get("menuView");menuView.$el.mouseover(function(){showing=true}).mouseout(function(){showing=false;setTimeout(function(){if(menu&&!showing){menu.close()}},1e3)});menuView.$el.find(".options").on("mouseenter",function(){showing=true})}).mouseout(function(){setTimeout(function(){if(menu&&!showing){menu.close()}},time)});menu.open()}menuView=menu.get("menuView");if(type==="merveys-th"){menuView.$el.css({top:options.parent.offset().top+options.parent.outerHeight()+"px",left:options.parent.offset().left+options.parent.outerWidth()-menuView.$el.width()+4+"px"})}else{if(evt.pageX||evt.pageY){posx=evt.pageX;posy=evt.pageY}else if(evt.clientX||evt.clientY){posx=evt.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;posy=evt.clientY+document.body.scrollTop+document.documentElement.scrollTop}else if(options.parent){offset=options.parent.offset();posx=evt.chartX+offset.left;posy=evt.chartY+offset.top}menuView.$el.css({left:posx+"px",top:posy+"px"})}menuView.$el.find(".q").popout()};SM.CustomizeActionMenu.popout=function(evt){$(evt.currentTarget).popout()};SM.SortedSummary=function(opts){var self=this;var SORT_ORDER_ASC="ascending",SORT_ORDER_DESC="descending",SORT_ORDER_UNSORTED="unsorted";var SORT_OPTION_DEFAULT={order:SM.QuestionDisplayModel.SORTING_ORDERS.UNSORTED,dimensionType:null,dimensionID:null};function _initialize(options){var question=options.question,labels=options.labels,isMirrored=options.isMirrored,shouldHideEmptyData=options.shouldHideEmptyData;self.summary=self._getSortedSummaryData(question,labels,isMirrored,shouldHideEmptyData,options)}function buildColumnChoices(columns){var columnChoices={};$.each(columns,function(i,column){$.each(column.items,function(j,columnChoice){if(columnChoice.id){columnChoices[columnChoice.id]=columnChoice}})});return columnChoices}function getRowByID(rowId){return _.find(self.rows,function(r){return r.id===rowId})}function getColumnByID(columnId){return _.find(self.columns,function(c){return c.id===columnId})}function getColumnChoiceByID(columnChoiceId){return _.find(self.columnChoices,function(columnChoice){return columnChoice.id===columnChoiceId})}function _buildResponsesCountsByRow(){var counts={};_.each(self.rows,function(row){counts[row.id]=calculateRowTotal(row.id)});return counts}function _buildResponsesCountsByColumn(){var counts={};_.each(self.columns,function(column){counts[column.id]=calculateColumnTotal(column.id)});return counts}function _buildRespondentCountsByRow(){var counts={},rowSummary;_.each(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary&&rowSummary.row_total!==undefined){counts[row.id]=rowSummary.row_total}else{counts[row.id]=0}});return counts}function _buildRespondentCountsByColumn(){var counts={},countData;if(self.isCompared){countData=self.summary.summary.answered_subtotals}else{countData=self.summary.summary.options.col_totals}_.each(self.columns,function(column,i){if(countData){if(self.isCompared){counts[column.id]=countData[column.id]}else{counts[column.id]=countData[i]}}else{counts[column.id]=0}});return counts}function calculateRowTotal(rowId){var total=0,rowSummary=self.summary.summary.options[rowId],columnSummary;if(rowSummary&&rowSummary.options){_.each(self.columns,function(column){columnSummary=rowSummary.options[column.id];if(columnSummary){total+=columnSummary.count}})}return total}function calculateColumnTotal(columnId){var total=0,rowSummary,columnSummary;_.each(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary&&rowSummary.options){columnSummary=rowSummary.options[columnId];if(columnSummary){total+=columnSummary.count}}});return total}function _buildScoresByColumn(){var scores={};_.each(self.columns,function(column){scores[column.id]={count:calculateColumnScore(column.id)}});return scores}function calculateColumnScore(columnId){var rowSummary,columnSummary,id,score,promoters=0,detractors=0,passives=0;_.each(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary&&rowSummary.options){columnSummary=rowSummary.options[columnId];if(columnSummary){id=row.id;if(id==="Detractors"){detractors=columnSummary.count}else if(id==="Promoters"){promoters=columnSummary.count}else{passives=columnSummary.count}}}});if(detractors+promoters+passives===0){score=0}else{score=Math.round(100*(promoters-detractors)/(detractors+promoters+passives))}return score}function calculateColumnTotals(){var columnTotals={},total;_.each(self.columns,function(column){total=calculateColumnTotal(column.id);columnTotals[column.id]=total});return columnTotals}function buildColumnTotalsByRow(){var columnTotalsByRow={},rowSummary,columnSummary;$.each(self.columns,function(i,column){$.each(self.rows,function(j,row){if(columnTotalsByRow[row.id]===undefined){columnTotalsByRow[row.id]={}}columnTotalsByRow[row.id][column.id]=0;rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){if(columnSummary.row_total!==undefined&&columnSummary.row_total>=0){columnTotalsByRow[row.id][column.id]=columnSummary.row_total}else{columnTotalsByRow[row.id][column.id]=columnSummary.count}}}})});return columnTotalsByRow}function calculateColumnChoiceTotalsByRow(columnChoices){var columnChoiceTotals={},columnChoiceSummary;$.each(self.rows,function(rowIndex,row){var rowSummary=self.summary.summary.options[row.id];if(rowSummary){$.each(rowSummary.options,function(i,columnSummary){$.each(columnChoices,function(j,columnChoice){if(columnChoiceTotals[columnChoice.id]===undefined){columnChoiceTotals[columnChoice.id]=0}columnChoiceSummary=columnSummary.options[columnChoice.id];if(columnChoiceSummary){columnChoiceTotals[columnChoice.id]+=columnChoiceSummary.count}})})}});return columnChoiceTotals}function calculateColumnChoiceTotalsByRowAndColumnChoice(columnChoices){var columnChoiceTotals={},rowSummary,columnSummary,columnChoiceSummary;_.each(self.rows,function(row){_.each(self.columns,function(column){columnChoices=columnChoices||column.items;_.each(columnChoices,function(columnChoice){if(columnChoiceTotals[row.id]===undefined){columnChoiceTotals[row.id]={}}if(columnChoiceTotals[row.id][columnChoice.id]===undefined){columnChoiceTotals[row.id][columnChoice.id]=0}rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){columnChoiceSummary=columnSummary.options[columnChoice.id];if(columnChoiceSummary){columnChoiceTotals[row.id][columnChoice.id]+=columnChoiceSummary.count}}}})})});return columnChoiceTotals}function calculateColumnChoiceTotalsByColumnChoice(columnChoices){var columnChoiceTotals={},columnChoiceSummary,rowSummary;$.each(self.rows,function(rowIndex,row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){$.each(rowSummary.options,function(i,columnSummary){$.each(columnChoices,function(j,columnChoice){if(columnChoiceTotals[columnChoice.id]===undefined){columnChoiceTotals[columnChoice.id]=0}columnChoiceSummary=columnSummary.options[columnChoice.id];if(columnChoiceSummary){columnChoiceTotals[columnChoice.id]+=columnChoiceSummary.count}})})}else{$.each(columnChoices,function(j,columnChoice){columnChoiceTotals[columnChoice.id]=0})}});return columnChoiceTotals}function getSortedRowTotals(){var sortedRowTotals=[],sortedRows=self.sortedRowsList[0];if(sortedRows){_.each(sortedRows,function(row,position){sortedRowTotals[position]=calculateRowTotal(row.id)})}return sortedRowTotals}function getSortedColumnTotals(){var sortedColumnTotals=[],sortedColumns=self.sortedColumnsList[0];if(sortedColumns){$.each(sortedColumns,function(position,column){sortedColumnTotals[position]=calculateColumnTotal(column.id)})}return sortedColumnTotals}function shouldSortOtherOption(){return self.isCompared?true:self.sortOptions.dimensionType!=="labels"}function otherIsAnAnswerChoice(){return self.others!==undefined&&self.others[0].options.is_answer_choice}function appendOtherAnswerChoicesToSortedRows(){var sortedRowsList=self.sortedRowsList[0];if(otherIsAnAnswerChoice()){$.each(self.others,function(i,other){sortedRowsList.push(other)})}}function addOtherAnswerChoicesToRows(){if(otherIsAnAnswerChoice()){$.each(self.others,function(i,other){self.rows.push(other)});self.rows[self.rows.length-1].position=self.rows.length}}function hideEmptyData(){self.rows=_.filter(self.rows,function(row){return self.summary.summary.options[row.id]!==undefined})}function calculateWeightedAveragesForComparedSimpleQuestion(){var weightedAverages={},weightedAverage,weight,rowSummary,columnSummary,columnTotal,columnCount,columnSum;_.each(self.columns,function(column){columnTotal=columnSum=0;_.each(self.rows,function(row,rowIndex){rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){columnCount=columnSummary.count}else{columnCount=0}}else{columnCount=0}weight=rowIndex+1;columnSum+=weight*columnCount;columnTotal+=columnCount});if(columnTotal===0){weightedAverage=0}else{weightedAverage=columnSum/columnTotal}weightedAverages[column.id]=weightedAverage});return weightedAverages}function calculateWeightedAveragesByRow(){var weightedAverages={},rowSummary,rowTotal,responses,naCount,naCol,weightedAverage;$.each(self.rows,function(index,row){rowSummary=self.summary.summary.options[row.id];if(rowSummary===undefined){weightedAverages[row.id]=0}else{responses=rowSummary.options;rowTotal=rowSummary.row_total;if(responses){naCount=0;if(self.question.naCol!==undefined){naCol=responses[self.question.naCol.id];if(naCol&&naCol.count){naCount=naCol.count}}weightedAverage=calculateWeightedAverageForRow(self.columns,responses,{naCount:naCount,total:rowTotal});weightedAverages[row.id]=weightedAverage}else{weightedAverages[row.id]=0}}});return weightedAverages}function calculateWeightedAveragesByRowAndColumn(){var weightedAverages={},rowSummary,columnSummary,columnChoicesSummary,weightedAverage;$.each(self.rows,function(i,row){weightedAverages[row.id]={};rowSummary=self.summary.summary.options[row.id];if(rowSummary){$.each(self.columns,function(j,column){columnSummary=rowSummary.options[column.id];if(columnSummary===undefined){weightedAverages[row.id][column.id]=0}else{columnChoicesSummary=columnSummary.options;if(columnChoicesSummary){weightedAverage=calculateWeightedAverageForColumn(self.columnChoices,columnChoicesSummary,{naCount:0});weightedAverages[row.id][column.id]=weightedAverage}}})}else{SM.log("No data for Row#"+row.id+" on Question#"+self.question.ID)}});return weightedAverages}function calculateWeightedAveragesByRowAndColumnChoice(){var weightedAverages={},rowSummary,weightedAverage;$.each(self.rows,function(i,row){weightedAverages[row.id]={};rowSummary=self.summary.summary.options[row.id];if(rowSummary){if(self.isMirrored){$.each(self.columnChoices,function(k,columnChoice){weightedAverage=calculateWeightedAverageForColChoice(self.columns,rowSummary,columnChoice);weightedAverages[row.id][columnChoice.id]=weightedAverage})}else{$.each(self.columns,function(k,column){weightedAverage=calculateWeightedAverageForColChoice(self.columnChoices,rowSummary,column);weightedAverages[row.id][column.id]=weightedAverage})}}else{if(self.isMirrored){$.each(self.columnChoices,function(k,columnChoice){weightedAverages[row.id][columnChoice.id]=0})}else{$.each(self.columns,function(k,column){weightedAverages[row.id][column.id]=0})}}});return weightedAverages}function calculateWeights(choices){var weights={};$.each(choices,function(index,choice){if(choice.options!==undefined&&choice.options.is_na){weights[choice.id]=0;return}if(choice.options===undefined||choice.options.weight===undefined){weights[choice.id]=index+1}else{weights[choice.id]=choice.options.weight}});return weights}function calculateWeightsByColumn(columns){var weights={};$.each(columns,function(i,column){var columnChoices=column.items;$.extend(weights,calculateWeights(columnChoices))});return weights}function calculateWeightedAverageForRow(columns,responses,options){return calculateWeightedAverageForDimension(columns,responses,options)
}function calculateWeightedAverageForColumn(columnChoices,responses,options){return calculateWeightedAverageForDimension(columnChoices,responses,options)}function calculateWeightedAverageForColChoice(columns,rowSummary,columnChoice){var sum=0,total=0,count=0,columnSummary,columnChoiceSummary;$.each(columns,function(j,column){if(column.options!==undefined&&column.options.is_na){return}if(self.isMirrored){columnSummary=rowSummary.options[column.id];if(columnSummary){columnChoiceSummary=columnSummary.options[columnChoice.id];if(columnChoiceSummary){count=columnChoiceSummary.count;sum+=count*self.weights[column.id];total+=count}}}else{columnSummary=rowSummary.options[columnChoice.id];if(columnSummary){columnChoiceSummary=columnSummary.options[column.id];if(columnChoiceSummary){count=columnChoiceSummary.count;sum+=count*self.weights[columnChoice.id];total+=count}}}});return calculateWeightedAverage(sum,total)}function calculateWeightedAverageForDimension(choices,responses,options){var total=options.total,naCount=options.naCount||0,shouldCalculateTotal=false,sum=0;options=options||{};if(_.isUndefined(total)){shouldCalculateTotal=true;total=0}$.each(choices,function(i,choice){var ct=0;if(undefined!==responses[choice.id]){ct=responses[choice.id].count}sum+=ct*self.weights[choice.id];if(shouldCalculateTotal){total+=ct}});total-=naCount;return calculateWeightedAverage(sum,total)}function calculateWeightedAverage(sum,total){var value=0;if(total!==0){value=sum/total}return parseFloat(value.toFixed(2))}self._getSortedSummaryData=function(question,labels,isMirrored,shouldHideEmptyData,options){self.question=question;self.isMirrored=isMirrored;self.isCompared=self.question.isCompared();self.rollup=self.question.getRollup();self.display=self.rollup.display;self.summary=self.rollup.getContextSummary();if(options&&options.summary){self.summary=options.summary}self.questionType=self.summary.type;self.questionSubType=self.question.subtype;self.summaryType=self.isCompared?self.summary.summary.type:self.summary.type;self.hasColumnChoices=self.summaryType==="menu_matrix";self.answerStructures=SM.Summarizable.labelAnswerStructures(self.question.getContextAnswerStructure(),self.display,null,self.question);if(options&&options.answerStructures){self.answerStructures=options.answerStructures}self.rows=self.answerStructures.rows;self.columns=self.answerStructures.cols;self.columnChoices=self.hasColumnChoices?buildColumnChoices(self.columns):null;self.columnChoicesArray=self.columnChoices?_.values(self.columnChoices):null;self.others=self.answerStructures.other;self.crossedOptions=self.answerStructures.crossedOptions;self.sortOptions=self.rollup.display.getDisplayData().sort_data;self.sortOptionsBS=self.rollup.display.getDisplayData().bs_sort_data;if(shouldSortOtherOption()){addOtherAnswerChoicesToRows()}if(shouldHideEmptyData){hideEmptyData()}self.rowIds=_.map(self.rows,function(r){return r.id});if(self.columns){self.columnIds=_.map(self.columns,function(c){return c.id})}if(self.hasColumnChoices){self.columnChoiceIds=_.map(self.columnChoices,function(cc){return cc.id})}if(self.summaryType!=="menu_matrix"){self.responsesCountsByRow=_buildResponsesCountsByRow();self.responsesCountsByColumn=_buildResponsesCountsByColumn();self.respondentCountsByColumn=_buildRespondentCountsByColumn();self.respondentCountsByRow=_buildRespondentCountsByRow()}if(self.question.isNPS()&&self.question.isCompared()){self.scoresByColumn=_buildScoresByColumn()}self.columnTotals=calculateColumnTotals();if(self.isCompared||self.summaryType==="menu_matrix"){self.columnTotalsByRow=buildColumnTotalsByRow()}if(self.hasColumnChoices){self.columnChoiceTotalsByRow=calculateColumnChoiceTotalsByRowAndColumnChoice();self.columnChoiceTotalsByColumnChoice=calculateColumnChoiceTotalsByColumnChoice(self.columnChoices)}self.numRows=self.rows.length;self.numColumns=self.columns?self.columns.length:0;if(self.numColumns>0){if(self.hasColumnChoices){if(self.isCompared){self.weights=calculateWeights(self.columns);self.weightedAveragesByRowAndColumnChoice=calculateWeightedAveragesByRowAndColumnChoice()}else{self.weights=calculateWeightsByColumn(self.columns);self.weightedAveragesByRowAndColumn=calculateWeightedAveragesByRowAndColumn()}}else{self.weights=calculateWeights(self.columns);if(self.isCompared){self.weightedAveragesByColumn=calculateWeightedAveragesForComparedSimpleQuestion()}else{self.weightedAveragesByColumn=self.weights;self.weightedAveragesByRow=calculateWeightedAveragesByRow()}}}self.sortedPositions={rows:[],columns:[],columnChoices:[]};self.sortingBS=false;setSortedPositions(self.sortOptions);setAsSorted();if(self.question.getRollup().hasBasicStats()){self.sortedPositions={rows:[],columns:[],columnChoices:[]};self.sortingBS=true;setSortedPositions(self.sortOptionsBS);setAsSortedBS();self.sortingBS=false}if(!_.isEmpty(self.sortedRowsList)){self.sortedRowTotals=getSortedRowTotals()}if(!_.isEmpty(self.sortedColumnsList)){self.sortedColumnTotals=getSortedColumnTotals()}if(!shouldSortOtherOption()){appendOtherAnswerChoicesToSortedRows()}return{sortedAnswers:{rowsList:self.sortedRowsList,columnsList:self.sortedColumnsList,columnChoicesList:self.sortedColumnChoicesList},sortedBS:{rowsList:self.sortedRowsListBS,columnsList:self.sortedColumnsListBS,columnChoicesList:self.sortedColumnChoicesListBS},totals:{sortedRowTotals:self.sortedRowTotals,sortedColumnTotals:self.sortedColumnTotals,columnTotalsByRow:self.columnTotalsByRow,columnChoiceTotalsByRow:self.columnChoiceTotalsByRow,columnChoiceTotalsByColumnChoice:self.columnChoiceTotalsByColumnChoice},counts:{responsesCountsByColumn:self.responsesCountsByColumn,responsesCountsByRow:self.responsesCountsByRow,respondentCountsByColumn:self.respondentCountsByColumn,respondentCountsByRow:self.respondentCountsByRow,scoresByColumn:self.scoresByColumn},weightedAverages:{weightedAveragesByRow:self.weightedAveragesByRow,weightedAveragesByColumn:self.weightedAveragesByColumn,weightedAveragesByRowAndColumn:self.weightedAveragesByRowAndColumn,weightedAveragesByRowAndColumnChoice:self.weightedAveragesByRowAndColumnChoice},weights:self.weights,quizRankings:self.sortedPositions.quizRankings}};function setSortedPositions(sortOptions){var sortData,orderedSortOptionKeys,sortOrder,dimensionType,dimensionID,canApplySort;if(self.summaryType==="menu_matrix"){if(!sortOptions){sortOptions={}}if(self.question.isCompared()){_.each(self.rows,function(row){if(!sortOptions[row.id]){sortOptions[row.id]=SORT_OPTION_DEFAULT}})}else{_.each(self.columns,function(column){if(!sortOptions[column.id]){sortOptions[column.id]=SORT_OPTION_DEFAULT}})}orderedSortOptionKeys=_.keys(sortOptions).sort();_.each(orderedSortOptionKeys,function(scopedDimensionID){sortData=sortOptions[scopedDimensionID];sortOrder=sortData.order;dimensionID=sortData.dimensionID;dimensionType=sortData.dimensionType;_setSortedPositions(sortOrder,dimensionType,dimensionID,scopedDimensionID)})}else{if(!sortOptions){sortOptions=SORT_OPTION_DEFAULT}sortOrder=sortOptions.order;dimensionType=sortOptions.dimensionType;dimensionID=sortOptions.dimensionID;canApplySort=true;if(dimensionID){canApplySort=self.rollup.combinehideModel.canApplySort(dimensionID)}if(canApplySort){_setSortedPositions(sortOrder,dimensionType,dimensionID)}else{_setSortedPositionsWhenUnsorted()}}}function setAsSorted(){self.sortedRowsList=[];self.sortedColumnsList=[];self.sortedColumnChoicesList=[];$.each(self.sortedPositions.rows,function(i,rowPositions){var sortedRows=[];$.each(rowPositions,function(rowId,position){sortedRows[position]=getRowByID(rowId)});self.sortedRowsList.push(sortedRows)});if(_.isEmpty(self.sortedRowsList)){self.sortedRowsList.push(self.rows)}$.each(self.sortedPositions.columns,function(i,columnPositions){var sortedColumns=[];$.each(columnPositions,function(columnId,position){if(columnId!=="undefined"){sortedColumns[position]=getColumnByID(columnId)}});self.sortedColumnsList.push(sortedColumns)});if(_.isEmpty(self.sortedColumnsList)){self.sortedColumnsList.push(self.columns)}$.each(self.sortedPositions.columnChoices,function(i,columnChoicePositions){var sortedColumnChoices=[];$.each(columnChoicePositions,function(columnChoiceId,position){sortedColumnChoices[position]=getColumnChoiceByID(columnChoiceId)});self.sortedColumnChoicesList.push(sortedColumnChoices)});if(_.isEmpty(self.sortedColumnChoicesList)){self.sortedColumnChoicesList.push(self.columnChoices)}}function setAsSortedBS(){self.sortedRowsListBS=[];self.sortedColumnsListBS=[];self.sortedColumnChoicesListBS=[];$.each(self.sortedPositions.rows,function(i,rowPositions){var sortedRows=[];$.each(rowPositions,function(rowId,position){sortedRows[position]=getRowByID(rowId)});self.sortedRowsListBS.push(sortedRows)});if(_.isEmpty(self.sortedRowsListBS)){self.sortedRowsListBS.push(self.rows)}$.each(self.sortedPositions.columns,function(i,columnPositions){var sortedColumns=[];$.each(columnPositions,function(columnId,position){if(columnId!=="undefined"){sortedColumns[position]=getColumnByID(columnId)}});self.sortedColumnsListBS.push(sortedColumns)});if(_.isEmpty(self.sortedColumnsListBS)){self.sortedColumnsListBS.push(self.columns)}$.each(self.sortedPositions.columnChoices,function(i,columnChoicePositions){var sortedColumnChoices=[];$.each(columnChoicePositions,function(columnChoiceId,position){sortedColumnChoices[position]=getColumnChoiceByID(columnChoiceId)});self.sortedColumnChoicesListBS.push(sortedColumnChoices)});if(_.isEmpty(self.sortedColumnChoicesListBS)){self.sortedColumnChoicesListBS.push(self.columnChoices)}}function _setSortedPositions(sortOrder,dimensionType,dimensionID,scopedDimensionID){if(dimensionID==="quiz_summary"){sortQuizQuestions(sortOrder,dimensionType)}else if(sortOrder===SORT_ORDER_UNSORTED||sortOrder===undefined||sortOrder===null){_setSortedPositionsWhenUnsorted(dimensionID,scopedDimensionID)}else{if(dimensionType==="averageRating"){_setSortedPositionsByAverageRating(sortOrder)}else if(dimensionType==="averageNumber"){setRowPositionsByAverageNumber(sortOrder)}else if(dimensionType==="totals"){_setSortedPositionsByTotals(sortOrder,dimensionID,scopedDimensionID)}else if(dimensionType==="labels"){_setSortedPositionsByLabel(sortOrder,dimensionID,scopedDimensionID)}else if(dimensionType==="responses"){setRowPositionsByResponses(sortOrder)}else if(dimensionType==="scores"){setRowPositionsByScores(sortOrder)}else{_setSortedPositionsByDimensionTypeAndID(sortOrder,dimensionType,dimensionID,scopedDimensionID)}}}function _setSortedPositionsWhenUnsorted(dimensionID,scopedDimensionID){if(self.sortingBS){if(self.isCompared){if(self.summaryType==="menu_matrix"){setColumnChoicePositionsByDefaultRowOrder()}else{setColumnPositionsByDefaultOrder()}}else{setRowPositionsByDefaultOrder()}}else{if(self.isMirrored){if(self.questionType==="menu_matrix"){setColumnChoicePositionsByDefaultColumnOrder(scopedDimensionID)}else if(self.isCompared){if(self.summaryType==="menu_matrix"){setColumnChoicePositionsByDefaultRowOrder()}else{setColumnPositionsByDefaultOrder()}}else{setColumnPositionsByDefaultOrder()}}else{if(self.isCompared){if(self.summaryType==="menu_matrix"){setColumnPositionsByDefaultOrder()}else{setRowPositionsByDefaultOrder()}}else{setRowPositionsByDefaultOrder()}}}}function _setSortedPositionsByAverageRating(sortOrder){if(self.isMirrored){setColumnPositionsByAverageRating(sortOrder)}else{setRowPositionsByAverageRating(sortOrder)}}function _setSortedPositionsByTotals(sortOrder,dimensionID,scopedDimensionID){if(self.questionType==="simple"){if(self.questionSubType==="numerical"){setRowPositionsByRowSum(sortOrder)}else{setRowPositionsByRowCount(sortOrder)}}else if(self.questionType==="menu_matrix"){if(self.isMirrored){setColumnChoicePositionsByRowTotal(scopedDimensionID,sortOrder)}else{setRowPositionsByColumnTotal(scopedDimensionID,sortOrder)}}else{if(self.isCompared){if(self.isMirrored){if(self.summaryType==="menu_matrix"){setColumnChoicePositionsByColumnTotal(scopedDimensionID,sortOrder)}else{setColumnPositionsByTotal(sortOrder)}}else{if(self.summaryType==="menu_matrix"){setColumnPositionsByRowTotal(scopedDimensionID,sortOrder)}else{setRowPositionsByTotal(sortOrder)}}}else{if(self.isMirrored){setColumnPositionsByTotal(sortOrder)}else{setRowPositionsByTotal(sortOrder)}}}}function _setSortedPositionsByLabel(sortOrder,dimensionID,scopedDimensionID){if(self.isCompared){if(self.isMirrored||self.sortingBS){if(self.summaryType==="menu_matrix"){setColumnChoicePositionsByLabel(dimensionID,sortOrder)}else{setColumnPositionsByLabel(sortOrder)}}else{if(self.summaryType==="menu_matrix"){setColumnPositionsByLabel(sortOrder)}else{setRowPositionsByLabel(sortOrder)}}}else{if(self.isMirrored&&!self.sortingBS){if(self.questionType==="menu_matrix"){setColumnChoicePositionsByLabel(scopedDimensionID,sortOrder)}else{setColumnPositionsByLabel(sortOrder)}}else{setRowPositionsByLabel(sortOrder)}}}function _setSortedPositionsByDimensionTypeAndID(sortOrder,dimensionType,dimensionID,scopedDimensionID){if(self.sortingBS){if(self.isCompared){if(dimensionType==="row"){setColumnPositionsByRowCount(dimensionID,sortOrder)}else{setColumnChoicePositionByColumnCount(scopedDimensionID,dimensionID,sortOrder)}}else{if(dimensionType==="column"){setRowPositionsByColumnCount(dimensionID,sortOrder)}else{setRowPositionsByColumnChoiceCountBS(dimensionID,sortOrder,scopedDimensionID)}}}else{if(self.isMirrored){if(self.questionType==="menu_matrix"){if(dimensionType==="row"){setColumnChoicePositionsByRowCount(scopedDimensionID,dimensionID,sortOrder)}else{setColumnChoicePositionsByDefaultColumnOrder(dimensionID)}}else{if(dimensionType==="row"){setColumnPositionsByRowCount(dimensionID,sortOrder)}else if(dimensionType==="column"){if(self.isCompared&&self.hasColumnChoices){setColumnChoicePositionByColumnCount(scopedDimensionID,dimensionID,sortOrder)}else{setColumnPositionsByDefaultOrder()}}else{if(self.isCompared&&self.hasColumnChoices){setColumnChoicePositionsByDefaultRowOrder()}else{setColumnPositionsByRowCount(dimensionID,sortOrder)}}}}else{if(self.summaryType==="menu_matrix"){if(self.isCompared){setColumnPositionsByColumnChoiceCount(scopedDimensionID,dimensionID,sortOrder)}else{setRowPositionsByColumnChoiceCount(dimensionID,sortOrder)}}else{if(dimensionType==="column"){setRowPositionsByColumnCount(dimensionID,sortOrder)}else if(self.isCompared&&dimensionType==="row"){setRowPositionsByColumnCount(dimensionID,sortOrder)}else if(dimensionType==="row"){setColumnPositionsByRowCount(dimensionID,sortOrder)}else{SM.log("Shouldn't have gotten here...");setRowPositionsByDefaultOrder()}}}}}function setRowPositionsByDefaultOrder(){var sortedRowPositions={};$.each(self.rows,function(position,row){sortedRowPositions[row.id]=position});self.sortedPositions.rows.push(sortedRowPositions)}function setColumnPositionsByDefaultOrder(){var sortedColumnPositions={};$.each(self.columns,function(position,column){sortedColumnPositions[column.id]=position});self.sortedPositions.columns.push(sortedColumnPositions)}function setColumnChoicePositionsByDefaultColumnOrder(columnId){var columnChoices,sortedColumnChoicePositions;$.each(self.columns,function(i,column){if(column.id===columnId){sortedColumnChoicePositions={};columnChoices=column.items;$.each(columnChoices,function(position,columnChoice){sortedColumnChoicePositions[columnChoice.id]=position});self.sortedPositions.columnChoices.push(sortedColumnChoicePositions)}})}function setColumnChoicePositionsByDefaultRowOrder(){var sortedColumnChoicePositions={};$.each(_.values(self.columnChoices),function(position,columnChoice){sortedColumnChoicePositions[columnChoice.id]=position});self.sortedPositions.columnChoices.push(sortedColumnChoicePositions)}function setRowPositionsByRowCount(sortOrder){var unsortedCounts=[],rowSummary;_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){unsortedCounts.push([row.id,rowSummary.count])}else{unsortedCounts.push([row.id,0])}});setSortedRowPositions(unsortedCounts,sortOrder)}function setRowPositionsByColumnCount(columnId,sortOrder){var unsortedCounts=[],rowSummary,columns,key,columnSummary;columns=self.sortingBS?SM.BasicStatsUtils.getStructure():self.columns;key=self.sortingBS?"stats":"options";_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];$.each(columns,function(i,column){if(column.id===columnId){if(rowSummary){columnSummary=rowSummary[key][column.id];if(_.isNumber(columnSummary)){unsortedCounts.push([row.id,columnSummary])}else if(columnSummary){unsortedCounts.push([row.id,columnSummary.count])}else{unsortedCounts.push([row.id,0])}}else{unsortedCounts.push([row.id,0])}}})});setSortedRowPositions(unsortedCounts,sortOrder)}function setRowPositionsByColumnChoiceCountBS(columnChoiceId,sortOrder,columnId){var unsortedCounts=[],columnChoices,key,rowSummary,columnSummary,columnChoiceSummary,columnColumnChoiceIds;$.each(self.rows,function(i,row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnChoices=self.sortingBS?SM.BasicStatsUtils.getStructure():self.columns[0].items;key=self.sortingBS?"stats":"options";columnColumnChoiceIds=_.pluck(columnChoices,"id");if(_.contains(columnColumnChoiceIds,columnChoiceId)){columnSummary=rowSummary.options[columnId];if(columnSummary){$.each(columnChoices,function(k,columnChoice){if(columnChoice.id===columnChoiceId){columnChoiceSummary=columnSummary[key][columnChoice.id];if(_.isNumber(columnChoiceSummary)){unsortedCounts.push([row.id,columnChoiceSummary])}else if(columnChoiceSummary){unsortedCounts.push([row.id,columnChoiceSummary.count])}else{unsortedCounts.push([row.id,0])}}})}else{unsortedCounts.push([row.id,0])}}}else{unsortedCounts.push([row.id,0])}});setSortedRowPositions(unsortedCounts,sortOrder)}function setRowPositionsByColumnChoiceCount(columnChoiceId,sortOrder){var unsortedCounts=[],columnChoices,key,rowSummary,columnSummary,columnChoiceSummary,columnColumnChoiceIds;$.each(self.rows,function(i,row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){$.each(self.columns,function(j,column){columnChoices=self.sortingBS?SM.BasicStatsUtils.getStructure():column.items;key=self.sortingBS?"stats":"options";columnColumnChoiceIds=_.pluck(columnChoices,"id");if(_.contains(columnColumnChoiceIds,columnChoiceId)){columnSummary=rowSummary.options[column.id];if(columnSummary){$.each(columnChoices,function(k,columnChoice){if(columnChoice.id===columnChoiceId){columnChoiceSummary=columnSummary[key][columnChoice.id];if(_.isNumber(columnChoiceSummary)){unsortedCounts.push([row.id,columnChoiceSummary])}else if(columnChoiceSummary){unsortedCounts.push([row.id,columnChoiceSummary.count])}else{unsortedCounts.push([row.id,0])}}})}else{unsortedCounts.push([row.id,0])}}})}else{unsortedCounts.push([row.id,0])}});setSortedRowPositions(unsortedCounts,sortOrder)}function setColumnPositionsByRowCount(rowId,sortOrder){var unsortedCounts=[],rowSummary,columnSummary,rows,key;rows=self.sortingBS?SM.BasicStatsUtils.getStructure():self.rows;key=self.sortingBS?"stats":"options";_.map(self.columns,function(column){$.each(rows,function(i,row){if(row.id===rowId){rowSummary=self.summary.summary[key][row.id];if(self.sortingBS){if(rowSummary&&rowSummary.compare){columnSummary=rowSummary.compare[column.id];if(_.isNumber(columnSummary)){unsortedCounts.push([column.id,columnSummary])}else{unsortedCounts.push([column.id,0])}}else{unsortedCounts.push([column.id,0])}}else{if(rowSummary&&rowSummary.options){columnSummary=rowSummary.options[column.id];if(columnSummary){unsortedCounts.push([column.id,columnSummary.count])}else{unsortedCounts.push([column.id,0])}}else{unsortedCounts.push([column.id,0])}}}})});setSortedColumnPositions(unsortedCounts,sortOrder)}function setColumnPositionsByColumnChoiceCount(rowId,columnChoiceId,sortOrder){var unsortedCounts=[],columnChoices,rowSummary,columnSummary,columnChoiceSummary;$.each(self.columns,function(i,column){$.each(self.rows,function(j,row){if(row.id===rowId){rowSummary=self.summary.summary.options[row.id];columnSummary=rowSummary.options[column.id];if(rowSummary&&columnSummary){columnChoices=column.items;$.each(columnChoices,function(k,columnChoice){if(columnChoice.id===columnChoiceId){columnChoiceSummary=columnSummary.options[columnChoice.id];unsortedCounts.push([column.id,columnChoiceSummary.count])}})}else{unsortedCounts.push([column.id,0])}}})});setSortedColumnPositions(unsortedCounts,sortOrder)}function setColumnChoicePositionsByRowCount(columnId,rowId,sortOrder){var unsortedCounts=[],columnChoices,rowSummary,columnSummary,columnChoiceSummary;var column=getColumnByID(columnId);columnChoices=column.items;$.each(columnChoices,function(j,columnChoice){$.each(self.rows,function(k,row){if(row.id===rowId){rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){columnChoiceSummary=columnSummary.options[columnChoice.id];if(columnChoiceSummary){unsortedCounts.push([columnChoice.id,columnChoiceSummary.count])}else{unsortedCounts.push([columnChoice.id,0])}}else{unsortedCounts.push([columnChoice.id,0])}}else{unsortedCounts.push([columnChoice.id,0])}}})});setSortedColumnChoicePositions(unsortedCounts,sortOrder)}function setColumnChoicePositionByColumnCount(rowId,columnId,sortOrder){var row=getRowByID(rowId),column,columnChoices,key,rowSummary,columnSummary,columnChoiceSummary,unsortedCounts=[];if(!self.sortingBS){column=getColumnByID(columnId);columnChoices=column.items}else{column=_.findWhere(SM.BasicStatsUtils.cols,{id:columnId});columnChoices=self.columns[0].items}key=self.sortingBS?"stats":"options";rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary[key][column.id];if(columnSummary){$.each(columnChoices,function(i,columnChoice){if(self.sortingBS){columnChoiceSummary=columnSummary.compare[columnChoice.id];unsortedCounts.push([columnChoice.id,columnChoiceSummary])}else{columnChoiceSummary=columnSummary.options[columnChoice.id];unsortedCounts.push([columnChoice.id,columnChoiceSummary.count])}})}else{$.each(columnChoices,function(i,columnChoice){unsortedCounts.push([columnChoice.id,0])})}}else{$.each(columnChoices,function(i,columnChoice){unsortedCounts.push([columnChoice.id,0])})}setSortedColumnChoicePositions(unsortedCounts,sortOrder)}function setRowPositionsByLabel(sortOrder){var unsortedLabels=[];_.map(self.rows,function(row){unsortedLabels.push([row.id,row.text])});setSortedRowPositions(unsortedLabels,sortOrder)}function setColumnPositionsByLabel(sortOrder){var unsortedLabels=[];_.map(self.columns,function(column){unsortedLabels.push([column.id,column.text])});setSortedColumnPositions(unsortedLabels,sortOrder)}function setColumnChoicePositionsByLabel(dimensionId,sortOrder){var unsortedLabels=[],column,columnChoices;if(self.isCompared){columnChoices=_.values(self.columnChoices)}else{column=getColumnByID(dimensionId);columnChoices=column.items}_.map(columnChoices,function(columnChoice){unsortedLabels.push([columnChoice.id,columnChoice.text])});setSortedColumnChoicePositions(unsortedLabels,sortOrder)}function setRowPositionsByTotal(sortOrder){var unsortedTotals=[],rowSummary;_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){unsortedTotals.push([row.id,rowSummary.row_total])}else{unsortedTotals.push([row.id,0])}});setSortedRowPositions(unsortedTotals,sortOrder)}function setRowPositionsByColumnTotal(columnId,sortOrder){var unsortedTotals=[],rowSummary,columnSummary;_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[columnId];if(columnSummary){unsortedTotals.push([row.id,columnSummary.row_total])}else{unsortedTotals.push([row.id,0])}}else{unsortedTotals.push([row.id,0])}});setSortedRowPositions(unsortedTotals,sortOrder)}function setColumnPositionsByTotal(sortOrder){var unsortedTotals=[];_.each(self.columns,function(column){unsortedTotals.push([column.id,self.columnTotals[column.id]])});setSortedColumnPositions(unsortedTotals,sortOrder)}function setColumnPositionsByRowTotal(rowId,sortOrder){var unsortedTotals=[];$.each(self.columns,function(i,column){unsortedTotals.push([column.id,self.columnTotalsByRow[rowId][column.id]])});setSortedColumnPositions(unsortedTotals,sortOrder)}function setColumnChoicePositionsByRowTotal(columnId,sortOrder){var unsortedTotals=[],columnChoices,columnChoiceTotals;$.each(self.columns,function(i,column){if(column.id===columnId){columnChoices=column.items;columnChoiceTotals=calculateColumnChoiceTotalsByRow(columnChoices);$.each(columnChoices,function(j,columnChoice){unsortedTotals.push([columnChoice.id,columnChoiceTotals[columnChoice.id]])})}});setSortedColumnChoicePositions(unsortedTotals,sortOrder)}function setColumnChoicePositionsByColumnTotal(rowId,sortOrder){var unsortedTotals=[];_.each(self.rows,function(row){if(row.id===rowId){_.each(self.columnChoices,function(columnChoice){unsortedTotals.push([columnChoice.id,self.columnChoiceTotalsByRow[row.id][columnChoice.id]])})}});setSortedColumnChoicePositions(unsortedTotals,sortOrder)}function setRowPositionsByRowSum(sortOrder){var unsortedSums=[],rowSummary;_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){unsortedSums.push([row.id,rowSummary.sum])}else{unsortedSums.push([row.id,0])}});setSortedRowPositions(unsortedSums,sortOrder)}function setRowPositionsByAverageRating(sortOrder){var unsortedWeightedAverages=[];$.each(self.weightedAveragesByRow,function(rowId,weightedAverage){unsortedWeightedAverages.push([rowId,weightedAverage])});setSortedRowPositions(unsortedWeightedAverages,sortOrder)}function setColumnPositionsByAverageRating(sortOrder){var unsortedWeightedAverages=[];$.each(self.columns,function(i,column){unsortedWeightedAverages.push([column.id,column.options.weight])});setSortedColumnPositions(unsortedWeightedAverages,sortOrder)}function setRowPositionsByAverageNumber(sortOrder){var unsortedNumbers=[],rowSummary;_.each(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){unsortedNumbers.push([row.id,rowSummary.average])}else{unsortedNumbers.push([row.id,0])}});setSortedRowPositions(unsortedNumbers,sortOrder)}function setRowPositionsByResponses(sortOrder){var unsortedNumResponses=[],rowSummary;_.each(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];if(rowSummary){unsortedNumResponses.push([row.id,rowSummary.count])}else{unsortedNumResponses.push([row.id,0])}});setSortedRowPositions(unsortedNumResponses,sortOrder)}function setRowPositionsByScores(sortOrder){var unsortedNumResponses=[],rowSummary;_.each(self.rows,function(row){rowSummary=self.summary.summary.quiz_stats.option_values[row.id];if(rowSummary){unsortedNumResponses.push([row.id,rowSummary.score])}else{unsortedNumResponses.push([row.id,0])}});setSortedRowPositions(unsortedNumResponses,sortOrder)}function sortQuizQuestions(sortOrder,sortBy){var sortKey=sortBy==="rankings"?"rank":sortBy==="averageScores"?"avg_score":"position",survey=self.question.survey,quizRankings=_.map(self.question.structure.question_ranking,function(rank){var q=survey.getQuestion(rank.question_id);_.extend(rank,{heading:q.heading,position:q.position});return rank});quizRankings.sort(function(a,b){var aVal=a[sortKey],bVal=b[sortKey];if(sortKey!=="position"){if(!a.rank&&!b.rank){return a.position-b.position}if(!a.rank){return 1}if(!b.rank){return-1}if(aVal===bVal){return 0}}if(sortOrder==="descending"){return aVal<bVal?1:-1}return aVal>bVal?1:-1});self.sortedPositions.quizRankings=quizRankings}function setSortedRowPositions(unsortedArray,sortOrder){_setSortedDimensionPositions("rows",unsortedArray,sortOrder)}function setSortedColumnPositions(unsortedArray,sortOrder){_setSortedDimensionPositions("columns",unsortedArray,sortOrder)}function setSortedColumnChoicePositions(unsortedArray,sortOrder){_setSortedDimensionPositions("columnChoices",unsortedArray,sortOrder)}function _setSortedDimensionPositions(dimensionType,unsortedArray,sortOrder){var sortedArray,sortedDimensionPositions={};if(sortOrder===SORT_ORDER_ASC){sortedArray=unsortedArray.sort(_sortAsc)}else if(sortOrder===SORT_ORDER_DESC){sortedArray=unsortedArray.sort(_sortDesc)}else if(sortOrder===SORT_ORDER_UNSORTED){sortedArray=unsortedArray}$.each(sortedArray,function(position,array){var dimensionId=array[0];sortedDimensionPositions[dimensionId]=position});self.sortedPositions[dimensionType].push(sortedDimensionPositions)}function _sortAsc(a,b){if(typeof a[1]==="string"){if(a[1].toLowerCase()>b[1].toLowerCase()){return 1}if(a[1].toLowerCase()<b[1].toLowerCase()){return-1}return 0}return a[1]-b[1]}function _sortDesc(a,b){if(typeof a[1]==="string"){if(a[1].toLowerCase()<b[1].toLowerCase()){return 1}if(a[1].toLowerCase()>b[1].toLowerCase()){return-1}return 0}return b[1]-a[1]}_initialize(opts)};SM.NPSSummary=function(opts){var self=this,dim="rows",question,display,rollup,combinehideModel;function _initialize(options){question.init(options);display.init(options);rollup.init(options);combinehideModel.init(options)}function _build(){combinehideModel._buildComposites();self.compositeSummary=rollup.compositeSummary;self.compositeAnswerStructure=question.compositeAnswerStructure}question=SM.Object.deepExtend(SM.QuestionModel,{init:function(options){this.structure={answers:options.answerStructures};this.answers=options.answerStructures;this.dim=dim},canCombineHide:function(){return true},isMultipleChoice:function(){return true},getCombineHideDim:function(){return this.dim},getContextStructure:function(){return this.structure},getContextAnswerStructure:function(){return this.answers}});display=SM.Object.deepExtend(SM.QuestionDisplayModel,{init:function(){this.question=question;this.rollup=rollup;this.display={}},getDisplayData:function(){return this.display}});rollup=SM.Object.deepExtend(SM.QuestionRollupModel,{init:function(options){this.question=question;this.summary=options.rollup;this.display=display;this.type=options.type}});combinehideModel=SM.Object.deepExtend(SM.QuestionCombineHideModel,{init:function(options){this.question=question;this.rollup=rollup;if(options.type==="score"){this.buildSettings4Score(options.answerStructures[dim])}else{this.buildSettings4Distribution(options.answerStructures[dim])}},buildSettings4Score:function(rows){var ids=_.pluck(rows,"id");this.settings={combines:[{id:"Score",title:"",combine:ids}],hides:[]}},buildSettings4Distribution:function(rows){var ids=_.pluck(rows,"id");this.settings={combines:[{combine:ids.slice(0,7),id:"Detractors",title:Globalize.localize("Detractors (0-6)")},{combine:ids.slice(7,9),id:"Passives",title:Globalize.localize("Passives (7-8)")},{combine:ids.slice(9,11),id:"Promoters",title:Globalize.localize("Promoters (9-10)")}],hides:[]}}});_initialize(opts);_build()};SM.Sortable={SORTING_ORDERS:{UNSORTED:"unsorted",ASCENDING:"ascending",DESCENDING:"descending"},DIMENSION_TYPES:{LABELS:"labels",RESPONSES:"responses",TOTALS:"totals",POSITIONS:"positions",RANKINGS:"rankings",SCORES:"scores",AVERAGE_SCORES:"averageScores",AVERAGE_RATING:"averageRating",AVERAGE_NUMBER:"averageNumber",ROW:"row",COLUMN:"column",COLUMN_CHOICE:"columnChoice",DATA_SEGMENT:"dataSegment",MIN:"min",LOWER_QUARTILE:"lowerQuartile",MEDIAN:"median",UPPER_QUARTILE:"upperQuartile",MAX:"max"}};SM.Summarizable={SCALE_TYPE_PERCENT:"percent",_createAsSummarizable:function(options){var self=this,question=options.question,rollup=question.getRollup(),display=rollup.display,showingBenchmark=display.getBenchmarkDisplay(),isTop2ChartType=display.isTop2ChartType(),isTop2=question.isTop2(),useComposites=!showingBenchmark||isTop2&&isTop2ChartType,useTop2Composites=showingBenchmark&&isTop2&&isTop2ChartType,answerStructures=useComposites?question.getContextAnswerStructure(useTop2Composites):question.getContextStructure().answers,summary=useComposites?rollup.getContextSummary(useTop2Composites):rollup.summary;self.question=question;self.isCompared=question.isCompared();self.rollup=rollup;self.display=display;self.summary=summary;self.benchmarkSummary=this.question.survey.getBenchmarkRollup(self.question.ID);
self.questionType=this.summary.type;self.questionSubType=this.question.subtype;self.questionFamily=this.question.family;self.answerStructures=self.labelAnswerStructures(answerStructures,self.display,{noLabelByWeight:options.noLabelByWeight,noLabelBySidi:options.noLabelBySidi});self._setAsSummarizable();self._mungeOtherData()},_setAsSummarizable:function(){var self=this;self.rows=self.answerStructures.rows.slice();self.columns=self.answerStructures.cols;self.others=self.answerStructures.other;self.crossedOptions=self.answerStructures.crossedOptions;self.numRows=self.rows.length;self.numColumns=self.columns?self.columns.length:0},_setAsSummarizableNps:function(nps_depth){var self=this,sortedSummary,npsSummary;npsSummary=self.npsSummary[nps_depth];self.summary=npsSummary.summary;self.answerStructures=self.labelAnswerStructures(npsSummary.answerStructures,self.display);if(self.question.isCompared()){self._setAsSummarizable();sortedSummary=self.rollup.getSortedSummary({summary:self.summary,answerStructures:self.answerStructures});self.setSortedSummaryAttributes(sortedSummary);self.scoresByColumn=sortedSummary.counts.scoresByColumn;self.sortedRowsList=[self.answerStructures.rows]}},_setAsSummarizableNpsScoreComparedChart:function(){var self=this,sortedSummary,npsSummary;npsSummary=self.npsSummary.distribution;self.summary=npsSummary.summary;self.answerStructures=self.labelAnswerStructures(npsSummary.answerStructures,self.display);self._setAsSummarizable();sortedSummary=self.rollup.getSortedSummary({summary:self.summary,answerStructures:self.answerStructures});self.setSortedSummaryAttributes(sortedSummary);self.scoresByColumn=sortedSummary.counts.scoresByColumn;npsSummary=self.npsSummary.score;self.answerStructures=self.labelAnswerStructures(npsSummary.answerStructures,self.display);self._setAsSummarizable();self.sortedRowsList=[self.answerStructures.rows];self.summary.summary.options={Score:{options:self.scoresByColumn}}},labelAnswerStructures:function(questionAnswerStructures,display,labelOptions,question){var self=this,answerStructures,isMirrored=display.getDisplayData().mirror,showBasicStats=display.getDisplayData().show_basic_stats,showSidiStats=display.getDisplayData().show_sig_diffs,noLabelByWeight=labelOptions&&labelOptions.noLabelByWeight,noLabelBySidi=labelOptions&&labelOptions.noLabelBySidi,labels=display.getDisplayData().labels,labelData,otherOption;question=question||self.question;if(showBasicStats&&!noLabelByWeight&&question.ID!=="quiz_summary"){answerStructures=question.labelByWeights(questionAnswerStructures)}else{answerStructures=SM.Object.deepCopy(questionAnswerStructures)}if(labels){if(labels.rows){_.each(answerStructures.rows,function(row){labelData=labels.rows[row.id];if(labelData){if(!_.isEmpty(labelData.text)){row.text=labelData.text}}})}if(labels.columns){_.each(answerStructures.cols,function(column){labelData=labels.columns[column.id];if(labelData){if(!_.isEmpty(labelData.text)){column.text=labelData.text}}})}if(labels.columnChoices){_.each(answerStructures.cols,function(column){_.each(column.items,function(columnChoice){labelData=labels.columnChoices[columnChoice.id];if(labelData){if(!_.isEmpty(labelData.text)){columnChoice.text=labelData.text}}})})}if(labels.crossedOptions){_.each(answerStructures.crossedOptions,function(crossedOption){labelData=labels.crossedOptions[crossedOption.id];if(labelData){if(!_.isEmpty(labelData.text)){crossedOption.text=labelData.text;if(showSidiStats){crossedOption.text+=" (A)"}}}});if(isMirrored){_.each(answerStructures.cols,function(column){_.each(column.items,function(columnChoice){labelData=labels.crossedOptions[columnChoice.id];if(labelData){if(!_.isEmpty(labelData.text)){columnChoice.text=labelData.text}}})})}else{_.each(answerStructures.rows,function(row){_.each(row.items,function(columnChoice){labelData=labels.crossedOptions[columnChoice.id];if(labelData){if(!_.isEmpty(labelData.text)){columnChoice.text=labelData.text}}})})}if(answerStructures.cols&&answerStructures.crossedOptions&&answerStructures.cols[0].id===answerStructures.crossedOptions[0].id){_.each(answerStructures.cols,function(column){labelData=labels.crossedOptions[column.id];if(labelData){if(!_.isEmpty(labelData.text)){column.text=labelData.text}}})}}if(labels.others){otherOption=answerStructures.other[0];labelData=labels.others[otherOption.id];if(!_.isEmpty(labelData.text)){otherOption.text=labelData.text}}}if(!noLabelBySidi){self.labelBySidi(answerStructures,question,display)}return answerStructures},labelBySidi:function(answerStructures,question,display){var isMirrored=display.getDisplayData().mirror,showSidiStats=display.getDisplayData().show_sig_diffs;if(showSidiStats&&question.canSidi()&&question.isCompared()){if(question.isMenuMatrix()){if(isMirrored){_.each(answerStructures.cols,function(column){_.each(column.items,function(columnChoice){if(columnChoice.sidiLabel){columnChoice.text+=" ("+columnChoice.sidiLabel+")"}})})}else{_.each(answerStructures.rows,function(row){_.each(row.items,function(columnChoice){if(columnChoice.sidiLabel){columnChoice.text+=" ("+columnChoice.sidiLabel+")"}})})}}else{if(answerStructures.cols&&answerStructures.crossedOptions&&answerStructures.cols[0].id===answerStructures.crossedOptions[0].id){_.each(answerStructures.cols,function(column){if(column.sidiLabel){column.text+=" ("+column.sidiLabel+")"}})}}}return answerStructures},_getDisplayOptions:function(){var self=this;self.displayData=self.rollup.display.getDisplayData();self.showTable=self.displayData.show_table;self.showChart=self.displayData.show_chart;self.isMirrored=self.displayData.mirror;self.isStacked=self.displayData.isStacked;self.isWeightedAvg=self.displayData.isWeightedAvg;self.showDataLabels=self.displayData.show_data;self.hideEmptyData=!self.displayData.show_empty_data;self.scaleType=self.displayData.scale_type;self.scaleIsPercent=self.scaleType===self.SCALE_TYPE_PERCENT;self.decimalPlaces=self.scaleIsPercent?self.displayData.dp_percentage:self.displayData.dp_absolute;self.decimalPlacesAbsolute=self.displayData.dp_absolute;self.decimalPlacesPercentage=self.displayData.dp_percentage;self.showBasicStats=self.displayData.show_basic_stats;self.showSidi=self.displayData.show_sig_diffs},_getSortedSummaryData:function(){var self=this,sortedSummary=self.rollup.getSortedSummary({summary:self.summary,answerStructures:self.answerStructures});self.summaryType=self.isCompared?self.summary.summary.type:self.summary.type;self.hasColumnChoices=self.summaryType==="menu_matrix";if(self.isCompared){self.aggregateOverColumns=self.summaryType==="matrix"&&self.isMirrored}else{self.aggregateOverColumns=self.isMirrored}self.setSortedSummaryAttributes(sortedSummary)},setSortedSummaryAttributes:function(sortedSummary){var self=this;self.sortedRowsList=sortedSummary.sortedAnswers.rowsList;self.sortedColumnsList=sortedSummary.sortedAnswers.columnsList;self.sortedColumnChoicesList=sortedSummary.sortedAnswers.columnChoicesList;self.sortedRowsListBS=sortedSummary.sortedBS.rowsList;self.sortedColumnsListBS=sortedSummary.sortedBS.columnsList;self.sortedColumnChoicesListBS=sortedSummary.sortedBS.columnChoicesList;self.responsesCountsByRow=sortedSummary.counts.responsesCountsByRow;self.responsesCountsByColumn=sortedSummary.counts.responsesCountsByColumn;self.respondentCountsByColumn=sortedSummary.counts.respondentCountsByColumn;self.respondentCountsByRow=sortedSummary.counts.respondentCountsByRow;self.sortedRowTotals=sortedSummary.totals.sortedRowTotals;self.sortedColumnTotals=sortedSummary.totals.sortedColumnTotals;self.columnTotalsByRow=sortedSummary.totals.columnTotalsByRow;self.columnChoiceTotalsByRow=sortedSummary.totals.columnChoiceTotalsByRow;self.columnChoiceTotalsByColumnChoice=sortedSummary.totals.columnChoiceTotalsByColumnChoice;self.weightedAveragesByRow=sortedSummary.weightedAverages.weightedAveragesByRow;self.weightedAveragesByColumn=sortedSummary.weightedAverages.weightedAveragesByColumn;self.weightedAveragesByRowAndColumn=sortedSummary.weightedAverages.weightedAveragesByRowAndColumn;self.weightedAveragesByRowAndColumnChoice=sortedSummary.weightedAverages.weightedAveragesByRowAndColumnChoice;self.weights=sortedSummary.weights},_getNpsData:function(){var self=this;self.npsSummary=self.rollup.buildNpsSummary()},_mungeOtherData:function(){var self=this;var otherIsAnswer=self.others!==undefined&&self.others[0].options.is_answer_choice;if(otherIsAnswer){_.each(self.others,function(other){self.rows.push(other)})}}};SM.SummarySeriesFactory=SM.Object.extend(SM.Summarizable,SM.Sortable,{buildSimpleSeries:function(summary,rows,options){var self=this,data,datum,row,name,total;data=self._summarizeDimension(rows,summary.summary,function(rowSummary,rowIndex){row=rows[rowIndex];name=row?row.text:null;total=self.summary.answered;datum=self._buildSeriesItemDatum(rowSummary,total,name);return datum},function(rowIndex){row=rows[rowIndex];name=row?row.text:null;datum=self._buildSeriesItemDatum(null,0,name);return datum},options&&options.isBasicStats?{key:"stats"}:null);return[self._buildSeriesItem(data)]},_makeWeights:function(rows){var weights={};_.each(rows,function(row){weights[row.id]=row.position});return weights},buildSimpleWeightedAverageSeries:function(summary,rows){var weights=this._makeWeights(rows),series=[],value=0,total=0,average,datum,seriesItem;_.each(summary.summary.options,function(item,id){total+=item.count;value+=item.count*weights[id]});if(total===0){average=1}else{average=value/total}datum=this._buildSeriesItemDatum(average,total,"weightedAverage");seriesItem=this._buildSeriesItem([datum]);series.push(seriesItem);return series},buildSimpleSeriesFromMatrixSummary:function(){var self=this,series=[],seriesItem,data,datum,sortedColumns,row,rowSummary,column,name,total;row=self.rows[0];rowSummary=self.summary.summary.options[row.id];sortedColumns=self.sortedColumnsList[0];data=self._summarizeDimension(sortedColumns,rowSummary,function(columnSummary,columnIndex){column=sortedColumns[columnIndex];name=column?column.text:null;total=rowSummary.row_total;datum=self._buildSeriesItemDatum(columnSummary,total,name);return datum},function(columnIndex){column=sortedColumns[columnIndex];name=column?column.text:null;datum=self._buildSeriesItemDatum(null,0,name);return datum});seriesItem=self._buildSeriesItem(data);series.push(seriesItem);return series},buildSimpleSeriesFromComparedMatrixSummary:function(){var self=this,series=[],seriesItem,data,datum,column,rowSummary,columnSummary,name,total;column=self.columns[0];total=self.summary.answered;data=_.map(self.rows,function(row){rowSummary=self.summary.summary.options[row.id];name=row.text;if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){datum=self._buildSeriesItemDatum(columnSummary,total,name)}else{datum=self._buildSeriesItemDatum(null,0,name)}}else{datum=self._buildSeriesItemDatum(null,0,name)}return datum});seriesItem=self._buildSeriesItem(data);series.push(seriesItem);return series},buildSimpleSeriesFromMenuMatrixSummary:function(columnID){var self=this,series=[],seriesItem,data,datum,sortedColumnChoices,row,rowSummary,columnSummary,columnChoice,name,total;row=self.rows[0];rowSummary=self.summary.summary.options[row.id];columnSummary=rowSummary.options[columnID];sortedColumnChoices=self.sortedColumnChoicesList[0];data=self._summarizeDimension(sortedColumnChoices,columnSummary,function(columnChoiceSummary,columnChoiceIndex){columnChoice=sortedColumnChoices[columnChoiceIndex];name=columnChoice?columnChoice.text:null;total=columnSummary.row_total;datum=self._buildSeriesItemDatum(columnChoiceSummary,total,name);return datum},function(columnChoiceSummary,columnChoiceIndex){columnChoice=sortedColumnChoices[columnChoiceIndex];name=columnChoice?columnChoice.text:null;datum=self._buildSeriesItemDatum(null,0,name);return datum});seriesItem=self._buildSeriesItem(data);series.push(seriesItem);return series},buildSimpleStackedSeries:function(summary,sortedRows){var self=this,data,datum,series,row,name,total,numSeries;data=self._summarizeDimension(sortedRows,summary.summary,function(rowSummary,rowIndex){row=sortedRows[rowIndex];name=row?row.text:null;total=self.summary.answered;datum=self._buildSeriesItemDatum(rowSummary,total,name);return datum},function(rowIndex){row=sortedRows[rowIndex];name=row.text;datum=self._buildSeriesItemDatum(null,0,name);return datum});series=_.map(data,function(seriesItemData,i){name=seriesItemData.name;numSeries=sortedRows.length;return self._buildSeriesItem([seriesItemData],{name:name,index:i,numSeries:numSeries})});return series},buildTop2StackedSeries:function(options){var self=this,summary=options.isCompared?self.rollup.top2compositeSummary:self.summary,answeredSubtotals=self.rollup.summary.summary.answered_subtotals,benchmarkSummary=self.question.getBenchmarkRollup(),answerStructures=self.answerStructures,rows=options.isCompared?answerStructures.cols:answerStructures.rows,series,seriesItem,seriesItemDataTop2=[],seriesItemDataRest=[],seriesItemAnsweredTotal=[],seriesItemDataBMTop2,seriesItemDataBMRest,seriesItemDataBlank,seriesItemDataBlankList,seriesItemTotalBM,fullTotal=self.rollup.answeredCount,compositeTotal=self.summary.answered,bmTotal=benchmarkSummary.getNumResponses(),distributionValues=benchmarkSummary.getContextDistributionValues(),top2Total=[],restValue,bmTop2Total=0,bmTop2pct,bmRestPct,i,top2Name=Globalize.localize("Your Top 2 Box Score"),benchmarkName=benchmarkSummary.getSegmentName()+" "+Globalize.localize("Top 2 Box Score");options=options||{};for(i=0;i<rows.length;i++){top2Total[i]=0}if(options.isCompared){_.each(rows,function(column,index){_.each(summary.summary.options,function(row){_.each(row.options,function(option,optionID){if(optionID===column.id){top2Total[index]+=option.count}})})});_.each(top2Total,function(value,index){var xrowID=self.summary.crossed_rows[index],rowTotal=answeredSubtotals[xrowID],top2pct=rowTotal===0?0:value*100/rowTotal,rowTotalPct=fullTotal===0?0:rowTotal*100/fullTotal,disableLabel=value===0,restPct,name=top2Name;seriesItemDataTop2.push({__options:{disableDataLabels:disableLabel},y:top2pct,absoluteY:value,percentageY:top2pct,name:name});seriesItemAnsweredTotal.push({y:rowTotalPct,absoluteY:rowTotal,percentageY:rowTotalPct,name:name});if(options.isTable){restValue=rowTotal;restPct=rowTotal===0?0:restValue*100/compositeTotal}else{restValue=rowTotal-value;restPct=rowTotal===0||value===0?0:restValue*100/rowTotal}seriesItemDataRest.push({__options:{disableDataLabels:true},y:restPct,absoluteY:restValue,percentageY:restPct,name:"rest"})})}else{self._summarizeDimension(rows,summary.summary,function(rowSummary,rowIndex){top2Total[rowIndex]+=rowSummary.count;return{}},function(){return{}});_.each(top2Total,function(value,index){var top2pct=fullTotal===0?0:value*100/fullTotal,restPct=fullTotal===0?0:(fullTotal-value)*100/fullTotal,name=options.isCompared?rows[index].text:top2Name,disableLabel=value===0;if(index===0){self.top2pct=top2pct}seriesItemDataTop2.push({__options:{decimalPlaces:1,disableDataLabels:disableLabel},y:top2pct,absoluteY:value,percentageY:top2pct,name:name});seriesItemDataRest.push({__options:{disableDataLabels:true},y:restPct,absoluteY:fullTotal-value,percentageY:restPct,name:"rest"})})}bmTop2Total=distributionValues.length===0?0:0 in distributionValues?distributionValues[0].count:0;seriesItemDataBlank={y:0,absoluteY:0,percentageY:0,name:"blank"};bmTop2pct=bmTotal===0?0:bmTop2Total*100/bmTotal;bmRestPct=bmTotal===0?0:(bmTotal-bmTop2Total)*100/bmTotal;self.bmTop2pct=bmTop2pct;seriesItemDataBMTop2={y:bmTop2pct,absoluteY:bmTop2Total,percentageY:bmTop2pct,name:"BMtop2"};seriesItemDataBMRest={__options:{disableDataLabels:true},y:bmRestPct,absoluteY:bmTotal-bmTop2Total,percentageY:bmRestPct,name:"BMrest"};seriesItemTotalBM={y:100,absoluteY:bmTotal,percentageY:100};if(options.isTable){series=[];if(options.isCompared){if(options.distribution){seriesItem=self._buildSeriesItem([seriesItemDataBMTop2],{dimension:{text:benchmarkSummary.getSegmentName(),type:"responses"},index:0,numSeries:1,template:"benchmark-matrix-table-response-cell",name:"name of segment"});series.push(seriesItem);seriesItem=self._buildSeriesItem([seriesItemTotalBM],{dimension:{text:Globalize.localize("Total"),type:"responses"},index:0,numSeries:1,template:"benchmark-matrix-table-response-cell",name:"sub totals"});series.push(seriesItem)}else{seriesItem=self._buildSeriesItem(seriesItemDataTop2,{dimension:{text:Globalize.localize("Your Top 2 Box Score"),type:"row"},index:0,numSeries:seriesItemDataTop2.length,template:"benchmark-matrix-table-response-cell",name:top2Name});series.push(seriesItem);seriesItem=self._buildSeriesItem(seriesItemAnsweredTotal,{dimension:{text:Globalize.localize("Total"),type:"row"},index:0,numSeries:1,template:"benchmark-matrix-table-response-cell",name:"sub totals"});series.push(seriesItem)}}else{seriesItem=self._buildSeriesItem(seriesItemDataTop2,{dimension:{text:Globalize.localize("Your Responses"),dimension:"row"},index:0,numSeries:seriesItemDataTop2.length,template:"benchmark-matrix-table-response-cell",name:top2Name});series.push(seriesItem);seriesItem=self._buildSeriesItem([seriesItemDataBMTop2],{dimension:{text:benchmarkSummary.getSegmentName(),dimension:"row"},index:0,numSeries:1,sampleSize:benchmarkSummary.getSampleSize(),template:"benchmark-matrix-table-response-cell",name:"name of segment"});series.push(seriesItem)}}else{seriesItemDataTop2.push(seriesItemDataBlank);seriesItemDataRest.push(seriesItemDataBMRest);seriesItemDataBlankList=[];for(i=0;i<top2Total.length;i++){seriesItemDataBlankList.push(seriesItemDataBlank)}seriesItemDataBlankList.push(seriesItemDataBMTop2);series=[self._buildSeriesItem(seriesItemDataTop2,{name:top2Name,index:0,numSeries:seriesItemDataTop2.length}),self._buildSeriesItem(seriesItemDataBlankList,{name:benchmarkName,index:1,numSeries:seriesItemDataBlankList.length}),self._buildSeriesItem(seriesItemDataRest,{name:"rest",hideLegendItem:true,index:2,numSeries:seriesItemDataRest.length,disableHover:true})]}return series},buildNumericalSeries:function(options){var self=this,series=[],seriesItem,sortedRows,rowSummary,averagesData,sumsData,responsesData,average,sum,numResponses;options=options||{};sortedRows=self.sortedRowsList[0];averagesData=_.map(sortedRows,function(row){rowSummary=self.summary.summary.options[row.id];average=rowSummary?rowSummary.average:0;return{absoluteY:Globalize.format(average,"n0")}});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageNumber");series.push(seriesItem);sumsData=_.map(sortedRows,function(row){rowSummary=self.summary.summary.options[row.id];sum=rowSummary?rowSummary.sum:0;return{absoluteY:Globalize.format(sum,"n0")}});seriesItem=self._buildTableSeriesItem(sumsData,options.totalSeriesName,"totals");series.push(seriesItem);responsesData=_.map(sortedRows,function(row){rowSummary=self.summary.summary.options[row.id];numResponses=rowSummary?rowSummary.count:0;return{absoluteY:Globalize.format(numResponses,"n0")}});seriesItem=self._buildTableSeriesItem(responsesData,options.responsesSeriesName,"responses");series.push(seriesItem);return series},buildMatrixSeries:function(options){var self=this,columns,series=[],seriesItem,data,datum,datumOptions,sortedRows,columnSummary,averagesData,row,totalsData,total;options=options||{};columns=options.columns||self.columns;sortedRows=options.isBasicStats?self.sortedRowsListBS[0]:self.sortedRowsList[0];_.each(columns,function(column,columnIndex){data=self._summarizeDimension(sortedRows,self.summary.summary,function(rowSummary,rowIndex){if(options.isBasicStats&&rowSummary.stats){columnSummary=rowSummary.stats[column.id];datum=self._buildSeriesItemDatum(columnSummary,0,null,{})}else if(rowSummary.options){row=sortedRows[rowIndex];columnSummary=rowSummary.options[column.id];total=self.respondentCountsByRow[row.id];datumOptions={};if(self._seriesDatumHasComments(row)){datumOptions.commentData=self._buildCommentData({option:row,crossedOption:column,crossedOptionSummary:columnSummary,matrixCross:self._isMatrixCross(self.summary)})}datum=self._buildSeriesItemDatum(columnSummary,total,null,datumOptions)}else{datum=self._buildSeriesItemDatum(null,0)}return datum},function(rowIndex){row=sortedRows[rowIndex];datum=self._buildSeriesItemDatum(null,0);return datum});seriesItem=self._buildSeriesItem(data,{dimension:column,index:columnIndex,numSeries:self.numColumns});series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedRows,function(r){var t=self.respondentCountsByRow[r.id];return{absoluteY:Globalize.format(t,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}if(options.includeAverage){averagesData=self._calculateAverage(sortedRows,function(r){return self.weightedAveragesByRow[r.id]});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageRating");series.push(seriesItem)}return series},buildMirroredMatrixSeries:function(options){var self=this,rows,key,series=[],seriesItem,seriesItemOptions,totalsData,scoresData,data,datum,datumOptions,averagesData,sortedColumns,rowSummary,var_id,numComments,column,total;options=options||{};sortedColumns=options.isBasicStats?self.sortedColumnsListBS[0]:self.sortedColumnsList[0];rows=options.rows||self.rows;key=options.isBasicStats?"stats":"options";_.each(rows,function(row,rowIndex){rowSummary=self.summary.summary[key][row.id];data=self._summarizeDimension(sortedColumns,rowSummary,function(columnSummary,columnIndex){datumOptions={};column=sortedColumns[columnIndex];total=self.respondentCountsByColumn[column.id];if(self.question.randomAssignmentOption!==undefined){total=self.respondentCountsByRow[row.id]}if(self._seriesDatumHasComments(row)){var_id="0";if(self.question.randomAssignmentOption!==undefined){var_id=self.question.randomAssignmentOption.toString()}datumOptions.commentData=self._buildCommentData({option:row,crossedOption:column,crossedOptionSummary:columnSummary,matrixCross:self._isMatrixCross(self.summary),variationID:var_id})}datum=self._buildSeriesItemDatum(columnSummary,total,null,datumOptions);return datum},function(columnIndex){column=sortedColumns[columnIndex];datum=self._buildSeriesItemDatum(null,0);return datum},options.isBasicStats?{key:"compare"}:null);seriesItemOptions={dimension:row,index:rowIndex,numSeries:self.numRows};if(self.question.hasCommentsPerRow()){numComments=rowSummary?rowSummary.row_other:0;seriesItemOptions.hasCommentsPerRow=true;seriesItemOptions.numComments=Globalize.format(numComments,"n0")}seriesItem=self._buildSeriesItem(data,seriesItemOptions);series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedColumns,function(col){var t=self.responsesCountsByColumn[col.id];return{absoluteY:Globalize.format(t,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}if(options.includeScore){scoresData=_.map(sortedColumns,function(col){var score=self.scoresByColumn[col.id];return{absoluteY:Globalize.format(score.count,"n0")}});seriesItem=self._buildTableSeriesItem(scoresData,options.scoreSeriesName,"score");series.push(seriesItem)}if(options.includeAverage){averagesData=self._calculateAverage(sortedColumns,function(col){return self.weightedAveragesByColumn[col.id]});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageRating");series.push(seriesItem)}return series},buildMenuMatrixSeries:function(column,columnIndex,columnChoices,columnChoiceTotals,options){var self=this,series=[],seriesItem,data,datum,rowSummary,columnSummary,columnChoiceSummary,numColumnChoices,sortedRows,sortedColumnChoices,total,totalsData,key=options&&options.isBasicStats?"stats":"options",summary;options=options||{};summary=self.summary.summary;numColumnChoices=columnChoices.length;if(self.isMirrored&&!self.isBasicStats){sortedColumnChoices=self.sortedColumnChoicesList[columnIndex];_.each(self.rows,function(row,i){rowSummary=summary.options[row.id];if(rowSummary){columnSummary=rowSummary.options[column.id];if(columnSummary){data=self._summarizeDimension(sortedColumnChoices,columnSummary,function(colChoiceSummary,index,columnChoiceId){total=columnChoiceTotals[columnChoiceId];datum=self._buildSeriesItemDatum(colChoiceSummary,total);return datum},function(){datum=self._buildSeriesItemDatum(null,0);return datum})}else{data=self._dataForUnsummarizedDimension(sortedColumnChoices.length)}}else{data=self._dataForUnsummarizedDimension(sortedColumnChoices.length)}seriesItem=self._buildSeriesItem(data,{dimension:row,index:i,numSeries:self.numRows});series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedColumnChoices,function(columnChoice){total=self.columnChoiceTotalsByColumnChoice[columnChoice.id];return{absoluteY:Globalize.format(total,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}}else{sortedRows=options.isBasicStats?self.sortedRowsListBS[columnIndex]:self.sortedRowsList[column.position-1];_.each(columnChoices,function(columnChoice,i){data=self._summarizeDimension(sortedRows,summary,function(rSummary){columnSummary=rSummary.options[column.id];if(columnSummary){columnChoiceSummary=columnSummary[key][columnChoice.id];total=columnSummary.row_total;datum=self._buildSeriesItemDatum(columnChoiceSummary,total)}else{datum=self._buildSeriesItemDatum(null,0)}return datum},function(){datum=self._buildSeriesItemDatum(null,0);return datum});seriesItem=self._buildSeriesItem(data,{dimension:columnChoice,index:i,numSeries:numColumnChoices});series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedRows,function(row){total=self.columnTotalsByRow[row.id][column.id];return{absoluteY:Globalize.format(total,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}}return series},buildComparedMatrixSeries:function(row,columnChoices,columnChoiceTotals,options){var self=this,series=[],key,data,datum,columns,rowSummary,columnSummary,columnChoiceSummary,seriesItem,numColumnChoices,sortedColumns,sortedColumnChoices,totalsData,total,averagesData,colID;options=options||{};numColumnChoices=columnChoices.length;rowSummary=self.summary.summary.options[row.id];if(self.isMirrored||self.isBasicStats){sortedColumnChoices=options.isBasicStats?self.sortedColumnChoicesListBS[row.position-1]:self.sortedColumnChoicesList[row.position-1];columns=options.columns||self.columns;key=options.isBasicStats?"stats":"options";_.each(columns,function(column,i){if(rowSummary){columnSummary=rowSummary[key][column.id];if(columnSummary){data=self._summarizeDimension(sortedColumnChoices,columnSummary,function(colChoiceSummary,index,columnChoiceId){total=columnChoiceTotals[columnChoiceId];datum=self._buildSeriesItemDatum(colChoiceSummary,total);return datum},null,options.isBasicStats?{key:"compare"}:null)}else{data=_.map(columnChoices,function(){datum=self._buildSeriesItemDatum(null,0);return datum})}}else{data=_.compact(_.map(columnChoices,function(columnChoice){if(columnChoice.id){datum=self._buildSeriesItemDatum(null,0);return datum}}))}seriesItem=self._buildSeriesItem(data,{dimension:column,index:i,numSeries:self.numColumns});series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedColumnChoices,function(columnChoice){total=self.columnChoiceTotalsByRow[row.id][columnChoice.id];return{absoluteY:Globalize.format(total,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}if(options.includeAverage){averagesData=self._calculateAverage(sortedColumnChoices,function(columnChoice){return self.weightedAveragesByRowAndColumnChoice[row.id][columnChoice.id]});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageRating");series.push(seriesItem)}}else{sortedColumns=self.sortedColumnsList[row.position-1];_.each(columnChoices,function(columnChoice,i){data=self._summarizeDimension(sortedColumns,rowSummary,function(colSummary){colID=columnChoice.id||columnChoice.variable_id;columnChoiceSummary=colSummary.options[colID];total=colSummary.row_total;datum=self._buildSeriesItemDatum(columnChoiceSummary,total);return datum},function(){datum=self._buildSeriesItemDatum(null,0);return datum});seriesItem=self._buildSeriesItem(data,{dimension:columnChoice,index:i,numSeries:numColumnChoices});series.push(seriesItem)});if(options.includeTotal){totalsData=_.map(sortedColumns,function(column){total=self.columnTotalsByRow[row.id][column.id];return{absoluteY:Globalize.format(total,"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}if(options.includeAverage){averagesData=self._calculateAverage(sortedColumns,function(columnChoice){return self.weightedAveragesByRowAndColumnChoice[row.id][columnChoice.id]});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageRating");series.push(seriesItem)}}return series},buildComparedMatrixSeriesNumericalBasicStats:function(row,columns,columnChoices){var self=this,series=[],data,datum,rowSummary,columnSummary,seriesItem;rowSummary=self.summary.summary.stats[row.id];_.each(columns,function(column,i){if(rowSummary){columnSummary=rowSummary[column.id];if(columnSummary){data=self._summarizeDimension(columnChoices,columnSummary,function(columnChoiceSummary){datum=self._buildSeriesItemDatum(columnChoiceSummary,1);return datum},null,{key:"compare"})}else{data=_.map(columnChoices,function(){datum=self._buildSeriesItemDatum(null,0);return datum})}}else{data=_.compact(_.map(columnChoices,function(columnChoice){if(columnChoice.id){datum=self._buildSeriesItemDatum(null,0);return datum}}))}seriesItem=self._buildSeriesItem(data,{dimension:column,index:i,numSeries:self.numColumns});series.push(seriesItem)});return series},_buildBenchmarkDistributionTableSeries:function(benchmarkRollup,options){var series=[],seriesData,values=benchmarkRollup.getContextDistributionValues(),numResponses=benchmarkRollup.getNumResponses(),dataTemplate=options.isTop2?"table-response-cell":"benchmark-table-percentage-cell",totalTemplate=options.isTop2?"table-response-cell":"benchmark-table-response-cell";_.each(values,function(value,index){series.push({name:index,data:[{absoluteY:value.count,percentageY:value.percent*100,name:index}],__options:{dimensionType:options.isTop2?SM.Sortable.DIMENSION_TYPES.RESPONSES:"percentage",template:dataTemplate}})});seriesData=[{y:numResponses,absoluteY:numResponses,percentageY:100,name:5}];series.push({name:"Total",data:seriesData,__options:{dimensionType:SM.Sortable.DIMENSION_TYPES.RESPONSES,template:totalTemplate}});return series},_buildBenchmarkNPSDistributionTableSeries:function(benchmarkRollup){var series=[],values=benchmarkRollup.getNpsDistributionValues(),score=this.getNPSScore();_.each(values,function(value,index){var seriesData=[{absoluteY:value.responses,percentageY:value.percentage,name:index}];series.push({name:index,data:seriesData,__options:{dimensionType:"averageRating",template:"benchmark-table-response-cell"}})});series.push({name:"Net promo",data:[{absoluteY:score,percentageY:score,name:"Nt prom"}],__options:{dimensionType:"averageRating",template:"benchmark-table-response-cell"}});return series},_buildBenchmarkQuartileTableSeries:function(benchmarkRollup,options){var series=[],seriesData,values=benchmarkRollup.getQuartileValuesArray(),numResponses=benchmarkRollup.getNumResponses();_.each(values,function(value,index){seriesData=[{y:value,absoluteY:value,percentageY:value,value:value,name:options.names[index]}];series.push({name:"Benchmark",data:seriesData,__options:{dimensionType:"averageRating",template:"benchmark-table-response-cell"}})});if(!options.nps&&options.includeTotal){seriesData=[{y:numResponses,absoluteY:numResponses,percentageY:numResponses,name:5}];series.push({name:"Total",data:seriesData,__options:{dimensionType:SM.Sortable.DIMENSION_TYPES.RESPONSES,template:"benchmark-table-response-cell"}})
}return series},buildComparedAverageSeries:function(){var question=this.question,crossedOptions=question.compareStructure.answers.crossedOptions,rollup=this.question.getRollup(),optionsSummary=rollup.summary.summary.options,subtotals=rollup.summary.summary.answered_subtotals,seriesData=[],series=[];if(question.isNPS()){optionsSummary=this.npsSummary.distribution.summary.summary.options;_.each(crossedOptions,function(option){var crossedId=option.id,detractorOptions=optionsSummary.Detractors?optionsSummary.Detractors.options||{}:{},detractors=detractorOptions[crossedId]?detractorOptions[crossedId].count||0:0,passiveOptions=optionsSummary.Passives?optionsSummary.Passives.options||{}:{},passives=passiveOptions[crossedId]?passiveOptions[crossedId].count||0:0,promoterOptions=optionsSummary.Promoters?optionsSummary.Promoters.options||{}:{},promoters=promoterOptions[crossedId]?promoterOptions[crossedId].count||0:0,score;if(detractors+passives+promoters>0){score=100*(promoters-detractors)/(detractors+passives+promoters);seriesData.push({y:score,absoluteY:score,percentageY:score,value:score,name:option.text})}});series.push({name:"User Scores",data:seriesData,__options:{dimensionType:SM.Sortable.DIMENSION_TYPES.AVERAGE,template:"benchmark-table-response-cell"}});return series}_.each(crossedOptions,function(option){var crossedId=option.id,weightedTotal=0,weightedAvg=0;_.each(question.answers,function(answer,id){var weight=answer.position;if(optionsSummary[id]&&optionsSummary[id].options[crossedId]){weightedTotal+=optionsSummary[id].options[crossedId].count*weight}});if(subtotals[crossedId]){weightedAvg=weightedTotal/subtotals[crossedId]}seriesData.push({y:weightedAvg,absoluteY:weightedAvg,percentageY:weightedAvg,value:weightedAvg,name:option.text})});series.push({name:"Weighted Averages",data:seriesData,__options:{dimensionType:SM.Sortable.DIMENSION_TYPES.AVERAGE,template:"benchmark-table-response-cell"}});return series},NPS_MINIMUM:-100,NPS_MAXIMUM:100,BOXPLOT_LINE_WIDTH:4,BOXPLOT_MEDIAN_WIDTH:2,BOXPLOT_MEDIAN_COLOR:"#FFFFFF",BOXPLOT_USER_VALUE_LINE_WIDTH:2,_buildBenchmarkQuartileChartSeries:function(benchmarkRollup,options){var quartileValues=benchmarkRollup.getQuartileValues(),responseMean,comparedSeries,series=[],seriesData=[],chartColor=options.colors[0],userColors=SM.Highcharts.DEFAULT_BENCHMARK_COLORS.slice(1),scoreName;if(this.question.isCompared()){comparedSeries=this.buildComparedAverageSeries();_.each(comparedSeries[0].data,function(datum,index){series.push({name:datum.name,color:userColors[index%userColors.length],lineWidth:this.BOXPLOT_USER_VALUE_LINE_WIDTH,data:[datum],__options:{dimensionType:"userAverage"}})})}else{if(this.question.isNPS()){responseMean=this.getNPSScore();scoreName=Globalize.localize("Your Net Promoter&#174; Score")}else{responseMean=benchmarkRollup.getResponseMean(this.question.ID);if(this.question.is_tmbc){scoreName=Globalize.localize("Your average")}else{scoreName=Globalize.localize("Your score")}}series.push({name:scoreName,color:userColors[0],lineWidth:this.BOXPLOT_USER_VALUE_LINE_WIDTH,data:[{y:responseMean,absoluteY:responseMean,percentageY:responseMean,name:scoreName}]})}_.each(quartileValues,function(value,index){seriesData.push({y:value,absoluteY:value,percentageY:value,name:options.names[index]})});seriesData=[[],[],seriesData,[]];series.push({name:benchmarkRollup.getSegmentName(),pointWidth:58,data:seriesData,tooltip:{headerFormat:"<em>Experiment No {point.key}</em><br/>"},color:chartColor,fillColor:chartColor,stemColor:chartColor,stemWidth:this.BOXPLOT_LINE_WIDTH,whiskerColor:chartColor,whiskerWidth:this.BOXPLOT_LINE_WIDTH,medianColor:this.BOXPLOT_MEDIAN_COLOR,medianWidth:this.BOXPLOT_MEDIAN_WIDTH,__options:{dimensionType:"benchmark"}});return series},getNPSScore:function(){return this.npsSummary.score.summary.summary.options.Score.count},isNPSScoreValid:function(){var options,detractors,passives,promoters;if(this.question.isCompared()){options=this.npsSummary.distribution.summary.summary.options;if(!options){return false}detractors=options.Detractors?options.Detractors.row_total||0:0;passives=options.Passives?options.Passives.row_total||0:0;promoters=options.Promoters?options.Promoters.row_total||0:0;return detractors+passives+promoters!==0}return!this.npsSummary.score.summary.summary.options.Score.noResponses},buildSimpleBenchmarkSeries:function(options){var benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID);options.names=[Globalize.localize("Minimum"),Globalize.localize("Lower Quartile"),Globalize.localize("Median"),Globalize.localize("Upper Quartile"),Globalize.localize("Maximum")];if(options.tableOutput){if(options.distribution){if(this.question.isNPS()){return this._buildBenchmarkNPSDistributionTableSeries(benchmarkRollup,options)}if(options.isTop2&&options.isCompared){return this.buildTop2StackedSeries(options)}return this._buildBenchmarkDistributionTableSeries(benchmarkRollup,options)}return this._buildBenchmarkQuartileTableSeries(benchmarkRollup,options)}return this._buildBenchmarkQuartileChartSeries(benchmarkRollup,options)},_customizeColors:function(data,colors){_.each(data,function(datum,index){datum.color=colors[index]})},buildBenchmarkMatrixSeries:function(options){var self=this,series=[],seriesItem,data,datum,datumOptions,sortedRows,total,totalsData,averagesData,dimension,isNPS=self.question.isNPS(),summary,hasOthers=!_.isUndefined(self.answerStructures.other),isTop2Chart=self.displayData.benchmark_chart_type===self.display.DISPLAY_VALUES.top2_vbar||self.displayData.benchmark_chart_type===self.display.DISPLAY_VALUES.top2_hbar||self.displayData.benchmark_chart_type===self.display.DISPLAY_VALUES.top2_donut,distributionValues;options=options||{};summary=self.summary.summary;if(self.question.compositeAnswerStructure&&!(self.question.isTop2()&&isTop2Chart)){sortedRows=self.question.structure.answers.rows;summary=self.rollup.summary.summary}else if(isNPS){sortedRows=self.answerStructures.rows}else{sortedRows=self.sortedRowsList[0]}if(!options.ignoreUserData){total=0;_.each(summary.options,function(option,id){var isOther,others;if(hasOthers){others=_.find(self.answerStructures.other,function(item){if(item.id===id){return true}});isOther=!!others}if(!isOther){total=total+option.count}});data=self._summarizeDimension(sortedRows,summary,function(rowSummary){if(rowSummary){datumOptions={};datum=self._buildSeriesItemDatum(rowSummary,total,null,datumOptions)}else{datum=self._buildSeriesItemDatum(null,0)}return datum},function(){datum=self._buildSeriesItemDatum(null,0);return datum});if(isNPS){self._customizeColors(data,SM.Highcharts.NPS_DISTRIBUTION_COLORS)}dimension=SM.Object.extend({},sortedRows[0]);dimension.text=Globalize.localize("Your Responses");seriesItem=self._buildSeriesItem(data,{dimension:dimension,index:0,numSeries:2,template:"benchmark-matrix-table-response-cell"});series.push(seriesItem);if(options.includeTotal){totalsData=_.map(sortedRows,function(r){return{absoluteY:Globalize.format(self.respondentCountsByRow[r.id],"n0")}});seriesItem=self._buildTableSeriesItem(totalsData,options.totalSeriesName,"totals");series.push(seriesItem)}if(options.includeAverage){averagesData=self._calculateAverage(sortedRows,function(r){return self.weightedAveragesByRow[r.id]});seriesItem=self._buildTableSeriesItem(averagesData,options.averageSeriesName,"averageRating");series.push(seriesItem)}}distributionValues=isTop2Chart?self.benchmarkSummary.getContextDistributionValues():self.benchmarkSummary.getDistributionValues();data=self._summarizeBenchmarkRow(sortedRows,distributionValues);if(isNPS){self._customizeColors(data,SM.Highcharts.NPS_BENCHMARK_DISTRIBUTION_COLORS)}seriesItem=self._buildSeriesItem(data,{dimension:{text:self.benchmarkSummary.getSegmentName()},index:1,numSeries:2,template:"benchmark-matrix-table-percent-cell",name:self.benchmarkSummary.getSegmentName()});seriesItem.__options.sampleSize=Globalize.format(self.benchmarkSummary.getSampleSize(),"n0");series.push(seriesItem);return series},buildComparedBenchmarkMatrixSeries:function(options){var series=this.buildMirroredMatrixSeries(options),benchmarkSeries;options.ignoreUserdata=true;benchmarkSeries=this.buildBenchmarkMatrixSeries(options);_.each(benchmarkSeries[1].data,function(datum,index){series[index].data.push(datum)});return series},_dataForUnsummarizedDimension:function(numDatum){var self=this,data=[],datum;_.times(numDatum,function(){datum=self._buildSeriesItemDatum(null,0);data.push(datum)});return data},_summarizeDimension:function(dimensionalData,summary,summaryIterator,nullIterator,options){var dimensionSummary,data,summarizedData=[],key=options&&options.key?options.key:"options",isRandomAssignmentQuestion=this.question.hasRandomAssignment(),randomAssignmentOption=this.question.randomAssignmentOption;_.each(dimensionalData,function(dimension,index){if(summary&&summary[key]){dimensionSummary=summary[key][dimension.id];if(!dimensionSummary&&isRandomAssignmentQuestion){dimensionSummary=summary[key][randomAssignmentOption]}if(dimensionSummary||_.isNumber(dimensionSummary)){data=summaryIterator(dimensionSummary,index,dimension.id)}else{if(nullIterator){data=nullIterator(index,dimension.id)}else{data=[0,0]}}}else{if(nullIterator){data=nullIterator(index,dimension.id)}else{data=[0,0]}}summarizedData.push(data)});return summarizedData},_summarizeBenchmarkRow:function(dimensionSummary,benchmarkSummary){var summarizedData=[];if(_.isEmpty(benchmarkSummary)){_.each(dimensionSummary,function(){summarizedData.push({_options:{},absoluteY:0,name:null,percentageY:0,y:0})})}else{_.each(dimensionSummary,function(dimension){var benchmarkDatum=_.find(benchmarkSummary,function(benchmark){if(dimension.id===benchmark.option_ids[dimension.question_id]){return benchmark}});if(!benchmarkDatum){benchmarkDatum={count:0,percent:0}}summarizedData.push({_options:{},absoluteY:benchmarkDatum.count,name:null,percentageY:benchmarkDatum.percent*100,y:benchmarkDatum.percent*100})})}return summarizedData},_buildSeriesItemDatum:function(dimensionSummary,total,name,options){var self=this,valueKey,absoluteValue,percentageValue,isForNumericalChart;if(_.isNumber(dimensionSummary)){absoluteValue=dimensionSummary;percentageValue=null}else if(_.isEmpty(dimensionSummary)){absoluteValue=0;if(self.get("isBasicStats")||self.isBasicStats){percentageValue=null}else{percentageValue=0}}else{isForNumericalChart=self.questionSubType==="numerical"&&!self.isCompared;valueKey=isForNumericalChart?"average":"count";absoluteValue=dimensionSummary[valueKey];if(!isForNumericalChart){percentageValue=self._calculatePercentage(absoluteValue,total)}}return{y:self.scaleIsPercent?percentageValue:absoluteValue,absoluteY:absoluteValue,percentageY:percentageValue,name:name,__options:options}},_seriesDatumHasComments:function(row){var self=this;return self.isCompared&&row.is_openended&&!row.apply_all_rows},_buildCommentData:function(options){return{optionID:options.option.id,crossedOptionID:options.crossedOption.id,matrixCross:options.matrixCross,numComments:options.crossedOptionSummary.count||0,variationID:options.variationID}},_isMatrixCross:function(summary){return summary.crossed_cols?"1":"0"},_calculatePercentage:function(value,total){if(total===undefined||total===0||value===undefined){return 0}return value/total*100},_buildSeriesItem:function(data,options){var self=this,seriesItem,dimension,dimensionIndex,numSeries;seriesItem={name:null,data:data,__options:{}};if(!_.isEmpty(options)){dimension=options.dimension;if(dimension){seriesItem.name=dimension.text;seriesItem.__options.labelText=dimension.text;seriesItem.__options.labelHTML=dimension.mediaHTML;seriesItem.__options.dimensionType=self._getDimensionType(dimension);seriesItem.__options.dimensionID=dimension.id}if(options.name!==undefined){seriesItem.name=options.name}seriesItem.__options.hasCommentsPerRow=options.hasCommentsPerRow;seriesItem.__options.numComments=options.numComments;dimensionIndex=options.index;numSeries=options.numSeries;if(dimensionIndex!==undefined&&numSeries!==undefined){seriesItem.index=self._seriesIndex(dimensionIndex,numSeries);seriesItem.legendIndex=self._legendIndex(dimensionIndex,numSeries)}if(options.template){seriesItem.__options.template=options.template}if(options.hideLegendItem){seriesItem.__options.hideLegendItem=options.hideLegendItem}if(options.disableHover){seriesItem.states={hover:{enabled:false}}}if(options.sampleSize){seriesItem.__options.sampleSize=options.sampleSize}}seriesItem.__options.scaleType=self.scaleType;seriesItem.__options.decimalPlaces=self.decimalPlaces;seriesItem.__options.showDataLabels=self.displayData.show_data;seriesItem.__options.isLegend=self.displayData.isLegend;if(self.questionSubType==="net_promoter_score"&&self.nps_depth==="score"){seriesItem.__options.decimalPlaces=0}return seriesItem},_seriesIndex:function(i,numSeries){var self=this,reverseSortOrder=self.highchartsChartType==="column"&&!self.isStacked;return reverseSortOrder?i:numSeries-i},_legendIndex:function(i,numSeries){var reverseSortOrder=false;return reverseSortOrder?numSeries-i:i},_getDimensionType:function(dimension){if(dimension.type==="column_choice"){return"columnChoice"}return dimension.type},_buildTableSeriesItem:function(data,name,dimensionType){return{name:name,data:data,__options:{labelText:name,dimensionType:dimensionType}}},_calculateAverage:function(dimensionalData,iterator){var average,formattedAverage,averagesData;averagesData=_.map(dimensionalData,function(dimension,i){average=iterator(dimension,i);formattedAverage=Globalize.format(average,"n2");return{absoluteY:formattedAverage}});return averagesData}});SM.CompositeSummaryBuilder={buildCompositeSummary:function(id2CompositeMapping,isTop2){var self=this,rollup=self.summary,summary=rollup.summary;if(!id2CompositeMapping){if(isTop2){self.top2compositeSummary=null}else{self.compositeSummary=null}return}if(rollup.type==="compare"&&summary.type==="matrix"){self.buildCompositeSummaryComparedMatrix(rollup,id2CompositeMapping,isTop2)}else if(rollup.type==="matrix"){self.buildCompositeSummaryMatrix(rollup,id2CompositeMapping,isTop2)}else if(rollup.type==="simple"){self.buildCompositeSummarySimple(rollup,id2CompositeMapping,isTop2)}},buildCompositeSummarySimple:function(rollup,id2CompositeMapping,isTop2){var self=this,compositeOptions,options,compositeSummary;compositeSummary=SM.Object.deepCopy(rollup);options=rollup.summary.options;compositeOptions=self._buildCompositeOptions(options,id2CompositeMapping);compositeSummary.summary.options=compositeOptions;if(!self.question.isMultipleChoice()){compositeSummary.answered=self._calcAnswered(compositeOptions)}if(isTop2){self.top2compositeSummary=compositeSummary}else{self.compositeSummary=compositeSummary}},_calcAnswered:function(compositeOptions){var self=this,total=0;_.each(compositeOptions,function(outer_option,outer_id){if(_.isArray(outer_option)){return}if(outer_id==="other_option"){return}if(self.question.isOther(outer_id)&&!self.question.otherIsAnAnswerChoice()){return}if(outer_option.count){total+=outer_option.count}else if(outer_option.options){_.each(outer_option.options,function(inner_option){total+=inner_option.count})}});return total},_buildScoreByDistribution:function(options){var compositeOptions={Score:{count:0}},score,promoters=0,detractors=0,passives=0;_.each(options,function(summaryItem,id){if(id==="Detractors"){detractors=summaryItem.count}else if(id==="Promoters"){promoters=summaryItem.count}else{passives=summaryItem.count}});if(detractors+promoters+passives===0){score=0;compositeOptions.Score.noResponses=true}else{score=Math.round(100*(promoters-detractors)/(detractors+promoters+passives))}compositeOptions.Score.count=score;return compositeOptions},_buildCompositeOptions:function(options,id2CompositeMapping){var self=this,compositeOptions,summariesMapping,combinedSummary,compositeId;if(self.type==="score"){return self._buildScoreByDistribution(options)}summariesMapping={};_.each(options,function(summaryItem,id){if(id2CompositeMapping[id]===null){return}if(id==="other_option"){return}if(_.isUndefined(id2CompositeMapping[id])){summariesMapping[id]=[];summariesMapping[id].push(summaryItem)}else{compositeId=id2CompositeMapping[id].id;if(!summariesMapping[compositeId]){summariesMapping[compositeId]=[]}summariesMapping[compositeId].push(summaryItem)}});compositeOptions={};_.each(summariesMapping,function(summaryList,id){combinedSummary=self.combineSummaries(summaryList);compositeOptions[id]=combinedSummary});return compositeOptions},_calcColTotals:function(outer_options,cols,summary){var is_menu_matrix=false,totals={},col_totals=[];_.each(outer_options,function(outer_option,outer_id){if(!outer_option.options){return}if(outer_id==="other_option"){return}_.each(outer_option.options,function(inner_option,inner_id){if(inner_option.count){if(!totals[inner_id]){totals[inner_id]=0}totals[inner_id]+=inner_option.count}else if(inner_option.options){is_menu_matrix=true;_.each(inner_option.options,function(option,id){if(!totals[id]){totals[id]=0}totals[id]+=option.count})}})});_.each(cols,function(id){if(!totals[id]){totals[id]=0}col_totals.push(totals[id])});if(!is_menu_matrix){outer_options.col_totals=col_totals}if(summary){summary.answered_subtotals=totals}},_calcOptionStats:function(outer_option){var total=0,max=0;_.each(outer_option.options,function(inner_option){if(inner_option.count){total+=inner_option.count;max=Math.max(max,inner_option.count)}else if(inner_option.options){_.each(inner_option.options,function(option){total+=option.count})}});outer_option.row_max=max;outer_option.row_total=total;return total===0},buildCompositeSummaryMatrix:function(rollup,id2CompositeMapping,isTop2){var self=this,compositeOptions,inner_options,cols,compositeSummary=SM.Object.deepCopy(rollup),outer_options=rollup.summary.options,composite_outer_options=compositeSummary.summary.options;_.each(outer_options,function(outer_option,id){inner_options=outer_option.options;if(!inner_options){return}compositeOptions=self._buildCompositeOptions(inner_options,id2CompositeMapping);composite_outer_options[id].options=compositeOptions;if(self.question.isMultipleChoice()){composite_outer_options[id].row_total=outer_option.row_total;composite_outer_options[id].row_max=outer_option.row_max}else{self._calcOptionStats(composite_outer_options[id])}});cols=_.pluck(self.question.compositeAnswerStructure.cols,"id");self._calcColTotals(composite_outer_options,cols);if(!self.question.isMultipleChoice()){compositeSummary.answered=self._calcAnswered(composite_outer_options)}if(isTop2){self.top2compositeSummary=compositeSummary}else{self.compositeSummary=compositeSummary}},buildCompositeSummaryComparedMatrix:function(rollup,id2CompositeMapping,isTop2){var self=this,compositeOptions,options,compositeSummary;compositeSummary=SM.Object.deepCopy(rollup);options=rollup.summary.options;compositeOptions=self._buildCompositeOptions(options,id2CompositeMapping);if(options.other_option){compositeOptions.other_option=SM.Object.deepCopy(options.other_option)}self._calcColTotals(compositeOptions,compositeSummary.crossed_cols||compositeSummary.crossed_rows,compositeSummary.summary);compositeSummary.summary.options=compositeOptions;if(!self.question.isMultipleChoice()){compositeSummary.answered=self._calcAnswered(compositeOptions)}if(isTop2){self.top2compositeSummary=compositeSummary}else{self.compositeSummary=compositeSummary}},combineSummaries:function(summaryItems){var self=this,compositeSummary={};_.each(summaryItems,function(summaryItem){self.aggregate(compositeSummary,summaryItem)});return compositeSummary},aggregate:function(objDsc,objSrc){var self=this;_.each(objSrc,function(value,key){if(!_.has(objDsc,key)){if(_.isNumber(value)){objDsc[key]=value}else{objDsc[key]=SM.Object.deepCopy(value)}}else{if(_.isNumber(value)){objDsc[key]+=value}else{self.aggregate(objDsc[key],value)}}})}};SM.Models.register("QuestionDisplay",SM.Object.deepExtend(SM.Sortable,{DISPLAY_VALUES:{show:"show",hide:"hide",percent:"percent",absolute:"absolute",labels:"labels",legend:"legend",wtd_avg:"weighted_avg",distribution:"distribution",pie:"pie",donut:"donut",hbar:"hbar",vbar:"vbar",area:"area",line:"line",boxplot:"boxplot",top2_vbar:"top2_vbar",top2_hbar:"top2_hbar",top2_donut:"top2_donut",stacked:"stacked",stacked_hbar:"stacked_hbar",stacked_vbar:"stacked_vbar",nps_score:"score",nps_detailed:"detailed",nps_distribution:"distribution",score_hbar:"score_hbar",score_vbar:"score_vbar",score_gauge:"score_gauge",none:"none",menu_matrix:"menu_matrix",matrix:"matrix",mirror:"mirror",disabled:"disabled"},DISPLAY_OPTIONS:{chart_type:"chart_type",benchmark_chart_type:"benchmark_chart_type",driver_state:"driver_state",colors:"colors",stacking:"stacking",benchmark_stacking:"benchmark_stacking",scale_type:"scale_type",scale_min_absolute:"scale_min_absolute",scale_min_percentage:"scale_min_percentage",scale_min_stacked:"scale_min_stacked",scale_min_wtd_avg:"scale_min_wtd_avg",scale_max_absolute:"scale_max_absolute",scale_max_percentage:"scale_max_percentage",scale_max_stacked:"scale_max_stacked",scale_max_wtd_avg:"scale_max_wtd_avg",dp_absolute:"dp_absolute",dp_percentage:"dp_percentage",mirror:"mirror",matrix_display:"matrix_display",label_type:"label_type",labels:"labels",show_data:"show_data",show_chart:"show_chart",show_table:"show_table",show_basic_stats:"show_basic_stats",show_sig_diffs:"show_sig_diffs",show_empty_data:"show_empty_data",show_benchmark:"show_benchmark",sort_data:"sort_data",bs_sort_data:"bs_sort_data",nps_depth:"nps_depth"},SHARED_DISPLAY_OPTIONS:["chart_type","benchmark_chart_type","stacking","scale_type","matrix_display","label_type","colors","show_data","show_chart","show_table","show_basic_stats","show_sig_diffs","show_empty_data","dp_absolute","dp_percentage"],DEFAULT_CHART_TYPE:"hbar",DRIVER_DEFAULT_DISPLAY_OPTIONS:{tmbc:{shared:{show_table:"hide"},by_question_type:{"single_choice.vertical":{matrix_display:"weighted_avg"}},by_depth_type:{},by_compared:{}},std:{shared:{},by_question_type:{},by_depth_type:{},by_compared:{}}},DEFAULT_DISPLAY_OPTIONS:{shared:{chart_type:"hbar",benchmark_chart_type:"hbar",stacking:"none",matrix_display:"distribution",scale_type:"percent",show_chart:"show",show_table:"show",show_data:"hide",show_basic_stats:"hide",show_sig_diffs:"hide",show_empty_data:"show",dp_absolute:"0",dp_percentage:"2"},by_question_type:{"matrix.rating":{matrix_display:"weighted_avg"},"single_choice.net_promoter_score":{nps_depth:"score",chart_type:"score_gauge"},"single_choice.net_promoter_score.compared":{nps_depth:"score",chart_type:"score_hbar"},"matrix.ranking":{matrix_display:"weighted_avg"},"single_choice.vertical":{show_benchmark:"hide"}},by_depth_type:{single:{label_type:"labels"},matrix:{label_type:"legend"},menu_matrix:{label_type:"legend"}},by_compared:{"true":{mirror:"mirror"},"false":{mirror:"none"}}},METAKEY_TYPE_COMPARE:"compare:",UNTYPED_DISPLAY_OPTIONS:{show_chart:true,show_table:true,show_empty_data:true,show_basic_stats:true,show_sig_diffs:true,colors:true,dp_absolute:true,dp_percentage:true,labels:true,show_benchmark:true,driver_state:true,tmbc_chart_type:true},BENCHMARKABLE_CHART_TYPES:{hbar:true,vbar:true,top2_hbar:true,top2_vbar:true,top2_donut:true},TOP2_CHART_TYPES:{top2_hbar:true,top2_vbar:true,top2_donut:true},__create:function(options){var self=this;self.question=options.question;self.rollup=options.rollup;self.tempDisplay={};self.displayUpdates={}},_fetchMetadata:function(){var self=this,isCompareRollup=self.rollup.isCompare(),comparePrefix=this.METAKEY_TYPE_COMPARE,display=this.question.survey.anviews.defaultView.getDisplayData(this.question.ID),displayNew={};_.each(display,function(value,key){var isCompareKey=SM.String.beginsWith(key,comparePrefix),compareKey;if(!isCompareKey){if(isCompareRollup){compareKey=comparePrefix+key;if(self.UNTYPED_DISPLAY_OPTIONS[key]&&display[compareKey]===undefined){displayNew[key]=display[key]}}else if(!isCompareRollup){displayNew[key]=display[key]}}else{compareKey=key;if(isCompareRollup){key=compareKey.substr(comparePrefix.length);displayNew[key]=display[compareKey]}}});return displayNew},_updateMetadata:function(updates,options){var self=this,isCompared=options.noTypify?false:self.rollup.isCompare();self.question.survey.anviews.defaultView.updateDisplayData(self.question.ID,updates,{isCompared:isCompared,untypedKeys:self.UNTYPED_DISPLAY_OPTIONS,done:options.done,fail:options.fail})},getDisplayData:function(options){var self=this,question=self.question,survey=question.survey,questionType=question.family+"."+question.subtype,driverType=survey.getDriverType(),driverDefaults=self.DRIVER_DEFAULT_DISPLAY_OPTIONS[driverType],depthType=question.depthType(),isCompared=question.isCompared(),isComparedStr=isCompared.toString(),displayMetadata=self._fetchMetadata(),tableHasOneRow,hasScaleOptions,hasDepthOptions,correctMirrorValue,nps_backward_compatible_types,valueOfShow=self.DISPLAY_VALUES.show,display,isDonutChart,isPieChart,isLineChart,isAreaChart,isBoxplotChart,isDistribution,isStacked;options=options||{};if(self.question.isNPS()&&self.question.isCompared()){questionType+=".compared"}if(driverType==="tmbc"&&!question.is_tmbc){driverDefaults=self.DRIVER_DEFAULT_DISPLAY_OPTIONS.std}display=SM.Object.extend(self.DEFAULT_DISPLAY_OPTIONS.shared,driverDefaults.shared,self.DEFAULT_DISPLAY_OPTIONS.by_question_type[questionType],driverDefaults.by_question_type[questionType],self.DEFAULT_DISPLAY_OPTIONS.by_depth_type[depthType],driverDefaults.by_depth_type[depthType],self.DEFAULT_DISPLAY_OPTIONS.by_compared[isComparedStr],driverDefaults.by_compared[isComparedStr],displayMetadata,self.tempDisplay);if(question.isMatrix()&&display.matrix_display===self.DISPLAY_VALUES.wtd_avg){correctMirrorValue=self.question.isCompared()?self.DISPLAY_VALUES.mirror:self.DISPLAY_VALUES.none;if(display.mirror!==correctMirrorValue){self._updateMetadata({mirror:correctMirrorValue},{});display.mirror=correctMirrorValue}}display.depth_type=depthType;display.show_chart=display.show_chart===valueOfShow;display.show_table=display.show_table===valueOfShow;display.show_data=display.show_data===valueOfShow;display.show_empty_data=display.show_empty_data===valueOfShow;display.show_basic_stats=display.show_basic_stats===valueOfShow;display.show_sig_diffs=display.show_sig_diffs===valueOfShow&&question.isCompared();display.mirror=display.mirror===this.DISPLAY_VALUES.mirror;display.show_benchmark=question.isBenchmarkable()&&display.show_benchmark===valueOfShow&&!survey.shouldShowProfiler()&&survey.canShowBenchmarking();if(display.show_benchmark){if(!display.benchmark_chart_type){if(survey.isTMBCTemplate()){display.benchmark_chart_type=self.DISPLAY_VALUES.boxplot}else if(question.isTop2()){display.benchmark_chart_type=self.DISPLAY_VALUES.top2_vbar}}if(display.benchmark_chart_type in self.TOP2_CHART_TYPES&&!self.question.isTop2()){display.benchmark_chart_type=self.DISPLAY_VALUES.hbar}if(display.benchmark_chart_type===self.DISPLAY_VALUES.top2_donut&&self.question.isCompared()&&self.question.compareStructure.answers.cols.length!==1){display.benchmark_chart_type=self.DISPLAY_VALUES.top2_vbar}if(display.benchmark_chart_type){display.chart_type=display.benchmark_chart_type}if(display.benchmark_stacking){display.stacking=display.benchmark_stacking}if(display.chart_type!==self.DISPLAY_VALUES.boxplot){if(self.question.isNPS()&&self.question.isCompared()){display.chart_type=self.DISPLAY_VALUES.boxplot}else{display.depth_type="matrix"}}if(display.matrix_display===self.DISPLAY_VALUES.wtd_avg){display.matrix_display=self.DISPLAY_VALUES.distribution}display.show_sig_diffs=false}else{if(display.chart_type===self.DISPLAY_VALUES.boxplot){display.chart_type=self.DISPLAY_VALUES.hbar}}if(self._shouldSetDefaultSortData(display)){self._setDefaultSortData(display)}if(self.question.isNPS()){self._setDefaultSortData(display)}nps_backward_compatible_types=[self.DISPLAY_VALUES.pie,self.DISPLAY_VALUES.donut,self.DISPLAY_VALUES.line,self.DISPLAY_VALUES.area];if(self.question.isNPS()&&_.contains(nps_backward_compatible_types,display.chart_type)){display.chart_type=self.question.isCompared()?self.DISPLAY_VALUES.score_hbar:self.DISPLAY_VALUES.score_gauge}tableHasOneRow=self.tableHasOneRow(display);if(question.isMultiResponse()&&(self._isPieChart(display)||self._isDonutChart(display))){display.chart_type=self.DEFAULT_CHART_TYPE}if(self._isStacked(display)){display.stacking=self.DISPLAY_VALUES.stacked;if(self._isVerticalBarChart(display)){display.chart_type=self.DISPLAY_VALUES.stacked_vbar}else if(self._isHorizontalBarChart(display)){display.chart_type=self.DISPLAY_VALUES.stacked_hbar}}if(display.depth_type!==question.QTYPE.single){if(tableHasOneRow&&(self._isAreaChart(display)||self._isLineChart(display))){display.chart_type=self.DEFAULT_CHART_TYPE}if(!tableHasOneRow&&(self._isPieChart(display)||self._isDonutChart(display))){display.chart_type=self.DEFAULT_CHART_TYPE}}if(self._scaleIsPercent(display)&&(self._isStacked(display)||self._isAreaChart(display))&&self._tableRowsAddToMoreThan100Percent(display)){display.scale_type=this.DISPLAY_VALUES.absolute}if(self._isPieChart(display)||self._isDonutChart(display)){display.scale_type=this.DISPLAY_VALUES.percent;if(display.stacking===this.DISPLAY_VALUES.none){if(!tableHasOneRow&&!question.isSingleChoice()){display.matrix_display=this.DISPLAY_VALUES.wtd_avg}}}if(question.QTYPE.open_ended===question.family&&question.QTYPE.numerical===question.subtype){display.scale_type=this.DISPLAY_VALUES.absolute}if(display.depth_type===question.QTYPE.single){if(display.stacking===this.DISPLAY_VALUES.stacked){display.label_type=this.DISPLAY_VALUES.legend}else if(!self._isPieChart(display)&&!self._isDonutChart(display)){display.label_type=this.DISPLAY_VALUES.labels}display.mirror=false;if(!question.isSingleChoice()||question.isNPS()){display.matrix_display=this.DISPLAY_VALUES.distribution}}if(this.DISPLAY_VALUES.wtd_avg===display.matrix_display){display.scale_type=this.DISPLAY_VALUES.absolute;display.stacking=this.DISPLAY_VALUES.none}if(question.isSimple()){if(!self.rollup.options){display.hasShowEmptyOptions=true}else{_.each(question.getContextStructure().answers.rows,function(row){if(!self.rollup.options[row.id]){display.hasShowEmptyOptions=true}})}}else{display.show_empty_data=true;display.hasShowEmptyOptions=false}if(display.show_benchmark){if(display.chart_type!==self.DISPLAY_VALUES.boxplot){if(!(display.chart_type in self.BENCHMARKABLE_CHART_TYPES)){display.chart_type=self.DISPLAY_VALUES.vbar}if(this.question.isNPS()){display.chart_type=self.DISPLAY_VALUES.score_gauge}}display.isStacked=false;display.label_type=this.DISPLAY_VALUES.legend;if(display.chart_type in self.BENCHMARKABLE_CHART_TYPES){display.isPercent=true}display.show_empty_data=true;display.show_basic_stats=false}isDonutChart=self._isDonutChart(display);isPieChart=self._isPieChart(display);isLineChart=self._isLineChart(display);isAreaChart=self._isAreaChart(display);isBoxplotChart=self._isBoxplotChart(display);isDistribution=display.matrix_display===this.DISPLAY_VALUES.distribution;isStacked=self._isStacked(display)&&!display.show_benchmark;hasDepthOptions=!(isDonutChart||isPieChart||isBoxplotChart);hasScaleOptions=!(isDonutChart||isPieChart||isBoxplotChart)&&isDistribution;if((isStacked||isAreaChart)&&self._tableRowsAddToMoreThan100Percent(display)){hasScaleOptions=false}if(question.isMultipleChoice()&&(isStacked||isAreaChart)&&!display.mirror){hasDepthOptions=false}if(question.isSingleChoice()&&(isLineChart||isAreaChart)){hasDepthOptions=false}if(question.isMatrix()){if(isStacked){hasDepthOptions=false}}if(question.isMenuMatrix()){if(isStacked){hasDepthOptions=false}}display.isLegend=display.label_type===this.DISPLAY_VALUES.legend;display.isDistribution=display.matrix_display===this.DISPLAY_VALUES.distribution;display.isWeightedAvg=display.matrix_display!==this.DISPLAY_VALUES.distribution;display.isPercent=self._scaleIsPercent(display);display.isStacked=isStacked;display.isDonutChart=isDonutChart;display.isLineChart=isLineChart;
display.isPieChart=isPieChart;display.isAreaChart=isAreaChart;display.isBoxplotChart=isBoxplotChart;display.isLableable=isDonutChart||isPieChart;display.hasDepthOptions=hasDepthOptions;display.hasScaleOptions=hasScaleOptions;display.isMirrorable=this._isDisplayMirrorable(display);display.tableHasOneRow=tableHasOneRow;if(question.isNPS()){if(!_.contains([self.DISPLAY_VALUES.score_gauge,self.DISPLAY_VALUES.score_hbar,self.DISPLAY_VALUES.score_vbar],display.chart_type)&&display.nps_depth===self.DISPLAY_VALUES.nps_score){display.nps_depth=self.DISPLAY_VALUES.nps_distribution}if(display.show_benchmark&&display.nps_depth===self.DISPLAY_VALUES.nps_detailed){display.nps_depth=self.DISPLAY_VALUES.nps_distribution}hasDepthOptions=true;display.isDepthScore=display.nps_depth===self.DISPLAY_VALUES.nps_score;display.isDepthDistribution=display.nps_depth===self.DISPLAY_VALUES.nps_distribution;display.isDepthDetailed=display.nps_depth===self.DISPLAY_VALUES.nps_detailed;if(display.isDepthScore){display.isStacked=false;display.scale_type=self.DISPLAY_VALUES.absolute;display.isPercent=false}if(_.isUndefined(display.disable_show_data)){self.setNpsDisableShowDataSetting(display)}}if(question.hasRandomAssignment()){display.show_basic_stats=false}return display},getExportDisplayData:function(){var self=this,question=self.question,questionType=question.family+"."+question.subtype,depthType=question.depthType(),isCompared=question.isCompared(),displayMetadata=self._fetchMetadata(),display;display=SM.Object.extend(self.DEFAULT_DISPLAY_OPTIONS.shared,self.DEFAULT_DISPLAY_OPTIONS.by_question_type[questionType],self.DEFAULT_DISPLAY_OPTIONS.by_depth_type[depthType],self.DEFAULT_DISPLAY_OPTIONS.by_compared[isCompared.toString()],displayMetadata,self.tempDisplay);display.depth_type=depthType;display.show_chart=display.show_chart===this.DISPLAY_VALUES.show;display.show_table=display.show_table===this.DISPLAY_VALUES.show;display.show_data=display.show_data===this.DISPLAY_VALUES.show;display.show_empty_data=display.show_empty_data===this.DISPLAY_VALUES.show;display.show_basic_stats=display.show_basic_stats===this.DISPLAY_VALUES.show;display.mirror=display.mirror===this.DISPLAY_VALUES.mirror;display.show_sig_diffs=display.show_sig_diffs===this.DISPLAY_VALUES.show&&display.mirror&&question.isCompared();return display},updateDisplayData:function(updates,options){var self=this,displayData=self.getDisplayData();options=options||{};if(_.isUndefined(options.notify)){options.notify=true}if(updates.mirror){updates.sort_data=self._setDefaultSortData(displayData)}self._updateMetadata(updates,{done:options.done,fail:options.fail,noTypify:options.noTypify});if(options.notify){self._trigger({type:"displayChange"})}},getTempDisplay:function(){var self=this;return self.tempDisplay},setNpsUpdatesByDepthOption:function(updates){var self=this,oldChartType=self.getChartType();if(updates.nps_depth===self.DISPLAY_VALUES.nps_score){if(self.question.isCompared()){updates.chart_type=self.DISPLAY_VALUES.score_hbar}else{updates.chart_type=self.DISPLAY_VALUES.score_gauge}}else{if(_.contains([self.DISPLAY_VALUES.score_gauge,self.DISPLAY_VALUES.score_hbar,self.DISPLAY_VALUES.score_vbar],oldChartType)){updates.chart_type=self.DISPLAY_VALUES.stacked_hbar;updates.stacking=self.DISPLAY_VALUES.stacked}}self.setNpsDisableShowDataSetting(updates)},setNpsDisableShowDataSetting:function(updates){var self=this;if(updates.nps_depth===self.DISPLAY_VALUES.nps_score){updates.show_data=self.DISPLAY_VALUES.show;updates.disable_show_data=self.DISPLAY_VALUES.disabled}else if(updates.nps_depth===self.DISPLAY_VALUES.nps_distribution){updates.show_data=self.DISPLAY_VALUES.show;updates.disable_show_data=self.DISPLAY_VALUES.none}else{updates.show_data=self.DISPLAY_VALUES.hide;updates.disable_show_data=self.DISPLAY_VALUES.none}},updateTempDisplay:function(updates){var self=this,displayData=self.getDisplayData(),updateBS,updateSidi;updateBS=updates.show_basic_stats&&updates.show_basic_stats===self.DISPLAY_VALUES.show;updateSidi=updates.show_sig_diffs&&updates.show_sig_diffs===self.DISPLAY_VALUES.show;if(updateSidi&&!displayData.mirror){updates.mirror=this.DISPLAY_VALUES.mirror}if(updates.mirror){updates.sort_data=self._setDefaultSortData(displayData)}if(updates.chart_type){self.updateChartDisplayOptions(updates)}else if(updates.nps_depth){self.setNpsUpdatesByDepthOption(updates)}SM.Object.deepUpdate(self.tempDisplay,updates);if((updateBS||updateSidi)&&!self.question.getRollup().hasBasicStats()){self.question.getRollup().fetchStatsRollup()}else{self._trigger({type:"tempDisplayChange"})}},updateChartDisplayOptions:function(updates){var self=this;updates.disable_show_data=self.DISPLAY_VALUES.none;if(updates.chart_type===self.DISPLAY_VALUES.score_gauge){self.setNpsDisableShowDataSetting(updates)}},clearTempDisplay:function(options){var self=this;options=options||{};if(_.isUndefined(options.notify)){options.notify=true}self.tempDisplay={};if(options.notify){self._trigger({type:"tempDisplayChange"})}},getDisplayUpdates:function(){var self=this;return self.displayUpdates},setDisplayUpdates:function(updates){var self=this,displayUpdates=self.getDisplayUpdates();SM.Object.deepUpdate(displayUpdates,updates)},clearDisplayUpdates:function(){var self=this;self.displayUpdates={}},getSharedDisplayUpdates:function(){var self=this,display=self.getDisplayData(),displayUpdates=self.getDisplayUpdates(),chartTypeUpdates,sharedUpdates;if(self.question.isNPS()){sharedUpdates={show_chart:display.show_chart?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_table:display.show_table?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_basic_stats:display.show_basic_stats?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_sig_diffs:display.show_sig_diffs?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide};return sharedUpdates}sharedUpdates={colors:display.colors,show_chart:display.show_chart?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_table:display.show_table?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_data:display.show_data?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_basic_stats:display.show_basic_stats?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,show_sig_diffs:display.show_sig_diffs?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,scale_type:display.scale_type,dp_absolute:display.dp_absolute,dp_percentage:display.dp_percentage,stacking:display.stacking,show_empty_data:display.show_empty_data?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide,label_type:display.label_type,matrix_display:display.matrix_display};if(display.show_benchmark){sharedUpdates.benchmark_chart_type=display.benchmark_chart_type}else{sharedUpdates.chart_type=display.chart_type}if(displayUpdates.chart_type){chartTypeUpdates=self.getChartTypeUpdates(display.chart_type)}sharedUpdates=SM.Object.extend(sharedUpdates,displayUpdates,chartTypeUpdates);_.each(sharedUpdates,function(value,key){if(!_.contains(self.SHARED_DISPLAY_OPTIONS,key)){delete sharedUpdates[key]}});sharedUpdates.show_chart=display.show_chart?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide;return sharedUpdates},getChartType:function(){var self=this,display=self.getDisplayData(),chartType;chartType=display[self.DISPLAY_OPTIONS.chart_type]||self.DEFAULT_CHART_TYPE;return chartType},isTop2ChartType:function(){var self=this,display=self.getDisplayData(),chartType=display.benchmark_chart_type;return chartType===self.DISPLAY_VALUES.top2_hbar||chartType===self.DISPLAY_VALUES.top2_vbar||chartType===self.DISPLAY_VALUES.top2_donut},_getNpsChartTypeByDepth:function(nps_depth){var self=this,oldChartType=self.getChartType();if(nps_depth===self.DISPLAY_VALUES.nps_score){return self.DISPLAY_VALUES.score_gauge}if(_.contains([self.DISPLAY_VALUES.score_gauge,self.DISPLAY_VALUES.score_hbar,self.DISPLAY_VALUES.score_vbar],oldChartType)){return self.DISPLAY_VALUES.hbar}return oldChartType},getChartTypeUpdates:function(chartType,isBenchmarkChart){var self=this,displayUpdates={},stacking,scoreChartTypes,oldChartType;if(chartType===self.DISPLAY_VALUES.stacked_hbar||chartType===self.DISPLAY_VALUES.stacked_vbar){stacking=self.DISPLAY_VALUES.matrix}else{stacking=self.DISPLAY_VALUES.none}if(self.question.isNPS()){scoreChartTypes=[self.DISPLAY_VALUES.score_gauge,self.DISPLAY_VALUES.score_hbar,self.DISPLAY_VALUES.score_vbar];if(_.contains(scoreChartTypes,chartType)){displayUpdates.nps_depth=self.DISPLAY_VALUES.nps_score;displayUpdates.show_data="show"}else{oldChartType=self.getChartType();if(_.contains(scoreChartTypes,oldChartType)){displayUpdates.nps_depth=self.DISPLAY_VALUES.nps_distribution}}}if(isBenchmarkChart){displayUpdates[self.DISPLAY_OPTIONS.benchmark_chart_type]=chartType}else{displayUpdates[self.DISPLAY_OPTIONS.chart_type]=chartType}displayUpdates[self.DISPLAY_OPTIONS.stacking]=stacking;displayUpdates[self.DISPLAY_OPTIONS.show_chart]=self.DISPLAY_VALUES.show;return displayUpdates},setBenchmarkDisplay:function(on){var self=this,updates={show_benchmark:on?self.DISPLAY_VALUES.show:self.DISPLAY_VALUES.hide};self.updateDisplayData(updates,{notify:!on,noTypify:true})},getBenchmarkDisplay:function(){var displayData=this.getDisplayData();return displayData.show_benchmark},isTop2:function(){var displayData=this.getDisplayData();return displayData.chart_type===this.DISPLAY_VALUES.top2_vbar||displayData.chart_type===this.DISPLAY_VALUES.top2_hbar||displayData.chart_type===this.DISPLAY_VALUES.top2_donut},notifyBenchmarkDisplay:function(){this._trigger("displayChange")},getScaleMinOptionKey:function(){var self=this,displayData=self.getDisplayData(),key;var isReallyStacked=displayData.isStacked||displayData.isAreaChart&&!self.question.isSimple()&&!displayData.isWeightedAvg;if(displayData.isPercent){key=self.DISPLAY_OPTIONS.scale_min_percentage}else{if(isReallyStacked){key=self.DISPLAY_OPTIONS.scale_min_stacked}else if(displayData.isWeightedAvg){key=self.DISPLAY_OPTIONS.scale_min_wtd_avg}else{key=self.DISPLAY_OPTIONS.scale_min_absolute}}if(displayData.mirror){key=key+":"+self.DISPLAY_OPTIONS.mirror}return key},getScaleMaxOptionKey:function(){var self=this,displayData=self.getDisplayData(),key;var isReallyStacked=displayData.isStacked||displayData.isAreaChart&&!self.question.isSimple()&&!displayData.isWeightedAvg;if(displayData.isPercent){key=self.DISPLAY_OPTIONS.scale_max_percentage}else{if(isReallyStacked){key=self.DISPLAY_OPTIONS.scale_max_stacked}else if(displayData.isWeightedAvg){key=self.DISPLAY_OPTIONS.scale_max_wtd_avg}else{key=self.DISPLAY_OPTIONS.scale_max_absolute}}if(displayData.mirror){key=key+":"+self.DISPLAY_OPTIONS.mirror}return key},getCustomScale:function(dataRange,currentScale){var self=this,displayData=self.getDisplayData(),customScaleMinOptionKey=self.getScaleMinOptionKey(),customScaleMin=displayData[customScaleMinOptionKey],customScaleMaxOptionKey=self.getScaleMaxOptionKey(),customScaleMax=displayData[customScaleMaxOptionKey],min,max;if(_.isUndefined(customScaleMin)||customScaleMin>dataRange.min){min=currentScale?currentScale.min:dataRange.min}else{min=customScaleMin}if(_.isUndefined(customScaleMax)||customScaleMax<dataRange.max){max=currentScale?currentScale.max:dataRange.max}else{max=customScaleMax}return $.extend(currentScale||{},{min:min,max:max})},buildLabelUpdates:function(options){var self=this,currentLabelData=self.getDisplayData().labels,displayUpdates,labelType=options.labelType,answerID=options.answerID,labelText=options.labelText;displayUpdates={labels:currentLabelData||{}};if(_.isEmpty(displayUpdates.labels[labelType])){displayUpdates.labels[labelType]={}}if(labelType==="questionHeading"){displayUpdates.labels[labelType].text=labelText}else{displayUpdates.labels[labelType][answerID]={text:labelText}}return displayUpdates},labelUpdatesHaveEmptyLabel:function(){var self=this,labelUpdates=self.getTempDisplay().labels,updatedHaveEmptyLabels=false;if(labelUpdates){if(labelUpdates.questionHeading){if(labelUpdates.questionHeading.text===""){updatedHaveEmptyLabels=true}}_.each(["rows","columns","columnChoices","crossedOptions","others"],function(labelType){_.each(labelUpdates[labelType],function(labelData){if(labelData.text===""){updatedHaveEmptyLabels=true}})})}return updatedHaveEmptyLabels},getQuestionHeadingLabel:function(){return this.getLabel("questionHeading")},getLabel:function(labelType,optionID){var self=this,displayData=self.getDisplayData(),label;if(_.isEmpty(displayData.labels)||_.isEmpty(displayData.labels[labelType])){return}if(labelType==="questionHeading"){label=displayData.labels[labelType]}else{label=displayData.labels[labelType][optionID]}return label},_isDisplayMirrorable:function(display){if(display.isDonutChart||display.isPieChart||display.isBoxplotChart){return false}else if(display.isWeightedAvg&&(display.depth_type===this.DISPLAY_VALUES.matrix||display.depth_type===this.DISPLAY_VALUES.menu_matrix)){return false}return true},tableHasOneRow:function(display){var self=this,question=self.rollup.question,answers=question.getContextStructure().answers,rows=answers.rows,columns=answers.cols,tableHasOneRow=false;if(question.isMatrix()){if(question.isMenuMatrix()){if(display.mirror){tableHasOneRow=true;_.each(columns,function(c){if(c.items.length!==1){tableHasOneRow=false}})}else{tableHasOneRow=rows.length===1}}else{tableHasOneRow=display.mirror&&columns.length===1||!display.mirror&&rows.length===1}}else if(question.isSingleChoice()&&display.matrix_display!==this.DISPLAY_VALUES.distribution){tableHasOneRow=true}return tableHasOneRow},_tableRowsAddToMoreThan100Percent:function(display){var self=this,question=self.question,crossedQuestion,isCompared;if(question.ID==="quiz_summary"){return false}crossedQuestion=question.getCrossedQuestion();isCompared=!!crossedQuestion;if(display.mirror){if(question.family===question.QTYPE.multiple_choice){return true}}else{if(isCompared){if(crossedQuestion.isMultiResponse()){return true}}else{if(question.isMultipleChoice()){return true}}}return false},_scaleIsAbsolute:function(display){return display.scale_type===this.DISPLAY_VALUES.absolute},_scaleIsPercent:function(display){return display.scale_type===this.DISPLAY_VALUES.percent},_isStacked:function(display){return display.stacking!==this.DISPLAY_VALUES.none},_isVerticalBarChart:function(display){return display.chart_type===this.DISPLAY_VALUES.vbar},_isHorizontalBarChart:function(display){return display.chart_type===this.DISPLAY_VALUES.hbar},_isAreaChart:function(display){return display.chart_type===this.DISPLAY_VALUES.area},_isLineChart:function(display){return display.chart_type===this.DISPLAY_VALUES.line},_isPieChart:function(display){return display.chart_type===this.DISPLAY_VALUES.pie},_isDonutChart:function(display){return display.chart_type===this.DISPLAY_VALUES.donut},_isBoxplotChart:function(display){return display.chart_type===this.DISPLAY_VALUES.boxplot},sort:function(dimensionType,dimensionID,sortOrder,scopedDimensionType,scopedDimensionID,sortGroup){var self=this,key,currentSortData,updates={},sortDataUpdates,dimensionUpdates;if(sortGroup){key=this.DISPLAY_OPTIONS.bs_sort_data}else{key=this.DISPLAY_OPTIONS.sort_data}currentSortData=self.getDisplayData()[key];dimensionUpdates={dimensionType:dimensionType,dimensionID:dimensionID,order:sortOrder};if(scopedDimensionType){sortDataUpdates=SM.Object.deepCopy(currentSortData);sortDataUpdates[scopedDimensionID]=dimensionUpdates}else{sortDataUpdates=dimensionUpdates}updates[key]=sortDataUpdates;self.updateDisplayData(updates)},_updateDisplaySortData:function(sortData){var self=this,updates={};updates[self.DISPLAY_OPTIONS.sort_data]=sortData;self.updateDisplayData(updates)},_shouldSetDefaultSortData:function(display){var self=this,sortData=display.sort_data,question=self.question,isCompared=question.isCompared(),isMirrored=!!display.mirror,shouldSetDefaultSortData;shouldSetDefaultSortData=_.isEmpty(sortData)||self._sortDataAppliesToDifferentQuestion(question,sortData,isCompared,isMirrored);return shouldSetDefaultSortData},_sortDataAppliesToDifferentQuestion:function(question,sortData,isCompared,isMirrored){var summaryType=question.summaryType(),answers=question.getContextStructure().answers,crossedOptions=answers.crossedOptions,crossedOptionIDs,scopedSortData,dimensionID,isForDifferentQuestion=false;if(isCompared&&!isMirrored){crossedOptionIDs=_.map(crossedOptions,function(crossedOption){return crossedOption.id});if(summaryType==="menu_matrix"){scopedSortData=_.values(sortData);_.each(scopedSortData,function(data){dimensionID=data.dimensionID;if(dimensionID&&!_.contains(crossedOptionIDs,dimensionID)){isForDifferentQuestion=true}})}else{dimensionID=sortData.dimensionID;if(dimensionID&&!_.contains(crossedOptionIDs,dimensionID)){isForDifferentQuestion=true}}}return isForDifferentQuestion},_setDefaultSortData:function(display){var self=this,sortData=display.sort_data||{},question=self.question,summaryType=question.summaryType(),isCompared=question.isCompared(),rows=question.structure.answers.rows,columns=question.structure.answers.cols;if(summaryType==="menu_matrix"){if(isCompared){_.each(rows,function(row){sortData[row.id]={order:self.SORTING_ORDERS.UNSORTED,dimensionType:null,dimensionID:null}})}else{_.each(columns,function(column){sortData[column.id]={order:self.SORTING_ORDERS.UNSORTED,dimensionType:null,dimensionID:null}})}}else if(question.ID==="quiz_summary"){sortData={order:self.SORTING_ORDERS.ASCENDING,dimensionType:"rankings",dimensionID:question.ID}}else{sortData={order:self.SORTING_ORDERS.UNSORTED,dimensionType:null,dimensionID:null}}display.sort_data=sortData;return sortData},isBenchmarkShown:function(){var self=this,displayData=self.getDisplayData();return displayData[self.DISPLAY_OPTIONS.show_benchmark]}}));SM.Models.register("QuestionCombineHide",{__create:function(options){var self=this;self.question=options.question;self.hasTop2=options.question.isTop2();self.rollup=options.rollup},load:function(){var self=this;self._loadSettings();self._buildComposites()},_buildComposites:function(){var self=this,id2CompositeMapping,isEmpty=self._isSettingsEmpty();if(isEmpty||!self.question.canCombineHide()||!self._sanityCheckSettings()){self.question.buildCompositeAnswerStructure();self.rollup.buildCompositeSummary()}else{self.question.buildCompositeAnswerStructure(self.settings);id2CompositeMapping=self.question.buildCompositeMapping(self.settings);self.rollup.buildCompositeSummary(id2CompositeMapping)}if(self.hasTop2){self.question.buildCompositeAnswerStructure(self.top2settings,true);id2CompositeMapping=self.question.buildCompositeMapping(self.top2settings,true);self.rollup.buildCompositeSummary(id2CompositeMapping,true);self.benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.ID);if(self.benchmarkRollup){self.benchmarkRollup.buildCompositeSummary(self.top2settings,id2CompositeMapping,true)}}},_isSettingsEmpty:function(){var self=this;if(self.rollup.display.getBenchmarkDisplay()&&!self.question.isTop2()){return true}return _.size(self.settings.combines)===0&&_.size(self.settings.hides)===0},_sanityCheckSettings:function(){var self=this,structure=self.question.getContextStructure(),answerStructure=structure.answers,dim=self.question.getCombineHideDim(),rows=answerStructure[dim],row,isValid=true;_.each(self.settings.combines,function(combineObj){_.each(combineObj.combine,function(id){row=_.findWhere(rows,{id:id});if(_.isUndefined(row)){isValid=false}})});_.each(self.settings.hides,function(hideObj){row=_.findWhere(rows,{id:hideObj.id});if(_.isUndefined(row)){isValid=false}});return isValid},_fetchSettings:function(){var questionDisplayMeta;questionDisplayMeta=this.question.survey.anviews.defaultView.getDisplayData(this.question.ID,{forTrends:true});return questionDisplayMeta.combine_hide},_updateSettings:function(options){var self=this,settings=self.settings;options=options||{};self.question.survey.anviews.defaultView.updateDisplayData(this.question.ID,{combine_hide:settings});self.rollup.display._trigger({type:"displayChange"})},_loadSettings:function(){var self=this,emptySettings={combines:[],hides:[]},isValid,fetched;if(self.question.isTop2()){self.top2settings=self._createTop2Settings()}else{self.top2settings=emptySettings}if(!self.question.canCombineHide()){self.settings=emptySettings;return}fetched=self._fetchSettings();if(!fetched){self.settings=emptySettings;return}self.settings=fetched;isValid=self._sanityCheckSettings();if(!isValid){self.settings=emptySettings}return},_createTop2Settings:function(){var self=this,settings={combines:[],hides:[]},rows=self.question.structure.answers.rows,ctOptions=rows.length,top2options=[],otherOptions=[];_.each(rows,function(option){if(self.question.isTop2Ascending()){if(option.position===ctOptions||option.position===ctOptions-1){top2options.push(option)}else{otherOptions.push(option)}}else{if(option.position===1||option.position===2){top2options.push(option)}else{otherOptions.push(option)}}});settings.combines[0]={combine:_.map(top2options,function(option){return option.id}),id:top2options[0].id+"ch",title:Globalize.localize("Top 2 Box Score")};settings.hides=_.map(otherOptions,function(option){return{id:option.id}});return settings},addCombine:function(newCombine){var self=this,derivedCombineItems=[];_.each(newCombine.combine,function(combineItem){var existingCombine=_.findWhere(self.settings.combines,{id:combineItem});if(!_.isUndefined(existingCombine)){derivedCombineItems=derivedCombineItems.concat(existingCombine.combine);self.settings.combines=_.reject(self.settings.combines,function(combine){return combine.id===existingCombine.id})}else{derivedCombineItems.push(combineItem)}});derivedCombineItems=_.sortBy(derivedCombineItems,function(id){return id});self.settings.combines.push({title:newCombine.title,id:derivedCombineItems[0]+"ch",combine:derivedCombineItems});_.each(derivedCombineItems,function(combineItem){self.settings.hides=_.reject(self.settings.hides,function(hideObj){return combineItem===hideObj.id})});self._buildComposites();self._updateSettings();SM.Bi.answersCombine(self.question);return true},editCombine:function(oldCombineId,newCombine){var self=this;self.settings.combines=_.reject(self.settings.combines,function(combine){return combine.id===oldCombineId});self.addCombine(newCombine);self._buildComposites();self._updateSettings();SM.Bi.answersEditCombine(self.question);return true},unCombine:function(id){var self=this,existingCombine=_.findWhere(self.settings.combines,{id:id});if(_.isUndefined(existingCombine)){return false}self.settings.combines=_.reject(self.settings.combines,function(combine){return combine.id===id});self._buildComposites();self._updateSettings();SM.Bi.answersUncombine(self.question);return true},addHide:function(id){var self=this,existingCombine;existingCombine=_.findWhere(self.settings.combines,{id:id});if(_.isUndefined(existingCombine)){this.settings.hides.push({id:id})}else{self.settings.combines=_.reject(self.settings.combines,function(combine){return combine.id===id});_.each(existingCombine.combine,function(combineItem){self.settings.hides.push({id:combineItem})})}self._buildComposites();self._updateSettings();SM.Bi.answersHide(self.question);return true},unHideAll:function(){var self=this;self.settings.hides=[];self._buildComposites();self._updateSettings();SM.Bi.answersUnhideAll(self.question)},unHide:function(id){var self=this,existingHide;existingHide=_.findWhere(self.settings.hides,{id:id});if(!existingHide){return false}self.settings.hides=_.reject(self.settings.hides,function(hide){return hide.id===id});self._buildComposites();self._updateSettings();SM.Bi.answersUnhide(self.question);return true},getHides:function(){var self=this,hiddenComposites=self.question.hiddenComposites;return hiddenComposites},isCombined:function(id){var self=this,existingCombine=_.findWhere(self.settings.combines,{id:id});return!_.isUndefined(existingCombine)},canApplySort:function(id){var self=this;if(!self.question.canCombineHide()){return true}if(self.isContextAnswerOption(id)){return true}if(self.inCombine(id)||self.isHidden(id)){return false}if(id.indexOf("ch")!==-1){return false}return true},isContextAnswerOption:function(id){var self=this,composite,answerStructure=self.question.getContextAnswerStructure(),dim=self.question.getCombineHideDim();if(!dim){return false}composite=_.findWhere(answerStructure[dim],{id:id});return!!composite},inCombine:function(id){var self=this,composite,combinedComposites=self.question.combinedComposites;composite=_.findWhere(combinedComposites,{id:id});return!!composite},isHidden:function(id){var self=this,composite,hiddenComposites=self.question.hiddenComposites;composite=_.findWhere(hiddenComposites,{id:id});return!!composite},canCombineHide:function(id){var self=this,answerStructure,dim,composite;if(!self.question.canCombineHide()){return false}answerStructure=self.question.getContextAnswerStructure();dim=self.question.getCombineHideDim();if(!dim){return false}if(!self.getMenuVisibleOptions(id)){return false}composite=_.findWhere(answerStructure[dim],{id:id});return!!composite},getMenuVisibleOptions:function(id){var self=this,existingCombine;if(self.question.isQuiz()){return{combine:false,hide:false,editCombine:false,unCombine:false}}existingCombine=_.findWhere(self.settings.combines,{id:id});if(_.isUndefined(existingCombine)){if(self._isOnlyComposite()){if(self.question.otherIsAnAnswerChoice()){return{combine:false,hide:true,editCombine:false,unCombine:false}}return null}return{combine:true,hide:true,editCombine:false,unCombine:false}}return{combine:false,hide:!self._isSingleComposite(),editCombine:true,unCombine:true}},getActionMenuOption:function(id){var self=this;if(!self.canCombineHide(id)){return null}return{id:id,visibleOptions:self.getMenuVisibleOptions(id)}},getUnHidingStatus:function(){return _.size(this.settings.hides)},_isSingleComposite:function(){var self=this;return self._isOnlyComposite()&&!self.question.otherIsAnAnswerChoice()},_isOnlyComposite:function(){var self=this,answerStructure=self.question.getContextAnswerStructure(),dim=self.question.getCombineHideDim(),ids=_.pluck(answerStructure[dim],"id");return _.size(ids)===1},_getLabelTextById:function(id){var self=this,dim=self.question.getCombineHideDim(),display=self.rollup.display,labels=display.getDisplayData().labels;dim=dim==="cols"?"columns":dim;if(labels&&labels[dim]&&labels[dim][id]){return labels[dim][id].text}return null},_getCompositeLabel:function(composite){var self=this;return self._getLabelTextById(composite.id)||composite.text},_getCombinedAnswerTextsByIds:function(ids){var self=this,combinedComposites=self.question.combinedComposites,composite;return _.map(ids,function(id){composite=_.findWhere(combinedComposites,{id:id});return composite?self._getLabelTextById(composite.id)||composite.text:""})},getCompositeAnswerTextById:function(id){var self=this,answerStructure=self.question.getContextAnswerStructure(),dim=self.question.getCombineHideDim(),composite;composite=_.findWhere(answerStructure[dim],{id:id});return composite?self._getLabelTextById(composite.id)||composite.text:""},getCombinedDataInfo:function(answerID,isEditCombine){var self=this,answerStructure=self.question.getContextAnswerStructure(),dim=self.question.getCombineHideDim(),labelInfo=[],others;_.each(answerStructure[dim],function(composite){var text,isCombined,combineObj,combinedTexts;if(composite.id===answerID){if(!isEditCombine){labelInfo.push({id:composite.id,text:self._getCompositeLabel(composite),isCombined:false,disabled:false,checked:true})}}else{combineObj=_.findWhere(self.settings.combines,{id:composite.id});if(combineObj){combinedTexts=self._getCombinedAnswerTextsByIds(combineObj.combine);if(isEditCombine){text=composite.text+" ("+combinedTexts.join(", ")+")"}else{text=composite.text+" ("+_.size(combineObj.combine)+")"}isCombined=true}else{text=self._getCompositeLabel(composite);isCombined=false}labelInfo.push({id:composite.id,text:text,isCombined:isCombined,disabled:false,checked:false})}});if(isEditCombine){_.each(self.question.combinedComposites,function(composite){if(composite.combineId===answerID){labelInfo.push({id:composite.id,text:self._getCompositeLabel(composite),isCombined:false,disabled:false,checked:true})}})}_.each(self.question.hiddenComposites,function(composite){labelInfo.push({id:composite.id,text:self._getCompositeLabel(composite),isCombined:false,disabled:false,checked:false})});labelInfo=_.sortBy(labelInfo,function(info){return info.id});if(dim==="rows"){others=answerStructure.other;if(!_.isUndefined(others)&&!_.isUndefined(others[0].options.is_answer_choice)){labelInfo.push({id:others[0].id,text:others[0].text,isCombined:false,disabled:true,checked:false})}}return labelInfo}});SM.Models.register("QuestionRollup",SM.Object.deepExtend(SM.Sortable,SM.CompositeSummaryBuilder,{METAKEY_TYPE_COMPARE:"compare:",__create:function(options){var self=this;this.isLoaded=options.isLoaded;this.question=options.question;this.questionID=this.question.ID;self.display=SM.Models.create("QuestionDisplay",{rollup:self,question:self.question});self.combinehideModel=SM.Models.create("QuestionCombineHide",{rollup:self,question:self.question});this.summary={answered_subtotals:{},options:{}};this.answered="";this.skipped="";this.type="null_rollup";this.taModelMap={};this.filoModelMap={};this.nestedQuestionDict={}},getContextSummary:function(isTop2){return(isTop2?this.top2compositeSummary:this.compositeSummary)||this.summary},load:function(rollup){var self=this,compareRule=this.question.survey.anviews.currentView.compareRule,summary,taMap,otherOption,crossedQuestion,structure;if(self.question.isNPS()){rollup=SM.ComparedByNps.rollup(rollup)}summary=rollup.summary;if(rollup.type==="compare"&&this.question.isComparable()){crossedQuestion=this.question.survey.getQuestion(compareRule.get("questionID"));if(crossedQuestion.ID===self.question.ID){self.comparedByMyself=true}self.comparedByRA=compareRule.isRA;self.setComparedByNpsDistributed(compareRule);rollup=this._mungeCompareData(rollup,compareRule,crossedQuestion,self.isComparedByNpsDistributed());SM.SidiUtils.labelBySidi(rollup,crossedQuestion);if(summary.type==="menu_matrix"){rollup=this._mungeCompareMenuMatrixRollup(rollup,crossedQuestion);if(compareRule.ruleType==="random_assignment"){structure=this.question.mungeCompareMenuMatrixRA(rollup,crossedQuestion)}else{structure=this.question.mungeCompareMenuMatrix(rollup,crossedQuestion,self.isComparedByNpsDistributed())}}else{rollup=this._mungeCompareMatrixRollup(rollup,crossedQuestion,this.question.isNumerical());if(compareRule.ruleType==="random_assignment"){structure=this.question.mungeCompareMatrixRA(rollup,crossedQuestion)}else{structure=this.question.mungeCompareMatrix(rollup,crossedQuestion,self.isComparedByNpsDistributed())}}}this.question.setCompareStructure(structure);this.summary=rollup;this.answeredCount=rollup.answered;this.answered=Globalize.format(rollup.answered,"n0");this.answered_subtotals=rollup.summary.answered_subtotals;this.skipped=Globalize.format(rollup.skipped,"n0");this.type=rollup.type;this.otherOption=rollup.other_option;this.options=summary.options;if(summary.type==="matrix"||this.type==="matrix"){this.options.col_totals=this._buildColumnTotals()}if(this.question.commentField&&!this.question.commentField.options.is_answer_choice){if(rollup.other_option){this.options[this.question.commentField.id]={count:rollup.other_option}}else if(summary.type==="matrix"&&this.options.other_option){this.options[this.question.commentField.id]={count:this.options.other_option.row_total}}else if(summary.type==="menu_matrix"){otherOption=this.options.other_option;if(otherOption&&otherOption.options&&otherOption.options.other_option){this.options[this.question.commentField.id]=otherOption.options.other_option}}}taMap=summary.ta_data;if(taMap){_.each(taMap,function(obj){obj.flags=rollup.flags});this._loadTaModels(taMap)}this.combinehideModel.load();this._trigger({type:"loaded"})},hasBasicStats:function(){return SM.BasicStatsUtils.hasBasicStats(this.summary)},fetchStatsRollup:function(){var self=this,params,context={},request;
context.self=self;params={view_data:self.question.survey.anviews.currentView.dump(),questions:[self.question.ID],include_basic_stats:true};request=SM.API.fetchRollups(params);$.when(context,request).done(self._onFetchedStatsRollups).fail(function(){})},_onFetchedStatsRollups:function(context,doneArgs){var data=doneArgs[0],self=context.self,rollups=data.question_rollups,rollup=_.values(rollups)[0];self.load(rollup);self.display._trigger({type:"displayChange"})},getSidiData:function(answerId,crossOptionId,captionId){var summary=this.summary.summary,stats,options,sidiData;if(!captionId){stats=summary.stats}else{if(!summary.options[captionId]){return null}stats=summary.options[captionId].stats}if(!stats||!stats.sig_diffs){return null}options=stats.sig_diffs.options;if(options[answerId]&&options[answerId][crossOptionId]){sidiData=SM.Object.deepCopy(options[answerId][crossOptionId]);sidiData.p=stats.sig_diffs.p;sidiData.confidence_level=stats.sig_diffs.confidence_level;return sidiData}return null},updatePresentationRollup:function(summary,variable_id){var summaryRollup=summary[variable_id];if(summaryRollup){this.answered=summaryRollup.count}else{this.answered=0}},isSimple:function(){return this.type==="simple"},isCompare:function(){return this.type==="compare"},getRowData:function(rowId){var rowData=this._getRowData(rowId);if(!rowData){rowData={count:0,row_max:0,row_total:0}}return rowData},getColData:function(rowId,colId){var colOptions=this._getColData(rowId,colId);if(!colOptions){colOptions={count:0}}return colOptions},getChoiceData:function(rowId,colId,choiceId){var colOptions=this._getColData(rowId,colId);if(colOptions){colOptions=colOptions.options[choiceId]}if(!colOptions){colOptions={count:0}}return colOptions},getFileUploadModel:function(optionID,crossTabOptionID,matrixCrossTab,variationID){var modelID=this._makeTaModelID(optionID,crossTabOptionID,variationID),model=this.filoModelMap[modelID];if(!model){model=this.filoModelMap[modelID]=SM.Models.create("FileUploadList",{ID:modelID,rollup:this,matrixCrossTab:matrixCrossTab})}return model},getTaModel:function(optionID,crossTabOptionID,variationID){var modelID=this._makeTaModelID(optionID,crossTabOptionID,variationID);return this.taModelMap[modelID]},createTaModel:function(optionID,crossTabOptionID,matrixCrossTab,variationID){var modelID=this._makeTaModelID(optionID,crossTabOptionID,variationID),taModel;if(this.taModelMap[modelID]){return this.taModelMap[modelID]}taModel=SM.Models.create("TextAnalysis",{ID:modelID,matrixCrossTab:matrixCrossTab});if(variationID){taModel.variationID=variationID}taModel.rollup=this;this.taModelMap[modelID]=taModel;return taModel},hasTaModels:function(){return!$.isEmptyObject(this.taModelMap)},getDisplayMode:function(){var question=this.question,compareRule=question.survey.anviews.currentView.compareRule,compareRuleOn=compareRule&&compareRule.get("selected")&&!compareRule.get("isCorrupt");if(this.type==="compare"){return"compare"}if(compareRuleOn){if(this.type==="null_rollup"||question.isMenuMatrix()||this.type==="presentation_random_assignment"){return"compare"}}return"standard"},getSortedSummary:function(optionsNps){var self=this,display=self.display.getDisplayData(),options={question:self.question,labels:display.labels,isMirrored:display.mirror,shouldHideEmptyData:self.question.ID!=="quiz_summary"&&!display.show_empty_data},sortedSummary;if(optionsNps){options=_.extend(options,optionsNps)}sortedSummary=new SM.SortedSummary(options);return sortedSummary.summary},buildNpsSummary:function(){var self=this,npsSummary,distributionSummary,scoreSummary;distributionSummary=new SM.NPSSummary({rollup:self.summary,answerStructures:self.question.getContextAnswerStructure(),type:"distribution"});scoreSummary=new SM.NPSSummary({rollup:distributionSummary.compositeSummary,answerStructures:distributionSummary.compositeAnswerStructure,type:"score"});npsSummary={score:{summary:scoreSummary.compositeSummary,answerStructures:scoreSummary.compositeAnswerStructure},distribution:{summary:distributionSummary.compositeSummary,answerStructures:distributionSummary.compositeAnswerStructure},detailed:{summary:self.summary,answerStructures:self.question.getContextAnswerStructure()}};return npsSummary},_buildColumnTotals:function(){var question=this.question,structure=question.getContextStructure(),answerCounts=this.options,colStructs=structure.answers.cols,rowStructs=structure.answers.rows,colTotals=[];$.each(colStructs,function(i,col){colTotals.push(0);$.each(rowStructs,function(j,row){var rowId=row.id,colId=col.id;if(answerCounts[rowId]&&answerCounts[rowId].options&&answerCounts[rowId].options[colId]){colTotals[i]+=answerCounts[rowId].options[colId].count}})});return colTotals},_makeTaModelID:function(optionID,crossTabOptionID,variationID){var modelID;if(!optionID){optionID=0}if(!crossTabOptionID){crossTabOptionID=0}if(!variationID){variationID=0}modelID=["qid",this.questionID,"oid",optionID,"xid",crossTabOptionID,"vid",variationID].join("_");return modelID},_loadTaModels:function(taMap){var rollup=this,taModelMap={},taModel;this.taModelMap=taModelMap;$.each(taMap,function(taID,taData){taModel=SM.Models.create("TextAnalysis",{ID:taID});taModel.rollup=rollup;taModelMap[taID]=taModel;taModel.load(taData)})},_getRowData:function(rowId){return this.options[rowId]},_getColData:function(rowId,colId){var rowOptions=this._getRowData(rowId);if(rowOptions){rowOptions=rowOptions.options[colId]}return rowOptions},_mungeCompareData:function(rollup,compareRule,crossedQuestion,mergeNPS){var self=this,i=0,crossed_rows,row,answered=rollup.answered;if(compareRule.ruleType==="random_assignment"){rollup.crossed_rows=this._getRACrossedList(compareRule,crossedQuestion,"rows")}else{crossed_rows=this._getCrossedList(compareRule,crossedQuestion,"rows");rollup.crossed_rows=mergeNPS?SM.ComparedByNps.mergeCrossedRows(crossed_rows,crossedQuestion):crossed_rows}if(compareRule.ruleType==="random_assignment"){if(crossedQuestion.family==="matrix"){rollup.crossed_cols=this._getRACrossedList(compareRule,crossedQuestion,"cols")}}else{if(crossedQuestion.family==="matrix"){rollup.crossed_cols=this._getCrossedList(compareRule,crossedQuestion,"cols")}}rollup.type="compare";rollup.crossed_question_id=crossedQuestion.ID;if(!answered){answered={this_question:0,compare_options_total:{}};if(rollup.crossed_cols&&rollup.crossed_cols.length>0){row=rollup.crossed_rows[0];answered.compare_options_total[row]={};for(;i<rollup.crossed_cols.length;i++){answered.compare_options_total[row][rollup.crossed_cols[i]]=0}rollup.answered=answered;rollup.summary.answered_subtotals=rollup.answered.compare_options_total[row]}else{for(;i<rollup.crossed_rows.length;i++){answered.compare_options_total[rollup.crossed_rows[i]]=0}rollup.answered=answered;rollup.summary.answered_subtotals=rollup.answered.compare_options_total}}else{if(rollup.crossed_cols&&rollup.crossed_cols.length>0){row=rollup.crossed_rows[0];rollup.summary.answered_subtotals=rollup.answered.compare_options_total[row]}else{rollup.summary.answered_subtotals=self._processCompareOptionsTotal(rollup.answered.compare_options_total,crossedQuestion)}}rollup.answered=rollup.answered.this_question;rollup.summary.type=this.question.getCompareType();return rollup},_getCrossedList:function(compareRule,crossedQuestion,dimension){var allOptions=dimension==="rows"?crossedQuestion.rowList:crossedQuestion.colList,crossedOptions;if(crossedQuestion.family==="matrix"){crossedOptions=compareRule.choiceSetList[0][dimension]}else{crossedOptions=compareRule.choiceSet.get("rows")}return $.map(allOptions,function(option){if(option.id in crossedOptions){return option.id}})},_getRACrossedList:function(compareRule,crossedQuestion,dimension){var allOptions=crossedQuestion.randomAssignmentList,crossedOptions;if(crossedQuestion.family==="matrix"){if(dimension==="rows"){crossedOptions=compareRule.get("rows")}else{return $.map(allOptions,function(option){return option.id})}}else{crossedOptions=compareRule.get("rows")}return $.map(allOptions,function(option){if(option.variable_id in crossedOptions){return option.variable_id}})},_processCompareItem:function(compare,crossedQuestion){var self=this,options;if(!crossedQuestion.isNPS()){return compare}options=_.map(compare,function(val){return val});if(self.isComparedByNpsDistributed()){return SM.ComparedByNps.aggregate(options[0],crossedQuestion)}return options[0]},_processCompareOptionsTotal:function(compare,crossedQuestion){var self=this,options;if(!crossedQuestion.isNPS()){return compare}options=_.map(compare,function(val){return val});if(self.isComparedByNpsDistributed()){return SM.ComparedByNps.answered_subtotals(options[0],crossedQuestion)}return options[0]},_mungeCompareMenuMatrixRollup:function(rollup,crossedQuestion){var self=this,comment,summary=rollup.summary,outerOptions=summary.options,compareOptionsTotal,mmStats,otherOption,COMMENT_FIELD="-2";_.each(outerOptions,function(outerOption,outerOptionID){if(outerOptionID===COMMENT_FIELD){comment=outerOption}else{if(outerOption.row_total===undefined){outerOption.compare_options_total=-1;outerOption.row_total=-1}else{compareOptionsTotal=outerOption.row_total.compare_options_total;outerOption.compare_options_total=compareOptionsTotal===undefined?-1:compareOptionsTotal;outerOption.row_total=outerOption.row_total.current_row}_.each(outerOption.options,function(mmOption){var mmRowOptionID;mmOption.row_total=mmOption.row_total.current_row;mmOption.options=self._processCompareItem(mmOption.compare,crossedQuestion);if(rollup.crossed_cols&&rollup.crossed_cols.length){_.each(mmOption.options,function(opt,id){mmRowOptionID=id});mmOption.options=mmOption.options[mmRowOptionID]}delete mmOption.compare})}mmStats=outerOption.stats;if(mmStats){_.each(mmStats,function(mmStat){var mmRowOptionID;if(rollup.crossed_cols&&rollup.crossed_cols.length&&mmStat.compare){_.each(mmStat.compare,function(mm,id){mmRowOptionID=id});mmStat.compare=mmStat.compare[mmRowOptionID]}})}});if(comment){outerOptions.other_option=comment;delete outerOptions[COMMENT_FIELD];if(comment.options[COMMENT_FIELD]!==undefined){comment.other_option=comment.options[COMMENT_FIELD];delete comment.options[COMMENT_FIELD];otherOption=comment.other_option;if(otherOption.row_total!==undefined&&otherOption.row_total.current_row!==undefined){otherOption.row_total=otherOption.row_total.current_row;otherOption.options=otherOption.compare;delete otherOption.compare;comment.options.other_option=otherOption;delete comment.other_option}}}return rollup},setComparedByNpsDistributed:function(compareRule){this.is_nps_distributed=compareRule.is_nps_distributed},isComparedByNpsDistributed:function(){return this.is_nps_distributed},_mungeCompareMatrixRollup:function(rollup,crossedQuestion,isNumerical){var self=this,comment,summary=rollup.summary,outerOptions=summary.options,mmStats=summary.stats,COMMENT_FIELD="-2";_.each(outerOptions,function(outerOption){var innerOptionID;if(outerOption.options){comment=outerOption.options[COMMENT_FIELD]}else{outerOption.row_total=outerOption.row_total.current_row;outerOption.options=self._processCompareItem(outerOption.compare,crossedQuestion);if(rollup.crossed_cols&&rollup.crossed_cols.length){_.each(outerOption.options,function(opt,id){innerOptionID=id});outerOption.options=outerOption.options[innerOptionID]}delete outerOption.compare}});if(mmStats&&(rollup.crossed_cols&&rollup.crossed_cols.length)){if(!isNumerical){_.each(mmStats,function(mmStat){mmStat.compare=_.values(mmStat.compare)[0]})}else{_.each(mmStats,function(mmStat){_.each(mmStat,function(ms){ms.compare=_.values(ms.compare)[0]})})}}if(comment&&comment.row_total!==undefined&&comment.row_total.current_row!==undefined){comment.row_total=comment.row_total.current_row;comment.options=comment.compare;delete comment.compare;outerOptions.other_option=comment;delete outerOptions[COMMENT_FIELD]}return rollup}}));SM.Models.register("QuestionRollupList",{__create:function(){this.pages={};this.questions={};this.lastRollupsRequest=null;this.lastFetchFilteredStamp=-1;this.isLoading=false;this.failedLoad=false;this.failedLoadRequestID=null;this.isUpdating=false},loadSurvey:function(survey){var anviews=survey.anviews;this.survey=survey;anviews.on("selectedViewLoaded",{self:this},this._onSelectedViewLoaded);anviews.on("selectedViewChanged",{self:this},this._onSelectedViewChanged);anviews.on("selectedViewFailed",{self:this},this._onSelectedViewFailed);anviews.currentView.on("failedLoadRequestID.set",{self:this},this._onSelectedViewFailed);anviews.currentView.on("lastSwitchRequest.changed",{self:this},this._onSwitchRequestChanged);anviews.currentView.on("ruleDeleted",{self:this},this._onRuleDeleted);anviews.currentView.on("ruleAdded",{self:this},this._onRuleAdded);anviews.currentView.on("ruleEdited",{self:this},this._onRuleEdited);this.createRollupModels()},createRollupModels:function(){var self=this;_.each(self.survey.questions,function(questionModel,questionID){var pageID=questionModel.page.ID,rollupModel;if(!self.pages[pageID]){self.pages[pageID]={}}rollupModel=SM.Models.create("QuestionRollup",{question:questionModel});self.pages[pageID][questionID]=rollupModel;self.questions[questionID]=rollupModel})},clear:function(){this.pages={};this.questions={};_.each(this.survey.questions,function(questionModel){questionModel.compareStructure=undefined});this.createRollupModels()},loadRollups:function(rollups){var self=this,questionRollup,flags={};flags.nltkOptionEnabled=self.survey.nltkOptionEnabled;if(rollups){_.each(rollups,function(rollup,questionID){rollup.flags=flags;if(questionID==="quiz_summary"){if(self.survey.isQuiz){self.survey.quizSummaryModel=SM.Models.create("QuizSummary",{survey:self.survey,quizSummary:rollup})}}else{questionRollup=self.questions[questionID];if(questionRollup){if(questionRollup.question.hasRandomAssignment()){self._loadRandomAssignmentRollups(questionRollup,rollup)}else{questionRollup.load(rollup)}}}})}},_loadRandomAssignmentRollups:function(question,rollups){var randomAssignmentVars=question.question.randomAssignmentList,subDict=question.nestedQuestionDict,isPresentation=question.question.family==="presentation",questionCopy;_.each(randomAssignmentVars,function(randomAssignmentOption){var rollup=rollups[randomAssignmentOption.variable_id],variationRollup,optionsTotal;if(!!rollup){if(rollup.type==="compare"&&(question.question.isEssay()||question.question.isFileUpload())&&rollup.answered){variationRollup=rollup.summary.options[randomAssignmentOption.variable_id];if(variationRollup){optionsTotal=rollup.answered.compare_options_total;_.each(variationRollup.compare,function(row,rowId){_.each(row,function(col,colId){optionsTotal[rowId][colId]=col.count})});rollup.answered.this_question=variationRollup.row_total.current_row;rollup.summary.options[0]=rollup.summary.options[randomAssignmentOption.variable_id]}else{rollup.summary.options[0].row_total=0;_.each(rollup.summary.options[0].compare,function(row,rowId){rollup.summary.options[0].compare[rowId].count=0})}}rollup.flags=rollups.flags;question.load(rollup);if(isPresentation){question.updatePresentationRollup(rollup.summary,randomAssignmentOption.variable_id)}questionCopy=_.clone(question);subDict[randomAssignmentOption.variable_id]=questionCopy}else if(typeof rollups.answered!==undefined&&rollups.answered instanceof Object){rollup=rollups;question.load(rollup);if(isPresentation){question.updatePresentationRollup(rollup.summary,randomAssignmentOption.variable_id)}questionCopy=_.clone(question);subDict[randomAssignmentOption.variable_id]=questionCopy}})},fetchStatsRollups:function(){var self=this,params,context={},shownList=self.survey.shownQuestionList,questionIDs=[],request;self.set("isUpdating",true,{notify:true});context.self=self;_.each(shownList,function(question){if(question.hasRollupLoaded()){questionIDs.push(question.ID)}});params={view_data:self.survey.anviews.currentView.dump(),questions:questionIDs,include_basic_stats:true};request=SM.API.fetchRollups(params);$.when(context,request).done(self._onFetchedStatsRollups).fail(function(){self.set("isUpdating",false,{notify:true})})},_onFetchedStatsRollups:function(context,doneArgs){var data=doneArgs[0],self=context.self,rollups=data.question_rollups;self.loadRollups(rollups);self.onSharedDisplayDataChange()},onSharedDisplayDataChange:function(){var self=this,rollups=_.values(self.questions),timeoutLength=200;if(!self.get("isUpdating")){self.set("isUpdating",true,{notify:true})}self._clearTempDisplays();_.each(rollups,function(rollup,i){setTimeout(function(){rollup.display._trigger({type:"allDisplaysChange"});if(i===rollups.length-1){self.set("isUpdating",false,{notify:true})}},timeoutLength*i)})},_clearTempDisplays:function(){var self=this,rollups=self.questions;_.each(rollups,function(rollup){rollup.display.clearTempDisplay({notify:false})})},isBuffered:function(){var isBuffered=true,survey=this.survey,buffer=survey.config.question_buffer_page_load_size,shownList=survey.shownQuestionList,pageIndex=survey.state.get("page");if(pageIndex!=="all"){shownList=this.survey.pageList[pageIndex].shownQuestionList}$.each(shownList,function(i,question){if(!question.hasRollupLoaded()&&i<buffer){isBuffered=false;return false}else if(i>=buffer){return false}});return isBuffered},hasAll:function(){var survey=this.survey,hasAll=true,shownList=survey.shownQuestionList,pageIndex=survey.state.get("page");if(pageIndex!=="all"){shownList=survey.pageList[pageIndex].shownQuestionList}$.each(shownList,function(i,question){if(!question.hasRollupLoaded()){hasAll=false;return false}});return hasAll},isAfterLastLoadedPage:function(page){var lastQuestion=this._getLastLoadedQuestion(),lastPage;if(!lastQuestion){return false}lastPage=lastQuestion.page;return page.position>lastPage.position},isAfterLastLoadedQuestion:function(question){var lastQuestion=this._getLastLoadedQuestion();if(!lastQuestion){return false}return question.position>lastQuestion.position},_getLastLoadedQuestion:function(){var survey=this.survey,unloadedQuestion,shownList=survey.shownQuestionList,pageIndex=survey.state.get("page");if(pageIndex!=="all"){shownList=survey.pageList[pageIndex].shownQuestionList}$.each(shownList,function(i,question){if(!question.hasRollupLoaded()){unloadedQuestion=question;return false}});return unloadedQuestion},fetchMoreRollups:function(){var self=this,pageIndex=this.survey.state.get("page"),requestContext={self:this},startIndex=this._getNextUnloadedQuestionIndex(pageIndex);if(startIndex>=0){$.when(requestContext,this.lastRollupsRequest).always(function(){self._makeFetchMoreRequest(requestContext)})}},fetchFiltered:function(){var self=this,requestContext={self:this,timestamp:SM.Date.timestamp()};this.set("lastFetchFilteredStamp",requestContext.timestamp);$.when(requestContext,this.lastRollupsRequest).always(function(){self._makeFetchFilteredRequest(requestContext)})},_makeFetchMoreRequest:function(context){var self=context.self,params,pageIndex=self.survey.state.get("page"),startIndex=self._getNextUnloadedQuestionIndex(pageIndex),request;context.timestamp=SM.Date.timestamp();params={view_data:self.survey.anviews.currentView.dump(),questions:self._getQuestionIDBuffer(pageIndex,startIndex)};if(params.questions.length===0){return}request=SM.API.fetchRollups(params);$.when(context,request).done(self._onFetchedMoreRollups).fail(function(data){self._onFetchMoreRollupsFailed(context,data)})},_getQuestionIDBuffer:function(pageIndex,startIndex,ignoreLoaded){var shownList=this.survey.shownQuestionList,bufferSize=this.survey.config.question_buffer_fetch_size,buffer=[];if(pageIndex!=="all"){shownList=this.survey.pageList[pageIndex].shownQuestionList}shownList=shownList.slice(startIndex);$.each(shownList,function(i,questionModel){if(!questionModel.hasRollupLoaded()||ignoreLoaded){buffer.push(questionModel.ID)}else{return false}if(buffer.length===bufferSize){return false}});return buffer},_getNextUnloadedQuestionIndex:function(pageIndex){var shownList=this.survey.shownQuestionList,index=-1;if(pageIndex!=="all"){shownList=this.survey.pageList[pageIndex].shownQuestionList}$.each(shownList,function(i,question){if(!question.hasRollupLoaded()){index=i;return false}});return index},_makeFetchFilteredRequest:function(context){var self=context.self,pageIndex,params,includeStats;if(context.timestamp===self.get("lastFetchFilteredStamp")){pageIndex=self.survey.state.get("page");params={view_data:self.survey.anviews.currentView.dump(),questions:self._getQuestionIDBuffer(pageIndex,0,true),include_quiz_summary:self.survey.isQuiz};includeStats=self.survey.anviews.defaultView.appliedSidiAll();if(includeStats){params=_.extend(params,{include_basic_stats:true})}if(params.questions.length===0){return}self.set("failedLoad",false);self.set("failedLoadRequestID",null);self.set("isLoading",true,{notify:true});self.lastRollupsRequest=SM.API.fetchRollups(params);self.clear();$.when(context,self.lastRollupsRequest).done(self._onFetchFiltered).fail(function(data){self._onFetchFilteredFail(context,data)})}},_triggerRollupsLoaded:function(rollups){var lastLoadedPosition=-1,question,self=this;$.each(rollups,function(questionID){question=self.survey.getQuestion(questionID);if(question.position>lastLoadedPosition){lastLoadedPosition=question.position}question._trigger({type:"rollupLoaded"})});self.survey._trigger({type:"rollupsAppended",lastLoadedPosition:lastLoadedPosition})},_onFetchedMoreRollups:function(context,doneArgs){var data=doneArgs[0],self=context.self;if(context.timestamp>self.get("lastFetchFilteredStamp")){self.survey.set("respondentCounts",data.respondent_counts,{notify:true});self.loadRollups(data.question_rollups);self.survey.benchmarkRollups.loadRollups(data.benchmark_rollups);self._triggerRollupsLoaded(data.question_rollups)}},_onFetchMoreRollupsFailed:function(context){if(context.timestamp>this.get("lastFetchFilteredStamp")){this.survey._trigger({type:"fetchRollupsFailed"})}},_onFetchFiltered:function(context,doneArgs){var data=doneArgs[0],self=context.self;if(context.timestamp===self.get("lastFetchFilteredStamp")){self.survey.set("respondentCounts",data.respondent_counts,{notify:true});self.loadRollups(data.question_rollups);self.survey.benchmarkRollups.loadRollups(data.benchmark_rollups);self.survey.anviews.currentView.save();self.set("isLoading",false,{notify:true})}},_onFetchFilteredFail:function(context,errorData){var requestID=errorData&&errorData.request_id;if(context.timestamp===this.get("lastFetchFilteredStamp")){this.set("failedLoad",true);this.set("failedLoadRequestID",requestID);this.set("isLoading",false,{notify:true});this.survey.anviews.currentView.invalidateNewRules()}},_onSelectedViewChanged:function(e){var self=e.data.self,timestamp=self.survey.anviews.currentView.get("lastSwitchStamp");self.set("lastFetchFilteredStamp",timestamp);self.set("failedLoad",false);self.set("failedLoadRequestID",null);self.set("isLoading",true,{notify:true});self.clear()},_onSelectedViewLoaded:function(e){var self=e.data.self,respondentCountData=e.respondentData.respondent_counts,rollupData=e.respondentData.question_rollups;if(self.survey.anviews.currentView.get("lastSwitchStamp")===self.get("lastFetchFilteredStamp")){self.survey.set("respondentCounts",respondentCountData,{notify:true});self.loadRollups(rollupData);self.set("isLoading",false,{notify:true})}},_onSelectedViewFailed:function(e){var self=e.data.self;if(self.survey.anviews.currentView.get("lastSwitchStamp")===self.get("lastFetchFilteredStamp")){self.set("failedLoad",true);self.set("failedLoadRequestID",self.survey.anviews.currentView.get("failedLoadRequestID"));self.set("isLoading",false,{notify:true})}},_onSwitchRequestChanged:function(e){var self=e.data.self;self.lastRollupsRequest=e.value},_onRuleDeleted:function(e){var ruleModel=e.ruleModel,self=e.data.self;if(ruleModel.get("selected")&&!e.ruleModel.isShow){self.fetchFiltered()}},_onRuleEdited:function(e){var self=e.data.self;if(!e.ruleModel.isShow){self.fetchFiltered()}},_onRuleAdded:function(e){var self=e.data.self;if(!e.ruleModel.isShow&&e.ruleModel.get("selected")){self.fetchFiltered()}}});SM.Models.register("AppliedCategoriesSelection",{__create:function(options){this._state={};this.responseID=options.responseID},load:function(categories){this.categories=categories},reset:function(){this._state={}},update:function(categoryID,state){this._state[categoryID]=state;this._trigger({type:"selection.changed",isDirty:this.isDirty()})},dump:function(){var state={},currentState=this._state,responseID=this.responseID,uncategorizedID=this.categories.UNCATEGORIZED_ID,categoryMap=this.categories.map;$.each(categoryMap,function(categoryID,categoryModel){var saved,current;if(categoryID!==uncategorizedID){saved=categoryModel.getApplicationState(responseID);current=currentState[categoryID];if(current&&saved!==current){state[categoryID]=current}else{state[categoryID]=saved}}});return state},isDirty:function(){var state=this._state,responseID=this.responseID,categoryMap=this.categories.map,isDirty=false;$.each(state,function(categoryID,st){var savedState=categoryMap[categoryID].getApplicationState(responseID);if(savedState!==st){isDirty=true;return false}});return isDirty}});SM.Models.register("FilterCategoriesSelection",{__create:function(){this.reset()},loadSelection:function(){var categoryMap=this.categories.map,state,list;this.reset();state=this._state;list=this._list;$.each(categoryMap,function(categoryID,category){if(category.isFiltering()){state[categoryID]=true;list.push(categoryID)}else{state[categoryID]=false}})},reset:function(){this._state={};this._list=[]},isEmpty:function(){return this._list.length===0},update:function(categoryID,state){this._state[categoryID]=state;if(state){SM.Array.addUnique(this._list,categoryID)}else{SM.Array.removeItem(this._list,categoryID)}this._trigger({type:"selection.changed",isDirty:this.isDirty()})},clear:function(){var self=this;$.each(this.categories.map,function(categoryID){self._state[categoryID]=false});this._list=[];this._trigger({type:"selection.changed",isDirty:this.isDirty()})},isDirty:function(){var state=this._state,categoryMap=this.categories.map,isDirty=false;$.each(state,function(categoryID,st){var savedState=categoryMap[categoryID].isFiltering();if(savedState!==st){isDirty=true;return false}});return isDirty},apply:function(){this.categories.taModel.filterCategories(this._list)}});SM.Models.register("TextPhrase",{MAX_CATNAME_LEN:25,DEFAULT_WEIGHTED_AVERAGE:.5,ID_PREFIX:"phrase-",__create:function(){this.ID=this.ID_PREFIX+this.__uid},__getters:{localizedPercent:function(self){var filterCount=self.phrases.taModel.filterCount;return Globalize.formatPercent(self.responseCount/filterCount,2)},percent:function(self){var filterCount=self.phrases.taModel.filterCount;return SM.Math.toPercentString(self.responseCount/filterCount,2)},fontSize:function(self){var phrases=self.phrases,lowestSize=14,maxIncrease=32,wtdAvg;if(phrases.lowScore!==phrases.highScore){wtdAvg=(self.dscore-phrases.lowScore)/(phrases.highScore-phrases.lowScore)}else{wtdAvg=self.DEFAULT_WEIGHTED_AVERAGE}return lowestSize+maxIncrease*wtdAvg}},load:function(phrase){this.text=phrase.phrase;this.responseCount=phrase.count;this.score=phrase.score;this.dscore=phrase.dscore},hasManyResponses:function(){return this.responseCount>1}});SM.Models.register("TextPhraseList",{LINGO_MAX_COUNT:5e3,viewModes:{CLOUD:"cloud",LIST:"list",LINGO:"lingo",NLTK:"nltk"},__create:function(options){this.ID=options.ID;this.list=[];this.sortedList=[];this.map={};this.viewMode=this.viewModes.CLOUD},load:function(phrasesList){var self=this,lowScore=100,highScore=0;this.viewMode=this.viewModes.CLOUD;self.list=[];self.sortedList=[];self.map={};_.each(phrasesList,function(phrase,i){var phraseModel=SM.Models.create("TextPhrase");phraseModel.phrases=self;phraseModel.load(phrase);phraseModel.set("rank",i+1);lowScore=Math.min(phraseModel.dscore,lowScore);highScore=Math.max(phraseModel.dscore,highScore);self.list.push(phraseModel);self.map[phraseModel.ID]=phraseModel;self.sortedList.push(phraseModel)});this.highScore=highScore;this.lowScore=lowScore;this._sortListUneven()},isLanguageAvailable:function(language){return language!=="ja"&&language!=="zh"},isOverResponseLimit:function(){return this.taModel.filterCount>=this.LINGO_MAX_COUNT},_sortListByText:function(){this.sortedList.sort(function(a,b){a=a.text.toLowerCase();b=b.text.toLowerCase();if(a===b){return 0}return a<b?-1:1})},_sortListAsCurve:function(list){var sortedList=[];list=_.sortBy(list,function(a,b){return a.dscore>b.dscore?-1:1});_.each(list,function(obj,index){if(index%2===0){sortedList.push(obj)}else{sortedList.unshift(obj)}});return sortedList},_sortListUneven:function(){var sortableList=this.sortedList,descending,max,mid,firstHalf,secondHalf,resultList=[];sortableList.sort(function(a,b){return a.dscore>b.dscore?-1:1});descending=sortableList;max=descending.length;mid=descending.length/2;firstHalf=descending.slice(0,mid+1);secondHalf=descending.slice(mid+1,max);firstHalf=this._sortListAsCurve(firstHalf);secondHalf=this._sortListAsCurve(secondHalf);_.each(firstHalf,function(obj,i){resultList.push(firstHalf[i]);if(firstHalf.length===secondHalf.length){resultList.push(secondHalf[i])}else if(i<secondHalf.length){resultList.push(secondHalf[i])}});this.sortedList=resultList}});SM.Models.register("TextResponse",{__create:function(options){this.ID=options.ID},__setters:{categoryIDs:function(self,categoryIDs){var list,sortedCategories,map;self.categories={list:[],map:{}};self.categoryIDs=[];list=self.categories.list;map=self.categories.map;if(!self.responses.taModel.categories.failed){sortedCategories=self.responses.taModel.categories.sortedList;$.each(sortedCategories,function(i,categoryModel){$.each(categoryIDs,function(j,categoryID){categoryID=String(categoryID);if(categoryID===categoryModel.ID){map[categoryID]=categoryModel;list.push(categoryModel);self.categoryIDs.push(categoryID);return false}})});self.set("isInFilter",self._isInFilter(),{notify:true});if(!self.get("isInFilter")){self.responses.remove(self.ID)}}}},load:function(responseData){var taModel=this.responses.taModel,highlights=this.responses.highlights,pacificOffsetMilliseconds=288e5,utcMilliseconds=responseData.date-pacificOffsetMilliseconds,hasTextAnalysis=taModel.hasTextAnalysis(),currentBrowserTimezoneOffset;this.localizedDate=new Date(utcMilliseconds);if(_.isNumber(SM.TIMEZONE_OFFSET_SHIFT)){currentBrowserTimezoneOffset=SM.Date.stdTimezoneOffset()*6e4;this.localizedDate=new Date(utcMilliseconds+(currentBrowserTimezoneOffset-SM.TIMEZONE_OFFSET_SHIFT))}this.dateStr=Globalize.format(this.localizedDate,"d")+" "+Globalize.format(this.localizedDate,"t");this.content=responseData.content;this.date=responseData.date;this.number=responseData.number;this.respondentID=responseData.respondent_id;this.highlights=highlights&&highlights[this.respondentID];this.respondentUrl=taModel.rollup.question.survey.getRespondentUrl(this.respondentID);if(hasTextAnalysis&&this.highlights){this.text=this._highlight()}else{this.text=[{text:this.decodeHTMLEntities(SM.Html.removeExternalAttributes(responseData.content))}]}this.categories={map:{},list:[]};if(hasTextAnalysis){this.set("categoryIDs",responseData.tag_ids||[])}},decodeHTMLEntities:function(text){return $("<textarea/>").html(text).text()},isSelected:function(){var selection=this.responses.selection;if(selection.isNone()){return false}return selection.isAll()||selection.map[this.ID]&&!selection.selectUnloaded||!selection.unselectedMap[this.ID]&&selection.selectUnloaded},addCategoryID:function(categoryID){var categoryIDs=this.get("categoryIDs");categoryIDs=categoryIDs.concat([categoryID]);this.set("categoryIDs",categoryIDs,{notify:true})},removeCategory:function(categoryID){var categories=this.categories;delete categories.map[categoryID];SM.Array.removeItem(this.categoryIDs,categoryID);categories.list=$.map(categories.list,function(category){if(category.ID!==categoryID){return category}});this._trigger("category.removed")},applyCategories:function(selection,newCategory){var self=this,diff=[],categoriesMap=this.categories.map,allCategories=self.responses.taModel.categories.sortedList,categoryIDs;
if(selection){categoryIDs=$.map(allCategories,function(category){var state=selection[category.ID];if(state==="checked"||state==="indeterminate"&&categoriesMap[category.ID]){return category.ID}});diff=this._diffCategories(categoryIDs,this.categoryIDs);self.set("categoryIDs",categoryIDs,{notify:true})}if(newCategory&&newCategory.label){diff.push({action:"create",label:newCategory.label,color:newCategory.color})}return diff},save:function(diff){var params,self=this;if(diff.length){params=this.responses.taModel._makeParams();params.commands=diff;params.response_text_ids=[this.ID];SM.API.taTagAllText(params).done(function(response){var categoryModel;if(response.new_tags.length){categoryModel=SM.Models.create("TextCategory");categoryModel.categories=self.responses.taModel.categories;categoryModel.load(response.new_tags[0]);self.responses.taModel.categories.add(categoryModel);self.addCategoryID(categoryModel.ID)}self.responses.taModel.categories.updateCounts(response.tag_counts.tags)})}},_isInFilter:function(){var isInFilter,categories;if(this.responses&&this.responses.taModel&&this.responses.taModel.categories){categories=this.responses.taModel.categories;if(!categories.hasFilter()){return true}if(!this.categoryIDs.length){return categories.isInFilter(categories.UNCATEGORIZED_ID)}$.each(this.categoryIDs,function(i,categoryID){if(categories.isInFilter(categoryID)){isInFilter=true;return false}});return isInFilter}return true},_diffCategories:function(newIDs,currentIDs){var adds=[],deletes={};if(!newIDs.length){if(!currentIDs.length){return[]}return $.map(currentIDs,function(currentID){return{action:"remove",tag_id:currentID}})}_.each(newIDs,function(newID){var hasID=false;_.each(currentIDs,function(currentID){if(currentID===newID){hasID=true;deletes[currentID]=false}if(currentID!==newID&&deletes[currentID]===undefined){deletes[currentID]=true}});if(!hasID){adds.push({action:"add",tag_id:newID})}});deletes=$.map(deletes,function(isDelete,categoryID){if(isDelete){return{action:"remove",tag_id:categoryID}}});return adds.concat(deletes)},_highlight:function(){var response=this.content,endOfContent=response.length,highlighted=[],section,lastHighlightEnd=0;$.each(this.highlights,function(index,highlight){var start=highlight[0],end=highlight[1],length=end-start,gap=start-lastHighlightEnd;if(gap>0){section=response.substr(lastHighlightEnd,gap);highlighted.push({text:SM.Html.strip(section)})}section=response.substr(start,length);lastHighlightEnd=end;highlighted.push({text:SM.Html.strip(section),highlight:true})});if(lastHighlightEnd<endOfContent){section=response.substr(lastHighlightEnd);highlighted.push({text:SM.Html.strip(section)})}return highlighted}});SM.Models.register("TextResponseList",{TA_INVALID_OFFSET:0,MAX_SEARCH_STRING_LEN:60,__create:function(options){this.ID=options.ID;this.selection=SM.Models.create("ResponsesSelection",{ID:this.ID});this.selection.responses=this;this.map={};this.list=[];this.loadedCount=0;this.highlights={}},load:function(responseData){var owner=this.taModel.rollup.question.survey.owner,queryCount;this.map={};this.list=[];this.loadedCount=0;this.highlights={};this.removedCount=0;this.totalCount=responseData.question_response_count;queryCount=this.taModel.filterCount<responseData.count?this.taModel.filterCount:responseData.count;this.queryCount=owner.isOverResponseLimit(queryCount)?owner.responseLimit:queryCount;this._append(responseData);this.failed=false;this._trigger({type:"loaded"})},append:function(responseData){this._append(responseData);this._trigger({type:"appended",respondents:this.list.slice(this.loadedCount-responseData.response_texts.length)})},isEmpty:function(){return this.list.length===0},applyCategories:function(categoriesSelection,newCategory){var self=this,responseIDs=self.selection.selectedIDs(),diff,except=false,diffs=[];$.each(responseIDs,function(index,responseID){diffs=diffs.concat(self.map[responseID].applyCategories(categoriesSelection,newCategory))});diff=this._cleanDiffs(diffs);self.selection.clear();return{diff:diff,responseIDs:responseIDs,except:except}},remove:function(responseID){this.queryCount--;this.removedCount++;delete this.map[responseID];this.list=$.map(this.list,function(responseModel){if(responseModel.ID!==responseID){return responseModel}});this._trigger("responseRemoved")},save:function(diff,responseIDs,except){var request,params,isRemoving,self=this;function onDone(response){var categoryModel;if(response.new_tags.length){categoryModel=SM.Models.create("TextCategory");categoryModel.categories=self.taModel.categories;categoryModel.load(response.new_tags[0]);self.taModel.categories.add(categoryModel);$.each(responseIDs,function(i,responseID){self.map[responseID].addCategoryID(categoryModel.ID)})}self.taModel.categories.updateCounts(response.tag_counts.tags)}if(diff.length){isRemoving=this._isRemovingFilteredCategory(diff);if(isRemoving){this.taModel.set("isSearching",true,{notify:true})}params=this.taModel._makeParams();params.commands=diff;if(except){params.except_response_text_ids=responseIDs;request=SM.API.taTagExceptText(params)}else{params.response_text_ids=responseIDs;request=SM.API.taTagAllText(params)}request.done(onDone);if(isRemoving){request.done(function(){self.taModel.filterCategories(self.taModel.categories.filter.list)})}}},_cleanDiffs:function(diffs){var dict={};return $.map(diffs,function(diff){if(!dict[diff.action]){dict[diff.action]={};if(diff.action==="create"){return diff}}if(diff.action==="create"){return}if(!dict[diff.action][diff.tag_id]){dict[diff.action][diff.tag_id]=true;return diff}})},_append:function(responseData){var self=this;SM.Object.update(this.highlights,responseData.highlights);$.each(responseData.response_texts,function(i,response){var responseModel=SM.Models.create("TextResponse",{ID:response.response_text_id});responseModel.responses=self;self.loadedCount++;response.number=self.loadedCount;responseModel.load(response);self.map[response.response_text_id]=responseModel;self.list.push(responseModel)})},_isRemovingFilteredCategory:function(diffs){var isRemoving=false,filterMap=this.taModel.categories.filter.map;$.each(diffs,function(i,diff){if(diff.action==="remove"&&filterMap[diff.tag_id]){isRemoving=true;return false}});return isRemoving}});SM.Models.register("TextCategory",{MAX_CATNAME_LEN:25,__getters:{localizedPercent:function(self){var filterCount=self.categories.taModel.filterCount;return Globalize.formatPercent(self.responseCount/filterCount,2)},percent:function(self){var filterCount=self.categories.taModel.filterCount;return SM.Math.toPercentString(self.responseCount/filterCount,2)}},__validators:{name:function(self,val){var obj={isValid:true},trimmed=$.trim(val);trimmed=_.escape(trimmed);if(!trimmed){obj.isValid=false;obj.exception="empty"}if(trimmed.length>self.MAX_CATNAME_LEN){obj.isValid=false;obj.exception="maxlength"}if(self._isDuplicateName(val)){obj.isValid=false;obj.exception="duplicate"}return obj}},load:function(category){var label,color;if(category){try{label=decodeURIComponent(category.label);color=decodeURIComponent(category.color)}catch(e){label=category.label;color=category.color}this.name=SM.Html.strip(label);this.color=color;this.responseCount=category.response_text_count||0;this.ID=""+category.tag_id;this.isNew=false}else{this.responseCount=0;this.color="86A33B";this.name="";this.isNew=true}},getApplicationState:function(responseID){if(responseID){return this._getResponseApplication(responseID)}return this._getResponsesSelectedApplication()},_getResponsesSelectedApplication:function(){var categories=this.categories,responses=categories.taModel.responses,selection=responses.selection,self=this,filterResponseCount=this.categories.taModel.filterCount,count;if(this.responseCount===0){return"unchecked"}if(selection.isAll()){if(this.responseCount===filterResponseCount){return"checked"}return"indeterminate"}else if(selection.get("selectUnloaded")){count=0;$.each(selection.unselectedMap,function(responseID,unselected){if(unselected&&responses.map[responseID].categories.map[self.ID]){count++}});if(this.responseCount-count===selection.get("count")){return"checked"}if(this.responseCount-count===0){return"unchecked"}return"indeterminate"}count=0;$.each(selection.map,function(responseID,selected){if(selected&&responses.map[responseID].categories.map[self.ID]){count++}});if(selection.get("count")===count){return"checked"}if(count===0){return"unchecked"}return"indeterminate"},_getResponseApplication:function(responseID){var responseModel=this.categories.taModel.responses.map[responseID];return responseModel.categories.map[this.ID]?"checked":"unchecked"},isFiltering:function(){return!!this.categories.filter.map[this.ID]},_colorOptions:[{name:"dkgreen",hex:"86A33B"},{name:"turquoise",hex:"4BBFBF"},{name:"blue",hex:"426496"},{name:"red",hex:"C6332A"},{name:"orange",hex:"F8922F"},{name:"ltgreen",hex:"ABBF38"},{name:"gray",hex:"898A7A"},{name:"purple",hex:"68264D"},{name:"lavender",hex:"9999FF"}],_isDuplicateName:function(name){var categories=this.categories.list,self=this,isDuplicate=false;$.each(categories,function(i,category){if(category.ID!==self.ID&&category.name===name){isDuplicate=true;return false}});return isDuplicate},save:function(){var params,self=this;if(this.ID===this.categories.UNCATEGORIZED_ID){throw new Error("Cannot save uncategorized")}if(!this.isNew){throw new Error("Cannot save a category that is not new")}params=this.categories.taModel._makeParams();params.color=SM.Html.strip(this.color);params.label=SM.Html.strip(this.name);SM.API.taCreateTag(params).done(function(response){self.load(response);self.categories.add(self)})},edit:function(updates){var params;if(this.ID===this.categories.UNCATEGORIZED_ID){throw new Error("Cannot delete the uncategorized id")}params=this.categories.taModel._makeParams();params.tag_id=this.ID;params.color=updates.color?SM.Html.strip(updates.color):this.color;params.label=updates.name?SM.Html.strip(updates.name):this.name;this.name=params.label;this.color=params.color;SM.API.taEditTag(params);this.categories._trigger({type:"category.edited",category:this})},kill:function(){var params,uncategorizedModel;if(this.ID===this.categories.UNCATEGORIZED_ID){throw new Error("Cannot delete the uncategorized id")}params=this.categories.taModel._makeParams();params.tag_id=this.ID;uncategorizedModel=this.categories.map[this.categories.UNCATEGORIZED_ID];this.categories.remove(this);this.categories=null;SM.API.taDeleteTag(params).done(function(response){var tagCounts=response.tag_counts,uncategorized;if(tagCounts.status===200){uncategorized=tagCounts.tags[uncategorizedModel.ID];if(uncategorized){uncategorizedModel.set("responseCount",uncategorized.response_text_count,{notify:true})}}})}});SM.Models.register("TextCategoriesList",{__create:function(options){this.ID=options.ID;this.map={};this.sortedList=[];this.list=[];this.filter={list:[],map:{}}},UNCATEGORIZED_ID:"-1",load:function(categoryMap){this._buildStructures(categoryMap);this._ensureUncategorizedModel();this._sortListByName()},count:function(){return this.list.length?this.list.length-1:0},hasMany:function(){return this.count()>1},isEmpty:function(){return this.count()===0},hasFilter:function(){return this.filter.list.length>0},getFilterList:function(){var self=this;return $.map(this.filter.list,function(categoryID){return self.map[categoryID]})},isInFilter:function(categoryID){if(this.hasFilter()){return!!this.filter.map[categoryID]}return true},createModel:function(){var categoryModel=SM.Models.create("TextCategory");categoryModel.categories=this;categoryModel.load();return categoryModel},add:function(categoryModel){this._add(categoryModel);this._sortListByName();this.taModel._trigger({type:"category.added",category:categoryModel})},remove:function(categoryModel){this._remove(categoryModel);this.taModel._trigger({type:"category.deleted",category:categoryModel})},loadFilterSelection:function(filterSelection){this.filterSelection=filterSelection;this.filterSelection.categories=this},updateCounts:function(categoryData){var self=this;$.each(categoryData,function(categoryID,category){self.map[categoryID].set("responseCount",category.response_text_count,{notify:true})})},_remove:function(categoryModel){var self=this,categoryID=categoryModel.ID,clearedUnordered=false,clearedOrdered=false;delete this.map[categoryID];$.each(this.list,function(i,category){if(!clearedUnordered&&categoryID===category.ID){self.list.splice(i,1);clearedUnordered=true}if(!clearedOrdered){category=self.sortedList[i];if(categoryID===category.ID){self.sortedList.splice(i,1);clearedOrdered=true}}if(clearedOrdered&&clearedUnordered){return false}});if(this.filter.map[categoryID]){SM.Array.removeItem(this.filter.list,categoryID);this.taModel.filterCategories(this.filter.list)}$.each(this.taModel.responses.list,function(i,responseModel){if(responseModel.categories.map[categoryID]){responseModel.removeCategory(categoryID)}});if(!clearedOrdered&&!clearedUnordered){throw new Error("Category was not deleted properly: deleted ordered: "+clearedOrdered," clearedUnordered: "+clearedUnordered)}},_add:function(categoryModel){this.map[categoryModel.ID]=categoryModel;this.list.push(categoryModel);this.sortedList.push(categoryModel)},_buildStructures:function(categoryMap){var self=this;$.each(categoryMap,function(categoryID,category){var categoryModel=SM.Models.create("TextCategory");categoryModel.categories=self;categoryModel.load(category);self._add(categoryModel)})},_ensureUncategorizedModel:function(){var uncategorizedModel;if(!this.map[this.UNCATEGORIZED_ID]){uncategorizedModel=SM.Models.create("TextCategory");uncategorizedModel.load({label:Globalize.localize("Uncategorized"),color:"333333",tag_id:this.UNCATEGORIZED_ID});this.map[this.UNCATEGORIZED_ID]=uncategorizedModel;this.list.push(uncategorizedModel);this.sortedList.push(uncategorizedModel)}this.map[this.UNCATEGORIZED_ID].set("name",Globalize.localize("Uncategorized"));this.map[this.UNCATEGORIZED_ID].set("isUncategorized",true)},_sortListByName:function(){var uncategorized=Globalize.localize("Uncategorized").toLowerCase();this.sortedList.sort(function(a,b){a=a.name.toLowerCase();b=b.name.toLowerCase();if(a===uncategorized){return 1}if(b===uncategorized){return-1}if(a===b){return 0}return a<b?-1:1})}});SM.Models.register("ResponsesSelection",{__create:function(options){this.ID=options.ID;this.map={};this.unselectedMap={};this.count=0;this.selectUnloaded=false},isAll:function(){var selectionCount=this.count,queryCount=this.responses.queryCount;return selectionCount===queryCount&&selectionCount>0},isNone:function(){return this.count===0},isMany:function(){return this.count>1},add:function(id){var selectionCount=this.count;if(!this.selectUnloaded){this.map[id]=true}else{this.unselectedMap[id]=false}if(!this.isAll()){this.set("count",selectionCount+1,{notify:true})}},selectedIDs:function(){var self=this;if(this.selectUnloaded){return $.map(this.responses.list,function(responseModel){var unSelected=self.unselectedMap[responseModel.ID];if(!unSelected){return responseModel.ID}})}return $.map(this.map,function(isSelected,responseID){if(isSelected){return responseID}})},unselectedIDs:function(){var self=this;if(this.selectUnloaded){return $.map(this.unselectedMap,function(unSelected,responseID){if(unSelected){return responseID}})}return $.map(this.responses.list,function(responseModel){var isSelected=self.map[responseModel.ID];if(!isSelected){return responseModel.ID}})},remove:function(id){var selectionCount=this.count;if(!this.selectUnloaded){this.map[id]=false}else{this.unselectedMap[id]=true}if(!this.isNone()){this.set("count",selectionCount-1,{notify:true})}},clear:function(){this.map={};this.unselectedMap={};this.set("count",0,{notify:true});this.selectUnloaded=false},selectAll:function(){var responsesCount=this.responses.queryCount;this.unselectedMap={};this.map={};this.set("count",responsesCount,{notify:true});this.selectUnloaded=true}});SM.Models.register("TextAnalysis",{PAGE_SIZE:50,TA_SUCCESS:200,__create:function(options){var ids;this.ID=options.ID;ids=this.ID.split("_");this.optionID=ids[3];this.crossedOptionID=ids[5];this.matrixCrossTabID=options.matrixCrossTab||"0";this.variationID=ids[7];this.inProgress=false;this.responses=SM.Models.create("TextResponseList",{ID:this.ID});this.responses.taModel=this;this.categories=SM.Models.create("TextCategoriesList",{ID:this.ID});this.categories.taModel=this;this.phrases=SM.Models.create("TextPhraseList",{ID:this.ID});this.phrases.taModel=this},__getters:{questionID:function(self){return self.rollup.question.ID},survey:function(self){return self.rollup.question.survey}},__setters:{searchDraft:function(self,val){var searchDraft=$.trim(val);searchDraft=SM.String.htmlStrip(searchDraft);self.searchDraft=searchDraft}},__validators:{searchDraft:function(self,val){var searchDraft=$.trim(val);searchDraft=SM.String.htmlStrip(searchDraft);if(!searchDraft){return{isValid:false,exception:"empty"}}return{isValid:true}}},load:function(taData,loadType){this.enableAnalysis=taData.text_data.enable_analysis;this.lingoEnabled=this.enableAnalysis&&this.hasTextAnalysis();if(loadType!=="analysisTypeChange"){this._loadCategoryData(taData.tag_data)}this._loadResponseData(taData.text_data);this._loadAnalysisData(taData.analysis_data);this._hasLoaded=true;this.flags=taData.flags;this.inProgress=taData.inProgress;if(loadType!=="analysisTypeChange"){this._trigger("loaded")}},hasLoaded:function(){return this._hasLoaded},hasTextAnalysis:function(){return this.rollup.question.survey.hasTextAnalysis()},makeModelId:function(qid,oid,xid){return["qid",qid,"oid",oid,"xid",xid].join("_")},fetch:function(){var params=this._makeSearchParams(),self=this;params.offset=0;SM.API.taGetRollupQuestion(params).done(function(response){var taData=response[self.ID];taData.flags=self.rollup.summary.flags;self.load(taData)})},fetchMoreResponses:function(){var self=this,params=this._makeSearchParams(),request,searchTime;this._lastSearch=SM.Date.timestamp();searchTime=this._lastSearch;if(this.categories.hasFilter()){params.restrict_by_tag_ids=this.categories.filter.list}params.offset=this.responses.loadedCount;if(this.get("query")){params.search_phrase=this.get("query");request=SM.API.taGetRollupSearch(params)}else if(this.get("phrase")){params.phrase=this.get("phrase");request=SM.API.taGetRollupPhrase(params)}else{request=SM.API.taGetRollupQuestion(params)}request.done(function onDone(response){var taData=response[self.ID];if(self._lastSearch===searchTime){if(taData.text_data.status===self.TA_SUCCESS){self.responses.set("fetchFailErrorID",null);self.responses.append(taData.text_data)}else{self.responses.set("fetchFailErrorID",response.request_id);self.responses._trigger("fetchMoreResponses.failed")}}}).fail(function onFail(response){if(self._lastSearch===searchTime){self.responses.set("fetchFailErrorID",response.request_id);self.responses._trigger("fetchMoreResponses.failed")}});return request},fetchResponses:function(){var params=this._makeSearchParams(),request;params.offset=0;if(this.categories.hasFilter()){params.restrict_by_tag_ids=this.categories.filter.list}this._beforeResponseRequest();request=SM.API.taGetRollupQuestion(params);this._handleResponseRequest(request,this._lastSearch)},clearQuery:function(){var params=this._makeSearchParams(),request,self=this;params.offset=0;this.set("query","");this.set("phrase","");this.set("searchDraft","",{notify:true});this.categories.filter.list=[];this.categories.filter.map={};this._beforeResponseRequest();request=SM.API.taGetRollupQuestion(params);self._handleResponseRequest(request,this._lastSearch)},searchPhrase:function(phrase){var params=this._makeSearchParams(),request;params.offset=0;params.phrase=phrase;if(this.categories.hasFilter()){params.restrict_by_tag_ids=this.categories.filter.list}this.set("query","");this.set("phrase",phrase);this._beforeResponseRequest();request=SM.API.taGetRollupPhrase(params);this._handleResponseRequest(request,this._lastSearch)},searchQuery:function(query){var params=this._makeSearchParams(),request;params.offset=0;params.search_phrase=query;if(this.categories.hasFilter()){params.restrict_by_tag_ids=this.categories.filter.list}this.set("phrase","");this.set("query",query);this._beforeResponseRequest();request=SM.API.taGetRollupSearch(params);this._handleResponseRequest(request,this._lastSearch)},filterCategories:function(categoryIDs){var map;this.categories.filter.map={};this.categories.filter.list=categoryIDs;map=this.categories.filter.map;$.each(categoryIDs,function(index,categoryID){map[categoryID]=true});if(this.query){this.searchQuery(this.query)}else if(this.phrase){this.searchPhrase(this.phrase)}else{this.fetchResponses()}},_lastSearch:null,_loadResponseData:function(responseData){if(responseData.status===200){this.responses.load(responseData)}else{this.responses.set("failed",true)}},_loadCategoryData:function(categoryData){if(categoryData.status===200){this.categories.load(categoryData.tags)}else{this.categories.set("failed",true)}},_loadAnalysisData:function(analysisData){if(analysisData.status===200){this.phrases.set("failed",false);this.phrases.load(analysisData.text_analysis)}else{this.phrases.set("failed",true)}},_makeParams:function(){var survey=this.get("survey");return{question_id:this.get("questionID"),variation_id:this.get("variationID"),option_id:this.get("optionID"),crosstab_option_id:this.get("crossedOptionID"),matrix_crosstab:this.get("matrixCrossTabID"),view_data:survey.anviews.currentView.dump(),survey_id:survey.ID}},_makeSearchParams:function(){var params=this._makeParams();SM.Object.update(params,{language:this._getLanguageParam(),page_size:this.PAGE_SIZE,hide_ids:1,include_question_tags:1,include_question_response_count:1});return params},_getLanguageParam:function(){switch(Globalize.culture().name){case"en":return"english";case"nl":return"dutch";case"da":return"danish";case"fr":return"french";case"de":return"german";case"it":return"italian";case"no":return"norwegian";case"pt":return"portuguese";case"ru":return"russian";case"es":return"spanish";case"sv":return"swedish";default:return"not_supported"}},_handleResponseRequest:function(request,requestTime){var self=this;request.done(function(response){var taData=response[self.ID];if(self._lastSearch===requestTime){self.set("isSearching",false);if(taData.text_data.status===self.TA_SUCCESS){self.responses.load(taData.text_data)}else{if(self._lastSearch===requestTime){self.responses.set("failed",true,{notify:true})}}}}).fail(function(){self.set("isSearching",false);if(self._lastSearch===requestTime){self.responses.set("failed",true,{notify:true})}})},_beforeResponseRequest:function(){this.responses.selection.clear();this.responses.set("failed",false);this.set("isSearching",true,{notify:true});this._lastSearch=SM.Date.timestamp()}});SM.Models.register("FileUploadList",{PAGE_SIZE:50,FILO_SUCCESS:200,TA_INVALID_OFFSET:0,MAX_SEARCH_STRING_LEN:60,__create:function(options){var summaryOptions=options.rollup.summary.summary.options["0"],filoData=options.rollup.summary.summary.file_upload_data,responsesCount=0,ids,modelID;this.ID=options.ID;ids=this.ID.split("_");this.optionID=ids[3];this.crossedOptionID=ids[5];this.matrixCrossTabID=options.matrixCrossTab||"0";this.variationID=ids[7];if(summaryOptions){if(this.crossedOptionID!=="0"){responsesCount=summaryOptions.options[this.crossedOptionID].count;modelID=options.rollup._makeTaModelID(this.optionID,this.crossedOptionID,this.variationID);if(filoData[modelID]){filoData=filoData[modelID]}}else if(this.variationID!=="0"){responsesCount=summaryOptions.options[this.variationID].count}else{responsesCount=summaryOptions.count}}SM.Object.update(this,{ID:options.ID,responsesCount:responsesCount,queryCount:responsesCount,loadedCount:filoData.count,rollup:options.rollup,filoData:filoData,query:""})},__getters:{questionID:function(self){return self.rollup.question.ID},survey:function(self){return self.rollup.question.survey},filoData:function(self){return self.filoData},query:function(self){return self.query}},__setters:{searchDraft:function(self,val){var searchDraft=$.trim(val);searchDraft=SM.String.htmlStrip(searchDraft);self.searchDraft=searchDraft},query:function(self,val){self.query=val}},__validators:{searchDraft:function(self,val){var searchDraft=$.trim(val);searchDraft=SM.String.htmlStrip(searchDraft);if(!searchDraft){return{isValid:false,exception:"empty"}}return{isValid:true}}},load:function(response){var self=this;self.filoData=response.file_upload_data;self.loadedCount=self.filoData.files.length;self.queryCount=self.get("query")?self.loadedCount:self.responsesCount;self.failed=false;self._hasLoaded=true;self._trigger("loaded")},hasLoaded:function(){return this._hasLoaded},fetch:function(){var self=this,params=self._makeSearchParams();params.offset=0;SM.API.filoByQuestion(params).done(function(response){self.load(response)})},fetchMoreResponses:function(){var self=this,params=this._makeSearchParams(),request,searchTime=self._lastSearch=SM.Date.timestamp();params.offset=self.loadedCount;if(self.get("query")){params.search_phrase=self.get("query");request=SM.API.filoBySearch(params)}else{request=SM.API.filoByQuestion(params)}request.done(function onDone(response){if(self._lastSearch===searchTime){self.set("fetchFailErrorID",null);self.append(response.file_upload_data)}}).fail(function onFail(response){if(self._lastSearch===searchTime){self.set("fetchFailErrorID",response.request_id);self._trigger("fetchMoreResponses.failed")}});return request},clearQuery:function(){var self=this,params=self._makeSearchParams(),request;params.offset=0;self.set("query","");self._beforeResponseRequest();request=SM.API.filoByQuestion(params);self._handleResponseRequest(request,self._lastSearch)},searchQuery:function(query){var self=this,params=self._makeSearchParams(),request;params.offset=0;params.search_phrase=query;self.set("query",query);self._beforeResponseRequest();request=SM.API.filoBySearch(params);self._handleResponseRequest(request,self._lastSearch)},_lastSearch:null,_makeParams:function(){var survey=this.get("survey");return{question_id:this.get("questionID"),variation_id:this.get("variationID"),option_id:this.get("optionID"),crosstab_option_id:this.get("crossedOptionID"),matrix_crosstab:this.get("matrixCrossTabID"),view_data:survey.anviews.currentView.dump(),survey_id:survey.ID}},_makeSearchParams:function(){var params=this._makeParams();SM.Object.update(params,{language:"english",page_size:this.PAGE_SIZE,hide_ids:1,include_question_tags:1,include_question_response_count:1});return params},_beforeResponseRequest:function(){var self=this;self.selected=[];self.set("failed",false);self.set("isSearching",true,{notify:true});self._lastSearch=SM.Date.timestamp()},_handleResponseRequest:function(request,requestTime){var self=this;request.done(function(response){if(self._lastSearch!==requestTime){return}self.set("isSearching",false);self.load(response)}).fail(function(){self.set("isSearching",false);if(self._lastSearch===requestTime){self.set("failed",true,{notify:true})}})},append:function(data){var self=this,filoData=self.get("filoData");filoData.files=filoData.files.concat(data.files);self.loadedCount=filoData.files.length;self._trigger({type:"appended",respondents:data.files})},getFiloItem:function(respId){return _.find(this.get("filoData").files,function(file){return file.respondent_id===respId})},isEmpty:function(){return this.loadedCount===0},isFullyLoaded:function(){return this.get("query")||this.loadedCount===this.queryCount},preview:function(filoItem){this._trigger({type:"preview",filoItem:filoItem})}});SM.Models.register("QuestionBenchmarkRollup",{__create:function(options){this.rollupList=options.rollupList;this.question=options.question;this.questionID=this.question.ID;this.logicalID=this.question.logicalID;this.RESPONSE_MEAN_COLOR="#C55126";this.OUTLIER_COLOR="#F0F0F0";this._rollupData={error:"no_data"}},loadRollupData:function(newRollupData){var self=this,curRollupData=self._rollupData,questionRollup=self.question.getRollup();if(curRollupData.error==="none"&&curRollupData.distribution_values){if(newRollupData){_.each(newRollupData.distribution_values,function(value,index){_.each(value.option_ids,function(option_id,question_id){curRollupData.distribution_values[index].option_ids[question_id]=option_id})});_.each(newRollupData.response_means,function(mean,question_id){curRollupData.response_means[question_id]=mean})}}else{self._rollupData=curRollupData=newRollupData||{error:"no_data"};if(curRollupData.distribution_values){_.each(this.question.structure.answers.rows,function(row,index){var i=index+1;if(!_.has(curRollupData.distribution_values,i)){curRollupData.distribution_values[i]=0}})}}if(questionRollup&&questionRollup.combinehideModel){questionRollup.combinehideModel.load()}},getRollupData:function(){return this._rollupData},hasError:function(){if(this._rollupData){return this._rollupData.error!=="none"}return true},getResponseMean:function(questionId){var mean;if(this.hasError()){return 0}mean=this._rollupData.response_means[questionId]||0;return SM.Math.roundTo(mean,2,0)},getContextDistributionValues:function(){if(this._rollupData.compositeDistribution){return this._rollupData.compositeDistribution[this.questionID].distribution_values}return this._rollupData.distribution_values},getDistributionValues:function(){return this._rollupData.distribution_values},getNumResponses:function(){return this._rollupData.num_responses||0},DETRACTORS:-100,PASSIVES:0,PROMOTERS:100,getNpsDistributionValues:function(){var distributionValues=this.getDistributionValues()||{},detractorsValue=distributionValues[this.DETRACTORS],passivesValue=distributionValues[this.PASSIVES],promotersValue=distributionValues[this.PROMOTERS],detractorsPercent=Math.round((detractorsValue?detractorsValue.percent:0)*1e4)/100,passivesPercent=Math.round((passivesValue?passivesValue.percent:0)*1e4)/100,promotersPercent=Math.round((promotersValue?promotersValue.percent:0)*1e4)/100,detractorsCt=detractorsValue?detractorsValue.count:0,passivesCt=passivesValue?passivesValue.count:0,promotersCt=promotersValue?promotersValue.count:0;if(detractorsPercent+promotersPercent+passivesPercent!==0){passivesPercent=100-(detractorsPercent+promotersPercent)}return{Detractors:{percentage:detractorsPercent,responses:detractorsCt},Passives:{percentage:passivesPercent,responses:passivesCt},Promoters:{percentage:promotersPercent,responses:promotersCt}}},getNpsScore:function(){var values=this.getNpsDistributionValues();return Math.round(values.Promoters.percentage-values.Detractors.percentage)},calculateQuartile:function(score,isNPS){var quartileValues=this._rollupData.quartile_values,quartile={isNPS:isNPS};if(!quartileValues){return quartile}if(score<quartileValues["25"]){quartile.bottom=true}else if(score<quartileValues["50"]){quartile.lower=true}else if(score<quartileValues["75"]){quartile.upper=true}else{quartile.top=true}return quartile},getError:function(){if(this.rollupList.hasError()){return this.rollupList.getError()}return this._rollupData.error||"no_error"},getQuartileValues:function(){var quartileValues=this._rollupData.quartile_values,shortValues={};_.each(quartileValues,function(value,id){shortValues[id]=SM.Math.roundTo(value,2,0)});return shortValues},getQuartileValuesArray:function(){var quartileValues=this.getQuartileValues(),quartileArray=[quartileValues[0],quartileValues[25],quartileValues[50],quartileValues[75],quartileValues[100]];return quartileArray},getSampleSize:function(){return this._rollupData.num_data_points||0},getDateStart:function(){var currentSegment=this.question.survey.dataSegmentList.getSelectedSegment();if(currentSegment){return currentSegment.dateStart()}SM.API.logError("No current segment!");return 0},getDateEnd:function(){var currentSegment=this.question.survey.dataSegmentList.getSelectedSegment();if(currentSegment){return currentSegment.dateEnd()}SM.API.logError("No current segment!");return 0},getPercentileStart:function(){var currentSegment=this.question.survey.dataSegmentList.getSelectedSegment();
if(currentSegment){return currentSegment.percentilStart()}SM.API.logError("No current segment!");return 0},getPercentileEnd:function(){var currentSegment=this.question.survey.dataSegmentList.getSelectedSegment();if(currentSegment){return currentSegment.percentilEnd()}SM.API.logError("No current segment!");return 100},getSegmentName:function(){var currentSegment=this.question.survey.dataSegmentList.getSelectedSegment();if(currentSegment){return currentSegment.name()}SM.API.logError("No current segment!");return""},revertBenchmarkRollup:function(){this._trigger({type:"revertBenchmarkRollup"})},_onFetchBenchmarkRollup:function(context,doneArgs){var data=doneArgs[0],self=context.self,rollupData=data.benchmarks[self.logicalID];SM.log("fetchBenchmarkRollup returned data for question id "+self.questionID);self.loadRollupData(rollupData);SM.log("QuestionBenchmarkRollup._onFetchBenchmarkRollup succeeded: triggering benchmarkRollupLoaded");self.rollupList.set("isLoading",false,{notify:true});self.rollupList._trigger({type:"benchmarkRollupLoaded",questionID:self.questionID});self.rollupList.survey.dataSegmentList._trigger(SM.DataSegmentListModel.DATA_SEGMENT_SHOWN_CHANGED)},_onFetchBenchmarkRollupFailed:function(context,data){this.rollupList.set("isLoading",false,{notify:true});SM.log("fetchBenchmarkRollup failed: "+data)},fetchBenchmarkRollup:function(){var self=this,params={question_ids:[self.questionID],view_data:this.question.survey.anviews.defaultView.dump()},context={self:self};self.rollupList.set("isLoading",true,{notify:true});self.lastFetchRequest=SM.API.bmFetchBenchmarkRollups(params);$.when(context,self.lastFetchRequest).done(self._onFetchBenchmarkRollup).fail(function(data){self._onFetchBenchmarkRollupFailed(context,data)})},buildCompositeSummary:function(combineHide,id2CompositeMapping){var self=this,distribution=self._rollupData.distribution_values,num_responses=self._rollupData.num_responses,compositeDistribution=self._rollupData.compositeDistribution||{},questionComposite={idMap:id2CompositeMapping,distribution_values:[]},keys,question_id;if(_.isUndefined(distribution)){return}keys=_.map(self.question.rowList,function(row){return row.id});if(self.question.isTop2Ascending()){question_id=id2CompositeMapping[keys[keys.length-1]].question_id}else{question_id=id2CompositeMapping[keys[0]].question_id}if(question_id in compositeDistribution){return}_.each(combineHide.combines,function(combineItem,i){var optionIds={},combinedDistribution={},count=0,percent=0;optionIds[question_id]=combineItem.id;combinedDistribution.option_ids=optionIds;_.each(combineItem.combine,function(option_id){_.each(distribution,function(distValue){if(option_id===distValue.option_ids[question_id]){count+=distValue.count}})});combinedDistribution.count=count;if(num_responses!==0){percent=count/num_responses}combinedDistribution.percent=percent;questionComposite.distribution_values[i]=combinedDistribution});compositeDistribution[question_id]=questionComposite;self._rollupData.compositeDistribution=compositeDistribution}});SM.Models.register("QuestionBenchmarkRollups",{__create:function(options){this.survey=options.survey;this.pages={};this.questions={};this.logicalQuestions={};this.createRollupModels();this.survey.anviews.on("selectedViewLoaded",{self:this},this._onSelectedViewLoaded)},createRollupModels:function(){var self=this;_.each(self.survey.questions,function(questionModel,questionID){var pageID=questionModel.page.ID,rollupModel;if(!self.pages[pageID]){self.pages[pageID]={}}if(questionModel.isBenchmarkable()){rollupModel=SM.Models.create("QuestionBenchmarkRollup",{question:questionModel,rollupList:self});self.pages[pageID][questionID]=rollupModel;self.questions[questionID]=rollupModel;if(!(questionModel.logicalID in self.logicalQuestions)){self.logicalQuestions[questionModel.logicalID]={}}self.logicalQuestions[questionModel.logicalID][questionID]=rollupModel}})},reset:function(){SM.log("Removing all rollup models.");this.pages={};this.questions={};this.logicalQuestions={};this.createRollupModels()},isSameSegment:function(rollupA,rollupB){var nameA=rollupA.segment_name,nameB=rollupB.segment_name;if(this.survey.isTMBCTemplate()){if(nameA==="StandOut GEI Benchmark"){nameA="SurveyMonkey Global Benchmark"}if(nameB==="StandOut GEI Benchmark"){nameB="SurveyMonkey Global Benchmark"}}return nameA===nameB&&rollupA.percentile_start===rollupB.percentile_start&&rollupA.percentile_end===rollupB.percentile_end},loadRollups:function(rollups,reset){var self=this;if(reset){self.reset()}if(!self.rollups||!self.isSameSegment(self.rollups,rollups)){self.rollups=rollups}if(rollups){_.each(rollups.benchmarks,function(rollup,logicalID){if(!self.rollups.benchmarks[logicalID]){self.rollups.benchmarks[logicalID]=rollup}_.each(self.logicalQuestions[logicalID],function(benchmarkRollup){benchmarkRollup.loadRollupData(rollup)})});SM.log("triggering benchmarkRollupsReloaded");this._trigger({type:"benchmarkRollupsReloaded",rollups:this})}},getRollup:function(questionID){return this.questions[questionID]||null},getStructure:function(logicalId){return this.rollups.info?this.rollups.info[logicalId]||{}:{}},getDateStart:function(){if(this.rollups){return this.rollups.date_start}return 0},setDateStart:function(dateStart){if(this.rollups){this.rollups.date_start=dateStart}},getDateEnd:function(){if(this.rollups){return this.rollups.date_end}return 0},setDateEnd:function(dateEnd){if(this.rollups){this.rollups.date_end=dateEnd}},getPercentileStart:function(){if(this.rollups){return this.rollups.percentile_start}return 0},setPercentileStart:function(percentileStart){if(this.rollups){this.rollups.percentile_start=percentileStart}},getPercentileEnd:function(){if(this.rollups){return this.rollups.percentile_end}return 100},setPercentileEnd:function(percentileEnd){if(this.rollups){this.rollups.percentile_end=percentileEnd}},getSegmentName:function(){if(this.rollups){return this.rollups.segment_name}},setSegmentName:function(name){if(this.rollups){this.rollups.segment_name=name}},hasError:function(){if(this.rollups){return this.rollups.error&&this.rollups.error!=="none"}return true},getError:function(){if(this.rollups){return this.rollups.error}return"no_data"},getSegmentOverride:function(){if(this.rollups){return this.rollups.segment_override}},_onSelectedViewLoaded:function(e){var self=e.data.self,currentView=self.survey.anviews.currentView,questionRollups=self.survey.questionRollups;if(currentView.get("lastSwitchStamp")===questionRollups.get("lastFetchFilteredStamp")){self.reset();self.loadRollups(e.benchmarkData)}}});SM.Models.register("DriverBenchmarkRollup",{__create:function(options){this.driver=options.driver;this.rollupList=options.rollupList;this.rollupKey=options.rollupKey;this.rollupId=options.rollupId;this._rollupData={error:"no_data"}},loadRollupData:function(newRollupData){this._rollupData=newRollupData},getRollupData:function(){return this._rollupData},getRollupId:function(){return this.rollupId},getRollupKey:function(){return this.rollupKey},hasError:function(){if(this._rollupData){return this._rollupData.error!=="none"}return true},getError:function(){if(this.rollupList.hasError()){return this.rollupList.getError()}return this._rollupData.error||"no_error"},getValue:function(){return this._rollupData.value||0},getRawQuartileValues:function(){return this._rollupData.quartile_values},getQuartileValues:function(){var quartileValues=this.getRawQuartileValues(),shortValues={};_.each(quartileValues,function(value,id){shortValues[id]=SM.Math.roundTo(value,2,0)});return shortValues},getQuartileValuesArray:function(){var quartileValues=this.getQuartileValues(),quartileArray=[quartileValues[0],quartileValues[25],quartileValues[50],quartileValues[75],quartileValues[100]];return quartileArray},getSampleSize:function(){return this._rollupData.sample_size||0},getDateStart:function(){return this.date_start||1412188765},getDateEnd:function(){return this.date_end||1443638365},getSegmentName:function(){var currentSegment=this.rollupList.survey.dataSegmentList.getSelectedSegment();if(currentSegment){return currentSegment.name()}SM.API.logError("No current segment!");return""}});SM.Models.register("DriverBenchmarkRollups",{__create:function(options){this.survey=options.survey;this.drivers={};this.driversById={};this.createRollupModels()},createRollupModels:function(){var self=this;_.each(self.survey.driverState.drivers,function(driverModel){var idMap=driverModel.getIdMap();_.each(idMap,function(rollupKey,rollupId){var rollupModel=SM.Models.create("DriverBenchmarkRollup",{driver:driverModel,rollupKey:rollupKey,rollupId:rollupId,rollupList:self});self.drivers[rollupKey]=rollupModel;self.driversById[rollupId]=rollupModel})})},reset:function(){SM.log("Removing all rollup models.");this.drivers={};this.createRollupModels()},loadRollups:function(rollups){var self=this;self.rollups=rollups;if(rollups){if(rollups.error&&rollups.error!=="none"){SM.API.logWarning({message:"Driver benchmark rollups error "+rollups.error})}_.each(rollups.driver_benchmarks,function(rollup,rollupId){if(self.driversById[rollupId]){self.driversById[rollupId].loadRollupData(rollup)}else{SM.API.logError({message:"Loading driver rollup for driver id "+rollupId+", but no driver available"})}});if(self.survey.isTMBCTemplate()){rollups.segment_name=self.survey.dataSegmentList.getSelectedSegment().name()}}},getRollup:function(rollupKey){return this.drivers[rollupKey]||null},getSegmentName:function(){if(this.rollups){return this.rollups.segment_name}},setSegmentName:function(name){if(this.rollups){this.rollups.segment_name=name}},hasError:function(){if(this.rollups){return this.rollups.error&&this.rollups.error!=="none"}return true},getError:function(){if(this.rollups){return this.rollups.error}return"no_data"},_onSelectedViewLoaded:function(e){var self=e.data.self,currentView=self.survey.anviews.currentView,questionRollups=self.survey.questionRollups;if(currentView.get("lastSwitchStamp")===questionRollups.get("lastFetchFilteredStamp")){self.reset();self.loadRollups(e.benchmarkData)}},_onNewSegmentAdded:function(e){var self=e.data.self,benchmarkData=e.benchmarkData;self.reset();self.loadRollups(benchmarkData)}});SM.Models.register("DriverState",{drivers:{},DRIVER_ID_MAP:{},DRIVER_KEY_MAP:{},__create:function(options){this.survey=options.survey;this._driverState=options.driverState},registerDriverModel:function(model){var self=this,idMap=model.getIdMap();if(model.DRIVER_KEY in this.drivers){throw new Error("Model "+model.DRIVER_KEY+" is already registered!")}this.drivers[model.DRIVER_KEY]=model;_.each(idMap,function(id,key){self.DRIVER_ID_MAP[id]=key;self.DRIVER_KEY_MAP[key]=id})},getDriverModel:function(modelKey){return this.drivers[modelKey]},getDriverKey:function(id){return this.DRIVER_ID_MAP[id]},getDriverId:function(key){return this.DRIVER_KEY_MAP[key]},getAllDriverState:function(){return this._driverState||{}},setAllDriverState:function(driverState,options){this._driverState=driverState;this.survey.anviews.defaultView.setDriverState(driverState,options)},getDriverState:function(driverKey){var driverState=this.getAllDriverState();return driverState[driverKey]||{}},setDriverState:function(driverKey,driverState,options){var allDriverState=this.getAllDriverState();allDriverState[driverKey]=driverState;this.setAllDriverState(allDriverState,options)},hasError:function(){if(this._driverState){return this._driverState.error&&this._driverState.error!=="none"}return true},getError:function(){if(this._driverState){return this._driverState.error}return"no_data"}});SM.DriverModel={__create:function(options){if(!this.DRIVER_KEY){throw new Error("Missing Driver Key")}this.survey=options.survey},getIdMap:function(){return{}},initData:function(data){var idMap=this.getIdMap(),canonicalData={};if(data){_.each(idMap,function(key,id){var hasScore;canonicalData[key]=data[id];if(!_.isUndefined(canonicalData[key])&&_.isUndefined(canonicalData[key].value)){hasScore=!_.isUndefined(canonicalData[key].score);canonicalData[key].value=hasScore?canonicalData[key].score:0}})}return canonicalData}};SM.Models.extend("TMBC",SM.DriverModel,{DRIVER_KEY:"tmbc",TMBC_ID_MAP:{},TMBC_TYPE_GEI:"tmbc_gei",TMBC_TYPE_ENGAGEMENT:"tmbc_engagement",TMBC_TYPE_ALL:"all",TMBC_ID_GEI:1,TMBC_ID_ENGAGEMENT:2,TMBC_MIN_RESPONSES:3,TMBC_DEFAULT_NAME:"StandOut GEI Benchmark",TMBC_GRADES:[{limit:93.42,grade:"A++",key:"App"},{limit:88.04,grade:"A+",key:"Ap"},{limit:84.08,grade:"A",key:"A"},{limit:80.84,grade:"A-",key:"Am"},{limit:77.92,grade:"A--",key:"Amm"},{limit:75.78,grade:"B++",key:"Bpp"},{limit:73.49,grade:"B+",key:"Bp"},{limit:70.96,grade:"B",key:"B"},{limit:68.17,grade:"B-",key:"Bm"},{limit:64.82,grade:"B--",key:"Bmm"},{limit:60.8,grade:"C++",key:"Cpp"},{limit:56.77,grade:"C+",key:"Cp"},{limit:51.76,grade:"C",key:"C"},{limit:42.232,grade:"C-",key:"Cm"},{limit:0,grade:"C--",key:"Cmm"}],__create:function(options){SM.DriverModel.__create.call(this,options);this.TMBC_ID_MAP[this.TMBC_ID_GEI]=this.TMBC_TYPE_GEI;this.TMBC_ID_MAP[this.TMBC_ID_ENGAGEMENT]=this.TMBC_TYPE_ENGAGEMENT;this.survey.driverState.registerDriverModel(this);if(options.tmbcData.status===0){this._tmbcData=this.initData(options.tmbcData.data)}else{this._tmbcData=options.tmbcData;SM.API.logError(options.tmbcData)}this._wasEdited=options.wasEdited},getIdMap:function(){return this.TMBC_ID_MAP},getTMBCDriverState:function(tmbcType){var tmbcDriverState=this.survey.driverState.getDriverState(this.DRIVER_KEY);if(tmbcType===this.TMBC_TYPE_ALL){if(!tmbcDriverState[this.TMBC_TYPE_GEI]){tmbcDriverState[this.TMBC_TYPE_GEI]={}}if(!tmbcDriverState[this.TMBC_TYPE_ENGAGEMENT]){tmbcDriverState[this.TMBC_TYPE_ENGAGEMENT]={}}return tmbcDriverState}if(!tmbcDriverState[tmbcType]){tmbcDriverState[tmbcType]={}}return tmbcDriverState[tmbcType]},setTMBCDriverState:function(tmbcType,driverState,options){var tmbcDriverState=this.survey.driverState.getDriverState(this.DRIVER_KEY);if(tmbcType===this.TMBC_TYPE_ALL){tmbcDriverState=driverState}else{tmbcDriverState[tmbcType]=driverState}this.survey.driverState.setDriverState(this.DRIVER_KEY,tmbcDriverState,options)},setTMBCShowHide:function(tmbcType,show){var showState=show?SM.QuestionDisplayModel.DISPLAY_VALUES.show:SM.QuestionDisplayModel.DISPLAY_VALUES.hide,tmbcDriverState=this.getTMBCDriverState(tmbcType);if(tmbcType===this.TMBC_TYPE_ALL){tmbcDriverState[this.TMBC_TYPE_GEI].show_benchmark=showState;tmbcDriverState[this.TMBC_TYPE_ENGAGEMENT].show_benchmark=showState}else{tmbcDriverState.show_benchmark=showState}this.setTMBCDriverState(tmbcType,tmbcDriverState)},getTMBCShowHide:function(tmbcType){var tmbcDriverState=this.getTMBCDriverState(tmbcType);return tmbcDriverState.show_benchmark!==SM.QuestionDisplayModel.DISPLAY_VALUES.hide},setTMBCChartType:function(tmbcType,chartType){var tmbcDriverState=this.getTMBCDriverState(tmbcType);tmbcDriverState.chart_type=chartType;this.setTMBCDriverState(tmbcType,tmbcDriverState)},getTMBCChartType:function(tmbcType){var tmbcDriverState=this.getTMBCDriverState(tmbcType);return tmbcDriverState.chart_type||SM.QuestionDisplayModel.DISPLAY_VALUES.donut},getDateStart:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType);if(rollup){return rollup.getDateStart()}return""},getDateEnd:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType);if(rollup){return rollup.getDateEnd()}return""},getTMBCValue:function(tmbcType){return this._tmbcData[tmbcType].value},getTMBCBenchmarkValue:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType);if(rollup){return rollup.getValue()}return 0},getQuartileValues:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType),quartileValues,shortValues={};if(rollup){quartileValues=rollup.getQuartileValues();_.each(quartileValues,function(value,id){shortValues[id]=SM.Math.roundTo(value,2,0)})}return shortValues},getQuartileValuesArray:function(tmbcType){var quartileValues=this.getQuartileValues(tmbcType);return[quartileValues[0],quartileValues[25],quartileValues[50],quartileValues[75],quartileValues[100]]},calculateQuartile:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType),quartileValues=rollup.getRawQuartileValues(),tmbcValue=this.getTMBCValue(tmbcType);if(!quartileValues){return{}}if(tmbcValue<=quartileValues["25"]){return{bottom:true}}if(tmbcValue<=quartileValues["50"]){return{lower:true}}if(tmbcValue<=quartileValues["75"]){return{upper:true}}return{top:true}},getSampleSize:function(tmbcType){var rollup=this.survey.driverRollups.getRollup(tmbcType);if(rollup){return rollup.getSampleSize()}return 0},getSegmentName:function(){return this.survey.driverRollups.getSegmentName()},getTMBCName:function(tmbcType){if(tmbcType===this.TMBC_TYPE_GEI){return"Your GEI"}else if(tmbcType===this.TMBC_TYPE_ENGAGEMENT){return"Your % Fully Engaged"}return""},getGrade:function(score){var i;for(i=0;i<this.TMBC_GRADES.length;i++){if(score>=this.TMBC_GRADES[i].limit){return this.TMBC_GRADES[i]}}return this.TMBC_GRADES[this.TMBC_GRADES.length-1]},hasTooFewResponses:function(){return this.survey.respondentCounts.total<this.TMBC_MIN_RESPONSES},wasEdited:function(){return this._wasEdited},hasError:function(){if(this._tmbcData){return this._tmbcData.error&&this._tmbcData.error!=="none"}return true},getError:function(){if(this._tmbcData){return this._tmbcData.error}return"no_data"}});SM.TaLearnMoreView=SM.Views.deepExtend(SM.DialogView,{__NAME:"TaLearnMore",__templateID:"ta-upgrade-dialog-template",__defaults:{width:850,isModal:true},__init:function(){this.$el.on("click",".cancel-btn",{self:this},this._onCancel).on("click",".upgrade-btn",{self:this},this._onUpgrade)},_onCancel:function(e){e.preventDefault();e.data.self.close()},_onUpgrade:function(e){e.data.self.close()}});SM.TaUpgradeView=SM.Views.register({__NAME:"TAUpgradeNow",__templateID:"upgrade-now-topbar-template",__model:"taModel",__init:function(){var survey=this.taModel.get("survey");this.$el.on("click",".close",{self:this},this._onCloseBtnClick);this.bindModel(survey.owner,"hasDismissedTaUpgrade.changed",{self:this},this._onDismissUpgrade)},_onCloseBtnClick:function(e){var self=e.data.self,survey=self.taModel.get("survey");e.preventDefault();survey.owner.set("hasDismissedTaUpgrade",true,{notify:true})},_onDismissUpgrade:function(e){var self=e.data.self;if(e.value){self.$el.remove()}}});SM.TaResponseShowTextView=SM.Views.register({__NAME:"TaResponseShowText",__templateID:"ta-response-summary-text-template",__model:"taModel",__init:function(){var taModel=this.taModel;if(taModel.hasTextAnalysis()){this.$el.on("click","[ta-reset-results-btn]",{self:this},this._onClear);this.bindModel(taModel.responses.selection,"count.changed",{self:this},this._update);this.bindModel(taModel.responses,"failed.set",{self:this},this._onResponsesFailed);this.bindModel(taModel.responses,"loaded",{self:this},this._update);this.bindModel(taModel.responses,"responseRemoved",{self:this},this._update);this.bindModel(taModel.categories,"category.edited",{self:this},this._update);this.bindModel(taModel,"isSearching.changed",{self:this},this._update)}},__beforeRender:function(){var responsesCount,taModel=this.taModel,responses=taModel.responses,selection=responses.selection,query=taModel.query,phrase=taModel.phrase,hasFilter=taModel.categories.hasFilter(),canClear=(query||phrase||hasFilter)&&taModel.hasTextAnalysis()&&!taModel.isSearching;responsesCount=selection.isNone()?responses.queryCount:selection.count;return{responsesFailed:responses.failed,taQuery:query||phrase||null,isSearching:taModel.isSearching,hasFilter:hasFilter,categories:taModel.categories.getFilterList(),hasSelection:!selection.isNone(),hasSingle:responsesCount===1,responsesCount:Globalize.format(responsesCount,"n0"),canClear:canClear}},_update:function(e){e.data.self.render()},_onClear:function(e){e.preventDefault();e.data.self.taModel.clearQuery()},_onResponsesFailed:function(e){if(e.value){e.data.self.render()}}});SM.TaResponseSearchFormView=SM.Views.register({__NAME:"TAResponseSearchFrom",__templateID:"ta-response-search-form-template",__model:"taModel",__init:function(){var taModel=this.taModel;if(taModel.hasTextAnalysis()){this.bindModel(taModel,"searchDraft.changed",{self:this},this._onSearchChange);this.$el.on("paste","[ta-search-responses-input]",{self:this},this._onPaste).on("keyup","[ta-search-responses-input]",{self:this},this._onKeyup)}this.$el.on("submit","form",{self:this},this._onFormSubmit).on("click","[ta-search-responses-btn]",{self:this},this._onSearchBtnClick)},__beforeRender:function(){return{requireUpgrade:!this.taModel.hasTextAnalysis(),isDisabled:!this.taModel.hasTextAnalysis(),query:this.taModel.query}},__afterRender:function(){this.$el.find("[ta-search-tip]").popout()},_onSearchBtnClick:function(e){var self=e.data.self,taModel=self.taModel;e.preventDefault();if(taModel.hasTextAnalysis()){if(taModel.validate("searchDraft",taModel.searchDraft).isValid){self.trigger({type:"search",query:taModel.searchDraft})}}},_onKeyup:function(e){var self=e.data.self,$input=$(e.target);self._isCurrentForm=true;self.taModel.set("searchDraft",$input.val(),{notify:true})},_onPaste:function(e){var self=e.data.self,$input=$(e.target);setTimeout(function(){self._isCurrentForm=true;self.taModel.set("searchDraft",$input.val(),{notify:true})},0)},_onFormSubmit:function(e){var self=e.data.self,taModel=self.taModel;e.preventDefault();if(taModel.hasTextAnalysis()){self.$el.find("[ta-search-responses-btn]").click()}},_onSearchChange:function(e){var self=e.data.self,$input=self.$el.find("[ta-search-responses-input]");if(!$input.is(":focus")){$input.val(e.value)}}});SM.TaCategoryFormView=SM.Views.register({__NAME:"TaCategoryForm",__templateID:"ta-category-form-template",__model:"category",__setup:function(){this.__defaults.saveText=Globalize.localize("Save")},__defaults:{isDisabled:true,ignoreEmptyName:false},__init:function(){this.$el.on("submit",{self:this},this._onFormSubmit).on("keyup","[category-name-text]",{self:this},this._onKeyup).on("paste","[category-name-text]",{self:this},this._onPaste).on("click","[color-swatch]",{self:this},this._onSwatchClick).on("click","[save-btn]",{self:this},this._onSaveClick);this.category.on("validated",{self:this},this._onNameValidation)},__destroy:function(){this.category.off("validated",this._onNameValidation)},__beforeRender:function(){var colors,category=this.category,selectedColor=this._getSelectedColor();this._currentName=category.name;colors=$.map(category._colorOptions,function(color){return{isSelected:color.hex===selectedColor,name:color.name,hex:color.hex}});return{maxLen:this.category.MAX_CATNAME_LEN,isReadOnly:$(".analyze-container.read-only").length>0,name:category.name,colors:colors,saveText:this.__settings.saveText,isDisabled:this.__settings.isDisabled,isEdit:!category.isNew}},__setters:{isDisabled:function(self,val){var $saveBtn=self.$el.find("[save-btn]");if(val){$saveBtn.addClass("disabled")}else{$saveBtn.removeClass("disabled")}self.__settings.isDisabled=val},isSaving:function(self,val){self.__settings.isSaving=val;self.render()}},_isDirty:function(){var category=this.category,currentName=this._currentName,isNameDirty=currentName!==category.name;if(!category.isNew){return isNameDirty||this._getSelectedColor()!==category.color}return isNameDirty},_testDirty:function(){if(this._dirty||this._isDirty()){this.set("isDisabled",false)}else if(!this._isDirty()&&!this._dirty){this.set("isDisabled",true)}},markDirty:function(isDirty){this._dirty=isDirty;this._testDirty()},_dirty:false,_selectedColor:"",_onSwatchClick:function(e){var self=e.data.self,$target=$(e.target);e.preventDefault();if($target.closest("ul").hasClass("disabled")){return}self._selectedColor=$target.attr("color-hex");self.$el.find("[color-swatch]").removeClass("selected");$target.addClass("selected");self._testDirty()},_onSaveClick:function(e){var self=e.data.self,name,color;e.preventDefault();name=self._currentName;color=self._getSelectedColor();self._removeError();if(self.__settings.isDisabled){return}if(self.__settings.ignoreEmptyName&&!self._currentName||self.category.validate("name",name).isValid){self.trigger({type:"save",color:color,name:name,ID:self.category.ID})}},_onFormSubmit:function(e){var self=e.data.self;e.preventDefault();self.$el.find("[save-btn]").click()},_onNameValidation:function(e){var self=e.data.self,nameValidation=e.validations.invalids.name,el=SM.Template.renderHTML("ta-category-name-error-template",{isEmpty:nameValidation.exception==="empty",isTooLong:nameValidation.exception==="maxlength",isDuplicate:nameValidation.exception==="duplicate"});self.$el.prepend(el)},_onKeyup:function(e){var self=e.data.self;self._currentName=$.trim(self.$el.find("[category-name-text]").val());if(e.which!==SM.KeyCodes.ENTER&&e.which!==SM.KeyCodes.NUMPAD_ENTER){self._removeError();self._testDirty()}},_onPaste:function(e){var self=e.data.self;setTimeout(function(){self._currentName=$.trim(self.$el.find("[category-name-text]").val());self._removeError();self._testDirty()},0)},_removeError:function(){this.$el.find("[category-error-msg]").remove()},_getSelectedColor:function(){return this._selectedColor||this.category.color}});SM.TaCagetoriesAppliedView=SM.Views.register({__NAME:"TaCategoriesApplied",__templateID:"ta-categories-chkbox-list-template",__model:"categories",__init:function(){var categories=this.categories;this.selection=SM.Models.create("AppliedCategoriesSelection",{responseID:this.__settings.responseID});this.selection.load(categories);this.$el.on("change","[category-item-chkbx]",{self:this},this._onStateChange).on("click","[ta-list-item-overlay]",{self:this},this._onListItemClick)},__beforeRender:function(){var sortedList=this.categories.sortedList;return{isReadOnly:$(".analyze-container.read-only").length>0,categories:this.categories.sortedList.slice(0,sortedList.length-1)}},__afterRender:function(){var list=this.categories.sortedList,responseID=this.__settings.responseID;this.$el.find("[category-item-chkbx]").each(function(i,el){var state=list[i].getApplicationState(responseID);if(state==="indeterminate"){el.indeterminate=true}else{el.checked=state==="checked"}})},_onStateChange:function(e){var self=e.data.self,$target=$(e.target),$item=$target.closest("[category-id]"),categoryID=$item.attr("category-id");self.selection.update(categoryID,e.target.checked?"checked":"unchecked");self.trigger("selectionChanged")},_onListItemClick:function(e){var $chkbox=$(e.target).closest("[category-id]").find("[category-item-chkbx]"),indeterminate=$chkbox.get(0).indeterminate;if($chkbox.prop("disabled")===true){return}if(indeterminate){$chkbox.get(0).indeterminate=false;$chkbox.prop("checked",true)}else{$chkbox.prop("checked",!$chkbox.prop("checked"))}$chkbox.trigger("change").focus()}});SM.TaCategorizeMenuView=SM.Views.deepExtend(SM.BaseMenuView,{__NAME:"TaCategorizeMenu",__templateID:"ta-categorize-menu-template",__model:"categories",__init:function(){this.$el.on("TaCategoryForm.save",{self:this},this._onApplyCategories).on("TaCategoriesApplied.selectionChanged",{self:this},this._onSelectionChange)},__afterRender:function(){var categories=this.categories,categoryModel=categories.createModel();if(categories.count()>0){this.categoriesView=SM.Views.create(SM.TaCagetoriesAppliedView,{model:categories,responseID:this.__settings.responseID});this.el.appendChild(this.categoriesView.el)}this.formView=SM.Views.create(SM.TaCategoryFormView,{model:categoryModel,saveText:Globalize.localize("Apply"),ignoreEmptyName:true});this.el.appendChild(this.formView.el)},_onSelectionChange:function(e){var self=e.data.self,categoriesView=self.categoriesView;self.formView.markDirty(categoriesView.selection.isDirty())},_onApplyCategories:function(e){var self=e.data.self;e.selection=self.categoriesView&&self.categoriesView.selection.dump()}});SM.CategorizeMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"categorizeMenu",__onMenuInit:function(){this.get("menuView").$el.on("TaCategoryForm.save",{self:this},this._onApplyCategories).on("click","[cancel-btn]",{self:this},this._onCancelCategories)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this.get("menuView").render()},_menuView:"TaCategorizeMenuView",_onApplyCategories:function(e){var self=e.data.self;e.preventDefault();self.close();self.trigger({type:"apply",responseID:self.__settings.responseID,selection:e.selection,name:e.name,color:e.color})},_onCancelCategories:function(e){e.preventDefault();e.data.self.close()}});SM.TaCategoryFilterListView=SM.Views.register({__NAME:"TaCagetoryFilterList",__templateID:"ta-categories-chkbox-list-template",__model:"categories",__init:function(){var categories=this.categories,filterSelection;if(!categories.filterSelection){filterSelection=SM.Models.create("FilterCategoriesSelection");categories.loadFilterSelection(filterSelection)}categories.filterSelection.loadSelection();this.$el.on("change","[category-item-chkbx]",{self:this},this._onStateChange).on("click","[ta-list-item-overlay]",{self:this},this._onListItemClick)},__beforeRender:function(){return{categories:this.categories.sortedList}},__afterRender:function(){var list=this.categories.sortedList;this.$el.find("[category-item-chkbx]").each(function(i,el){el.checked=list[i].isFiltering()})},_onStateChange:function(e){var self=e.data.self,$target=$(e.target),$item=$target.closest("[category-id]"),categoryID=$item.attr("category-id");self.categories.filterSelection.update(categoryID,e.target.checked)},_onListItemClick:function(e){var $target=$(e.target),$item=$target.closest("[category-id]"),$chkbox=$item.find("[category-item-chkbx]");$chkbox.prop("checked",!$chkbox.prop("checked")).trigger("change").focus()}});SM.TaFilterMenuView=SM.Views.deepExtend(SM.BaseMenuView,{__NAME:"TaFilterMenu",__templateID:"ta-filter-menu-template",__defaults:{isDisabled:true},__model:"categories",__init:function(){var categories=this.categories;categories.filterSelection.on("selection.changed",{self:this},this._onSelectionChange);this.$el.on("click","[clear-btn]",{self:this},this._onClearClick)},__destroy:function(){var categories=this.categories;categories.filterSelection.off("selection.changed",this._onSelectionChange)},__beforeRender:function(){return{isDisabled:this.__settings.isDisabled,hasFilter:this.categories.hasFilter()}},__afterRender:function(){var categories=this.categories,categoriesView;categoriesView=SM.Views.create(SM.TaCategoryFilterListView,{model:categories});this.$el.prepend(categoriesView.el)},_onClearClick:function(e){var self=e.data.self;e.preventDefault();self.categories.filterSelection.clear();self.$el.find("[clear-btn]").addClass("disabled");self.$el.find("input[type=checkbox]").prop("checked",false)},_onSelectionChange:function(e){var self=e.data.self,$clearBtn=self.$el.find("[clear-btn]"),$saveBtn=self.$el.find("[save-btn]");if(e.isDirty){$saveBtn.removeClass("disabled")}else{$saveBtn.addClass("disabled")}if(!self.categories.filterSelection.isEmpty()){$clearBtn.removeClass("disabled")}}});SM.TaCategoriesShowTextView=SM.Views.register({__NAME:"TaCategoriesShowText",__templateID:"ta-categories-summary-text-template",__model:"categories",__init:function(){var taModel=this.categories.taModel;taModel.on("category.deleted",{self:this},this._onChangeCount);taModel.on("category.added",{self:this},this._onChangeCount)},__destroy:function(){var taModel=this.categories.taModel;taModel.off("category.deleted",this._onChangeCount);taModel.off("category.added",this._onChangeCount)},__beforeRender:function(){var categories=this.categories;return{hasCategories:!categories.isEmpty(),hasMany:categories.hasMany(),hasError:categories.failed,count:Globalize.format(categories.count(),"n0")}},_onChangeCount:function(e){var self=e.data.self;self.render()}});SM.TaCategoriesToolbarView=SM.Views.register({__NAME:"TaCategoriesToolbar",__templateID:"ta-categories-toolbar-template",__model:"taModel",__beforeRender:function(){return{isDisabled:this.taModel.categories.failed}},__afterRender:function(){var showTextView,searchFormView;
searchFormView=SM.Views.create(SM.TaResponseSearchFormView,{model:this.taModel});showTextView=SM.Views.create(SM.TaCategoriesShowTextView,{model:this.taModel.categories});this.$el.find("[ta-toolbar-row-a]").prepend(searchFormView.el);this.$el.append(showTextView.el)}});SM.TaCategoryItemView=SM.Views.register({__NAME:"TaCategoryItem",__templateID:"ta-category-item-template",__model:"category",__defaults:{mode:"view"},__init:function(){this.category.on("responseCount.changed",{self:this},this._onCountChange)},__destroy:function(){this.category.off("responseCount.changed",this._onCountChange)},__beforeRender:function(){var category=this.category;return{isReadOnly:$(".analyze-container.read-only").length>0,deleteMode:this._isDeleteMode(),viewMode:this._isViewMode(),editMode:this._isEditMode(),isSaving:this.__settings.isSaving,isUncategorized:category.isUncategorized,name:category.name,color:category.color,ID:category.ID,count:category.responseCount,localizedPercent:category.get("localizedPercent"),percent:category.get("percent")}},__afterRender:function(){var editView;if(this._isEditMode()){this.$el.on("leave",{self:this},this._onLeaveEdit).on("keyup",{self:this},this._onKeyup);editView=SM.Views.create(SM.TaCategoryFormView,{model:this.category});this.el.appendChild(editView.el);this.$el.find("input").focus()}},__setters:{mode:function(self,value){self.__settings.mode=value;self.render()}},modes:{VIEW:"view",DELETE:"delete",EDIT:"edit"},_cancel:function(){if(this.category.isNew){this.category.off("isLoading.changed",this._onLoading)}this.$el.find("[cancel-btn]").click()},_isDeleteMode:function(){return this.__settings.mode===this.modes.DELETE},_isViewMode:function(){return this.__settings.mode===this.modes.VIEW},_isEditMode:function(){return this.__settings.mode===this.modes.EDIT},_onLeaveEdit:function(e){var self=e.data.self;self.$el.off("leave");self._cancel()},_onKeyup:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self.$el.off("keyup");self._cancel()}},_onCountChange:function(e){var self=e.data.self;self.render()}});SM.TaCategoriesListView=SM.Views.register({__NAME:"TaCategoriesListView",__templateID:"ta-categories-list-template",__model:"categories",__init:function(){this.categories.taModel.on("category.added",{self:this},this._onAdd);this.$el.on("TaCategoryForm.save",{self:this},this._onSave).on("click","[confirm-delete-btn]",{self:this},this._onConfirmDeleteClick).on("click","[delete-btn]",{self:this},this._onDeleteClick).on("click","[cancel-btn]",{self:this},this._onCancelClick).on("click","[edit-btn]",{self:this},this._onEditClick)},__destroy:function(){this.categories.taModel.off("category.added",this._onAdd)},__afterRender:function(){var categories=this.categories,msg,views;if(categories.failed){msg=SM.Template.render("ta-categories-error-template",{isServiceError:true});this.$el.html(msg)}else{views=$.map(categories.sortedList,function(category){return SM.Views.create(SM.TaCategoryItemView,{model:category}).el});this.$el.append(views)}},_onConfirmDeleteClick:function(e){var self=e.data.self,category;e.preventDefault();category=self._getViewData(e.target);category.model.kill();category.view.$el.remove()},_onDeleteClick:function(e){var self=e.data.self,category;e.preventDefault();if(!_.isUndefined($(e.target).attr("full-access-only"))){return}category=self._getViewData(e.target);category.view.set("mode",category.view.modes.DELETE)},_onCancelClick:function(e){var self=e.data.self,category;e.preventDefault();category=self._getViewData(e.target);if(category.model.isNew){category.view.$el.remove()}else{category.view.set("mode",category.view.modes.VIEW)}},_onEditClick:function(e){var self=e.data.self,category;e.preventDefault();if(!_.isUndefined($(e.target).attr("full-access-only"))){return}category=self._getViewData(e.target);category.view.set("mode",category.view.modes.EDIT)},_onSave:function(e){var self=e.data.self,category;e.preventDefault();category=self._getViewData(e.target);if(category.model.isNew){category.model.color=e.color;category.model.name=e.name;category.view.set("isSaving",true);category.view.set("mode",category.view.modes.VIEW);category.model.save()}else{category.model.edit({color:e.color,name:e.name});category.view.set("mode",category.view.modes.VIEW)}},createNewCategory:function(categoryModel){var view=SM.Views.create(SM.TaCategoryItemView,{model:categoryModel,mode:"edit",isNew:true});this.$el.prepend(view.el);this.$el.find("input").focus()},_getViewData:function(el){var $item=$(el).closest("[category-id]"),view=$item.data("TaCategoryItem");return{view:view,model:view.category}},_onAdd:function(e){e.data.self.render()}});SM.TaCategoriesPanelView=SM.Views.extend({__NAME:"TaCategoriesPanel",__templateID:"ta-categories-panel-template",__model:"taModel",__init:function(){this.$el.on("click","[ta-new-category-btn]",{self:this},this._onCreateClick)},__afterRender:function(){var toolbarView,taModel=this.taModel;toolbarView=SM.Views.create(SM.TaCategoriesToolbarView,{model:taModel});this._listView=SM.Views.create(SM.TaCategoriesListView,{model:this.taModel.categories});this.$el.append(toolbarView.el);this.$el.append(this._listView.el)},_onCreateClick:function(e){var self=e.data.self,category;e.preventDefault();if(!self.taModel.categories.failed){category=self.taModel.categories.createModel();self._listView.createNewCategory(category)}}});SM.TaResponseBtnMenuView=SM.Views.register({__NAME:"TaResponseBtnMenu",__templateID:"ta-response-btn-menu-template",__model:"taModel",__init:function(){var self=this,taModel=self.taModel,selection=taModel.responses.selection;if(taModel.hasTextAnalysis()){selection.on("count.changed",{self:this},this._enableCategorizeMenu);taModel.on("category.deleted",{self:this},this._enableFilterMenu);taModel.on("category.added",{self:this},this._enableFilterMenu);this.$el.on("categorizeMenu.apply",{self:this},this._onApplyCategories).on("menu.menuInit","[filter-menu-btn]",{self:this},this._onFilterMenuInit).on("menu.beforeOpen","[filter-menu-btn]",{self:this},this._onFilterBeforeOpen).on("menu.afterOpen","[filter-menu-btn]",{self:this},this._onFilterAfterOpen)}},__destroy:function(){var taModel=this.taModel,selection=taModel.responses.selection;if(taModel.hasTextAnalysis()){selection.off("count.changed",this._enableCategorizeMenu);taModel.off("category.deleted",this._enableFilterMenu);taModel.off("category.added",this._enableFilterMenu)}},__beforeRender:function(){var taModel=this.taModel,responses=taModel.responses,selection=responses.selection,isFilterDisabled=!taModel.hasTextAnalysis()||taModel.categories.isEmpty()||taModel.filterCount===0||taModel.categories.failed,isCategorizeDisabled=!taModel.hasTextAnalysis()||selection.get("count")===0||taModel.categories.failed;return{hasSelectAll:taModel.hasTextAnalysis()&&!taModel.categories.failed,isCategorizeDisabled:isCategorizeDisabled,isFilterDisabled:isFilterDisabled,requireUpgrade:!taModel.hasTextAnalysis()}},__afterRender:function(){var self=this,taModel=self.taModel;if(taModel.hasTextAnalysis()){this.$el.find("[categorize-menu-btn]").categorizeMenu({model:this.taModel.categories});this._filterMenu=this.$el.find("[filter-menu-btn]").menu({menuView:"TaFilterMenuView",model:this.taModel.categories}).data("menu")}},_enableCategorizeMenu:function(e){var self=e.data.self,$categorizeBtn=self.$el.find("[categorize-menu-btn]");if(self.taModel.responses.selection.isNone()){$categorizeBtn.addClass("disabled")}else{$categorizeBtn.removeClass("disabled")}},_enableFilterMenu:function(e){var self=e.data.self,$filterBtn=self.$el.find("[filter-menu-btn]");if(self.taModel.categories.isEmpty()){$filterBtn.addClass("disabled")}else{$filterBtn.removeClass("disabled")}},_onApplyCategories:function(e){var self=e.data.self,updates;updates=self.taModel.responses.applyCategories(e.selection,{label:e.name,color:e.color});self.taModel.responses.save(updates.diff,updates.responseIDs,updates.except)},_onFilterBeforeOpen:function(e){var menuView=e.menu.get("menuView");menuView.render()},_onFilterAfterOpen:function(e){var menuView=e.menu.get("menuView");menuView.$el.find("input:first").focus()},_onFilterMenuInit:function(e){var self=e.data.self,menuView=e.menu.get("menuView");menuView.$el.on("click","[save-btn]",{menu:e.menu,self:self},self._onApplyFilter).on("click","[cancel-btn]",{menu:e.menu,self:self},self._onCancelFilter)},_onApplyFilter:function(e){var self=e.data.self,filterSelection=self.taModel.categories.filterSelection;e.preventDefault();if(filterSelection.isDirty()){filterSelection.apply();e.data.menu.close()}},_onCancelFilter:function(e){e.preventDefault();e.data.menu.close()}});SM.TaResponseSelectAllView=SM.Views.register({__NAME:"TaResponseSelectAllView",__templateID:"ta-select-all-template",__model:"taModel",__init:function(){var taModel=this.taModel,responses=taModel.responses,selection=responses.selection;responses.on("loaded",{self:this},this._onResponsesLoaded);taModel.on("isSearching.changed",{self:this},this._onSearching);selection.on("count.changed",{self:this},this._onCountChange);this.$el.on("click",{self:this},this._onSelectAllClick)},__destroy:function(){var taModel=this.taModel,responses=taModel.responses,selection=responses.selection;selection.off("count.changed",this._onCountChange);responses.off("loaded",this._onResponsesLoaded)},__afterRender:function(){this.$el.prop("checked",this.taModel.responses.selection.isAll()).prop("disabled",this.taModel.responses.queryCount===0||this.taModel.isSearching)},_onSelectAllClick:function(e){var self=e.data.self,$chkbx=$(e.target),responses=self.taModel.responses,state=$chkbx.prop("checked");if(state){responses.selection.selectAll()}else{responses.selection.clear()}},_onCountChange:function(e){e.data.self.render()},_onResponsesLoaded:function(e){e.data.self.render()},_onSearching:function(e){e.data.self.render()}});SM.TaResponseToolbarView=SM.Views.register({__NAME:"TAResponseTopBar",__templateID:"ta-response-toolbar-template",__model:"taModel",__afterRender:function(){var taModel=this.taModel,showTextView,btnView,searchFormView,selectAllView,hasSelectAllView=taModel.hasTextAnalysis()&&!taModel.categories.failed,$toolbar=this.$el.find("[ta-toolbar-row-a]");searchFormView=SM.Views.create(SM.TaResponseSearchFormView,{model:this.taModel});$toolbar.append(searchFormView.el);if(hasSelectAllView){selectAllView=SM.Views.create(SM.TaResponseSelectAllView,{model:this.taModel});$toolbar.append(selectAllView.el)}btnView=SM.Views.create(SM.TaResponseBtnMenuView,{model:this.taModel});$toolbar.append(btnView.el);showTextView=SM.Views.create(SM.TaResponseShowTextView,{model:this.taModel});this.$el.append(showTextView.el)}});SM.TaResponseItemView=SM.Views.register({__NAME:"TaResponseItem",__templateID:"ta-response-item-template",__model:"response",__init:function(){this.bindModel(this.response,"categoryIDs.changed",{self:this},this._onCategoryIDsChange);this.bindModel(this.response.responses.taModel.categories,"category.edited",{self:this},this._onCategoryEdited);this.bindModel(this.response,"category.removed",{self:this},this._onCategoryRemoved)},__beforeRender:function(){var response=this.response,taModel=response.responses.taModel;return{ID:response.ID,categories:response.categories.list,text:response.text,createDate:response.dateStr,respondentUrl:response.respondentUrl,isChecked:response.isSelected(),noTA:!response.responses.taModel.hasTextAnalysis(),canCategorize:taModel.hasTextAnalysis()&&!taModel.categories.failed,actionsEnabled:this._areActionsEnabled()}},__afterRender:function(){var taModel=this.response.responses.taModel;if(taModel.hasTextAnalysis()&&!taModel.categories.failed){this.$el.find("[categorize-menu-btn]").categorizeMenu({model:taModel.categories,responseID:this.response.ID,parentEl:this.__settings.parentEl})}},_onCategoryIDsChange:function(e){var self=e.data.self;if(self.response.get("isInFilter")){self.render()}else{self.$el.remove()}},_onCategoryEdited:function(e){var self=e.data.self;if(self.response.categories.map[e.category.ID]){self.render()}},_onCategoryRemoved:function(e){var self=e.data.self;self.render()},_areActionsEnabled:function(){return!SM.App.isSharingApp()}});SM.TaLoadMoreResponsesView=SM.Views.register({__NAME:"TaLoadMoreResponsesView",__model:"responses",__templateID:"ta-load-more-responses-template",__defaults:{fetchMoreFailed:false,fetchFailErrorID:null},__init:function(){this.$el.on(SM.Event.CLICK,"[ta-responses-try-again-btn]",{self:this},this._onTryAgainClicked);this.responses.on("fetchMoreResponses.failed",{self:this},this._onFetchFail)},__destroy:function(){this.responses.off("fetchMoreResponses.failed",this._onFetchFail)},__beforeRender:function(){return{id:this.get("ID"),failed:this.get("fetchMoreFailed"),errorID:this.get("fetchFailErrorID")}},_onFetchFail:function(e){var self=e.data.self;self.set("fetchMoreFailed",true);self.set("fetchFailErrorID",self.responses.fetchFailErrorID);self.render()},_onTryAgainClicked:function(e){var self=e.data.self;e.preventDefault();self.set("fetchMoreFailed",false);self.set("fetchFailErrorID",null);self.render();self.responses.taModel.fetchMoreResponses()}});SM.TaResponseListView=SM.Views.register({__NAME:"TaResponseList",__templateID:"ta-response-list-template",__model:"responses",__create:function(){this.set("lazyLoaderID",this.__NAME+"loader"+this.__uid)},__init:function(){this.$el.on("infiniteScroll.reachedEnd",{self:this},this._requestMoreResponses).on("multiselect.applied",{self:this},this._onMultiSelectApplied);this.responses.on("appended",{self:this},this._onResponsesAppended);if(this.responses.taModel.hasTextAnalysis()){this.responses.selection.on("count.changed",{self:this},this._onCountChange);this.responses.taModel.on("isSearching.changed",{self:this},this._onIsSearching);this.responses.on("loaded",{self:this},this._onResponsesLoaded);this.responses.on("failed.set",{self:this},this._onResponsesFailed);this.$el.on("change","[response-item-chkbx]",{self:this},this._onItemSelected);this.$el.on("categorizeMenu.apply","[categorize-menu-btn]",{self:this},this._onApplyCategories)}this._infiniteScroll=this.$el.infiniteScroll({markerID:this.get("lazyLoaderID")}).data("infiniteScroll");this.$el.multiselect({checkboxSelector:"input[response-item-chkbx]"})},__destroy:function(){this.responses.off("appended",this._onResponsesAppended);if(this.responses.taModel.hasTextAnalysis()){this.responses.selection.off("count.changed",this._onCountChange);this.responses.taModel.off("isSearching.changed",this._onIsSearching);this.responses.off("failed.set",this._onResponsesFailed);this.responses.off("loaded",this._onResponsesLoaded)}},__afterRender:function(){var responses=this.responses,loadMoreView,html,frag;if(responses.failed){html=SM.Template.render("ta-responses-error-template",{isServiceError:true});this.$el.html(html)}else if(responses.taModel.isSearching){html=SM.Template.render("qtext-search-spinner-template");this.$el.html(html)}else{if(!responses.isEmpty()){frag=this._createListFragment(responses.list);this.$el.append(frag)}if(this._hasUnloadedResponses()){loadMoreView=SM.Views.create(SM.TaLoadMoreResponsesView,{model:this.responses,ID:this.get("lazyLoaderID")});this.$el.append(loadMoreView.el)}}},_createListFragment:function(responsesList){var frag=document.createDocumentFragment(),self=this;$.each(responsesList,function(i,response){var el=SM.Views.create(SM.TaResponseItemView,{model:response,parentEl:self.el}).el;frag.appendChild(el)});return frag},_requestMoreResponses:function(e){var self=e.data.self;self.responses.taModel.fetchMoreResponses();e.stopPropagation()},_hasUnloadedResponses:function(){return this.responses.loadedCount<this.responses.queryCount+this.responses.removedCount},_updateResponseSelection:function(checkbox){var $checkbox=$(checkbox),selection=this.responses.selection,selected=checkbox.checked,$item=$checkbox.closest("[data-response-id]"),id=$item.attr("data-response-id");if(selected){selection.add(id)}else{selection.remove(id)}},_onMultiSelectApplied:function(e){var self=e.data.self;e.$checkboxes.each(function(){self._updateResponseSelection(this)})},_onItemSelected:function(e){var self=e.data.self;if(!e.isEditingAll){self._updateResponseSelection(e.target)}},_onCountChange:function(e){var self=e.data.self;if(self.responses.selection.isAll()){self.$el.find("input[response-item-chkbx]").each(function(){this.checked=true});self.$el.data("multiselect").reset()}else if(self.responses.selection.isNone()){self.$el.find("input[response-item-chkbx]").each(function(){this.checked=false});self.$el.data("multiselect").reset()}},_onIsSearching:function(e){var self=e.data.self;self._infiniteScroll.set("isActive",false);self.render()},_onResponsesLoaded:function(e){var self=e.data.self;self.render();if(!self._hasUnloadedResponses()){self._infiniteScroll.removeMarker()}self._infiniteScroll.set("isActive",true)},_onResponsesFailed:function(e){var self=e.data.self;if(e.value){self.render()}},_onResponsesAppended:function(e){var self=e.data.self,frag=self._createListFragment(e.respondents);self.$el.find("[data-response-id]").last().after(frag);if(!self._hasUnloadedResponses()){self._infiniteScroll.removeMarker()}self._infiniteScroll.set("isActive",true)},_onApplyCategories:function(e){var self=e.data.self,diff,responseModel=self.responses.map[e.responseID];diff=responseModel.applyCategories(e.selection,{label:e.name,color:e.color});responseModel.save(diff)}});SM.TaResponsesPanelView=SM.Views.extend({__NAME:"TAResponsePanel",__templateID:"ta-response-panel-template",__model:"taModel",__create:function(){var self=this;self.survey=self.taModel.get("survey");self.hasTextAnalysis=self.taModel.hasTextAnalysis()},__afterRender:function(){var self=this,upgradeView,listView,toolbarView;if(self._shouldShowUpgradeView()&&!self.survey.isReadOnly()){upgradeView=SM.Views.create(SM.TaUpgradeView,{model:self.taModel});self.$el.append(upgradeView.el)}if(self._shouldShowToolbar()){toolbarView=SM.Views.create(SM.TaResponseToolbarView,{model:self.taModel});self.$el.append(toolbarView.el)}listView=SM.Views.create(SM.TaResponseListView,{model:self.taModel.responses});self.$el.append(listView.el)},_shouldShowToolbar:function(){return!SM.App.isSharingApp()&&!SM.App.isMerveysApp()},_shouldShowUpgradeView:function(){var self=this;if(SM.App.isSharingApp()){return false}return!self.hasTextAnalysis&&!self.survey.owner.hasDismissedTaUpgrade}});SM.TaAnalysisShowTextView=SM.Views.register({__NAME:"TaAnalysisShowText",__templateID:"ta-analysis-summary-text-template",__model:"phrases",__init:function(){this.bindModel(this.phrases,"TaAnalysisInProgress.changed",{self:this},this._onAnalysisInProgress)},__beforeRender:function(){var phrases=this.phrases,phraseCount=phrases.list.length;return{hasAny:phraseCount>0,count:phraseCount,hasError:phrases.failed,inProgress:phrases.inProgress}},_onAnalysisInProgress:function(e){var self=e.data.self;self.render()}});SM.TaAnalysisTypeBtnView=SM.Views.register({__NAME:"TaAnalysisTypeBtn",__templateID:"ta-analysis-type-btn-template",__model:"taModel",__init:function(){var self=this;this.$el.on("selectMenu.change","a[ta-analysis-type]",function(e){self.$el.trigger("analysisTypeChange",e.value)}).on("selectMenu.afterOpen","a[ta-analysis-type]",function(e){var menuView=e.selectMenu.get("menuView");menuView.$el.find(".q").popout()})},__afterRender:function(){this.$el.find("[ta-analysis-type]").selectMenu({selectedValue:"lingo",options:[{text:Globalize.localize("Most Important"),value:"lingo"},{text:Globalize.localize("Most Frequent"),value:"nltk"}]})}});SM.TaAnalysisToolbarView=SM.Views.register({__NAME:"TaAnalysisToolbar",__templateID:"ta-analysis-toolbar-template",__model:"taModel",__init:function(){var self=this;this._popouts={};this.taModel.phrases.on("viewMode.changed",{self:this},this._onViewModeChanged);this.$el.on(SM.Event.CLICK,"[ta-phrase-mode-tab]",{self:this},this._onTabClick).on(SM.Event.MOUSEENTER,"[ta-phrase-mode-tab]",{self:this},this._onMouseenter).on(SM.Event.MOUSELEAVE,"[ta-phrase-mode-tab]",{self:this},this._onMouseleave);this.$el.on({analysisTypeChange:function(e,val){self._onAnalysisClick(self,e,val)}})},__destroy:function(){this.taModel.phrases.off("viewMode.changed",this._onViewModeChanged)},__beforeRender:function(){var viewModes=this.taModel.phrases.viewModes;return{cloudTab:viewModes.CLOUD,listTab:viewModes.LIST,lingoAnalysis:Globalize.localize(viewModes.LINGO),nltkAnalysis:Globalize.localize(viewModes.NLTK),isDisabled:this.taModel.phrases.failed}},__afterRender:function(){var view,taModel=this.taModel,phrases=taModel.phrases;if(this.taModel.flags.nltkOptionEnabled){view=SM.Views.create(SM.TaAnalysisTypeBtnView,{model:taModel});this.$el.find("[ta-toolbar-row-a]").append(view.el)}if(!this.taModel.phrases.failed){this.$el.find("[ta-phrase-mode-tab="+phrases.viewMode+"]").addClass("open")}view=SM.Views.create(SM.TaResponseSearchFormView,{model:taModel});this.$el.find("[ta-toolbar-row-a]").prepend(view.el);view=SM.Views.create(SM.TaAnalysisShowTextView,{model:phrases});this.$el.append(view.el)},_onViewModeChanged:function(e){var self=e.data.self;self.$el.find("[ta-phrase-mode-tab]").removeClass("open");self.$el.find("[ta-phrase-mode-tab="+e.value+"]").addClass("open")},_onTabClick:function(e){var self=e.data.self,$tab=$(e.target),phrases=self.taModel.phrases;e.preventDefault();if(!phrases.failed){phrases.set("viewMode",$tab.attr("ta-phrase-mode-tab"),{notify:true})}},_onAnalysisClick:function(self,e,val){var params=self.taModel._makeSearchParams();params.offset=0;self.taModel.phrases.set("inProgress",true);self.taModel.phrases._trigger("TaAnalysisInProgress.changed");params.is_lingo=val==="lingo";SM.API.taGetRollupQuestion(params).done(function(response){var taData=response[self.taModel.ID];taData.flags=self.taModel.flags;self.taModel.load(taData,"analysisTypeChange");self.taModel.phrases._trigger("TaCloudDataLoaded");self.taModel.phrases.set("inProgress",false);self.taModel.phrases._trigger("TaAnalysisInProgress.changed")});e.preventDefault()},_getViewMode:function(viewMode){return viewMode==="cloud"?"Cloud":"List"},_onMouseenter:function(e){var self=e.data.self,$owner=$(e.target),viewMode=self._getViewMode($owner.attr("ta-phrase-mode-tab"));self._addTip($owner,viewMode)},_onMouseleave:function(e){var self=e.data.self,$owner=$(e.target),viewMode=self._getViewMode($owner.attr("ta-phrase-mode-tab"));self._removeTip(viewMode)},_addTip:function($owner,viewMode){var tooltip;if(!this._popouts[viewMode]){tooltip=SM.Template.renderHTML("ta-mode-tab-popout-template",{isCloudViewMode:viewMode==="Cloud"});this._popouts[viewMode]=$(tooltip)}$(document.body).append(this._popouts[viewMode]);this._popouts[viewMode].removeClass("out").position({my:"center bottom",at:"center top",of:$owner,collision:"none"}).addClass("active")},_removeTip:function(viewMode){var self=this;if(!this._popouts[viewMode]){return}this._popouts[viewMode].addClass("out");setTimeout(function(){if(self._popouts&&self._popouts[viewMode]){self._popouts[viewMode].removeClass("active").detach()}},200)}});SM.TaAnalysisListView=SM.Views.register({__NAME:"TaAnalysisListView",__templateID:"ta-analysis-list-template",__model:"phrases",__beforeRender:function(){var phrases=$.map(this.phrases.list,function(phrase){return{ID:phrase.ID,localizedPercent:phrase.get("localizedPercent"),percent:phrase.get("percent"),count:phrase.responseCount,text:phrase.text}});return{phrases:phrases}}});SM.TaAnalysisCloudView=SM.Views.register({__NAME:"TaAnalysisCloudView",__templateID:"ta-analysis-cloud-template",__model:"phrases",__init:function(){this._popouts={};this.$el.on("click","[phrase-filter-id]",{self:this},this._onClick).on("mouseenter","[phrase-filter-id]",{self:this},this._onMouseenter).on("mouseleave","[phrase-filter-id]",{self:this},this._onMouseleave);this.bindModel(this.phrases,"TaCloudDataLoaded",{self:this},this._newDataLoaded)},__beforeRender:function(){var phrases=$.map(this.phrases.sortedList,function(phrase){return{ID:phrase.ID,fontSize:phrase.get("fontSize"),text:SM.String.truncate(phrase.text,100,false)}});return{phrases:phrases}},__destroy:function(){if(!!this._popouts){$.each(this._popouts,function(phraseID,$popout){$popout.remove()})}this._popouts=null},_onMouseenter:function(e){var self=e.data.self,$owner=$(e.target),phraseID=$owner.attr("phrase-filter-id");self._addTip($owner,phraseID)},_onMouseleave:function(e){var self=e.data.self,$owner=$(e.target),phraseID=$owner.attr("phrase-filter-id");self._removeTip(phraseID)},_onClick:function(e){var self=e.data.self,$owner=$(e.target),phraseID=$owner.attr("phrase-filter-id");self._removeTip(phraseID)},_phraseWidth:function(ownerWidth){if(ownerWidth>500){return"right top"}return"center top"},_addTip:function($owner,phraseID){var phrase=this.phrases.map[phraseID],cloud;if(!this._popouts[phraseID]){cloud=SM.Template.renderHTML("ta-cloud-popout-template",{hasMany:phrase.hasManyResponses(),count:phrase.responseCount,percent:phrase.get("localizedPercent"),rank:phrase.rank});this._popouts[phraseID]=$(cloud)}$(document.body).append(this._popouts[phraseID]);this._popouts[phraseID].removeClass("out").position({my:"center bottom",at:this._phraseWidth($owner.width()),of:$owner,collision:"none"}).addClass("active")},_removeTip:function(phraseID){var self=this;if(!this._popouts[phraseID]){return}this._popouts[phraseID].addClass("out");setTimeout(function(){if(self._popouts&&self._popouts[phraseID]){self._popouts[phraseID].removeClass("active").detach()}},200)},_newDataLoaded:function(e){var self=e.data.self;self.render()}});SM.TaAnalysisContentView=SM.Views.register({__NAME:"TaAnalysisContent",__templateID:"ta-analysis-panel-content-template",__model:"phrases",__init:function(){this.phrases.on("viewMode.changed",{self:this},this._onViewModeChanged);this.bindModel(this.phrases,"TaAnalysisInProgress.changed",{self:this},this._onAnalysisInProgress)},__destroy:function(){this.phrases.off("viewMode.changed",this._onViewModeChanged)},__afterRender:function(){var phrases=this.phrases,html,language=Globalize.culture().name;if(!phrases.isLanguageAvailable(language)){html=SM.Template.render("ta-analysis-error-template",{isUnsupported:true})}else if(phrases.isOverResponseLimit()){html=SM.Template.render("ta-analysis-error-template",{isOverLimit:true,limit:Globalize.format(phrases.LINGO_MAX_COUNT,"n0")})}else if(phrases.failed){html=SM.Template.render("ta-analysis-error-template",{isServiceError:true})}else if(phrases.inProgress){html=SM.Template.render("ta-analysis-spinner-template")}else if(phrases.viewMode==="cloud"){html=SM.Views.create(SM.TaAnalysisCloudView,{model:phrases}).el}else{html=SM.Views.create(SM.TaAnalysisListView,{model:phrases}).el}this.$el.html(html)},_onViewModeChanged:function(e){var self=e.data.self;self.render()},_onAnalysisInProgress:function(e){var self=e.data.self;self.render()}});SM.TaAnalysisPanelView=SM.Views.extend({__NAME:"TaAnalysisPanel",__templateID:"ta-analysis-panel-template",__model:"taModel",__afterRender:function(){var contentView,toolbarView;toolbarView=SM.Views.create(SM.TaAnalysisToolbarView,{model:this.taModel});contentView=SM.Views.create(SM.TaAnalysisContentView,{model:this.taModel.phrases});this.$el.append(toolbarView.el);this.$el.append(contentView.el)}});SM.TaTabsView=SM.Views.register({__NAME:"TaTabsView",__templateID:"ta-tabs-template",__model:"taModel",__defaults:{selectedTab:"responses"},__init:function(){var taModel=this.taModel;this.$el.tabs({selectedTab:this.__settings.selectedTab});taModel.on("category.deleted",{self:this},this._onCategoryCountChange);taModel.on("category.added",{self:this},this._onCategoryCountChange);this.$el.on("TAResponseSearchFrom.search",{self:this},this._onSearch).on("click","[category-filter-id]",{self:this},this._onCategoryClick).on("click","[phrase-filter-id]",{self:this},this._onPhraseClick).on("click","[learn-more-trigger]",{self:this},this._onLearnMoreClick)},__destroy:function(){this.taModel.off("category.deleted",this._onCategoryCountChange);this.taModel.off("category.added",this._onCategoryCountChange)},__beforeRender:function(){var hasTextAnalysis=this.taModel.hasTextAnalysis(),selectedTab=this.get("selectedTab"),taModel=this.taModel,tabs=[];tabs.push({name:"responses",icon:"w",hasCount:true,count:Globalize.format(taModel.filterCount,"n0"),text:Globalize.localize("Responses"),isDisabled:false});if(this._shouldShowAnalysisTab()){tabs.push({name:"analysis",icon:"C",text:Globalize.localize("Text Analysis"),isDisabled:!hasTextAnalysis})}if(this._shouldShowCategoriesTab()){tabs.push({name:"categories",icon:"z",text:Globalize.localize("My Categories"),hasCount:!taModel.categories.failed,count:hasTextAnalysis&&!taModel.categories.failed?Globalize.format(taModel.categories.count(),"n0"):0,isDisabled:!hasTextAnalysis})}$.each(tabs,function(i,tab){tab.isOpen=selectedTab===tab.name});return{tabs:tabs}},__afterRender:function(){var panelContents=[],responsesPanelView,analyzePanelView,categoriesPanelView,hasTextAnalysis=this.taModel.hasTextAnalysis(),$panels=this.$el.find("[ta-tabs-panel]");responsesPanelView=SM.Views.create(SM.TaResponsesPanelView,{model:this.taModel});panelContents.push(responsesPanelView.el);if(hasTextAnalysis){analyzePanelView=SM.Views.create(SM.TaAnalysisPanelView,{model:this.taModel});categoriesPanelView=SM.Views.create(SM.TaCategoriesPanelView,{model:this.taModel});panelContents.push(analyzePanelView.el);panelContents.push(categoriesPanelView.el)}$.each(panelContents,function(i,contents){$panels.eq(i).append(contents)})},_onLearnMoreClick:function(e){var self=e.data.self;e.preventDefault();if(!self.taModel.get("survey").isReadOnly()){SM.Views.create(SM.TaLearnMoreView).open()}},_onCategoryClick:function(e){var self=e.data.self,tabs=self.$el.data("tabs"),categoryID=$(e.target).attr("category-filter-id");e.preventDefault();self.taModel.filterCategories([categoryID]);tabs.open("responses")},_onPhraseClick:function(e){var self=e.data.self,tabs=self.$el.data("tabs"),phraseID,phraseText;e.preventDefault();phraseID=$(e.target).attr("phrase-filter-id");phraseText=self.taModel.phrases.map[phraseID].text;self.taModel.searchQuery(phraseText);tabs.open("responses")},_onSearch:function(e){var self=e.data.self,tabs=self.$el.data("tabs");self.taModel.searchQuery(e.query);tabs.open("responses")},_onCategoryCountChange:function(e){var self=e.data.self,$responseCount=self.$el.find("[tab-target=categories] [ta-tab-count]");$responseCount.text("("+self.taModel.categories.count()+")")},_shouldShowAnalysisTab:function(){return!SM.App.isSharingApp()&&!SM.App.isMerveysApp()},_shouldShowCategoriesTab:function(){return!SM.App.isSharingApp()&&!SM.App.isMerveysApp()}});SM.TaContainerView=SM.Views.register({__NAME:"TaContainerView",__templateID:"ta-container-template",__model:"taModel",__afterRender:function(){var tabSetView=SM.Views.create(SM.TaTabsView,{model:this.taModel});this.$el.append(tabSetView.$el)}});SM.SummaryChartContainerView=SM.Views.register({__NAME:"summaryQuestionChartView",__templateID:"summary-chart-container-template",__model:"question",__create:function(options){var self=this;self.survey=options.survey;self.question=options.question;self.rollup=self.question.getRollup();self.display=self.rollup.display;self.isExport=options.isExport;self.randomAssignmentOption=options.randomAssignmentOption;self.questionView=options.questionView},__beforeRender:function(){var self=this,display=self.display.getDisplayData();return{isShown:display.show_chart}},__afterRender:function(){var self=this,chartView,viewType;if(self._shouldHideChart()){return}try{if(self.display.getBenchmarkDisplay()){if(self.question.isNPS()&&self.display.getChartType()==="score_gauge"){viewType=SM.BenchmarkNpsSummaryChartView}else if(self.question.isTop2()){viewType=SM.BenchmarkTop2SummaryChartView}else{viewType=SM.BenchmarkSummaryChartView}}else if(self.question.isNPS()){viewType=SM.NpsSummaryChartView}else{viewType=SM.BaseSummaryChartView}chartView=SM.Views.create(viewType,{question:self.question,questionView:self.questionView});
self.$el.html(chartView.el);self.chartView=chartView}catch(exception){self._handleRenderingError(exception)}},_shouldHideChart:function(){var self=this,display=self.display.getDisplayData();return!display.show_chart},_handleRenderingError:function(exception){var self=this,div;div=document.createElement("div");div.innerHTML=SM.Template.render("summary-chart-display-error-template");self.$el.html(div);SM.Error.log(exception,"question summary chart rendering error, QuestionID: "+self.question.ID)},__init:function(){var self=this;self.bindModel(self.display,"displayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"tempDisplayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"allDisplaysChange",{self:self},self._onDisplayChange)},_onDisplayChange:function(e){var self=e.data.self;if(self.question.hasRandomAssignment()&&!!self.randomAssignmentOption){self.question.randomAssignmentOption=self.randomAssignmentOption}self.render()}});SM.BaseSummaryChartView=SM.Views.register(SM.Object.deepExtend(SM.SummarySeriesFactory,{__NAME:"BaseSummaryChartView",__templateID:"summary-chart-template",HIGHCHARTS_CHART_TYPE_MAP:{vbar:"column",hbar:"bar",area:"area",line:"line",stacked_vbar:"column",stacked_hbar:"bar",pie:"pie",donut:"pie",boxplot:"boxplot",top2_hbar:"bar",top2_vbar:"column",top2_donut:"pie"},DATA_LABEL_OFFSETS:{column:[0,-10],bar:[10,0],pie:[10,0],donut:[10,0],line:[0,-10],area:[0,-10],boxplot:[10,0]},TITLE_HEIGHT:30,__create:function(options){var self=this;self._createAsSummarizable(_.extend(options,{noLabelByWeight:true,noLabelBySidi:true}));self.DEFAULT_HIGHCHARTS_OPTIONS=SM.Object.deepExtend(SM.Highcharts.DEFAULT_OPTIONS,{plotOptions:{series:{dataLabels:{formatter:this._formatDataLabel}}}});_.bindAll(this,"_compileChartOptions","_renderChart")},getSeriesList:function(){var self=this;return self.seriesList},__beforeRender:function(){var self=this;self._getDisplayOptions();self._getChartMetadata();self._getSortedSummaryData()},__afterRender:function(){var self=this,questionOptionsList,chartOptionsList,configLimit,singleDataPoints=0,totalDataPoints=0,isBenchmarkable=self.question.isBenchmarkable(),shouldShowProfiler=self.question.survey.isProfilerDialogEnabled(),showingBenchmark=self.displayData.show_benchmark,noResponsesTemplate="no-matching-responses-template";self.$el.empty();self.seriesList=[];if(SM.App.isSharingApp()||SM.App.isExportApp()){isBenchmarkable=false}if(self.summary.answered===0&&!showingBenchmark){self.$el.html(SM.Template.render(noResponsesTemplate,{isBenchmarkable:isBenchmarkable,showLink:!shouldShowProfiler,classes:"mod-no-header"}));return}questionOptionsList=self._buildQuestionOptions();chartOptionsList=_.map(questionOptionsList,self._compileChartOptions);if(_.size(chartOptionsList[0].series)===0){self.$el.html(SM.Template.render(noResponsesTemplate,{isBenchmarkable:false,classes:"mod-no-header"}));return}totalDataPoints=0;_.each(chartOptionsList,function(charOptions){singleDataPoints=_.size(charOptions.series)*_.size(charOptions.series[0].data);totalDataPoints+=singleDataPoints});configLimit=self.question.survey.config.question_chart_display_threshold;if(singleDataPoints>configLimit||totalDataPoints>configLimit*3){self.$el.html(SM.Template.render("chart-too-big-template"));return}_.each(chartOptionsList,self._renderChart)},_compileChartOptions:function(questionOptions,chartIndex){var self=this,chartOptions,eventOptions,plotOptions,tooltipOptions,legendOptions,colorOptions,compiledOptions,series,xAxisLabels,$chartContainer;$chartContainer=$("<div></div>");$chartContainer.attr("chart-type",self.chartType);series=questionOptions.series;self.seriesList.push(series);xAxisLabels=questionOptions.xAxis.categories;chartOptions=self._buildChartOptions(series,xAxisLabels,$chartContainer,chartIndex);eventOptions=self._buildEventOptions($chartContainer);colorOptions=self._buildColorOptions();plotOptions=self._buildPlotOptions(series);tooltipOptions=self._buildTooltipOptions();legendOptions=self._buildLegendOptions();if(self.question.isEmoji()&&series[0].__options.dimensionType==="row"&&self.question.structure.answers.rows[0].text===series[0].name){legendOptions.legend.itemStyle={fontFamily:"SMFont"}}self._setDataLabelCoordinates(series,questionOptions.yAxis,chartOptions.chart);compiledOptions=SM.Object.deepExtend(self.DEFAULT_HIGHCHARTS_OPTIONS,chartOptions,eventOptions,colorOptions,plotOptions,tooltipOptions,legendOptions,questionOptions);return compiledOptions},_renderChart:function(chartOptions){var self=this,chart,$chartContainer=$(chartOptions.chart.renderTo),cb;self.$el.append($chartContainer);if(self.isBoxplot){cb=self._renderBoxPlotLabels}else{cb=function(){}}chart=new Highcharts.Chart(chartOptions,cb);self._bindEvents($chartContainer,chart)},_bindEvents:function($chartContainer,chart){if(!SM.App.isSharingApp()){SM.Highcharts.bindYAxisEvents($chartContainer,chart.yAxis[0]);SM.Highcharts.bindAreaChartEvents($chartContainer);SM.Highcharts.bindXAxisEvents($chartContainer)}},_getChartMetadata:function(){var self=this;self.chartMetadata=self.rollup.display.getDisplayData();self.chartType=self.chartMetadata.chart_type;self.scaleType=self.chartMetadata.scale_type;self.scaleIsPercent=self.scaleType===self.SCALE_TYPE_PERCENT;self.isMirrored=self.chartMetadata.mirror;self.isWeightedAvg=self.chartMetadata.isWeightedAvg;self.isDistribution=self.chartMetadata.isDistribution;self.isStacked=self.chartMetadata.isStacked;self.isArea=self.chartMetadata.isAreaChart;self.isPie=self.chartMetadata.isPieChart;self.isDonut=self.chartMetadata.isDonutChart;self.isBoxplot=self.chartMetadata.isBoxplotChart;self.showDataLabels=self.chartMetadata.show_data;self.hideEmptyData=!self.chartMetadata.show_empty_data;self.hasXAxis=!self.isPie&&!self.isDonut;self.showBenchmark=self.chartMetadata.show_benchmark;self.hasTitle=self._hasTitle();self.hasLegend=self._hasLegend();self.highchartsChartType=self.HIGHCHARTS_CHART_TYPE_MAP[self.chartType];self.isVertical=self._isVertical()},_buildQuestionOptions:function(){var self=this,optionsList;if(self.summaryType==="menu_matrix"){if(self.isWeightedAvg){optionsList=self._buildMenuMatrixWeightedAvgChartOptionsList()}else if(self.isPie||self.isDonut){optionsList=self._buildMenuMatrixPieChartOptionsList()}else{optionsList=self._buildMenuMatrixChartOptionsList()}}else if(self.summaryType==="matrix"){if(self.isWeightedAvg){optionsList=[self._buildMatrixWeightedAvgChartOptions()]}else if(self.isPie||self.isDonut){optionsList=[self._buildPieChartOptions()]}else{optionsList=[self._buildMatrixChartOptions()]}}else{if(self.isPie||self.isDonut){optionsList=[self._buildPieChartOptions()]}else{optionsList=[self._buildSimpleChartOptions()]}}return optionsList},_buildSimpleChartOptions:function(){var self=this,chartOptions,categories,series,sortedRows;sortedRows=self.sortedRowsList[0];if(self.isStacked){categories=[];series=self.buildSimpleStackedSeries(self.summary,sortedRows)}else if(self.isWeightedAvg){categories=["Weighted Average"];series=self.buildSimpleWeightedAverageSeries(self.summary,sortedRows)}else{categories=self.buildCategories(sortedRows);series=self.buildSimpleSeries(self.summary,sortedRows)}chartOptions={xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series)};return chartOptions},_buildPieChartOptions:function(options){var self=this,chartOptions,categories,series,sortedRows;options=options||{};sortedRows=self.sortedRowsList[0];categories=self.buildCategories(sortedRows);if(self.summaryType==="matrix"){if(self.isCompared){series=self.buildSimpleSeriesFromComparedMatrixSummary()}else{series=self.buildSimpleSeriesFromMatrixSummary()}}else if(self.summaryType==="menu_matrix"){series=self.buildSimpleSeriesFromMenuMatrixSummary(options.columnID)}else{series=self.buildSimpleSeries(self.summary,sortedRows)}chartOptions={xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series)};return chartOptions},_buildMatrixChartOptions:function(){var self=this,chartOptions,categories,series;if(self.aggregateOverColumns){categories=self.buildCategories(self.sortedColumnsList[0]);series=self.buildMirroredMatrixSeries()}else{categories=self.buildCategories(self.sortedRowsList[0]);series=self.buildMatrixSeries()}chartOptions={xAxis:self._buildXAxisOptions(categories),yAxis:self._buildYAxisOptions(series),series:series};return chartOptions},_buildMenuMatrixChartOptionsList:function(){var self=this,columnChoices,columnChoiceTotals,chartOptionsList,chartOptions,sortedRows,sortedColumns,sortedColumnChoices,categories,series;if(self.question.isCompared()){chartOptionsList=_.map(self.rows,function(row,rowIndex){columnChoices=row.items;if(_.isEmpty(columnChoices)){return}if(self.isMirrored){sortedColumnChoices=self.sortedColumnChoicesList[rowIndex];categories=self.buildCategories(sortedColumnChoices)}else{sortedColumns=self.sortedColumnsList[rowIndex];categories=self.buildCategories(sortedColumns)}columnChoiceTotals=self.columnChoiceTotalsByRow[row.id];series=self.buildComparedMatrixSeries(row,columnChoices,columnChoiceTotals);chartOptions=self._buildMenuMatrixChartOptions(categories,series,row.text);return chartOptions})}else{chartOptionsList=_.map(self.columns,function(column,columnIndex){if(self.isMirrored){sortedColumnChoices=self.sortedColumnChoicesList[columnIndex];categories=self.buildCategories(sortedColumnChoices)}else{sortedRows=self.sortedRowsList[columnIndex];categories=self.buildCategories(sortedRows)}series=self.buildMenuMatrixSeries(column,columnIndex,column.items,self.columnChoiceTotalsByColumnChoice);chartOptions=self._buildMenuMatrixChartOptions(categories,series,column.text);return chartOptions})}chartOptionsList=_.compact(chartOptionsList);return chartOptionsList},_buildMenuMatrixChartOptions:function(categories,series,titleText){var self=this;return{title:self._buildMenuMatrixTitleOptions(titleText),xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series)}},_buildMatrixWeightedAvgChartOptions:function(){var self=this;return self._buildWeightedAvgChartOptions(0,function(dimensionId){if(self.isCompared){return self.weightedAveragesByColumn[dimensionId]}return self.weightedAveragesByRow[dimensionId]})},_buildMenuMatrixWeightedAvgChartOptionsList:function(){var self=this;var chartOptionsList=[],chartOptions;if(self.isCompared){_.each(self.rows,function(row,rowIndex){chartOptions=self._buildWeightedAvgChartOptions(rowIndex,function(columnChoiceId){return self.weightedAveragesByRowAndColumnChoice[row.id][columnChoiceId]});chartOptions.title=self._buildMenuMatrixTitleOptions(row.text);chartOptionsList.push(chartOptions)})}else{_.each(self.columns,function(column,columnIndex){chartOptions=self._buildWeightedAvgChartOptions(columnIndex,function(rowId){return self.weightedAveragesByRowAndColumn[rowId][column.id]});chartOptions.title=self._buildMenuMatrixTitleOptions(column.text);chartOptionsList.push(chartOptions)})}return chartOptionsList},_buildMenuMatrixPieChartOptionsList:function(){var self=this;var chartOptionsList=[],chartOptions;_.each(self.columns,function(column){chartOptions=self._buildPieChartOptions({columnID:column.id});chartOptions.title=self._buildMenuMatrixTitleOptions(column.text);chartOptionsList.push(chartOptions)});return chartOptionsList},_buildMenuMatrixTitleOptions:function(titleText){var self=this,options;titleText=_.string.truncate(titleText,SM.Highcharts.MAX_TITLE_CHARS);options={align:"left",text:titleText,useHTML:true,style:{padding:"10px 1500px 10px 10px",backgroundColor:"#DFDFDF",fontSize:"12px"},x:84,y:0};if(this.highchartsChartType==="bar"&&!self.isStacked){options.x=104}if(self.question.isEmoji()&&self.question.structure.answers.rows[0].text===titleText){options.style.fontFamily="SMFont"}return options},_buildWeightedAvgChartOptions:function(sortedDimensionIndex,getWeightedAverageValue){var self=this,chartOptions,categories=[],series,seriesData=[],categoryName,weightedAverage;if(self.isCompared){if(self.summaryType==="menu_matrix"){if(self.sortedColumnChoicesList.length){_.each(self.sortedColumnChoicesList[sortedDimensionIndex],function(columnChoice){categoryName=columnChoice.text;weightedAverage=getWeightedAverageValue(columnChoice.id);categories.push(categoryName);seriesData.push({y:weightedAverage,absoluteY:weightedAverage})})}}else{if(self.sortedColumnsList.length){_.each(self.sortedColumnsList[sortedDimensionIndex],function(column){categoryName=column.text;weightedAverage=getWeightedAverageValue(column.id);categories.push(categoryName);seriesData.push({y:weightedAverage,absoluteY:weightedAverage})})}}}else{if(self.sortedRowsList.length){_.each(self.sortedRowsList[sortedDimensionIndex],function(row){categoryName=row.text;weightedAverage=getWeightedAverageValue(row.id);categories.push(categoryName);seriesData.push({y:weightedAverage,absoluteY:weightedAverage})})}}series=[self._buildSeriesItem(seriesData,{})];chartOptions={xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series)};return chartOptions},_buildChartOptions:function(series,xAxisLabels,$container,chartIndex){var self=this,numSeries=series.length,numXAxisLabels=_.isEmpty(xAxisLabels)?0:xAxisLabels.length,titleHeight=self.hasTitle?self.TITLE_HEIGHT:0,labelHeight=self.hasXAxis?SM.Highcharts.calculateXAxisLabelHeight(self.highchartsChartType,xAxisLabels):0,legendHeight=self.hasLegend?SM.Highcharts.calculateLegendHeight(series):0,answerStructures=self.answerStructures,chartOptions;if(self.question.isSingleChoice()&&self.isWeightedAvg){answerStructures={rows:[{text:Globalize.localize("Weighted Average")}]}}chartOptions={chart:{type:self.highchartsChartType,width:SM.Highcharts.calculateChartWidth(self.highchartsChartType,{numSeries:numSeries,numXAxisLabels:numXAxisLabels,isStacked:self.isStacked,isCompared:self.isCompared}),height:SM.Highcharts.calculateChartHeight(self.highchartsChartType,{answerStructures:answerStructures,titleHeight:titleHeight,labelHeight:labelHeight,legendHeight:legendHeight,isDistribution:self.question.isNPS()||self.isDistribution,isCompared:self.isCompared,isStacked:self.isStacked,isMirrored:self.isMirrored,chartIndex:chartIndex}),marginTop:SM.Highcharts.calculateMarginTop(0,titleHeight),marginBottom:SM.Highcharts.calculateMarginBottom(labelHeight,legendHeight),renderTo:$container[0]}};if(self.isPie||self.isDonut){chartOptions.chart.plotBackgroundColor="#FFF";chartOptions.chart.marginLeft=0}if(self.question.isNPS()&&self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_score){chartOptions.chart.marginLeft=80;chartOptions.chart.marginRight=50}else if(self.highchartsChartType==="bar"&&!self.isStacked){chartOptions.chart.marginLeft=115}return chartOptions},_buildEventOptions:function($chartContainer){var eventOptions,type,self=this;if(SM.App.isSharingApp()){return}eventOptions={chart:{events:{click:function(e){SM.CustomizeActionMenu.actionMenu.call(self,e,"background",{parent:$chartContainer})}}},plotOptions:{series:{events:{legendItemClick:function(e){e.preventDefault();type=self.question.isNPS()?"legendNPS":"legend";SM.CustomizeActionMenu.actionMenu.call(self,e.browserEvent,type,{parent:$chartContainer})}},point:{events:{click:function(e){type=self.question.isNPS()?"dataPointNPS":"dataPoint";SM.CustomizeActionMenu.actionMenu.call(self,e,type,{parent:$chartContainer})},mouseOver:SM.Highcharts.onPointMouseOver,mouseOut:SM.Highcharts.onPointMouseOut}}}}};return eventOptions},_buildColorOptions:function(){var self=this,options={};if(_.isEmpty(self.chartMetadata.colors)){return}options.colors=self.chartMetadata.colors;return options},_buildXAxisOptions:function(categories){var self=this,xAxisOptions={};if(_.isEmpty(categories)){xAxisOptions.labels={enabled:false}}else{xAxisOptions.categories=categories;if(_.contains(["column","line","area"],self.highchartsChartType)){SM.Object.deepUpdate(xAxisOptions,{labels:{y:25,formatter:SM.Highcharts.xAxisLabelFormatter}})}if(_.include(["bar"],self.highchartsChartType)){SM.Object.deepUpdate(xAxisOptions,{labels:{formatter:function(){return SM.Highcharts.formatAxisLabel(this.value,115,2)},style:{textAlign:"right"}}})}if(this.question.isEmoji()&&!self.aggregateOverColumns&&this.question.structure.answers.rows.length>=1&&this.question.structure.answers.rows[0].text===categories[0]){SM.Object.deepUpdate(xAxisOptions,{labels:{style:{fontFamily:"SMFont"}}})}}return xAxisOptions},buildCategories:function(mappableItems){return _.map(mappableItems,function(item){return item.text})},_buildYAxisOptions:function(series){var self=this,scaleOptions,labelOptions,yAxisOptions={startOnTick:false,endOnTick:false};scaleOptions=self._getYAxisScaleOptions(series);labelOptions={labels:{formatter:self.scaleIsPercent?SM.Highcharts.percentageLabelFormatter:SM.Highcharts.yAxisLabelFormatter}};SM.Object.deepUpdate(yAxisOptions,scaleOptions);SM.Object.deepUpdate(yAxisOptions,labelOptions);return yAxisOptions},_otherIsAnAnswerChoice:function(){var self=this;return self.others!==undefined&&self.others[0].options.is_answer_choice},_getYAxisScaleOptions:function(series){var self=this,highcharts=SM.Highcharts,specialCharts=self.isStacked||self.isArea&&!self.question.isSimple()&&!self.isWeightedAvg,options,newOptions,max,range;if(self.scaleIsPercent){if(specialCharts){return{min:0,max:100,tickInterval:10}}range=highcharts.calculateSeriesRange(series);options={min:0,max:Math.ceil(range.max/100)*100||100};options.tickInterval=options.max/10}else if(specialCharts){range=highcharts.calculateStackedSeriesRange(series);options=highcharts.calculateYAxisScaleOptions(range.max)}else if(self.question.isSingleChoice()&&self.isWeightedAvg){max=self._otherIsAnAnswerChoice()?self.question.rowList.length+1:self.question.rowList.length;range={min:0,max:max};options=highcharts.calculateYAxisScaleOptions(max,0)}else{range=highcharts.calculateSeriesRange(series);if(range.max<0){range.max=0}options=highcharts.calculateYAxisScaleOptions(Math.max(range.max,-range.min));if(range.min<0){options.min=-options.max;options.tickInterval*=2}}options=self.display.getCustomScale(range,options);if(specialCharts){options.min=0}newOptions=highcharts.calculateYAxisScaleOptions(options.max,options.min);options.tickInterval=newOptions.tickInterval;return options},_buildPlotOptions:function(series){var self=this,numSeries=series.length,pointWidth,options={plotOptions:{series:{}}};options.plotOptions[self.highchartsChartType]={colorByPoint:self._shouldColorByPoint(numSeries),borderWidth:0,dataLabels:{enabled:self.showDataLabels,x:self.DATA_LABEL_OFFSETS[self.highchartsChartType][0],y:self.DATA_LABEL_OFFSETS[self.highchartsChartType][1]}};if(self.isStacked){options.plotOptions.series.stacking="normal";options.plotOptions[self.highchartsChartType].dataLabels.x=0;options.plotOptions[self.highchartsChartType].dataLabels.y=0}if(self.isArea){options.plotOptions.area.stacking="normal";options.plotOptions.area.dataLabels.y=30}if(self.isPie||self.isDonut){options.plotOptions.pie.dataLabels={enabled:self.showDataLabels||self.chartMetadata.label_type==="labels",color:"#000000",connectorColor:"#000000"};options.plotOptions.series.dataLabels={formatter:self._formatPieChartDataLabel};if(self.isDonut){options.plotOptions.series.innerSize="40%"}if(self._hasLegend()){options.plotOptions.pie.showInLegend=true}}pointWidth=self._calculatePointWidth(series);if(pointWidth){options.plotOptions[self.highchartsChartType].pointWidth=pointWidth}return options},_getNumPoints:function(series){var self=this,points,numPoints;points=_.map(series,function(s){return s.data?s.data.length:0});if(self.isStacked){numPoints=_.max(points)}else{numPoints=_.reduce(points,function(memo,point){return memo+point},0)}return numPoints},_calculatePointWidth:function(series){var self=this,numPoints=self._getNumPoints(series),pointWidth;if(self.highchartsChartType==="column"){if(numPoints<=4){pointWidth=80}else if(numPoints<=6){pointWidth=60}}if(self.highchartsChartType==="bar"){if(numPoints<=4){pointWidth=50}else if(numPoints<=6){pointWidth=40}}return pointWidth},_shouldColorByPoint:function(numSeries){var self=this,shouldColorByPoint;if(numSeries===1){if(_.contains(["line","area"],self.highchartsChartType)||self.isStacked||self.isMirrored&&!self.isCompared||self.isCompared&&!self.isMirrored){shouldColorByPoint=false}else{shouldColorByPoint=true}}else{shouldColorByPoint=false}return shouldColorByPoint},_buildTooltipOptions:function(){var self=this,options={tooltip:{}};if(self.showDataLabels){options.tooltip.enabled=false}return options},_buildLegendOptions:function(){var self=this,options={legend:{enabled:self._hasLegend()}};if(self._hasLegend()){options.legend.enabled=true;if(self.isPie||self.isDonut){options.legend.align="center"}else{options.legend.x=75;options.legend.align="left";options.legend.width=514}if(self.question.isNPS()&&self.isStacked&&self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed){options.legend.itemDistance=15}}return options},_hasTitle:function(){var self=this;return self.questionType==="menu_matrix"||self.questionType==="compare"&&self.questionFamily==="matrix"},_hasLegend:function(){var self=this;if((self.isPie||self.isDonut)&&self.chartMetadata.label_type!=="legend"){return false}if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_score&&self.question.isCompared()){return false}return(self.questionType==="simple"&&self.isStacked||self.questionType==="matrix"||self.questionType==="menu_matrix"||self.questionType==="compare"||(self.isPie||self.isDonut)&&self.chartMetadata.label_type==="legend")&&!self.isWeightedAvg},_isVertical:function(){var self=this;if(!self.highchartsChartType){throw new Error("_isVertical requires highchartsChartType to be set")}return _.contains(["column","area","line"],self.highchartsChartType)},_formatDataLabel:function(){var options=this.series.options.__options,pointOptions=this.point.__options||{},scaleType=options.scaleType,decimalPlaces=options.decimalPlaces;if(pointOptions.disableDataLabels){return null}if(this.y===0){return null}return SM.Highcharts.formatYValue(this.y,scaleType,decimalPlaces)},_formatPieChartDataLabel:function(){var options=this.series.options.__options,shouldShowDataLabels=options.showDataLabels,hasLegend=options.isLegend,name,absoluteY,percentageY;name=SM.Highcharts.formatTextualAxisLabel(this.point.name,150,4);absoluteY=this.point.absoluteY;percentageY=SM.Highcharts.formatYValue(this.point.percentageY,"percent",options.decimalPlaces);if(absoluteY===0){return null}if(shouldShowDataLabels){if(hasLegend){return percentageY+"<br>"+"("+absoluteY+")"}return"<b>"+name+"</b> <br>"+percentageY+" ("+absoluteY+")"}return"<b>"+name+"</b>"},_setDataLabelCoordinates:function(series,yAxisOptions,chartOptions){var self=this,chartType=chartOptions.type,plotAreaHeight=chartOptions.height-chartOptions.marginTop-chartOptions.marginBottom,yAxisMax=yAxisOptions.max,label,labelLength;if(self.isStacked){return}_.each(series,function(seriesItem,i){_.each(seriesItem.data,function(data,j){if(typeof data==="number"){label=SM.Highcharts.formatYValue(data,self.scaleType,self.decimalPlaces);labelLength=label.length;if(self._isLabelInsidePoint(labelLength,data.y,yAxisMax,chartType,plotAreaHeight)){series[i].data[j]={y:data,dataLabels:self._buildDataLabelCoordinateOptions(labelLength)}}}else if(typeof data==="object"){if(data.y){label=SM.Highcharts.formatYValue(data.y,self.scaleType,self.decimalPlaces);labelLength=label.length;if(self._isLabelInsidePoint(labelLength,data.y,yAxisMax,chartType,plotAreaHeight)){data.dataLabels=self._buildDataLabelCoordinateOptions(labelLength)}}}})})},_isLabelInsidePoint:function(labelLength,yValue,yAxisMax,chartType,plotAreaHeight){var self=this;if(self.isVertical){return SM.Highcharts.DATA_LABEL_CHARACTER_HEIGHT+Math.abs(self.DATA_LABEL_OFFSETS[chartType][1])+SM.Highcharts.DATA_LABEL_PADDING>(yAxisMax-yValue)/yAxisMax*plotAreaHeight}return labelLength*SM.Highcharts.DATA_LABEL_CHARACTER_WIDTH+self.DATA_LABEL_OFFSETS[chartType][0]+SM.Highcharts.DATA_LABEL_PADDING>(yAxisMax-yValue)/yAxisMax*SM.Highcharts.PLOT_AREA_WIDTH},_buildDataLabelCoordinateOptions:function(labelLength){var self=this,x,y,characterWidth=10,minOffset=30;x=self.isVertical?0:Math.min(-labelLength*characterWidth,-minOffset);y=self.isVertical?Math.max(-labelLength*characterWidth,minOffset):0;return{x:x,y:y}}}));SM.NpsSummaryChartView=SM.Views.deepExtend(SM.BaseSummaryChartView,{__NAME:"NpsSummaryChartView",HIGHCHARTS_CHART_TYPE_MAP:{vbar:"column",hbar:"bar",stacked_vbar:"column",stacked_hbar:"bar",score_gauge:"score",score_vbar:"column",score_hbar:"bar"},__beforeRender:function(){var self=this;self._getDisplayOptions();self._getChartMetadata();self._getSortedSummaryData();self._getNpsData();if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_score&&self.question.isCompared()){self._setAsSummarizableNpsScoreComparedChart()}else{self._setAsSummarizableNps(self.nps_depth)}},__afterRender:function(){var self=this,questionOptionsList,chartOptionsList,showingBenchmark=self.displayData.show_benchmark,isBenchmarkable=true,shouldShowProfiler=self.question.survey.isProfilerDialogEnabled(),noResponsesTemplate="no-matching-responses-template";self.$el.empty();self.seriesList=[];if(SM.App.isSharingApp()||SM.App.isExportApp()){isBenchmarkable=false}self.$el.empty();self.seriesList=[];if(self.summary.answered===0&&!showingBenchmark){self.$el.html(SM.Template.render(noResponsesTemplate,{isBenchmarkable:isBenchmarkable,showLink:!shouldShowProfiler,classes:"mod-no-header"}));return}if(self.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.score_gauge){_.bindAll(this,"_renderGaugeShapes");self._renderScoreChart();return}questionOptionsList=self._buildQuestionOptions();chartOptionsList=_.map(questionOptionsList,self._compileChartOptions);_.each(chartOptionsList,self._renderChart)},_buildColorOptions:function(){var self=this,options={};if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_distribution){options.colors=SM.Highcharts.NPS_DISTRIBUTION_COLORS}else if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed){options.colors=SM.Highcharts.NPS_DETAILED_DISTRIBUTION_COLORS}else{options.colors=SM.Highcharts.DEFAULT_COLORS}return options},_buildTooltipOptions:function(){var self=this,options;options=SM.BaseSummaryChartView._buildTooltipOptions.call(this);if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_score){options.tooltip.formatter=SM.Highcharts.formatTooltipNpsScore}else if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed){options.tooltip.formatter=SM.Highcharts.formatTooltipNpsDetailed}return options},_getChartMetadata:function(){var self=this;self.chartType=self.displayData.chart_type;self.nps_depth=self.displayData.nps_depth;self.hasXAxis=true;self.showDataLabels=self.displayData.show_data;self.hasTitle=self._hasTitle();self.hasLegend=self._hasLegend();self.highchartsChartType=self.HIGHCHARTS_CHART_TYPE_MAP[self.chartType];self.isVertical=self._isVertical()},_buildQuestionOptions:function(){var self=this,optionsList;if(self.summaryType==="matrix"){optionsList=[self._buildMatrixChartOptions()]}else{optionsList=[self._buildSimpleChartOptions()]}if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_score){SM.Object.deepUpdate(optionsList[0],SM.Highcharts.NPS_SCORE_BAR_CHART_OPTIONS)}return optionsList},_buildSimpleChartOptions:function(){var self=this,chartOptions,categories,series,summary=self.summary,rows=self.answerStructures.rows;if(self.isStacked){categories=[];series=self.buildSimpleStackedSeries(summary,rows)}else{categories=self.buildCategories(rows);series=self.buildSimpleSeries(summary,rows)}chartOptions={xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series)};return chartOptions},buildCategories:function(mappableItems){var self=this,simpleLegend;if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed&&self.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.vbar&&!self.question.isCompared()){simpleLegend=true}else{simpleLegend=false}return _.map(mappableItems,function(item,index){if(index===0&&simpleLegend){return"0"}if(index===10&&simpleLegend){return"10"}return item.text})},_renderScoreChart:function(){var self=this,chartOptions;chartOptions=SM.Highcharts.NPS_SCORE_CHART_BASE_OPTIONS;self.$el.highcharts(chartOptions,self._renderGaugeShapes)},_renderGaugeShapes:function(chart){var self=this,isExport=self.question.survey.isExport,score;score=self.npsSummary.score.summary.summary.options.Score.count;SM.Highcharts.renderGaugeShapes(chart,score,self.$el,isExport)}});SM.BenchmarkSummaryChartView=SM.Views.register(SM.Object.deepExtend(SM.BaseSummaryChartView,{__NAME:"BenchmarkSummaryChartView",__templateID:"summary-chart-template",__beforeRender:function(){SM.BaseSummaryChartView.__beforeRender.call(this);if(this.question.isNPS()){this._getNpsData();this._setAsSummarizableNps(this.nps_depth)}},__afterRender:function(){var survey=this.question.survey,benchmarkRollup=survey.getBenchmarkRollup(this.question.ID),md={};if(this.showBenchmark&&benchmarkRollup.hasError()){this.$el.addClass("bm-error");md.notApplicable=benchmarkRollup.getError()==="no_access";md.noData=benchmarkRollup.getError()==="no_data";md.isNPS=false;md.user_id=survey.currentUserID;md.name=benchmarkRollup.getSegmentName();md.useBMStr=md.name.indexOf("Benchmark")===-1;md.source="question";this.$el.html(SM.Template.render("summary-benchmark-data-not-available-template",md));return}this.$el.removeClass("bm-error");_.bindAll(this,"_renderBoxPlotLabels");SM.BaseSummaryChartView.__afterRender.call(this)},__init:function(){this.$el.on(SM.Event.CLICK,"[cta]",{self:this},this._onBuyBenchmarksClicked)},_onBuyBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),href=$tgt.attr("link"),source=$tgt.attr("source");e.preventDefault();e.stopPropagation();SM.Bi.benchmarkingAbout(self.question.ID,source,href,self.question.isNPS());href+="?param="+self.question.survey.currentUserID;window.open(href,"_blank")},_getChartMetadata:function(){SM.BaseSummaryChartView._getChartMetadata.call(this);if(this.question.isNPS()){this.nps_depth=this.displayData.nps_depth}},_buildQuestionOptions:function(){var optionsList;if(this.isBoxplot){optionsList=[this._buildBoxPlotOptions()]}else if(this.isDistribution&&this.showBenchmark){if(this.question.isNPS()){optionsList=[this._buildBenchmarkNPSMatrixOptions()];SM.Object.deepUpdate(optionsList[0],SM.Highcharts.NPS_SCORE_BAR_CHART_OPTIONS)}else{this.scaleIsPercent=true;this.scaleType="percentage";optionsList=[this._buildBenchmarkMatrixOptions()]}}else{optionsList=SM.BaseSummaryChartView._buildQuestionOptions.call(this)}return optionsList},_getComparedPlotLines:function(series,meanWidth){var self=this,plotLines=[],plotLabels=[],colors=SM.Highcharts.DEFAULT_BENCHMARK_COLORS.slice(1);_.each(series,function(seriesItem,index){if(seriesItem.__options&&seriesItem.__options.dimensionType==="userAverage"){if(self.question.isNPS()){plotLines.push({value:seriesItem.data[0].y,color:colors[index%colors.length],width:meanWidth,zIndex:100});plotLabels.push(seriesItem.data[0].y)}else if(seriesItem.data[0].y!==0){plotLines.push({value:seriesItem.data[0].y,color:colors[index%colors.length],width:meanWidth,zIndex:100});plotLabels.push(seriesItem.data[0].y)}}});plotLabels.sort(function(a,b){return a-b});this.dataPlotLabels=plotLabels;return plotLines},_fixBoxPlotSeries:function(series){var simpleData=[],dataIndex=2,boxplotSeries;boxplotSeries=_.filter(series,function(seriesItem){if(seriesItem.__options&&seriesItem.__options.dimensionType==="benchmark"){return seriesItem}});_.each(boxplotSeries[0].data[dataIndex],function(item){simpleData.push(item.y)});boxplotSeries[0].data[dataIndex]=simpleData;this.dataBoxPlot=simpleData;return series},_buildBoxPlotOptions:function(){var boxPlotYAxisLabelFormatter=function(){var rows=question.structure.answers.rows,numCategories=rows.length,maxWidth=this.axis.width/numCategories,maxNumLines=SM.Highcharts.X_AXIS_MAX_VISIBLE_LINES,label=this.value;
if(this.isFirst&&!question.isNPS()){label=rows[0].text}if(this.isLast&&!question.isNPS()){label=rows[rows.length-1].text}return SM.Highcharts.formatAxisLabel(label,maxWidth,maxNumLines)},question=this.question,colorOptions={colors:SM.Highcharts.DEFAULT_BENCHMARK_COLORS},benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),responseMean,meanWidth=!question.isNPS()||this.isNPSScoreValid()?2:0,benchmarkSeries=this.buildSimpleBenchmarkSeries(colorOptions),min=this.question.isNPS()?-100:1,max=this.question.isNPS()?100:this.question.structure.answers.rows.length,tickInterval=this.question.isNPS()?100:1,chartOptions={chart:{type:"boxplot",inverted:true,width:SM.Highcharts.CHART_WIDTH,isNPS:this.question.isNPS()},plotOptions:{boxplot:{dataLabels:{enabled:true}}},xAxis:{categories:["","","",""]},yAxis:{tickInterval:tickInterval,min:min,max:max,labels:{formatter:boxPlotYAxisLabelFormatter}},legend:{labelFormatter:SM.Highcharts.legendUnescapedFormatter},series:this._fixBoxPlotSeries(benchmarkSeries),tooltip:{enabled:false}};if(this.question.isCompared()){chartOptions.yAxis.plotLines=this._getComparedPlotLines(benchmarkSeries,meanWidth)}else{responseMean=question.isNPS()?this.getNPSScore():benchmarkRollup.getResponseMean(this.question.ID);if(!question.isNPS()&&responseMean>=1||question.isNPS()&&this.isNPSScoreValid()){chartOptions.yAxis.plotLines=[{value:responseMean,color:colorOptions.colors[1],width:meanWidth,zIndex:100}];this.dataPlotLabels=[responseMean]}else{this.dataPlotLabels=[]}}if(this.question.isNPS()){chartOptions.yAxis.minorTickInterval=50;chartOptions.yAxis.gridLineColor="#E0E0E0";chartOptions.yAxis.minorGridLineColor="#FFF"}return chartOptions},buildCategories:function(mappableItems){return _.map(mappableItems,function(item){var text=item.text.replace(/\/([^\s])/g,"/ $1");return text})},_buildBenchmarkMatrixOptions:function(){var rows=this.question.compositeAnswerStructure?this.question.structure.answers.rows:this.sortedRowsList[0],cols=this.question.getContextStructure().answers.cols,categories=this.buildCategories(this.question.isCompared()?cols:rows),benchmarkSeries=this.question.isCompared()?this.buildComparedBenchmarkMatrixSeries({}):this.buildBenchmarkMatrixSeries({}),widthOptions={isCompared:this.question.isCompared(),numSeries:benchmarkSeries.length},heightOptions={answerStructures:{rows:rows,cols:cols},isCompared:this.question.isCompared(),isDistribution:true,titleHeight:0,legendHeight:SM.Highcharts.calculateLegendHeight(benchmarkSeries)},chartType=this.rollup.display.getChartType()==="hbar"?"bar":"column",chartOptions={chart:{type:chartType,inverted:false},plotOptions:{column:{dataLabels:{enabled:false}},row:{dataLabels:{enabled:false}}},yAxis:{tickInterval:20,min:0,max:100,labels:{formatter:SM.Highcharts.percentageLabelFormatter}},series:benchmarkSeries,tooltip:{enabled:false}},benchmarkRollup;if(this.question.isCompared()){benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID);categories.push(benchmarkRollup.getSegmentName());cols=heightOptions.answerStructures.cols.slice(0);cols.push({});heightOptions.answerStructures.cols=cols}chartOptions.xAxis=this._buildXAxisOptions(categories);widthOptions.numXAxisLabels=chartOptions.xAxis.categories.length;chartOptions.chart.width=SM.Highcharts.calculateChartWidth(chartType,widthOptions);heightOptions.labelHeight=SM.Highcharts.calculateXAxisLabelHeight(chartType,chartOptions.xAxis.categories);chartOptions.chart.height=SM.Highcharts.calculateChartHeight(chartType,heightOptions);return chartOptions},_buildBenchmarkNPSMatrixOptions:function(){var rows=this.answerStructures.rows,categories=this.buildNPSCategories(rows),benchmarkSeries=this.buildBenchmarkMatrixSeries({}),chartOptions={chart:{type:"column",inverted:false,height:250,width:500},plotOptions:{column:{dataLabels:{enabled:false}}},xAxis:this._buildXAxisOptions(categories),yAxis:{tickInterval:20,min:0,max:100,labels:{formatter:SM.Highcharts.percentageLabelFormatter}},series:benchmarkSeries,tooltip:{enabled:false}};return chartOptions},_buildEventOptions:function(){if(SM.App.isSharingApp()){return}if(this.display.getBenchmarkDisplay()){return{}}return SM.BaseSummaryChartView._buildEventOptions.call(this)},_buildColorOptions:function(){var colors,bmColor,numColors;if(this.showBenchmark&&(this.highchartsChartType==="column"||this.highchartsChartType==="bar")){if(this.question.isNPS()){return{colors:SM.Highcharts.NPS_BENCHMARK_DISTRIBUTION_COLORS}}colors=SM.Highcharts.DEFAULT_BENCHMARK_COLORS.slice(0);numColors=this.numColumns+1;bmColor=colors.shift();while(colors.length<numColors){$.merge(colors,colors)}colors.splice(numColors,0,bmColor);return{colors:colors}}return SM.BaseSummaryChartView._buildColorOptions.call(this)},buildNPSCategories:function(mappableItems){var self=this,simpleLegend;if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed&&self.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.vbar&&!self.question.isCompared()){simpleLegend=true}else{simpleLegend=false}return _.map(mappableItems,function(item,index){if(index===0&&simpleLegend){return"0"}if(index===10&&simpleLegend){return"10"}return item.text})},_hasLegend:function(){if(this.isBoxplot||this.showBenchmark&&this.isDistribution){return true}return SM.BaseSummaryChartView._hasLegend.call(this)},_renderBoxPlotLabels:function(chart){var self=this,data=self.dataBoxPlot;SM.Highcharts.renderBoxPlotLabels(chart,data);if(self.dataPlotLabels){SM.Highcharts.renderBoxPlotLabels(chart,self.dataPlotLabels,true)}}}));SM.BenchmarkNpsSummaryChartView=SM.Views.deepExtend(SM.NpsSummaryChartView,{__NAME:"BenchmarkNpsSummaryChartView",TEXT_RADIUS:115,CHAR_W:7,CHAR_H:12,COLOR_EMPTY:"#CCC",NPS_BENCHMARK_COLOR_OPTIONS:{colors:["#A9BD38","#A9BD38","#A9BD38","#A9BD38"]},NPS_BENCHMARK_CHART_OPTIONS:{chart:{width:328,height:220,showingBenchmark:true,noResponses:false},plotOptions:{pie:{size:"75%"}}},__afterRender:function(){var survey=this.question.survey,benchmarkRollup=survey.getBenchmarkRollup(this.question.ID),md={};if(benchmarkRollup.hasError()){this.$el.addClass("bm-error");md.notApplicable=benchmarkRollup.getError()==="no_access";md.noData=benchmarkRollup.getError()==="no_data";md.isNPS=true;md.user_id=survey.currentUserID;md.name=benchmarkRollup.getSegmentName();md.useBMStr=md.name.indexOf("Benchmark")===-1;md.source="question";this.$el.html(SM.Template.render("summary-benchmark-data-not-available-template",md));return}this.$el.removeClass("bm-error");SM.NpsSummaryChartView.__afterRender.call(this)},__init:function(){this.$el.on(SM.Event.CLICK,"[cta]",{self:this},this._onBuyBenchmarksClicked)},_onBuyBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),href=$tgt.attr("link"),source=$tgt.attr("source");e.preventDefault();e.stopPropagation();SM.Bi.benchmarkingAbout(self.question.ID,source,href,self.question.isNPS());href=href+"?param="+self.question.survey.currentUserID;window.open(href,"_blank")},_buildBenchmarkNpsLabels:function(){var labelSeries=[],defaultLabels=SM.Highcharts.NPS_SCORE_CHART_MISC_OPTIONS.labels;var offset=defaultLabels[0].x/2-12,biases=[{x:0,y:20},{x:10,y:5},{x:-10,y:5},{x:5,y:-15},{x:-5,y:-15}];_.each(defaultLabels,function(datum,index){labelSeries.push({x:datum.x-offset+biases[index].x,y:datum.y+biases[index].y,text:datum.text})});return labelSeries},_renderGaugeShapes:function(chart){var self=this,isExport=self.question.survey.isExport,benchmarkRollup,score,$container;if(chart.userOptions.chart.isBenchmark){benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID);score=benchmarkRollup.getNpsScore();$container=self._$bmNpsCtnr}else{score=self.npsSummary.score.summary.summary.options.Score.count;if(self.npsSummary.score.summary.summary.options.Score.noResponses){chart.userOptions.chart.noResponses=true}$container=self._$userNpsCtnr}SM.Highcharts.renderGaugeShapes(chart,score,$container,isExport)},_renderScoreChart:function(){var self=this,chartOptions,survey=this.question.survey,benchmarkRollup=survey.getBenchmarkRollup(this.question.ID),userTitle=$("<div/>").html(Globalize.localize("Your Net Promoter&#174; Score")).text(),answered=Globalize.format(this.summary.answered,"n0"),skipped=Globalize.format(this.summary.skipped,"n0"),userTemplate=SM.Template.render("benchmark-nps-chart-template",{title:userTitle,side:"left",isBenchmark:false,answered:answered,skipped:skipped}),bmTemplate=SM.Template.render("benchmark-nps-chart-template",{title:benchmarkRollup.getSegmentName(),side:"right",isBenchmark:true});self.$el.addClass("sm-bm-nps");self.$el.append($(userTemplate));self.$el.append($(bmTemplate));self._$userNpsCtnr=self.$el.find(".sm-bm-nps-chart.left");self._$bmNpsCtnr=self.$el.find(".sm-bm-nps-chart.right");if(!self.NPS_BENCHMARK_CHART_OPTIONS.labels){self.NPS_BENCHMARK_CHART_OPTIONS.labels=self._buildBenchmarkNpsLabels()}chartOptions=$.extend(true,{},SM.Highcharts.NPS_SCORE_CHART_BASE_OPTIONS,self.NPS_BENCHMARK_CHART_OPTIONS);self._$userNpsCtnr.highcharts(chartOptions,self._renderGaugeShapes);chartOptions=$.extend(true,{},SM.Highcharts.NPS_SCORE_CHART_BASE_OPTIONS,self.NPS_BENCHMARK_CHART_OPTIONS,self.NPS_BENCHMARK_COLOR_OPTIONS);chartOptions.chart.isBenchmark=true;self._$bmNpsCtnr.highcharts(chartOptions,self._renderGaugeShapes)}});SM.BenchmarkTop2SummaryChartView=SM.Views.register(SM.Object.deepExtend(SM.BenchmarkSummaryChartView,{__NAME:"BenchmarkTop2SummaryChartView",__templateID:"summary-chart-template",__model:"question",__afterRender:function(){var self=this,questionOptionsList,chartOptionsList,chartView,options={isTable:false,isCompared:self.summary.type==="compare"},benchmarkRollup=self.benchmarkSummary,md={};self.$el.empty();self.seriesList=[];self.isStacked=true;self.hasLegend=true;self.showDataLabels=true;self.decimalPlaces=1;self.showBenchmark=self.displayData.show_benchmark;if(self.showBenchmark&&benchmarkRollup.hasError()){self.$el.addClass("bm-error");md.notApplicable=benchmarkRollup.getError()==="no_access";md.noData=benchmarkRollup.getError()==="no_data";md.isNPS=false;md.user_id=self.question.survey.currentUserID;md.name=benchmarkRollup.getSegmentName();md.useBMStr=md.name.indexOf("Benchmark")===-1;md.source="question";this.$el.html(SM.Template.render("summary-benchmark-data-not-available-template",md));return}this.$el.removeClass("bm-error");if(self.get("isDonut")&&self.showBenchmark){chartView=SM.Views.create(SM.TMBCSummaryChartView,{model:null,tmbcType:"",benchmarkDisplay:true,questionView:self.questionView,question:self.question,isTop2:true,summary:self.summary,series:self.buildTop2StackedSeries(options)});self.$el.addClass("short sm-chart-container tmbc-chart-container");self.$el.html(chartView.el);self.chartView=chartView;return}questionOptionsList=self._buildQuestionOptions();chartOptionsList=_.map(questionOptionsList,self._compileChartOptions);_.each(chartOptionsList,self._renderChart)},_buildColorOptions:function(){return{colors:["#2D606F",SM.Highcharts.DEFAULT_BENCHMARK_COLORS[0],"#CCCCCC"]}},_hasLegend:function(){return true},_top2LabelFormatter:function(){var pointOptions=this.point.__options||{},chartType=this.series.chart.userOptions.chart.type,value,sp="",bsp="";if(this.key==="blank"||this.key==="rest"||this.key==="BMrest"){return}if(pointOptions.disableDataLabels){return}value=Math.round(this.y*10)/10;if(chartType==="bar"){if(value>10){sp="&nbsp;&nbsp;&nbsp"}}else if(chartType==="column"){if(value>20){bsp="<br/>&nbsp;"}}return sp+value+"%"+bsp},_buildQuestionOptions:function(){var self=this,seriesOptions={isTable:false,isCompared:self.summary.type==="compare"},benchmarkRollup=self.question.getBenchmarkRollup(),segmentName=benchmarkRollup?benchmarkRollup.getSegmentName():"Unknown segment",chartOptions,categories,series;series=self.buildTop2StackedSeries(seriesOptions);if(seriesOptions.isCompared){categories=self.buildCategories(self.columns)}else{categories=[Globalize.localize("Your Responses")]}categories.push(segmentName);chartOptions={xAxis:self._buildXAxisOptions(categories),series:series,yAxis:self._buildYAxisOptions(series),plotOptions:{series:{dataLabels:{style:{color:"#FFF",fontSize:"14px"},formatter:self._top2LabelFormatter}}}};if(self.displayData.benchmark_chart_type==="top2_hbar"){chartOptions.chart={marginLeft:135};chartOptions.xAxis.labels.formatter=function(){return SM.Highcharts.formatAxisLabel(this.value,135,2)};chartOptions.plotOptions.series.dataLabels.align="left";chartOptions.plotOptions.series.dataLabels.verticalAlign="middle"}else if(self.displayData.benchmark_chart_type==="top2_vbar"){chartOptions.plotOptions.series.dataLabels.align="center";chartOptions.plotOptions.series.dataLabels.verticalAlign="bottom"}return[chartOptions]},_buildChartOptions:function(series,xAxisLabels,$container,chartIndex){var options=SM.BaseSummaryChartView._buildChartOptions.call(this,series,xAxisLabels,$container,chartIndex),chart=options.chart;if(this.question.isCompared()&&this.showBenchmark&&this.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.top2_hbar){chart.height=chart.marginBottom+25+(this.answerStructures.crossedOptions.length+1)*70}if(chart.height-chart.marginBottom<215){chart.height=215+chart.marginBottom}return options}}));SM.SummaryQuizSummaryChartView=SM.Views.register(SM.Object.deepExtend(SM.SummarySeriesFactory,{__NAME:"summaryQuizSummaryChartView",__templateID:"summary-quiz-summary-chart-template",XAXIS_LABELS:["0-10%","11-20%","21-30%","31-40%","41-50%","51-50%","61-70%","71-80%","81-90%","91-100%"],__create:function(options){var self=this;self.question=options.quizSummary;self.rollup=self.question.getRollup();self.display=self.rollup.display;self._createAsSummarizable(_.extend(options,{question:self.question,noLabelByWeight:true,noLabelBySidi:true}));self.quizChartOptions=SM.Object.deepCopy(SM.Highcharts.QUIZ_SUMMARY_CHART_OPTIONS);_.bindAll(this,"_compileChartOptions","_renderChart")},__beforeRender:function(){var self=this;self._getDisplayOptions();self._getChartMetadata();self._getSortedSummaryData()},__afterRender:function(){var self=this,quizSummaryOptionsList,chartOptionsList,noResponsesTemplate="no-matching-responses-template";self.$el.empty();self.seriesList=[];quizSummaryOptionsList=[self._buildSimpleChartOptions()];chartOptionsList=_.map(quizSummaryOptionsList,self._compileChartOptions);if(_.size(chartOptionsList[0].series)===0){self.$el.html(SM.Template.render(noResponsesTemplate,{isBenchmarkable:false,classes:"mod-no-header"}));return}_.each(chartOptionsList,self._renderChart)},_compileChartOptions:function(quizSummaryOptions,chartIndex){var self=this,chartOptions,eventOptions,tooltipOptions,compiledOptions,series=quizSummaryOptions.series,xAxisLabels=quizSummaryOptions.xAxis.categories,$chartContainer=$("<div></div>");$chartContainer.attr("chart-type",self.chartType);if(self.question.survey.isExport){$chartContainer.addClass("sm-chart")}self.seriesList.push(series);chartOptions=self._buildChartOptions(series,xAxisLabels,$chartContainer,chartIndex);eventOptions=self._buildEventOptions($chartContainer);tooltipOptions=self._buildTooltipOptions();self._setDataLabelCoordinates(series,quizSummaryOptions.yAxis,chartOptions.chart);compiledOptions=SM.Object.deepExtend(self.quizChartOptions,chartOptions,eventOptions,tooltipOptions,quizSummaryOptions);return compiledOptions},_renderChart:function(chartOptions){var self=this,$chartContainer=$(chartOptions.chart.renderTo),chart=new Highcharts.Chart(chartOptions,function(){});self.$el.append($chartContainer);if(!SM.App.isSharingApp()){SM.Highcharts.bindYAxisEvents($chartContainer,chart.yAxis[0]);SM.Highcharts.bindAreaChartEvents($chartContainer);SM.Highcharts.bindXAxisEvents($chartContainer)}},_getChartMetadata:function(){var self=this;self.chartMetadata=self.rollup.display.getDisplayData();self.chartType=self.chartMetadata.chart_type;self.scaleType="absolute";self.scaleIsPercent=false;self.hideEmptyData=false;self.highchartsChartType="column"},_buildSimpleChartOptions:function(){var self=this,sortedRows=self.sortedRowsList[0],categories=_.map(sortedRows,function(item){return item.value}),series=self.buildSimpleSeries(self.summary,sortedRows);return{xAxis:{categories:categories,title:{text:Globalize.localize("Score"),offset:28},labels:{formatter:function(){var total=parseInt(this.axis.categories[0],10),index=this.value/total-1;return self.XAXIS_LABELS[index]}}},series:series,yAxis:self._buildYAxisOptions(series)}},_buildChartOptions:function(series,xAxisLabels,$container,chartIndex){var self=this,labelHeight=SM.Highcharts.calculateXAxisLabelHeight(self.highchartsChartType,xAxisLabels);return{chart:{type:self.highchartsChartType,width:625,height:SM.Highcharts.calculateChartHeight(self.highchartsChartType,{answerStructures:self.answerStructures,titleHeight:0,labelHeight:labelHeight,legendHeight:0,isDistribution:false,isCompared:false,isStacked:false,isMirrored:false,chartIndex:chartIndex}),marginBottom:SM.Highcharts.calculateMarginBottom(labelHeight,5),renderTo:$container[0]}}},_buildEventOptions:function(){var eventOptions;if(SM.App.isSharingApp()){return}eventOptions={plotOptions:{series:{point:{events:{mouseOver:SM.Highcharts.onPointMouseOver,mouseOut:SM.Highcharts.onPointMouseOut}}}}};return eventOptions},_buildYAxisOptions:function(series){var yAxisOptions={title:{text:Globalize.localize("Number of respondents")}},highcharts=SM.Highcharts,range=highcharts.calculateSeriesRange(series),scaleOptions=highcharts.calculateYAxisScaleOptions(Math.max(range.max,-range.min)),newOptions=highcharts.calculateYAxisScaleOptions(scaleOptions.max,scaleOptions.min);scaleOptions.tickInterval=newOptions.tickInterval;SM.Object.deepUpdate(yAxisOptions,scaleOptions);return yAxisOptions},_buildTooltipOptions:function(){var self=this;return{tooltip:{formatter:function(){var absoluteY=SM.Highcharts.formatYValue(this.point.absoluteY,"absolute",0),index=this.point.x,startIndex=index===0?0:index/10+.01,total=parseInt(this.point.category,10)/(index+1);return SM.Template.render("summary-quiz-summary-chart-tooltip-template",{absoluteY:absoluteY,label:self.XAXIS_LABELS[index],startVal:Globalize.format(total*startIndex,"n1"),endVal:Globalize.format(total*(index+1)/10,"n1"),total:Globalize.format(total,"n0")})}}}},_setDataLabelCoordinates:function(series){var self=this;_.each(series,function(seriesItem){_.each(seriesItem.data,function(data){var label;if(data.y){label=SM.Highcharts.formatYValue(data.y,self.scaleType,self.decimalPlaces);data.dataLabels={x:0,y:Math.max(-label.length*10,30)}}})})}}));SM.SummaryTMBCChartContainerView=SM.Views.register({__NAME:"summaryTMBCChartContainerView",__templateID:"summary-tmbc-chart-container-template",__model:"tmbc",__create:function(options){var self=this;if(self.get("isTop2")){self.question=options.question;self.survey=self.question.survey}else{self.survey=self.tmbc.survey}self.tmbcType=options.tmbcType;self.chartType=options.chartType;self.questionView=options.questionView},__beforeRender:function(){return{isShown:true}},__afterRender:function(){var self=this,chartView,viewType,benchmarkDisplay=self.get("showBenchmark");if(self._shouldHideChart()){return}try{if(self.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.donut||self.get("isTop2")){viewType=SM.TMBCSummaryChartView;self.$el.addClass("short")}else{viewType=SM.TMBCBoxPlotView}chartView=SM.Views.create(viewType,{model:self.tmbc,tmbcType:self.tmbcType,benchmarkDisplay:benchmarkDisplay,questionView:self.questionView,question:self.question});self.$el.html(chartView.el);self.chartView=chartView}catch(exception){self._handleRenderingError(exception)}},_shouldHideChart:function(){return false},_handleRenderingError:function(exception){var self=this,div;div=document.createElement("div");div.innerHTML=SM.Template.render("summary-chart-display-error-template");self.$el.html(div);SM.Error.log(exception,"tmbc summary chart rendering error")},__init:function(){},_onDisplayChange:function(e){var self=e.data.self;if(self.question.hasRandomAssignment()&&!!self.randomAssignmentOption){self.question.randomAssignmentOption=self.randomAssignmentOption}self.render()}});SM.TMBCSummaryChartView=SM.Views.register({__NAME:"TMBCSummaryChartView",__templateID:"summary-chart-template",__model:"tmbc",TEXT_RADIUS:115,CHAR_W:7,CHAR_H:12,COLOR_EMPTY:"#CCC",TMBC_COLOR_OPTIONS:{colors:["#A9BD38","#E0E0E0"]},TMBC_CHART_OPTIONS:{chart:{width:328,height:215,noResponses:false,margin:[0,0,0,0],spacingTop:0,spacingBottom:0,spacingLeft:0,spacingRight:0,style:{fontFamily:"Arial"},plotBackgroundColor:"#FFF",type:"pie",renderTo:{},events:{}},title:{text:null},colors:["#2D606F","#E0E0E0"],plotOptions:{series:{animation:false,point:{events:{}},events:{},innerSize:156},pie:{size:186,marker:{states:{hover:{enabled:false}}},center:["50%","50%"],colorByPoint:true,borderWidth:1,borderColor:null,dataLabels:{enabled:false},startAngle:0,endAngle:360.5}},labels:[],legend:{enabled:false},tooltip:{enabled:false},credits:{enabled:false},series:[{data:[{y:1},{y:1}]}]},__create:function(options){this.chartType=SM.QuestionDisplayModel.DISPLAY_VALUES.donut;this.tmbcType=options.tmbcType;this.benchmarkDisplay=options.benchmarkDisplay;if(SM.Browser.isIE8){this.TMBC_CHART_OPTIONS.plotOptions.pie.borderWidth=0}this.isTop2=options.question?options.question.isTop2():false;this.survey=options.question?options.question.survey:this.tmbc.survey;if(this.isTop2){this.summary=options.summary;this.series=options.series;this.rollup=options.question.getRollup()}this.DEFAULT_HIGHCHARTS_OPTIONS=SM.Object.deepExtend(SM.Highcharts.DEFAULT_OPTIONS,{plotOptions:{series:{dataLabels:{formatter:this._formatDataLabel}}}});_.bindAll(this,"_compileChartOptions","_renderChart")},__afterRender:function(){var self=this,questionOptionsList,chartOptionsList,survey=this.survey,md={};if(!this.isTop2&&this.tmbc.hasError()){this.$el.addClass("bm-error");md.notApplicable=this.tmbc.getError()==="no_access";md.noData=this.tmbc.getError()==="no_data";md.isNPS=true;md.user_id=survey.currentUserID;md.name=this.tmbc.getSegmentName();md.useBMStr=md.name.indexOf("Benchmark")===-1;md.source="tmbc";this.$el.html(SM.Template.render("summary-benchmark-data-not-available-template",md));return}this.$el.removeClass("bm-error");this.$el.addClass("sm-bm-nps");if(this.isTop2){this.$el.addClass("top2")}self.$el.empty();self.seriesList=[];self.$el.empty();self.seriesList=[];if(self.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.donut){_.bindAll(this,"_renderTMBCShapes");self._renderTMBCChart();return}questionOptionsList=self._buildQuestionOptions();chartOptionsList=_.map(questionOptionsList,self._compileChartOptions);_.each(chartOptionsList,self._renderChart)},__init:function(){this.$el.on(SM.Event.CLICK,"[cta]",{self:this},this._onBuyBenchmarksClicked)},_compileChartOptions:function(questionOptions,chartIndex){var self=this,chartOptions,eventOptions,plotOptions,tooltipOptions,legendOptions,colorOptions,compiledOptions,series,xAxisLabels,$chartContainer;$chartContainer=$("<div></div>");$chartContainer.attr("chart-type",self.chartType);series=questionOptions.series;self.seriesList.push(series);xAxisLabels=questionOptions.xAxis.categories;chartOptions=self._buildChartOptions(series,xAxisLabels,$chartContainer,chartIndex);eventOptions=self._buildEventOptions($chartContainer);colorOptions=self._buildColorOptions();plotOptions=self._buildPlotOptions(series);tooltipOptions=self._buildTooltipOptions();legendOptions=self._buildLegendOptions();self._setDataLabelCoordinates(series,questionOptions.yAxis,chartOptions.chart);compiledOptions=SM.Object.deepExtend(self.DEFAULT_HIGHCHARTS_OPTIONS,chartOptions,eventOptions,colorOptions,plotOptions,tooltipOptions,legendOptions,questionOptions);return compiledOptions},_renderChart:function(chartOptions){var self=this,chart,$chartContainer=$(chartOptions.chart.renderTo),cb;self.$el.append($chartContainer);if(self.isBoxplot){cb=self._renderBoxPlotLabels}else{cb=function(){}}chart=new Highcharts.Chart(chartOptions,cb);self._bindEvents($chartContainer,chart)},_onBuyBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),href=$tgt.attr("link"),source=$tgt.attr("source");e.preventDefault();e.stopPropagation();SM.Bi.benchmarkingAbout(self.question.ID,source,href,self.question.isNPS());href=href+"?param="+self.question.survey.currentUserID;window.open(href,"_blank")},_renderTMBCShapes:function(chart){var self=this,isExport=self.survey.isExport,score,$container;if(chart.userOptions.chart.isBenchmark){$container=self._$bmNpsCtnr;if(self.isTop2){score=Math.round(self.series[1].data[1].y*10)/10}else{score=Math.round(self.tmbc.getTMBCBenchmarkValue(self.tmbcType))}}else{$container=self._$userNpsCtnr;if(self.isTop2){score=Math.round(self.series[0].data[0].y*10)/10}else{score=Math.round(self.tmbc.getTMBCValue(self.tmbcType))}}SM.Highcharts.renderTMBCShapes(chart,score,$container,isExport)},_renderTMBCChart:function(){var self=this,chartOptions,userTitle,userTemplate,bmTemplate,score,grade,answered=0,skipped=0,segmentName="Segment";self.$el.addClass("sm-bm-nps");chartOptions=$.extend(true,{},self.TMBC_CHART_OPTIONS);chartOptions.chart.showingBenchmark=self.benchmarkDisplay;chartOptions.chart.tmbcType=self.tmbcType;chartOptions.chart.isTop2=self.isTop2;if(self.benchmarkDisplay){if(self.isTop2){userTitle=$("<div/>").html(self.series[0].name).text();answered=self.rollup.answered;skipped=self.rollup.skipped;segmentName=self.survey.benchmarkRollups.getSegmentName()}else{userTitle=$("<div/>").html(self.tmbc.getTMBCName(self.tmbcType)).text();segmentName=self.tmbc.getSegmentName()}userTemplate=SM.Template.render("tmbc-chart-template",{title:userTitle,side:"left",isBenchmark:false,isTop2:self.isTop2,answered:answered,skipped:skipped});bmTemplate=SM.Template.render("tmbc-chart-template",{title:segmentName,isTop2:self.isTop2,side:"right",isBenchmark:true});self.$el.append($(userTemplate));self.$el.append($(bmTemplate));self._$userNpsCtnr=self.$el.find(".sm-bm-nps-chart.left");self._$bmNpsCtnr=self.$el.find(".sm-bm-nps-chart.right")}else{self.$el.addClass("tmbc");self._$userNpsCtnr=self.$el;chartOptions.chart.width*=2}if(self.isTop2){score=self.series[0].data[0].y}else{score=self.tmbc.getTMBCValue(self.tmbcType)}if(self.tmbcType===SM.TMBCModel.TMBC_TYPE_GEI){grade=self.tmbc.getGrade(score);chartOptions.tooltip.settings={grade:grade.grade};chartOptions.tooltip.settings[grade.key]=true;score=score/1.1}else{chartOptions.tooltip.settings={}}if(self.isTop2){chartOptions.chart.score=Math.round(score*10)/10}else{chartOptions.chart.score=Math.round(score)}if(score<1){score=50;chartOptions.colors[0]=chartOptions.colors[1];chartOptions.plotOptions.pie.borderColor=chartOptions.colors[0]}else if(score>99){score=50;chartOptions.colors[1]=chartOptions.colors[0];chartOptions.plotOptions.pie.borderColor=chartOptions.colors[0]}chartOptions.series[0].data[0].y=score;chartOptions.series[0].data[1].y=100-score;self._$userNpsCtnr.highcharts(chartOptions,self._renderTMBCShapes);if(self.benchmarkDisplay){chartOptions=$.extend(true,{},self.TMBC_CHART_OPTIONS,self.TMBC_COLOR_OPTIONS);chartOptions.chart.showingBenchmark=self.benchmarkDisplay;chartOptions.chart.tmbcType=self.tmbcType;if(self.isTop2){score=self.series[1].data[1].y;chartOptions.chart.isTop2=true}else{score=self.tmbc.getTMBCBenchmarkValue(self.tmbcType)}if(self.tmbcType===SM.TMBCModel.TMBC_TYPE_GEI){score=score/1.1}if(self.isTop2){chartOptions.chart.score=Math.round(score*10)/10}else{chartOptions.chart.score=Math.round(score)}if(score<1){score=50;chartOptions.colors[0]=chartOptions.colors[1];chartOptions.plotOptions.pie.borderColor=chartOptions.colors[0]}else if(score>99){score=50;chartOptions.colors[1]=chartOptions.colors[0];chartOptions.plotOptions.pie.borderColor=chartOptions.colors[0]}chartOptions.series[0].data[0].y=score;chartOptions.series[0].data[1].y=100-score;chartOptions.chart.isBenchmark=true;self._$bmNpsCtnr.highcharts(chartOptions,self._renderTMBCShapes)}}});SM.TMBCBoxPlotView=SM.Views.register({__NAME:"TMBCBoxPlotView",__templateID:"summary-chart-template",__model:"tmbc",__create:function(options){this.chartType="boxplot";this.isBoxplot=true;this.tmbcType=options.tmbcType;this.highchartsChartType="boxplot";this.hasLegend=true;this.DEFAULT_HIGHCHARTS_OPTIONS=SM.Object.deepExtend(SM.Highcharts.DEFAULT_OPTIONS,{chart:{forcePercent:this.tmbcType===this.tmbc.TMBC_TYPE_ENGAGEMENT},plotOptions:{series:{dataLabels:{formatter:this._formatDataLabel}}}});_.bindAll(this,"_compileChartOptions","_renderChart")},__afterRender:function(){var self=this,questionOptionsList,chartOptionsList,survey=this.tmbc.survey,md={};if(this.showBenchmark&&(this.tmbc.hasError()||this.tmbc.wasEdited())){this.$el.addClass("bm-error");md.notApplicable=this.tmbc.getError()==="no_access";md.noData=this.tmbc.getError()==="no_data";md.wasEdited=this.tmbc.wasEdited();md.isNPS=false;md.user_id=survey.currentUserID;md.name=this.tmbc.getSegmentName();md.source="tmbc";this.$el.html(SM.Template.render("tmbc-data-not-available-template",md));return}this.$el.removeClass("bm-error");_.bindAll(this,"_renderBoxPlotLabels");self.$el.empty();self.seriesList=[];questionOptionsList=self._buildQuestionOptions();chartOptionsList=_.map(questionOptionsList,self._compileChartOptions);_.each(chartOptionsList,self._renderChart)},__init:function(){},_buildPlotOptions:function(){var self=this,options={plotOptions:{series:{}}};options.plotOptions[self.highchartsChartType]={colorByPoint:false,borderWidth:0,dataLabels:{enabled:self.showDataLabels,x:10,y:0}};return options},_buildTooltipOptions:function(){var self=this,options={tooltip:{}};if(self.showDataLabels){options.tooltip.enabled=false}return options},_buildLegendOptions:function(){var options={legend:{enabled:true}};options.legend.x=75;options.legend.align="left";options.legend.width=514;return options},_compileChartOptions:function(questionOptions,chartIndex){var self=this,chartOptions,eventOptions,plotOptions,tooltipOptions,legendOptions,colorOptions,compiledOptions,series,xAxisLabels,$chartContainer;$chartContainer=$("<div></div>");$chartContainer.attr("chart-type",self.chartType);series=questionOptions.series;self.seriesList.push(series);xAxisLabels=questionOptions.xAxis.categories;chartOptions=self._buildChartOptions(series,xAxisLabels,$chartContainer,chartIndex);eventOptions=self._buildEventOptions($chartContainer);colorOptions=self._buildColorOptions();plotOptions=self._buildPlotOptions(series);tooltipOptions=self._buildTooltipOptions();legendOptions=self._buildLegendOptions();compiledOptions=SM.Object.deepExtend(self.DEFAULT_HIGHCHARTS_OPTIONS,chartOptions,eventOptions,colorOptions,plotOptions,tooltipOptions,legendOptions,questionOptions);return compiledOptions},_renderChart:function(chartOptions){var self=this,$chartContainer=$(chartOptions.chart.renderTo),cb;self.$el.append($chartContainer);if(self.isBoxplot){cb=self._renderBoxPlotLabels}else{cb=function(){}}return new Highcharts.Chart(chartOptions,cb)},_buildQuestionOptions:function(){var optionsList=[];if(this.isBoxplot){optionsList=[this._buildBoxPlotOptions()]}return optionsList},BOXPLOT_LINE_WIDTH:4,BOXPLOT_MEDIAN_WIDTH:2,BOXPLOT_MEDIAN_COLOR:"#FFFFFF",BOXPLOT_USER_VALUE_LINE_WIDTH:2,_buildTMBCQuartileChartSeries:function(options){var quartileValues=this.tmbc.getQuartileValues(this.tmbcType),tmbcValue,series=[],seriesData=[],chartColor=options.colors[0],userColors=SM.Highcharts.DEFAULT_BENCHMARK_COLORS.slice(1),scoreName;options.names=[Globalize.localize("Minimum"),Globalize.localize("Lower Quartile"),Globalize.localize("Median"),Globalize.localize("Upper Quartile"),Globalize.localize("Maximum")];tmbcValue=this.tmbc.getTMBCValue(this.tmbcType);scoreName=Globalize.localize("Your average");series.push({name:scoreName,color:userColors[0],lineWidth:this.BOXPLOT_USER_VALUE_LINE_WIDTH,data:[{y:tmbcValue,absoluteY:tmbcValue,percentageY:tmbcValue,name:scoreName}]});_.each(quartileValues,function(value,index){seriesData.push({y:value,absoluteY:value,percentageY:value,name:options.names[index]})});seriesData=[[],[],seriesData,[]];series.push({name:this.tmbc.getSegmentName(),pointWidth:58,data:seriesData,tooltip:{headerFormat:"<em>Experiment No {point.key}</em><br/>"},color:chartColor,fillColor:chartColor,stemColor:chartColor,stemWidth:this.BOXPLOT_LINE_WIDTH,whiskerColor:chartColor,whiskerWidth:this.BOXPLOT_LINE_WIDTH,medianColor:this.BOXPLOT_MEDIAN_COLOR,medianWidth:this.BOXPLOT_MEDIAN_WIDTH,__options:{dimensionType:"benchmark"}});
return series},_fixBoxPlotSeries:function(series){var simpleData=[],dataIndex=2,boxplotSeries;boxplotSeries=_.filter(series,function(seriesItem){if(seriesItem.__options&&seriesItem.__options.dimensionType==="benchmark"){return seriesItem}});_.each(boxplotSeries[0].data[dataIndex],function(item){simpleData.push(item.y)});boxplotSeries[0].data[dataIndex]=simpleData;this.dataBoxPlot=simpleData;return series},_buildBoxPlotOptions:function(){var boxPlotYAxisLabelFormatter=function(){var maxWidth=this.axis.width/3,maxNumLines=SM.Highcharts.X_AXIS_MAX_VISIBLE_LINES,label=this.value,formatType;if(self.tmbcType===self.tmbc.TMBC_TYPE_ENGAGEMENT){formatType=SM.Highcharts.getGlobalizeFormatType("percent",0);label=Globalize.format(this.value/100,formatType)}return SM.Highcharts.formatAxisLabel(label,maxWidth,maxNumLines)},self=this,colorOptions={colors:SM.Highcharts.DEFAULT_BENCHMARK_COLORS},responseMean,meanWidth=2,benchmarkSeries=this._buildTMBCQuartileChartSeries(colorOptions),min=0,max=self.tmbcType===self.tmbc.TMBC_TYPE_GEI?110:100,tickInterval=self.tmbcType===self.tmbc.TMBC_TYPE_GEI?27.5:25,chartOptions={chart:{type:"boxplot",inverted:true,width:SM.Highcharts.CHART_WIDTH,isNPS:false},plotOptions:{boxplot:{dataLabels:{enabled:true}}},xAxis:{categories:["","","",""]},yAxis:{tickInterval:tickInterval,min:min,max:max,labels:{formatter:boxPlotYAxisLabelFormatter}},legend:{labelFormatter:SM.Highcharts.legendUnescapedFormatter},series:this._fixBoxPlotSeries(benchmarkSeries),tooltip:{enabled:false}};responseMean=this.tmbc.getTMBCValue(this.tmbcType);chartOptions.yAxis.plotLines=[{__options:{grade:this.tmbc.getGrade(responseMean),tmbcType:this.tmbcType},value:responseMean,color:colorOptions.colors[1],width:meanWidth,zIndex:100,events:{mouseover:self._tmbcMouseOver,mouseout:self._tmbcMouseOut}}];this.dataPlotLabels=[responseMean];chartOptions.yAxis.gridLineColor="#FFF";return chartOptions},buildCategories:function(mappableItems){return _.map(mappableItems,function(item){var text=item.text.replace(/\/([^\s])/g,"/ $1");return text})},_buildChartOptions:function(series,xAxisLabels,$container){var self=this,numSeries=series.length,numXAxisLabels=_.isEmpty(xAxisLabels)?0:xAxisLabels.length,titleHeight=self.hasTitle?self.TITLE_HEIGHT:0,labelHeight=self.hasXAxis?SM.Highcharts.calculateXAxisLabelHeight(self.highchartsChartType,xAxisLabels):0,legendHeight=self.hasLegend?SM.Highcharts.calculateLegendHeight(series):0;var chartOptions={chart:{type:self.highchartsChartType,width:SM.Highcharts.calculateChartWidth(self.highchartsChartType,{numSeries:numSeries,numXAxisLabels:numXAxisLabels,isStacked:self.isStacked,isCompared:self.isCompared}),height:SM.Highcharts.calculateChartHeight(self.highchartsChartType,{answerStructures:{rows:[0,50,100],cols:[]},titleHeight:titleHeight,labelHeight:labelHeight,legendHeight:legendHeight,isDistribution:true,isCompared:false,isStacked:false,isMirrored:false,chartIndex:0})-25,marginTop:SM.Highcharts.calculateMarginTop(0,titleHeight),marginBottom:SM.Highcharts.calculateMarginBottom(labelHeight,legendHeight),renderTo:$container[0]}};return chartOptions},_tmbcMouseOver:function(e){var self=this,seriesItem=self.axis.chart.series[0],userOptions=self.axis.chart.userOptions.yAxis.plotLines[0].__options,$tgt=$(e.currentTarget),$legendItem=$(seriesItem.legendItem.element);if($legendItem.length){$legendItem.toggleClass("point-hovered")}if(userOptions.tmbcType==="tmbc_engagement"){return}if($tgt.find(".popout.tmbc").length<1){$tgt.append('<div class="popout sidi-popout tmbc"></div>')}if(self._tmbcpopout){self._tmbcpopout.__settings.offsetY=e.offsetY}else{userOptions.grade.offsetY=e.offsetY;self._tmbcpopout=$tgt.tmbcpopout(userOptions.grade).data("tmbcpopout");self._tmbcpopout._beforeShow()}self._tmbcpopout._isHovered=true;self._tmbcpopout._show()},_tmbcMouseOut:function(){var seriesItem=this.axis.chart.series[0],$legendItem=$(seriesItem.legendItem.element);if($legendItem.length){$legendItem.toggleClass("point-hovered")}},_buildEventOptions:function(){if(SM.App.isSharingApp()){return}return{plotOptions:{series:{point:{events:{mouseOver:SM.Highcharts.onPointMouseOver,mouseOut:SM.Highcharts.onPointMouseOver}}}}}},_buildColorOptions:function(){return{}},_hasLegend:function(){return!!this.isBoxplot},_renderBoxPlotLabels:function(chart){var self=this,data=self.dataBoxPlot;SM.Highcharts.renderBoxPlotLabels(chart,data);if(self.dataPlotLabels){SM.Highcharts.renderBoxPlotLabels(chart,self.dataPlotLabels,true)}}});SM.SummaryTableContainerView=SM.Views.register({__NAME:"SummaryTableContainerView",__templateID:"summary-table-container-template",__create:function(options){var self=this;self.survey=options.survey;self.question=options.question;self.rollup=self.question.getRollup();self.display=self.rollup.display;self.tableViewType=options.tableViewType;self.hasBenchmarkingOptions=options.hasBenchmarkingOptions;self.isExport=options.isExport;self.randomAssignmentOption=options.randomAssignmentOption;self._showingBenchmark=self.display.getDisplayData().show_benchmark;self.benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.ID);if(self.hasBenchmarkingOptions&&self.question.isTop2()){self.isTop2=self.display.isTop2()}_.bindAll(this,"_onTableDisplayChange","_onDisplaySaving","_setHighlightedLabelCell")},__init:function(){var self=this;self.bindModel(self.display,"displayChange",{self:self},self._onTableDisplayChange);self.bindModel(self.display,"tempDisplayChange",{self:self},self._onTableDisplayChange);self.bindModel(self.display,"allDisplaysChange",{self:self},self._onTableDisplayChange);self.bindModel(self.display,"saving",{self:self},self._onDisplaySaving);if(self.benchmarkRollup){self.benchmarkRollup.rollupList.on("benchmarkRollupLoaded",{self:self},self._onBenchmarkRollupLoaded);self.bindModel(self.benchmarkRollup,"revertBenchmarkRollup",{self:self},self._onRevertBenchmarkRollup)}self.$el.on("setHighlightedLabelCell",self._setHighlightedLabelCell)},__afterRender:function(){var self=this,tableView,tableViewType,footerView,showBasicStats,isComparedNpsBenchmark,title,question=self.question,$el=self.$el,spacerClass=question.isTop2()?" top2":"";if(self._shouldHideTable()){return}try{if(question.isTop2()){$el.addClass("top2")}$el.html("");if(question.isQuiz()&&parseInt(self.rollup.answered,10)>0){tableView=SM.Views.create(SM.QuizStatsTableView,{question:question,isBasicStats:showBasicStats,highlightedDimensionID:self.highlightedDimensionID,isExport:self.isExport,isTop2:self.isTop2});$el.append(tableView.el);$el.append($('<div class="sm-bs-space'+spacerClass+'"></div>'))}tableViewType=self._getTableViewType();tableView=SM.Views.create(tableViewType,{question:question,highlightedDimensionID:self.highlightedDimensionID,isExport:self.isExport,isTop2:self.isTop2});if(question.isNPS()&&!tableView.isNPSScoreValid()&&!self._hasBenchmarking()){return}$el.append(tableView.el);showBasicStats=!question.isQuiz()&&tableView.showBasicStats&&question.getRollup().hasBasicStats();tableViewType=self._getAuxiliaryTableViewType(showBasicStats);if(tableViewType){$el.append($('<div class="sm-bs-space'+spacerClass+'"></div>'));if(question.isTop2()){$el.append($('<div class="sm-bs-space top2 ledger"></div>'))}isComparedNpsBenchmark=self._hasBenchmarking()&&question.isNPS()&&question.isCompared();if(isComparedNpsBenchmark){title=SM.Template.render("benchmark-nps-distribution-table-title",{});$el.append($(title))}tableView=SM.Views.create(tableViewType,{question:question,isBasicStats:showBasicStats,highlightedDimensionID:self.highlightedDimensionID,isExport:self.isExport,isTop2:self.isTop2});$el.append(tableView.el);if(isComparedNpsBenchmark){$el.append($('<div class="sm-bs-space"></div>'));tableView=SM.Views.create(SM.BenchmarkNpsDistributionTableView,{question:question,highlightedDimensionID:self.highlightedDimensionID,isExport:self.isExport});$el.append(tableView.el)}}if(!SM.App.isSharingApp()&&!self.isExport&&!self._hasBenchmarking()){footerView=SM.Views.create(SM.CombineHideFooterView,{rollup:self.rollup,isMultiple:true,isSingle:true,isNone:false});$el.append(footerView.el)}}catch(exception){self._handleRenderingError(exception)}},_hasBenchmarking:function(){return this.hasBenchmarkingOptions&&this.survey.owner.hasBenchmarking()&&this._showingBenchmark},_getTableViewType:function(){var self=this,question=self.question,tableViewType;if(self._hasBenchmarking()){if(!question.isNPS()&&self.display.getDisplayData().isDistribution&&self.display.getChartType()!=="boxplot"){if(question.isCompared()){tableViewType=SM.ComparedMatrixSummaryTableView}else{tableViewType=SM.BenchmarkMatrixTableView}}else{tableViewType=SM.BenchmarkQuartileTableView}}else if(question.isNPS()){if(question.isCompared()){tableViewType=SM.NpsComparedMatrixSummaryTableView}else{tableViewType=SM.NpsSimpleSummaryTableView}}else if(question.isCompared()){if(question.isMenuMatrix()){tableViewType=SM.ComparedMenuMatrixSummaryTablesView}else{tableViewType=SM.ComparedMatrixSummaryTableView}}else{if(question.isMenuMatrix()){tableViewType=SM.MenuMatrixSummaryTablesView}else if(question.isMatrix()){tableViewType=SM.MatrixSummaryTableView}else if(question.isNumerical()){tableViewType=SM.NumericalSummaryTableView}else if(question.isQuiz()){tableViewType=SM.QuizSummaryTableView}else{tableViewType=SM.SimpleSummaryTableView}}return tableViewType},_getAuxiliaryTableViewType:function(showBasicStats){var self=this,question=self.question;if(question.isQuiz()){return null}if(self._hasBenchmarking()&&(question.isNPS()||question.isCompared())){if(self.benchmarkRollup.hasError()){return null}if(question.isNPS()){if(question.isCompared()){return SM.NpsComparedMatrixSummaryTableView}return SM.BenchmarkNpsDistributionTableView}if(self.display.getChartType()==="boxplot"){return SM.ComparedAverageTableView}return SM.BenchmarkDistributionTableView}if(showBasicStats&&!self._hasBenchmarking()){if(question.isMenuMatrix()){return}if(question.isCompared()&&question.isNumerical()){return SM.MenuMatrixBasicStatsTableView}if(question.isSimpleRating()){return SM.SimpleBasicStatsTableView}if(question.isCompared()||question.isMatrix()||question.isNumerical()){return SM.MatrixBasicStatsTableView}if(question.isSimple()){return SM.SimpleBasicStatsTableView}}return null},_shouldHideTable:function(){var self=this,display=self.display.getDisplayData(),survey,benchmarkRollup;if(!display.show_table){return true}if(display.show_benchmark){survey=self.question.survey;benchmarkRollup=survey.getBenchmarkRollup(self.question.ID);return benchmarkRollup.hasError()}return false},_handleRenderingError:function(exception){var self=this,div;div=document.createElement("div");div.innerHTML=SM.Template.render("summary-table-display-error-template");self.$el.html(div);SM.Error.log(exception,"question summary table rendering error, QuestionID: "+self.question.ID)},_setHighlightedLabelCell:function(e){var self=this;self.highlightedDimensionID=e.answerID},_unsetHighlightedLabelCell:function(){var self=this;self.highlightedDimensionID=null},_onTableDisplayChange:function(){var self=this;if(self.question.hasRandomAssignment()&&!!self.randomAssignmentOption){self.question.randomAssignmentOption=self.randomAssignmentOption}self.render()},_onDisplaySaving:function(){var self=this;self._unsetHighlightedLabelCell()},_onBenchmarkRollupLoaded:function(e){var self=e.data.self,questionID=e.questionID;if(questionID===self.question.ID){self._showingBenchmark=true;self.render()}},_onRevertBenchmarkRollup:function(e){var self=e.data.self;self._showingBenchmark=false;self.render()}});SM.BaseSummaryTableView=SM.Object.deepExtend(SM.SummarySeriesFactory,{__defaults:{tableOptions:{headingsType:null,showFooter:false,hideExpandLinks:false},seriesOptions:{},seriesData:{},labelsData:{}},__create:function(options){var self=this;if(!options.question.survey.owner.canSigDiffs()){options=_.extend(options,{noLabelBySidi:true})}self._createAsSummarizable(options);self._buildLocalizedLabels();self._bindEvents(options.events);self._runIntegrityChecks();self.seriesOptions=self.__settings.seriesOptions;self.tableOptions=self.__settings.tableOptions;self.isExport=options.isExport;self.highlightedDimensionID=options.highlightedDimensionID},_runIntegrityChecks:function(){var self=this;if(self.__settings.tableOptions.headingsType===undefined){throw new Error('You must define tableOptions.headingsType as one of "series" or "labels"')}},_buildLocalizedLabels:function(){var self=this;self.localizedLabels={answerChoices:Globalize.localize("Answer Choices"),responses:Globalize.localize("Responses"),total:Globalize.localize("Total"),score:Globalize.localize("Net Promoter&#174; Score"),totalNumber:Globalize.localize("Total Number"),totalRespondents:Globalize.localize("Total Respondents"),averageNumber:Globalize.localize("Average Number"),averageRating:Globalize.localize("Weighted Average"),averageRanking:Globalize.localize("Score")}},_bindEvents:function(){_.bindAll(this,"_onCaptionClick","_onThClick","_onTdClick","_onThActionSelected","_onTAToggleLinkClick")},__beforeRender:function(){var self=this;self._getDisplayOptions();self._getSortedSummaryData();if(self._setSeriesOptions){self._setSeriesOptions(self.get("seriesOptions"))}},__afterRender:function(){var self=this;self.$el.empty();self._renderTable();self.$el.find(".q").popout();if(self.question.survey.owner.canSigDiffs()&&self.question.canSidi()&&!self.rollup.comparedByRA&&self.showSidi&&self.isMirrored){self._renderSidiPopout()}},_renderSidiPopout:function(){var self=this,isSharing=SM.App.isSharingApp(),isExport=self.question.survey.isExport,canBuy=Globalize.culture().name==="en",tableDataCells=self.$el.find("tbody td"),tableRowSelector="tr",tableCellSelector="td",tableSelector="table",tableHeaderSelector="th",captionSelector="caption";if(isExport){tableDataCells=self.$el.find("div[display=tbody] div[display=td]");tableSelector="div[display=table]";tableRowSelector="div[display=tr]";tableCellSelector="div[display=td]";tableHeaderSelector="div[display=th]";captionSelector="div[display=caption]"}tableDataCells.each(function(){var $td=$(this),$caption,$table,captionId,$tr,mid,$first_td,rowId,$th,colId,colTotals,tipSide,options;if(!$td.find(".sm-data-table-liner").length){return}$tr=$td.closest(tableRowSelector);$first_td=$tr.find(tableCellSelector+":first-child");mid=$tr.find(tableCellSelector).length/2;$table=$td.closest(tableSelector);if($table.hasClass("basic-stats-matrix-table")){return}rowId=$first_td.attr("data-dimension-id");if(!rowId){return}$th=$td.closest(tableSelector).find(tableHeaderSelector).eq($td.index());colId=$th.attr("data-dimension-id");colTotals=$th.attr("data-dimension-type")==="totals";if(colTotals){colTotals=parseInt($.trim($td.find(".sm-data-total").text()).replace(/[,\s]+|[,\s]+/g,""),10)<30}if(!colId&&!colTotals){return}if(colTotals&&isSharing){return}if(colId){if(self.question.isMenuMatrix()){$caption=$table.find(captionSelector);captionId=$caption.attr("data-dimension-id")}options=self.question.getSidiOptions(colId,rowId,captionId);if(!options){return}if(options.hasSidi){if(!isExport){$td.css({"background-color":"#D9E7E9"})}$td.append('<div class="sm-data-table-liner sm-data-sidi">'+options.groups+"</div>")}}else if(colTotals){options={hasSidi:false,needMore:true}}if(!isExport){$td.append('<div class="popout sidi-popout"></div>');tipSide=$td.index()<mid?"left":"right";options=_.extend(options,{question:self.question,surveyID:self.question.survey.ID,isSharing:isSharing,canBuy:canBuy,tipSide:tipSide});$td.sidipopout(options)}})},_renderTable:function(){var self=this;_.each(["_buildTableHeaderRowData","_buildTableBodyRowData","_buildTableFooterRowData"],function(method){if(self[method]===undefined){throw new Error("You must define "+method+" in "+self.__NAME)}});if(self.display.isBenchmarkShown()&&self.benchmarkSummary.hasError()){return}if(self._setLabelsAndSeriesData){self._setLabelsAndSeriesData()}if(self.showTitle&&self._renderTitle){self._renderTitle()}SM.Hightables.renderTable(self._getTableOptions());if(self.highlightedDimensionID){self._highlightLabelCell(self.highlightedDimensionID)}},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,"[ta-toggle-link]",{self:self},self._onTAToggleLinkClick);self.$el.on("actionMenu.actionSelected","th",{self:self},self._onThActionSelected);self.$el.on("actionMenu.actionSelected","td",{self:self},self._onTdActionSelected);self.$el.on("highlightLabelCell",function(e){self._highlightLabelCell(e.answerID)});self.$el.on("unHighlightLabelCell",function(e){self._unHighlightLabelCell(e.answerID)})},_highlightLabelCell:function(dimensionID){var self=this;self.$el.find(".highlight").removeClass("highlight");self.$el.find("[data-dimension-id='"+dimensionID+"']").addClass("highlight")},_unHighlightLabelCell:function(dimensionID){var self=this;self.$el.find("[data-dimension-id='"+dimensionID+"']").removeClass("highlight")},_getTableOptions:function(){var self=this,isExport=!!self.isExport;return{target:self.$el,tableData:self._getTableData(),tableClasses:self._getTableClasses(),useDivs:isExport,flattenNestedTables:isExport,events:self._getTableEvents()}},_getTableData:function(options){var self=this,captionData,theadRowData,tbodyRowData,tfootRowData;options=options||{};if(self._buildTableCaptionData&&self._enableCaption!==false){captionData=self._buildTableCaptionData(options)}tbodyRowData=self._buildTableBodyRowData(options);theadRowData=self._buildTableHeaderRowData(options);tfootRowData=self._buildTableFooterRowData(options);return{caption:captionData,thead:{rows:theadRowData},tbody:{rows:tbodyRowData},tfoot:{rows:tfootRowData}}},_getTableLabelsData:function(mappableItems){var self=this,question=self.question,useEmoji=false,summary,labelsData,labelData,responsesCount,canCombineHide;labelsData=_.map(mappableItems,function(item){if(question.isEmoji()&&item.type==="row"&&question.structure.answers.rows[0].text===item.text){useEmoji=true}labelData={dimensionID:item.id,labelText:item.text,useEmoji:useEmoji};if(item.mediaHTML){labelData.labelHTML=item.mediaHTML}if(self._labelCellHasComments(item)&&self._shouldShowCommentsInLabelCell()){summary=self.summary.summary.options[item.id];if(!!question.randomAssignmentOption){labelData.variationID=self.question.randomAssignmentOption.toString();if(self.questionFamily==="demographic"){summary=self.summary.summary.options[question.randomAssignmentOption]}}else{labelData.variationID="0"}if(summary){responsesCount=summary.count}else{responsesCount=0}labelData.hasComments=true;labelData.optionID=item.id;labelData.responsesCount=responsesCount}canCombineHide=self.rollup.combinehideModel.canCombineHide(item.id);labelData.hideActionMenu=!self._shouldShowTdActionMenu(item.id,canCombineHide);return labelData});return labelsData},_shouldShowTdActionMenu:function(dimensionID,canCombineHide){var self=this;if(self.question.isNPS()){if(!self.question.isCompared()){return false}if(!self.isMirrored){return false}}if(self.displayData.show_benchmark){return false}if(self.isBasicStats){return false}if(self.get("isBasicStats")){return false}return self._shouldAllowLabelEditing(dimensionID)||canCombineHide},_labelCellHasComments:function(item){var self=this;return self.question.isNumerical()||self.question.isOpenEnded()||item.is_openended&&item.options.is_answer_choice},_shouldShowCommentsInLabelCell:function(){var self=this;return!self.isCompared&&self.__NAME!=="MatrixBasicStatsTableView"},_getTableHeaderRowDataForLabels:function(options){var self=this,labelsData=options.labelsData,includeBlankCell=options.includeBlankCell,rows=[],row={},cells=[],cell,cssClasses,numTableRows,isSortable;numTableRows=self.numRows;isSortable=numTableRows>1;if(includeBlankCell){cell=self._buildBlankTableHeaderCell({isSortable:isSortable});cells.push(cell)}_.each(labelsData,function(labelData){cssClasses=self._getTableHeaderCellCSSClasses(isSortable,labelData.dimensionType);cell={template:labelData.template||"table-header-cell",context:{labelText:labelData.text,classes:cssClasses,dimensionType:labelData.dimensionType,hideActionMenu:labelData.hideActionMenu,variationID:"0"}};if(labelData.flags){$.extend(cell.context,labelData.flags)}cells.push(cell)});row.cells=cells;rows.push(row);return rows},_getTableHeaderRowDataForSeries:function(options){var series=options.series,includeBlankCell=options.includeBlankCell,scopedDimensionID=options.scopedDimensionID;var self=this,rows=[],cells=[],row={},cell,cssClasses,numTableRows,isSortable,hideActionMenu,labelHTML;numTableRows=series[0].data.length;isSortable=numTableRows>1;if(includeBlankCell){cell=self._buildBlankTableHeaderCell({scopedDimensionID:scopedDimensionID,isSortable:isSortable});cells.push(cell)}_.each(series,function(seriesItem){var itemOptions=seriesItem.__options,dimensionType=itemOptions.dimensionType,dimensionID=itemOptions.dimensionID,useEmoji=false;cssClasses=self._getTableHeaderCellCSSClasses(isSortable,dimensionType,dimensionID,scopedDimensionID);if(options.hideActionMenu){hideActionMenu=true}else{hideActionMenu=self.isBasicStats&&self.question.isCompared()&&self.question.isNumerical()||!self.get("isBasicStats")&&self.question.isNPS()&&(self.isMirrored||!!!dimensionID)}labelHTML=self.question.isNPS()?itemOptions.labelText:itemOptions.labelHTML;if(self.question.isEmoji()&&itemOptions.dimensionType==="row"&&self.question.getAnswer(itemOptions.dimensionID)&&self.question.getAnswer(itemOptions.dimensionID).text===itemOptions.labelText){useEmoji=true}cell={template:"table-header-cell",context:{labelText:itemOptions.labelText,labelHTML:labelHTML,classes:cssClasses,dimensionType:dimensionType,dimensionID:dimensionID,hasCommentsPerRow:itemOptions.hasCommentsPerRow,optionID:dimensionID,variationID:"0",responsesCount:itemOptions.numComments,columnHasComments:itemOptions.numComments>0,colSpan:itemOptions.colSpan,hideActionMenu:hideActionMenu,useEmoji:useEmoji,isQuiz:seriesItem.isQuiz,isQuizCorrect:seriesItem.isQuizCorrect}};cells.push(cell)});row.cells=cells;rows.push(row);return rows},_buildBlankTableHeaderCell:function(options){var self=this,cssClasses,dimensionType,hideActionMenu,scopedDimensionID=options.scopedDimensionID,isSortable=options.isSortable;hideActionMenu=self.isBasicStats||self.question.isCompared()&&(!self.get("isBasicStats")&&self.question.isNPS()||self.isBasicStats&&self.question.isNumerical());dimensionType="labels";cssClasses=self._getTableHeaderCellCSSClasses(isSortable,dimensionType,null,scopedDimensionID);return{template:"table-header-blank-cell",context:{classes:cssClasses,dimensionType:dimensionType,hideActionMenu:hideActionMenu,isStatsHeader:self.isBasicStats}}},_getTableBodyRowData:function(options){var self=this,rows=[],row,cells,cell,labelsData=options.labelsData,series=options.series;_.each(labelsData,function(labelData,tableRowIndex){cells=[];cell=self._buildLabelCell(labelData);cells.push(cell);_.each(series,function(seriesItem){cell=self._buildSeriesCell(seriesItem,tableRowIndex);cells.push(cell)});row={cells:cells};rows.push(row)});return rows},_buildLabelCell:function(labelData){return{template:"table-label-cell",context:labelData}},_buildSeriesCell:function(seriesItem,tableRowIndex){var self=this,seriesData,dimensionType,context=seriesItem.__options.defaultContext||{},template,absoluteY,percentageY,commentData;seriesData=seriesItem.data[tableRowIndex];dimensionType=seriesItem.__options.dimensionType;template=seriesItem.__options.template||"table-response-cell";absoluteY=seriesData?seriesData.absoluteY:0;if(absoluteY===null){absoluteY="--"}context.numResponses=self._formattedNumResponses(absoluteY,dimensionType);if(self._shouldIncludePercentageData(dimensionType)){percentageY=seriesData?seriesData.percentageY:0;if(percentageY!==null){context.percentage=self._formattedPercentage(percentageY)}}if(dimensionType==="totals"&&self.question.isCompared()){if(self.summary.answered===0){percentageY=0}else{percentageY=100*Globalize.parseInt(absoluteY+"")/self.summary.answered;context.percentage=self._formattedPercentage(percentageY)}}if(seriesData&&seriesData.__options&&seriesData.__options.commentData){commentData=seriesData.__options.commentData;context.hasComments=true;context.numComments=commentData.numComments;context.optionID=commentData.optionID;context.crossedOptionID=commentData.crossedOptionID;context.matrixCrossTab=commentData.matrixCross;context.variationID=commentData.variationID||"0"}return{template:template,context:context}},_formattedNumResponses:function(numResponses){var decimalPlacesAbsolute=this.get("isBasicStats")||this.isBasicStats?2:0,formatType=SM.Highcharts.getGlobalizeFormatType("absolute",decimalPlacesAbsolute);return Globalize.format(numResponses,formatType)},_formattedPercentage:function(value){var formatType=SM.Highcharts.getGlobalizeFormatType("percent",this.decimalPlacesPercentage);return Globalize.format(value/100,formatType)},_shouldIncludePercentageData:function(dimensionType){return!_.include(["totals","averageRating","averageNumber","responses","score"],dimensionType)},_getTableFooterRowData:function(options){var self=this,rows=[],colSpan=options.colSpan,row;if(self.question.isSimple()){colSpan=colSpan>1?colSpan-1:1;row={template:"simple-table-footer-row",context:{colSpan:colSpan,questionIsMultiResponse:self.question.isMultiResponse(),numRespondents:Globalize.format(self.rollup.getContextSummary().answered,"n0")}};rows.push(row)}else if(self.question.isNumerical()){row={template:"numerical-table-footer-row",context:{colSpan:options.colSpan===4,numRespondents:Globalize.format(self.rollup.getContextSummary().answered,"n0")}};rows.push(row)}if(self._shouldShowCommentsRow()){row={template:"table-footer-comments-row",context:{colSpan:options.colSpan,optionID:options.optionID,variationID:options.variationID,hasComments:options.hasComments,numComments:options.numComments}};rows.push(row)}return rows},_shouldShowCommentsRow:function(){var self=this;if(self.isExport){return false}return self._hasCommentField()&&!self._commentFieldIsAnswer()&&!self._hasCommentFieldPerRow()},_getTableClasses:function(){var self=this,classes=[];classes.push("sm-data-table");if(SM.App.isSharingApp()){classes.push("shared")}if(self.questionType==="simple"){classes.push("sm-data-table-summary")}else if(self.questionType==="matrix"||self.questionType==="menu_matrix"||self.question.isCompared()){classes.push("sm-matrix-table")}if(self.question.isNPS()){if(!self.question.isCompared()){classes.push("nps-detailed-table")}else{classes.push("nps-compared-table")}}if(self.question.survey.isQuiz){classes.push("is-quiz")}if(self.isBasicStats||self.__NAME==="MatrixBasicStatsTableView"){classes.push("basic-stats-matrix-table")}return classes.join(" ")},_getTableHeaderCellCSSClasses:function(isSortable,dimensionType,dimensionID,scopedDimensionID){var self=this,cssClasses=[],sortData;sortData=self._getSortData(scopedDimensionID);if(isSortable){cssClasses.push("sortable")}if(_.contains(["totals","averageRating","averageNumber","averageRanking","dataSegment"],dimensionType)){cssClasses.push(dimensionType)}if(sortData&&sortData.dimensionType===dimensionType){if(dimensionID){if(sortData.dimensionID===dimensionID){cssClasses.push(sortData.order)}}else{cssClasses.push(sortData.order)}}if(self.isBasicStats){cssClasses.push("basic-stats")}return cssClasses.join(" ")},_hasCommentField:function(){var self=this;return!!self.question.commentField},_commentFieldIsAnswer:function(){var self=this;return!!self.question.commentField.options.is_answer_choice},_hasCommentFieldPerRow:function(){var self=this;return self._hasCommentField()&&self.question.commentField.options.apply_all_rows},_shouldAllowLabelEditing:function(dimensionID){var self=this,canEditLabels=true;if(!dimensionID||self.question.isOpenEnded()||self.question.isCompared()&&self.question.isNumerical()||self.rollup.combinehideModel.isCombined(dimensionID)){canEditLabels=false}return canEditLabels},_getSortData:function(scopedDimensionID){var self=this,sortData;if(scopedDimensionID){sortData=self.displayData.sort_data[scopedDimensionID]}else{sortData=self.displayData.sort_data}return sortData},_getTableEvents:function(){return{tdMouseEnter:this._onTdMouseEnter,tdMouseLeave:this._onTdMouseLeave,thClick:this._onThClick,tdClick:this._onTdClick}},_onCaptionClick:function(e){var self=this,$currentTarget=$(e.currentTarget),dimensionID=$currentTarget.attr("data-dimension-id"),actionMenuOptions={answerID:dimensionID,visibleOptions:{labels:true}};SM.CustomizeActionMenu.actionMenu.call(self,e,"caption",actionMenuOptions)},_onThClick:function(e){var self=this,$currentTarget=$(e.currentTarget),dimensionType=$currentTarget.attr("data-dimension-type"),dimensionID=$currentTarget.attr("data-dimension-id"),option4CombineHide,actionMenuOptions={parent:$currentTarget,visibleOptions:{}};if(_.isEmpty(dimensionType)){return}if(SM.App.isSharingApp()){return}if($currentTarget.hasClass("no-action-menu")){return}if(_.contains(["labels","totals","averageRating","averageNumber","responses"],dimensionType)||dimensionID&&self.rollup.combinehideModel.isCombined(dimensionID)){actionMenuOptions.visibleOptions.labels=false}else{actionMenuOptions.visibleOptions.labels=true}if(dimensionType==="labels"){actionMenuOptions.visibleOptions.number=false}else{actionMenuOptions.visibleOptions.number=true}actionMenuOptions.visibleOptions.labels=self._shouldAllowLabelEditing(dimensionID);actionMenuOptions.answerID=dimensionID;if(!self.get("isBasicStats")&&self.question.isNPS()&&!!dimensionID){actionMenuOptions.visibleOptions.ascending=false;actionMenuOptions.visibleOptions.descending=false;actionMenuOptions.visibleOptions.unsorted=false}if($currentTarget.hasClass("basic-stats")||this.__NAME==="MatrixBasicStatsTableView"){actionMenuOptions.visibleOptions.labels=false}if(self.display.getBenchmarkDisplay()){return}option4CombineHide=self.rollup.combinehideModel.getActionMenuOption(dimensionID);if(self.question.ID==="quiz_summary"){actionMenuOptions.visibleOptions.unsorted=false}SM.CustomizeActionMenu.actionMenu.call(self,e,"th",SM.Object.deepExtend(actionMenuOptions,option4CombineHide))},_onThActionSelected:function(e){var self=this,$target=$(e.target),$cell=$target,$table=$cell.parents("table").eq(0),dimensionType=$cell.attr("data-dimension-type"),dimensionID=$cell.attr("data-dimension-id"),scopedDimID,scopedDimType,sortOrder,sortGroup;if(_.contains(["unsorted","ascending","descending"],e.action)){sortOrder=e.action;if($table.attr("data-dimension-id")){scopedDimID=$table.attr("data-dimension-id");scopedDimType=$table.attr("data-dimension-type")}sortGroup=$table.hasClass("basic-stats-matrix-table");self.rollup.display.sort(dimensionType,dimensionID,sortOrder,scopedDimType,scopedDimID,sortGroup)}else{self._onCombineHideActionSelected(e)}},_onTdClick:function(e){var self=this,$target=$(e.target),$currentTarget=$(e.currentTarget),dimensionID,canCombineHide,option4CombineHide,actionMenuOptions={visibleOptions:{}};if(SM.App.isSharingApp()){return}if($currentTarget.parents("tfoot").length){return}if($target.is("a")){return}if($currentTarget.hasClass("no-action-menu")){return}dimensionID=$currentTarget.attr("data-dimension-id");if(!dimensionID){return}actionMenuOptions.answerID=dimensionID;actionMenuOptions.visibleOptions.labels=self._shouldAllowLabelEditing(dimensionID);canCombineHide=self.rollup.combinehideModel.canCombineHide(dimensionID);if(self._shouldShowTdActionMenu(dimensionID,canCombineHide)){option4CombineHide=self.rollup.combinehideModel.getActionMenuOption(dimensionID);SM.CustomizeActionMenu.actionMenu.call(self,e,"td",SM.Object.deepExtend({parent:$currentTarget},actionMenuOptions,option4CombineHide))}},_onTdActionSelected:function(e){var self=e.data.self;if(self._onCombineHideActionSelected(e)){e.stopPropagation()}},_onTdMouseLeave:function(){},_onTdMouseEnter:function(){},_onCombineHideActionSelected:function(e){var self=e.data.self,action,answerID;action=e.action;answerID=e.$action.attr("data-answer-id");if(_.contains(["combine","editCombine","unCombine","hide"],action)){self._handleCombineHideAction(action,answerID);
return true}return false},_handleCombineHideAction:function(action,answerID){var self=this;switch(action){case"combine":SM.Bi.uiTrigger="addCombineQuestionSummaryTableAnswerChoiceMenu";self._openCombineDialog(answerID,false);break;case"editCombine":SM.Bi.uiTrigger="editCombineQuestionSummaryTableAnswerChoiceMenu";self._openCombineDialog(answerID,true);break;case"unCombine":SM.Bi.uiTrigger="unCombineQuestionSummaryTableAnswerChoiceMenu";self.rollup.combinehideModel.unCombine(answerID);break;case"hide":SM.Bi.uiTrigger="hideQuestionSummaryTableAnswerChoiceMenu";self.rollup.combinehideModel.addHide(answerID);break;default:break}},_openCombineDialog:function(answerID,isEditCombine){var self=this,combineDialogView;combineDialogView=SM.Views.create(SM.CombineDialogView,{model:self.rollup,answerID:answerID,isEditCombine:isEditCombine});combineDialogView.open();$("body").addClass("modal-open")},_onTAToggleLinkClick:function(e){var self=this,visibilityAttr="ta-visible",visibilityClass="ta-visible",$target=$(e.target),$cell,$prevCell,taIsVisible;e.preventDefault();if(self.question.hasCommentsPerRow()&&!self.question.isCompared()&&self.isMirrored){$cell=$target.parents("th:eq(0)")}else{$cell=$target.parents("td:eq(0)")}$prevCell=$target.closest("tr").find("["+visibilityAttr+"=true]").not($cell);taIsVisible=$cell.attr(visibilityAttr)==="true";if($prevCell.length){$prevCell.attr(visibilityAttr,"false");$prevCell.removeClass(visibilityClass);self._hideTARowView($prevCell)}if(taIsVisible){self._hideTARowView($target);$cell.attr(visibilityAttr,"false");$cell.removeClass(visibilityClass)}else{self._expandTARowView($target);$cell.attr(visibilityAttr,"true");$cell.addClass(visibilityClass)}},_expandTARowView:function($target){var self=this,optionID=$target.attr("option-id"),variationID=$target.attr("variation-id"),crossedOptionID=$target.attr("crossed-option-id"),matrixCrossTab=$target.attr("matrix-crosstab"),count=$target.data("responseCount"),model,taRowView,$row=$target.closest("tr");if(self.question.isFileUpload()){model=self.rollup.getFileUploadModel(optionID,crossedOptionID,matrixCrossTab,variationID)}else{model=self.rollup.getTaModel(optionID,crossedOptionID,variationID);if(!model){model=self.rollup.createTaModel(optionID,crossedOptionID,matrixCrossTab,variationID)}model.set("filterCount",count)}taRowView=SM.Views.create(SM.SummaryTaRowView,{question:self.question,model:model});$row.after(taRowView.el);$(taRowView.el).data("containerView",taRowView)},_hideTARowView:function($target){var $row=$target.closest("tr"),$taRow=$row.next();$taRow.data("containerView").destroy();$taRow.remove()},_getQuizScoresData:function(data,isSeries){var self=this,quizStats=self.summary.summary.quiz_stats,dimensionId,label,optionValues;if(!quizStats){return}optionValues=quizStats.option_values;return _.map(data,function(item){var optionVal=_.find(optionValues,function(val,key){if(isSeries){dimensionId=item.__options.dimensionID;label=item.__options.labelText}else{dimensionId=item.dimensionID;label=item.labelText}return key===dimensionId});if(optionVal){item.isQuiz=true;item.isQuizCorrect=optionVal.is_correct;return{name:label,isCorrect:optionVal.is_correct,score:Globalize.format(optionVal.score,"n0"),total:Globalize.format(quizStats.total_score,"n0")}}return{name:label,noScore:true}})}});SM.SimpleSummaryTableView=SM.Views.deepExtend(SM.BaseSummaryTableView,{__NAME:"SimpleSummaryTableView",__templateID:"summary-table-template",_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData;labelsData=[{text:self.localizedLabels.answerChoices,dimensionType:self.DIMENSION_TYPES.LABELS},{text:self.localizedLabels.responses,dimensionType:self.DIMENSION_TYPES.RESPONSES}];headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData,rows=self.sortedRowsList[0],labelsData,seriesData;labelsData=self._getTableLabelsData(rows);seriesData=self.buildSimpleSeries(self.summary,rows,self.seriesOptions);bodyRowData=self._getTableBodyRowData({labelsData:labelsData,series:seriesData});return bodyRowData},_buildTableFooterRowData:function(){var self=this,footerOptions={colSpan:2},numComments,variationID="0";if(self._hasCommentField()&&!self._commentFieldIsAnswer()){numComments=self.summary.other_option||0;if(self.question.randomAssignmentOption){variationID=self.question.randomAssignmentOption.toString()}_.extend(footerOptions,{optionID:self.question.commentField.id,variationID:variationID,hasComments:numComments>0,numComments:numComments})}return self._getTableFooterRowData(footerOptions)}});SM.QuizSummaryTableView=SM.Views.deepExtend(SM.BaseSummaryTableView,{__NAME:"QuizSummaryTableView",__templateID:"summary-table-template",__afterRender:function(){SM.BaseSummaryTableView.__afterRender.call(this);this.$el.find("table.sm-data-table").addClass("is-quiz")},_buildTableHeaderRowData:function(){var self=this;return self._getTableHeaderRowDataForLabels({labelsData:[{text:self.localizedLabels.answerChoices,dimensionType:self.DIMENSION_TYPES.LABELS},{text:self.localizedLabels.averageRanking,dimensionType:self.DIMENSION_TYPES.SCORES},{text:self.localizedLabels.responses,dimensionType:self.DIMENSION_TYPES.RESPONSES}]})},_buildTableBodyRowData:function(){var self=this,rows=self.sortedRowsList[0],labelsData=self._getTableLabelsData(rows),scoresData=self._getQuizScoresData(labelsData,false),seriesData=self.buildSimpleSeries(self.summary,rows,self.seriesOptions);return self._getTableBodyRowData({labelsData:labelsData,scoresData:scoresData,series:seriesData})},_getTableBodyRowData:function(options){var self=this,rows=[],labelsData=options.labelsData,scoresData=options.scoresData,series=options.series;_.each(labelsData,function(labelData,tableRowIndex){var cells=[];cells.push(self._buildLabelCell(labelData));cells.push({template:"table-quiz-score-cell",context:scoresData[tableRowIndex]});_.each(series,function(seriesItem){cells.push(self._buildSeriesCell(seriesItem,tableRowIndex))});rows.push({cells:cells})});return rows},_buildTableFooterRowData:function(){var self=this,footerOptions={colSpan:3},variationID="0",numComments=self.summary.other_option||0;if(self._hasCommentField()&&!self._commentFieldIsAnswer()){if(self.question.randomAssignmentOption){variationID=self.question.randomAssignmentOption.toString()}_.extend(footerOptions,{optionID:self.question.commentField.id,variationID:variationID,hasComments:numComments>0,numComments:numComments})}return self._getTableFooterRowData(footerOptions)},_getTableFooterRowData:function(options){var self=this,rows=[{template:"quiz-table-footer-row",context:{questionIsMultiResponse:self.question.isMultiResponse(),numRespondents:Globalize.format(self.rollup.getContextSummary().answered,"n0")}}];if(self._shouldShowCommentsRow()){rows.push({template:"table-footer-comments-row",context:options})}return rows}});SM.SummaryQuizSummaryTableContainerView=SM.Views.register({__NAME:"summaryQuizSummaryTableContainerView",__templateID:"summary-table-container-template",__create:function(options){var self=this;self.survey=options.survey;self.quizSummary=options.quizSummary;self.isExport=options.isExport;self.display=self.quizSummary.getRollup().display},__init:function(){var self=this;self.bindModel(self.display,"displayChange",{self:self},self._onTableDisplayChange);self.$el.on("setHighlightedLabelCell",self._setHighlightedLabelCell).on("click","#quiz-ranking-show-all",{self:self},self._showAllRankings).on("click","#quiz-ranking-show-top",{self:self},self._showTopRankings)},__afterRender:function(){var self=this,view;try{view=SM.Views.create(SM.QuizStatsSummaryTableView,{question:self.quizSummary,isExport:self.isExport});self.$el.html(view.el);self.$el.append($(SM.Template.render("quiz-ranking-table-caption")));view=self._rankingTableView=SM.Views.create(SM.QuizRankSummaryTableView,{question:self.quizSummary,isExport:self.isExport});self.$el.append(view.el);if(view.isLongTable){self.$el.append($(SM.Template.render("quiz-ranking-table-footer")))}}catch(exception){self._handleRenderingError(exception)}},_handleRenderingError:function(exception){var self=this,div=document.createElement("div");div.innerHTML=SM.Template.render("summary-table-display-error-template");self.$el.html(div);SM.Error.log(exception,"quiz summary table rendering error")},_onTableDisplayChange:function(e){e.data.self._rankingTableView.render()},_showAllRankings:function(e){var self=e.data.self;e.preventDefault();self._rankingTableView.showAll();$("#quiz-ranking-show-all").addClass("hide");$("#quiz-ranking-show-top").removeClass("hide")},_showTopRankings:function(e){var self=e.data.self;e.preventDefault();self._rankingTableView.showTop();$("#quiz-ranking-show-all").removeClass("hide");$("#quiz-ranking-show-top").addClass("hide")}});SM.QuizStatsSummaryTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"QuizStatsSummaryTableView",__templateID:"summary-table-template",__afterRender:function(){var self=this;self.$el.empty();self._renderTable()},_renderTable:function(){var self=this,md=self._buildTemplateData(),content=SM.Template.renderHTML("quiz-summary-stats-table",md);self.$el.prepend(content)},_getSortedSummaryData:function(){},_buildTemplateData:function(){var self=this,stats=self.summary.summary.quiz_stats,formatNumber=SM.String.formatNumber;if(stats.std_dev===null){stats.std_dev="--"}return{lowest:formatNumber(stats.lowest,true),highest:formatNumber(stats.highest,true),median:formatNumber(stats.median,true),mean:formatNumber(stats.mean,true),std:_.isNumber(stats.std_dev)?formatNumber(stats.std_dev,true):stats.std_dev}}});SM.QuizRankSummaryTableView=SM.Views.deepExtend(SM.BaseSummaryTableView,{__NAME:"QuizRankSummaryTableView",__templateID:"summary-table-template",_LONG_TABLE_THRESHOLD:5,_LONG_TABLE_TOP_SIZE:3,_showTopRows:true,isLongTable:false,__afterRender:function(){var self=this;SM.BaseSummaryTableView.__afterRender.call(self);self.$el.addClass("quiz-rank-container");self.isLongTable=!self.isExport&&self.sortedQuizRankings.length>self._LONG_TABLE_THRESHOLD;if(self._showTopRows&&self.isLongTable){self._collapseTable()}},_collapseTable:function(){var self=this;_.each(self.$el.find("tbody tr"),function(tr,index){if(index>=self._LONG_TABLE_TOP_SIZE){$(tr).hide()}})},_buildTableHeaderRowData:function(){var self=this,labelsData=[{text:Globalize.localize("Questions")+" ("+_.size(self.question.structure.question_ranking)+")",dimensionType:self.DIMENSION_TYPES.POSITIONS},{text:Globalize.localize("Difficulty"),dimensionType:self.DIMENSION_TYPES.RANKINGS},{text:Globalize.localize("Average Score"),dimensionType:self.DIMENSION_TYPES.AVERAGE_SCORES}];return self._getTableHeaderRowDataForLabels({labelsData:labelsData})},_buildTableBodyRowData:function(){var self=this,bodyRowData=_.map(self.sortedQuizRankings,function(qr){return{cells:[{context:{qId:qr.question_id,position:qr.position,heading:qr.heading,isExport:self.question.survey.isExport},template:"quiz-ranking-table-label-cell"},{context:{value:qr.rank?qr.rank+"":"--"},template:"quiz-ranking-table-value-cell"},{context:{value:_.isUndefined(qr.avg_score)?"--":SM.String.formatNumber(qr.avg_score,true)},template:"quiz-ranking-table-value-cell"}]}});return bodyRowData},_getSortedSummaryData:function(){this.sortedQuizRankings=this.question.getRollup().getSortedSummary().quizRankings},_getTableClasses:function(){var classes=["sm-data-table sm-data-table-summary"];if(SM.App.isSharingApp()){classes.push("shared")}return classes.join(" ")},setHeight:function(){var el=this.$el;setTimeout(function(){el.height(el.find("table").height()+2+"px")},0)},showAll:function(){var self=this,el=self.$el,tableEl=el.find("table");tableEl.find("tbody tr").show();setTimeout(function(){el.animate({height:tableEl.height()+2+"px"},function(){self.setHeight();self._showTopRows=false})})},showTop:function(){var self=this,el=self.$el,tableEl=el.find("table"),topHiddenTr=$(tableEl.find("tbody tr")[self._LONG_TABLE_TOP_SIZE]);el.animate({height:topHiddenTr.offset().top+2-tableEl.offset().top+"px"},function(){self._collapseTable();setTimeout(function(){self.setHeight();self._showTopRows=true;tableEl.scrollIntoView()},0)})},_buildTableFooterRowData:function(){}});SM.QuizStatsTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"QuizStatsTableView",__templateID:"summary-table-template",__afterRender:function(){var self=this;self.$el.empty();self._renderTable();self.$el.find(".q").popout()},_renderTable:function(){var self=this,md=self._buildTemplateData(),content=SM.Template.renderHTML("quiz-stats-table",md);self.$el.prepend(content)},_buildTemplateData:function(){var self=this,stats=self.summary.summary.quiz_stats,formatNumber=SM.String.formatNumber;return{avg_score:formatNumber(stats.avg_score,false,1),avg_percent:formatNumber(stats.avg_score/stats.total_score,true),total_score:formatNumber(stats.total_score,false,1),total_questions:formatNumber(stats.total_questions),std_dev:formatNumber(stats.std_dev,false,2),rank:formatNumber(stats.rank),percent_correct:formatNumber(stats.percent_correct,true)}}});SM.NpsSimpleSummaryTableView=SM.Views.deepExtend(SM.SimpleSummaryTableView,{__NAME:"NpsSimpleSummaryTableView",__templateID:"summary-table-template",__beforeRender:function(){var self=this;self._getDisplayOptions();self._getSortedSummaryData();self._getNpsData()},__afterRender:function(){var self=this;self.$el.empty();if(self.isDepthDetailed){self._renderTable()}self._renderDistributionTable()},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData;labelsData=[{text:"",dimensionType:self.DIMENSION_TYPES.LABELS,hideActionMenu:true},{text:self.localizedLabels.responses,dimensionType:self.DIMENSION_TYPES.RESPONSES,hideActionMenu:true}];headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_renderDistributionTable:function(){var self=this,md,content;md=self._buildDistributionSeries();md.hasHeader=self.isDepthDetailed;content=SM.Template.renderHTML("nps-distribution-table",md);self.$el.prepend(content)},_buildTableCaptionData:function(){return{template:"table-caption",context:{caption:Globalize.localize("Answer Choices"),dimensionID:"scopedDimension.id",mediaCaption:Globalize.localize("Answer Choices"),classes:""}}},_buildDistributionSeries:function(){var self=this,seriesData,decimalPlacesPercentage=self.decimalPlacesPercentage,formatYValue=SM.Highcharts.formatYValue;seriesData=self.buildSimpleSeries(self.npsSummary.distribution.summary,self.npsSummary.distribution.answerStructures.rows);if(self.nps_depth==="score"){decimalPlacesPercentage=self.decimalPlaces}return{Detractors:{name:seriesData[0].data[0].name,percent:formatYValue(seriesData[0].data[0].percentageY,"percent",decimalPlacesPercentage),value:self._formattedNumResponses(seriesData[0].data[0].absoluteY)},Passives:{name:seriesData[0].data[1].name,percent:formatYValue(seriesData[0].data[1].percentageY,"percent",decimalPlacesPercentage),value:self._formattedNumResponses(seriesData[0].data[1].absoluteY)},Promoters:{name:seriesData[0].data[2].name,percent:formatYValue(seriesData[0].data[2].percentageY,"percent",decimalPlacesPercentage),value:self._formattedNumResponses(seriesData[0].data[2].absoluteY)},Score:Math.round(seriesData[0].data[2].percentageY-seriesData[0].data[0].percentageY)}},_getDisplayOptions:function(){var self=this;SM.Summarizable._getDisplayOptions.call(self);self.nps_depth=self.displayData.nps_depth;self.isDepthDetailed=self.displayData.isDepthDetailed}});SM.NumericalSummaryTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"NumericalSummaryTableView",__templateID:"summary-table-template",_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.averageSeriesName=self.localizedLabels.averageNumber;seriesOptions.totalSeriesName=self.localizedLabels.totalNumber;seriesOptions.responsesSeriesName=self.localizedLabels.responses},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsDefaults,labelsData;labelsDefaults=[{text:self.localizedLabels.answerChoices,dimensionType:self.DIMENSION_TYPES.LABELS},{text:self.localizedLabels.averageNumber,dimensionType:self.DIMENSION_TYPES.AVERAGE_NUMBER},{text:self.localizedLabels.totalNumber,dimensionType:self.DIMENSION_TYPES.TOTALS},{text:self.localizedLabels.responses,dimensionType:self.DIMENSION_TYPES.RESPONSES}];labelsData=labelsDefaults;headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData,rows=self.sortedRowsList[0],labelsData,seriesData,seriesOptions=self.get("seriesOptions");seriesData=self.buildNumericalSeries(seriesOptions);labelsData=self._getTableLabelsData(rows);bodyRowData=self._getTableBodyRowData({labelsData:labelsData,series:seriesData});return bodyRowData},_buildTableFooterRowData:function(){var self=this,footerRowData;footerRowData=self._getTableFooterRowData({colSpan:4});return footerRowData}});SM.MatrixSummaryTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"MatrixSummaryTableView",__templateID:"summary-table-template",_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.includeTotal=true;if(self.question.isMultiResponse()){seriesOptions.totalSeriesName=self.localizedLabels.totalRespondents}else{seriesOptions.totalSeriesName=self.localizedLabels.total}if(self.question.isRating()||self.question.isRanking()){seriesOptions.includeAverage=true;if(self.question.isRating()){seriesOptions.averageSeriesName=self.localizedLabels.averageRating}else{seriesOptions.averageSeriesName=self.localizedLabels.averageRanking}}},_setLabelsAndSeriesData:function(){var self=this,sortedRows,sortedColumns,seriesOptions=self.get("seriesOptions");if(self.isMirrored){sortedColumns=self.sortedColumnsList[0];self.labelsData=self._getTableLabelsData(sortedColumns);self.seriesData=self.buildMirroredMatrixSeries(seriesOptions)}else{sortedRows=self.sortedRowsList[0];self.seriesData=self.buildMatrixSeries(seriesOptions);if(self._hasCommentFieldPerRow()){self.labelsData=self._getCommentsPerRowTableLabelsData(sortedRows)}else{self.labelsData=self._getTableLabelsData(sortedRows)}}},_getCommentsPerRowTableLabelsData:function(rows){var self=this,summary,cell,responsesCount,variationID;return _.map(rows,function(row){summary=self.summary.summary.options[row.id];responsesCount=summary&&summary.row_other?summary.row_other:0;variationID=self.question.randomAssignmentOption?self.question.randomAssignmentOption:0;cell={variationID:variationID,labelText:row.text,labelHTML:row.mediaHTML,hasCommentsPerRow:true,optionID:row.id,responsesCount:responsesCount,rowHasComments:responsesCount>0};return cell})},_buildTableHeaderRowData:function(){var self=this,headerRowData;headerRowData=self._getTableHeaderRowDataForSeries({series:self.seriesData,includeBlankCell:true});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData;bodyRowData=self._getTableBodyRowData({labelsData:self.labelsData,series:self.seriesData});return bodyRowData},_buildTableFooterRowData:function(){var self=this,footerRowData,footerOptions,numComments,colSpan;if(self._hasCommentField()&&!self._hasCommentFieldPerRow()){numComments=self.summary.other_option||0;colSpan=self.seriesData.length+1;footerOptions={colSpan:colSpan,optionID:self.question.commentField.id,variationID:self.question.randomAssignmentOption,hasComments:numComments>0,numComments:numComments};footerRowData=self._getTableFooterRowData(footerOptions);return footerRowData}}});SM.BaseMenuMatrixSummaryTablesView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"BaseMenuMatrixSummaryTablesView",__templateID:"summary-table-template",_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.includeTotal=true;seriesOptions.totalSeriesName=self.localizedLabels.total;seriesOptions.averageSeriesName=self.localizedLabels.averageNumber;if(self.question.isRating()||self.question.isRanking()){seriesOptions.includeAverage=true;if(self.question.isRating()){seriesOptions.averageSeriesName=self.localizedLabels.averageRating}else{seriesOptions.averageSeriesName=self.localizedLabels.averageRanking}}},__afterRender:function(){var self=this,tableOptions;self.$el.empty();if(!self.dimensionalSplitKey){throw new Error("You must define self.dimensionalSplitKey for menu-matrix questions")}_.each(self[self.dimensionalSplitKey],function(scopedDimension,scopedDimensionIndex){self._setLabelsAndSeriesData(scopedDimension,scopedDimensionIndex);tableOptions=self._getTableOptions(scopedDimension,scopedDimensionIndex);SM.Hightables.renderTable(tableOptions);if(self.showBasicStats&&self.question.getRollup().hasBasicStats()&&!self.question.isNumerical()){self.isBasicStats=true;self._enableCaption=false;self._setLabelsAndSeriesData(scopedDimension,scopedDimensionIndex);tableOptions=self._getTableOptions(scopedDimension,scopedDimensionIndex);SM.Hightables.renderTable(tableOptions);self._enableCaption=true;self.isBasicStats=false}});if(self._hasOtherCommentsTable()){self._renderOtherCommentsTable()}if(self.highlightedDimensionID){self._highlightLabelCell(self.highlightedDimensionID)}self.$el.find(".q").popout();if(self.question.survey.owner.canSigDiffs()&&self.showSidi&&self.isMirrored){self._renderSidiPopout()}},_getTableOptions:function(scopedDimension,scopedDimensionIndex){var self=this,tableData=self._getTableData({scopedDimension:scopedDimension,scopedDimensionIndex:scopedDimensionIndex}),tableClasses=self._getTableClasses(),isExport=!!self.isExport,hightablesOptions,$target;if(self.isBasicStats){$target=$('<div class="sm-bs-menu-matrix-table"></div>')}else if(self.showBasicStats){$target=$('<div class="sm-bs-table"></div>')}else{$target=$("<div></div>")}self.$el.append($target);hightablesOptions={target:$target,tableData:tableData,tableClasses:tableClasses,tableAttrs:{"dimension-id":scopedDimension.id,"dimension-type":scopedDimension.type},events:{captionClick:self._onCaptionClick,thClick:self._onThClick,tdClick:self._onTdClick},useDivs:isExport,flattenNestedTables:isExport};return hightablesOptions},_buildTableCaptionData:function(options){var self=this,scopedDimension=options.scopedDimension,useEmoji=false;if(self.question.isEmoji()&&scopedDimension.type==="row"&&self.question.getAnswer(scopedDimension.id).text===scopedDimension.text){useEmoji=true}return{template:"table-caption",context:{caption:scopedDimension.text,dimensionID:scopedDimension.id,mediaCaption:scopedDimension.mediaHTML,classes:"",useEmoji:useEmoji}}},_buildTableHeaderRowData:function(options){var self=this,headerRowData,scopedDimensionID=options.scopedDimension.id;headerRowData=self._getTableHeaderRowDataForSeries({series:self.seriesData,includeBlankCell:true,scopedDimensionID:scopedDimensionID});return headerRowData},_buildTableBodyRowData:function(options){var self=this,bodyRowData,scopedDimensionID=options.scopedDimension.id;bodyRowData=self._getTableBodyRowData({labelsData:self.labelsData,series:self.seriesData,scopedDimensionID:scopedDimensionID});return bodyRowData}});SM.MenuMatrixSummaryTablesView=SM.Views.extend(SM.BaseMenuMatrixSummaryTablesView,{__NAME:"MenuMatrixSummaryTablesView",dimensionalSplitKey:"columns",_setLabelsAndSeriesData:function(column,columnIndex){var self=this,seriesOptions=self.get("seriesOptions"),labelsDataSource,columnChoices;if(self.isBasicStats){labelsDataSource=self.sortedRowsListBS[columnIndex]}else if(self.isMirrored){labelsDataSource=self.sortedColumnChoicesList[columnIndex]}else{labelsDataSource=self.sortedRowsList[columnIndex]}self.labelsData=self._getTableLabelsData(labelsDataSource);if(self.isBasicStats){columnChoices=SM.BasicStatsUtils.getStructure("column_choice");seriesOptions={isBasicStats:true}}else{columnChoices=column.items}self.seriesData=self.buildMenuMatrixSeries(column,columnIndex,columnChoices,self.columnChoiceTotalsByColumnChoice,seriesOptions)},_buildTableFooterRowData:function(){},_hasOtherCommentsTable:function(){var self=this;return self._hasCommentField()},_getOtherTableData:function(){var self=this,numComments=self.summary.other_option||0;return{optionID:self.question.commentField.id,hasComments:numComments>0,numComments:numComments,variationID:"0"}},_renderOtherCommentsTable:function(){var self=this,otherTableData=self._getOtherTableData();self.$el.append(SM.Template.render("other-comments-for-menu-matrix-table",otherTableData))}});SM.ComparedMatrixSummaryTableView=SM.Views.deepExtend(SM.BaseSummaryTableView,{__NAME:"ComparedMatrixSummaryTableView",__templateID:"summary-table-template",__create:function(options){SM.BaseSummaryTableView.__create.call(this,options);this.isTop2=options.isTop2;this.showTitle=this.isTop2},_renderTitle:function(){var self=this,fullTotal=self.rollup.answeredCount,percentage=fullTotal===0?0:self.rollup.top2compositeSummary.answered/fullTotal,percentageStr=Globalize.format(percentage,"p1"),title=SM.Template.render("top2-table-title",{score:percentageStr});self.$el.prepend($(title))},_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.includeTotal=true;seriesOptions.totalSeriesName=self.localizedLabels.total},_setLabelsAndSeriesData:function(){var self=this,sortedRows,sortedColumns,seriesOptions=self.get("seriesOptions"),isTop2=self.get("isTop2");if(isTop2){self.decimalPlacesPercentage=1}if(self.isMirrored){sortedColumns=self.sortedColumnsList[0];self.labelsData=self._getTableLabelsData(sortedColumns);if(isTop2){seriesOptions.isTable=true;seriesOptions.isCompared=true;self.seriesData=self.buildTop2StackedSeries(seriesOptions)}else{self.seriesData=self.buildMirroredMatrixSeries(seriesOptions)}}else{sortedRows=self.sortedRowsList[0];self.seriesData=self.buildMatrixSeries(seriesOptions);self.labelsData=self._getTableLabelsData(sortedRows)}},_buildTableHeaderRowData:function(){var self=this,headerRowData;if(self.question.survey.isQuiz){self._getQuizScoresData(self.seriesData,true)}headerRowData=self._getTableHeaderRowDataForSeries({series:self.seriesData,includeBlankCell:true,hideActionMenu:self.display.getBenchmarkDisplay()});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData;if(self.question.survey.isQuiz){self._getQuizScoresData(self.labelsData,false)}bodyRowData=self._getTableBodyRowData({labelsData:self.labelsData,series:self.seriesData});return bodyRowData},_buildTableFooterRowData:function(){var self=this,footerRowData,footerOptions={};if(self._hasCommentField()&&!self._commentFieldIsAnswer()){footerOptions.showComments=true}footerRowData=self._getTableFooterRowData(footerOptions);return footerRowData},_getTableFooterRowData:function(options){var self=this,tfootRowData=[],totalsRowData,commentsRowData;totalsRowData=self._getTableFooterTotalsRowData();tfootRowData.push(totalsRowData);if(options.showComments){if(self.isMirrored){commentsRowData=self._getMirroredTableFooterCommentsRowData();tfootRowData.push(commentsRowData)}else{commentsRowData=self._getTableFooterCommentsRowData();tfootRowData.push(commentsRowData)}}return tfootRowData},_getTableFooterTotalsRowData:function(){var self=this,totals,tableCells=[],isTop2=self.get("isTop2"),showPercentage=isTop2&&self.sortedColumnsList[0].length>1;tableCells.push({template:"table-label-cell",context:{hideActionMenu:self.question.isNPS(),labelText:self.localizedLabels.totalRespondents}});if(isTop2){totals=[self.rollup.top2compositeSummary.answered]}else if(self.isMirrored){totals=_.map(self.rows,function(row){return self.respondentCountsByRow[row.id]})}else{totals=_.map(self.columns,function(column){return self.respondentCountsByColumn[column.id]})}_.each(totals,function(total){var percentage=isTop2?total===0?0:total*100/self.rollup.answeredCount:0;self.top2Percentage=self._formattedPercentage(percentage);tableCells.push({template:"table-footer-total-cell",context:{hasPercentage:showPercentage,percentage:self.top2Percentage,total:self._formattedNumResponses(total)}})});tableCells.push({template:"table-footer-total-cell",context:{hasPercentage:showPercentage,percentage:self._formattedPercentage(100),total:self._formattedNumResponses(self.rollup.answeredCount)}});if(self.get("seriesOptions").includeScore){tableCells.push({template:"table-footer-total-cell",context:{total:""}})}return{cells:tableCells}},_getTableFooterCommentsRowData:function(){var self=this,rollup=self.question.getRollup(),otherSummary,sortedColumns=self.sortedColumnsList[0],matrixCross,numComments,totalComments=0,tableRow,tableCells=[],tableCell,summary;try{otherSummary=rollup.options.other_option.options}catch(e){otherSummary=null}matrixCross=rollup.summary.crossed_cols?"1":"0";tableCell={template:"table-label-cell",context:{labelText:self.question.commentField.text}};tableCells.push(tableCell);_.each(sortedColumns,function(column){if(otherSummary&&otherSummary[column.id]){summary=otherSummary[column.id];numComments=summary.count}else{numComments=0}totalComments+=numComments;tableCell={template:"table-footer-comment-cell",context:{hasComments:numComments>0,numComments:numComments,optionID:self.question.commentField.id,crossedOptionID:column.id,matrixCrossTab:matrixCross,responsesCount:numComments}};tableCells.push(tableCell)});tableCell={template:"table-footer-total-cell",context:{total:totalComments}};tableCells.push(tableCell);tableRow={cells:tableCells};return tableRow},_getMirroredTableFooterCommentsRowData:function(){var self=this,rollup=self.question.getRollup(),otherSummary,sortedColumns=self.sortedColumnsList[0],tableBodyRowData=[],tableRow,tableCells,numComments,matrixCross,colSpan,variationID;try{otherSummary=rollup.options.other_option.options}catch(e){otherSummary=null}matrixCross=rollup.summary.crossed_cols?"1":"0";_.each(sortedColumns,function(column){if(otherSummary&&otherSummary[column.id]){numComments=otherSummary[column.id].count}else{numComments=0}if(matrixCross==="2"){variationID=column.id||0;variationID.toString()}else if(rollup.comparedByRA&&self.question.hasRandomAssignment()){variationID=self.question.randomAssignmentOption}else{variationID="0"}tableCells=[{labelText:column.text,numComments:numComments,hasComments:numComments>0,optionID:self.question.commentField.id,crossedOptionID:column.id,matrixCrossTab:matrixCross,variationID:variationID}];tableRow={cells:tableCells};tableBodyRowData.push(tableRow)});colSpan=self.numRows+2;return{template:"mirrored-compared-other-comments-for-matrix-table",context:{otherFieldLabel:self.question.commentField.text,rows:tableBodyRowData,colSpan:colSpan,variationID:"0"}}}});SM.NpsComparedMatrixSummaryTableView=SM.Views.deepExtend(SM.ComparedMatrixSummaryTableView,{__NAME:"NpsComparedMatrixSummaryTableView",__templateID:"summary-table-template",_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.includeTotal=true;seriesOptions.totalSeriesName=self.localizedLabels.total;seriesOptions.includeScore=true;seriesOptions.scoreSeriesName=self.localizedLabels.score},_unsetSeriesOptions:function(seriesOptions){seriesOptions.includeScore=false},__beforeRender:function(){var self=this;self._getDisplayOptions();self._getSortedSummaryData();self._getNpsData()},__afterRender:function(){var self=this;self.$el.empty();self._enableCaption=self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed;self.isMirrored=true;self._setAsSummarizableNps(SM.QuestionDisplayModel.DISPLAY_VALUES.nps_distribution);self._setSeriesOptions(self.get("seriesOptions"));self._renderTable();if(self.nps_depth===SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed){self.isMirrored=false;self._setAsSummarizableNps(SM.QuestionDisplayModel.DISPLAY_VALUES.nps_detailed);self._unsetSeriesOptions(self.get("seriesOptions"));self._renderTable()}self.isMirrored=true},_buildTableCaptionData:function(){var self=this;return{template:"table-caption",context:{caption:Globalize.localize("Net Promoter Score"),dimensionID:"",mediaCaption:Globalize.localize(self.isMirrored?"Net Promoter Score":"Answer Choices"),classes:""}}},_getDisplayOptions:function(){var self=this;self.displayData=self.rollup.display.getDisplayData();
self.isDepthDetailed=self.displayData.isDepthDetailed;self.showTable=self.displayData.show_table;self.showChart=self.displayData.show_chart;self.isMirrored=self.displayData.mirror;self.isStacked=self.displayData.isStacked;self.isWeightedAvg=self.displayData.isWeightedAvg;self.showDataLabels=self.displayData.show_data;self.hideEmptyData=!self.displayData.show_empty_data;self.scaleType=self.displayData.scale_type;self.scaleIsPercent=self.scaleType===self.SCALE_TYPE_PERCENT;self.decimalPlaces=self.scaleIsPercent?self.displayData.dp_percentage:self.displayData.dp_absolute;if(self.displayData.nps_depth==="score"){self.decimalPlacesAbsolute="0";self.decimalPlacesPercentage=self.displayData.dp_absolute}else{self.decimalPlacesAbsolute=self.displayData.dp_absolute;self.decimalPlacesPercentage=self.displayData.dp_percentage}self.nps_depth=self.displayData.nps_depth;self.showBasicStats=self.displayData.show_basic_stats;self.showSidi=self.displayData.show_sig_diffs}});SM.ComparedMenuMatrixSummaryTablesView=SM.Views.extend(SM.BaseMenuMatrixSummaryTablesView,{__NAME:"ComparedMenuMatrixSummaryTablesView",dimensionalSplitKey:"rows",_setLabelsAndSeriesData:function(row,rowIndex){var self=this,seriesOptions,columnChoices,sortedColumnChoices,sortedColumns,columnChoiceTotals,responsesCount,summary,variationID,matrixCrossTab,crossedQuestionID;seriesOptions=self.get("seriesOptions");columnChoices=row.items;if(self.isMirrored||self.isBasicStats){sortedColumnChoices=self.isBasicStats?self.sortedColumnChoicesListBS[rowIndex]:self.sortedColumnChoicesList[rowIndex];self.labelsData=self._getTableLabelsData(sortedColumnChoices);if(self.question.survey.isQuiz){self._getQuizScoresData(self.labelsData,false)}if(self.isMirrored&&self._hasCommentFieldPerRow()){summary=self.summary.summary.options[row.id];responsesCount=summary&&summary.row_other?summary.row_other:0;crossedQuestionID=self.summary.crossed_question_id?self.summary.crossed_question_id:0;matrixCrossTab=crossedQuestionID&&self.question.survey.questions[crossedQuestionID].family==="matrix"?1:0;variationID=self.question.randomAssignmentOption?self.question.randomAssignmentOption:0;if(!self.isBasicStats){self.labelsData=_.map(self.labelsData,function(data){data.hasCommentsPerRow=true;data.optionID=row.id;data.variationID=variationID;data.matrixCrossTab=matrixCrossTab;if(data.dimensionID&&data.dimensionID>0){data.crossedOptionID=data.dimensionID}data.responsesCount=responsesCount;data.rowHasComments=data.responsesCount>0;return data})}}}else{sortedColumns=self.sortedColumnsList[rowIndex];self.labelsData=self._getTableLabelsData(sortedColumns)}columnChoiceTotals=self.columnChoiceTotalsByRow[row.id];if(self.isBasicStats){seriesOptions={columns:SM.BasicStatsUtils.getStructure(),isBasicStats:true}}self.seriesData=self.buildComparedMatrixSeries(row,columnChoices,columnChoiceTotals,seriesOptions)},_buildTableFooterRowData:function(){},_hasOtherCommentsTable:function(){var self=this;return self._hasCommentField()&&!self._commentFieldIsAnswer()&&!self._hasCommentFieldPerRow()},_crossedOptionInOtherSummary:function(otherSummary,crossedOptionID){var column=_.find(otherSummary,function(row){return crossedOptionID in row});return column[crossedOptionID]},_getOtherTableData:function(){var self=this,rollup=self.question.getRollup(),otherSummary,labelsData=[],labelData,cellsData=[],cellData,numComments,totalNumComments=0,variationID,matrixCross,colSpan;try{otherSummary=rollup.options.other_option.options.other_option.options}catch(error){otherSummary=null}matrixCross=rollup.summary.crossed_cols?"1":"0";_.each(self.crossedOptions,function(crossedOption){labelData={text:crossedOption.text};labelsData.push(labelData);if(otherSummary){if(otherSummary[crossedOption.id]){numComments=otherSummary[crossedOption.id].count}else if(self._crossedOptionInOtherSummary(otherSummary,crossedOption.id)){numComments=self._crossedOptionInOtherSummary(otherSummary,crossedOption.id).count}}else{numComments=0}if(rollup.comparedByRA&&self.question.hasRandomAssignment()){variationID=self.question.randomAssignmentOption}else{variationID=crossedOption.variable_id||0;variationID=variationID.toString()}totalNumComments+=numComments;cellData={hasComments:numComments>0,numComments:numComments,optionID:self.question.commentField.id,crossedOptionID:crossedOption.id,matrixCrossTab:matrixCross,variationID:variationID};cellsData.push(cellData)});if(self.isMirrored){colSpan=self.columns.length+2}else{colSpan=self.crossedOptions.length+2}return{crossedOptionLabels:labelsData,otherOptionLabel:self.question.commentField.text,crossedOptionCells:cellsData,totalNumComments:totalNumComments,colSpan:colSpan}},_renderOtherCommentsTable:function(){var self=this,otherTableData=self._getOtherTableData();self.$el.append(SM.Template.render("compared-other-comments-for-menu-matrix-table",otherTableData))}});SM.BenchmarkDistributionTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"BenchmarkDistributionTableView",__templateID:"summary-table-template",__beforeRender:function(){SM.BaseSummaryTableView.__beforeRender.call(this);if(this.question.isNPS()){this._getNpsData()}if(this.get("isTop2")){this.decimalPlacesPercentage=1}},__afterRender:function(){SM.BaseSummaryTableView.__afterRender.call(this);if(!this.get("isTop2")&&!this.question.isCompared()){this._renderTitle()}},_renderTitle:function(){var benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),isNPS=!!this.npsSummary,isTMBC=this.question.survey.isTMBCTemplate(),userScore,quartile,title;if(benchmarkRollup.hasError()){return}if(this.npsSummary){userScore=this.npsSummary.score.summary.summary.options.Score.count}else{userScore=benchmarkRollup.getResponseMean(this.question.ID)}quartile=benchmarkRollup.calculateQuartile(userScore,isNPS);quartile.scoreName=isTMBC?Globalize.localize("Your average"):Globalize.localize("Your score");quartile.isTMBC=isTMBC;title=SM.Template.render("benchmark-quartile-table-title",quartile);this.$el.prepend($("<br/>"));this.$el.prepend($(title));this.$el.find(".q").popout()},_getTableClasses:function(){var classes=SM.BaseSummaryTableView._getTableClasses.call(this);return classes+" benchmark"},_getTableEvents:function(){return{tdClick:this._onTdClick}},_onTdClick:function(e){var $menuTgt=$(e.currentTarget),dimension=$menuTgt.closest("td").attr("data-dimension-id"),survey=this.question.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();if(dimension==="segment-name"){SM.BenchmarkActionMenu.actionMenu(this,$menuTgt,currentSegment,"question",e,true)}},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData,rows=this.answerStructures.rows;labelsData=[{text:"",dimensionType:self.DIMENSION_TYPES.LABELS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMinimum:false}}];if(self.question.isTop2()&&self.question.isCompared()){labelsData.push({text:Globalize.localize("Top 2 Box Score"),dimensionType:self.DIMENSION_TYPES.RESPONSES,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMinimum:false}})}else{_.each(rows,function(row){labelsData.push({text:row.text,dimensionType:self.DIMENSION_TYPES.RESPONSES,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMinimum:false}})})}labelsData.push({text:self.localizedLabels.total,dimensionType:self.DIMENSION_TYPES.TOTALS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMaximum:false}});headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_buildLocalizedLabels:function(){var self=this;self.localizedLabels={dataSegment:Globalize.localize("Segment"),min:Globalize.localize("Minimum"),lowerQuartile:Globalize.localize("Lower Quartile"),median:Globalize.localize("Median"),upperQuartile:Globalize.localize("Upper Quartile"),max:Globalize.localize("Maximum"),total:Globalize.localize("Total")}},_shouldIncludePercentageData:function(dimensionType){if(this.question.isTop2()){return true}return SM.BaseSummaryTableView._shouldIncludePercentageData.call(this,dimensionType)},_formattedNumResponses:function(numResponses,dimensionType){var decimalPlaces=dimensionType==="responses"?0:2,formatType=SM.Highcharts.getGlobalizeFormatType("absolute",decimalPlaces);return Globalize.format(numResponses,formatType)},_getNPSTableBodyRowData:function(options){var self=this,row,cells=[],cell,series=options.series;_.each(series,function(seriesItem){seriesItem.__options={template:"benchmark-nps-simple-table-response-cell",defaultContext:{value:seriesItem.data[0].value}};cell=self._buildSeriesCell(seriesItem,0);cells.push(cell)});row={cells:cells};return[row]},_buildTableBodyRowData:function(){var self=this,bodyRowData,benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.ID),labelsData,seriesData=self.buildSimpleBenchmarkSeries({colors:["#000","#000"],tableOutput:true,isTable:true,distribution:true,nps:self.question.isNPS(),isTop2:self.question.isTop2(),isCompared:self.question.isCompared()}),md={name:benchmarkRollup.getSegmentName()};if(this.question.isNPS()){return this._getNPSTableBodyRowData({series:seriesData})}if(!this.question.isCompared()){md.sampleSize=benchmarkRollup.getSampleSize()}labelsData=[{dimensionID:"segment-name",labelHTML:SM.Template.render("benchmark-table-data-segment-name-cell",md)}];bodyRowData=self._getTableBodyRowData({labelsData:labelsData,series:seriesData});return bodyRowData},_buildTableFooterRowData:function(){var footerRowData,benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),isNPS=this.question.isNPS(),responseMean=isNPS?this.getNPSScore():benchmarkRollup.getResponseMean(this.question.ID),responseMeanStr=Globalize.format(responseMean,isNPS?"n0":"n2"),scoreName=isNPS?"Your Net Promoter&#174; Score":"Your score";if(isNPS||this.question.isCompared()){return[]}footerRowData=[{context:{responseMean:responseMeanStr,scoreName:Globalize.localize(scoreName)},template:"benchmark-quartile-table-footer-row"}];return footerRowData}});SM.BenchmarkQuartileTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"BenchmarkQuartileTableView",__templateID:"summary-table-template",__beforeRender:function(){SM.BaseSummaryTableView.__beforeRender.call(this);if(this.question.isNPS()){this._getNpsData()}},__afterRender:function(){SM.BaseSummaryTableView.__afterRender.call(this);this._renderTitle()},_renderTitle:function(){var benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),isTMBC=this.question.is_tmbc,isNPS=!!this.npsSummary,userScore,quartile,title;if(benchmarkRollup.hasError()){return}this.$el.prepend($("<br/>"));if(this.npsSummary){if(this.npsSummary.score.summary.summary.options.Score.noResponses){return}userScore=this.npsSummary.score.summary.summary.options.Score.count}else{userScore=benchmarkRollup.getResponseMean(this.question.ID)}quartile=benchmarkRollup.calculateQuartile(userScore,isNPS);quartile.isCompared=this.question.isCompared();quartile.scoreName=isTMBC?Globalize.localize("Your average"):Globalize.localize("Your score");quartile.isTMBC=isTMBC;title=SM.Template.render("benchmark-quartile-table-title",quartile);this.$el.prepend($(title));this.$el.find(".q").popout()},_getTableClasses:function(){return SM.BaseSummaryTableView._getTableClasses.call(this)+" benchmark"},_getTableEvents:function(){return{tdClick:this._onTdClick}},_onTdClick:function(e){var $menuTgt=$(e.currentTarget),dimension=$menuTgt.closest("td").attr("data-dimension-id"),survey=this.question.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();if(dimension==="segment-name"){SM.BenchmarkActionMenu.actionMenu(this,$menuTgt,currentSegment,"question",e,true)}},_buildTableHeaderRowData:function(){var self=this,labelsData=[];if(!this.question.isNPS()){labelsData.push({text:"",dimensionType:self.DIMENSION_TYPES.LABELS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMinimum:false}})}labelsData=labelsData.concat([{text:self.localizedLabels.min,dimensionType:self.DIMENSION_TYPES.MIN,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMinimum:true}},{text:self.localizedLabels.lowerQuartile,dimensionType:self.DIMENSION_TYPES.LOWER_QUARTILE,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isLowerQuartile:true}},{text:self.localizedLabels.median,dimensionType:self.DIMENSION_TYPES.MEDIAN,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMedian:true}},{text:self.localizedLabels.upperQuartile,dimensionType:self.DIMENSION_TYPES.UPPER_QUARTILE,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isUpperQuartile:true}},{text:self.localizedLabels.max,dimensionType:self.DIMENSION_TYPES.MAX,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMaximum:true}}]);if(!this.question.isNPS()&&this.question.getRollup().display.getChartType()!=="boxplot"){labelsData.push({text:self.localizedLabels.total,dimensionType:self.DIMENSION_TYPES.TOTALS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false,isMaximum:false}})}return self._getTableHeaderRowDataForLabels({labelsData:labelsData})},_buildLocalizedLabels:function(){var self=this;self.localizedLabels={dataSegment:Globalize.localize("Segment"),min:Globalize.localize("Minimum"),lowerQuartile:Globalize.localize("Lower Quartile"),median:Globalize.localize("Median"),upperQuartile:Globalize.localize("Upper Quartile"),max:Globalize.localize("Maximum"),total:Globalize.localize("Total")}},_formattedNumResponses:function(numResponses,dimensionType){var decimalPlaces=dimensionType==="responses"?0:2,formatType=SM.Highcharts.getGlobalizeFormatType("absolute",decimalPlaces);return Globalize.format(numResponses,formatType)},_getNPSTableBodyRowData:function(options){var self=this,cells=[];_.each(options.series,function(seriesItem){seriesItem.__options={template:"benchmark-nps-simple-table-response-cell",defaultContext:{value:seriesItem.data[0].value}};cells.push(self._buildSeriesCell(seriesItem,0))});return[{cells:cells}]},_buildTableBodyRowData:function(){var self=this,benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.ID),seriesData=self.buildSimpleBenchmarkSeries({colors:["#000","#000"],tableOutput:true,nps:this.question.isNPS(),includeTotal:this.question.getRollup().display.getChartType()!=="boxplot"}),md={name:benchmarkRollup.getSegmentName()};if(this.question.isNPS()){return this._getNPSTableBodyRowData({series:seriesData})}return self._getTableBodyRowData({labelsData:[{dimensionID:"segment-name",labelHTML:SM.Template.render("benchmark-table-data-segment-name-cell",md)}],series:seriesData})},_buildTableFooterRowData:function(){var benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),isNPS=this.question.isNPS(),isTMBC=this.question.is_tmbc,responseMean=isNPS?this.getNPSScore():benchmarkRollup.getResponseMean(this.question.ID),noResponses=isNPS?!this.isNPSScoreValid():responseMean===0,responseMeanStr=Globalize.format(responseMean,isNPS?"n0":"n2"),scoreName=isTMBC?"Your average":isNPS?"Your Net Promoter&#174; Score":"Your score";if(this.question.isCompared()){return[]}return[{context:{responseMean:responseMeanStr,noResponses:noResponses,includeTotal:false,isNPS:isNPS,scoreName:Globalize.localize(scoreName)},template:"benchmark-quartile-table-footer-row"}]}});SM.BenchmarkMatrixTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"BenchmarkMatrixTableView",__templateID:"summary-table-template",__afterRender:function(){var self=this,$title,score;SM.BaseSummaryTableView.__afterRender.call(this);if(self.display.isTop2ChartType()&&!self.benchmarkSummary.hasError()){score=""+Math.round(self.top2pct*10)/10+"%";$title=SM.Template.render("top2-table-title",{score:score});self.$el.prepend($title);self.$el.find(".q").popout()}},_onThClick:function(e){var $tgt=$(e.currentTarget),survey=this.question.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();if(!$tgt.hasClass("no-action-menu")){SM.BenchmarkActionMenu.actionMenu(this,$tgt,currentSegment,"question",e,true)}},_setSeriesOptions:function(seriesOptions){var self=this;seriesOptions.includeTotal=false;seriesOptions.isTable=true;seriesOptions.totalSeriesName=self.localizedLabels.total;if(this.display.isTop2ChartType()){self.decimalPlacesPercentage=1}if(self.question.isRating()||self.question.isRanking()){seriesOptions.includeAverage=true;if(self.question.isRating()){seriesOptions.averageSeriesName=self.localizedLabels.averageRating}else{seriesOptions.averageSeriesName=self.localizedLabels.averageRanking}}},_setLabelsAndSeriesData:function(){var self=this,isTop2=this.get("isTop2"),sortedRows,seriesOptions=self.get("seriesOptions");if(self.question.compositeAnswerStructure&&!isTop2){sortedRows=self.question.structure.answers.rows}else{sortedRows=self.sortedRowsList[0]}if(isTop2){self.seriesData=self.buildTop2StackedSeries({isTable:true})}else{self.seriesData=self.buildBenchmarkMatrixSeries(seriesOptions)}self.labelsData=self._getTableLabelsData(sortedRows);self.labelsData.hideActionMenu=true},_getTableClasses:function(){var classes=SM.BaseSummaryTableView._getTableClasses.call(this);return classes+" benchmark-table"},_getCommentsPerRowTableLabelsData:function(rows){var self=this,summary,rowSummary,cell,responsesCount;if(self.question.compositeAnswerStructure){summary=self.rollup.summary.summary}else{summary=self.summary.summary}return _.map(rows,function(row){rowSummary=summary.options[row.id];responsesCount=rowSummary&&rowSummary.row_other?rowSummary.row_other:0;cell={labelText:row.text,labelHTML:row.mediaHTML,hasCommentsPerRow:true,optionID:row.id,responsesCount:responsesCount,rowHasComments:responsesCount>0};return cell})},_getTableHeaderRowDataForSeries:function(options){var series=options.series,scopedDimensionID=options.scopedDimensionID;var self=this,cells=[],cell,cssClasses,numTableRows=series[0].data.length,isSortable=numTableRows>1;cssClasses=self._getTableHeaderCellCSSClasses(isSortable,"header");cell={template:"table-header-cell",context:{labelText:Globalize.localize("Answer Choices"),classes:cssClasses,dimensionType:"header",dimensionID:"0",hasCommentsPerRow:false,optionID:null,variationID:"0",responsesCount:0,columnHasComments:false,colSpan:1,hideActionMenu:true}};cells.push(cell);_.each(series,function(seriesItem,index){var itemOptions=seriesItem.__options,dimensionType=itemOptions.dimensionType,dimensionID=itemOptions.dimensionID,labelText=itemOptions.labelText,labelHTML=labelText,hideActionMenu=true,md={};if(index===1){md.name=labelText;if(!self.question.survey.isTMBCTemplate()){md.sampleSize=itemOptions.sampleSize}labelHTML=SM.Template.render("benchmark-table-data-segment-name-cell",md);hideActionMenu=true}cssClasses=self._getTableHeaderCellCSSClasses(isSortable,dimensionType,dimensionID,scopedDimensionID);if(hideActionMenu){cssClasses=cssClasses+" no-action-menu"}cell={template:"table-header-cell",context:{labelHTML:labelHTML,classes:cssClasses,dimensionType:dimensionType,dimensionID:dimensionID,hasCommentsPerRow:itemOptions.hasCommentsPerRow,optionID:dimensionID,variationID:"0",responsesCount:itemOptions.numComments,columnHasComments:itemOptions.numComments>0,colSpan:itemOptions.colSpan,hideActionMenu:hideActionMenu}};cells.push(cell)});return[{cells:cells}]},_getTableHeaderRowDataForLabels:function(options){var self=this,labelsData=options.labelsData,cssClasses,cell,cells=[],numTableRows=self.numRows,isSortable=numTableRows>1;cssClasses=self._getTableHeaderCellCSSClasses(isSortable,"header");cssClasses=cssClasses+" no-action-menu";cell={template:"table-header-cell",context:{labelText:Globalize.localize("Answer Choices"),classes:cssClasses,dimensionType:"header",hideActionMenu:true,variationID:"0"}};cells.push(cell);_.each(labelsData,function(labelData){var labelText=labelData.text;cssClasses=self._getTableHeaderCellCSSClasses(isSortable,labelData.dimensionType);cssClasses=cssClasses+" no-action-menu";cell={template:"table-header-cell",context:{labelText:labelText,classes:cssClasses,dimensionType:labelData.dimensionType,hideActionMenu:labelData.hideActionMenu,variationID:"0"}};cells.push(cell)});return[{cells:cells}]},_buildTableHeaderRowData:function(){var self=this,headerRowData;headerRowData=self._getTableHeaderRowDataForSeries({series:self.seriesData,includeBlankCell:true});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData;bodyRowData=self._getTableBodyRowData({labelsData:self.labelsData,series:self.seriesData});return bodyRowData},_buildTableFooterRowData:function(){var self=this,isTop2=this.get("isTop2"),answered=isTop2?self.rollup.answered:self.summary.answered,footerOptions,cells=[],rows=[],row,numComments,colSpan;if(self._hasCommentField()&&!self._hasCommentFieldPerRow()){numComments=self.summary.other_option||0;colSpan=self.seriesData.length+1;footerOptions={colSpan:colSpan,optionID:self.question.commentField.id,variationID:self.question.randomAssignmentOption,hasComments:numComments>0,numComments:numComments}}cells.push({template:"benchmark-table-footer-label-cell",context:{}});cells.push({template:"benchmark-table-footer-total-cell",context:{total:Globalize.format(answered,"n0")}});cells.push({template:"benchmark-table-footer-total-cell",context:{total:Globalize.format(self.benchmarkSummary.getNumResponses(),"n0")}});rows.push({cells:cells});if(self._shouldShowCommentsRow()){row={template:"table-footer-comments-row",context:{colSpan:footerOptions.colSpan,optionID:footerOptions.optionID,variationID:footerOptions.variationID,hasComments:footerOptions.hasComments,numComments:footerOptions.numComments}};rows.push(row)}return rows}});SM.BenchmarkNpsDistributionTableView=SM.Views.deepExtend(SM.NpsSimpleSummaryTableView,{__NAME:"BenchmarkNpsDistributionTableView",__templateID:"summary-table-template",__beforeRender:function(){var self=this;self._getDisplayOptions();self._getSortedSummaryData();self._getNpsData()},__afterRender:function(){var self=this;self.$el.empty();self._renderDistributionTable();if(!self.question.isCompared()){self._renderTitle()}},__init:function(){SM.NpsSimpleSummaryTableView.__init.call(this);this.$el.on(SM.Event.CLICK,"[data-dimension-id=segment-name] .sm-table-label-wrapper[segment-name]",{self:this},this._onTdClick)},_renderTitle:function(){var title=SM.Template.render("benchmark-nps-distribution-table-title",{});this.$el.prepend($(title))},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData;labelsData=[{text:"",dimensionType:self.DIMENSION_TYPES.LABELS,hideActionMenu:true},{text:self.localizedLabels.responses,dimensionType:self.DIMENSION_TYPES.RESPONSES,hideActionMenu:true}];headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_renderDistributionTable:function(){var self=this,md={rows:[]},content;if(self.nps_depth==="score"){self.decimalPlaces=2;self.decimalPlacesPercentage=2}md.isCompared=self.question.isCompared();if(!md.isCompared){md.rows=md.rows.concat(self._buildUserDistributionContext())}md.rows=md.rows.concat(self._buildBenchmarkDistributionContext(md.isCompared));md.hasHeader=self.isDepthDetailed;content=SM.Template.renderHTML("nps-benchmark-distribution-table",md);self.$el.prepend(content)},_buildTableCaptionData:function(){return{template:"table-caption",context:{caption:Globalize.localize("Answer Choices"),dimensionID:"scopedDimension.id",mediaCaption:Globalize.localize("Answer Choices"),classes:""}}},_buildUserDistributionContext:function(){var md;md=this._buildDistributionSeries();md.segmentName=Globalize.localize("Your Responses");md.isBenchmark=false;md.hideActionMenu=true;return md},_buildBenchmarkDistributionContext:function(){var self=this,seriesData,dataSegment=this.question.survey.dataSegmentList.getSelectedSegment(),benchmarkRollup=this.question.survey.getBenchmarkRollup(this.question.ID),decimalPlacesPercentage=self.decimalPlacesPercentage,formatYValue=SM.Highcharts.formatYValue,distributionData;seriesData=self.buildSimpleBenchmarkSeries({tableOutput:true,nps:true,distribution:true});distributionData={segmentName:dataSegment.name(),orgCount:Globalize.format(benchmarkRollup.getSampleSize(),"n0"),isBenchmark:true,Detractors:{name:seriesData[0].data[0].name,percent:formatYValue(seriesData[0].data[0].percentageY,"percent",decimalPlacesPercentage),value:formatYValue(seriesData[0].data[0].absoluteY,"number",0)},Passives:{name:seriesData[1].data[0].name,percent:formatYValue(seriesData[1].data[0].percentageY,"percent",decimalPlacesPercentage),value:formatYValue(seriesData[1].data[0].absoluteY,"number",0)},Promoters:{name:seriesData[2].data[0].name,percent:formatYValue(seriesData[2].data[0].percentageY,"percent",decimalPlacesPercentage),value:formatYValue(seriesData[2].data[0].absoluteY,"number",0)},Score:formatYValue(seriesData[2].data[0].percentageY-seriesData[0].data[0].percentageY,"number",0)};return[distributionData]},_onTdClick:function(e){var $menuTgt=$(e.currentTarget),dimension=$menuTgt.closest("td").attr("data-dimension-id"),survey=this.question.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();if(dimension==="segment-name"){SM.BenchmarkActionMenu.actionMenu(this,$menuTgt,currentSegment,"question",e,true)}},_getDisplayOptions:function(){var self=this;SM.Summarizable._getDisplayOptions.call(self);self.nps_depth=self.displayData.nps_depth;self.isDepthDetailed=self.displayData.isDepthDetailed}});SM.ComparedAverageTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"ComparedAverageTableView",__templateID:"summary-table-template",__beforeRender:function(){SM.BaseSummaryTableView.__beforeRender.call(this)},__afterRender:function(){SM.BaseSummaryTableView.__afterRender.call(this)},_getTableClasses:function(){var classes=SM.BaseSummaryTableView._getTableClasses.call(this);return classes+" benchmark compared-avg"},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData;labelsData=[{text:"",dimensionType:self.DIMENSION_TYPES.LABELS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:false}},{text:self.localizedLabels.score,dimensionType:self.DIMENSION_TYPES.TOTALS,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isScore:true}}];headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_buildLocalizedLabels:function(){var self=this;self.localizedLabels={dataSegment:Globalize.localize("Segment"),min:Globalize.localize("Minimum"),lowerQuartile:Globalize.localize("Lower Quartile"),median:Globalize.localize("Median"),upperQuartile:Globalize.localize("Upper Quartile"),max:Globalize.localize("Maximum"),total:Globalize.localize("Total"),score:Globalize.localize("Score")}},_formattedNumResponses:function(numResponses,dimensionType){var decimalPlaces=dimensionType==="responses"?0:2,formatType=SM.Highcharts.getGlobalizeFormatType("absolute",decimalPlaces);return Globalize.format(numResponses,formatType)},_buildTableBodyRowData:function(){var self=this,bodyRowData,labelsData=[],seriesData=self.buildComparedAverageSeries({tableOutput:true});_.each(this.question.compareStructure.answers.crossedOptions,function(xOption){labelsData.push({labelText:xOption.text,hideActionMenu:true})});bodyRowData=self._getTableBodyRowData({labelsData:labelsData,series:seriesData});return bodyRowData},_buildTableFooterRowData:function(){return[]},_getTableEvents:function(){return{}}});SM.SummaryTaRowView=SM.Views.register({__NAME:"SummaryTaRowView",__templateID:"summary-ta-row-template",__model:"taModel",__init:function(){if(!this.taModel.hasLoaded()){this.taModel.on("loaded",{self:this},this._onLoaded);this.taModel.fetch()}},__create:function(options){this.question=options.question;this.containerView=null},__destroy:function(){this.taModel.off("loaded",this._onLoaded);if(this.containerView){this.containerView.destroy()}},__beforeRender:function(){return{isLoading:!this.taModel.hasLoaded()}},__afterRender:function(){if(this.taModel.hasLoaded()){this.containerView=SM.Views.create(this.taModel.filoData?SM.SummaryFileUploadContainerView:SM.TaContainerView,{question:this.question,model:this.taModel});this.$el.find("td").append(this.containerView.el)}},_onLoaded:function(e){e.data.self.render()}});SM.MenuMatrixBasicStatsTableView=SM.Views.extend(SM.BaseMenuMatrixSummaryTablesView,{__NAME:"MenuMatrixBasicStatsTableView",dimensionalSplitKey:"rows",_setLabelsAndSeriesData:function(row){var self=this,columns,columnChoices;columnChoices=self.columns;columns=SM.BasicStatsUtils.getStructure();self.isBasicStats=true;self.labelsData=self._getTableLabelsData(self.columns);self.seriesData=self.buildComparedMatrixSeriesNumericalBasicStats(row,columns,columnChoices)},_hasOtherCommentsTable:function(){return false},_buildTableFooterRowData:function(){}});SM.MatrixBasicStatsTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"MatrixBasicStatsTableView",__templateID:"summary-table-template",_buildTableCaptionData:function(){return{template:"table-caption-bs-stats",context:{caption:"Basic Statistics",dimensionID:"",mediaCaption:Globalize.localize("Basic Statistics"),classes:""}}},_setLabelsAndSeriesData:function(){var self=this,sortedRows,sortedColumns;if(self.question.isCompared()){sortedColumns=self.sortedColumnsListBS[0];self.labelsData=self._getTableLabelsData(sortedColumns);self.seriesData=self.buildMirroredMatrixSeries({isBasicStats:true,rows:SM.BasicStatsUtils.getStructure("row")})}else{sortedRows=self.sortedRowsListBS[0];self.seriesData=self.buildMatrixSeries({isBasicStats:true,columns:SM.BasicStatsUtils.getStructure()});self.labelsData=self._getTableLabelsData(sortedRows)}},_buildTableHeaderRowData:function(){var self=this,headerRowData;headerRowData=self._getTableHeaderRowDataForSeries({series:self.seriesData,includeBlankCell:true});return headerRowData},_buildTableBodyRowData:function(){var self=this,bodyRowData;bodyRowData=self._getTableBodyRowData({labelsData:self.labelsData,series:self.seriesData});return bodyRowData},_buildTableFooterRowData:function(){}});SM.SimpleBasicStatsTableView=SM.Views.extend(SM.BaseSummaryTableView,{__NAME:"SimpleBasicStatsTableView",__templateID:"summary-table-template",__afterRender:function(){var self=this;self.$el.empty();self._renderTable();self.$el.find(".q").popout()},_renderTable:function(){var self=this,md,content;md=self._buildTemplateData();content=SM.Template.renderHTML("simple-basic-stats-table",md);self.$el.prepend(content)},_buildTemplateData:function(){var self=this,seriesData;if(self.question.isMatrix()){seriesData=self.buildMatrixSeries({isBasicStats:true,columns:SM.BasicStatsUtils.getStructure()});return{min:self._formattedNumResponses(seriesData[0].data[0].absoluteY),max:self._formattedNumResponses(seriesData[1].data[0].absoluteY),median:self._formattedNumResponses(seriesData[2].data[0].absoluteY),mean:self._formattedNumResponses(seriesData[3].data[0].absoluteY),std:self._formattedNumResponses(seriesData[4].data[0].absoluteY)}}seriesData=self.buildSimpleSeries(self.summary,SM.BasicStatsUtils.getStructure(),{isBasicStats:true});return{min:self._formattedNumResponses(seriesData[0].data[0].absoluteY),max:self._formattedNumResponses(seriesData[0].data[1].absoluteY),median:self._formattedNumResponses(seriesData[0].data[2].absoluteY),mean:self._formattedNumResponses(seriesData[0].data[3].absoluteY),std:self._formattedNumResponses(seriesData[0].data[4].absoluteY)}}});SM.TMBCTableContainerView=SM.Views.register({__NAME:"TMBCTableContainerView",__templateID:"summary-table-container-template",__model:"tmbc",__create:function(options){var self=this;self.tmbcType=options.tmbcType;self.tableViewType=options.tableViewType;self.isExport=options.isExport;self._showingBenchmark=true;_.bindAll(this,"_onTableDisplayChange","_setHighlightedLabelCell")},__init:function(){var self=this;self.$el.on("setHighlightedLabelCell",self._setHighlightedLabelCell)},__afterRender:function(){var self=this,tableView,tableViewType;
if(self._shouldHideTable()){return}try{tableViewType=self._getTableViewType();tableView=SM.Views.create(tableViewType,{model:self.tmbc,tmbcType:self.tmbcType,highlightedDimensionID:self.highlightedDimensionID,isExport:self.isExport});self.$el.html(tableView.el)}catch(exception){self._handleRenderingError(exception)}},_hasBenchmarking:function(){return this.survey.owner.hasBenchmarking()&&this._showingBenchmark},_getTableViewType:function(){return SM.TMBCQuartileTableView},_shouldHideTable:function(){return false},_handleRenderingError:function(exception){var self=this,div;div=document.createElement("div");div.innerHTML=SM.Template.render("summary-table-display-error-template");self.$el.html(div);SM.Error.log(exception,"tmbc summary table rendering error")},_setHighlightedLabelCell:function(e){var self=this;self.highlightedDimensionID=e.answerID},_unsetHighlightedLabelCell:function(){var self=this;self.highlightedDimensionID=null},_onTableDisplayChange:function(){this.render()}});SM.TMBCQuartileTableView=SM.Views.extend(SM.Sortable,{__NAME:"TMBCQuartileTableView",__templateID:"summary-table-template",__model:"tmbc",__defaults:{tableOptions:{headingsType:null,showFooter:false,hideExpandLinks:false},seriesOptions:{},seriesData:{},labelsData:{}},__create:function(options){var self=this;self._buildLocalizedLabels();self._bindEvents(options.events);self.seriesOptions=self.__settings.seriesOptions;self.tableOptions=self.__settings.tableOptions;self.isExport=options.isExport;self.tmbcType=options.tmbcType},_bindEvents:function(){_.bindAll(this,"_onCaptionClick","_onThClick","_onTdClick","_onThActionSelected")},__beforeRender:function(){},__afterRender:function(){this.$el.empty();this._renderTable();this.$el.find(".q").popout();this._renderTitle()},_renderTable:function(){var self=this,tableOptions;_.each(["_buildTableHeaderRowData","_buildTableBodyRowData","_buildTableFooterRowData"],function(method){if(self[method]===undefined){throw new Error("You must define "+method+" in "+self.__NAME)}});if(self.tmbc.hasError()){return}if(self._setLabelsAndSeriesData){self._setLabelsAndSeriesData()}tableOptions=self._getTableOptions();SM.Hightables.renderTable(tableOptions)},_renderTitle:function(){var title,quartile;this.$el.prepend($("<br/>"));quartile=this.tmbc.calculateQuartile(this.tmbcType);title=SM.Template.render("tmbc-quartile-table-title",quartile);this.$el.prepend($(title));this.$el.find(".q").popout()},__init:function(){var self=this;self.$el.on("actionMenu.actionSelected","td",{self:self},self._onTdActionSelected)},_getTableOptions:function(){var self=this,tableData=self._getTableData(),tableClasses=self._getTableClasses(),isExport=!!self.isExport,hightablesOptions;hightablesOptions={target:self.$el,tableData:tableData,tableClasses:tableClasses,useDivs:isExport,flattenNestedTables:isExport,events:self._getTableEvents()};return hightablesOptions},_getTableData:function(options){var self=this,captionData,theadRowData,tbodyRowData,tfootRowData;options=options||{};tbodyRowData=self._buildTableBodyRowData(options);theadRowData=self._buildTableHeaderRowData(options);tfootRowData=self._buildTableFooterRowData(options);return{caption:captionData,thead:{rows:theadRowData},tbody:{rows:tbodyRowData},tfoot:{rows:tfootRowData}}},_getTableHeaderRowDataForLabels:function(options){var self=this,labelsData=options.labelsData,includeBlankCell=options.includeBlankCell,rows=[],row={},cells=[],cell,cssClasses,numTableRows,isSortable;numTableRows=self.numRows;isSortable=numTableRows>1;if(includeBlankCell){cell=self._buildBlankTableHeaderCell({isSortable:isSortable});cells.push(cell)}_.each(labelsData,function(labelData){cssClasses=self._getTableHeaderCellCSSClasses(isSortable,labelData.dimensionType);cell={template:labelData.template||"table-header-cell",context:{labelText:labelData.text,classes:cssClasses,dimensionType:labelData.dimensionType,hideActionMenu:labelData.hideActionMenu,variationID:"0"}};if(labelData.flags){$.extend(cell.context,labelData.flags)}cells.push(cell)});row.cells=cells;rows.push(row);return rows},_getTableHeaderRowDataForSeries:function(options){var series=options.series,includeBlankCell=options.includeBlankCell,scopedDimensionID=options.scopedDimensionID;var self=this,rows=[],cells=[],row={},cell,cssClasses,numTableRows,isSortable,hideActionMenu,labelHTML;numTableRows=series[0].data.length;isSortable=numTableRows>1;if(includeBlankCell){cell=self._buildBlankTableHeaderCell({scopedDimensionID:scopedDimensionID,isSortable:isSortable});cells.push(cell)}_.each(series,function(seriesItem){var itemOptions=seriesItem.__options,dimensionType=itemOptions.dimensionType,dimensionID=itemOptions.dimensionID;cssClasses=self._getTableHeaderCellCSSClasses(isSortable,dimensionType,dimensionID,scopedDimensionID);if(options.hideActionMenu){hideActionMenu=true}else{hideActionMenu=false}labelHTML=itemOptions.labelHTML;cell={template:"table-header-cell",context:{labelText:itemOptions.labelText,labelHTML:labelHTML,classes:cssClasses,dimensionType:dimensionType,dimensionID:dimensionID,hasCommentsPerRow:itemOptions.hasCommentsPerRow,optionID:dimensionID,variationID:"0",responsesCount:itemOptions.numComments,columnHasComments:itemOptions.numComments>0,colSpan:itemOptions.colSpan,hideActionMenu:hideActionMenu}};cells.push(cell)});row.cells=cells;rows.push(row);return rows},_buildBlankTableHeaderCell:function(options){var self=this,cssClasses,dimensionType,hideActionMenu,scopedDimensionID=options.scopedDimensionID,isSortable=options.isSortable;hideActionMenu=false;dimensionType="labels";cssClasses=self._getTableHeaderCellCSSClasses(isSortable,dimensionType,null,scopedDimensionID);return{template:"table-header-blank-cell",context:{classes:cssClasses,dimensionType:dimensionType,hideActionMenu:hideActionMenu,isStatsHeader:false}}},_getTableBodyRowData:function(options){var self=this,rows=[],row,cells=[],cell,series=options.series;_.each(series,function(seriesItem){cell=self._buildSeriesCell(seriesItem,0);cells.push(cell)});row={cells:cells};rows.push(row);return rows},_buildLabelCell:function(labelData){return{template:"table-label-cell",context:labelData}},_buildSeriesCell:function(seriesItem,tableRowIndex){var self=this,seriesData,dimensionType,context=seriesItem.__options.defaultContext||{},template,absoluteY;seriesData=seriesItem.data[tableRowIndex];dimensionType=seriesItem.__options.dimensionType;template=seriesItem.__options.template||"table-response-cell";absoluteY=seriesData?seriesData.absoluteY:0;if(self.tmbcType===self.tmbc.TMBC_TYPE_GEI){context.numResponses=self._formattedNumResponses(absoluteY,dimensionType)}else{context.numResponses=self._formattedPercentage(absoluteY)}return{template:template,context:context}},_formattedNumResponses:function(numResponses){var decimalPlaces=0,formatType=SM.Highcharts.getGlobalizeFormatType("absolute",decimalPlaces);return Globalize.format(numResponses,formatType)},_formattedPercentage:function(value){var formatType=SM.Highcharts.getGlobalizeFormatType("percent",0);return Globalize.format(value/100,formatType)},_getTableFooterRowData:function(){return[{template:"simple-table-footer-row",context:{questionIsMultiResponse:false,numRespondents:Globalize.format(this.tmbc.getTMBCValue(this.tmbcType),"n0")}}]},_getTableHeaderCellCSSClasses:function(isSortable,dimensionType,dimensionID,scopedDimensionID){var self=this,cssClasses=[],sortData;sortData=self._getSortData(scopedDimensionID);if(isSortable){cssClasses.push("sortable")}if(_.contains(["totals","averageRating","averageNumber","averageRanking","dataSegment"],dimensionType)){cssClasses.push(dimensionType)}if(sortData&&sortData.dimensionType===dimensionType){if(dimensionID){if(sortData.dimensionID===dimensionID){cssClasses.push(sortData.order)}}else{cssClasses.push(sortData.order)}}return cssClasses.join(" ")},_getSortData:function(){return{order:"ascending"}},_onCaptionClick:function(e){var self=this,$currentTarget=$(e.currentTarget),dimensionID=$currentTarget.attr("data-dimension-id"),actionMenuOptions={answerID:dimensionID,visibleOptions:{labels:true}};SM.CustomizeActionMenu.actionMenu.call(self,e,"caption",actionMenuOptions)},_onThClick:function(e){var $currentTarget=$(e.currentTarget),dimensionType=$currentTarget.attr("data-dimension-type"),dimensionID=$currentTarget.attr("data-dimension-id"),actionMenuOptions={parent:$currentTarget,visibleOptions:{}};if(SM.App.isSharingApp()||_.isEmpty(dimensionType)||$currentTarget.hasClass("no-action-menu")){return}actionMenuOptions.visibleOptions.labels=false;actionMenuOptions.visibleOptions.number=dimensionType!=="labels";actionMenuOptions.visibleOptions.labels=false;actionMenuOptions.answerID=dimensionID},_onThActionSelected:function(){},_onTdActionSelected:function(){},_onTdMouseLeave:function(){},_onTdMouseEnter:function(){},_getTableClasses:function(){var classes=[];classes.push("sm-data-table");if(SM.App.isSharingApp()){classes.push("shared")}classes.push("sm-data-table-summary");classes.push("benchmark");return classes.join(" ")},_getTableEvents:function(){return{tdClick:this._onTdClick}},_onTdClick:function(e){var $menuTgt=$(e.currentTarget),dimension=$menuTgt.closest("td").attr("data-dimension-id"),survey=this.tmbc.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();if(dimension==="segment-name"){SM.BenchmarkActionMenu.actionMenu(this,$menuTgt,currentSegment,"tmbc",e,true)}},_buildTableHeaderRowData:function(){var self=this,headerRowData,labelsData=[];labelsData=labelsData.concat([{text:self.localizedLabels.min,dimensionType:self.DIMENSION_TYPES.MIN,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMinimum:true}},{text:self.localizedLabels.lowerQuartile,dimensionType:self.DIMENSION_TYPES.LOWER_QUARTILE,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isLowerQuartile:true}},{text:self.localizedLabels.median,dimensionType:self.DIMENSION_TYPES.MEDIAN,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMedian:true}},{text:self.localizedLabels.upperQuartile,dimensionType:self.DIMENSION_TYPES.UPPER_QUARTILE,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isUpperQuartile:true}},{text:self.localizedLabels.max,dimensionType:self.DIMENSION_TYPES.MAX,hideActionMenu:true,template:"benchmark-table-header-cell",flags:{hasHelp:true,isMaximum:true}}]);headerRowData=self._getTableHeaderRowDataForLabels({labelsData:labelsData});return headerRowData},_buildLocalizedLabels:function(){var self=this;self.localizedLabels={dataSegment:Globalize.localize("Segment"),min:Globalize.localize("Minimum"),lowerQuartile:Globalize.localize("Lower Quartile"),median:Globalize.localize("Median"),upperQuartile:Globalize.localize("Upper Quartile"),max:Globalize.localize("Maximum"),total:Globalize.localize("Total")}},_getTMBCTableBodyRowData:function(options){var self=this,row,cells=[],cell,series=options.series;_.each(series,function(seriesItem){seriesItem.__options={template:"benchmark-nps-simple-table-response-cell",defaultContext:{value:seriesItem.data[0].value}};cell=self._buildSeriesCell(seriesItem,0);cells.push(cell)});row={cells:cells};return[row]},_buildTMBCQuartileTableSeries:function(options){var self=this,series=[],seriesData,values=this.tmbc.getQuartileValuesArray(this.tmbcType);_.each(values,function(value,index){seriesData=[{y:value,absoluteY:value,percentageY:value,value:value,name:options.names[index]}];series.push({name:self.tmbc.getSegmentName(),data:seriesData,__options:{dimensionType:"averageRating",template:"benchmark-table-response-cell"}})});return series},buildTMBCSeries:function(options){options.names=[Globalize.localize("Minimum"),Globalize.localize("Lower Quartile"),Globalize.localize("Median"),Globalize.localize("Upper Quartile"),Globalize.localize("Maximum")];if(options.tableOutput){return this._buildTMBCQuartileTableSeries(options)}return this._buildTMBCQuartileChartSeries(options)},_buildTableBodyRowData:function(){var self=this,seriesData=self.buildTMBCSeries({colors:["#000","#000"],tableOutput:true,nps:false,includeTotal:false});return self._getTableBodyRowData({series:seriesData})},_buildTableFooterRowData:function(){var tmbcName=this.tmbcType===this.tmbc.TMBC_TYPE_GEI?"Your Global Engagement Index":"Your % Fully Engaged";return[{context:{tmbcValue:Globalize.format(this.tmbc.getTMBCValue(this.tmbcType),"n0"),isFE:this.tmbcType===this.tmbc.TMBC_TYPE_ENGAGEMENT,tmbcName:tmbcName},template:"tmbc-quartile-table-footer-row"}]}});SM.SummaryQuestionViewContainer=SM.Views.register({__NAME:"summaryQuestionViewContainer",__templateID:"summary-question-container-template",__model:"question",nestedQuestionDict:{},__create:function(options){this.questionViewProto=options.questionViewProto;this.isBenchmarkable=false},__beforeRender:function(){var self=this,question=self.question,hasRollupLoaded=question.hasRollupLoaded(),survey=question.survey,currentUserID=survey.currentUserID,questionViewProto=self.questionViewProto,questionHeading;if(hasRollupLoaded){if(question.hasRandomAssignment()&&question.isPresentation()){questionHeading=question.heading}return{isVisible:!question.isAfterLastLoadedRollup()&&question.isShown(),question:question,questionHeading:questionHeading,encryptedID:question.survey.encryptedID,userID:currentUserID,hasTable:questionViewProto._hasTableView,hasChart:questionViewProto._hasChartView,hasBenchmarking:false,exportEnabled:survey.isExportFormatTypeEnabled("png","chart")}}return{isVisible:false,question:question}},__afterRender:function(md){var self=this,question=self.question,hasRandomAssignment=question.hasRandomAssignment();if(md.isDisabledQuestionType||!md.isVisible){return}self.$questionContent=this.$el.find("[sm-questionview-content-container]");if(hasRandomAssignment){self._renderRandomAssignmentQuestionViews()}else{self._renderQuestionView()}if(!SM.App.isSharingApp()){self.$el.find(".share-btn").popout()}if(this._shouldShowExportBtn()){self.$el.find("[export-btn]").append(SM.Views.create(SM.ExportAllBtnView,{model:question.survey,noBorder:false,buttonName:"ExportQuestionButton",singleMode:true,question:question,hasTACloud:question.hasTACloud(),hasCloudView:question.hasCloudView(),hasChartView:question.hasChartView()}).el)}},_renderQuestionView:function(){var self=this,questionViewProto=self.questionViewProto;self.questionView=SM.Views.create(questionViewProto,{model:self.question,isBenchmarkable:self.isBenchmarkable});self.$questionContent.append(self.questionView.el)},_renderRandomAssignmentQuestionViews:function(){var self=this,questionView,randomAssignmentOption,randomAssignmentList,randomAssignmentVarID,questionModel,i=0;randomAssignmentList=this.question.randomAssignmentList;for(i;i<randomAssignmentList.length;i++){randomAssignmentOption=randomAssignmentList[i];randomAssignmentVarID=randomAssignmentOption.variable_id;questionModel=self.__settings.nestedQuestionDict[randomAssignmentVarID];if(questionModel){questionView=SM.Views.create(this.questionViewProto,{model:questionModel.question,isRandomAssignment:true,optionTypeID:randomAssignmentVarID,randomAssignmentIndex:i});self.$questionContent.append(questionView.el)}}},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,"[customize-btn]",{self:self},self._onCustomizeBtnClick).on(SM.Event.CLICK,"[share-btn]",{self:self},self._onShareBtnClick);self.$el.on("openCustomizeView",{self:self},self._onOpenCustomizeView);self.$el.on("beforeCustomizeViewAnimateIn","[sm-customize-question-view]",{self:self},self._onBeforeCustomizeViewAnimateIn);self.$el.on("afterCustomizeViewAnimateOut","[sm-customize-question-view]",{self:self},self._onAfterCustomizeViewAnimateOut);self.bindModel(self.question,"rollupLoaded",{self:self},self._onQuestionLoaded);self.bindModel(self.question.survey,"rollupsAppended",{self:self},self._onSurveyRollupsAppended)},_onCustomizeBtnClick:function(e){var self=e.data.self,$tgt=$(e.target);e.preventDefault();if(self.question.survey.isReadOnly()||$tgt.hasClass("disabled")){return}SM.Bi.uiTrigger="questionCustomizeButton";self.openCustomizeView("chartType")},_onBeforeCustomizeViewAnimateIn:function(e){var self=e.data.self;_.each(["[customize-btn]","[export-btn]","[share-btn]"],function(btn){self.$el.find(btn).addClass("hide")})},_onAfterCustomizeViewAnimateOut:function(e){var self=e.data.self;_.each(["[customize-btn]","[export-btn]","[share-btn]"],function(btn){self.$el.find(btn).removeClass("hide")});self.customizeView.$el.remove();self.customizeView=null},_onOpenCustomizeView:function(e){var self=e.data.self,tabName=e.action,answerID=e.answerID;self.openCustomizeView(tabName,{answerID:answerID})},_onShareBtnClick:function(e){e.preventDefault()},_onQuestionLoaded:function(e){e.data.self.render()},_onSurveyRollupsAppended:function(e){var self=e.data.self;if(self.question.position>e.lastLoadedPosition){self.render()}},openCustomizeView:function(tabName,options){var self=this,customizeViewOptions,scrollTop;options=options||{};if(!self.customizeView){customizeViewOptions=self._buildCustomizeViewOptions();self.customizeView=SM.Views.create(SM.CustomizeQuestionSummaryView,customizeViewOptions)}if(tabName!=="top2ChartType"){self.customizeView.tabs.open(tabName)}scrollTop=self.$el.offset().top-20;$("body").animate({scrollTop:scrollTop},250,function(){self.customizeView.animateIn(self.$el.find("[sm-questionview-content-container]"),function(){if(tabName==="labels"){self.customizeView.currentView.scrollToLabel(options.answerID)}})})},_buildCustomizeViewOptions:function(){var self=this,questionViewProto=this.questionViewProto;return{question:self.question,questionView:self.questionView,hasMirrorOptions:questionViewProto._hasMirrorOptions,hasDepthOptions:questionViewProto._hasDepthOptions,hasScaleOptions:questionViewProto._hasScaleOptions,hasShowEmptyOptions:questionViewProto._hasShowEmptyOptions,hasPieDonutCharts:questionViewProto._hasPieDonutCharts,hasStackedCharts:questionViewProto._hasStackedCharts}},_shouldShowExportBtn:function(){var survey=this.question.survey;return survey.isExportEnabled()&&!SM.App.isSharingApp()}});SM.SummaryBaseQuestionView={__templateID:"summary-question-template",__model:"question",_hasTableView:false,_hasChartView:false,_hasTextView:false,_hasFileUploadView:false,_hasPieDonutCharts:false,_hasStackedCharts:false,_hasScaleOptions:false,_hasDepthOptions:false,_hasMirrorOptions:false,_hasShowEmptyOptions:false,_hasBenchmarkingOptions:false,_tableViewType:undefined,_textViewType:undefined,_isDisabledQuestionType:false,_isPresentation:false,isRandomAssignment:false,optionTypeID:undefined,randomAssignmentIndex:undefined,__create:function(options){var self=this;if(!!self.__settings.optionTypeID&&!!self.__settings.isRandomAssignment){self.question.randomAssignmentOption=self.__settings.optionTypeID}self.rollup=self.question.getRollup();self.survey=self.question.survey;self.display=self.rollup.display;self.currentQuestionHeading=self._getQuestionHeading();self.questionContainerView=options.questionContainerView;self.isBenchmarkable=options.isBenchmarkable},__beforeRender:function(){var self=this,question=this.question,rollup=question.getRollup(),hasRollupLoaded=question.hasRollupLoaded(),survey=question.survey,currentUserID=survey.currentUserID,hasRandomAssignment=this.__settings.isRandomAssignment,questionHeading=self.currentQuestionHeading,viewedNumber,viewedPercentage,optionLetter,randomAssignmentOption,isTextPresentation,crossed_rows,i,templateName=survey.getTemplateName(),isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate(),hasPaid=survey.owner.hasBenchmarkingRestricted();crossed_rows=rollup.summary.crossed_rows;if(crossed_rows!==undefined&&hasRandomAssignment){for(i=0;i<crossed_rows.length;i++){if(question.randomAssignmentOption===crossed_rows[i]){hasRandomAssignment=false;break}}}if(hasRandomAssignment){randomAssignmentOption=question.randomAssignmentList[this.__settings.randomAssignmentIndex];questionHeading=randomAssignmentOption.variable_name||randomAssignmentOption.heading;optionLetter=this.__settings.randomAssignmentIndex;viewedNumber=parseInt(rollup.answered,0);if(this._isPresentation){viewedPercentage=Globalize.formatPercent(viewedNumber/rollup.answeredCount,2);if(question.subtype===question.QTYPE.descriptive_text){questionHeading="";isTextPresentation=true}}else{viewedPercentage=Globalize.formatPercent(viewedNumber/(parseInt(rollup.skipped,0)+viewedNumber),2)}}if(!!templateName){templateName="&qbcat="+templateName}return{isVisible:!question.isAfterLastLoadedRollup()&&hasRollupLoaded&&question.isShown(),questionHeading:questionHeading,question_id:question.ID,answered:rollup.answered,skipped:rollup.skipped,hasBenchmarking:this.isBenchmarkable,isActive:this.display.getBenchmarkDisplay(),isBenchmarkable:this.isBenchmarkable,showBenchmark:this.showBenchmark,sampleSize:5467,dateStart:"1/10/2010",dateEnd:"1/30/2012",isDisabledQuestionType:this._isDisabledQuestionType,disabledMsg:this.__settings.disabledMsg,encryptedID:this.question.survey.encryptedID,userID:currentUserID,hasRandomAssignment:hasRandomAssignment,optionLetter:optionLetter+1,viewedPercentage:viewedPercentage,viewedNumber:Globalize.format(viewedNumber,"n0"),isPresentation:this._isPresentation,isTextPresentation:isTextPresentation,templateName:templateName,isTMBC:isTMBC,toStore:toStore,hasPaid:hasPaid,user_id:survey.currentUserID,surveyId:survey.ID}},__afterRender:function(md){var self=this;if(md.isDisabledQuestionType||!md.isVisible){return}self.$questionContent=self.$el;if(self._hasChartView){self._renderChartView()}if(self._hasTableView){self._renderTableView()}if(self._hasTextView){if(self._shouldRenderTextView()){self._renderTextView()}else{self._renderUnavailableTextView()}}if(self._hasFileUploadView){self._renderFileUploadView()}if(self._isPresentation){self._renderPresentationView()}self._setMinHeight()},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,"[question-heading]",{self:self},self._onQuestionHeadingClick);self.$el.on("actionMenu.actionSelected","[question-heading]",{self:self},self._onQuestionHeadingActionSelected);self.$el.on("actionMenu.actionSelected",".sm-chart-container *",{self:self},self._onChartActionSelected);self.$el.on("actionMenu.actionSelected",".sm-data-table-container *",{self:self},self._onTableActionSelected);self.bindModel(self.display,"displayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"tempDisplayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"allDisplaysChange",{self:self},self._onDisplayChange)},_getQuestionHeading:function(){var label=this.display.getQuestionHeadingLabel();if(label&&!_.isEmpty(label.text)){return label.text}return this.question.heading},_onChartActionSelected:function(e){var self=e.data.self,canCustomizeCharts=self.survey.owner.canCustomizeCharts();e.stopPropagation();if(e.action==="colors"&&!canCustomizeCharts){SM.Bi.uiTrigger="questionChartEditColorsMenuButton";SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"customize-upgrade-dialog-template"}).open()}else{SM.Bi.uiTrigger="questionChart"+e.action+"MenuButton";self.$el.trigger({type:"openCustomizeView",action:e.action})}},_renderQuestionHeading:function(){var self=this,heading=self._getQuestionHeading();if(self.currentQuestionHeading!==heading){self.$el.find("[question-heading]").text(heading);self.currentQuestionHeading=heading}},_renderChartView:function(){var self=this,chartContainerView;chartContainerView=SM.Views.create(SM.SummaryChartContainerView,{survey:self.survey,question:self.question,randomAssignmentOption:self.question.randomAssignmentOption,questionView:self});self.$questionContent.append(chartContainerView.el);self.chartContainerView=chartContainerView},_renderTableView:function(){var self=this,tableView;tableView=SM.Views.create(SM.SummaryTableContainerView,{survey:this.survey,question:this.question,tableViewType:this._tableViewType,hasBenchmarkingOptions:this._hasBenchmarkingOptions,randomAssignmentOption:self.question.randomAssignmentOption});self.$questionContent.append(tableView.el)},_renderTextView:function(){var self=this,rollup=this.question.getRollup(),taModel=rollup.getTaModel(),textView;if(this.question.hasRandomAssignment()){taModel=rollup.getTaModel(0,0,this.question.randomAssignmentOption)}taModel.set("filterCount",rollup.answeredCount);textView=SM.Views.create(SM.TaContainerView,{model:taModel});self.$questionContent.append(textView.el)},_renderPresentationView:function(){var self=this,presentationView;presentationView=SM.Views.create(SM.SummaryPresentationContainerView,{question:this.question,randomAssignmentOption:this.question.randomAssignmentList[this.__settings.randomAssignmentIndex]});self.$questionContent.append(presentationView.el)},_renderUnavailableTextView:function(){var $target=this.$el.find(".summary-question-text-analysis-container"),html=SM.Template.render("response-data-unavailable-template");$target.append(html)},_renderFileUploadView:function(){var fileUploadView=SM.Views.create(SM.SummaryFileUploadContainerView,{question:this.question,model:this.question.getRollup().getFileUploadModel()});this.$questionContent.append(fileUploadView.el)},_onQuestionHeadingClick:function(e){var self=e.data.self,actionMenuOptions={};if(self.question.isNPS()){return}if(self._hasChartView){if(self._hasBenchmarkingOptions&&!self.display.getBenchmarkDisplay()||!self._hasBenchmarkingOptions){SM.CustomizeActionMenu.actionMenu.call(self,e,"h1",actionMenuOptions)}}},_onDisplayChange:function(e){var self=e.data.self;self._setMinHeight();self._renderQuestionHeading();if(self.isBenchmarkable){self._updateBenchmarkIcon()}},_onQuestionHeadingActionSelected:function(e){var self=e.data.self;e.stopPropagation();if(e.action==="labels"){SM.Bi.uiTrigger="questionHeadingEditLabelMenuButton";self.$el.trigger({type:"openCustomizeView",action:e.action,answerID:null})}},_onTableActionSelected:function(e){var self=e.data.self;if(e.action==="labels"){e.stopPropagation();self.$el.trigger({type:"openCustomizeView",action:e.action,answerID:e.$action.attr("data-answer-id")})}},_setMinHeight:function(){var self=this,height;setTimeout(function(){height=0;if(self.$questionContent!==undefined){_.each(self.$questionContent.children(":visible"),function(child){height+=$(child).outerHeight()});self.$questionContent.css({"min-height":height})}},150)},_shouldRenderTextView:function(){if(SM.App.isSharingApp()){return!SM.App.sharedView.hideOpenEnded()}return true},_updateBenchmarkIcon:function(){var $icon=this.$el.find(".benchmarkable-icon-ctnr"),active=this.display.getBenchmarkDisplay();if(active){$icon.addClass("active")}else{$icon.removeClass("active")}},getCurrentChartView:function(){var self=this;return self.chartContainerView.chartView}};SM.SummaryBenchmarkQuestionViewContainer=SM.Views.extend(SM.SummaryQuestionViewContainer,{__NAME:"summaryBenchmarkQuestionViewContainer",__beforeRender:function(){var self=this,md=SM.SummaryQuestionViewContainer.__beforeRender.call(self),question=this.question,survey=question.survey,rollup=question.getRollup(),isTMBC=question.survey.isTMBCTemplate(),hasRollupLoaded=question.hasRollupLoaded();self.display=rollup.display;self.benchmarkRollup=question.survey.getBenchmarkRollup(question.ID);if(hasRollupLoaded){self._showingBenchmark=self.display.isBenchmarkShown();md.hasBenchmarking=self._hasBenchmarking();self.isGaugeChart=self.display.getChartType()===self.display.DISPLAY_VALUES.score_gauge;self.isTop2Donut=self.display.getChartType()===self.display.DISPLAY_VALUES.top2_donut;md.isBenchmarkable=self.display.getChartType()!==self.display.DISPLAY_VALUES.boxplot}else{self.isGaugeChart=false;self.isTop2Donut=false;md.isBenchmarkable=true}md.isTMBC=isTMBC;if(isTMBC&&question.survey.driverRollups.hasError()){self._showingBenchmark=false}md.toStore=survey.isStoreTemplate();md.hasPaid=survey.owner.hasBenchmarkingRestricted();md.question_id=question.ID;md.user_id=survey.owner.id;md.surveyId=survey.id;md.isTop2=question.isTop2();self.isBenchmarkable=true;return md},__afterRender:function(md){var self=this,question=this.question,survey=question.survey,isOwner=question.survey.isCurrentUserAlsoOwner(),isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate();if(self.question.isTop2()&&self.display.getBenchmarkDisplay()){self.questionViewProto=SM.BenchmarkTop2QuestionView}SM.SummaryQuestionViewContainer.__afterRender.call(self,md);self._setupBenchmarkMenus();this._setBenchmarkSubheading();this._showOrHideButtons();this._showOrHideBenchmarkSubheading();if(this._showingBenchmark){this._openDataSegmentList();if(this.question.structure.is_edited&&!self.benchmarkRollup.hasError()){this._buildEditedQuestionTemplate();this._showOrHideEditedQuestionWarning()}}if(isOwner&&!question.survey.isProfilerDialogEnabled()){this._popout=this.$el.find(".benchmarkable-icon-ctnr").popout({at:"right top",offsetX:10,questionID:this.question.ID});this._popout.questionID=this.question.ID;this._popout.isTMBC=isTMBC;this._popout.toStore=toStore;this._popout.owner=this}},_onPopoutOpened:function(e){var self=e.data.self,$realPopout=$(".popout.open");if(self.question.ID===e.popout.__settings.questionID){SM.Bi.logUpsellTooltipOpened(self.question.ID)}$realPopout.on(SM.Event.CLICK,".upsell-btn",{self:self},self._onPopoutGetBenchmarksClicked)},_onPopoutGetBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),href=$tgt.attr("destination"),qid=$tgt.attr("question_id"),survey=self.question.survey,owner=survey.owner,hasPaid=owner.hasBenchmarkingRestricted(),isNPS=self.question.isNPS(),isStore=survey.isStoreTemplate(),requestDialog,popout,onDone=function(){if(isStore){window.location.href=href}else{requestDialog=SM.Views.create(SM.BenchmarkRequestDialogView,{model:survey,type:survey.getTemplateType(),triggeredFrom:"accordion"});requestDialog.open()}};e.preventDefault();e.stopPropagation();if(self.question.ID===qid){popout=self._popout.data("popout");popout._isHovered=false;popout._$msg.remove();SM.Bi.benchmarkingBuyMore(qid,"upsell_popout","question",href,hasPaid,isNPS).done(onDone).fail(onDone)}},__init:function(){var survey=this.question.survey;SM.SummaryQuestionViewContainer.__init.call(this);this.$el.on("actionMenu.actionSelected",{self:this},this._onBenchmarkingBtnClick);this.$el.on(SM.Event.CLICK,"a[summary-btn], a[benchmarking-btn]",{self:this},this._onBenchmarkingBtnClick);this.$el.on(SM.Event.CLICK,"[hide-link]",{self:this},this._onHideBenchmarksClicked);this.$el.on(SM.Event.CLICK,"[show-link]",{self:this},this._onShowBenchmarksClicked);this.$el.on("actionMenu.actionSelected","[bm-chart-type-btn]",{self:this},this._onChartTypeSelected);this.$el.on(SM.Event.CLICK,"[benchmark-sub-heading], .benchmark-nps-chart-header.right",{self:this},this._onBenchmarkSubheadingClick);if(this.benchmarkRollup){SM.log("SummaryBenchmarkQuestionViewContainer["+this.question.ID+"].__init: binding benchmarkRollupLoaded to benchmarkRollup[]");this.benchmarkRollup.rollupList.on("benchmarkRollupLoaded",{self:this},this._onBenchmarkRollupLoaded);this.benchmarkRollup.rollupList.on("benchmarkRollupsReloaded",{self:this},this._onBenchmarkRollupsReloaded)}this.$el.on(SM.Event.CLICK,".benchmarkable-icon-ctnr",{self:this},this._onBenchmarkableIconClicked);if(this.question.isTop2()){this.bindModel(this.display,"displayChange",{self:this},this._onDisplayChange);this.bindModel(this.display,"tempDisplayChange",{self:this},this._onDisplayChange);this.bindModel(this.display,"allDisplaysChange",{self:this},this._onDisplayChange)}this.__subscribe("popout.opened",this._onPopoutOpened,{self:this});survey.profiler.on("profilerOverlayBeforeOpen",{self:this},this._onProfilerOverlayBeforeOpen);survey.profiler.on("profilerOverlayAfterClose",{self:this},this._onProfilerOverlayAfterClose)},__destroy:function(){var survey=this.question.survey;this.benchmarkRollup.rollupList.off("benchmarkRollupsReloaded",this._onBenchmarkRollupsReloaded);this.benchmarkRollup.rollupList.off("benchmarkRollupLoaded",this._onBenchmarkRollupLoaded);this.__unsubscribe("popout.opened",this._onPopoutOpened);
survey.profiler.off("profilerOverlayBeforeOpen",this._onProfilerOverlayBeforeOpen);survey.profiler.off("profilerOverlayAfterClose",this._onProfilerOverlayAfterClose)},_onBeforeCustomizeViewAnimateIn:function(e){var self=e.data.self;self._showOrHideButtons(false,true);SM.SummaryQuestionViewContainer._onBeforeCustomizeViewAnimateIn.call(this,e);self.$el.find(".benchmarkable-icon-ctnr").addClass("disabled")},_onAfterCustomizeViewAnimateOut:function(e){var self=e.data.self;SM.SummaryQuestionViewContainer._onAfterCustomizeViewAnimateOut.call(this,e);self._showOrHideButtons();self.$el.find(".benchmarkable-icon-ctnr").removeClass("disabled")},_onOpenCustomizeView:function(e){var self=e.data.self,tabName=e.action,answerID=e.answerID;self.openCustomizeView(tabName,{answerID:answerID})},_onCustomizeBtnClick:function(e){var self=e.data.self;if(self._showingBenchmark){if(self.question.isTop2()){e.preventDefault();if(self.question.survey.isReadOnly()){return}SM.Bi.uiTrigger="top2CustomizeButton";self.openCustomizeView("top2ChartType")}}else{SM.SummaryQuestionViewContainer._onCustomizeBtnClick.call(this,e)}},_onDisplayChange:function(e){var self=e.data.self;self.isTop2Donut=self.display.getChartType()===self.display.DISPLAY_VALUES.top2_donut;self._setBenchmarkSubheading();self._showOrHideBenchmarkSubheading()},_buildCustomizeViewOptions:function(){var md=SM.SummaryQuestionViewContainer._buildCustomizeViewOptions.call(this);if(this._showingBenchmark&&this.question.isTop2()){md.isTop2Customizer=true}return md},_onBenchmarkRollupsReloaded:function(e){var self=e.data.self;SM.log("SummaryBenchmarkQuestionViewContainer["+self.question.ID+"]._onBenchmarkRollupsReloaded");self.benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.id);self.render()},_initBenchmarkMenu:function($menu,template){var menu,menuView,survey=this.question.survey,disabled=!(survey.profiler&&survey.canShowBenchmarking()&&!survey.shouldShowProfiler())&&survey.isReadOnly();$menu.actionMenu({disabled:disabled,templateID:template});menu=$menu.data("actionMenu");if(menu){menuView=menu.get("menuView");menuView.$el.find(".q").popout()}},_initChartMenu:function($chartMenu){if(this._showingBenchmark){if(this.question.isTop2()){this.$el.on(SM.Event.CLICK,"span[bm-chart-type-btn]",{self:this},this._onCustomizeBtnClick)}else{this.chartMenu=$chartMenu.actionMenu({isReadOnly:this.question.survey.isReadOnly(),menuView:"BMChartOptionsMenuView",position:{my:"left top",at:"left bottom"},model:this.question}).data("actionMenu")}}},_setupBenchmarkMenus:function(){var $showMenu=this.$el.find("span[benchmarking-btn]").find("a[show-menu]"),$hideMenu=this.$el.find("span[summary-btn]").find("a[hide-menu]"),$chartMenu=this.$el.find("span[bm-chart-type-btn]");this._initBenchmarkMenu($showMenu,"show-benchmarks-menu-template");this._initBenchmarkMenu($hideMenu,"hide-benchmarks-menu-template");this._initChartMenu($chartMenu)},_setBenchmarkSubheading:function(){var $bmSubHeading=this.isGaugeChart||this.isTop2Donut?this.$el.find(".benchmark-nps-chart-footer [benchmark]"):this.$el.find("[benchmark-sub-heading]"),segmentName=this.benchmarkRollup.getSegmentName(),sampleSize=Globalize.format(this.benchmarkRollup.getSampleSize(),"n0"),dateStart=moment.unix(this.benchmarkRollup.getDateStart()).toDate(),dateEnd=moment.unix(this.benchmarkRollup.getDateEnd()).toDate(),subHeading=SM.Template.render("summary-benchmark-question-subheading-template",{isGaugeChart:this.isGaugeChart,isTop2Donut:this.isTop2Donut,isTMBC:this.question.survey.isTMBCTemplate(),segmentName:segmentName,sampleSize:sampleSize,dateStart:Globalize.format(dateStart,"d"),dateEnd:Globalize.format(dateEnd,"d")});$bmSubHeading.html(subHeading)},_onBenchmarkSubheadingClick:function(e){var self=e.data.self,$menuTgt=$(e.currentTarget),survey=self.question.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();SM.BenchmarkActionMenu.actionMenu(self,$menuTgt,currentSegment,"question",e,true)},_onBenchmarkRollupLoaded:function(e){var self=e.data.self,questionID=e.questionID,display;if(self.question.ID===questionID){self.benchmarkRollup=self.question.survey.getBenchmarkRollup(self.question.ID);display=self.question.getRollup().display;display.notifyBenchmarkDisplay(true);self._setBenchmarkSubheading()}},_showOrHideBenchmarkSubheading:function(){var $qSubHeading=this.$el.find("[question-sub-heading][standard]"),$bmSubHeading=this.$el.find("[benchmark-sub-heading]"),display=this.question.getRollup().display;if(this._showingBenchmark){$qSubHeading.hide();if(this.isBenchmarkable){if(this.benchmarkRollup.hasError()){$bmSubHeading.hide()}else if(display.getChartType()===display.DISPLAY_VALUES.score_gauge||display.getChartType()===display.DISPLAY_VALUES.top2_donut){$bmSubHeading.hide()}else{$bmSubHeading.show()}}}else{$qSubHeading.show();$bmSubHeading.hide()}},_buildDescriptionText:function(description){var startPos=description.indexOf("<"),barPos=description.indexOf("|"),endPos=description.indexOf(">");if(startPos===-1){return description}return description.substr(0,startPos)+description.substr(startPos+1,barPos-startPos-1).trim()+description.substr(endPos+1)},_buildEditedQuestionTemplate:function(){var benchmarkRollups=this.question.survey.benchmarkRollups,$content=this.$el.find("[sm-questionview-content]"),$editedTemplate,structure,questionStruct,md={hasStruct:false},i;if(benchmarkRollups){structure=benchmarkRollups.getStructure(this.question.logicalID);if(structure&&structure.structure){structure=structure.structure;questionStruct=structure.languages[0];md.hasStruct=true;md.questionNumber=this.question.position;md.questionText=this._buildDescriptionText(questionStruct.description);if(structure.qid===669){md.answers=questionStruct.answers_new.columns}else{md.answers=questionStruct.answers_new.rows}for(i=0;i<md.answers.length;i++){md.answers[i].position=i+1}}else{questionStruct=this.question.structure;md.hasStruct=true;md.questionNumber=this.question.position;md.questionText=questionStruct.heading;if(questionStruct.logicalID===669){md.answers=questionStruct.answers.columns}else{md.answers=questionStruct.answers.rows}for(i=0;i<md.answers.length;i++){md.answers[i].position=i+1}}}$editedTemplate=SM.Template.render("summary-benchmark-question-bank-edited-template",md);$content.prepend($editedTemplate);$content.find(".q").popout();$content.find(".qb-popout").popout({offsetX:150})},_showOrHideEditedQuestionWarning:function(){var $editedWarning=this.$el.find("[benchmark-question-bank-edited]");if(this._showingBenchmark){$editedWarning.show()}else{$editedWarning.hide()}},_showOrHideButtons:function(disableAll,hideAll){var $el=this.$el,survey=this.question.survey,$summaryBtn=$el.find("span[summary-btn]"),$bmBtn=$el.find("span[benchmarking-btn]"),$chartBtn=$el.find("span[bm-chart-type-btn]"),$customizeBtn=$el.find("[customize-btn]"),$exportBtn=$el.find("[export-btn]"),$shareBtn=$el.find("[share-btn]");disableAll=!!disableAll;if(hideAll){$summaryBtn.addClass("hide");$bmBtn.addClass("hide");$chartBtn.addClass("hide");$customizeBtn.addClass("hide");$exportBtn.addClass("hide");$shareBtn.addClass("hide")}else if(this._showingBenchmark){$summaryBtn.removeClass("hide").toggleClass("disabled",disableAll||survey.isTMBCTemplate()&&survey.driverRollups.hasError());$summaryBtn.find("[show-menu]").toggleClass("disabled",disableAll);$bmBtn.addClass("hide");$chartBtn.removeClass("hide");$chartBtn.toggleClass("disabled",disableAll||this.question.isNPS()&&this.question.isCompared());$customizeBtn.addClass("hide");$exportBtn.addClass("hide");$shareBtn.addClass("hide")}else{$summaryBtn.addClass("hide");$bmBtn.removeClass("hide").toggleClass("disabled",disableAll);$bmBtn.find("[show-menu]").toggleClass("disabled",disableAll);$chartBtn.addClass("hide");$customizeBtn.removeClass("hide").toggleClass("disabled",disableAll);$exportBtn.removeClass("hide").toggleClass("disabled",disableAll);$shareBtn.removeClass("hide").toggleClass("disabled",disableAll)}},_openDataSegmentList:function(){var $accordion=$(".analyze-secondary-column.accordion"),accordion=$accordion.accordion().data("accordion");if(accordion){accordion.open("DataSegmentBuilderViewContainer")}},_toggleBenchmarkingBtn:function(){this._showingBenchmark=!this._showingBenchmark;this._showOrHideButtons();this._showOrHideBenchmarkSubheading();this._showOrHideEditedQuestionWarning();if(this._showingBenchmark){this._openDataSegmentList()}this.question.survey.dataSegmentList._trigger(SM.DataSegmentListModel.DATA_SEGMENT_SHOWN_CHANGED)},_hideBenchmarks:function(question,all){var self=this,dataSegmentList,display;if(all){dataSegmentList=question.survey.dataSegmentList;dataSegmentList.enableAllBenchmarks(false)}else{display=question.getRollup().display;display.setBenchmarkDisplay(false);if(question.isTop2()){self.questionViewProto=SM.SummaryQuestionListView._getQuestionViewForQuestionType(question)}this._toggleBenchmarkingBtn();this.benchmarkRollup.revertBenchmarkRollup()}SM.Bi.benchmarkingShowHide(question.ID,"hide",all)},_showBenchmarks:function(question,all){var dataSegmentList,display;if(all){dataSegmentList=question.survey.dataSegmentList;dataSegmentList.enableAllBenchmarks(true)}else{display=question.getRollup().display;display.setBenchmarkDisplay(true);this.benchmarkRollup.fetchBenchmarkRollup()}SM.Bi.benchmarkingShowHide(question.ID,"show",all)},_onHideBenchmarksClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._hideBenchmarks(self.question,false)},_onShowBenchmarksClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._showBenchmarks(self.question,false)},_onBenchmarkingBtnClick:function(e){var self=e.data.self,$tgt=$(e.target),survey=self.question.survey,$action=e.$action?e.$action:$(e.target),action=$action.attr("data-action"),profilerDialog,onDone=function(){self._showBenchmarks(self.question,action==="show-all-benchmarks")},onFail=function(msg){SM.API.logError({name:"Profile could not be saved",message:"Error "+msg+" saving profile"})};e.preventDefault();if($tgt.hasClass("disabled")||$tgt.closest(".btn-menu").hasClass("disabled")){return}if(action==="hide-benchmark"||action==="hide-all-benchmarks"){self._hideBenchmarks(self.question,action==="hide-all-benchmarks")}else if(action==="show-benchmark"||action==="show-all-benchmarks"){if(survey.isProfilerDialogEnabled()){profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"question",triggeredFrom:"question_benchmarking_button"});profilerDialog.open()}else if(survey.profiler.profileSaved||survey.owner.hasBenchmarkingRestricted()||survey.currentUserBenchmarksEnabled){self._showBenchmarks(self.question,action==="show-all-benchmarks")}else{survey.profiler.save({done:onDone,fail:onFail})}}},_hasBenchmarking:function(){var self=this,survey=self.question.survey,owner=survey.owner;if(!survey.isCurrentUserAlsoOwner()){return survey.canShowBenchmarking()}return self.questionViewProto._hasBenchmarkingOptions&&owner.hasBenchmarking()&&self.question.isBenchmarkable()},_onChartTypeSelected:function(e){var self=e.data.self,action=e.action,display=self.question.getRollup().display,oldChartType=display.getChartType(),updates;if(action!==oldChartType){updates=display.getChartTypeUpdates(action);updates[display.DISPLAY_OPTIONS.benchmark_chart_type]=updates[display.DISPLAY_OPTIONS.chart_type];delete updates[display.DISPLAY_OPTIONS.chart_type];updates[display.DISPLAY_OPTIONS.benchmark_stacking]=updates[display.DISPLAY_OPTIONS.stacking];delete updates[display.DISPLAY_OPTIONS.stacking];display.updateDisplayData(updates);self.render()}},_onProfilerOverlayBeforeOpen:function(e){var self=e.data.self,owner=e.owner;if(owner===self){self._showOrHideButtons(true)}},_onProfilerOverlayAfterClose:function(e){var self=e.data.self,owner=e.owner;if(owner===self){self._showOrHideButtons()}},_onBenchmarkableIconClicked:function(e){var self=e.data.self,$tgt=$(e.target),survey=self.question.survey,isOwner=survey.isCurrentUserAlsoOwner(),$ctnr=self.$el.find("[sm-questionview-content]");e.preventDefault();e.stopPropagation();if(!isOwner){return}if($tgt.hasClass("disabled")){return}if(survey.isProfilerDialogEnabled()){if(self._profilerOverlay){self._profilerOverlay.close()}else{self._profilerOverlay=SM.Views.create(SM.ProfilerDriverOverlayView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"icon",triggeredFrom:"icon",owner:self,$tgt:$tgt,$ctnr:$ctnr});self._profilerOverlay.open($ctnr)}}}});SM.SummaryTMBCViewContainer=SM.Views.register({__NAME:"summaryTMBCViewContainer",__templateID:"tmbc-view-container-template",__model:"survey",__create:function(options){this.tmbcType=options.tmbcType},__beforeRender:function(){var self=this,tmbc=self.survey.tmbc,md={tmbcType:self.tmbcType,isGEI:self.tmbcType===tmbc.TMBC_TYPE_GEI,isFE:self.tmbcType===tmbc.TMBC_TYPE_ENGAGEMENT};if(this.survey.owner.hasBenchmarkingOptOut()&&!this.survey.owner.hasBenchmarkingRestricted()||this.survey.driverRollups.hasError()||SM.App.isSharingApp()){this._showingBenchmark=false}else{this._showingBenchmark=this.survey.tmbc.getTMBCShowHide(this.tmbcType)}if(!this._showingBenchmark){this.chartType=SM.QuestionDisplayModel.DISPLAY_VALUES.donut}else{this.chartType=this.survey.tmbc.getTMBCChartType(this.tmbcType)}return md},__afterRender:function(){var self=this,currentView=self.survey.anviews.currentView,hasError=self.survey.tmbc.hasError(),tooFewResponses=self.survey.tmbc.hasTooFewResponses(),hasFilterOrCompare=!!currentView.getCompareRuleSelected()||currentView.hasFilterRule(),wasEdited=self.survey.tmbc.wasEdited(),isOwner=self.survey.isCurrentUserAlsoOwner(),html;self.$tmbcContent=this.$el.find("[tmbc-content-container]");if(!hasError&&!tooFewResponses&&!hasFilterOrCompare&&!wasEdited){self.tmbcView=SM.Views.create(SM.TMBCView,{model:self.survey.tmbc,tmbcType:self.tmbcType,chartType:self.chartType,showBenchmark:self._showingBenchmark});self.$tmbcContent.append(self.tmbcView.$el);self._dataNotAvailable=false}else{if(hasError){tooFewResponses=false;hasFilterOrCompare=false;wasEdited=false}else if(wasEdited){tooFewResponses=false;hasFilterOrCompare=false}else if(tooFewResponses){hasFilterOrCompare=false;wasEdited=false}else{tooFewResponses=false;wasEdited=false}html=SM.Template.render("tmbc-data-not-available-template",{hasError:hasError,tooFewResponses:tooFewResponses,hasFilter:hasFilterOrCompare,wasEdited:wasEdited,isGEI:self.tmbcType===self.survey.tmbc.TMBC_TYPE_GEI,isFE:self.tmbcType===self.survey.tmbc.TMBC_TYPE_ENGAGEMENT,isTMBC:true,toStore:self.survey.isStoreTemplate(),user_id:self.survey.currentUserID,tmbcType:self.tmbcType});self.$tmbcContent.html(html);self._dataNotAvailable=true}self._setupBenchmarkMenus();this._setBenchmarkSubheading();this._showOrHideButtons();this._showOrHideBenchmarkSubheading();this.$el.find(".q").popout();if(isOwner&&!self.survey.isProfilerDialogEnabled()){this._popout=this.$el.find(".benchmarkable-icon-ctnr").popout({at:"right top",offsetX:10,tmbcType:this.tmbcType});this._popout.tmbcType=this.tmbcType}},__init:function(){this.survey.anviews.currentView.on("ruleEdited",{self:this},this._onRuleEdited);this.$el.on("actionMenu.actionSelected",{self:this},this._onBenchmarkingBtnClick).on(SM.Event.CLICK,"a[summary-btn], a[benchmarking-btn]",{self:this},this._onBenchmarkingBtnClick).on(SM.Event.CLICK,"[hide-link]",{self:this},this._onHideBenchmarksClicked).on(SM.Event.CLICK,"[show-link]",{self:this},this._onShowBenchmarksClicked).on(SM.Event.CLICK,"[bm-chart-type-btn]",{self:this},this._onChartTypeBtnClicked).on("actionMenu.actionSelected","[bm-chart-type-btn]",{self:this},this._onChartTypeSelected).on(SM.Event.CLICK,".benchmarkable-icon-ctnr",{self:this},this._onBenchmarkableIconClicked).on(SM.Event.CLICK,".tmbc-chart-header.right",{self:this},this._onTMBCChartHeaderClick);this.__subscribe("popout.opened",this._onPopoutOpened,{self:this})},__destroy:function(){this.__unsubscribe("popout.opened",this._onPopoutOpened)},_onPopoutOpened:function(e){var self=e.data.self,$realPopout=$(".popout.open");if(self.tmbcType===e.popout.__settings.tmbcType){SM.Bi.logUpsellTooltipOpened(self.tmbcType)}$realPopout.on(SM.Event.CLICK,".upsell-btn",{self:self},self._onPopoutGetBenchmarksClicked)},_onPopoutGetBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),href=$tgt.attr("destination"),tmbcType=$tgt.attr("tmbcType"),owner=self.survey.owner,hasPaid=owner.hasBenchmarkingRestricted(),isTMBC=self.survey.isTMBCTemplate(),popout,onDone=function(){if(isTMBC){SM.Views.create(SM.BenchmarkRequestDialogView,{model:self.survey,type:self.survey.getTemplateType(),triggeredFrom:"tmbc",lqid:"",canonical_name:""}).open()}else{window.location.href=href}};e.preventDefault();e.stopPropagation();if(self.tmbcType===tmbcType){popout=self._popout.data("popout");popout._isHovered=false;popout._$msg.remove();SM.Bi.benchmarkingBuyMore(tmbcType,"upsell_popout","icon",href,hasPaid,false).done(onDone).fail(onDone)}},_onRuleEdited:function(e){var self=e.data.self;if(!e.ruleModel.isShow){self.render()}},_onTMBCChartHeaderClick:function(e){var self=e.data.self,$menuTgt=$(e.currentTarget),survey=self.survey,currentSegment=survey.dataSegmentList.getSelectedSegment();SM.BenchmarkActionMenu.actionMenu(self,$menuTgt,currentSegment,"tmbc",e,true)},_initBenchmarkMenu:function($menu,template){var menu,menuView;$menu.actionMenu({templateID:template});menu=$menu.data("actionMenu");if(menu){menuView=menu.get("menuView");menuView.$el.find(".q").popout()}},_initChartMenu:function($chartMenu){this.chartMenu=$chartMenu.actionMenu({menuView:"TMBCChartOptionsMenuView",position:{my:"left top",at:"left bottom"},model:this.survey.tmbc,tmbcType:this.tmbcType,isReadOnly:this.survey.isReadOnly()}).data("actionMenu");this.chartMenu.open()},_onChartTypeBtnClicked:function(e){var self=e.data.self,$tgt=$(e.target);e.stopPropagation();e.preventDefault();if(self._showingBenchmark){self._initChartMenu($tgt)}},_setupBenchmarkMenus:function(){var $showMenu=this.$el.find("span[benchmarking-btn]").find("a[show-menu]"),$hideMenu=this.$el.find("span[summary-btn]").find("a[hide-menu]");this._initBenchmarkMenu($showMenu,"show-benchmarks-menu-template");this._initBenchmarkMenu($hideMenu,"hide-benchmarks-menu-template")},_setBenchmarkSubheading:function(){var isDonut=this.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.donut,subHeadingSelector=isDonut?".benchmark-nps-chart-footer [benchmark]":"[benchmark-sub-heading]",$bmSubHeading=this.$el.find(subHeadingSelector),tmbc=this.survey.tmbc,segmentName=tmbc.getSegmentName(),sampleSize=Globalize.format(tmbc.getSampleSize(this.tmbcType),"n0"),dateStart=moment.unix(tmbc.getDateStart(this.tmbcType)).toDate(),dateEnd=moment.unix(tmbc.getDateEnd(this.tmbcType)).toDate(),subHeading=SM.Template.render("summary-benchmark-question-subheading-template",{isGaugeChart:isDonut,isTMBC:true,segmentName:segmentName,sampleSize:sampleSize,dateStart:Globalize.format(dateStart,"d"),dateEnd:Globalize.format(dateEnd,"d")});$bmSubHeading.html(subHeading)},_showOrHideBenchmarkSubheading:function(){var isDonut=this.chartType===SM.QuestionDisplayModel.DISPLAY_VALUES.donut,$qSubHeading=this.$el.find("[question-sub-heading][standard]"),$bmSubHeading=this.$el.find("[benchmark-sub-heading]"),tmbc=this.survey.tmbc;if(this._showingBenchmark){$qSubHeading.hide();if(this.isBenchmarkable){if(tmbc.hasError()){$bmSubHeading.hide()}else if(isDonut){$bmSubHeading.hide()}else{$bmSubHeading.show()}}}else{$qSubHeading.show();$bmSubHeading.hide()}},_showOrHideButtons:function(){var self=this,$summaryBtn=self.$el.find("span[summary-btn]"),$summaryLink=$summaryBtn.find("a[summary-btn]"),$summaryMenu=$summaryBtn.find("a[hide-menu]"),$bmBtn=self.$el.find("span[benchmarking-btn]"),$bmLink=$bmBtn.find("a[benchmarking-btn]"),$bmMenu=$bmBtn.find("a[show-menu]"),$chartBtn=self.$el.find("a[bm-chart-type-btn]"),noAccess=self.survey.driverRollups.getError()==="no_access";if(self._dataNotAvailable||self.survey.driverRollups.hasError()&&!noAccess){$summaryLink.addClass("disabled");$summaryMenu.addClass("disabled");$bmLink.addClass("disabled");$bmMenu.addClass("disabled")}else{$summaryLink.removeClass("disabled");$summaryMenu.removeClass("disabled");$bmLink.removeClass("disabled");$bmMenu.removeClass("disabled")}if(self._showingBenchmark){$summaryBtn.show();$bmBtn.hide();if(self._dataNotAvailable){$chartBtn.addClass("disabled")}else{$chartBtn.removeClass("disabled")}}else{$summaryBtn.hide();$bmBtn.show();$chartBtn.addClass("disabled")}},_toggleBenchmarkingBtn:function(){this._showingBenchmark=!this._showingBenchmark;this._showOrHideButtons();this._showOrHideBenchmarkSubheading()},_hideBenchmarks:function(tmbcType,all){if(all){this.survey.dataSegmentList.enableAllBenchmarks(false)}else{this.survey.tmbc.setTMBCShowHide(tmbcType,false);this.render()}SM.Bi.benchmarkingShowHide(tmbcType,"show",all)},_showBenchmarks:function(tmbcType,all){if(all){this.survey.dataSegmentList.enableAllBenchmarks(true)}else{this.survey.tmbc.setTMBCShowHide(tmbcType,true);this.render()}SM.Bi.benchmarkingShowHide(tmbcType,"show",all)},_onHideBenchmarksClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._hideBenchmarks(self.tmbcType,false)},_onShowBenchmarksClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._showBenchmarks(self.tmbcType,false)},_onBenchmarkingBtnClick:function(e){var self=e.data.self,survey=self.survey,$action=e.$action?e.$action:$(e.target),action=$action.attr("data-action"),profilerDialog;e.preventDefault();if($(e.target).hasClass("disabled")){return}if(action==="hide-benchmark"||action==="hide-all-benchmarks"){self._hideBenchmarks(self.tmbcType,action==="hide-all-benchmarks")}else if(action==="show-benchmark"||action==="show-all-benchmarks"){if(survey.isProfilerDialogEnabled()){profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"driver",triggeredFrom:"driver_benchmarking_button"});profilerDialog.open()}else{self._showBenchmarks(self.tmbcType,action==="show-all-benchmarks")}}},_hasBenchmarking:function(){var self=this,survey=self.survey,owner=survey.owner;if(!survey.isCurrentUserAlsoOwner()){return survey.canShowBenchmarking()}return owner.hasBenchmarking()},_onChartTypeSelected:function(e){var self=e.data.self,action=e.action,oldChartType=self.survey.tmbc.getTMBCChartType(self.tmbcType);if($(e.target).hasClass("disabled")){return}if(action!==oldChartType){self.chartType=action;self.survey.tmbc.setTMBCChartType(self.tmbcType,action);self.render()}},_onBenchmarkableIconClicked:function(e){var self=e.data.self,$tgt=$(e.target),survey=self.survey,isOwner=survey.isCurrentUserAlsoOwner(),$ctnr=self.$el.find("[sm-questionview-content]");e.preventDefault();e.stopPropagation();if(!isOwner){return}if($tgt.hasClass("disabled")){return}if(survey.isProfilerDialogEnabled()){if(self._profilerOverlay){self._profilerOverlay.close()}else{if($ctnr.length===0){$ctnr=self.$el.find("[tmbc-content-container]")}self._profilerOverlay=SM.Views.create(SM.ProfilerDriverOverlayView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"tmbc",triggeredFrom:"icon",owner:self,$tgt:$tgt,$ctnr:$ctnr});self._profilerOverlay.open($ctnr)}}}});SM.TMBCView=SM.Views.register({__NAME:"tmbcView",__templateID:"summary-tmbc-template",__model:"tmbc",_hasTableView:false,_hasChartView:false,_chartViewType:undefined,_tableViewType:undefined,__create:function(options){var self=this;self.survey=self.tmbc.survey;self.tmbcType=options.tmbcType;self.chartType=options.chartType;this._hasChartView=true;this._hasTableView=true},__beforeRender:function(){var self=this,hasTmbcLoaded=!self.tmbc.hasError(),survey=self.tmbc.survey,currentUserID=survey.currentUserID,isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate();this._hasTableView=self.get("showBenchmark");return{isVisible:hasTmbcLoaded,hasBenchmarking:true,isActive:self.get("showBenchmark"),isBenchmarkable:!SM.App.isSharingApp(),showBenchmark:self.get("showBenchmark"),sampleSize:self.tmbc.getSampleSize(self.tmbcType),dateStart:self.tmbc.getDateStart(self.tmbcType),dateEnd:self.tmbc.getDateEnd(self.tmbcType),userID:currentUserID,viewedPercentage:true,viewedNumber:Globalize.format(0,"n0"),isPresentation:false,isTextPresentation:false,isTMBC:isTMBC,toStore:toStore,tmbcType:self.tmbcType}},__afterRender:function(md){var self=this;if(!md.isVisible){return}self.$questionContent=this.$el;if(this._hasChartView){this._renderChartView()}if(this._hasTableView){this._renderTableView()}self._setMinHeight()},__init:function(){var self=this,menuSelected="actionMenu.actionSelected";self.$el.on(SM.Event.CLICK,"[question-heading]",{self:self},self._onQuestionHeadingClick).on(menuSelected,"[question-heading]",{self:self},self._onQuestionHeadingActionSelected).on(menuSelected,".sm-chart-container *",{self:this},this._onChartActionSelected).on(menuSelected,".sm-data-table-container *",{self:this},this._onTableActionSelected)},_onChartActionSelected:function(e){var self=e.data.self,canCustomizeCharts=self.survey.owner.canCustomizeCharts();e.stopPropagation();if(e.action==="colors"&&!canCustomizeCharts){SM.Bi.uiTrigger="questionChartEditColorsMenuButton";SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"customize-upgrade-dialog-template"}).open()}else{SM.Bi.uiTrigger="questionChart"+e.action+"MenuButton";self.$el.trigger({type:"openCustomizeView",action:e.action})}},_renderChartView:function(){var self=this,chartContainerView;chartContainerView=SM.Views.create(SM.SummaryTMBCChartContainerView,{model:self.tmbc,tmbcType:self.tmbcType,chartType:self.chartType,questionView:self,showBenchmark:self.get("showBenchmark")});self.$questionContent.append(chartContainerView.el);self.chartContainerView=chartContainerView},_renderTableView:function(){var self=this,tableView;tableView=SM.Views.create(SM.TMBCTableContainerView,{model:self.tmbc,tmbcType:self.tmbcType,tableViewType:this._tableViewType});self.$questionContent.append(tableView.el)},_onTableActionSelected:function(e){var self=e.data.self;if(e.action==="labels"){e.stopPropagation();self.$el.trigger({type:"openCustomizeView",action:e.action,answerID:e.$action.attr("data-answer-id")})}},_setMinHeight:function(){var self=this,height;setTimeout(function(){height=0;if(self.$questionContent!==undefined){_.each(self.$questionContent.children(":visible"),function(child){height+=$(child).outerHeight()});self.$questionContent.css({"min-height":height})}},150)},_updateBenchmarkIcon:function(){var $icon=this.$el.find(".benchmarkable-icon-ctnr"),active=this.display.getBenchmarkDisplay();if(active){$icon.addClass("active")}else{$icon.removeClass("active")}},getCurrentChartView:function(){var self=this;return self.chartContainerView.chartView}});SM.BenchmarkTop2QuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"benchmarkTop2QuestionView",__templateID:"summary-question-template",__model:"question",_hasTableView:true,_hasChartView:true,_hasTextView:false,_hasBenchmarkingOptions:true,_chartViewType:undefined,_tableViewType:undefined,__create:function(options){var self=this;self.survey=self.question.survey;self.rollup=self.question.getRollup();self.survey=self.question.survey;self.display=self.rollup.display;self.currentQuestionHeading=self._getQuestionHeading();self.questionContainerView=options.questionContainerView;self.isBenchmarkable=options.isBenchmarkable},__beforeRender:function(){var self=this,survey=self.survey,currentUserID=survey.currentUserID,isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate(),benchmarkRollup=self.question.getBenchmarkRollup(),dataSegment=survey.dataSegmentList.getSelectedSegment(),templateName=survey.getTemplateName();this._hasTableView=true;this.benchmarkRollup=benchmarkRollup;if(!!templateName){templateName="&qbcat="+templateName}return{isVisible:true,hasBenchmarking:true,isActive:true,isBenchmarkable:!SM.App.isSharingApp(),answered:self.rollup.answered,skipped:self.rollup.skipped,showBenchmark:true,question_id:self.question.ID,sampleSize:benchmarkRollup.getSampleSize(),dateStart:dataSegment.dateStart(),dateEnd:dataSegment.dateEnd(),userID:currentUserID,viewedPercentage:true,viewedNumber:Globalize.format(0,"n0"),isPresentation:false,isTextPresentation:false,isTMBC:isTMBC,templateName:templateName,toStore:toStore,tmbcType:self.tmbcType,questionHeading:self.currentQuestionHeading,user_id:survey.currentUserID,surveyId:survey.ID}},_onChartActionSelected:function(e){var self=e.data.self,canCustomizeCharts=self.survey.owner.canCustomizeCharts();e.stopPropagation();if(e.action==="colors"&&!canCustomizeCharts){SM.Bi.uiTrigger="questionChartEditColorsMenuButton";SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"customize-upgrade-dialog-template"}).open()}else{SM.Bi.uiTrigger="questionChart"+e.action+"MenuButton";self.$el.trigger({type:"openCustomizeView",action:e.action})}},__afterRender:function(md){SM.SummaryBaseQuestionView.__afterRender.call(this,md);this._renderQuestionHeading();if(this.isBenchmarkable){this._updateBenchmarkIcon();this._setBenchmarkSubheading();this._showOrHideBenchmarkSubheading()}},_setBenchmarkSubheading:function(){var self=this,displayData=self.display.getDisplayData(),isTop2Donut=displayData.benchmark_chart_type===self.display.DISPLAY_VALUES.top2_donut,$bmSubHeading=isTop2Donut?this.$el.find(".benchmark-nps-chart-footer [benchmark]"):this.$el.find("[benchmark-sub-heading]"),segmentName=this.benchmarkRollup.getSegmentName(),sampleSize=Globalize.format(this.benchmarkRollup.getSampleSize(),"n0"),dateStart=moment.unix(this.benchmarkRollup.getDateStart()).toDate(),dateEnd=moment.unix(this.benchmarkRollup.getDateEnd()).toDate(),subHeading=SM.Template.render("summary-benchmark-question-subheading-template",{isGaugeChart:false,isTop2Donut:isTop2Donut,isTMBC:this.question.survey.isTMBCTemplate(),segmentName:segmentName,sampleSize:sampleSize,dateStart:Globalize.format(dateStart,"d"),dateEnd:Globalize.format(dateEnd,"d")});$bmSubHeading.html(subHeading)},_showOrHideBenchmarkSubheading:function(){var $qSubHeading=this.$el.find("[question-sub-heading][standard]"),$bmSubHeading=this.$el.find("[benchmark-sub-heading]"),display=this.question.getRollup().display;$qSubHeading.hide();if(this.benchmarkRollup.hasError()){$bmSubHeading.hide()}else if(display.getChartType()===display.DISPLAY_VALUES.score_gauge||display.getChartType()===display.DISPLAY_VALUES.top2_donut){$bmSubHeading.hide()}else{$bmSubHeading.show()}},_renderChartView:function(){var self=this,display=self.question.getRollup().display,displayData=display.getDisplayData(),chartType=displayData.show_benchmark?displayData.benchmark_chart_type:displayData.chart_type,chartContainerView;if(chartType===display.DISPLAY_VALUES.top2_donut||chartType===display.DISPLAY_VALUES.top2_vbar||chartType===display.DISPLAY_VALUES.top2_hbar){chartContainerView=SM.Views.create(SM.BenchmarkTop2SummaryChartView,{model:self.question,questionView:self,showBenchmark:true,question:self.question,isDonut:chartType===display.DISPLAY_VALUES.top2_donut})}else{chartContainerView=SM.Views.create(SM.BenchmarkSummaryChartView,{question:self.question,isBenchmarkable:true})}self.$questionContent.append(chartContainerView.el);self.chartContainerView=chartContainerView},_renderTableView:function(){var self=this,display=self.question.getRollup().display,displayData=display.getDisplayData(),chartType=displayData.benchmark_chart_type,tableView;if(!displayData.show_table){return}if(chartType===display.DISPLAY_VALUES.hbar||chartType===display.DISPLAY_VALUES.vbar){tableView=SM.Views.create(SM.SummaryTableContainerView,{survey:self.survey,question:self.question,tableViewType:self._tableViewType,hasBenchmarkingOptions:self._hasBenchmarkingOptions,randomAssignmentOption:self.question.randomAssignmentOption})}else if(chartType===display.DISPLAY_VALUES.top2_hbar||chartType===display.DISPLAY_VALUES.top2_vbar||chartType===display.DISPLAY_VALUES.top2_donut){tableView=SM.Views.create(SM.SummaryTableContainerView,{survey:self.survey,question:self.question,tableViewType:self._tableViewType,hasBenchmarkingOptions:self._hasBenchmarkingOptions,randomAssignmentOption:self.question.randomAssignmentOption,isTop2:true})
}else if(chartType===display.DISPLAY_VALUES.boxplot){tableView=SM.Views.create(SM.SummaryTableContainerView,{survey:self.survey,question:self.question,tableViewType:SM.BenchmarkQuartileTableView,hasBenchmarkingOptions:self._hasBenchmarkingOptions,randomAssignmentOption:self.question.randomAssignmentOption,isTop2:true})}else{tableView=SM.Views.create(SM.TMBCTableContainerView,{model:self.tmbc,tmbcType:self.tmbcType,tableViewType:this._tableViewType})}self.$questionContent.append(tableView.el)},_onTableActionSelected:function(e){var self=e.data.self;if(e.action==="labels"){e.stopPropagation();self.$el.trigger({type:"openCustomizeView",action:e.action,answerID:e.$action.attr("data-answer-id")})}},_onDisplayChange:function(e){var self=e.data.self;self.render()},_setMinHeight:function(){var self=this,height;setTimeout(function(){height=0;if(self.$questionContent!==undefined){_.each(self.$questionContent.children(":visible"),function(child){height+=$(child).outerHeight()});self.$questionContent.css({"min-height":height})}},150)},_updateBenchmarkIcon:function(){var $icon=this.$el.find(".benchmarkable-icon-ctnr"),active=this.display.getBenchmarkDisplay();if(active){$icon.addClass("active")}else{$icon.removeClass("active")}},getCurrentChartView:function(){var self=this;return self.chartContainerView}});SM.BMChartOptionsMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"BMChartOptionsMenuView",__templateID:"bm-chart-type-menu-template",__model:"question",__defaults:{md:{vbar:{enabled:true,selected:true},hbar:{enabled:true,selected:false},boxplot:{enabled:true,selected:false},score_gauge:{enabled:true,selected:false}}},__beforeRender:function(){var md=this.get("md"),display=this.question.getRollup().display,type=display.getChartType();if(type!==display.DISPLAY_VALUES.vbar&&type!==display.DISPLAY_VALUES.hbar&&type!==display.DISPLAY_VALUES.score_gauge&&type!==display.DISPLAY_VALUES.boxplot){if(this.question.isNPS()){type=display.DISPLAY_VALUES.score_gauge}else{type=display.DISPLAY_VALUES.vbar}}$.each(md,function(t){md[t].selected=false});md[type].selected=true;if(this.question.isNPS()){md[display.DISPLAY_VALUES.vbar].enabled=false;md[display.DISPLAY_VALUES.hbar].enabled=false;md[display.DISPLAY_VALUES.score_gauge].enabled=true}else{md[display.DISPLAY_VALUES.vbar].enabled=true;md[display.DISPLAY_VALUES.hbar].enabled=true;md[display.DISPLAY_VALUES.score_gauge].enabled=false}md.isReadOnly=this.__settings.isReadOnly;return md}});SM.TMBCChartOptionsMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"TMBCChartOptionsMenuView",__templateID:"tmbc-chart-type-menu-template",__model:"tmbc",__defaults:{md:{boxplot:{enabled:true,selected:false},donut:{enabled:true,selected:false}},tmbcType:SM.TMBCModel.TMBC_TYPE_GEI},__beforeRender:function(){var md=this.get("md"),type=this.tmbc.getTMBCChartType(this.get("tmbcType"));if(!(type in md)){type=SM.QuestionDisplayModel.DISPLAY_VALUES.donut}$.each(md,function(t){md[t].selected=false});md[type].selected=true;md.isReadOnly=this.get("isReadOnly");return md}});SM.SummarySingleChoiceQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summarySingleChoiceQuestionView",_hasTableView:true,_hasChartView:true,_hasPieDonutCharts:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasShowEmptyOptions:true,_hasBenchmarkingOptions:true,_hasDepthOptions:true});SM.SummaryMultipleChoiceQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryMultipleChoiceQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasShowEmptyOptions:true});SM.SummaryPresentationQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryPresentationQuestionView",_isPresentation:true});SM.SummaryNumericalQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryNumericalQuestionView",_hasTableView:true,_hasChartView:true});SM.SummaryDemographicQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryDemographicQuestionView",_hasTableView:true});SM.SummaryOpenEndedMultiQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryOpenEndedQuestionView",_hasTableView:true});SM.SummaryDateTimeQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryDateTimeQuestionView",_hasTableView:true});SM.SummaryEssayQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryEssayQuestionView",_hasTextView:true,_textViewType:SM.SummaryTextView});SM.SummaryFileUploadQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryFileUploadQuestionView",_hasFileUploadView:true});SM.SummaryMatrixRatingQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryMatrixRatingQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasDepthOptions:true,_hasMirrorOptions:true});SM.SummarySingleMatrixQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summarySingleMatrixQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasDepthOptions:true,_hasMirrorOptions:true});SM.SummaryMatrixRankingQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryMatrixRankingQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasDepthOptions:true,_hasMirrorOptions:true});SM.SummaryMultiMatrixQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryMultiMatrixQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasDepthOptions:true,_hasMirrorOptions:true});SM.SummaryMenuMatrixQuestionView=SM.Views.extend(SM.SummaryBaseQuestionView,{__NAME:"summaryMenuMatrixQuestionView",_hasTableView:true,_hasChartView:true,_hasStackedCharts:true,_hasScaleOptions:true,_hasDepthOptions:true,_hasMirrorOptions:true});SM.SummaryDisabledQuestionView=SM.Views.deepExtend(SM.SummaryBaseQuestionView,{__NAME:"summaryDisabledQuestionView",__defaults:{disabledMsg:"This question is disabled"},_hasTableView:false,_hasChartView:false,_isDisabledQuestionType:true});SM.FileUploadItemView=SM.Views.register({__NAME:"FileUploadItemView",__model:"filoItem",__templateID:"filo-item-template",__create:function(options){this.filoList=options.filoList;this.survey=this.filoList.get("survey");this.fileVerified=this.survey.owner.isFiloEnabled()&&this.filoItem.file_status===3},__init:function(){var self=this;self.$el.find(".filo-item-body").on("click",".filo-item-download",{self:self},self._onDownload).on("click",{self:self},self._onClickItem)},__beforeRender:function(){var data=this.filoItem,created=new Date(data.date),deleted=data.date_deleted?new Date(data.date_deleted):false;return{name:data.name,size:SM.FiloUtils.formatSize(data.file_size),date:Globalize.format(created,"d")+" "+Globalize.format(created,"t"),fileId:data.file_id,respondentId:data.respondent_id,status:data.scan_status,deleted:deleted?Globalize.format(deleted,"d")+" "+Globalize.format(deleted,"t"):"",filoEnabled:this.survey.owner.isFiloEnabled(),statusVerified:this.fileVerified,statusVerifying:data.file_status===1,statusCorrupted:data.file_status===2,respondentUrl:this.survey.getRespondentUrl(data.respondent_id)}},__afterRender:function(){var self=this;self.$el.find(".filo-item-action-link").actionMenu({templateID:"filo-item-action-menu-template",position:{my:"right top",at:"right bottom"}}).on("actionMenu.menuInit",function(e){var actionMenu=e.actionMenu,menuEl=actionMenu.get("menuView").$el;if(!self.fileVerified){menuEl.find("a[data-action=download], a[data-action=preview]").addClass("disabled")}}).on("actionMenu.actionSelected",{self:self},self._onMenuAction)},_onDownload:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();if(self.fileVerified){self.survey.filoDownload(self.filoItem.file_id)}},_onClickItem:function(e){var self=e.data.self,target=$(e.target),isAnchor=target.closest("a").closest(".filo-item").length===1;if(isAnchor&&!target.hasClass("filo-item-name")){return}e.preventDefault();self._preview()},_onMenuAction:function(e){var self=e.data.self,action=e.action,fileId=self.filoItem.file_id,dialog;if(action==="download"){if(self.fileVerified){self.survey.filoDownload(fileId)}}else if(action==="preview"){self._preview(fileId)}else if(action==="delete"){dialog=SM.Views.create(SM.FiloDeleteWarningView,{model:[self.filoItem],onContinueClick:function(){self.survey.filoDelete([self.filoItem])}});dialog.open()}},_preview:function(){if(this.fileVerified){this.filoList.preview(this.filoItem)}}});SM.SummaryFileUploadContainerView=SM.Views.register({__NAME:"summaryFileUploadContainerView",__templateID:"filo-container-template",__model:"filoList",__create:function(options){var self=this;self.question=options.question;self.selected=[]},__beforeRender:function(){var self=this;return{surveyID:self.question.survey.ID,responsesCount:self.filoList.responsesCount,queryCount:self.filoList.queryCount,filoEnabled:this.filoList.get("survey").owner.isFiloEnabled(),filoQuery:self.filoList.get("query")}},__init:function(){var self=this;self.filoList.on("appended",{self:self},self._onResponsesAppended).on("loaded",{self:self},self._onResponsesLoaded).on("preview",{self:self},self._onPreview);self.$el.on("submit",".qtext-search form",{self:self},self._onSearch).on("click","[clear-search]",{self:self},self._onClearSearch).on("change","[select-all-responses-chkbx]",{self:self},self._onSelectAll).on("click","[delete-files-btn]",{self:self},self._onDeleteFiles).on("click","[learn-more-trigger]",{self:self},self._onLearnMoreClick);self.$el.find(".filo-list-container").on("change","[response-item-chkbx]",{self:self},self._onItemSelected).on("click",".filo-item-download",{self:self},self._onItemDownload)},__destroy:function(){var self=this;self.filoList.off("appended",self._onResponsesAppended);self.filoList.off("loaded",self._onResponsesLoaded);self.filoList.off("preview",self._onPreview)},__afterRender:function(){var self=this,filoList=self.filoList,filoData=filoList.get("filoData"),listEl=self.$el.find(".filo-list-container"),frag;if(self._shouldShowUpgradeView()){frag=SM.Views.create(SM.FiloUpgradeView,{model:filoList});self.$el.find(".filo-toolbar-actions").after(frag.el)}if(filoList.failed){frag=SM.Template.render("filo-responses-error-template");listEl.frag(frag)}else{if(filoList.isEmpty()){self._setToolbarStatus("single")}else{frag=self._createListFragment(filoData.files);listEl.append(frag);self._setToolbarStatus(filoData.files.length>1?"multiple":"single")}if(!filoList.isFullyLoaded()){frag=SM.Template.render("filo-more-responses-template",{});listEl.append(frag)}self._infiniteScroll=listEl.infiniteScroll({threshold:10,markerID:"filo-load-more-marker"}).data("infiniteScroll");listEl.on("infiniteScroll.reachedEnd",{self:self},self._onRequestMoreResponses)}self.$el.find("[filo-search-tip]").popout()},_createListFragment:function(filoList){var frag=document.createDocumentFragment(),self=this,el;_.each(filoList,function(filoItem){SM.Object.update(filoItem,{question_id:self.question.ID});el=SM.Views.create(SM.FileUploadItemView,{filoList:self.filoList,model:filoItem});frag.appendChild(el.el)});return frag},_onItemSelected:function(e){var self=e.data.self,responseContainer=$(e.target).closest("[data-response-id]"),responseId=responseContainer.attr("data-response-id");if(e.target.checked){if(!_.find(self.selected,function(x){return x.respondent_id===responseId})){self.selected.push(self.filoList.getFiloItem(responseId))}}else{self.selected=_.reject(self.selected,function(x){return x.respondent_id===responseId})}self._updateSelections()},_onSelectAll:function(e){var self=e.data.self,checkboxes=self.$el.find(".filo-list-container [response-item-chkbx]"),isAllSelected=e.target.checked;checkboxes.prop("checked",isAllSelected);if(isAllSelected){self.selected=self.filoList.get("filoData").files}else{self.selected=[]}self.$el.find(".delete-files-btn").toggleClass("disabled",!isAllSelected)},_onDeleteFiles:function(e){var self=e.data.self,dialog;e.preventDefault();if($(e.target).hasClass("disabled")){return}dialog=SM.Views.create(SM.FiloDeleteWarningView,{model:self.selected,onContinueClick:function(){self.question.survey.filoDelete(self.selected)}});dialog.open()},_updateSelections:function(){var self=this,selectAll=self.$el.find("[select-all-responses-chkbx]"),isAllSelected=self.selected.length===self.filoList.loadedCount;selectAll.prop("checked",isAllSelected);self.$el.find(".delete-files-btn").toggleClass("disabled",self.selected.length===0)},_setToolbarStatus:function(status){var self=this,summaryText=self.$el.find(".filo-toolbar-summary>span"),html,className;if(status==="searching"){className="searching";html=SM.Template.render("qtext-search-spinner-template");self.$el.find(".filo-list-container").html(html)}else if(status==="single"){className="responses-single"}else if(status==="multiple"){className="responses-multi"}else if(status==="selected"){className="responses-selected"}else{className=""}summaryText.attr("class",className)},_onSearch:function(e){var self=e.data.self,query=$.trim(self.$el.find("[filo-search-input]").val());e.preventDefault();if(query){self._setToolbarStatus("searching");self.filoList.searchQuery(query);self._infiniteScroll.set("isActive",false)}},_onClearSearch:function(e){var self=e.data.self;e.preventDefault();self._setToolbarStatus("searching");self._infiniteScroll.set("isActive",false);self.$el.find("[filo-search-input]").val("");self.filoList.clearQuery()},_onPreview:function(e){var filoList=e.data.self.filoList,files=_.filter(filoList.get("filoData").files,function(file){return file.file_status===3}),index=_.indexOf(files,e.filoItem);if(index>-1){if(self.previewView){self.previewView.destroy()}self.previewView=SM.Views.create(SM.FileUploadPreviewView,{files:files,index:index,filoList:filoList,survey:filoList.get("survey")});self.previewView.open()}},_onResponsesAppended:function(e){var self=e.data.self,frag=self._createListFragment(e.respondents);self.$el.find("[data-response-id]").last().after(frag);if(self.filoList.isFullyLoaded()||e.respondents.length===0){self._infiniteScroll.removeMarker()}else{self._infiniteScroll.set("isActive",true)}},_onResponsesLoaded:function(e){var self=e.data.self;self.render();if(self.filoList.isFullyLoaded()){self._infiniteScroll.removeMarker()}self._infiniteScroll.set("isActive",true)},_onRequestMoreResponses:function(e){var self=e.data.self;self.filoList.fetchMoreResponses();e.stopPropagation()},_shouldShowUpgradeView:function(){var owner=this.filoList.get("survey").owner;if(SM.App.isSharingApp()){return false}return!(owner.isFiloEnabled()||owner.hasDismissedFiloUpgrade)},_onLearnMoreClick:function(e){e.preventDefault();SM.Views.create(SM.FiloLearnMoreView).open()}});SM.FiloUpgradeView=SM.Views.register({__NAME:"FiloUpgradeView",__templateID:"filo-upgrade-topbar-template",__model:"filoList",__init:function(){var self=this,survey=self.filoList.get("survey");self.$el.on("click",".close",{self:self},self._onCloseBtnClick);self.bindModel(survey.owner,"hasDismissedFiloUpgrade.changed",{self:self},self._onDismissUpgrade)},_onCloseBtnClick:function(e){var self=e.data.self,survey=self.filoList.get("survey");e.preventDefault();survey.owner.set("hasDismissedFiloUpgrade",true,{notify:true})},_onDismissUpgrade:function(e){if(e.value){e.data.self.$el.remove()}}});SM.FiloLearnMoreView=SM.Views.deepExtend(SM.DialogView,{__NAME:"FiloLearnMoreView",__templateID:"filo-upgrade-dialog-template",__defaults:{width:850,isModal:true},__init:function(){this.$el.on("click",".cancel-btn",{self:this},this._onCancel).on("click",".upgrade-btn",{self:this},this._onUpgrade)},_onCancel:function(e){e.preventDefault();e.data.self.close()},_onUpgrade:function(e){e.data.self.close()}});SM.SummaryCompareNumericalQuestionView=SM.Views.deepExtend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareNumericalQuestionView",_hasChartView:false,_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareDemographicQuestionView=SM.Views.deepExtend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareDemographicQuestionView",_hasChartView:false,_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareOpenEndedMultiQuestionView=SM.Views.deepExtend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareOpenEndedQuestionView",_hasChartView:false,_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareDateTimeQuestionView=SM.Views.deepExtend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareDateTimeQuestionView",_hasChartView:false,_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareEssayQuestionView=SM.Views.deepExtend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareEssayQuestionView",_hasChartView:false,_hasTextView:false,_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareMenuMatrixQuestionView=SM.Views.deepExtend(SM.SummaryDisabledQuestionView,{__setup:function(){this.__defaults.disabledMsg=Globalize.localize("Compare rules do not apply to this question")},__defaults:{},__NAME:"summaryCompareMenuMatrixQuestionView"});SM.SummaryCompareSingleChoiceQuestionView=SM.Views.extend(SM.SummarySingleMatrixQuestionView,{__NAME:"summaryCompareSingleChoiceQuestionView",_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView,_hasBenchmarkingOptions:true});SM.SummaryCompareMultipleChoiceQuestionView=SM.Views.extend(SM.SummaryCompareSingleChoiceQuestionView,{__NAME:"summaryCompareMultipleChoiceQuestionView",_tableViewType:SM.SummaryCompareMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMatrixTableView});SM.SummaryCompareMatrixRatingQuestionView=SM.Views.extend(SM.SummaryMenuMatrixQuestionView,{__NAME:"summaryCompareMatrixRatingQuestionView",_tableViewType:SM.SummaryCompareMenuMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMenuMatrixTableView});SM.SummaryCompareMatrixRankingQuestionView=SM.Views.extend(SM.SummaryMenuMatrixQuestionView,{__NAME:"summaryCompareMatrixRatingQuestionView",_tableViewType:SM.SummaryCompareMenuMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMenuMatrixTableView});SM.SummaryCompareSingleMatrixQuestionView=SM.Views.extend(SM.SummaryMenuMatrixQuestionView,{__NAME:"summaryCompareSingleMatrixQuestionView",_tableViewType:SM.SummaryCompareMenuMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMenuMatrixTableView});SM.SummaryCompareMultiMatrixQuestionView=SM.Views.extend(SM.SummaryMenuMatrixQuestionView,{__NAME:"summaryCompareMultiMatrixQuestionView",_tableViewType:SM.SummaryCompareMenuMatrixTableView,_exportTableViewType:SM.ExportSummaryCompareMenuMatrixTableView});SM.SummaryComparePresentationQuestionView=SM.Views.deepExtend(SM.SummaryDisabledQuestionView,{__setup:function(){this.__defaults.disabledMsg=Globalize.localize("Compare rules do not apply to this question")},__defaults:{},__NAME:"summaryComparePresentationQuestionView"});SM.SummaryQuestionListView=SM.Views.register({__NAME:"summaryQuestionList",__templateID:"summary-question-list-template",__model:"page",qTypes:{standard:{single_choice:SM.SummarySingleChoiceQuestionView,multiple_choice:SM.SummaryMultipleChoiceQuestionView,matrix_rating:SM.SummaryMatrixRatingQuestionView,matrix_ranking:SM.SummaryMatrixRankingQuestionView,matrix_single:SM.SummarySingleMatrixQuestionView,matrix_multi:SM.SummaryMultiMatrixQuestionView,matrix_menu:SM.SummaryMenuMatrixQuestionView,open_ended_essay:SM.SummaryEssayQuestionView,open_ended_single:SM.SummaryEssayQuestionView,open_ended_multi:SM.SummaryOpenEndedMultiQuestionView,open_ended_numerical:SM.SummaryNumericalQuestionView,open_ended_file_upload:SM.SummaryFileUploadQuestionView,demographic:SM.SummaryDemographicQuestionView,datetime:SM.SummaryDateTimeQuestionView,presentation:SM.SummaryPresentationQuestionView},compare:{single_choice:SM.SummaryCompareSingleChoiceQuestionView,multiple_choice:SM.SummaryCompareMultipleChoiceQuestionView,matrix_rating:SM.SummaryCompareMatrixRatingQuestionView,matrix_ranking:SM.SummaryCompareMatrixRankingQuestionView,matrix_single:SM.SummaryCompareSingleMatrixQuestionView,matrix_multi:SM.SummaryCompareMultiMatrixQuestionView,matrix_menu:SM.SummaryCompareMenuMatrixQuestionView,open_ended_essay:SM.SummaryCompareEssayQuestionView,open_ended_single:SM.SummaryCompareEssayQuestionView,open_ended_multi:SM.SummaryCompareOpenEndedMultiQuestionView,open_ended_numerical:SM.SummaryCompareNumericalQuestionView,open_ended_file_upload:SM.SummaryCompareEssayQuestionView,demographic:SM.SummaryCompareDemographicQuestionView,datetime:SM.SummaryCompareDateTimeQuestionView,presentation:SM.SummaryComparePresentationQuestionView}},__afterRender:function(){var self=this,questions=self.page.shownQuestionList,frag=document.createDocumentFragment(),isExport=self.page.survey.isExport;_.each(questions,function(question){var questionContainerProto,questionViewProto,questionContainerView;if(SM.App.isSharingApp()&&question.subtype==="file_upload"){return}questionContainerProto=question.isBenchmarkable()&&!isExport&&!SM.App.isSharingApp()?SM.SummaryBenchmarkQuestionViewContainer:SM.SummaryQuestionViewContainer;questionViewProto=self._getQuestionViewForQuestionType(question);questionContainerView=SM.Views.create(questionContainerProto,{model:question,nestedQuestionDict:self.page.survey.questionRollups.questions[question.ID].nestedQuestionDict,questionViewProto:questionViewProto});frag.appendChild(questionContainerView.el)},self);self.el.appendChild(frag)},_getQuestionViewForQuestionType:function(question){var family=question.family,subtype=question.subtype,mode=question.getRollup().getDisplayMode(),qType;switch(family){case"matrix":qType="matrix_"+subtype;break;case"open_ended":qType="open_ended_"+subtype;break;case"single_choice":case"multiple_choice":case"demographic":case"datetime":case"presentation":default:qType=family;break}return this.qTypes[mode][qType]}});SM.CustomizeQuestionSummaryView=SM.Views.register({__NAME:"CustomizeQuestionSummaryView",__templateID:"customize-question-summary-template",__create:function(options){var self=this;self.question=options.question;self.survey=self.question.survey;self.rollup=self.question.getRollup();self.display=self.rollup.display;self.questionView=options.questionView;self.applyToAll=false;self.hasMirrorOptions=options.hasMirrorOptions;self.hasDepthOptions=options.hasDepthOptions;self.hasScaleOptions=options.hasScaleOptions;self.hasShowEmptyOptions=options.hasShowEmptyOptions;self.hasAreaCharts=options.hasAreaCharts;self.hasPieDonutCharts=options.hasPieDonutCharts;self.hasStackedCharts=options.hasStackedCharts;self.isTop2Customizer=options.isTop2Customizer||false;self.currentView=null;_.bindAll(this,"_onBeforeTabOpen","_onTabClick","_onSaveBtnClick","_onCancelBtnClick","_onApplyToAllCheckBoxClick","_onDisplayChange","_enableSaveBtn")},__beforeRender:function(){var self=this,isNps=self.question.isNPS(),isNpsSimple=isNps&&!self.question.isCompared();return{questionID:self.question.ID,isNps:isNps,isNpsSimple:isNpsSimple,isTop2Customizer:self.isTop2Customizer}},__afterRender:function(){var self=this,canCustomize;self.$el.css("height","auto");if(self.isTop2Customizer){self._renderTop2ChartTypeView(self.$el.find("[top2-chart-type]"))}else{canCustomize=self.survey.owner.canCustomizeCharts();if(!canCustomize){self.tabs=self.$el.find(".tabs").tabs({requireOpenTab:true,noClickTab:"colors"}).data("tabs")}else{self.tabs=self.$el.find(".tabs").tabs({requireOpenTab:true}).data("tabs")}}self.$el.find(".sm-customize-actions [save-btn]").addClass("disabled")},_renderTab:function(tabName,$panel){var self=this;switch(tabName){case"chartType":self._renderCustomizeChartTypeView($panel);break;case"displayOptions":self._renderCustomizeDisplayOptionsView($panel);break;case"colors":self._renderCustomizeColorsView($panel);break;case"labels":self._renderCustomizeLabelsView($panel);break;default:break}},_renderCustomizeChartTypeView:function($panel){var self=this;if(self.question.isNPS()){self.currentView=SM.Views.create(SM.NpsCustomizeChartTypeView,{question:self.question,rollup:self.rollup,display:self.display,hasPieDonutCharts:self.hasPieDonutCharts,hasStackedCharts:self.hasStackedCharts})}else{self.currentView=SM.Views.create(SM.CustomizeChartTypeView,{question:self.question,rollup:self.rollup,display:self.display,hasPieDonutCharts:self.hasPieDonutCharts,hasStackedCharts:self.hasStackedCharts})}$panel.html(self.currentView.el)},_renderTop2ChartTypeView:function($panel){var self=this;self.currentView=SM.Views.create(SM.CustomizeTop2ChartTypeView,{question:self.question,rollup:self.rollup,display:self.display});$panel.html(self.currentView.el)},_renderCustomizeDisplayOptionsView:function($panel){var self=this;self.currentView=SM.Views.create(SM.CustomizeDisplayOptionsView,{question:self.question,rollup:self.rollup,display:self.display,customizeView:self,hasMirrorOptions:self.hasMirrorOptions,hasDepthOptions:self.hasDepthOptions,hasScaleOptions:self.hasScaleOptions,hasShowEmptyOptions:self.hasShowEmptyOptions});$(self.currentView.el).on("displayOptionsValidation",function(e,validationError){if(!validationError&&self._canSave()){self._enableTabs();self._enableSaveBtn()}else{self._disableTabs();self._disableSaveBtn()}});$panel.html(self.currentView.el)},_renderCustomizeColorsView:function($panel){var self=this;self.currentView=SM.Views.create(SM.CustomizeColorsView,{question:self.question,rollup:self.rollup,display:self.display});$panel.html(self.currentView.el)},_renderCustomizeLabelsView:function($panel){var self=this;self.currentView=SM.Views.create(SM.CustomizeLabelsView,{question:self.question,rollup:self.rollup,display:self.display});$panel.html(self.currentView.el)},animateIn:function($target,cb){var self=this;if($target.find("[sm-customize-question-view]").length===0){self.$el.prependTo($target)}self.$el.trigger({type:"beforeCustomizeViewAnimateIn"});self.$el.slideDown(500,function(){if(cb){cb()}})},animateOut:function(){var self=this;self.$el.slideUp({duration:250,complete:function(){self.$el.trigger({type:"afterCustomizeViewAnimateOut"});self.$el.find(".sm-customize-actions [save-btn]").addClass("disabled")}})},__init:function(){var self=this;if(!self.isTop2Customizer){self.tabs.$el.children("nav").find(".tab").on("click",self._onTabClick);self.tabs.$el.on("tabs.beforeOpen",self._onBeforeTabOpen)}self.$el.find(".apply-to-all .q").popout();self.$el.on("click","[apply-to-all-checkbox]",self._onApplyToAllCheckBoxClick);self.$el.on("click",".sm-customize-actions [save-btn]",self._onSaveBtnClick);self.$el.on("click",".sm-customize-actions [cancel-btn]",self._onCancelBtnClick);self.bindModel(self.display,"allDisplaysChange",{self:self},function(){self.currentView.render()});self.bindModel(self.display,"displayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"tempDisplayChange",{self:self},self._onDisplayChange);self.bindModel(self.display,"allDisplaysChange",{self:self},self._onDisplayChange)},_onDisplayChange:function(){var self=this;if(self._canSave()){self._enableTabs();self._enableSaveBtn()}else{self._disableTabs();self._disableSaveBtn()}},_onTabClick:function(e){var self=this,dialog,$tab=$(e.target),tabKey=$tab.attr("tab-target"),userCanCustomize=self.survey.owner.canCustomizeCharts();e.preventDefault();if(!userCanCustomize&&tabKey==="colors"){dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"customize-upgrade-dialog-template"});dialog.open()}},_onBeforeTabOpen:function(e){var self=this,tabName=e.tab.key,$panel=e.tab.$panel;self._renderTab(tabName,$panel)},_onApplyToAllCheckBoxClick:function(e){var self=this,$target=$(e.target);self.applyToAll=$target.prop("checked");if(self.applyToAll&&self._canSave()){self._enableSaveBtn()}else{if(!self._isDirty()){self._disableSaveBtn()}}},_onSaveBtnClick:function(e){var self=this,$btn=$(e.target);e.preventDefault();if($btn.hasClass("disabled")){return}self.display._trigger({type:"saving"});self._save({applyToAll:self.applyToAll});self.animateOut()},_onCancelBtnClick:function(e){var self=this;e.preventDefault();self._clearUpdates();self.animateOut()},_save:function(options){var self=this,displayUpdates,top2Questions,applyToAll;options=options||{};applyToAll=options.applyToAll;displayUpdates=self.display.getDisplayUpdates();SM.Bi.customizeQuestion(displayUpdates,options.applyToAll,self.display.question);if(applyToAll&&self.question.isTop2()){top2Questions=_.filter(self.survey.questions,function(q){return q.isTop2()});self.survey.anviews.defaultView.updateQuestionDisplayData(displayUpdates,top2Questions,{isCompared:self.question.isCompared(),untypedKeys:SM.QuestionDisplayModel.UNTYPED_DISPLAY_OPTIONS});self._clearUpdates();self.survey.questionRollups.onSharedDisplayDataChange();return}if(!_.isEmpty(displayUpdates)){self.display.updateDisplayData(displayUpdates,{done:function(){if(applyToAll){self._applyToAll()}}})}else{if(applyToAll){self._applyToAll()}}self._clearUpdates()},_applyToAll:function(){var self=this,updates=self.display.getSharedDisplayUpdates(),updateBS,updateSidi;self.survey.anviews.defaultView.updateSharedDisplayData({updates:updates,deletedKeys:self.display.SHARED_DISPLAY_OPTIONS,untypedKeys:self.display.UNTYPED_DISPLAY_OPTIONS,isCompared:self.question.isCompared()});updateBS=updates.show_basic_stats&&updates.show_basic_stats===SM.QuestionDisplayModel.DISPLAY_VALUES.show;updateSidi=updates.show_sig_diffs&&updates.show_sig_diffs===SM.QuestionDisplayModel.DISPLAY_VALUES.show;if(updateBS||updateSidi){self.survey.questionRollups.fetchStatsRollups()}else{self.survey.questionRollups.onSharedDisplayDataChange()}},_clearUpdates:function(){var self=this;self.display.clearDisplayUpdates();self.display.clearTempDisplay()},_canSave:function(){var self=this;if(self.display.labelUpdatesHaveEmptyLabel()){return false}return true},_isDirty:function(){var self=this;return!_.isEmpty(self.display.getDisplayUpdates())},_disableTabs:function(){if(!this.isTop2Customizer){this.tabs.$el.children("nav").find(".tab").addClass("disabled")}},_enableTabs:function(){if(!this.isTop2Customizer){this.tabs.$el.children("nav").find(".tab").removeClass("disabled")}},_enableSaveBtn:function(){var self=this;self.$el.find("[sm-customize-actions] [save-btn]").removeClass("disabled")},_disableSaveBtn:function(){var self=this;self.$el.find("[sm-customize-actions] [save-btn]").addClass("disabled")}});SM.CustomizeChartTypeView=SM.Views.register({__NAME:"CustomizeChartTypeView",__templateID:"customize-chart-type-template",__defaults:{hasAreaCharts:false,hasPieDonutCharts:false,hasStackedCharts:false},__create:function(options){var self=this;self.question=options.question;self.rollup=options.rollup;self.display=options.display;self.set("hasAreaCharts",options.hasAreaCharts);self.set("hasPieDonutCharts",options.hasPieDonutCharts);self.set("hasStackedCharts",options.hasStackedCharts)},__beforeRender:function(md){var self=this,displayValues=self.display.DISPLAY_VALUES,displayData=self.display.getDisplayData(),chartType=self.display.getChartType();md={hbar:{isEnabled:true,isSelected:chartType===displayValues.hbar},vbar:{isEnabled:true,isSelected:chartType===displayValues.vbar},pie:{isEnabled:self.get("hasPieDonutCharts"),isSelected:chartType===displayValues.pie},donut:{isEnabled:self.get("hasPieDonutCharts"),isSelected:chartType===displayValues.donut},stacked_hbar:{isEnabled:self.get("hasStackedCharts"),isSelected:chartType===displayValues.stacked_hbar},stacked_vbar:{isEnabled:self.get("hasStackedCharts"),isSelected:chartType===displayValues.stacked_vbar},line:{isEnabled:true,isSelected:chartType===displayValues.line},area:{isEnabled:true,isSelected:chartType===displayValues.area},boxplot:{isEnabled:false,isSelected:false}};
if(displayData.tableHasOneRow){md.stacked_hbar.isEnabled=true;md.stacked_vbar.isEnabled=true;md.line.isEnabled=false;md.area.isEnabled=false;if(!self.display._tableRowsAddToMoreThan100Percent(displayData)){md.pie.isEnabled=true;md.donut.isEnabled=true}}if(displayData.isWeightedAvg){md.stacked_hbar.isEnabled=false;md.stacked_vbar.isEnabled=false;md.pie.isEnabled=false;md.donut.isEnabled=false}if(!md[chartType].isEnabled&&md[chartType].isSelected){md[chartType].isSelected=false;chartType=self.display.DEFAULT_CHART_TYPE;md[chartType].isSelected=true}return md},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,".chart-types li",{self:self},self._onChartTypeClick)},_onChartTypeClick:function(e){var self=e.data.self,$target=$(e.target),chartType=$target.attr("data-chart-type"),updates;e.preventDefault();if($target.hasClass("disabled")){return}updates=self.display.getChartTypeUpdates(chartType);self.display.updateTempDisplay(updates);self.display.setDisplayUpdates(updates);self.render()}});SM.CustomizeTop2ChartTypeView=SM.Views.register({__NAME:"CustomizeChartTypeView",__templateID:"top2-customize-chart-type-template",__defaults:{hasAreaCharts:false,hasPieDonutCharts:false,hasStackedCharts:false},__create:function(options){var self=this;self.question=options.question;self.rollup=options.rollup;self.display=options.display;self.set("hasAreaCharts",options.hasAreaCharts);self.set("hasPieDonutCharts",options.hasPieDonutCharts);self.set("hasStackedCharts",options.hasStackedCharts);_.bindAll(this,"_onChartTypeClick")},__beforeRender:function(md){var self=this,displayValues=self.display.DISPLAY_VALUES,chartType=self.display.getChartType(),isCompare=self.rollup.type==="compare",enableDonut=true;if(isCompare){enableDonut=self.question.compareStructure.answers.crossedOptions.length===1}md={hbar:{isEnabled:true,isSelected:chartType===displayValues.hbar},vbar:{isEnabled:true,isSelected:chartType===displayValues.vbar},boxplot:{isEnabled:true,isSelected:chartType===displayValues.boxplot},top2_vbar:{isEnabled:true,isSelected:chartType===displayValues.top2_vbar},top2_hbar:{isEnabled:true,isSelected:chartType===displayValues.top2_hbar},top2_donut:{isEnabled:enableDonut,isSelected:chartType===displayValues.top2_donut}};if(!md[chartType].isEnabled&&md[chartType].isSelected){md[chartType].isSelected=false;chartType=self.display.DEFAULT_CHART_TYPE;md[chartType].isSelected=true}return md},__afterRender:function(){this.$el.find(".q").popout()},__init:function(){var self=this;self.$el.on(SM.Event.CLICK,".chart-types li",{self:self},self._onChartTypeClick)},_onChartTypeClick:function(e){var self=this,$target=$(e.target),chartType;e.preventDefault();if($target.hasClass("disabled")){return}chartType=$target.attr("data-chart-type");self._changeChartType(chartType)},_changeChartType:function(chartType){var self=this,updates;updates=self.display.getChartTypeUpdates(chartType,true);self.display.updateTempDisplay(updates);self.display.setDisplayUpdates(updates);self.render()}});SM.CustomizeDisplayOptionsView=SM.Views.register({__NAME:"CustomizeDisplayOptionsView",__templateID:"customize-display-options-template",__defaults:{hasDepthOptions:false,hasScaleOptions:false,hasMirrorOptions:false,hasShowEmptyOptions:false},_yAxisScaleOptions:null,__create:function(options){var self=this;self.question=options.question;self.rollup=options.rollup;self.display=options.display;self.customizeView=options.customizeView;self.set("hasMirrorOptions",options.hasMirrorOptions);self.set("hasDepthOptions",options.hasDepthOptions);self.set("hasScaleOptions",options.hasScaleOptions);self.set("hasShowEmptyOptions",options.hasShowEmptyOptions);_.bindAll(self,"_onDisplayOptionSelected","_onShowUpgradeDialog","_onScaleEditSpin")},__beforeRender:function(){var self=this,displayOptions=self.display.DISPLAY_OPTIONS,displayValues=self.display.DISPLAY_VALUES,displayData=self.display.getDisplayData({isCustomization:true}),hasDepthOptions=displayData.hasDepthOptions&&self.get("hasDepthOptions"),hasScaleOptions=displayData.hasScaleOptions&&self.get("hasScaleOptions"),isPercent=displayData.isPercent,isMirrorable=displayData.isMirrorable&&self.get("hasMirrorOptions"),upgradeSidi=!self.question.survey.owner.canSigDiffs(),disableSidi=!upgradeSidi&&(!self.question.canSidi()||self.rollup.comparedByRA),enableSidi=!upgradeSidi&&!disableSidi,disableBS=self.question.hasRandomAssignment()||self.question.isQuiz(),isSidiStatsShown=displayData.show_sig_diffs&&displayData.mirror,hasShowEmptyOptions=displayData.hasShowEmptyOptions&&self.get("hasShowEmptyOptions"),numDecimalPlaces=parseInt(isPercent?displayData.dp_percentage:displayData.dp_absolute,10),rangeScaleOptions=self._getRangeScaleOptions(displayData),axisRangeValues;if(self.question.isNPS()&&displayData.nps_depth===displayValues.nps_score){hasScaleOptions=false}if(rangeScaleOptions!=="none"){axisRangeValues=self._buildAxisMaxValuesContext(displayData);if(axisRangeValues&&!axisRangeValues.hasOptions){rangeScaleOptions="none"}}return{questionID:self.question.ID,isTableShown:displayData.show_table,isChartShown:displayData.show_chart,isDataShown:displayData.show_data,disableDataShown:displayData.disable_show_data===displayValues.disabled,disableBS:disableBS,isBasicStatsShown:displayData.show_basic_stats,disableSidi:disableSidi,enableSidi:enableSidi,upgradeSidi:upgradeSidi,isSidiStatsShown:isSidiStatsShown,hasEmptyOptions:hasShowEmptyOptions,canShowEmpty:hasShowEmptyOptions&&!displayData.show_empty_data,canHideEmpty:hasShowEmptyOptions&&displayData.show_empty_data,hasMirrorOptions:isMirrorable,canMirror:isMirrorable&&!displayData.mirror,canUnMirror:isMirrorable&&displayData.mirror,hasDepthOptions:hasDepthOptions,isDistributionChart:displayData.isDistribution,isWeightedAvg:displayData.isWeightedAvg,canDistributionChart:hasDepthOptions&&!displayData.isDistribution,canWeightedAvgChart:self._canChooseWeightedAvgChart(displayData,hasDepthOptions),hasScaleOptions:hasScaleOptions,scaleIsPercent:isPercent,rangeScaleMinEditable:rangeScaleOptions.indexOf("min")>-1,rangeScaleMaxEditable:rangeScaleOptions.indexOf("max")>-1,scaleMinOptionKey:self.display.getScaleMinOptionKey(),scaleMaxOptionKey:self.display.getScaleMaxOptionKey(),axisMaxValue:axisRangeValues?axisRangeValues.max:null,axisMinValue:axisRangeValues?axisRangeValues.min:null,enableDecimalPlaces:isPercent||displayData.isWeightedAvg,decimalPlacesKey:displayOptions[isPercent?"dp_percentage":"dp_absolute"],dpIsZero:numDecimalPlaces===0,dpIsOne:numDecimalPlaces===1,dpIsTwo:numDecimalPlaces===2,isLabelable:displayData.isLableable,labelIsLegend:displayData.isLableable&&displayData.isLegend,labelIsLabel:displayData.isLableable&&!displayData.isLegend,isNps:self.question.isNPS(),isDepthScore:displayData.isDepthScore,isDepthDistribution:displayData.isDepthDistribution,isDepthDetailed:displayData.isDepthDetailed,displayOptions:displayOptions,displayValues:displayValues}},__afterRender:function(){var self=this,options=self._yAxisScaleOptions,scaleMin=self.$el.find("#scaleMin"),scaleMax=self.$el.find("#scaleMax");self.$el.find(".q").each(function(){$(this).popout()});scaleMin.spinner({max:options?Math.floor(options.min):null,spin:self._onScaleEditSpin});if(scaleMin.prop("disabled")){scaleMin.spinner("disable");if(!scaleMin.closest(".form-group").hasClass("disabled")){scaleMin.closest(".scale-wrapper").addClass("disabled")}}scaleMax.spinner({min:options?Math.ceil(options.max):null,spin:self._onScaleEditSpin});if(scaleMax.prop("disabled")){scaleMax.spinner("disable")}},__init:function(){var self=this;self.$el.on("change","input, select",self._onDisplayOptionSelected);self.$el.on("click",".upgrade-trigger",self._onShowUpgradeDialog);self.$el.on("click",".upgrade-trigger .upgrade-btn",self._onUpgradeBtnClicked);self.$el.on("click",'.upgrade-trigger input[type="checkbox"]',self._onUpgradeTriggerFieldToggle)},_onShowUpgradeDialog:function(){this._showUpgradeDialog("sig-diff-upgrade-dialog-template")},_showUpgradeDialog:function(templateID){var upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:templateID});upgradeDialog.open()},_onUpgradeTriggerFieldToggle:function(e){var upgradeDialog;e.stopImmediatePropagation();$(e.currentTarget).prop("checked",false);upgradeDialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"sig-diff-upgrade-dialog-template"});upgradeDialog.open()},_onUpgradeBtnClicked:function(e){e.stopImmediatePropagation()},_onScaleEditSpin:function(e,ui){var self=this,input=$(e.target),action=input.attr("data-action").split(".");if(action[0]==="chart"){input.removeClass("error").closest(".scale-container").removeAttr("title");clearTimeout(self._spinnerTimeout);self._spinnerTimeout=setTimeout(function(){self._updateChartDisplayOptions(action[1],ui.value+"")},250)}},_onDisplayOptionSelected:function(e){var self=this,$target=$(e.target),$displayOption=$target.parents(".display-option"),$option,action,value,parts,field,inputMin,inputMax,rangeMin,rangeMax,valueMin,valueMax,errorMin,errorMax,modelType;if(!!$displayOption.attr("disabled")||$displayOption.hasClass("upgrade-trigger")){return}if($target.is("select")){$option=$target.children("option:selected");action=$option.attr("data-action");value=$option.attr("data-value")}else{action=$target.attr("data-action");if(action.indexOf("chart.scale")>-1){inputMin=self.$el.find("#scaleMin");inputMax=self.$el.find("#scaleMax");rangeMin=self._yAxisScaleOptions.min;rangeMax=self._yAxisScaleOptions.max;valueMin=parseFloat(inputMin.val());valueMax=parseFloat(inputMax.val());inputMin.val(isNaN(valueMin)?Math.floor(rangeMin):valueMin);inputMax.val(isNaN(valueMax)?Math.ceil(rangeMax):valueMax);errorMin=!isNaN(valueMin)&&valueMin>rangeMin;errorMax=!isNaN(valueMax)&&valueMax<rangeMax;inputMin.toggleClass("error",errorMin);if(errorMin){inputMin.closest(".scale-container").attr("title",Globalize.localize("Enter a number less than the lowest number in your chart"))}else{inputMin.closest(".scale-container").removeAttr("title")}if(!isNaN(valueMax)){inputMax.val(valueMax)}inputMax.toggleClass("error",errorMax);if(errorMax){inputMax.closest(".scale-container").attr("title",Globalize.localize("Enter a number greater than the highest number in your chart"))}else{inputMax.closest(".scale-container").removeAttr("title")}self.$el.trigger("displayOptionsValidation",[errorMin||errorMax]);if(errorMin||errorMax){return}}value=$target.attr("data-value");if(_.isUndefined(value)){value=$target.val()}}parts=action.split(".");modelType=parts[0];field=parts[1];e.preventDefault();if(value&&field&&modelType){if(modelType==="table"){self._updateTableDisplayOptions(field,value)}else if(modelType==="chart"){self._updateChartDisplayOptions(field,value)}else if(modelType==="both"){self._updateChartDisplayOptions(field,value);self._updateTableDisplayOptions(field,value)}}else{SM.Error.log({name:"DisplayOptionSelectedException",details:"_onDisplayOptionSelected: no field or value selected"})}self.render()},_updateChartDisplayOptions:function(field,value){var self=this,update={};update[field]=value;self.display.updateTempDisplay(update);self.display.setDisplayUpdates(update)},_updateTableDisplayOptions:function(field,value){var self=this,update={};update[field]=value;self.display.updateTempDisplay(update);self.display.setDisplayUpdates(update)},_canChooseWeightedAvgChart:function(displayData,hasDepthOptions){var self=this;return hasDepthOptions&&displayData.isDistribution&&(self.question.isCompared()?displayData.mirror:!displayData.mirror)},_getRangeScaleOptions:function(displayData){var self=this;if(self.question.hasRandomAssignment()||!self.customizeView.questionView.getCurrentChartView()||displayData.isPieChart||displayData.isDonutChart||self.question.isNPS()&&displayData.chart_type===self.display.DISPLAY_VALUES.score_gauge){return"none"}if(displayData.isStacked||displayData.isAreaChart&&!self.question.isSimple()){return displayData.isPercent?"none":"max"}return"max_min"},_buildAxisMaxValuesContext:function(displayData){var self=this,isNPS=self.question.isNPS(),hightcharts=SM.Highcharts,specialCharts=displayData.isStacked||displayData.isAreaChart&&!self.question.isSimple(),options,seriesMin,seriesMax;if(isNPS&&displayData.chart_type===SM.QuestionDisplayModel.DISPLAY_VALUES.score_gauge){self._yAxisScaleOptions=options={min:-100,max:100,hasOptions:false}}else if(specialCharts&&displayData.isPercent){self._yAxisScaleOptions=options={min:0,max:100,hasOptions:false}}else{_.each(self.customizeView.questionView.getCurrentChartView().getSeriesList(),function(series){var range;if(displayData.isStacked||displayData.isAreaChart&&!self.question.isSimple()&&!displayData.isWeightedAvg){range=hightcharts.calculateStackedSeriesRange(series)}else{range=hightcharts.calculateSeriesRange(series)}if(_.isUndefined(seriesMin)){seriesMin=range.min;seriesMax=range.max}else{seriesMin=Math.min(seriesMin,range.min);seriesMax=Math.max(seriesMax,range.max)}});if(displayData.isPercent){options={min:0,max:Math.ceil(seriesMax/100)*100||100};options.tickInterval=options.max/10}else if(self.question.isSingleChoice()&&displayData.isWeightedAvg){options=hightcharts.calculateYAxisScaleOptions(self.question.rowList.length,0)}else{if(seriesMax<0){seriesMax=0}options=hightcharts.calculateYAxisScaleOptions(seriesMax);if(seriesMin<0){options.min=-options.max;options.tickInterval*=2}}options=self.display.getCustomScale({min:seriesMin,max:seriesMax},options);if(isNPS){if(displayData.nps_depth===self.display.DISPLAY_VALUES.nps_distribution||displayData.nps_depth===self.display.DISPLAY_VALUES.nps_detailed){options.min=0;seriesMin=0}else if(options.min<0){options.min=Math.min(options.min,-options.max)}}else if(specialCharts){options.min=0;seriesMin=0}options.hasOptions=true;self._yAxisScaleOptions={min:seriesMin,max:seriesMax,tickInterval:options.tickInterval}}return options}});SM.NpsCustomizeChartTypeView=SM.Views.deepExtend(SM.CustomizeChartTypeView,{__NAME:"NpsCustomizeChartTypeView",__templateID:"nps-customize-chart-type-template",__beforeRender:function(md){var self=this,displayValues=self.display.DISPLAY_VALUES,chartType=self.display.getChartType();md={hbar:{isEnabled:true,isSelected:chartType===displayValues.hbar},vbar:{isEnabled:true,isSelected:chartType===displayValues.vbar},stacked_hbar:{isEnabled:true,isSelected:chartType===displayValues.stacked_hbar},stacked_vbar:{isEnabled:true,isSelected:chartType===displayValues.stacked_vbar},score_gauge:{isEnabled:!self.question.isCompared(),isSelected:chartType===displayValues.score_gauge},score_hbar:{isEnabled:true,isSelected:chartType===displayValues.score_hbar},score_vbar:{isEnabled:true,isSelected:chartType===displayValues.score_vbar}};return md},__afterRender:function(){SM.CustomizeChartTypeView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.CustomizeColorsView=SM.Views.register({__NAME:"CustomizeColorsView",__templateID:"customize-colors-template",MIN_COLORS_FOR_DELETING:11,__create:function(options){var self=this;self.rollup=options.rollup;self.display=options.display;_.bindAll(this,"_newColor","_createColor","_editColor","_updateColor","_deleteColor","_sortColors","_onActionMenuAfterClose","_onColorPickerSwatchClick")},__beforeRender:function(){var self=this;self.displayUpdates=self.display.getDisplayUpdates();self.displayData=self.display.getDisplayData();self.tempDisplay=self.display.getTempDisplay();self.colors=self.displayData.colors||SM.Highcharts.DEFAULT_COLORS;return{colors:self._colorsForTemplate()}},__afterRender:function(){var self=this;self._bindActionMenusToColorListItems();self._makeColorListSortable()},_colorsForTemplate:function(){var self=this,context;context=_.map(self.colors,function(hexValue,index){return{position:index,hex:hexValue}});return context},_makeColorListSortable:function(){var self=this,$colorList=self.$el.find(".color-list");$colorList.sortable({scroll:false,distance:5,tolerance:"pointer",containment:"parent",placeholder:"color-list-item-placeholder",forcePlaceholderSize:true,update:self._sortColors})},_bindActionMenusToColorListItems:function(){var self=this,color,$colorListItems,$colorListItem,$actionMenu,menuActions;$colorListItems=self.$el.find(".color-list-item");menuActions=[{text:Globalize.localize("Edit Color"),action:"_editColor"},{text:Globalize.localize("Copy Color"),action:"_copyColor"},{text:Globalize.localize("Delete Color"),action:"_deleteColor",isDisabled:self.colors.length<self.MIN_COLORS_FOR_DELETING}];_.each($colorListItems,function(colorListItems){$colorListItem=$(colorListItems);color={hex:$colorListItem.attr("data-hex"),position:parseInt($colorListItem.attr("data-position"),10)};$actionMenu=$colorListItem.actionMenu({templateID:"color-list-item-action-menu-template",actions:menuActions});(function(clr,$item){$actionMenu.on("actionMenu.beforeOpen",function(e){self._onActionMenuBeforeOpen(e)});$actionMenu.on("actionMenu.afterClose",function(e){self._onActionMenuAfterClose(e,clr,$item)})})(color,$colorListItem)})},_renderColorPickerView:function($target,options){var self=this,view,viewOptions;viewOptions={position:options.position,originalHexValue:options.hexValue};if(options.add){viewOptions.onSwatchClick=self._onColorPickerSwatchClick;viewOptions.onColorSelected=self._createColor;viewOptions.primaryBtnText=Globalize.localize("Add")}else{viewOptions.onSwatchClick=self._onColorPickerSwatchClick;viewOptions.onColorSelected=self._updateColor}view=SM.Views.create(SM.CustomizeColorPickerView,viewOptions);$("body").append(view.el);view.$el.position({my:"left center",at:"right center",of:$target,within:self.$el})},__init:function(){var self=this;self.$el.on("click","[new-color]",self._newColor)},_onActionMenuBeforeOpen:function(e){var self=this,actionMenu=e.actionMenu,menuView=actionMenu.get("menuView");var deleteActionContext=menuView.get("actions")[2];deleteActionContext.isDisabled=self.colors.length<self.MIN_COLORS_FOR_DELETING},_onActionMenuAfterClose:function(e,color,$colorListItem){var self=this,actionMenu=e.actionMenu,menuView=actionMenu.get("menuView"),selectedAction=menuView.get("selectedAction");if(selectedAction){self[selectedAction].call(self,color,$colorListItem)}},_onColorPickerSwatchClick:function(data){var self=this,position=data.position,hexValue=data.hex,shouldUpdateTempDisplay;self.colors[position]=hexValue;shouldUpdateTempDisplay=self._shouldUpdateTempDisplay({position:position});if(shouldUpdateTempDisplay){self.display.updateTempDisplay({colors:self.colors})}},_newColor:function(e){var self=this,$currentTarget=$(e.currentTarget);e.preventDefault();self._renderColorPickerView($currentTarget,{add:true})},_createColor:function(options){var self=this,hexValue=options.hex;self.colors.push(hexValue);self.display.updateTempDisplay({colors:self.colors});self._setChartDisplayUpdates(self.colors);self.render()},_editColor:function(color,$colorListItem){var self=this,position,hexValue;hexValue=color.hex;position=color.position;self._renderColorPickerView($colorListItem,{position:position,hexValue:hexValue})},_updateColor:function(data){var self=this,position=data.position,hexValue=data.hex;self.colors[position]=hexValue;self.display.updateTempDisplay({colors:self.colors});self._setChartDisplayUpdates(self.colors);self.render()},_copyColor:function(color){var self=this,newPosition=color.position+1,hexValue=color.hex;self.colors.splice(newPosition,0,hexValue);self.display.updateTempDisplay({colors:self.colors});self._setChartDisplayUpdates(self.colors);self.render()},_deleteColor:function(color,$colorListItem){var self=this;self.colors.splice(color.position,1);self.display.updateTempDisplay({colors:self.colors});self._setChartDisplayUpdates(self.colors);$colorListItem.fadeOut(250,function(){self.render()})},_sortColors:function(){var self=this,$sortedColorListItems,sortedColors;$sortedColorListItems=self.$el.find(".color-list-item");sortedColors=_.map($sortedColorListItems,function(colorListItem){return $(colorListItem).attr("data-hex")});self.colors=sortedColors;if(self._shouldUpdateTempDisplay()){self.display.updateTempDisplay({colors:self.colors})}self._setChartDisplayUpdates(self.colors);self.render()},_shouldUpdateTempDisplay:function(){return true},_setChartDisplayUpdates:function(colors){var self=this,update={colors:colors};self.display.setDisplayUpdates(update)}});SM.CustomizeColorPickerView=SM.Views.register({__NAME:"CustomizeColorPickerView",__templateID:"customize-color-picker-template",DEFAULT_HEX_VALUES:["#FFFFFF","#E9E9E9","#CCCCCC","#999999","#676767","#343434","#010101","#D0CFBD","#B6B8AA","#93938B","#807E71","#717167","#5A5947","#4D4B3E","#FFFCB9","#F8F580","#E8EC74","#D0D04C","#A7C23D","#86A23C","#4F7A28","#FECB3E","#F1B12B","#F29E2C","#DC7E36","#C75227","#C6332B","#FF3301","#D9EDEC","#8CC8C9","#33BDBF","#01A3A6","#01858A","#36606E","#003849","#A7C6FC","#74A6FF","#398AFF","#0063FF","#0142AA","#01317D","#002055","#E493FC","#D257FF","#9A2ABD","#7B209F","#61197D","#450F5A","#2E073E"],__create:function(options){var self=this;self.position=options.position;self.originalHexValue=options.originalHexValue;self.onColorSelected=options.onColorSelected;self.onSwatchClick=options.onSwatchClick;self.primaryBtnText=options.primaryBtnText||Globalize.localize("Save");_.bindAll(this,"_onSwatchClick","_onCustomHexValueChange","_onSaveBtnClick","_onCancelBtnClick")},__beforeRender:function(){var self=this,defaultColors;self.newHexValue=null;self.$selectedSwatch=null;defaultColors=self._colorsForTemplate();return{defaultColors:defaultColors,primaryBtnText:self.primaryBtnText}},__afterRender:function(){var self=this;self.$customHexSwatch=self.$el.find("[custom-hex-swatch]")},__init:function(){var self=this;self.$el.on("click","[color-swatch]",self._onSwatchClick);self.$el.on("click","[primary-btn]",self._onSaveBtnClick);self.$el.on("click","[cancel-btn]",self._onCancelBtnClick);self.$el.on("keyup","[custom-hex-value]",self._onCustomHexValueChange)},_colorsForTemplate:function(){var self=this;return _.map(self.DEFAULT_HEX_VALUES,function(hexValue,index){return{position:index,hex:hexValue}})},_animateOut:function(){var self=this;self.$el.fadeOut(250,function(){self.$el.remove()})},_onSwatchClick:function(e){var self=this,$target=$(e.currentTarget);e.preventDefault();self.newHexValue=$target.attr("data-hex");if(self.$selectedSwatch){self.$selectedSwatch.removeClass("selected")}self.$selectedSwatch=$target;self.$selectedSwatch.addClass("selected");self.onSwatchClick({position:self.position,hex:self.newHexValue})},_onCustomHexValueChange:function(e){var self=this,$target=$(e.target),hexValue=$target.val();if(self._validateHexValue(hexValue)){self.$customHexSwatch.css({backgroundColor:hexValue})}},_validateHexValue:function(){return true},_onSaveBtnClick:function(e){var self=this;e.preventDefault();self.onColorSelected({position:self.position,hex:self.newHexValue});self._animateOut()},_onCancelBtnClick:function(e){var self=this;e.preventDefault();if(self.newHexValue&&self.originalHexValue){self.onColorSelected({position:self.position,hex:self.originalHexValue})}self._animateOut()}});SM.CustomizeLabelsView=SM.Views.register({__NAME:"CustomizeLabelsView",__templateID:"customize-labels-template",__create:function(options){var self=this;self.question=options.question;self.rollup=options.rollup;self.display=options.display;_.bindAll(this,"_onLabelInputClick","_onLabelInputKeyUp","_onLabelInputFocus","_onLabelInputBlur","_onRevertLinkClick")},__beforeRender:function(){var self=this,isCompared=self.question.isCompared(),answersStructures=self.question.labelByWeights(self.question.getContextStructure().answers),rows=answersStructures.rows,columns=answersStructures.cols,columnChoices,crossedOptions=answersStructures.crossedOptions,otherOptions=answersStructures.other,answerLabels=[],questionHeadingLabel,rowLabels,columnLabels,columnChoiceLabels,crossedOptionLabels,otherOptionLabels;if(!self.question.isNPS()){questionHeadingLabel=self._buildQuestionHeadingLabelContext();answerLabels=answerLabels.concat(questionHeadingLabel);rowLabels=self._buildLabelsContext("rows",rows);answerLabels=answerLabels.concat(rowLabels);if(!isCompared||isCompared&&crossedOptions!==columns){columnLabels=self._buildLabelsContext("columns",columns);answerLabels=answerLabels.concat(columnLabels)}otherOptionLabels=self._buildLabelsContext("others",otherOptions);answerLabels=answerLabels.concat(otherOptionLabels)}if(isCompared){if(!self.rollup.comparedByMyself){crossedOptionLabels=self._buildLabelsContext("crossedOptions",crossedOptions);answerLabels=answerLabels.concat(crossedOptionLabels)}}else{if(columns&&columns[0].items){_.each(columns,function(column){columnChoices=column.items;columnChoiceLabels=self._buildLabelsContext("columnChoices",columnChoices);answerLabels=answerLabels.concat(columnChoiceLabels)})}}_.each(answerLabels,function(answerLabel,i){answerLabel.tabIndex=i+1});return{answerLabels:answerLabels}},_buildQuestionHeadingLabelContext:function(){var self=this,label=self.display.getQuestionHeadingLabel(),customText=label&&label.text&&label.text.length?label.text:null;return self._buildLabelContext("questionHeading",self.question.heading,customText,{})},_buildLabelsContext:function(answersType,answersArray){var self=this,labelContexts=[],label,labelContext,customText;_.each(answersArray,function(answerData){if(self._isCustomizableAnswerOption(answerData)){label=self.display.getLabel(answersType,answerData.id);if(label&&label.text){customText=label.text.length?label.text:null}else{customText=null}labelContext=self._buildLabelContext(answersType,answerData.text,customText,{answerID:answerData.id});if(answerData.type==="row"&&self.question.isEmoji()&&!customText){labelContext.useEmoji=true}labelContexts.push(labelContext)}});return labelContexts},_isCustomizableAnswerOption:function(answerData){var isCustomizable=true;if(answerData.type==="other"&&!answerData.options.is_answer_choice){isCustomizable=false}return isCustomizable},_buildLabelContext:function(labelType,originalText,customText,options){var labelContext={};labelContext.labelType=labelType;labelContext.originalText=originalText;labelContext.customText=customText;labelContext.showRevertLink=originalText!==customText&&!_.isEmpty(customText);if(options.answerID){labelContext.answerID=options.answerID}return labelContext},__init:function(){var self=this;self.$el.on("click","[custom-label-input]",self._onLabelInputClick);self.$el.on("focus","[custom-label-input]",self._onLabelInputFocus);self.$el.on("blur","[custom-label-input]",self._onLabelInputBlur);self.$el.on("keyup","[custom-label-input]",self._onLabelInputKeyUp);self.$el.on("click","[revert-custom-label-link]",self._onRevertLinkClick)},_onLabelInputClick:function(e){var self=this,$target=$(e.currentTarget);$target.select();self._hideErrorMessaging($target)},_onLabelInputFocus:function(e){var self=this,$target=$(e.currentTarget),answerID=$target.attr("answer-id");self._highlightTableLabelCell(answerID);self._hideErrorMessaging($target)},_onLabelInputKeyUp:function(e){var self=this,$target=$(e.currentTarget),$revertLink=$target.parent().parent().find("[revert-custom-label-link]"),answerID=$target.attr("answer-id"),labelType=$target.attr("label-type"),labelText=$target.val(),originalText;originalText=self._getOriginalText(labelType,answerID);if(labelText!==originalText){if(labelType==="rows"&&self.question.isEmoji()){$target.removeAttr("style")}$revertLink.removeClass("hidden");self._changeLabel({labelType:labelType,answerID:answerID,labelText:labelText})}else{$revertLink.addClass("hidden")}},_onLabelInputBlur:function(e){var self=this,$target=$(e.currentTarget),answerID=$target.attr("answer-id"),$errorMessage=$target.next("[custom-label-error-message]"),labelText=$target.val();if(!labelText){$target.addClass("has-errors");$errorMessage.show()}else{self._unHighlightTableLabelCell(answerID)}},_onRevertLinkClick:function(e){var self=this,$revertLink=$(e.currentTarget),$labelInput=$revertLink.parent().find("[custom-label-input]"),answerID=$labelInput.attr("answer-id"),labelType=$labelInput.attr("label-type"),originalText;e.preventDefault();originalText=self._getOriginalText(labelType,answerID);$labelInput.val(originalText);if(labelType==="rows"&&self.question.isEmoji()){$labelInput.css("font-family","SMFont")}$revertLink.addClass("hidden");self._hideErrorMessaging($labelInput);self._changeLabel({labelType:labelType,answerID:answerID,labelText:null})},scrollToLabel:function(answerID){var self=this,$labelInput,scrollTop;if(answerID){$labelInput=self.$el.find("[answer-id='"+answerID+"']")}else{$labelInput=self.$el.find("[label-type='questionHeading']")}if($labelInput.length===0){return}scrollTop=self.$el.scrollTop()+$labelInput.position().top;self.$el.animate({scrollTop:scrollTop},250,function(){$labelInput.click()})},_highlightTableLabelCell:function(answerID){var self=this,$table=self.$el.parents("[sm-question-view]").find("[summary-table-container] table");$table.trigger({type:"highlightLabelCell",answerID:answerID})},_unHighlightTableLabelCell:function(answerID){var self=this,$table=self.$el.parents("[sm-question-view]").find("[summary-table-container] > table");$table.trigger({type:"unHighlightLabelCell",answerID:answerID})},_setHighlightedTableLabelCell:function(answerID){var self=this,$tableContainer=self.$el.parents("[sm-question-view]").find("[summary-table-container]");$tableContainer.trigger({type:"setHighlightedLabelCell",answerID:answerID})},_changeLabel:function(options){var self=this,updates;self._setHighlightedTableLabelCell(options.answerID);updates=self.display.buildLabelUpdates(options);self.display.updateTempDisplay(updates);self.display.setDisplayUpdates(updates)},_getOriginalText:function(labelType,answerID){var self=this,answers=self.question.getContextStructure().answers,answer,text;if(labelType==="questionHeading"){text=self.question.heading}else{if(labelType==="rows"){answer=_.find(answers.rows,function(row){return row.id===answerID});text=answer.text}else if(labelType==="columns"){answer=_.find(answers.cols,function(column){return column.id===answerID});text=answer.text}else if(labelType==="columnChoices"){_.each(answers.cols,function(column){_.each(column.items,function(columnChoice){if(columnChoice.id===answerID){answer=columnChoice;text=answer.text;return}})})}else if(labelType==="crossedOptions"){answer=_.find(answers.crossedOptions,function(crossedOption){return crossedOption.id===answerID});text=answer.text}else if(labelType==="others"){answer=_.find(answers.other,function(otherOption){return otherOption.id===answerID});text=answer.text}}return text},_hideErrorMessaging:function($target){var $errorMessage=$target.next("[custom-label-error-message]");if($target.hasClass("has-errors")){$target.removeClass("has-errors");$errorMessage.hide()}}});SM.CombineDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"CombineDialogView",__templateID:"combine-dialog-template",__model:"rollup",__onAfterClose:function(){SM.DialogView.__onAfterClose.call(this);this.$el.remove();$("body").removeClass("modal-open")},__defaults:{isModal:true,easyClose:false,closeBtn:true,width:755},__beforeRender:function(){var self=this,answerID=self.__settings.answerID,title=self.rollup.combinehideModel.getCompositeAnswerTextById(answerID);return{isEditCombine:self.__settings.isEditCombine,answerID:answerID,title:title}},__afterRender:function(md){var self=this;SM.DialogView.__afterRender.call(self,md);self.$el.find(".q").popout();self.dialogLabelInfo=self.rollup.combinehideModel.getCombinedDataInfo(self.__settings.answerID,self.__settings.isEditCombine);_.each(self.dialogLabelInfo,function(labelInfo){var itemHTML=SM.Template.renderHTML("combine-hide-combine-list-item-template",labelInfo);self.$el.find("[combine-view-option-list]").append(itemHTML)})},__init:function(){var self=this;this.$el.on(SM.Event.CLICK,"[save-btn]",{self:this},this._onSave);this.$el.on(SM.Event.CLICK,"[cancel-btn]",{self:this},this._onCancel);self.$el.find("input[type='text']").on("keyup",{self:this},self._onInput);
self.$el.find("input[type='text']").on("focus",{self:this},self._onInput);self.$el.find("input[type='checkbox']").on("click",{self:this},self._onCheck)},_onInput:function(e){var self=e.data.self;self.$el.find(".form-control-errors").addClass("valid");self._validate()},_onCancel:function(e){e.preventDefault();e.data.self.close()},_canSave:function(){var self=this,isChecked,checkList=[],$input,name;$input=self.$el.find("input[type='text']");name=$input.val();if(_.string.isBlank(name)){return false}self.$el.find("input[type='checkbox']").each(function(){isChecked=$(this).is(":checked");if(isChecked){checkList.push($(this).attr("data-answer-id"))}});if(_.size(checkList)<=1){return false}return true},_onCheck:function(e){var self=e.data.self;self._validate()},_validate:function(){var self=this;if(self._canSave()){self._enableSaveBtn()}else{self._disableSaveBtn()}},_enableSaveBtn:function(){var self=this;self.$el.find("[save-btn]").removeClass("disabled")},_disableSaveBtn:function(){var self=this;self.$el.find("[save-btn]").addClass("disabled")},_onSave:function(e){var self=e.data.self,checkList=[],$input,title,isChecked,valid=true;e.preventDefault();if(self.$el.find("[save-btn]").hasClass("disabled")){return}self.$el.find("input[type='checkbox']").each(function(){isChecked=$(this).is(":checked");if(isChecked){checkList.push($(this).attr("data-answer-id"))}});$input=self.$el.find("input[type='text']");title=$input.val();if(self.__settings.isEditCombine){valid=self.rollup.combinehideModel.editCombine(self.__settings.answerID,{title:title,combine:checkList})}else{valid=self.rollup.combinehideModel.addCombine({title:title,combine:checkList})}if(valid){self.close()}}});SM.CombineHideFooterView=SM.Views.register({__NAME:"CombineHideFooterView",__templateID:"summary-combine-hide-footer-template",__create:function(options){var self=this;self.rollup=options.rollup},__beforeRender:function(){var self=this,sizeHides;sizeHides=self.rollup.combinehideModel.getUnHidingStatus();return{isMultiple:sizeHides>1,isSingle:sizeHides===1,isNone:sizeHides===0}},__init:function(){var self=this;self.$el.on("actionMenu.actionSelected",{self:this},this._onActionSelected);self.$el.on(SM.Event.CLICK,"a[single-choice]",{self:this},this._onSingle);self.$el.on(SM.Event.CLICK,"a[multiple-choices]",{self:this},this._onMultiple);self.$el.on(SM.Event.CLICK,".action-arrow",{self:this},this._onMultiple)},_onActionSelected:function(e){var self=e.data.self;e.stopPropagation();if(e.action==="un-hide-action-sv"){self.rollup.combinehideModel.unHideAll()}else{self.rollup.combinehideModel.unHide(e.action)}},_onSingle:function(e){var self=e.data.self;e.stopPropagation();self.rollup.combinehideModel.unHideAll()},_onMultiple:function(e){var self=e.data.self,hides,actions,$el;e.stopPropagation();hides=self.rollup.combinehideModel.getHides();actions=[];actions.push({text:Globalize.localize("Show and recalculate all"),action:"un-hide-action-sv"});_.each(hides,function(hide){actions.push({text:self.rollup.combinehideModel._getCompositeLabel(hide),action:hide.id})});$el=self.$el.find("a[multiple-choices]");$el.actionMenu({templateID:"combine-hide-footer-action-menu-template",position:{collision:"none none"},actions:actions});$el.data("actionMenu").open()}});SM.SummaryPageView=SM.Views.register({__NAME:"summaryPageView",__model:"page",__templateID:"summary-page-template",__beforeRender:function(){return{id:this.page.ID}},__afterRender:function(){var div,pageHeaderView=SM.Views.create(SM.SummaryPageHeaderView,{model:this.page}),questionListView;this.$el.prepend(pageHeaderView.el);if(this.page.shownQuestionList.length){questionListView=SM.Views.create(SM.SummaryQuestionListView,{model:this.page});this.$el.find(".page-header").after(questionListView.el)}else{div=document.createElement("div");div.innerHTML=SM.Template.render("no-page-questions");this.el.appendChild(div)}}});SM.SummaryPageHeaderView=SM.Views.register({__NAME:"SummaryPageHeaderView",__model:"page",__templateID:"summary-page-title-template",__init:function(){this.bindModel(this.page.survey,"rollupsAppended",{self:this},this._onRollupsAppended)},__beforeRender:function(){var page=this.page,questionRollups=page.survey.questionRollups,isAfterLastLoadedPage=questionRollups.isAfterLastLoadedPage(page);return{isVisible:!isAfterLastLoadedPage&&this.page.isShown(),title:this.page.heading,number:this.page.position}},_onRollupsAppended:function(e){var self=e.data.self;self.render()}});SM.SummaryPageListView=SM.Views.register({__NAME:"pageListView",__model:"survey",__templateID:"summary-page-list-template",__create:function(){this.set("lazyLoaderID",this.__NAME+"loader"+this.__uid)},__init:function(){var survey=this.survey,questionRollups=survey.questionRollups;this.$el.on(SM.Event.CLICK,"[try-again-btn]",{self:this},this._onTryAgainClicked).on("infiniteScroll.reachedEnd",{self:this},this._onReachedEnd);this.bindModel(survey,"rollupsAppended",{self:this},this._onRollupsAppended);this.bindModel(survey.state,"page.changed",{self:this},this._onPageChange);this.bindModel(survey,"shownListsChanged",{self:this},this._onPageChange);this.infiniteScroll=this.$el.infiniteScroll({windowScroll:true,threshold:1e3,markerID:this.get("lazyLoaderID"),isActive:!questionRollups.hasAll()&&questionRollups.isBuffered()}).data("infiniteScroll");if(this.infiniteScroll){this.survey.on("suspendResumeScroll",{self:this},this._onSuspendResumeScroll)}},__destroy:function(){if(this.infiniteScroll){this.survey.off("suspendResumeScroll",this._onSuspendResumeScroll)}},__beforeRender:function(){return{hasAllRollups:this.survey.questionRollups.hasAll()}},__afterRender:function(){var pageModel,lazyLoadView,survey=this.survey,questionRollups=survey.questionRollups,hasShownQuestions=survey.shownQuestionList.length>0,pageIndex=survey.state.get("page"),allPagesSelected=survey.state.get("allPagesSelected");if(!hasShownQuestions){SM.Template.renderHTML("no-shown-page-questions")}else if(!allPagesSelected){pageModel=survey.pageList[pageIndex];this._renderPage(pageModel)}else{this._renderAllPages(survey.shownPageList)}if(this._shouldRenderTMBCViews()){this._renderTMBCViews()}if(!questionRollups.hasAll()&&!SM.App.isSharingApp()){lazyLoadView=SM.Views.create(SM.SummaryLazyLoadView,{model:this.survey,ID:this.get("lazyLoaderID")});this.el.appendChild(lazyLoadView.el);if(this.infiniteScroll&&questionRollups.isBuffered()){this.infiniteScroll.set("isActive",true)}}},_shouldRenderTMBCViews:function(){var survey=this.survey;if(!survey.state.isSummaryMode()||survey.isExport){return false}if(!SM.App.isSharingApp()&&!survey.hasValidEntity()&&!survey.owner.hasBenchmarkingRestricted()){return false}if(!survey.isTMBCTemplate()){return false}if(survey.state.get("allPagesSelected")||survey.state.get("page")===0){return true}return false},_renderTMBCViews:function(){var view=SM.Views.create(SM.SummaryTMBCViewContainer,{model:this.survey,tmbcType:this.survey.tmbc.TMBC_TYPE_ENGAGEMENT});this.$el.prepend(view.el);view=SM.Views.create(SM.SummaryTMBCViewContainer,{model:this.survey,tmbcType:this.survey.tmbc.TMBC_TYPE_GEI});this.$el.prepend(view.el)},_onSuspendResumeScroll:function(e){var self=e.data.self,suspend=e.suspend;if(suspend){self.suspendScroll()}else{self.resumeScroll()}},suspendScroll:function(){var self=this;if(self.infiniteScroll){self._scrollWasActive=self.infiniteScroll.get("isActive");self.infiniteScroll.set("isActive",false)}},resumeScroll:function(){var self=this;if(self.infiniteScroll&&!_.isUndefined(self._scrollWasActive)){self.infiniteScroll.set("isActive",self._scrollWasActive);delete self._scrollWasActive}},_renderPage:function(pageModel){var pageView=SM.Views.create(SM.SummaryPageView,{model:pageModel});this.$el.prepend(pageView.el)},_renderAllPages:function(pageList){var pageView,frag=document.createDocumentFragment();$.each(pageList,function(i,pageModel){if(!pageModel.shownQuestionList.length){return true}pageView=SM.Views.create(SM.SummaryPageView,{model:pageModel});frag.appendChild(pageView.el)});this.$el.prepend(frag)},_onPageChange:function(e){var self=e.data.self;if(self.survey.questionRollups.isBuffered()){self.infiniteScroll.set("isActive",true)}else{self.infiniteScroll.set("isActive",false);self.survey.questionRollups.fetchMoreRollups()}self.render()},_onTryAgainClicked:function(e){var self=e.data.self;self.infiniteScroll.set("isActive",false);self.survey.questionRollups.fetchMoreRollups()},_onReachedEnd:function(e){if(!SM.App.isSharingApp()){e.data.self.survey.questionRollups.fetchMoreRollups()}},_onRollupsAppended:function(e){var self=e.data.self;if(!self.survey.questionRollups.hasAll()){self.infiniteScroll.set("isActive",true)}else{self.infiniteScroll.removeMarker();self.infiniteScroll.set("isActive",false)}}});SM.SummaryLazyLoadView=SM.Views.register({__NAME:"lazyLoadView",__model:"survey",__templateID:"lazy-load-template",__defaults:{lastFetchFailed:false},__init:function(){this.$el.on(SM.Event.CLICK,"[try-again-btn]",{self:this},this._onTryAgainClicked);this.bindModel(this.survey,"fetchRollupsFailed",{self:this},this._onFetchFail)},__beforeRender:function(){return{id:this.get("ID"),lastFetchFailed:this.__settings.lastFetchFailed}},_onFetchFail:function(e){var self=e.data.self;self.__settings.lastFetchFailed=true;self.render()},_onTryAgainClicked:function(e){var self=e.data.self;e.preventDefault();self.__settings.lastFetchFailed=false;self.$el.trigger("tryFetchMore");self.render()}});SM.SummaryPresentationContainerView=SM.Views.register({__NAME:"summaryPresentationContainerView",__templateID:"summary-presentation-question-template",randomAssignmentOption:null,__create:function(options){var self=this;self.question=options.question},__beforeRender:function(){var self=this,randomAssignmentOption=self.__settings.randomAssignmentOption,imagePresentation=this.question.subtype===this.question.QTYPE.image,textPresentation=this.question.subtype===this.question.QTYPE.descriptive_text,imageObject,text,imageSource,imageSourceLink;if(imagePresentation){if(!!randomAssignmentOption){imageObject=randomAssignmentOption.image;imageSource=imageObject.source}else{imageObject=this.image;imageSource=imageObject.source}if(imageObject.type==="upload"){imageSourceLink=this.question.survey.resourcePath+"/"+imageSource}else if(imageObject.type==="s3"){imageSourceLink=imageObject.url}else{imageSourceLink=imageSource}}else{if(!!randomAssignmentOption){text=randomAssignmentOption.heading}else{text=this.heading}}return{imagePresentation:imagePresentation,textPresentation:textPresentation,imageObject:imageObject,text:text,surveyID:this.question.survey.ID,imageSourceLink:imageSourceLink}}});SM.ProfilerDriverView=SM.Views.register({__NAME:"profilerDriverView",__model:"survey",__templateID:"profiler-driver-template",__beforeRender:function(){var isTMBCTemplate=this.survey.isTMBCTemplate(),validTMBCTemplate=this.survey.validateTMBCTemplate();return{isTMBC:isTMBCTemplate&&validTMBCTemplate}},__afterRender:function(){if(this.survey.isTMBCTemplate()){this.$el.find(".q").popout()}},__init:function(){this.$el.on(SM.Event.CLICK,"[complete-profile-btn]",{self:this},this._onCompleteProfileClick);this.survey.on("profiler:profile_saved",{self:this},this._onEntitySaved)},close:function(){this.$el.remove()},_onEntitySaved:function(e){var self=e.data.self;self.close()},_onCompleteProfileClick:function(e){var self=e.data.self,profilerDialog;e.stopPropagation();e.preventDefault();if(self.survey.isProfilerDialogEnabled()){profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:self.survey.profiler,type:self.survey.getTemplateType(),action_source:"top_driver_module",triggeredFrom:"top_driver_complete_profile_button"});profilerDialog.open()}}});SM.ProfilerDriverOverlayContentView=SM.Views.register({__NAME:"profilerDriverOverlayContentView",__templateID:"profiler-driver-overlay-content-template",__model:"profiler",__beforeRender:function(options){var survey=this.profiler.parent,isTMBC=survey.isTMBCTemplate(),isNPS=options.useNPS,toStore=survey.isStoreTemplate(),user_id=survey.currentUserID,templateName=survey.getTemplateName(),md={isNPS:isNPS,isGeneric:!isNPS,surveyId:survey.ID,toStore:toStore,isTMBC:isTMBC,user_id:user_id,useCB:options.useCB,"short":options.short};if(!!templateName){md.templateName="&qbcat="+templateName}return md},__afterRender:function(){this._$optInCB=this.$el.find(".cb input");this._$completeBtn=this.$el.find("[complete-profile=btn]");this._setOptIn(true)},__init:function(){this.$el.on(SM.Event.CLICK,"[complete-profile-btn]",{self:this},this._onCompleteProfileBtnClicked);this.$el.on(SM.Event.CLICK,".cb input",{self:this},this._onOptOutCBClicked);this.$el.on(SM.Event.CLICK,"[overlay-close-btn]",{self:this},this._onCloseBtnClicked);this.$el.on(SM.Event.CLICK,".benchmarkable-icon-ctnr",{self:this},this._onCloseBtnClicked);this.profiler.on(SM.Event.PROFILER_DIALOG_CLOSE,{self:this},this._onProfilerDialogClosed);this.profiler.on(SM.Event.PROFILER_STATE_CHANGED,{self:this},this._onProfilerStateChanged)},_onOptOutCBClicked:function(e){var self=e.data.self,isChecked=$(e.target).is(":checked");if(!isChecked){self.profiler.showOptOutDialog(self.$el,false)}},_setOptIn:function(optIn){if(optIn){this._$optInCB.prop("checked",true)}else{this._$optInCB.prop("checked",false)}},_onProfilerStateChanged:function(e){var self=e.data.self,state=e.state,owner=self.get("owner");if(state===self.profiler.PROFILER_STATE_OPT_IN){self._setOptIn(true)}else if(state===self.profiler.PROFILER_STATE_OPT_OUT){owner.close()}},_onCompleteProfileBtnClicked:function(e){var self=e.data.self,survey=self.profiler.parent,owner=self.get("owner"),profilerDialog,rq,onDone=function(){survey.dataSegmentList.enableAllBenchmarks(true)};e.stopPropagation();e.preventDefault();if(self.get("useCB")){owner.close();if(self._$optInCB.is(":checked")){rq=survey.profiler.setBenchmarkOptOut(false,false,"question_overlay_out_out_checkbox");if(rq){rq.done(onDone).fail(onDone)}else{onDone()}}}else{profilerDialog=SM.Views.create(SM.ProfilerDialogView,{model:survey.profiler,type:survey.getTemplateType(),action_source:"question",triggeredFrom:"question_benchmarking_button"});profilerDialog.open()}},_onCloseBtnClicked:function(e){var self=e.data.self,owner=self.get("owner");e.stopPropagation();e.preventDefault();owner.close()},_onProfilerDialogClosed:function(e){var self=e.data.self,owner=self.get("owner");if(!e.canceled){owner.close()}}});SM.ProfilerDriverOverlayView=SM.Views.register({__NAME:"profilerDriverOverlayView",__templateID:"profiler-driver-overlay-template",__model:"profiler",OVERLAY_SLIDE_TIME:1e3,OVERLAY_MIN_HT:360,__beforeRender:function(options){var md={},ht=options.$ctnr.height();if(ht<this.OVERLAY_MIN_HT){md.short=true;this._short=true}if(options.action_source==="tmbc"){this._useNPS=false}else{this._useNPS=options.type==="NPS"||options.owner.question.isNPS()}return md},__afterRender:function(){var $contentCtnr=this.$el.find("[profiler-overlay-content-ctnr]"),source="question",survey=this.profiler.parent,contentView=SM.Views.create(SM.ProfilerDriverOverlayContentView,{model:this.profiler,source:source,useCB:survey.hasValidEntity(),owner:this,useNPS:this._useNPS,$tgt:this.get("$tgt"),"short":this._short});$contentCtnr.append(contentView.$el)},open:function($ctnr){var ht,$tgt=this.get("$tgt"),owner=this.get("owner"),$aqCtnr=$ctnr;$ctnr=$ctnr.closest(".sm-questionview-content");if($ctnr.length===0){$ctnr=$aqCtnr}ht=$ctnr.height();this.$el.height(ht);this.$el.hide();this.profiler._trigger({type:"profilerOverlayBeforeOpen",owner:owner});this.profiler.parent._trigger({type:"suspendResumeScroll",suspend:true});this._$bmIcon=$tgt;this._$ctnr=$ctnr;this.__onBeforeOpen();this._open()},close:function(){var self=this,owner=this.get("owner"),$tgt=this.get("$tgt");self.__onBeforeClose();self.$el.slideUp(self.OVERLAY_SLIDE_TIME,function(){self._fadeOutComplete();owner._profilerOverlay=null;$tgt.removeClass("active");if(self.$el){self.$el.remove()}self.profiler.parent._trigger({type:"suspendResumeScroll",suspend:false});self.profiler._trigger({type:"profilerOverlayAfterClose",owner:owner})})},position:function(){var self=this,offset=self._$ctnr.offset();self.$el.css({left:offset.left,top:offset.top})},__onBeforeOpen:function(){var self=this;$(window).on(SM.Event.RESIZE+"."+self.__NAME+self.__uid,{self:self},self._onResize);self.subscribe(SM.Event.KEYDOWN,self._onOpenKeydown)},__onBeforeClose:function(){var self=this;$(window).off(SM.Event.RESIZE+"."+self.__NAME+self.__uid,self._onResize);this.unsubscribe(SM.Event.KEYDOWN,self._onOpenKeydown)},__onWindowResize:function(){this.position()},_open:function(){var self=this,container=SM.Template.renderHTML("profiler-overlay-container-template",{}),overlay=SM.Template.renderHTML("profiler-overlay-mask-template",{});var actualHt=$(".content-wrapper").height();self._$dialogContainer=$(container);self._$dialogContainer.height(actualHt);self._$dialogContainer.appendTo(document.body);self._$overlay=$(overlay);self._$overlay.height(actualHt);self._$overlay.appendTo(this._$dialogContainer);self._$overlay.on("click",{self:self},self._onOverlayClick);setTimeout(function(){self._fadeIn()},0)},_close:function(){var self=this;self._$overlay.removeClass("open");self.$el.removeClass("open");self.$el.addClass("close");self._isOpen=false;self._hasShownOnce=false;setTimeout(function(){self._fadeOutComplete()},100)},_fadeIn:function(){var self=this;self._$overlay.addClass("open");self.$el.addClass("open");self.$el.removeClass("close");self._isOpen=true;self._hasShownOnce=true;self._$overlay.append(this.$el);self.position();self.$el.slideDown(this.OVERLAY_SLIDE_TIME,function(){self._$bmIcon.addClass("active")})},_fadeOutComplete:function(){this._$overlay.off("click");this._$overlay.remove();this._$overlay=null;this.$el.detach();this.trigger("afterClose");this._$dialogContainer.remove();this._$dialogContainer=null},_onResize:function(e){var self=e.data.self;self.__onWindowResize(e)},_onOpenKeydown:function(e){var self=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){self.close();e.preventDefault()}},_onOverlayClick:function(e){e.data.self.close()}});SM.ProfilerDialogContentView=SM.Views.register({__NAME:"profilerDialogContentView",__model:"profiler",__templateID:"profiler-dialog-content-template",__beforeRender:function(){var survey=this.profiler.parent,md={needProfile:true,needOptIn:false,isNPS:survey.isNPSTemplate(),isGeneric:!survey.isNPSTemplate(),isTMBC:survey.isTMBCTemplate()};return md},__afterRender:function(){var $profilerHolder=this.$el.find(".profiler-placeholder"),checkboxText=Globalize.localize("I agree to anonymously contribute my Question Bank responses and "+"profile information to Benchmarks.");this.profilerView=this.profiler.createProfilerView(true,"#inline-profiler-dialog",this.get("dlg"));this.usingDisclaimer=!this.profiler.hasValidEntity()&&!this.profiler.user.benchmarkingHasOptOut;this.profilerView.$el.find("[profiler-opt-in-cb]").next(".label").text(checkboxText);$profilerHolder.append(this.profilerView.$el);this._enableDlgShowBtn(this.profiler.hasProfile());SM.Bi.benchmarkingProfilerDialogOpened(this.get("triggeredFrom"),this.get("source"))},__init:function(){this.profiler.on(SM.Event.PROFILER_ENTITY_INFO_CHANGED,{self:this},this._onEntityInfoUpdated);this.profiler.on(SM.Event.PROFILER_STATE_CHANGED,{self:this},this._onProfilerStateChanged)},_getOptIn:function(){return this.usingDisclaimer||this.profilerView._getOptIn()},_onEntityInfoUpdated:function(e){var self=e.data.self,optIn=self._getOptIn(),hasProfile=self.profiler.hasProfile();self._enableDlgShowBtn(optIn&&hasProfile)},_onProfilerStateChanged:function(e){var self=e.data.self,optIn=self._getOptIn(),hasProfile=self.profiler.hasProfile();if(e.state==="optIn"||e.state==="optOut"||e.state==="loaded"){self._enableDlgShowBtn(optIn&&hasProfile)}},_enableDlgShowBtn:function(enable){var $showBtn=this.$el.find(".show-benchmarks-btn");if(enable){$showBtn.removeClass("disabled")}else{$showBtn.addClass("disabled")}}});SM.ProfilerDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"profilerDialogView",__templateID:"inline-profiler-dialog-template",__model:"profiler",__defaults:{isModal:true,width:760,height:555,position:{my:"center",at:"center",collision:"none"},easyClose:true,closeBtn:true},__onBeforeOpen:function(){var $contentCtnr=this.$el.find("[profiler-content-ctnr]"),source="profilerDialog",contentView=SM.Views.create(SM.ProfilerDialogContentView,{model:this.profiler,type:this.__settings.type,dlg:this,source:this.get("action_source"),triggeredFrom:this.get("triggeredFrom")});$contentCtnr.append(contentView.$el);contentView.$el.on(SM.Event.CLICK,"[show-benchmarks-btn]",{self:this},this._onProfilerDialogShowBenchmarksClicked);SM.DialogView.__onBeforeOpen.call(this);this._oldSource=this.profiler.setSource(source);this._oldTriggeredFrom=this.profiler.setTriggeredFrom(this.get("triggeredFrom"));this._wasCanceled=true},__onAfterClose:function(){var self=this,uiTrigger,onSaveDone=function(){self.profiler.parent.triggerProfileSaved();self.profiler.parent.dataSegmentList.enableAllBenchmarks(true)};if(this._wasCanceled){if(!this.profiler.profileSaved){this.profiler.clearProfile()}uiTrigger="profiler_dialog_cancel_button"}else{this.profiler.setBenchmarkOptOut(false);this.profiler.save({done:onSaveDone});uiTrigger="profiler_dialog_see_benchmarks_button"}this.profiler._trigger({type:SM.Event.PROFILER_DIALOG_CLOSE,canceled:this._wasCanceled});SM.Bi.benchmarkingProfilerDialogClosed(uiTrigger,"profilerDialog",this._wasCanceled);this.profiler.setSource(this._oldSource);this.profiler.setTriggeredFrom(this._oldTriggeredFrom);$("<div>").append(this.$el).empty()},_onProfilerDialogShowBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target);e.stopPropagation();e.preventDefault();if(!$tgt.hasClass("disabled")){self._wasCanceled=false;self.close()}}});SM.ProfilerMarketingDialogContentView=SM.Views.register({__NAME:"profilerMarketingDialogContentView",__templateID:"profiler-marketing-dialog-content-template",__model:"profiler",__beforeRender:function(){var survey=this.profiler.parent,isTMBC=survey.isTMBCTemplate(),toStore=survey.isStoreTemplate(),user_id=survey.currentUserID,templateName=survey.getTemplateName(),md={isNPS:this.get("type")==="nps",isGeneric:this.get("type")!=="nps",surveyId:survey.ID,toStore:toStore,isTMBC:isTMBC,user_id:user_id};if(!!templateName){md.templateName="&qbcat="+templateName}return md}});SM.ProfilerMarketingDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"profilerMarketingDialogView",__templateID:"profiler-marketing-dialog-template",__model:"profiler",__defaults:{isModal:true,width:790,position:{my:"center",at:"center",collision:"none"},easyClose:true,closeBtn:true},__onBeforeOpen:function(){var $contentCtnr=this.$el.find("[profiler-marketing-content-ctnr]"),source="accordion",contentView=SM.Views.create(SM.ProfilerMarketingDialogContentView,{model:this.profiler,type:this.__settings.type,dlg:this,source:source,triggeredFrom:this.get("triggeredFrom")});$contentCtnr.append(contentView.$el);this.$el.on(SM.Event.CLICK,"[get-benchmarks-btn]",{self:this},this._onProfilerDialogGetBenchmarksClicked);SM.DialogView.__onBeforeOpen.call(this);SM.Bi.logProfilerMarketingDialog(this.get("triggeredFrom"),this.get("segmentName"))},__onAfterClose:function(){$("<div>").append(this.$el).empty()},_onProfilerDialogGetBenchmarksClicked:function(e){var self=e.data.self,$tgt=$(e.target),destination=$tgt.attr("destination"),source=self.get("triggeredFrom"),hasPaid=self.profiler.user.hasBenchmarkingRestricted(),isNPS=false,isTMBC=self.profiler.parent.isTMBCTemplate(),toStore=self.profiler.parent.isStoreTemplate(),questionId,requestDialog,onDone=function(){self.close();if(isTMBC){window.open(destination,"_blank")}else if(!toStore){requestDialog=SM.Views.create(SM.BenchmarkRequestDialogView,{model:self.profiler.parent,type:self.profiler.parent.getTemplateType(),triggeredFrom:"accordion"});requestDialog.open()}else{window.location.href=destination}};e.preventDefault();e.stopPropagation();if(source==="question"){questionId=self.question.ID;isNPS=self.question.isNPS()}else{isNPS=self.profiler.parent.isNPSTemplate()}SM.Bi.benchmarkingBuyMore(questionId,"interstitial_modal",source,destination,hasPaid,isNPS).done(onDone).fail(onDone);self.close()}});SM.SummaryQuizSummaryView=SM.Views.register({__NAME:"summaryQuizSummaryView",__templateID:"summary-quiz-summary-template",__model:"quizSummary",__create:function(options){var self=this;self.rollup=self.quizSummary.getRollup();self.display=self.rollup.display;self.isExport=options.isExport},__beforeRender:function(){var self=this,quizSummary=self.quizSummary,structure=quizSummary.structure,avg=structure.avg_score,survey=quizSummary.survey,currentUserID=survey.currentUserID,formatNumber=SM.String.formatNumber,viewedNumber,viewedPercentage,optionLetter;return{avgPercent:formatNumber(avg.score/avg.total,true),avgScore:formatNumber(avg.score,false,avg.total>20?0:1),avgTotal:formatNumber(avg.total),encryptedID:self.quizSummary.survey.encryptedID,userID:currentUserID,optionLetter:optionLetter+1,viewedPercentage:viewedPercentage,viewedNumber:formatNumber(viewedNumber),user_id:survey.currentUserID,surveyId:survey.ID}},__afterRender:function(){var self=this;self.$questionContent=self.$el.find("[quiz-summary-content]");self.chartContainerView=SM.Views.create(SM.SummaryQuizSummaryChartView,{survey:self.survey,quizSummary:self.quizSummary});self.$questionContent.append(self.chartContainerView.el);self.tableView=SM.Views.create(SM.SummaryQuizSummaryTableContainerView,{survey:self.survey,quizSummary:self.quizSummary,isExport:self.isExport});self.$questionContent.append(self.tableView.el);self.$el.find(".q").popout()},__init:function(){var self=this;self.$el.on("actionMenu.actionSelected",".sm-chart-container *",{self:self},self._onChartActionSelected);self.$el.on("actionMenu.actionSelected",".sm-data-table-container *",{self:self},self._onTableActionSelected)},_onChartActionSelected:function(e){var self=e.data.self,dialog,canCustomizeCharts=self.survey.owner.canCustomizeCharts();e.stopPropagation();if(e.action==="colors"&&!canCustomizeCharts){SM.Bi.uiTrigger="questionChartEditColorsMenuButton";dialog=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"customize-upgrade-dialog-template"});dialog.open()}else{SM.Bi.uiTrigger="questionChart"+e.action+"MenuButton";self.$el.trigger({type:"openCustomizeView",action:e.action})}},_onTableActionSelected:function(e){var self=e.data.self;if(e.action==="labels"){e.stopPropagation();self.$el.trigger({type:"openCustomizeView",action:e.action,answerID:e.$action.attr("data-answer-id")})}},getCurrentChartView:function(){var self=this;return self.chartContainerView.chartView}});SM.ProfilerAPI={Paths:{SET_CATEGORY:"/ajax/bm/set_category",GET_ENTITY_QUESTIONS:"/ajax/bm/get_entity_questions",GET_QUESTIONS_BY_ENTITY_TYPE:"/ajax/bm/get_questions_by_entity_type",GET_AUTOCOMPLETE_FOR_KEY:"/ajax/bm/get_autocomplete_for_key",STORE_ANSWERS:"/ajax/bm/store_answers",GET_ENTITY_INFO:"/ajax/bm/get_entity_info",BM_SET_BENCHMARK_OPT_OUT:"/ajax/bm/set_benchmark_opt_out",PROFILER_LOG:"/ajax/bm/profiler_log"},API:{hasProfilerAPI:true,noopRq:{done:function(f){},fail:function(f){}},profilerAPIinit:function(options){this.profilerParentId=options.profilerParentId;this.userId=options.userId;this.autoOptIn=options.autoOptIn||false;this.profilerSource=options.profilerSource},_profilerPost:function(key,data,options){data.parent_id=this.profilerParentId;data.user_id=this.userId;if(this.autoOptIn&&key==="GET_ENTITY_INFO"){data.auto_opt_in=this.autoOptIn;data.webapp=this.logOptions.webapp}return this.post(key,data,options)},setCategory:function(data,ajaxOptions){SM.log("setCategory("+data.category+")");return this._profilerPost("SET_CATEGORY",data,ajaxOptions)},fetchEntityQuestions:function(data,ajaxOptions){SM.log("fetchEntityQuestions("+data.entity_id+")");return this._profilerPost("GET_ENTITY_QUESTIONS",data,ajaxOptions)},fetchEntityTypeQuestions:function(data,ajaxOptions){SM.log("fetchEntityTypeQuestions("+data.entity_type+")");return this._profilerPost("GET_QUESTIONS_BY_ENTITY_TYPE",data,ajaxOptions)},fetchAutocompleteForKey:function(data,ajaxOptions){SM.log("fetchAutocompleteForKey("+data.key+", "+data.value+", "+data.timestamp+")");return this._profilerPost("GET_AUTOCOMPLETE_FOR_KEY",data,ajaxOptions)},storeAnswers:function(data,ajaxOptions){SM.log("storeAnswers()");return this._profilerPost("STORE_ANSWERS",data,ajaxOptions)},fetchEntityData:function(data,ajaxOptions){SM.log("fetchEntityData("+data.entity_id+")");return this._profilerPost("GET_ENTITY_INFO",data,ajaxOptions)},bmSetBenchmarkOptOut:function(data,ajaxOptions){SM.log("bmSetBenchmarkOptOut("+data.opt_out+")");return this._profilerPost("BM_SET_BENCHMARK_OPT_OUT",data,ajaxOptions)},profilerLogBi:function(actionType,uiTrigger,value,triggeredFrom,oldValue){var data={log_category:"benchmarking",action_type:actionType,ui_trigger:uiTrigger||"",profiler_source:this.profilerSource};if(actionType==="set_benchmark_opt_out"){data.opt_out=value;data.triggered_from=triggeredFrom}else{if(!!value){data.entity_id=value}if(!!oldValue){data.old_entity_id=oldValue}}return this.logBi(data)},logConfirmProfile:function(uiTrigger){return this.profilerLogBi("confirm_profile",uiTrigger)},logCancelProfile:function(uiTrigger){return this.profilerLogBi("cancel_profile",uiTrigger)},logAddProfile:function(uiTrigger,entityId,oldEntityId){return this.profilerLogBi("add_profile",uiTrigger,entityId,null,oldEntityId)},logRemoveProfile:function(uiTrigger,entityId){return this.profilerLogBi("remove_profile",uiTrigger,entityId)},logProfileStatus:function(status,uiTrigger,entityId,oldEntityId){if(status!=="no_change"&&status!=="update_error"){var actionType=status==="entity_added"?"add_profile":status==="entity_removed"?"remove_profile":status==="entity_changed"?"changed_profile":"profile_updated";return this.profilerLogBi(actionType,uiTrigger,entityId,null,oldEntityId)}return this.noopRq},logEntityStatus:function(status,uiTrigger,entityId){if(status!=="no_change"){var actionType=status==="entity_updated"?"edit_profile":"create_profile";return this.profilerLogBi(actionType,uiTrigger,entityId)}return this.noopRq},logCollectorStatus:function(status,uiTrigger,entityId){if(status!=="no_change"){var actionType=status==="entity_added"?"add_collector_profile":"remove_collector_profile";return this.profilerLogBi(actionType,uiTrigger,entityId)}return this.noopRq},logBenchmarkOptOut:function(optOut,uiTrigger,triggeredFrom){return this.profilerLogBi("set_benchmark_opt_out",uiTrigger,optOut,triggeredFrom)}}};SM.AutocompletePF=SM.Widgets.deepExtend(SM.Autocomplete,{__NAME:"autocompletepf",__init:function(options){SM.Autocomplete.__init.call(this);this.$el.off("keydown",SM.Autocomplete._onKeydown);this.$el.off("keyup",SM.Autocomplete._onKeyup);this.bind("keydown",this._onKeydown);this.bind("keyup",this._onKeyup)},_onKeydown:function(e){var self=e.data.self,kc=e.which;if(self.isOpen()){if(kc===SM.KeyCodes.DOWN){self._menu.nextCurrent();e.preventDefault();e.stopImmediatePropagation()}else if(kc===SM.KeyCodes.UP){self._menu.prevCurrent();e.preventDefault();e.stopImmediatePropagation()}else if(kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.NUMPAD_ENTER){if(!self._menu._$currentOption){var $tgt=$(e.target),value=$tgt.val(),item;e.text=value;if($tgt.prop("id")==="entity_location_all"){item={key:"location",location_text:value,city:"",state:"",zip:""}}else{item={key:"all",id:0}}e.value=JSON.stringify(item);self._onOptionSelected(e)}else{self._menu.selectCurrent();e.preventDefault()}}}},_onKeyup:function(e){var self=e.data.self,kc=e.which,currentInput;if(kc===SM.KeyCodes.DOWN||kc===SM.KeyCodes.UP||kc===SM.KeyCodes.ENTER||kc===SM.KeyCodes.ESCAPE){e.preventDefault();return}if(kc===SM.KeyCodes.SHIFT||kc===SM.KeyCodes.CTRL||kc===SM.KeyCodes.CAPS||kc===SM.KeyCodes.ALT||kc===SM.KeyCodes.HOME||kc===SM.KeyCodes.END||kc===SM.KeyCodes.LEFT||kc===SM.KeyCodes.RIGHT||kc===SM.KeyCodes.LEFT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.RIGHT_WINDOW||kc===SM.KeyCodes.SELECT){return
}if((e.ctrlKey||e.metaKey)&&kc===SM.KeyCodes.V){return}if(kc===SM.KeyCodes.BACKSPACE){if(!self._isOpen){currentInput=self._getInput();if(currentInput.length<=self.__settings.minLength){self.trigger("afterClose")}}}if(self.__settings.delay>0){self._debounceSearch()}else{self._pipeInput()}},__onFocusOutside:function(e){var self=e.data.self;self.trigger({type:"blur"});SM.BaseMenu.__onFocusOutside.call(self,e)},__onClickOutside:function(e){var self=e.data.self;self.trigger({type:"blur"});SM.BaseMenu.__onClickOutside.call(self,e)}});(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else if(typeof module==="object"&&module.exports){factory(require("jquery"))}else{factory(jQuery)}})(function($){var isOperaMini=Object.prototype.toString.call(window.operamini)==="[object OperaMini]";var isInputSupported="placeholder"in document.createElement("input")&&!isOperaMini;var isTextareaSupported="placeholder"in document.createElement("textarea")&&!isOperaMini;var valHooks=$.valHooks;var propHooks=$.propHooks;var hooks;var placeholder;var settings={};if(isInputSupported&&isTextareaSupported){placeholder=$.fn.placeholder=function(){return this};placeholder.input=true;placeholder.textarea=true}else{placeholder=$.fn.placeholder=function(options){var defaults={customClass:"placeholder"};settings=$.extend({},defaults,options);return this.filter((isInputSupported?"textarea":":input")+"[placeholder]").not("."+settings.customClass).bind({"focus.placeholder":clearPlaceholder,"blur.placeholder":setPlaceholder}).data("placeholder-enabled",true).trigger("blur.placeholder")};placeholder.input=isInputSupported;placeholder.textarea=isTextareaSupported;hooks={get:function(element){var $element=$(element);var $passwordInput=$element.data("placeholder-password");if($passwordInput){return $passwordInput[0].value}return $element.data("placeholder-enabled")&&$element.hasClass(settings.customClass)?"":element.value},set:function(element,value){var $element=$(element);var $replacement;var $passwordInput;if(value!==""){$replacement=$element.data("placeholder-textinput");$passwordInput=$element.data("placeholder-password");if($replacement){clearPlaceholder.call($replacement[0],true,value)||(element.value=value);$replacement[0].value=value}else if($passwordInput){clearPlaceholder.call(element,true,value)||($passwordInput[0].value=value);element.value=value}}if(!$element.data("placeholder-enabled")){element.value=value;return $element}if(value===""){element.value=value;if(element!=safeActiveElement()){setPlaceholder.call(element)}}else{if($element.hasClass(settings.customClass)){clearPlaceholder.call(element)}element.value=value}return $element}};if(!isInputSupported){valHooks.input=hooks;propHooks.value=hooks}if(!isTextareaSupported){valHooks.textarea=hooks;propHooks.value=hooks}$(function(){$(document).delegate("form","submit.placeholder",function(){var $inputs=$("."+settings.customClass,this).each(function(){clearPlaceholder.call(this,true,"")});setTimeout(function(){$inputs.each(setPlaceholder)},10)})});$(window).bind("beforeunload.placeholder",function(){$("."+settings.customClass).each(function(){this.value=""})})}function args(elem){var newAttrs={};var rinlinejQuery=/^jQuery\d+$/;$.each(elem.attributes,function(i,attr){if(attr.specified&&!rinlinejQuery.test(attr.name)){newAttrs[attr.name]=attr.value}});return newAttrs}function clearPlaceholder(event,value){var input=this;var $input=$(input);if(input.value===$input.attr("placeholder")&&$input.hasClass(settings.customClass)){input.value="";$input.removeClass(settings.customClass);if($input.data("placeholder-password")){$input=$input.hide().nextAll('input[type="password"]:first').show().attr("id",$input.removeAttr("id").data("placeholder-id"));if(event===true){$input[0].value=value;return value}$input.focus()}else{input==safeActiveElement()&&input.select()}}}function setPlaceholder(event){var $replacement;var input=this;var $input=$(input);var id=input.id;if(event&&event.type==="blur"){if($input.hasClass(settings.customClass)){return}if(input.type==="password"){$replacement=$input.prevAll('input[type="text"]:first');if($replacement.length>0&&$replacement.is(":visible")){return}}}if(input.value===""){if(input.type==="password"){if(!$input.data("placeholder-textinput")){try{$replacement=$input.clone().prop({type:"text"})}catch(e){$replacement=$("<input>").attr($.extend(args(this),{type:"text"}))}$replacement.removeAttr("name").data({"placeholder-enabled":true,"placeholder-password":$input,"placeholder-id":id}).bind("focus.placeholder",clearPlaceholder);$input.data({"placeholder-textinput":$replacement,"placeholder-id":id}).before($replacement)}input.value="";$input=$input.removeAttr("id").hide().prevAll('input[type="text"]:first').attr("id",$input.data("placeholder-id")).show()}else{var $passwordInput=$input.data("placeholder-password");if($passwordInput){$passwordInput[0].value="";$input.attr("id",$input.data("placeholder-id")).show().nextAll('input[type="password"]:last').hide().removeAttr("id")}}$input.addClass(settings.customClass);$input[0].value=$input.attr("placeholder")}else{$input.removeClass(settings.customClass)}}function safeActiveElement(){try{return document.activeElement}catch(exception){}}});SM.Models.register("ProfilerConfig",{__create:function(options){var self=this;this.ID="profiler_config";this.parent=options.parent;this.config=options.config||{}},isEntityOnly:function(){return this.config.entity_only},getSrcRef:function(){return this.config.srcref||""},getCmpId:function(){return this.config.cmp_id||""}});SM.Models.register("ProfilerUser",{__create:function(options){this.benchmarkingEnabled=options.benchmarking_enabled;this.benchmarkingRestrictedEnabled=options.benchmarking_restricted_enabled;this.benchmarkingHasOptOut=options.benchmarking_has_opt_out;this.benchmarkingOptOutWasSet=options.benchmarking_opt_out_was_set},hasBenchmarking:function(){return this.benchmarkingEnabled},hasBenchmarkingRestricted:function(){return this.benchmarkingRestrictedEnabled&&this.hasBenchmarking()},hasBenchmarkingOptOut:function(){return this.benchmarkingOptOutWasSet&&this.benchmarkingHasOptOut},canShowBenchmarking:function(){if(this.hasBenchmarkingRestricted()){return true}return this.hasBenchmarking()&&!this.hasBenchmarkingOptOut()}});SM.Models.register("Profile",{MAX_ERRLEN:400,__create:function(options){this.ID="profile";this.parent=options.parent;this._loadProfile(options.profile_data);SM.Event.PROFILER_USER_QUESTIONS_LOADED="profiler:userQuestionsLoaded";SM.Event.PROFILER_ANSWERS_SAVED="profiler:answersSaved"},_separateQuestions:function(questions){var user_questions=[],entity_questions=[],other_questions=[];$.each(questions,function(ix,question){if(question.profile_type==="user"){user_questions.push(question)}else if(question.profile_type==="entity"){entity_questions.push(question)}else{SM.API.logInfo({msg:"invalid question loaded"});other_questions.push(question)}});return{user:user_questions,entity:entity_questions,other:other_questions}},_loadProfile:function(profile_data){var question_sets=this._separateQuestions(profile_data.questions);this.category=profile_data.category;this.category_name=profile_data.category_name;this.sub_categories=profile_data.sub_categories;this.entity=SM.Models.create("Entity",{ID:"entity",parent:this,entity:profile_data.entity,questions:question_sets.entity})},setProp:function(propName,value){this[propName]=value},getEntity:function(){return this.entity},getQuestion:function(id){return this.questions[id]},getConfig:function(){return this.parent.config},fromRecapture:function(){return this.parent.fromRecapture()},getSrcRef:function(){return this.getConfig().getSrcRef()},getCmpId:function(){return this.getConfig().getCmpId()},currentCategory:function(){return this.category},currentCategoryData:function(){return this.parent.config.getCategoryData(this.category)},isValid:function(){return this.entity.isValid()},_loadQuestions:function(questionList,replace){this.questions.installQuestions(questionList,replace);this._trigger({type:SM.Event.PROFILER_USER_QUESTIONS_LOADED,questions:this.questions,replace:replace})},setCategory:function(category){var self=this;function onFetchDone(data){var question_sets=self._separateQuestions(data.questions);self.category_num=data.category_num;self._loadQuestions(question_sets.user,1);self.entity.loadQuestions(question_sets.entity,0,true)}function onFetchFail(err,msg,rs){if(SM.DEBUG){self.questions.addErrorQuestion(err,msg,rs,1)}}this.category=category;SM.API.setCategory({category:category,entity_id:this.entity.getEntityId(),srcref:this.getSrcRef(),cmp_id:this.getCmpId()}).done(onFetchDone).fail(onFetchFail)},logAnswerStatus:function(answerStatus,uiTrigger){SM.API.logProfileStatus(answerStatus.profile_status,uiTrigger,answerStatus.entity_id,answerStatus.old_entity_id);SM.API.logEntityStatus(answerStatus.entity_status,uiTrigger,answerStatus.entity_id);SM.API.logCollectorStatus(answerStatus.collector_status,uiTrigger,answerStatus.collector_entity_id)},getPropStdName:function(stdName){return"subcategories"},setProp:function(propName,value){this[propName]=value},collectAllAnswers:function(options){var self=this,answers,entityAnswers=this.entity.asAnswer(),source=this.parent.getSource(),triggeredFrom=this.parent.getTriggeredFrom(),uiTrigger;options=options||{};answers=options.answers,uiTrigger=options.uiTrigger?options.uiTrigger:triggeredFrom;function onStoreDone(data){self.logAnswerStatus(data.answer_status,uiTrigger);self.entity.markClean();if(data.answer_status.profile_status!=="entity_removed"){self.entity.setEntityId(data.answer_status.entity_id)}SM.log("Answer status:\n	profile_status: "+data.answer_status.profile_status+"\n"+"	entity_status: "+data.answer_status.entity_status+"\n","	entity_id: "+data.answer_status.entity_id+"\n","	collector_status: "+data.answer_status.collector_status);self.entity.saveBackup();if(options.done){options.done(data)}}function onStoreFail(err,msg,rs){if(options.fail){options.fail(err,msg,rs)}}if(answers||entityAnswers){answers=answers||[];if(entityAnswers){entityAnswers.collectors=this.parent.getCollectors();entityAnswers.update_user=this.parent.getSaveAsDefault();answers.push(entityAnswers)}SM.API.storeAnswers({answers:answers,source:source,triggeredFrom:triggeredFrom,collectors:this.parent.getCollectors(),update_user:this.parent.getSaveAsDefault()}).done(onStoreDone).fail(onStoreFail)}else if(options.done&&options.forceDone){options.done({})}}});SM.Models.register("Entity",{ENTITY_ID_INVALID:"verified.0",ENTITY_ID_SELF:"self",__create:function(options){this.ID=options.ID;this.parent=options.parent;this.entity=options.entity;if(!this.entity){this.entity={};this.clear()}if(this.entity.size<0){this.entity.size=0}this._initEvents();this._initQuestionModels();this._initQuestionViews();this.questions=SM.Models.create("EntityQuestionList",{type:"entity",parent:this,questions:this.entity.questions,event:SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED});this.entity.edited=false;this.saveBackup();this.acRefCt=0;this.acCt=0},_initEvents:function(){SM.Event.PROFILER_ENTITY_QUESTIONS_FETCHED="profiler:entityQuestionsFetched";SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED="profiler:entityQuestionsLoaded";SM.Event.PROFILER_ENTITY_INFO_UPDATED="profiler:entityInfoUpdated";SM.Event.PROFILER_ENTITY_TYPE_CHANGED="profiler:entityTypeChanged";SM.Event.PROFILER_ENTITY_NAME_DELETE="profiler:entityNameDelete";SM.Event.PROFILER_NAME_ERROR="profiler:entityNameError";SM.Event.PROFILER_AUTOCOMPLETE_AVAILABLE="profiler:autocompleteAvailable";SM.Event.PROFILER_DIALOG_CLOSE="profiler:profilerDialogClose"},_initQuestionModels:function(){var profiler=this.getProfiler();profiler.addQuestionModelsForProfileType("entity",{single_choice:{menu:"ProfilerMenuChoiceQuestion"},multiple_choice:{vertical:"ProfilerMultipleChoiceQuestion",vertical_two_col:"ProfilerMultipleChoiceQuestion"},open_ended:{single:"ProfilerQuestion",autocomplete:"ProfilerAutocompleteQuestion"},descriptive_text:{error:"ProfilerErrorQuestion"},all:{all:"ProfilerQuestion"}})},_initQuestionViews:function(){var profiler=this.getProfiler();profiler.addQuestionViewsForProfileType("entity",{single_choice:{menu:"ProfilerMenuQuestionView"},multiple_choice:{vertical:"ProfilerMultipleChoiceQuestionView",vertical_two_col:"ProfilerMultipleChoiceQuestionView"},open_ended:{single:"ProfilerBaseQuestionView",autocomplete:"ProfilerAutocompleteQuestionView"},all:{all:"ProfilerBaseQuestionView"}})},refAC:function(){this.acRefCt++;this.acCt++;SM.log("Entity.refAC -> refCt: "+this.acRefCt+", total: "+this.acCt);if(this.acRefCt>1){SM.log("  Multiple AC refs ("+this.acRefCt+")!")}return this.acCt},getACCt:function(){return this.acCt},derefAC:function(refId){this.acRefCt--;SM.log("Entity.derefAC("+refId+") -> refCt: "+this.acRefCt)},setViewState:function(isStatic,isClosed){this._isStatic=isStatic;this._isClosed=isClosed},isViewOpen:function(){return!this._isStatic&&!this._isClosed},getProfiler:function(){return this.parent.parent},setEntityView:function(entityView){this._entityView=entityView},getHeading:function(){var question=this.questions.getQuestionByIndex(0);if(question){return question.question.question_text}return""},getLabel:function(){var question=this.questions.getQuestionByIndex(0);if(question){return question.question.label_text}return""},getLocation:function(includeName){var location="";if(includeName){location+=this.entity.name}if(this.entity.entity_location_all!==""){if(location!==""){location+=", "}location+=this.entity.entity_location_all}else{if(this.entity.city!==""){if(location!==""){location+=", "}location+=this.entity.city}if(this.entity.state!==""){if(location!==""){location+=", "}location+=this.entity.state}if(this.entity.zip!==""){if(location!==""){location+=" "}location+=this.entity.zip}}return location},getFullLocation:function(includeName){var location="";if(includeName){location+=this.entity.name+"\n"}if(this.entity.address1&&this.entity.address1!==""){location+=this.entity.address1;if(this.entity.address2&&this.entity.address2!==""){location+="\n"+this.entity.address2}if(this.entity.address3&&this.entity.address3!==""){location+="\n"+this.entity.address3}}if(location!==""){location+="\n"}location+=this.getLocation(false)},formatName:function(text){var location="";if(!text){text=""}if(text===""||text.search(this.entity.zip)===-1){if(text!==""){location+=", "}location+=this.getLocation()}return text+location},formatSize:function(useCanonical){SM.log("formatSize???");return""},setSource:function(source){this.source=source},getSource:function(){return this.source||"unknown"},getEntityId:function(){return this.entity.entity_id||this.ENTITY_ID_INVALID},setEntityId:function(id){this.entity.entity_id=id},clearEntityId:function(){this.entity.entity_id=this.ENTITY_ID_INVALID},getSavedEntityId:function(){return this._savedEntity.entity_id},getEntityType:function(){if(this.entityTypeOverride){return this.entityTypeOverride}return this.entity.entity_type},setEntityType:function(typeVal){if(typeof typeVal!=="undefined"){if(this.entity.entity_type!==typeVal){this.entity.entity_type=typeVal;this.entity.edited=true}}},getName:function(){return this.entity.name},setName:function(name){if(this.entity.name!==name){this.entity.name=name;this.entity.edited=true}},getIndustry:function(){return this.entity.entity_industry},getPropStdName:function(propName){if(propName==="entity_name_organization"||propName==="entity_name_company"||propName==="entity_name_nonprofit"||propName==="entity_name_healthcare"||propName==="entity_name_education"){propName="name"}return propName},getProp:function(propName){propName=this.getPropStdName(propName);if(propName in this.entity){if(propName==="entity_type"){return this.getEntityType()}if(propName==="size"){SM.log("getProp(size) ???");return this.getSize()}if(propName==="entity_location_all"){return this.getLocation()}return this.entity[propName]}return""},setProp:function(propName,value){if(propName==="entity_type"){this.setEntityType(value)}else if(propName==="size"){SM.log("setProp(size) ???")}else if(propName==="entity_location_all"){this.setLocation(value)}else{if(this.entity[propName]!==value){this.entity[propName]=value;this.entity.edited=true}}},setIndustry:function(industryVal){if(typeof industryVal!=="undefined"&&!(typeof this.entity.entity_industry==="undefined"&&industryVal==="")||typeof industryVal==="undefined"&&this.entity.entity_industry!==""){if(this.entity.entity_industry!==industryVal){this.entity.entity_industry=industryVal;this.entity.edited=true}}},getSize:function(){SM.log("getSize()???");return""},setSize:function(sizeVal){SM.log("setSize()???")},setLocation:function(locVal,data){if(this.entity.entity_location_all!==locVal){this.entity.entity_location_all=locVal;if(data){this.entity.city=data.city;this.entity.state=data.state;this.entity.zip=data.zip;this.entity.country=data.country}else{this.entity.city="";this.entity.state="";this.entity.zip="";this.entity.country=""}this.entity.edited=true}},hasQuestions:function(){return!this.questions.isEmpty()},getQuestion:function(id){return this.questions.findById(id)},loadQuestions:function(questionList,replace,makeStatic,onFetch,entityTypeOverride){var event=onFetch?SM.Event.PROFILER_ENTITY_QUESTIONS_FETCHED:SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED;this.questions.installQuestions(questionList,replace);this.entityTypeOverride=entityTypeOverride;this._trigger({type:event,questions:this.questions,replace:replace,makeStatic:makeStatic});this.parent.parent.triggerEntityChanged();if(!makeStatic){this.parent.parent.triggerStateChanged("loaded")}},fetchEntityData:function(entity_id,name,saveProfile){var self=this,profiler=this.parent.parent;function onFetchDone(data){self.entity=data.entity_data;self.entityTypeOverride=undefined;self.saveBackup();self.questions.installQuestions(data.questions,0);if(saveProfile){self.parent.logAnswerStatus(data.answer_status,"fetchEntity")}self._trigger({type:SM.Event.PROFILER_ENTITY_INFO_UPDATED,entity:self,isStatic:true});self.parent.parent.triggerEntityChanged();if(saveProfile){self.parent.parent.triggerEntitySaved(true)}}function onFetchFail(err,msg,rs){self.entity.name=name;self.questions.addErrorQuestion(err,msg,rs,1);self._trigger({type:SM.Event.PROFILER_ENTITY_INFO_UPDATED,entity:self,isStatic:true});self.parent.parent.triggerEntityChanged();if(saveProfile){self.parent.parent.triggerEntitySaved(false)}}source=this.getSource();SM.API.fetchEntityData({entity_id:entity_id,name:name,save_profile:saveProfile,update_user:profiler.getSaveAsDefault(),collectors:profiler.getCollectors(),source:profiler.getSource(),triggeredFrom:profiler.getTriggeredFrom()}).done(onFetchDone).fail(onFetchFail)},fetchEntityQuestions:function(entityId){var self=this,profiler=this.parent.parent;function onFetchDone(data){self.loadQuestions(data.questions,0,false,true)}function onFetchFail(err,msg,rs){if(SM.DEBUG){self.questions.addErrorQuestion(err,msg,rs,3)}}SM.API.fetchEntityQuestions({entity_id:entityId,collectors:profiler.getCollectors()}).done(onFetchDone).fail(onFetchFail)},fetchEntityTypeQuestions:function(entityType,makeStatic){var self=this,profiler=this.parent.parent;function onFetchDone(data){self.loadQuestions(data.questions,0,makeStatic,true,entityType)}function onFetchFail(err,msg,rs){if(SM.DEBUG){self.questions.addErrorQuestion(err,msg,rs,3)}}SM.API.fetchEntityTypeQuestions({entity_type:entityType,collectors:profiler.getCollectors()}).done(onFetchDone).fail(onFetchFail)},setEntityValue:function(name,id,source){var entityType=this.entity.entity_type;if(id===0){if(name!==""){this.setName(name);if(this._entityView){this._entityView._saveData();entityType=this._entityView.getSavedEntityType()}if(entityType===""){this.fetchEntityQuestions(id)}else if(entityType!==this.entity.entity_type){this.fetchEntityTypeQuestions(entityType,false)}else{this.fetchEntityTypeQuestions(entityType,false)}}else{this.clear();this.entityTypeOverride=undefined;this.parent.parent.triggerEntityChanged()}}else{this.setSource(source);this.fetchEntityData(id,name,true)}},asAnswer:function(){var answers=this.questions.collectAllAnswers(),entity;if(answers){entity=$.extend({},this.entity);delete entity.questions;delete entity.list_type;return{answer_type:"entity",entity:entity}}},isValid:function(){var entity_id=this.getEntityId();return entity_id!==0&&entity_id!==this.ENTITY_ID_INVALID&&entity_id!==this.ENTITY_ID_SELF||this.getName()!==""},isNew:function(){var entity_id=this.getEntityId();return(entity_id===0||entity_id===this.ENTITY_ID_INVALID||entity_id===this.ENTITY_ID_SELF)&&this.getName()!==""},isVerified:function(){var entity_id=this.getEntityId();if(this.isValid()){if(typeof entity_id==="number"){return true}if(entity_id!==this.ENTITY_ID_INVALID&&entity_id.search("unverified")===-1){return true}}return false},isEmpty:function(){var key;for(key in this.entity){if(key==="entity_id"||key==="edited"||key==="list_type"||key==="user_id"||key==="questions"||key==="date_created"||key==="date_modified"){continue}if(this.entity[key]===undefined||this.entity[key]===null){continue}if(key==="size"){SM.log("Entity data for entity id "+this.entity.entity_id+" has size parameter!");if(this.entity.size!==0&&this.entity.size!==""){return false}}else if(key==="entity_grades"){if(this.entity.entity_grades.length!==0){return false}}else if(this.entity[key]!==""){return false}}return true},markDirty:function(){this.entity.edited=true},markClean:function(){this.entity.edited=false},isEdited:function(){return this.entity.edited},clear:function(){var key;for(key in this.entity){if(key==="entity_id"){this.entity.entity_id=this.ENTITY_ID_INVALID}else if(key==="edited"){this.entity.edited=true}else if(key==="size"){SM.log("Entity data for entity id "+this.entity.entity_id+" has size parameter!");delete this.entity["size"]}else{this.entity[key]=""}}},saveBackup:function(){this._savedEntity=$.extend({},this.entity)},restoreBackup:function(){this.entity=$.extend({},this._savedEntity)}});SM.Models.register("Profiler",{MAX_ERRLEN:400,PROFILER_STATE_CANCEL:"cancel",PROFILER_STATE_LOADED:"loaded",PROFILER_STATE_OPT_IN:"optIn",PROFILER_STATE_OPT_OUT:"optOut",__create:function(options){var userId;this.ID="profiler";this.parent=options.parent;if(options.config){this.config=options.config}else{this.config=SM.Models.create("ProfilerConfig",{parent:this,config:{entity_only:true}})}this.parentId=options.parent?options.parent.ID:0;this.webapp=options.webapp||options.source||"unknown";if(options.user){this.user=options.user;userId=options.profiler_data.data.user.user_id}else{this.user=SM.Models.create("ProfilerUser",options)}this.source=options.source||options.webapp;this.showHeading=options.showHeading;this.disableOrgAC=options.disableOrgAC;this.showDefaultCB=options.showDefaultCB;this.showOptInCB=options.showOptInCB;this.disableAccordion=options.disableAccordion;this.autoOptIn=options.autoOptIn;this.showQuestionText=options.showQuestionText;this.hasCollectorProfile=options.hasCollectorProfile||false;this._initConstants(options);this._initEvents();if(!SM.API.hasProfilerAPI){SM.API.extend(options.basePath,SM.ProfilerAPI);SM.API.profilerAPIinit({profilerParentId:options.parentId,userId:userId,autoOptIn:this.autoOptIn,profilerSource:this.source})}if(!options.profiler_data||options.profiler_data.status!==0){this._profiler_data={profile:{category:"",sub_categories:[],questions:[],entity:{questions:[]}},config:{entity_only:false},user:{}}}else{this._profiler_data=options.profiler_data.data}this.profile=SM.Models.create("Profile",{parent:this,profile_data:this._profiler_data.profile});this.config=SM.Models.create("ProfilerConfig",{parent:this,config_data:this._profiler_data.config});this.profileSaved=this.profile.isValid()||this.hasCollectorProfile;this.setSaveAsDefault(!options.showDefaultCB||!this.profileSaved&&!this.hasDefaultProfile())},_initConstants:function(data){SM.DEFAULT_SRCREF="getstarted";SM.DESTINATIONS={getstarted:"/",home:"/home/",myaccount:"/user/account",recapture:"/",directtopro:"/"};SM.ENTITY_ID_INVALID="verified.0";SM.PROFILER_QUESTION_MODELS={"default":{all:{all:"ProfilerQuestion"}}};SM.PROFILER_QUESTION_VIEWS={"default":{all:{all:"ProfilerBaseQuestionView"}}}},getQuestionModelsByProfileType:function(profileType){var questionModels=SM.PROFILER_QUESTION_MODELS[profileType];if(!questionModels){return SM.PROFILER_QUESTION_MODELS["default"]}return questionModels},addQuestionModelsForProfileType:function(profileType,questionModels){if(profileType in SM.PROFILER_QUESTION_MODELS){SM.log("WARNING: overwriting question models for profile type "+profileType)}SM.PROFILER_QUESTION_MODELS[profileType]=questionModels},getQuestionViewsByProfileType:function(profileType){var questionViews=SM.PROFILER_QUESTION_VIEWS[profileType];if(!questionViews){return SM.PROFILER_QUESTION_VIEWS["default"]}return questionViews},addQuestionViewsForProfileType:function(profileType,questionViews){if(profileType in SM.PROFILER_QUESTION_VIEWS){SM.log("WARNING: overwriting question views for profile type "+profileType)}SM.PROFILER_QUESTION_VIEWS[profileType]=questionViews},_initEvents:function(){SM.Event.PROFILER_ENTITY_INFO_CHANGED="profiler:entityInfoChanged";SM.Event.PROFILER_OPT_IN_CHANGED="profiler:optInChanged";SM.Event.PROFILER_ENTITY_SAVED="profiler:entitySaved";SM.Event.PROFILER_STATE_CHANGED="profiler:stateChanged"},_closeDataSegmentList:function(){var $accordion=$(".analyze-secondary-column.accordion"),accordion=$accordion.accordion().data("accordion");if(accordion){accordion.close("DataSegmentBuilderViewContainer")}},createProfilerView:function(openIfInvalid,ownerId,dlg){this.profilerView=SM.Views.create(SM.ProfilerView,{model:this,ownerId:ownerId,dlg:dlg,showHeading:this.showHeading,disableOrgAC:this.disableOrgAC,source:this.source,showDefaultCB:this.showDefaultCB,showOptInCB:this.showOptInCB,disableAccordion:this.disableAccordion,showQuestionText:this.showQuestionText,openIfInvalid:openIfInvalid||false});return this.profilerView},getBenchmarkOptIn:function(){return!this.user.benchmarkingOptOutWasSet||!this.user.benchmarkingHasOptOut},setBenchmarkOptOut:function(optOut,reset,uiTrigger){var value=optOut?1:0,source=this.getSource(),triggeredFrom=this.getTriggeredFrom(),rq;var onDone=function(data){SM.API.logBenchmarkOptOut(optOut,uiTrigger,triggeredFrom)};var onFail=function(msg,err,rq){SM.API.logError({errName:"Benchmark Opt Out failed",message:msg})};uiTrigger=uiTrigger||"benchmark_opt_out_checkbox";if(this.user.benchmarkingHasOptOut!==optOut){rq=SM.API.bmSetBenchmarkOptOut({opt_out:value,source:source,triggeredFrom:triggeredFrom}).done(onDone).fail(onFail);this.user.benchmarkingHasOptOut=optOut}if(optOut){this._closeDataSegmentList();this.triggerStateChanged("optOut")}return rq},getProfile:function(){return this.profile},getEntity:function(){return this.profile.getEntity()},getEntityType:function(){return this.profile.getEntity().getEntityType()},getEntityTypeQuestion:function(){return this.getQuestion(this.getEntityType())},getQuestion:function(id){return this.getEntity().getQuestion(id)},getAnswerText:function(questionId,optionId){var question=this.getQuestion(questionId),text="";if(question){text=question.findAnswerText(optionId)}return text},getQuestionAttributes:function(questionId,attributeClass){var question=this.getQuestion(questionId),attributes={};if(question){attributes=question.getAttributes(attributeClass)}return attributes},getQuestionAttribute:function(questionId,attributeClass,attribute){return this.getQuestionAttributes(questionId,attributeClass)[attribute]},hasValidEntity:function(){return this.profile.entity.isValid()},getHeading:function(collapsed){var md={collapsed:collapsed},entity=this.profile.entity;if(collapsed){if(entity.isValid()){md.heading=entity.getLabel()+": ";md.text=entity.getLocation(true)}else{md.heading=entity.getHeading();md.text=""}}else{if(entity.isValid()){md.heading=entity.getLabel();md.text=""}else{md.heading=entity.getHeading();md.text=""}}return md},getQuestionText:function(){return this.profile.entity.getHeading()},getCollectors:function(){return this._profiler_data.profile.collectors},hasDefaultProfile:function(){return this._profiler_data.profile.has_default_profile},getSaveAsDefault:function(){return this._saveAsDefault},setSaveAsDefault:function(saveAsDefault){this._saveAsDefault=saveAsDefault},shouldShowProfiler:function(){if(this.user.hasBenchmarkingRestricted()){return false}return!this.user.benchmarkingOptOutWasSet||!this.profile.entity.isValid()&&!this.user.benchmarkingHasOptOut},resetProfiler:function(){function onDone(data){window.location.reload()}this.setBenchmarkOptOut(false,true);this.clearProfile();this.save({done:onDone,forceDone:true})},clearProfile:function(){this.profile.entity.setEntityValue("",0)},hasProfile:function(){return this.profile.entity.isValid()},triggerEntityChanged:function(){this._trigger({type:SM.Event.PROFILER_ENTITY_INFO_CHANGED,entity:this.profile.entity})},triggerEntitySaved:function(succeeded){this._trigger({type:SM.Event.PROFILER_ENTITY_SAVED,succeeded:succeeded})},triggerStateChanged:function(stateNew){this._trigger({type:SM.Event.PROFILER_STATE_CHANGED,state:stateNew})},save:function(options){this.profile.collectAllAnswers(options)},setSource:function(source){var oldSource=this.source;this.source=source;return oldSource},getSource:function(){return this.source||"unknown"},setTriggeredFrom:function(trigger){var oldTrigger=this.trigger;this.trigger=trigger;return oldTrigger},getTriggeredFrom:function(){return this.trigger||this.getSource()},fromRecapture:function(){if("fromRecapture"in this.parent){return this.parent.fromRecapture()}return false},_onOptOutBtnClicked:function(e){var self=e.data.self;e.stopPropagation();e.preventDefault();self._wasCanceled=false;self._optOutDialog.close();delete self._optOutDialog},showOptOutDialog:function($owner,hideOwner){var self=this;if(hideOwner){$owner.hide()}self._optOutDialog=SM.Views.create(SM.DialogView,{width:550,isModal:true,templateID:"benchmarking-opt-out-dialog-template"});self._optOutDialog.$el.on(SM.Event.CLICK,"[bm-opt-out-btn]",{self:self},self._onOptOutBtnClicked);self._optOutDialog.$el.on("dialog.afterClose",function(){if(self._wasCanceled){self.triggerStateChanged(self.PROFILER_STATE_OPT_IN);if(hideOwner){$owner.show()}}else{self.setBenchmarkOptOut(true)}});self._wasCanceled=true;self._optOutDialog.open()}});SM.ProfilerQuestion={_create:function(options){this.ID=options.ID;this.parent=options.parent;this.question=options.question;this.isRootQuestion=this.question.is_root_question;if(this.question.profile_type==="entity"){this.answer={answer_type:"entity",entity:options.entity}}else{this.answer={answer_type:"unknown"}}},__create:function(options){this._create(options)},getProfiler:function(){return this.parent.getProfiler()},getProfile:function(){return this.getProfiler().getProfile()},getFamily:function(){return this.question.type.family},getSubtype:function(){return this.question.type.subtype},getQuestionId:function(){return this.question.question_id},getStdName:function(){var stdName=this.getQuestionId();if(this.isEntityQuestion()){stdName=this.answer.entity.getPropStdName(stdName)}else if(this.isUserQuestion()){stdName=this.getProfile().getPropStdName(stdName)}return stdName},getProfileType:function(){return this.question.profile_type},isEntityQuestion:function(){return this.getProfileType()==="entity"},isUserQuestion:function(){return this.getProfileType()==="user"},getAttributes:function(attributeClass){var attrs=this.question.attributes||{};if(attributeClass){return attrs[attributeClass]||{}}return attrs},getAnswerData:function(){return this.question.answer_data},getAnswerType:function(){return this.answer.answer_type},getLabel:function(){return this.question.label_text},getQuestionText:function(){return this.question.question_text},getPlaceholder:function(){return this.question.placeholder},getEntity:function(){return this.answer.entity},getAnswers:function(){return this.question.answers.rows
},ctAnswers:function(){return this.question.answers.rows.length},eachAnswer:function(f){_.each(this.question.answers.rows,f)},findAnswer:function(p){return _.find(this.question.answers.rows,p)},getAutocomplete:function(p){return""},_findAnswerTextForCanonicalValue:function(canonicalValue){answer=this.findAnswer(function(answer){if(answer.name===canonicalValue){return true}});return answer?answer.option_text:""},findAnswerText:function(canonicalValue){var self=this,value="";if(canonicalValue===undefined||canonicalValue===null){return""}if(typeof canonicalValue==="string"){return this._findAnswerTextForCanonicalValue(canonicalValue)}_.each(canonicalValue,function(thisValue,i){var text=self._findAnswerTextForCanonicalValue(thisValue);if(i>0){value+=", "}value+=text});return value},collectAnswers:function(){return this.answer}};SM.Models.register("ProfilerQuestion",SM.ProfilerQuestion);SM.Models.extend("ProfilerAutocompleteQuestion",SM.ProfilerQuestion,{__create:function(options){this._create(options);this.LOCATION_KEY="location";this.NONE_KEY="none";this.LOCATION_ID="entity_location_all";this._lastResponseTime=0},generateAutocompleteResults:function(term,source){var self=this,timestamp=(new Date).getTime();function onFetchDone(data){var resultList=[],key,item;if(data.timestamp>=self._lastResponseTime){SM.log("  -> Received AC with timestamp "+data.timestamp+" >= "+self._lastResponseTime);self._lastResponseTime=data.timestamp;key=self.question.autocomplete;if(key===self.LOCATION_KEY){if(data.matches.length>0){_.each(data.matches,function(item,i){var text=item.location_text,value;item.key=key;value=JSON.stringify(item);resultList.push({text:text,value:value})})}else{item={key:key,location_text:term,city:"",state:"",zip:"",country:""};resultList.push({text:term,value:JSON.stringify(item)})}}else{if(data.matches.length>0){_.each(data.matches,function(item,i){var text=item.name+", "+item.city+", "+item.state+" "+item.zip,value;item.key=key;value=JSON.stringify(item);resultList.push({text:text,value:value,type:item.type})});var resultListNew=[];$.each(resultList,function(i,thisResult){var resultNew=$.extend({},thisResult);$.each(resultList,function(j,thatResult){if(i!==j){if(thisResult.text===thatResult.text){resultNew.text=thisResult.text+" ("+thisResult.type+")";return false}}});resultListNew.push(resultNew)});resultList=resultListNew}else{item={key:key,id:0};resultList.push({text:term,value:JSON.stringify(item)})}}self._trigger({type:SM.Event.PROFILER_AUTOCOMPLETE_AVAILABLE,key:key,resultList:resultList,source:source})}else{SM.log("  -> Ignoring AC with timestamp "+data.timestamp+" < "+self._lastResponseTime)}}function onFetchFail(err,msg,rs){var data={timestamp:self._lastResponseTime,matches:[]};SM.log("Error "+err.status+": "+msg+" occurred in autocomplete result.");onFetchDone(data)}SM.API.fetchAutocompleteForKey({key:this.question.autocomplete,value:term,timestamp:timestamp}).done(onFetchDone).fail(onFetchFail)},getKey:function(){return this.question.autocomplete},getAutocomplete:function(p){return this.question.autocomplete},isLocationQuestion:function(){return this.question.question_id===this.LOCATION_ID},getPlaceholder:function(){var profile=this.parent.parent.parent;if(!this.question.intl_placeholder){return this.question.placeholder}return this.question.intl_placeholder},getAnswerText:function(){if(this.isLocationQuestion()){return this.answer.entity.getLocation()}return this.answer.entity.formatName(this.answer.entity.entity.name)},setAnswer:function(text,value,source){text=SM.Html.strip(text,true);if(this.isLocationQuestion()){this.answer.entity.setLocation(value)}else{this.answer.entity.setEntityValue(text,value,source)}}});SM.Models.extend("ProfilerMultipleChoiceQuestion",SM.ProfilerQuestion,{__create:function(options){this._create(options)},setChoice:function(answerId,set){var qid=this.question.question_id;if(this.answer.answer_type==="subcategory"){SM.Array.removeItem(this.answer.subcategories,answerId);if(set){this.answer.subcategories.push(answerId)}}else if(this.answer.answer_type==="entity"){if(!(qid in this.answer.entity)){this.answer.entity[qid]=[]}SM.Array.removeItem(this.answer.entity[qid],answerId);if(set){this.answer.entity[qid].push(answerId)}}}});SM.Models.extend("ProfilerMenuChoiceQuestion",SM.ProfilerQuestion,{__create:function(options){this._create(options)},setChoice:function(answerId,set){var qid=this.question.question_id;if(this.answer.answer_type==="subcategory"){SM.Array.removeItem(this.answer.subcategories,answerId);if(set){this.answer.subcategories.push(answerId)}}else if(this.answer.answer_type==="entity"){if(!(qid in this.answer.entity)){this.answer.entity[qid]=[]}SM.Array.removeItem(this.answer.entity[qid],answerId);if(set){this.answer.entity[qid].push(answerId)}}}});SM.Models.extend("ProfilerErrorQuestion",SM.ProfilerQuestion,{__create:function(options){this._create(options);this.question.heading=options.question.heading;this.question.html=options.question.html;this.isRootQuestion=false;this.answer={answer_type:"error",error:{error_code:500,error_message:"This is VERY VERY BAD!"}}},_errorTemplate:{answers:{rows:[]},heading:"Error: no such question",html:'<li class="question"><div class="error"><div class="question-text">An error occurred</div></div></li>',id:"error",autocomplete:"",type:{family:"descriptive_text",subtype:"error"},profile_type:"error",question_id:"error"}});SM.ProfilerQuestionList={init:function(type,options){this.AT_END=-1;this.ID="profilerQuestionList:"+type;this.type=type;this.parent=options.parent;this.event=options.event;this.list=[];this.map={};this.map_by_category={};this._loadQuestions(options.questions);this._initErrorQuestion()},getProfiler:function(){var parent=this.parent;while(parent&&parent.ID!=="profiler"){parent=parent.parent}return parent},getProfile:function(){var profiler=this.getProfiler();if(profiler){return profiler.getProfile()}},getEntity:function(){var profile=this.getProfile();if(profile){return profile.getEntity()}},_makeQuestion:function(question,options){var profiler=this.getProfiler(),profileType=question.profile_type,family=question.type.family,subtype=question.type.subtype,questionModels=profiler.getQuestionModelsByProfileType(profileType);if(question.autocomplete&&question.autocomplete!==""){subtype="autocomplete"}if(!(family in questionModels)){family="all"}if(!(subtype in questionModels[family])){family="all";subtype="all"}if(profileType==="entity"){options.entity=this.parent}return SM.Models.create(questionModels[family][subtype],options)},_initErrorQuestion:function(){this._errorQuestion={heading:"Unknown Error",autocomplete:"",type:{family:"descriptive_text",subtype:"error"}}},addErrorQuestion:function(err,msg,rs,index){var errMsg=SM.Error.makeErrorMessage(err,msg,rs);this._errorQuestion.heading=errMsg;this._errorQuestion.html=SM.Template.render("profiler-question-error-template",{error:errMsg});this.installQuestions([this._errorQuestion],this.AT_END);SM.PubSub.publish({type:this.event,questions:this,replace:this.AT_END})},shouldIgnore:function(question){return false},_loadQuestions:function(questions){var self=this,category=this.parent.category;$.each(questions,function(id,question){if(self.shouldIgnore(question)){return true}var qModel=self.map[question.question_id];if(qModel){if(self.findById(question.question_id)){return true}}else{qModel=self._makeQuestion(question,{ID:"question:"+question.question_id,parent:self,question:question});self.map[question.question_id]=qModel}self.list.push(qModel)})},installQuestions:function(questionList,replace){if(replace>=0){this.replace(questionList,replace)}else{replace=this.list.length;this.append(questionList)}},reinstallQuestions:function(modelList,replace){if(replace>0){this.list=this.list.slice(0,replace).concat(modelList)}else{this.list=modelList}},isEntityQuestionList:function(){return false},isUserQuestionList:function(){return false},isEmpty:function(){return this.list.length===0},each:function(func){$.each(this.list,func)},append:function(questionList){this._loadQuestions(questionList)},clear:function(){this.list=[];this.map={}},findById:function(question_id){var found=null;this.each(function(ix,question){if(question.question.question_id===question_id){found=question;return false}});return found},getQuestionByIndex:function(index){if(index<this.list.length){return this.list[index]}},replace:function(questionList,from){this.list=this.list.slice(0,from);this._loadQuestions(questionList)},getQuestion:function(id){return this.map[id]},getQuestionsByCategory:function(category){return this.map_by_category[category]},setView:function(view){this._questionListView=view},collectAllAnswers:function(){var answers=[];this.each(function(i,question){answers.push(question.collectAnswers())});return answers}};SM.Models.extend("EntityQuestionList",SM.ProfilerQuestionList,{__create:function(options){this.init("entity",options)},isEntityQuestionList:function(){return true},collectAllAnswers:function(){var entity=this.getEntity();if(!this._questionListView){SM.API.logWarning({error:"No question list view",message:"could not collect data without a question list view"});return}if(entity&&entity.isViewOpen()){this._questionListView.collectData();if(entity.isEmpty()){entity.clear()}if(!entity.isEmpty()&&entity.getName()===""){entity._trigger({type:SM.Event.PROFILER_NAME_ERROR});return}}return SM.ProfilerQuestionList.collectAllAnswers.call(this)}});SM.ProfileQuestionCtnrView=SM.Views.register({__NAME:"profileQuestionCtnrView",__model:"profile",__templateID:"profiler-question-ctnr-template",__create:function(){SM.log("QuestionCtnrView.__create()")},__destroy:function(){SM.log("QuestionCtnrView.__destroy()");this.profile.off(SM.Event.PROFILER_USER_QUESTIONS_LOADED,this._onQuestionsLoaded);this.profile.entity.off(SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED,this._onQuestionsLoaded)},__beforeRender:function(options){return options.md},__afterRender:function(){var qView,entity=this.profile.entity,isStatic=entity.isValid()&&!entity.isEmpty(),isClosed=!isStatic,questionListView,entityInfoView;this._$footer=this.$el.find(".profile-panel-footer");if(this.profile.questions.isEmpty()){qView=SM.Views.create(SM.ProfileQuestionListEmptyView,{});this.$el.children().append(qView.$el)}else{questionListView=SM.Views.create(SM.ProfilerQuestionListView,{model:this.profile.questions,viewType:"user",isClosed:false,isStatic:false});entityInfoView=SM.Views.create(SM.EntityInfoView,{model:this.profile.entity,isClosed:isClosed,isStatic:isStatic});this._entityInfoView=entityInfoView;if(this.profile.fromRecapture()){this._$footer.before(entityInfoView.$el);this._$footer.before(questionListView.$el)}else{this._$footer.before(questionListView.$el);this._$footer.before(entityInfoView.$el)}}this._showFooter()},__init:function(){this.profile.on(SM.Event.PROFILER_USER_QUESTIONS_LOADED,{self:this},this._onQuestionsLoaded);this.profile.entity.on(SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED,{self:this},this._onQuestionsLoaded)},_onQuestionsLoaded:function(e){var self=e.data.self;SM.log("  QuestionCtnrView._onQuestionsLoaded ("+e.type+")");self._showFooter()},_showFooter:function(){if(this.profile.questions.list.length>1||this.profile.entity.hasQuestions()){if(!this.profile.entity.hasQuestions()){this._entityInfoView.$el.addClass("hidden")}else{this._entityInfoView.$el.removeClass("hidden")}this._$footer.find(".continue").removeClass("hide");this._$footer.find(".privacy-text").removeClass("hide");this.$el.find(".hide-border").removeClass("hide-border")}else{this._entityInfoView.$el.addClass("hidden");this._$footer.find(".continue").addClass("hide");this._$footer.find(".privacy-text").addClass("hide");this.$el.find("li.question").first().addClass("hide-border")}}});SM.ProfileQuestionListEmptyView=SM.Views.register({__NAME:"profileQuestionListEmptyView",__templateID:"profiler-question-list-empty-template"});SM.ProfilerQuestionListView=SM.Views.register({__NAME:"profilerQuestionListView",__model:"questionList",__templateID:"profiler-question-list-template",_qViews:[],MAX_STRING_LENGTH:75,__create:function(options){if(this.get("eventOwner")){this.eventOwner=this.get("eventOwner")}else{this.eventOwner=this.questionList.parent}if(this.get("classes")){this.classes=this.get("classes")}else{this.classes=""}},__destroy:function(){this.eventOwner.off(this.questionList.event,this._onQuestionsLoaded)},__setters:{isStatic:function(self,val){self.__settings.isStatic=val;self.__settings.isClosed=false;self.__update()},isClosed:function(self,val){self.__settings.isClosed=val;self.__update()}},__beforeRender:function(options){this.ID=this.__NAME+":"+this.questionList.ID;return{classes:this.classes}},__afterRender:function(){var self=this,entity=self.questionList.parent,config=entity.parent.config,notranslate=" notranslate",isStatic=this.questionList.type==="entity"&&!this.get("isClosed")&&this.get("isStatic");if(isStatic){this.questionList.each(function(i,question){var canonical_name=question.question.question_id,std_name=canonical_name;value=entity.entity[std_name],noxlate=false;if(canonical_name==="error"){if(SM.DEBUG){}return true}if(std_name==="entity_type"){return true}if(std_name==="size"){SM.log("WARNING: std_name === size???")}else if(std_name==="name"||std_name==="entity_location_all"){noxlate=true}else{value=question.findAnswerText(value)}if(value&&value!==""){value=SM.String.truncate(value,self.MAX_STRING_LENGTH,true)}options={model:question,isStatic:true,name:std_name,value:value,noxlate:noxlate,showLabel:false,source:self.get("source")};view=self._makeQuestionView(question,options);self.$el.append(view.$el)})}else{if(this.$el.length>1){this.$el=this.$el.slice(0,1)}this._addQuestions(0,this.get("isClosed"))}this.questionList.setView(this)},__init:function(){this.eventOwner.on(this.questionList.event,{self:this},this._onQuestionsLoaded)},_onQuestionsLoaded:function(e){var self=e.data.self,replace=e.replace,newQuestions=e.questions;self.questionList=newQuestions;self.__update();return},_removeQuestions:function(from){var self=this,$questions=this.$el.children();$questions.each(function(ix_q,q){if(ix_q>=from){var $q=$(q);self._qViews[ix_q]=null}})},_makeQuestionView:function(question,options){var profiler=this.questionList.getProfiler(),profileType=question.getProfileType(),family=question.getFamily(),subtype=question.getSubtype(),questionViews=profiler.getQuestionViewsByProfileType(profileType);SM.log("makeQuestionView("+question.getQuestionId()+"["+family+", "+subtype+"])");if(question.question.autocomplete!==""){subtype="autocomplete"}if(!(family in questionViews)){family="all"}if(!(subtype in questionViews[family])){family="all";subtype="all"}viewName=questionViews[family][subtype];if(!(viewName in SM)){throw new Error("Non-existent view "+viewName)}return SM.Views.create(SM[viewName],options)},_addQuestions:function(from){var self=this;isClosed=this.get("isClosed"),isStatic=this.get("isStatic"),disableOrgAC=this.get("disableOrgAC"),useHeading=false,showLabel=!isStatic&&!isClosed,showPlaceholder=false;SM.log("Adding questions from question list "+this.ID);var qViewsNew=[];for(i=0;i<from;i++){qViewsNew=this._qViews[i]}this._qViews=qViewsNew;this.questionList.each(function(ix_q,question){var qView,disableAC=false,$err;if(ix_q===from||!isClosed&&ix_q>from){if(SM.DEBUG||question.question.question_id!=="error"){if(!isClosed&&self.questionList.type==="entity"){if(self.questionList.parent.isVerified()&&question.question.question_id==="entity_type"){return true}if(question.question.autocomplete!==""&&!question.isLocationQuestion()){if(!question.parent.parent.isVerified()){disableAC=disableOrgAC}if(showLabel){showPlaceholder=true}$err=SM.Template.render("entity-name-error-template",{})}}qView=self._makeQuestionView(question,{model:question,useHeading:useHeading,disableAC:disableAC,showLabel:showLabel,showPlaceholder:showPlaceholder,source:self.get("source")});self._qViews[ix_q]=qView;self.$el.append(qView.$el);if($err){self.$el.append($err)}}}})},_clearQuestions:function(){if(this._qViews){$.each(this._qViews,function(i,view){view.clear()})}},saveData:function(){var self=this,savedData=[],foundEntityType=false,lastMissingIndex=-1;if(this._qViews){$.each(this._qViews,function(i,view){if(view&&view.saveValue){savedData.push(view.saveValue());if(view.qid==="entity_type"){foundEntityType=true}}else{savedData.push("");lastMissingIndex=i}})}if(!foundEntityType&&this.questionList.type==="entity"){savedData.push({qid:"entity_type",value:this.questionList.parent.entity.entity_type})}return savedData},unsaveData:function(savedData){if(this._qViews){$.each(this._qViews,function(i,view){if(view&&view.unsaveValue){view.unsaveValue(savedData[i])}})}},collectData:function(){if(this._qViews){$.each(this._qViews,function(i,view){if(view&&view.collectValue){view.collectValue()}})}}});SM.ProfileQuestionListEmptyView=SM.Views.register({__NAME:"profileQuestionListEmptyView",__templateID:"profiler-question-list-empty-template"});SM.ProfilerBaseQuestionView=SM.Views.register({__NAME:"profilerBaseQuestionView",__model:"question",__templateID:"profiler-question-template",__beforeRender:function(){var question_data=this.question.question;this.ID=this.__NAME+":"+question_data.question_id;return{isStatic:this.__settings.isStatic,showLabel:this.__settings.showLabel,noxlate:this.__settings.noxlate,name:this.__settings.name,label:question_data.label_text,value:this.__settings.value}},__afterRender:function(){if(this.question.isEntityQuestion()){var $desc=this.$el.find(".desc");$desc.text(this.question.question.label_text);var id=this.$el.prop("id").substr(2),$select=this.$el.find("select"),$loc=this.$el.find("input[type=text]"),entity=this.question.getEntity();this._qid=id;if($select.length>0){this._$dataElt=$select}else if($loc.length>0){this._$dataElt=$loc}else{this._$dataElt=$()}this._$dataElt.val(entity?entity.getProp(this._qid):"")}else{SM.log("Base Question of profile type "+this.question.question.profile_type+" created");this._qid=this.question.getQuestionId();this._$dataElt=$()}},__init:function(){var entity=this.question.getEntity();if(entity){entity.on(SM.Event.PROFILER_ENTITY_NAME_DELETE,{self:this},this._onEntityNameDelete)}},__destroy:function(){var entity=this.question.getEntity();if(entity){entity.off(SM.Event.PROFILER_ENTITY_NAME_DELETE,this._onEntityNameDelete)}},_onEntityNameDelete:function(e){var self=e.data.self;SM.log("_onEntityNameDelete - clearing "+self._qid);self._$dataElt.val("")},saveValue:function(){return{qid:this._qid,value:this._$dataElt.val()}},unsaveValue:function(savedValue){if(savedValue&&savedValue.qid===this._qid){this._$dataElt.val(savedValue.value)}},collectValue:function(){var value=this._$dataElt.val(),entity=this.question.getProfile().entity;if(this._qid!=="error"){entity.setProp(this._qid,value)}}});SM.ProfilerAutocompleteQuestionView=SM.Views.register(SM.Views.extend(SM.ProfilerBaseQuestionView,{__NAME:"profilerAutocompleteQuestionView",__model:"question",__templateID:"profiler-ac-question-template",MAX_STRING_LENGTH:75,__create:function(options){var entity=options.model.getEntity();this.ID=this.__NAME+":"+this.question.getQuestionId();if(entity){this._acvId="ACQ_"+entity.refAC();SM.log("ProfilerAutocompleteQuestionView["+this._acvId+"].__create()")}},__destroy:function(){var entity=this.question.getEntity();if(entity){entity.derefAC(this._acvId);SM.log("ProfilerAutocompleteQuestionView["+this._acvId+"].__destroy()");entity.off(SM.Event.PROFILER_AUTOCOMPLETE_AVAILABLE,this._onAutocompleteAvailable)}this.question.off(SM.Event.PROFILER_ENTITY_NAME_DELETE,this._onEntityNameDelete);this.__unsubscribe("autocompletepf.selected",this._onAutocompleteSelected);this.__unsubscribe("autocompletepf.blur",this._onAutocompleteBlur);this.__unsubscribe("autocompletepf.afterClose",this._onAutocompleteCLose);if(this._ac){if(this._ac.menu){this._ac.menu.$el.remove();this._ac.menu=undefined}this._ac=undefined}},__beforeRender:function(){var entity=this.question.getEntity(),qid=this.question.getQuestionId(),value=entity?entity.getProp(qid):"",label=this.get("showPlaceholder")?this.question.getPlaceholder():this.question.getLabel(),name=entity.getPropStdName(qid);this.ID=this.__NAME+":"+qid;value=SM.String.truncate(value,this.MAX_STRING_LENGTH,true);return{isStatic:this.get("isStatic"),showLabel:this.get("showLabel"),noxlate:this.get("noxlate"),name:name,loc:name==="entity_location_all"?"loc":"",label:label,text:value}},__afterRender:function(){var entity=this.question.getEntity(),config=entity.parent.config,value,$desc;this._buildQuestion();$desc=this.$el.find(".desc");if(this.get("useHeading")){$desc.hide()}else{$desc.show();$desc.text(this.question.getLabel())}if(this.question.isLocationQuestion()){value=entity.getLocation()}else{value=entity.getName()}if(this.get("isStatic")){value=SM.String.truncate(value,this.MAX_STRING_LENGTH,true)}this._$dynamicText.val(value);this._$dynamicDelete.addClass("hidden");this._inside=false;if(entity&&entity.isEmpty()){this.$el.addClass("closed")}else{this.$el.removeClass("closed")}this._qid=this.question.getQuestionId()},__init:function(){var self=this,entity=this.question.getEntity();if(!this.get("disableAC")){this._ac=this._$dynamicText.autocompletepf({minLength:2,delay:100,maxResults:50,search:function(term){self.question.generateAutocompleteResults(term,self.get("source"))},classes:["long"]}).data("autocompletepf")}this.question.on(SM.Event.PROFILER_AUTOCOMPLETE_AVAILABLE,{self:this},this._onAutocompleteAvailable);this.__subscribe("autocompletepf.selected",this._onAutocompleteSelected,{self:this});this.__subscribe("autocompletepf.blur",this._onAutocompleteBlur,{self:this});this.__subscribe("autocompletepf.afterClose",this._onAutocompleteClose,{self:this});if(entity){entity.on(SM.Event.PROFILER_ENTITY_NAME_DELETE,{self:this},this._onEntityNameDelete)}this._$dynamicDelete.on(SM.Event.CLICK,{self:this},this._onDeleteNameClicked);this._$dynamicDelete.on(SM.Event.MOUSEENTER,{self:this},this._onDeleteMouseEnter);this._$dynamicDelete.on(SM.Event.MOUSELEAVE,{self:this},this._onDeleteMouseExit);this._$dynamicText.on(SM.Event.FOCUS,{self:this},this._onTextFocus);this._$dynamicText.on(SM.Event.BLUR,{self:this},this._onTextBlur);this._$dynamicText.attr("placeholder",this.question.getPlaceholder());this._$dynamicText.placeholder()},_buildQuestion:function(){var entity=this.question.getEntity(),qid=this.question.getQuestionId();this._$dynamicText=this.$el.find("input[type=text][autocompletepf]["+entity.getPropStdName(qid)+"]");this._$dynamicDelete=this.$el.find(".entity-name-delete")},_onEntityNameDelete:function(e){var self=e.data.self;self._$dynamicText.val("")},_onAutocompleteAvailable:function(e){var self=e.data.self,resultList=e.resultList,source=self.get("source"),key=self.question.getKey();if(self._ac&&e.key===key&&e.source===source){self._ac.set("results",resultList)}},_onTextFocus:function(e){var self=e.data.self;self._$dynamicDelete.removeClass("hidden")},_onTextBlur:function(e){var self=e.data.self;if(!self._inside){self._$dynamicDelete.addClass("hidden")}},_onAutocompleteBlur:function(e){var self=e.data.self,text=self.$el.find("[autocompletepf]").val();if(text&&text.length>=2){SM.log("Event: onAutocompleteBlur - non-empty text");self.question.setAnswer(text,0,self.get("source"))}},_onAutocompleteClose:function(e){var self=e.data.self,$ac=self.$el.find("[autocompletepf]"),text=$ac.val();if(text&&text.length<2){SM.log("Event: onAutocompleteClose - too little text");self.question.setAnswer("",0,self.get("source"));$ac.val("")}},_onDeleteMouseEnter:function(e){var self=e.data.self;self._inside=true},_onDeleteMouseExit:function(e){var self=e.data.self;self._inside=false},_onAutocompleteSelected:function(e){var self=e.data.self,text=SM.Html.strip(SM.String.trim(e.text)),value=e.value,item=JSON.parse(value),mySource=self.get("source"),currentSource=self.question.parent.parent.getProfiler().getSource();SM.log("Event: autocompletepf.selected("+mySource+"): ["+text+", "+value+"]");if(mySource===currentSource){if(item.key===self.question.LOCATION_KEY){if(self.question.isLocationQuestion()){self._$dynamicText.val(text);self._$dynamicText.data("ACResult",item)}}else{if(!self.question.isLocationQuestion()){value=parseInt(item.id,10);self.question.setAnswer(text,value,self.get("source"))}}}else{SM.log("...ignored, current source should be "+currentSource)}},_onDeleteNameClicked:function(e){var self=e.data.self,entity=self.question.getEntity();e.preventDefault();e.stopPropagation();SM.log("Event: ACQV:_onDeleteNameClicked");if(self.question.isLocationQuestion()){self._$dynamicText.val("")}else if(entity){entity._trigger({type:SM.Event.PROFILER_ENTITY_NAME_DELETE});self._$dynamicText.focus()}self._$dynamicDelete.addClass("hidden");self._inside=false;if(self._ac){self._ac.close()}},saveValue:function(){var saveObject={qid:this._qid,value:this._$dynamicText.val()};if(this.question.isLocationQuestion()){saveObject.ACResult=this._$dynamicText.data("ACResult")}return saveObject},unsaveValue:function(savedValue){if(savedValue&&savedValue.qid===this._qid){this._$dynamicText.val(savedValue.value);if(savedValue.ACResult){this._$dynamicText.data("ACResult",savedValue.ACResult)}}},collectValue:function(){var entity=this.question.getProfile().entity,stdName=this.question.getStdName(),value=SM.String.trim(SM.Html.strip(this._$dynamicText.val(),true));if(stdName==="name"){entity.setName(value)}else if(stdName==="entity_location_all"){entity.setLocation(value,this._$dynamicText.data("ACResult"))}}}));SM.ProfilerMultipleChoiceQuestionView=SM.Views.register(SM.Views.extend(SM.ProfilerBaseQuestionView,{__NAME:"profilerMultipleChoiceQuestionView",__model:"question",__templateID:"profiler-mc-question-template",__init:function(){var entity=this.question.getEntity();this.$el.on(SM.Event.CLICK,"input",{self:this},this._onInputClick);if(entity){entity.on(SM.Event.PROFILER_ENTITY_NAME_DELETE,{self:this},this._onEntityNameDelete)}},__destroy:function(){var entity=this.question.getEntity();if(entity){entity.off(SM.Event.PROFILER_ENTITY_NAME_DELETE,this._onEntityNameDelete)}},NUM_OPTIONS_PER_COL:4,__beforeRender:function(){var qid=this.question.getQuestionId(),profileType=this.question.getProfileType(),isStatic=profileType==="user"?false:this.__settings.isStatic,showLabel=profileType==="user"?true:this.__settings.showLabel,noxlate=profileType==="user"?false:this.__settings.noxlate,label=profileType==="user"?this.question.getQuestionText():this.question.getLabel(),entity=this.question.getEntity(),twoColumns=this.question.ctAnswers()>this.NUM_OPTIONS_PER_COL,values=[],valueList=[],valueList2=[],text="";this.ID=this.__NAME+":"+qid;if(entity){values=entity.getProp(qid);text=this.question.findAnswerText(values),lastAnswerIndex=this.question.ctAnswers()-1;this.question.eachAnswer(function(answer,ix){if(!answer.ignore){var index=SM.Array.indexOf(values,answer.name),valueItem={optValue:answer.name,optText:answer.option_text,isChecked:index!==-1,addBreak:ix<lastAnswerIndex};valueList.push(valueItem)}})}else if(profileType==="user"){var profile=this.question.parent.parent,values=profile.sub_categories;this.question.eachAnswer(function(answer,ix){if(!answer.ignore){var index=SM.Array.indexOf(values,answer.name),valueItem={optValue:answer.name,optText:answer.option_text,isChecked:false,addBreak:true};if(twoColumns&&ix%2){valueList2.push(valueItem)}else{valueList.push(valueItem)}}})}return{isStatic:isStatic,showLabel:showLabel,twoColumns:twoColumns,noxlate:this.__settings.noxlate,name:qid,label:label,values:valueList,values2:valueList2,text:text}},__afterRender:function(){var self=this,profile=this.question.getProfile(),profileType=this.question.getProfileType(),qid=this.question.getQuestionId(),answers=this.question.getAnswers(),categoryInfo,choices,categoryData,selectAll,foundOne=false,srcRef;this._cacheElements();if(profileType==="user"){profile=this.question.parent.parent;categoryInfo=profile.currentCategoryData();choices=this.question.getAnswerData().subcategories;categoryData=profile.getConfig().getCategoryDataForQuestion(qid);if(categoryData.isMore){this.$el.find(".column-ctnr").after(SM.Template.render("suggest-categories-template"))}selectAll=choices.length===0;if(!selectAll){$.each(categoryInfo.sub_cats,function(id,value){$.each(choices,function(i,subcat){if(subcat===id){foundOne=true;return false}});if(foundOne){return false}});selectAll=!foundOne}else{srcRef=profile.getSrcRef();selectAll=srcRef===""||srcRef==="getstarted"}selectAll=selectAll&&!categoryData.selectNone}else{choices=profile.entity.getProp(qid)||[];selectAll=false}this._$inputs.each(function(i){var answerId=this.value;if(selectAll||SM.Array.indexOf(choices,answerId)!==-1){$(this).prop("checked",true);self.question.setChoice(answerId,true)}else{$(this).prop("checked",false)}})},_cacheElements:function(){this._$inputs=this.$el.find("input")},_onInputClick:function(e){var self=e.data.self,$tgt=$(e.target),value=$tgt.is(":checked"),name=$tgt.attr("value");self.question.setChoice(name,value)},_onEntityNameDelete:function(e){var self=e.data.self;if(self.question.isEntityQuestion()){self._$inputs.each(function(i){$(this).prop("checked",false)})}},_getValues:function(){var answers=this.question.getAnswers(),values=[];this._$inputs.each(function(i){if($(this).is(":checked")){values.push(answers[i].name)}});return values},_setValues:function(values){var answers=this.question.getAnswers();this._$inputs.each(function(i){if(SM.Array.indexOf(values,answers[i].name)>-1){$(this).prop("checked",true)}else{$(this).prop("checked",false)}})},saveValue:function(){return{qid:this.question.getQuestionId(),value:this._getValues()}},unsaveValue:function(savedValues){if(savedValues&&savedValues.qid===this.question.getQuestionId()){this._setValues(savedValues.value)}},collectValue:function(){var value=this._getValues(),stdName=this.question.getStdName(),profile=this.question.getProfile();if(this.question.isUserQuestion()){profile.setProp(stdName,value)}else if(this.question.isEntityQuestion()){profile.entity.setProp(stdName,value)}}}));SM.ProfilerMenuQuestionView=SM.Views.register({__NAME:"profilerMenuQuestionView",__model:"question",__templateID:"profiler-menu-question-template",__beforeRender:function(){var entity=this.question.getEntity(),qid=this.question.getQuestionId(),value,text,options=[];this.ID=this.__NAME+":"+qid;if(entity){value=entity.getProp(qid);text=this.question.findAnswerText(value);options.push({optValue:"",optText:Globalize.localize("_Profiler_Choose"),isSelected:value===""});this.question.eachAnswer(function(answer,ix){options.push({optValue:answer.name,optText:answer.option_text,isSelected:value===answer.name})})}return{isStatic:this.get("isStatic"),showLabel:this.get("showLabel"),noxlate:this.get("noxlate"),name:qid,label:this.question.getLabel(),value:value,text:text,options:options}},__afterRender:function(){if(this.question.isEntityQuestion()){this._qid=this.question.getQuestionId();this._$dataElt=this.$el.find("select")}else{SM.log("Menu Question of profile type "+this.question.getProfileType()+" created");this._qid=this.question.getQuestionId();this._$dataElt=$()}},__init:function(){var entity=this.question.getEntity();if(this._qid==="entity_type"){this.$el.on(SM.Event.CHANGE,"select",{self:this},this._onEntityTypeChanged)}if(entity){entity.on(SM.Event.PROFILER_ENTITY_NAME_DELETE,{self:this},this._onEntityNameDelete)}},_onEntityNameDelete:function(e){var self=e.data.self;SM.log("_onEntityNameDelete - clearing "+self._qid);self._$dataElt.val("")},_onEntityTypeChanged:function(e){var self=e.data.self,entityType=$(e.target).val(),entity=self.question.getEntity();entity._trigger({type:SM.Event.PROFILER_ENTITY_TYPE_CHANGED,entityType:entityType})},saveValue:function(){return{qid:this._qid,value:this._$dataElt.val()}},unsaveValue:function(savedValue){if(savedValue&&savedValue.qid===this._qid){this._$dataElt.val(savedValue.value)}},collectValue:function(){var value=this._$dataElt.val(),stdName=this.question.getStdName();
entity=this.question.getProfile().entity;if(stdName!=="error"){entity.setProp(stdName,value)}}});SM.EntityView=SM.Views.register({__NAME:"entityView",__model:"entity",__templateID:"entity-view-template",__setters:{isStatic:function(self,val){var isClosed=false,isValid=self.entity.isValid(),isEmpty=self.entity.isEmpty();if(val&&!isValid&&isEmpty){val=false;isClosed=true}self.__settings.isStatic=val;self.__settings.isClosed=isClosed;self.entity.setViewState(self.__settings.isStatic,self.__settings.isClosed);self.__update()},isClosed:function(self,val){var oldval=self.__settings.isClosed;if(oldval!==val){self.__settings.isClosed=val;self.entity.setViewState(self.__settings.isStatic,self.__settings.isClosed);self.__update()}}},__create:function(){SM.log("EntityInfoView.__create()");if(this.__settings.isClosed===undefined){this.__settings.isClosed=!this.entity.isValid()&&!this.__settings.openIfInvalid}if(this.__settings.isStatic===undefined){if(this.__settings.isClosed){this.__settings.isStatic=false}else{this.__settings.isStatic=this.entity.isValid()&&!this.entity.isEmpty()}}if(this.__settings.disableOrgAC===undefined){this.__settings.disableOrgAC=true}},__beforeRender:function(){var md={entity_id:this.entity.getEntityId(),heading:this.entity.getHeading(),showHeading:this.__settings.showHeading,hideCancel:this.__settings.hideCancel};if(this.__settings.openIfInvalid&&!this.entity.isValid()){this.__settings.isClosed=false;this.__settings.isStatic=false}md.isStatic=this.__settings.isStatic,md.isClosed=this.__settings.isClosed,this.ID=this.__NAME+":"+this.entity.ID;return md},__afterRender:function(){var self=this,html="",isStatic=this.__settings.isStatic,isClosed=this.__settings.isClosed,disableOrgAC=this.__settings.disableOrgAC;this._$eiCtnr=this.$el.find(".entity-info-ctnr");this._$cancelBtn=this.$el.find(".cancel");SM.log("  entityInfoView.__afterRender(closed: "+isClosed+", static: "+isStatic+")");if(!this._questionListView){this._questionListView=SM.Views.create(SM.ProfilerQuestionListView,{model:this.entity.questions,viewType:"entity",isClosed:isClosed,isStatic:isStatic,disableOrgAC:disableOrgAC,source:self.__settings.source})}else{if(this.__settings.isClosed){this._questionListView.set("isClosed",true)}else{this._questionListView.set("isStatic",this.__settings.isStatic)}}if(this.__settings.isClosed){this._$eiCtnr.prepend(this._questionListView.$el)}else if(!this.__settings.isStatic){this.$el.find("[terminator]").before(this._questionListView.$el)}else{this._$eiCtnr.append(this._questionListView.$el)}this._cacheElements()},_cacheElements:function(){this._$eType=this.$el.find("#lientity_type select");this._$nameErr=this.$el.find(".question-error");this._$name=this.$el.find("input[name]");this.entity.setEntityView(this)},__init:function(){this.entity.on(SM.Event.PROFILER_ENTITY_QUESTIONS_FETCHED,{self:this},this._onEntityQuestionsLoaded);this.entity.on(SM.Event.PROFILER_ENTITY_QUESTIONS_LOADED,{self:this},this._onEntityQuestionsLoaded);this.entity.on(SM.Event.PROFILER_ENTITY_INFO_UPDATED,{self:this},this._onEntityInfoUpdated);this.entity.on(SM.Event.PROFILER_ENTITY_TYPE_CHANGED,{self:this},this._onEntityTypeChanged);this.entity.on(SM.Event.PROFILER_ENTITY_NAME_DELETE,{self:this},this._onEntityNameDelete);this.entity.on(SM.Event.PROFILER_NAME_ERROR,{self:this},this._onShowNameError);this.$el.on(SM.Event.CLICK,".edit",{self:this},this._onEditInfoClicked);this.$el.on(SM.Event.CLICK,".done",{self:this},this._onDoneInfoClicked);this.$el.on(SM.Event.CLICK,".cancel",{self:this},this._onCancelClicked);this.$el.on(SM.Event.CLICK,".entity-info-ctnr",{self:this},this._onEntityInfoClicked)},_onEntityInfoUpdated:function(e){var self=e.data.self;self.set("isStatic",e.isStatic)},_onEntityQuestionsLoaded:function(e){var self=e.data.self;SM.log("  EntityInfoView._onEntityQuestionsLoaded()");self.set("isStatic",e.makeStatic);self._unsaveData()},_editEntityInfo:function(){var entityId=this.entity.getEntityId(),entityType=this.entity.entity.entity_type;if(entityType===""){this.entity.fetchEntityQuestions(entityId)}else{this.entity.fetchEntityTypeQuestions(entityType,false)}},_onEditInfoClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._editEntityInfo();self.entity.getProfiler().triggerStateChanged("edit")},_onEntityInfoClicked:function(e){var self=e.data.self;if(self.__settings.isStatic){self._editEntityInfo()}},_onAutocompleteAvailable:function(e){var self=e.data.self;self.clearNameError()},showNameError:function(){this._$nameErr.removeClass("hidden");this._$name.addClass("err")},clearNameError:function(){this._$nameErr.addClass("hidden");this._$name.removeClass("err")},_onShowNameError:function(e){var self=e.data.self;self.showNameError()},_done:function(collect){var self=this,entityType=this.entity.entity.entity_type,savedEntityData=$.extend({},this.entity.entity);var onDone=function(){self.entity.getProfiler().triggerEntitySaved(true)};var onFail=function(){self.entity.getProfiler().triggerEntitySaved(false)};if(collect){this.collectData()}else{this.entity.restoreBackup();this.entity.getProfiler().triggerStateChanged("cancel");if(this._$eType.val()!==undefined&&this._$eType.val()!==entityType){this.entity.fetchEntityTypeQuestions(entityType,true);return}}if(this.entity.isEmpty()){this.entity.clear()}if(collect&&!this.entity.isEmpty()&&this.entity.getName()===""){this.showNameError();this.entity.entity=savedEntityData}else{this.clearNameError();if(this.entity.isValid()){this.set("isStatic",true)}else{this.set("isClosed",true)}this.entity.getProfiler().triggerEntityChanged();this.entity.getProfiler().save({done:onDone,fail:onFail,uiTrigger:"edit_entity_done_button"})}},_onDoneInfoClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._done(true)},_onCancelClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._done(false)},_onEntityTypeChanged:function(e){var self=e.data.self;self._saveData();self.entity.fetchEntityTypeQuestions(e.entityType,self.__settings.isStatic)},_onEntityNameDelete:function(e){var self=e.data.self;self.entity.setEntityValue("",0)},_saveData:function(){this._savedData=this._questionListView.saveData();this._useSavedData=true},getSavedEntityType:function(){if(this._useSavedData){entityTypeItem=_.find(this._savedData,function(item){if(item.qid==="entity_type"){return true}});if(entityTypeItem){return entityTypeItem.value}}return""},_unsaveData:function(){if(this._useSavedData){this._questionListView.unsaveData(this._savedData);this._useSavedData=false}},collectData:function(){this._questionListView.collectData();this.entity.setSource(this.get("source"))}});SM.ProfilerView=SM.Views.register({__NAME:"profilerView",__model:"profiler",__templateID:"profiler-view-template",__create:function(){SM.log("ProfilerView.__create()");if(this.get("disableOrgAC")===undefined){this.set("disableOrgAC",true)}if(this.get("disableAccordion")){this._collapsed=false}else{this._collapsed=this.profiler.hasValidEntity()}},__beforeRender:function(){var md=this.profiler.getHeading(this._collapsed),hasValidEntity=this.profiler.hasValidEntity()||this.profiler.hasCollectorProfile;md.showHeading=this.get("showHeading");md.hideCancel=this.get("hideCancel");md.showDefaultCB=this.get("showDefaultCB");md.showOptInCB=this.get("showOptInCB");md.useDisclaimer=!hasValidEntity&&!this.profiler.user.benchmarkingHasOptOut;md.showOptInHighlight=hasValidEntity;md.disableAccordion=this.get("disableAccordion");md.showQuestionText=this.get("showQuestionText");md.questionText=this.profiler.getQuestionText();this.ID=this.__NAME+":"+this.get("source");return md},__afterRender:function(){var self=this,disableOrgAC=this.get("disableOrgAC");this._cacheElements();this._entityView=SM.Views.create(SM.EntityView,{model:this.profiler.profile.entity,showHeading:false,disableOrgAC:this.get("disableOrgAC"),source:this.get("source"),openIfInvalid:this.get("openIfInvalid")});this._$eiCtnr.append(this._entityView.$el);this._setHeading(this._collapsed);if(this.get("showDefaultCB")){if(this.profiler.getSaveAsDefault()){this._$setDefaultCB.prop("checked","checked")}}if(this.get("showOptInCB")){this._setOptIn(true)}self._initAccordion();self.$el.find("[profiler-q]").popout()},_cacheElements:function(){this._$eiCtnr=this.$el.find(".entity-ctnr");this._$headingText=this.$el.find(".title .name");this._$headingLabel=this.$el.find(".title .heading");this._$setDefaultCB=this.$el.find("[profiler-default-cb] input[type=checkbox]");this._$optInCB=this.$el.find("[profiler-opt-in-cb]");this._$questionText=this.$el.find(".question-text")},__init:function(){this.$el.on(SM.Event.CLICK,"[profiler-default-cb]",{self:this},this._onDefaultCBClicked);this.$el.on(SM.Event.CLICK,"input[profiler-opt-in-cb]",{self:this},this._onOptInCBClicked);this.profiler.profile.entity.on(SM.Event.PROFILER_ENTITY_INFO_UPDATED,{self:this},this._onEntityInfoUpdated);this.profiler.on(SM.Event.PROFILER_ENTITY_INFO_CHANGED,{self:this},this._onEntityInfoUpdated);this.profiler.on(SM.Event.PROFILER_STATE_CHANGED,{self:this},this._onProfilerStateChanged)},_setHeading:function(collapsed){var md=this.profiler.getHeading(collapsed);this._$headingLabel.text(md.heading);this._$headingText.text(md.text)},_setQuestionText:function(){var questionText;if(this.get("showQuestionText")){questionText=this.profiler.getQuestionText();this._$questionText.text(questionText)}},_onAccordionOpen:function(e){this._setCollapserState(false)},_onAccordionClose:function(e){this._setCollapserState(true)},_initAccordion:function(){var self=this,$accordion=this.$el.find("[profiler-accordion]"),accordion=$accordion.accordion({}).data().accordion;$accordion.on("accordion.beforeOpen",function(e){self._onAccordionOpen(e)}).on("accordion.afterClose",function(e){self._onAccordionClose(e)});if(!self._collapsed){accordion.open("profiler-main-section")}},_setCollapserState:function(collapsed){this._setHeading(collapsed);this._collapsed=collapsed},_onDefaultCBClicked:function(e){var self=e.data.self,$tgt=$(e.target),$cb=$tgt.closest("[profiler-default-cb]").find("input[type=checkbox]"),isChecked=$cb.is(":checked");if(!$tgt.is($cb)){isChecked=!isChecked;$cb.prop("checked",isChecked)}self.profiler.setSaveAsDefault(isChecked)},_getOptIn:function(){return this._$optInCB.is(":checked")},_setOptIn:function(optIn){if(optIn){this._$optInCB.prop("checked","checked")}else{this._$optInCB.prop("checked","")}},_onProfilerStateChanged:function(e){var self=e.data.self,state=e.state;if(state===self.profiler.PROFILER_STATE_OPT_IN){self._setOptIn(true)}else if(state===self.profiler.PROFILER_STATE_OPT_OUT){self.get("dlg").close()}},_onOptInCBClicked:function(e){var self=e.data.self,$tgt=$(e.target),wasChecked=$tgt.is(":checked"),$owner=$(self.get("ownerId"));if(wasChecked){self.profiler.user.benchmarkingHasOptOut=false;self.profiler.triggerStateChanged("optIn")}else{self.profiler.showOptOutDialog($owner,true)}},_onEntityInfoUpdated:function(e){var self=e.data.self;self._setHeading(self._collapsed);self._setQuestionText()},_onEntityQuestionsLoaded:function(e){var self=e.data.self;SM.log("  EntityInfoView._onEntityQuestionsLoaded()");self.set("isStatic",e.makeStatic);self._unsaveData()},_editEntityInfo:function(){var entityId=this.entity.getEntityId(),entityType=this.entity.entity.entity_type;if(entityType===""){this.entity.fetchEntityQuestions(entityId)}else{this.entity.fetchEntityTypeQuestions(entityType,false)}},_onEditInfoClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._editEntityInfo()},_onEntityInfoClicked:function(e){var self=e.data.self;if(self.__settings.isStatic){self._editEntityInfo()}},_onAutocompleteAvailable:function(e){var self=e.data.self;self.clearNameError()},showNameError:function(){this._$nameErr.removeClass("hidden")},clearNameError:function(){this._$nameErr.addClass("hidden")},_onShowNameError:function(e){var self=e.data.self;self.showNameError()},_done:function(collect){var self=this,entityType=this.entity.entity.entity_type,savedEntityData=$.extend({},this.entity.entity);var onDone=function(){self.entity.getProfiler().triggerEntitySaved(true)};var onFail=function(){self.entity.getProfiler().triggerEntitySaved(false)};if(collect){this.collectData()}else{this.entity.restoreBackup();if(this._$eType.val()!==undefined&&this._$eType.val()!==entityType){this.entity.fetchEntityTypeQuestions(entityType,true);return}}if(this.entity.isEmpty()){this.entity.clear()}if(collect&&!this.entity.isEmpty()&&this.entity.getName()===""){this.showNameError();this.entity.entity=savedEntityData}else{this.clearNameError();if(this.entity.isValid()){this.set("isStatic",true)}else{this.set("isClosed",true)}this.entity.getProfiler().triggerEntityChanged();this.entity.getProfiler().save({done:onDone,fail:onFail})}},_onDoneInfoClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._done(true)},_onCancelClicked:function(e){var self=e.data.self;e.preventDefault();e.stopPropagation();self._done(false)},_onEntityTypeChanged:function(e){var self=e.data.self;self._saveData();self.entity.fetchEntityTypeQuestions(e.entityType,self.__settings.isStatic)},_onEntityNameDelete:function(e){var self=e.data.self;self.entity.setEntityValue("",0)},_saveData:function(){this._savedData=this._questionListView.saveData();this._useSavedData=true},getSavedEntityType:function(){if(this._useSavedData){entityTypeItem=_.find(this._savedData,function(item){if(item.qid==="entity_type"){return true}});if(entityTypeItem){return entityTypeItem.value}}return""},_unsaveData:function(){if(this._useSavedData){this._questionListView.unsaveData(this._savedData);this._useSavedData=false}},collectData:function(){this._questionListView.collectData();this.entity.setSource(this.get("source"))}});